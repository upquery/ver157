create or replace procedure ATU_COPUSU (PRM_USUARIO VARCHAR2, PRM_USUARIO_COP VARCHAR2, PRM_STATUS VARCHAR2 DEFAULT 'MANTER') AS
    
VAR_USUARIO VARCHAR2(40) := TRIM(UPPER(PRM_USUARIO));
VAR_USUARIO_COP VARCHAR2(40) := TRIM(UPPER(PRM_USUARIO_COP));


BEGIN

IF  PRM_STATUS='DELETAR' THEN

--DELETA FULL--

DELETE FILTROS              WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO;
DELETE DESTAQUE             WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO;
DELETE FLOAT_FILTER_ITEM    WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO;
DELETE OBJECT_RESTRICTION   WHERE TRIM(UPPER(USUARIO))    = VAR_USUARIO;
DELETE PARAMETRO_USUARIO    WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO;
DELETE ROLES                WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO;
DELETE COLUMN_RESTRICTION   WHERE TRIM(UPPER(USUARIO))    = VAR_USUARIO;
DELETE USER_NETWALL         WHERE TRIM(UPPER(USUARIO))    = VAR_USUARIO;
DELETE BI_PERMISSAO_CUSTOM  WHERE TRIM(UPPER(NM_USUARIO)) = VAR_USUARIO;
DELETE USER_SCREENS         WHERE TRIM(UPPER(USUARIO))    = VAR_USUARIO;

--  INSERE FULL  --


INSERT INTO FILTROS SELECT VAR_USUARIO AS CD_USUARIO,CD_OBJETO,MICRO_VISAO,CD_COLUNA,CONDICAO,CONTEUDO,LIGACAO,ST_AGRUPADO,(SELECT NVL(MAX(CD_FILTRO),0)+1 FROM FILTROS) AS CD_FILTRO,TP_FILTRO,CD_CRIADO
FROM FILTROS WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO_COP;

INSERT INTO DESTAQUE SELECT VAR_USUARIO AS CD_USUARIO,CD_OBJETO,CD_COLUNA,CONDICAO,CONTEUDO,COR_FUNDO,COR_FONTE,TIPO_DESTAQUE,PRIORIDADE,(SELECT NVL(MAX(CD_DESTAQUE),0)+1 FROM DESTAQUE) AS CD_DESTAQUE
FROM DESTAQUE WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO_COP;

INSERT INTO FLOAT_FILTER_ITEM SELECT VAR_USUARIO AS CD_USUARIO,SCREEN,CD_COLUNA,CONTEUDO 
FROM FLOAT_FILTER_ITEM WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO_COP;

INSERT INTO OBJECT_RESTRICTION SELECT VAR_USUARIO AS USUARIO,CD_OBJETO,ST_RESTRICAO,DT_LAST
FROM OBJECT_RESTRICTION WHERE USUARIO = VAR_USUARIO_COP;

INSERT INTO PARAMETRO_USUARIO SELECT VAR_USUARIO AS CD_USUARIO,CD_PADRAO,CONTEUDO,PRE_LOAD
FROM PARAMETRO_USUARIO WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO_COP;

INSERT INTO ROLES SELECT VAR_USUARIO AS CD_USUARIO,CD_ROLE,TIPO
FROM ROLES WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO_COP;

INSERT INTO COLUMN_RESTRICTION SELECT VAR_USUARIO AS USUARIO,CD_MICRO_VISAO,CD_COLUNA,ST_RESTRICAO,DT_LAST
FROM COLUMN_RESTRICTION WHERE TRIM(UPPER(USUARIO)) = VAR_USUARIO_COP;

INSERT INTO USER_NETWALL SELECT VAR_USUARIO AS USUARIO,NOME_REGRA,TIPO_REGRA,NET_ADDRESS,HR_INICIO,HR_FINAL,DIA_SEMANA,DT_REGRA
FROM USER_NETWALL WHERE TRIM(UPPER(USUARIO)) = VAR_USUARIO_COP;

INSERT INTO BI_PERMISSAO_CUSTOM SELECT VAR_USUARIO AS NM_USUARIO,NM_VISAO,NM_COLUNA,CD_CUSTOM 
FROM BI_PERMISSAO_CUSTOM WHERE TRIM(UPPER(NM_USUARIO)) = VAR_USUARIO_COP;

INSERT INTO USER_SCREENS SELECT VAR_USUARIO AS USUARIO,SCREEN,STATUS
FROM USER_SCREENS WHERE TRIM(UPPER(USUARIO)) = VAR_USUARIO_COP;

END IF;

-- ADICIONA TODOS MENOS OS QUE J√Å EXISTEM --

IF PRM_STATUS='MANTER' THEN


INSERT INTO FILTROS(SELECT CD_USUARIO,CD_OBJETO,MICRO_VISAO,CD_COLUNA,CONDICAO,CONTEUDO,LIGACAO,ST_AGRUPADO,(SELECT NVL(MAX(CD_FILTRO),0)+1 FROM FILTROS ) AS CD_FILTRO,TP_FILTRO,CD_CRIADO FROM (
SELECT VAR_USUARIO AS CD_USUARIO,CD_OBJETO,MICRO_VISAO,CD_COLUNA,CONDICAO,CONTEUDO,LIGACAO,ST_AGRUPADO,TP_FILTRO,CD_CRIADO
FROM FILTROS WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO_COP
MINUS 
SELECT TRIM(UPPER(CD_USUARIO)),CD_OBJETO,MICRO_VISAO,CD_COLUNA,CONDICAO,CONTEUDO,LIGACAO,ST_AGRUPADO,TP_FILTRO,CD_CRIADO 
FROM FILTROS WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO));

INSERT INTO DESTAQUE(
SELECT TRIM(UPPER(CD_USUARIO)),CD_OBJETO,CD_COLUNA,CONDICAO,CONTEUDO,COR_FUNDO,COR_FONTE,TIPO_DESTAQUE,PRIORIDADE,(SELECT NVL(MAX(CD_DESTAQUE),0)+1 FROM DESTAQUE) AS CD_DESTAQUE FROM( 
SELECT VAR_USUARIO AS CD_USUARIO,CD_OBJETO,CD_COLUNA,CONDICAO,CONTEUDO,COR_FUNDO,COR_FONTE,TIPO_DESTAQUE,PRIORIDADE
FROM DESTAQUE WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO_COP
MINUS
SELECT TRIM(UPPER(CD_USUARIO)),CD_OBJETO,CD_COLUNA,CONDICAO,CONTEUDO,COR_FUNDO,COR_FONTE,TIPO_DESTAQUE,PRIORIDADE 
FROM DESTAQUE WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO));


INSERT INTO FLOAT_FILTER_ITEM(
SELECT VAR_USUARIO AS CD_USUARIO,SCREEN,CD_COLUNA,CONTEUDO 
FROM FLOAT_FILTER_ITEM WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO_COP
MINUS
SELECT * FROM FLOAT_FILTER_ITEM WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO);

INSERT INTO OBJECT_RESTRICTION(
SELECT VAR_USUARIO AS USUARIO,CD_OBJETO,ST_RESTRICAO,DT_LAST
FROM OBJECT_RESTRICTION WHERE TRIM(UPPER(USUARIO)) = VAR_USUARIO_COP
MINUS
SELECT * FROM OBJECT_RESTRICTION WHERE USUARIO = VAR_USUARIO);

INSERT INTO PARAMETRO_USUARIO(
SELECT VAR_USUARIO AS CD_USUARIO,CD_PADRAO,CONTEUDO,PRE_LOAD
FROM PARAMETRO_USUARIO WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO_COP
MINUS
SELECT * FROM PARAMETRO_USUARIO WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO);

INSERT INTO ROLES(
SELECT VAR_USUARIO AS CD_USUARIO,CD_ROLE,TIPO
FROM ROLES WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO_COP
MINUS
SELECT * FROM ROLES WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO);

INSERT INTO COLUMN_RESTRICTION(
SELECT VAR_USUARIO AS USUARIO,CD_MICRO_VISAO,CD_COLUNA,ST_RESTRICAO,DT_LAST
FROM COLUMN_RESTRICTION WHERE TRIM(UPPER(USUARIO)) = VAR_USUARIO_COP
MINUS
SELECT * FROM COLUMN_RESTRICTION WHERE TRIM(UPPER(USUARIO)) = VAR_USUARIO);

INSERT INTO USER_NETWALL(
SELECT VAR_USUARIO AS USUARIO,NOME_REGRA,TIPO_REGRA,NET_ADDRESS,HR_INICIO,HR_FINAL,DIA_SEMANA,DT_REGRA
FROM USER_NETWALL WHERE TRIM(UPPER(USUARIO)) = VAR_USUARIO_COP
MINUS
SELECT * FROM USER_NETWALL WHERE TRIM(UPPER(USUARIO)) = VAR_USUARIO);

INSERT INTO BI_PERMISSAO_CUSTOM(
SELECT VAR_USUARIO AS NM_USUARIO,NM_VISAO,NM_COLUNA,CD_CUSTOM 
FROM BI_PERMISSAO_CUSTOM WHERE TRIM(UPPER(NM_USUARIO)) = VAR_USUARIO_COP
MINUS
SELECT * FROM BI_PERMISSAO_CUSTOM WHERE TRIM(UPPER(NM_USUARIO)) = VAR_USUARIO);

INSERT INTO USER_SCREENS(
SELECT VAR_USUARIO AS USUARIO,SCREEN,STATUS
FROM USER_SCREENS WHERE TRIM(UPPER(USUARIO)) = VAR_USUARIO_COP
MINUS
SELECT * FROM USER_SCREENS WHERE TRIM(UPPER(USUARIO)) = VAR_USUARIO);

END IF;

COMMIT;

EXCEPTION 
 WHEN OTHERS THEN 
        ROLLBACK;

END;
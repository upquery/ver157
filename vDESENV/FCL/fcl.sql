create or replace package body FCL  is

g_key                 RAW(32767)  := UTL_RAW.cast_to_raw('69198823');
g_pad_chr             VARCHAR2(1) := '~';
g_abriu_tela_infouser varchar(1); 

PROCEDURE padstring (p_text  IN OUT  VARCHAR2);



PROCEDURE padstring (p_text  IN OUT  VARCHAR2) IS

	l_units  NUMBER;
BEGIN
	IF LENGTH(p_text) MOD 8 > 0 THEN
	l_units := TRUNC(LENGTH(p_text)/8) + 1;
	p_text  := RPAD(p_text, l_units * 8, g_pad_chr);
	END IF;
END;

procedure inputp (	prm_tipo	    char default null,
					prm_ind		    char default null,
					prm_default	    char default null,
					prm_objeto	    char default null,
					prm_sufixo      char default null,
					prm_tmp_field   char default null,
					prm_script	    char default null,
					prm_list	    char default null,
					prm_ordem       varchar2 default null ) as

	ws_count		number;
	ws_script       varchar2(2000);

begin
	/*fcl.refresh_Session;*/
	--htp.p(prm_tipo);
case prm_tipo

	

	when 'CFREE_FONTE' then
		fcl.pickcolor(prm_default, '', '', prm_tmp_field, prm_objeto);
	when 'CFREE_FUNDO' then
		fcl.pickcolor(prm_default, '', '', prm_tmp_field, prm_objeto);
	when 'COR_FONTE' then
		fcl.pickcolor(prm_default, '', '', prm_tmp_field, prm_objeto);
	when 'COR_FUNDO' then
		fcl.pickcolor(prm_default, '', '', prm_tmp_field, prm_objeto);
	when 'LOCAL' then
		fcl.listbox(trim(PRM_OBJETO)||'_'||prm_sufixo, 'id_'||prm_tmp_field||prm_ind, prm_script, prm_default, prm_list, prm_tmp_field, prm_objeto);
	when 'LIGACAO' then
		fcl.listlig(trim(PRM_OBJETO)||'_'||prm_sufixo, prm_tmp_field, prm_script, prm_default, prm_list, prm_ordem);
	when 'TEXTO' THEN
		fcl.entry(trim(PRM_OBJETO)||'_'||prm_sufixo, 'id_'||prm_tmp_field||prm_ind, prm_script, prm_default, prm_list, '', trim(PRM_OBJETO));
	when 'TEXTO_UPPER' THEN
		fcl.entry(trim(PRM_OBJETO)||'_'||prm_sufixo, 'id_'||prm_tmp_field||prm_ind, prm_script, prm_default, prm_list, '', trim(PRM_OBJETO), prm_case => 'UPPERCASE');
	when 'TEXTO_LOWER' THEN
		fcl.entry(trim(PRM_OBJETO)||'_'||prm_sufixo, 'id_'||prm_tmp_field||prm_ind, prm_script, prm_default, prm_list, '', trim(PRM_OBJETO), prm_case => 'LOWERCASE');
	when 'TEXTAREA' THEN
		htp.p('<textarea data-atrib="'||trim(PRM_OBJETO)||'" title="'||prm_default||'" onblur="if(this.parentNode.parentNode.id == ''form-parametro''){ this.parentNode.parentNode.parentNode.setAttribute(''data-alterado'', ''T''); } if(document.getElementById('||chr(39)||prm_tmp_field||chr(39)||')){ document.getElementById('||chr(39)||prm_tmp_field||chr(39)||').value=this.value; } " onkeyup="'||fun.attrib_temporeal(trim(PRM_OBJETO), prm_objeto)||'" >'||prm_default||'</textarea>' );
	when 'TEXTO_FLOAT' then
		htp.p('<input class="float_title" readonly="" type="text" title="'||prm_tmp_field||'" value="'||prm_tmp_field||'">');
		fcl.entry(trim(PRM_OBJETO)||'_'||prm_sufixo, 'id_'||prm_tmp_field||prm_ind, prm_script, prm_default, prm_list, '', trim(PRM_OBJETO), prm_tmp_field);
	when 'INTEIRO' then
		fcl.entry(trim(PRM_OBJETO)||'_'||prm_sufixo, 'id_'||prm_tmp_field||prm_ind, prm_script, prm_default, prm_list, '', trim(PRM_OBJETO), prm_tmp_field);
	when 'INTEIRO_FLOAT' then
		htp.p('<input class="float_title" readonly="" type="text" title="'||prm_tmp_field||'" value="'||prm_tmp_field||'">');
		fcl.entry(trim(PRM_OBJETO)||'_'||prm_sufixo, 'id_'||prm_tmp_field||prm_ind, prm_script, prm_default, prm_list, '', trim(PRM_OBJETO), prm_tmp_field);
	when 'NUMERICO' then
		fcl.entry(trim(PRM_OBJETO)||'_'||prm_sufixo, 'id_'||prm_tmp_field||prm_ind, prm_script, prm_default, prm_list, '', trim(PRM_OBJETO), prm_tmp_field);
	when 'DATA' then
		htp.p('<input class="float_title" readonly="" type="text" title="'||prm_tmp_field||'" value="'||prm_tmp_field||'">');
		if owa_util.get_cgi_env('HTTP_USER_AGENT') like '%iPhone%'  then
			htp.p('<input readonly="readonly" style="font-size: 18px;" type="text" id="data_'||'id_'||prm_tmp_field||prm_ind||'" onfocus="calendar.set(this.id);" ontouchend="this.blur();" value="'||prm_default||'" />');
		else
			htp.p('<input readonly="readonly" type="text" id="data_'||'id_'||prm_tmp_field||prm_ind||'" onfocus="calendar.set(this.id);" ontouchend="this.blur();" value="'||prm_default||'" />');
		end if;
	when 'DATA2' then
		--htp.p('<input class="float_title" readonly="" type="text" title="'||prm_tmp_field||'" value="'||prm_tmp_field||'">');
		htp.p('<input placeholder="DD/MM/YY" type="text" id="data_'||'id_'||prm_tmp_field||prm_ind||'" oninput="this.value = VMasker.toPattern(this.value, ''99/99/99'');" value="'||prm_default||'" />');
	when 'INTEIRO' then
		
		fcl.entry(trim(PRM_OBJETO)||'_'||prm_sufixo, 'id_'||prm_tmp_field||prm_ind, prm_script, prm_default, prm_list, '', prm_tmp_field, prm_tmp_field);
		
		/*  when 'MULTI' then
	fcl.mentry(trim(PRM_OBJETO)||'_'||prm_sufixo, 'id_'||prm_tmp_field||prm_ind, prm_script, prm_default, prm_list);*/
	when 'COR_GOM' then
		fcl.pickcolor(prm_default, '', '', prm_tmp_field, prm_objeto);
	when 'FONTE' then
		fcl.pickfont(trim(PRM_OBJETO)||'_'||prm_sufixo, 'id_'||prm_tmp_field||prm_ind, prm_script, prm_default, prm_tmp_field, prm_objeto);
	when 'TAMANHO_FONTE' then
		fcl.pickfontsize(PRM_OBJETO||'_'||prm_sufixo, 'id_'||prm_tmp_field||prm_ind, prm_script, prm_default);
	when 'NEGRITO' then
	/*fcl.checkbox(PRM_TIPO||PRM_IND, trim(PRM_OBJETO)||'_'||prm_sufixo, prm_script, 'bold', '', fpdata(PRM_DEFAULT,'bold','CHECKED',''), 'id_'||prm_tmp_field||prm_ind);*/

		/*ws_script := fun.attrib_temporeal(prm_tmp_field, prm_objeto);
		
		htp.p('<select onchange="'||ws_script||'">');
			htp.p('<option value="normal">normal</option>');
			htp.p('<option value="bold" '||fpdata(PRM_DEFAULT,'bold','SELECTED','')||'>negrito</option>');
		htp.p('</select>');*/
		
		if prm_default = 'bold' then
			htp.p('<span class="checkbox checked" data-positive="bold" data-negative="normal" title="'||prm_default||'"></span>');
		else
			htp.p('<span class="checkbox" data-positive="bold" data-negative="normal" title="'||prm_default||'"></span>');
		end if;

	when 'DEGRADE' then
		
		/*fcl.checkbox(PRM_TIPO||PRM_IND, trim(PRM_OBJETO), 'nocheck', 'S', 'N', fpdata(trim(PRM_DEFAULT),'S','CHECKED',''), 'id_'||prm_tmp_field||prm_ind, prm_tmp_field, prm_objeto);*/

		if prm_default = 'S' then
			htp.p('<span class="checkbox checked" data-positive="S" data-negative="N" title="'||prm_default||'"></span>');
		else
			htp.p('<span class="checkbox" data-positive="S" data-negative="N" title="'||prm_default||'"></span>');
		end if;
	
	when 'ITALICO' then
	
		/*ws_script := fun.attrib_temporeal(prm_tmp_field, prm_objeto);
		htp.p(prm_tmp_field);*/
		/*htp.p('<select onchange="'||ws_script||'">');
			htp.p('<option value="normal">normal</option>');
			htp.p('<option value="italic" '||fpdata(PRM_DEFAULT,'italic','SELECTED','')||'>it&aacute;lico</option>');
		htp.p('</select>');*/
		
		if prm_default = 'italic' then
			htp.p('<span class="checkbox checked" data-positive="italic" data-negative="normal" title="'||prm_default||'"></span>');
		else
			htp.p('<span class="checkbox" data-positive="italic" data-negative="normal" title="'||prm_default||'"></span>');
		end if;
		
		
	/*fcl.checkbox(PRM_TIPO||PRM_IND, trim(PRM_OBJETO)||'_'||prm_sufixo, prm_script, 'italic', '', fpdata(PRM_DEFAULT,'italic','CHECKED',''), 'id_'||prm_tmp_field||prm_ind);*/
	when 'BORDA' then
		fcl.checkbox(PRM_TIPO||PRM_IND, trim(PRM_OBJETO), prm_script, '1px solid #000000', '', fpdata(trim(PRM_DEFAULT),'1px solid #000000','CHECKED',''), 'id_'||prm_tmp_field||prm_ind, prm_tmp_field, prm_objeto);
	when 'CHECK_ONLY' then
		
		/*fcl.checkbox(PRM_TIPO||PRM_IND, trim(PRM_OBJETO), 'nocheck', 'S', 'N', fpdata(trim(PRM_DEFAULT),'S','CHECKED',''), 'id_'||prm_tmp_field||prm_ind, prm_tmp_field, prm_objeto);
		if prm_default = 'S' then
			htp.p('<span class="checkbox checked" title="'||prm_default||'"></span>');
		else
			htp.p('<span class="checkbox" title="'||prm_default||'"></span>');
		end if;*/
		
		if prm_default = 'S' then
			htp.p('<span class="checkbox checked" data-positive="S" data-negative="N" title="'||prm_default||'"></span>');
		else
			htp.p('<span class="checkbox" data-positive="S" data-negative="N" title="'||prm_default||'"></span>');
		end if;
	
	when 'ANO' then
		ws_count := 2000;
			htp.formSelectOpen( cname => trim('id_'||prm_tmp_field||prm_ind)||'ano_'||prm_sufixo, cattributes => ' id="'||trim('id_'||prm_tmp_field||prm_ind)||'ano_'||prm_sufixo||'id" onchange="document.getElementById('||chr(39)||'id_'||prm_tmp_field||prm_ind||chr(39)||').value = document.getElementById('||chr(39)||trim('id_'||prm_tmp_field||prm_ind)||'ano_'||prm_sufixo||'id'||chr(39)||').options[document.getElementById('||chr(39)||trim('id_'||prm_tmp_field||prm_ind)||'ano_'||prm_sufixo||'id'||chr(39)||').selectedIndex].value; " ');
			loop
				if  ws_count > 2018 then
					exit;
				end if;

				if  to_number(nvl(prm_default,'')) = ws_count then
					fcl.formSelectOption( ws_count, ws_count, cselected => 'SELECTED');
				else
					fcl.formSelectOption( ws_count, ws_count);
				end if;
				ws_count := ws_count + 1;
			end loop;
	htp.formSelectClose;
	else
		htp.p('***');
end case;

end inputp;


procedure CHECKBOX (    prm_chkname	    varchar2 default null,
						prm_campo	    varchar2 default null,
						prm_prop	    varchar2 default null,
						prm_chk		    varchar2 default null,
						prm_nchk	    varchar2 default null,
						prm_default	    varchar2 default null,
						prm_tmp_field	varchar2 default null,
						prm_attrib      varchar2 default null,
						prm_objeto      varchar2 default null ) as

	ws_command_script      varchar2(2000);
	ws_scrip_efeito        varchar2(2000);

begin
	/*fcl.refresh_Session;*/
	
	/*case prm_attrib
		when 'NO_RADIUS' then
			ws_scrip_efeito := 'onchange=" var obj = this.parentNode.parentNode.parentNode.getAttribute(''data-obj''); if(this.checked == true){ document.getElementById(obj).style.setProperty(''border-radius'', ''0''); } else { document.getElementById(obj).style.setProperty(''border-radius'', ''7px 7px 0 0''); }"';
		when 'DASH_MARGIN' then
			ws_scrip_efeito := 'onkeypress=" var obj = this.parentNode.parentNode.parentNode.getAttribute(''data-obj''); document.getElementById(obj).style.setProperty(''margin'', this.value);"';
	else
			ws_scrip_efeito := '';
	end case;*/

	ws_scrip_efeito := fun.attrib_temporeal(prm_attrib, prm_objeto);
	
	if  prm_prop <> 'nocheck' then
		ws_command_script := ' onclick=" if(parent.document.getElementById('||chr(39)||prm_campo||chr(39)||')){ if (this.checked) { document.getElementById('||chr(39)||prm_tmp_field||chr(39)||').value='||chr(39)||prm_chk||chr(39)||'; } else { document.getElementById('||chr(39)||prm_tmp_field||chr(39)||').value=''''; } ; }  " ';
	else
		ws_command_script := ' onclick=" if (this.checked) { document.getElementById('||chr(39)||prm_tmp_field||chr(39)||').value = ''S''; } else { document.getElementById('||chr(39)||prm_tmp_field||chr(39)||').value = ''N''; }; " ';
	end if;

	htp.p('<input style="width: 14px;" type="checkbox" name="'||prm_chkname||'" '||fun.IFNOTNULL(prm_default,' checked ')||ws_command_script||' onchange="'||ws_scrip_efeito||'" >' );

end CHECKBOX;

procedure pickcolor (  prm_valor       varchar2 default null,
					prm_placeholder varchar2 default null,
					prm_id          varchar2 default null,
					prm_attrib      varchar2 default null,
					prm_obj         varchar2 default null ) as

	ws_scrip_efeito varchar2(2000);
	ws_id           varchar2(80);

begin

	ws_scrip_efeito := fun.attrib_temporeal(prm_attrib, prm_obj);

	htp.p('<input type="color" value="'||nvl(prm_valor, '#111111')||'" oninput="this.nextElementSibling.value = this.value; '||ws_scrip_efeito||'" />');

	if nvl(prm_id, 'N/A') <> 'N/A' then
		ws_id := 'id="'||prm_id||'"';
	end if;

	/*htp.p('<input type="color" value="'||nvl(prm_valor, '#111111')||'" oninput="this.nextElementSibling.value = this.value; '||ws_scrip_efeito||'" onchange="this.nextElementSibling.value = this.value; '||ws_scrip_efeito||'"/>');*/
	htp.p('<input autocomplete="on" type="text" placeholder="'||prm_placeholder||'" title="'||fun.lang('DICA: pode ser usado transparent no campo de cor')||'" '||ws_id||' style="width: 70px;" value="'||nvl(prm_valor, '')||'" oninput="this.previousElementSibling.value = this.value; '||ws_scrip_efeito||'" />');

end pickcolor;

/*
List Box
*/

procedure listlig (	prm_campo	char default null,
					prm_tmp_field	char default null,
					prm_script	char default null,
					prm_default	char default null,
					prm_list	char default null,
					prm_ordem   varchar2 default null ) as

	cursor crs_cdesc is
			select nds_cd_codigo, nds_cd_empresa, nds_cd_descricao, nds_tabela, nds_tfisica
			from CODIGO_DESCRICAO
			where	nds_tabela = upper(prm_script);

	ws_cdesc	crs_cdesc%rowtype;

	ws_cursor	integer;
	ws_linhas	integer;

	ws_codigo	varchar2(30);
	ws_descricao	varchar2(60);
	ws_par_emp	varchar2(180);

	ws_sql		varchar2(2000);

	ws_contador	number(2);
	ws_zebrado	char(20);
	ws_accesso	exception;

	ws_agrupador	long;
	ws_texto	long;
	ws_textot	long;
	ws_nm_var	long;
	ws_ct_var	long;
	ws_limitador varchar2(2000);
	ws_count    number;

begin
	/*fcl.refresh_Session;*/
	Open  crs_cdesc;
	fetch crs_cdesc into ws_cdesc;
	close crs_cdesc;

	if instr(prm_campo, 'FLOAT') > 0 then


		begin
			select nvl(propriedade, 'N/A') into ws_limitador from object_attrib where cd_object = prm_tmp_field and cd_prop = 'LIMITADORES';
		exception when others then
			ws_limitador := 'N/A';
		end;
		
		select length(propriedade) into ws_count from object_attrib where cd_object = trim(prm_tmp_field) and cd_prop = 'LIMITADORES';

		if ws_limitador <> 'N/A' then
			if  ws_cdesc.nds_cd_empresa='*' then
				ws_par_emp := ' where '||rtrim(ws_cdesc.nds_cd_codigo)||' in (select column_value from table(fun.vpipe((select propriedade from object_attrib where cd_object = '''||trim(prm_tmp_field)||''' and cd_prop = ''LIMITADORES''))))';
			else
				ws_par_emp := ' where '||rtrim(ws_cdesc.nds_cd_empresa)||' = to_number(retorna_empresa) and '||rtrim(ws_cdesc.nds_cd_codigo)||' in (select column_value from table(fun.vpipe((select propriedade from object_attrib where cd_object = '''||trim(prm_tmp_field)||''' and cd_prop = ''LIMITADORES'' and rownum = 1))))';
			end if;
		end if;
	else
		if  ws_cdesc.nds_cd_empresa='*' then
			ws_par_emp := '';
		else
			ws_par_emp := ' where '||rtrim(ws_cdesc.nds_cd_empresa)||' = to_number(retorna_empresa)';
		end if;
	end if;

	ws_sql := 'select '||rtrim(ws_cdesc.nds_cd_codigo)||', '||rtrim(ws_cdesc.nds_cd_descricao)||' from '||nvl(fun.ret_var('OWNER_TABLE_DATA'),'DWU')||'.'||rtrim(ws_cdesc.nds_tfisica)||ws_par_emp||' '||prm_ordem;

	ws_cursor := dbms_sql.open_cursor;

	dbms_sql.parse(ws_cursor, ws_sql, DBMS_SQL.NATIVE);
	dbms_sql.define_column(ws_cursor, 1, ws_codigo, 60);
	dbms_sql.define_column(ws_cursor, 2, ws_descricao, 60);

	ws_linhas := dbms_sql.execute(ws_cursor);

	ws_agrupador := substr(ws_texto, 1 ,instr(ws_texto,'|')-1);
	ws_texto := substr(ws_texto, instr(ws_texto,'|')+1, length(ws_texto));
	if (prm_campo = 'NO_') then
		htp.p('<select onchange= "document.getElementById('''||prm_tmp_field||''').value=this.options[this.selectedIndex].value " >');
	else
		htp.p('<select id="'||prm_tmp_field||'_ligacao" onchange="if(this.parentNode.parentNode.id == ''form-parametro''){ this.parentNode.parentNode.parentNode.setAttribute(''data-alterado'', ''T''); }" data-turbo="'||prm_tmp_field||'_FILTER">');
	end if;
	/*float par, não pode ficar sem parâmetro*/
	htp.p('<option value="" style="display: none;">'||fun.lang('Sem Filtro')||'</option>');

	loop
		ws_linhas := dbms_sql.fetch_rows(ws_cursor);
		if  ws_linhas <> 1 then exit; end if;

		dbms_sql.column_value(ws_cursor, 1, ws_codigo);
		dbms_sql.column_value(ws_cursor, 2, ws_descricao);

		htp.p('<option value="'||trim(ws_codigo)||'" '||fpdata(prm_default,trim(ws_codigo),'selected="selected"','')||'>'||ws_descricao||'</option>');
	end loop;
	dbms_sql.close_cursor(ws_cursor);
	htp.p('</select>');

end listlig;

procedure pickfont ( prm_campo	    varchar2 default null,
					prm_tmp_field	varchar2 default null,
					prm_script	    varchar2 default null,
					prm_default	varchar2 default null,
					prm_attrib     varchar2 default null,
					prm_obj        varchar2 default null ) as

	cursor crs_font is
		select	cd_font
		from	FONTS;

	ws_font		     crs_font%rowtype;
	ws_scrip_efeito  varchar2(2000);

begin

	ws_scrip_efeito := fun.attrib_temporeal(prm_attrib, prm_obj);
	
	htp.p('<select name="'||prm_campo||'codefont" onchange="document.getElementById('||chr(39)||prm_tmp_field||chr(39)||').value=this.options[this.selectedIndex].value; '||ws_scrip_efeito||'">');
		open crs_font;
		loop
			fetch crs_font into ws_font;
				exit when crs_font%notfound;
				htp.p('<option value="'||ws_font.cd_font||'" '||fpdata(prm_default,ws_font.cd_font,'selected="selected"','')||'>'||ws_font.cd_font||'</option>');
		end loop;
		close crs_font;
	htp.p('</select>');

end pickfont;

procedure pickfontsize (prm_campo	char default null,
			prm_tmp_field	char default null,
			prm_script	char default null,
			prm_default	char default null ) as


begin
	/*fcl.refresh_Session;*/
	htp.p('<select name="'||prm_campo||'tamanho" onchange="document.getElementById('||chr(39)||prm_tmp_field||chr(39)||').value=this.options[this.selectedIndex].value  ">');

		htp.p('<option value="10px" '||fpdata(prm_default,'10px','selected="selected"','')||'>10px</option>');
		htp.p('<option value="12px" '||fpdata(prm_default,'12px','selected="selected"','')||'>12px</option>');
		htp.p('<option value="14px" '||fpdata(prm_default,'14px','selected="selected"','')||'>14px</option>');
		htp.p('<option value="18px" '||fpdata(prm_default,'18px','selected="selected"','')||'>18px</option>');
		htp.p('<option value="22px" '||fpdata(prm_default,'22px','selected="selected"','')||'>22px</option>');
		htp.p('<option value="28px" '||fpdata(prm_default,'28px','selected="selected"','')||'>28px</option>');
		htp.p('<option value="36px" '||fpdata(prm_default,'36px','selected="selected"','')||'>36px</option>');
		htp.p('<option value="48px" '||fpdata(prm_default,'48px','selected="selected"','')||'>48px</option>');
	htp.p('</select>');
	/*htp.p('<input name="'||prm_campo||'tamanho" onchange="document.getElementById('||chr(39)||prm_campo||chr(39)||').style.'||prm_script||'=this.value+''px''; document.getElementById('||chr(39)||prm_tmp_field||chr(39)||').value=this.value;" type="range" min="14" max="32" step="2"/>');*/

end pickfontsize;

/*
Input TEXT
*/

procedure ENTRY (	prm_campo	    varchar2 default null,
					prm_tmp_field	varchar2 default null,
					prm_script	    varchar2 default null,
					prm_default	    varchar2 default null,
					prm_list	    varchar2 default null,
					prm_tipo	    varchar2 default 'TEXT',
					prm_objeto      varchar2 default null,
					prm_atrib       varchar2 default null,
					prm_case        varchar2 default 'N/A' ) as

	ws_scrip_efeito varchar2(2000);
	ws_custom_style varchar2(2000);
	ws_text			varchar2(2000);
	ws_exist        number;
	ws_onblur       varchar2(2000); 

begin
	
	ws_scrip_efeito := fun.attrib_temporeal(prm_atrib, prm_objeto);
	if trim(prm_atrib) = 'ORDEM' then
		ws_custom_style := 'position: absolute;';
		ws_text := prm_atrib;
	end if;
	
	ws_exist := 0;
	
	if trim(prm_atrib) = 'FIXED-N' then
		ws_exist := length(trim(fun.getprop(prm_objeto, 'TOTAL_GERAL_TEXTO')));
	end if;

	ws_onblur := 'if(this.parentNode.parentNode.id == ''form-parametro''){ this.parentNode.parentNode.parentNode.setAttribute(''data-alterado'', ''T''); } if(document.getElementById('||chr(39)||prm_tmp_field||chr(39)||')){ document.getElementById('||chr(39)||prm_tmp_field||chr(39)||').value=this.value; }'; 		
	if prm_case = 'UPPERCASE' then 
		ws_onblur       := 'this.value = this.value.toUpperCase(); console.log(this.value); '|| ws_onblur; 
		ws_custom_style := ws_custom_style||' text-transform: uppercase;';
	elsif prm_case = 'LOWERCASE' then 
		ws_onblur := 'this.value = this.value.toLowerCase(); console.log(this.value); '|| ws_onblur; 
		ws_custom_style := ws_custom_style||' text-transform: lowercase;';		
	end if; 

	if ws_exist > 0 then
		htp.p('<input class="readonly" readonly="" style="'||ws_custom_style||'" data-atrib="'||prm_atrib||'" title="'||prm_default||'" type="'||prm_tipo||'" name="'||prm_campo||'" value="99"                onblur="'||ws_onblur||'" onkeyup="'||ws_scrip_efeito||'" />' );
	elsif  trim(ws_text) = 'ORDEM' then
		htp.p('<textarea maxlength="1000" style=" height: 24px;" title="'||prm_default||'" type="'||prm_tipo||'" name="'||prm_campo||'" value="'||prm_default||'">'||prm_default||'</textarea>');
	else
		htp.p('<input  data-exist="'||ws_exist||'" style="'||ws_custom_style||'" data-atrib="'||prm_atrib||'" title="'||prm_default||'" type="'||prm_tipo||'" name="'||prm_campo||'" value="'||prm_default||'" onblur="'||ws_onblur||'" onkeyup="'||ws_scrip_efeito||'" />' );
	end if;
	

end ENTRY;



procedure BASET	(		j_base		char	default null ) as

begin
	htp.print('<BASE target="'||rtrim(j_base)||'">');

end BASET;



procedure PDATA (		prm_mode	varchar2 default null,
				prm_check	varchar2 default null,
				prm_data	varchar2 default null,
				prm_other	varchar2 default null )  as

begin
	if  prm_mode = prm_check then
		htp.p(PRM_DATA);
	else
		htp.p(PRM_OTHER);
	end if;

end PDATA;

function FPDATA (  prm_mode	 varchar2 default null,
				prm_check varchar2 default null,
				prm_data	 varchar2 default null,
				prm_other varchar2 default null )   return varchar2 as

begin
	if  prm_mode = prm_check then
		return(PRM_DATA);
	else
		return(PRM_OTHER);
	end if;

end FPDATA;



function FDATALINK ( 		prm_gif		varchar2 default null,
				prm_link	varchar2 default null,
				prm_type	varchar2 default 'GIF',
				prm_alt		varchar2 default null,
				prm_panel	varchar2 default 'COLUNA',
				prm_form	varchar2 default null,
				prm_select	varchar2 default null,
				prm_url		varchar2 default null,
				prm_comando     varchar2 default null ) return varchar2 as

begin
	/*fcl.refresh_Session;*/
	if  prm_panel = 'SIMPLES' then
		return('<a href="'||prm_link||'">'||htf.img(fun.r_gif(prm_gif, prm_type )));
	else
	if  prm_gif = 'NOGIF' then
		return('<a href="'||prm_url||'">'||prm_link||'</A>');
	else
		if  nvl(prm_form,'NODATA') <> 'NODATA' then
		return(htf.tabledata('<a href="'||prm_link||'" >'||htf.img(fun.r_gif(prm_gif, prm_type ), calt => prm_alt,  cattributes => 'onclick="document.location.href='''||prm_url||'&prm_comando='||prm_comando||'|'||'''+document.'||prm_form||'.'||prm_select||'.options[document.'||prm_form||'.'||prm_select||'.selectedIndex].value;" border="0" ')||'</a>','center','','','','','border="0" width="1%" '));
		else
		if  prm_panel = 'COLUNA' then
			return(htf.tabledata('<a href="'||prm_link||'" >'||htf.img(fun.r_gif(prm_gif, prm_type ), calt => prm_alt,  cattributes => 'border="0" ')||'</A>','center','','','','','border="0" width="1%" '));
		else
			return('<a href="'||prm_link||'">'||htf.img(fun.r_gif(prm_gif, prm_type ), cattributes => 'border="0" '));
		end if;
		end if;
	end if;
	end if;

end FDATALINK;

procedure XDATALINK ( 		prm_gif		varchar2 default null,
				prm_link	varchar2 default null,
				prm_type	varchar2 default 'GIF',
				prm_alt		varchar2 default null,
				prm_positions	varchar2 default null,
				prm_url		varchar2 default null,
				prm_comando     varchar2 default null ) as

begin
		htp.p(htf.tabledata( '<a href="'||prm_link||'" >'||htf.img(fun.r_gif(prm_gif, prm_type ), calt => prm_alt, cattributes => ' border="0" onclick="document.location.href='''||prm_url||'&prm_locais='''||prm_positions||';" ')|| '</a>','center','','','','',' border="0" width="0%" '));

end XDATALINK;


procedure RURL ( 	prm_parametros		varchar2 default null,
			prm_micro_visao		varchar2 default null,
			prm_coluna		varchar2 default null,
			prm_agrupador		varchar2 default null,
			prm_rp			varchar2 default 'ROLL',
			prm_colup		varchar2 default null,
			prm_comando		varchar2 default null,
			prm_objid		varchar2 default null,
			prm_ccount		varchar2 default '0' ) as

	ws_url_default			long;
	ws_colup			long;
	ws_coluna			long;
	ws_agrupador			long;
	ws_rp				long;
	ws_mode				long;

begin
	ws_colup     := prm_colup;
	ws_coluna    := prm_coluna;
	ws_agrupador := prm_agrupador;
	ws_rp	     := prm_rp;
	ws_mode	     := 'ED';

	htp.p('<script>');
	htp.p(' if  (parent.document.getElementById(''cutflag'').value == ''PASS'') {');
	htp.p('parent.document.getElementById('||chr(39)||'par_'||prm_objid||chr(39)||').value='||chr(39)||prm_parametros||chr(39)||';');
	htp.p('parent.document.getElementById('||chr(39)||'mvs_'||prm_objid||chr(39)||').value='||chr(39)||prm_micro_visao||chr(39)||';');
	htp.p('parent.document.getElementById('||chr(39)||'col_'||prm_objid||chr(39)||').value='||chr(39)||ws_coluna||chr(39)||';');
	htp.p('parent.document.getElementById('||chr(39)||'agp_'||prm_objid||chr(39)||').value='||chr(39)||ws_agrupador||chr(39)||';');
	htp.p('parent.document.getElementById('||chr(39)||'rps_'||prm_objid||chr(39)||').value='||chr(39)||ws_rp||chr(39)||';');
	htp.p('parent.document.getElementById('||chr(39)||'cup_'||prm_objid||chr(39)||').value='||chr(39)||ws_colup||chr(39)||';');
	htp.p('parent.document.getElementById('||chr(39)||'cutflag'||chr(39)||').value='||chr(39)||'STOP'||chr(39)||';');
	htp.p('}');
	htp.p('</script>');
	htp.p('OK');

end RURL; 

/*
Carrega attributos de objectos
*/

procedure ARRGETPROP (	prm_objeto	char default null,
						prm_cd_prop	in out DBMS_SQL.VARCHAR2_TABLE,
						prm_prop	in out DBMS_SQL.VARCHAR2_TABLE,
						prm_rotulo	in out DBMS_SQL.VARCHAR2_TABLE,
						prm_tipo	in out DBMS_SQL.VARCHAR2_TABLE,
						prm_sufixo	in out DBMS_SQL.VARCHAR2_TABLE,
						prm_script	in out DBMS_SQL.VARCHAR2_TABLE,
						prm_list	in out DBMS_SQL.VARCHAR2_TABLE,
						prm_grupo	in out DBMS_SQL.VARCHAR2_TABLE,
						prm_hint    in out DBMS_SQL.VARCHAR2_TABLE,
						prm_ordem   in out DBMS_SQL.NUMBER_TABLE,
						prm_screen varchar2 default 'DEFAULT' ) as

	cursor crs_attrib is
		select	t1.cd_prop, t1.label, t1.cd_tipo, nvl(t2.vl_default, t1.vl_default) vl_default, t1.sufixo, t1.script, t1.validacao, t1.grupo, t1.hint, t1.ordem
		from	OBJETOS, BI_OBJECT_PADRAO t1 
		left join
		object_padrao t2 on t2.cd_prop = t1.cd_prop and t2.tp_objeto = t1.tp_objeto
		where	cd_objeto = prm_objeto and
			OBJETOS.Tp_Objeto in (select column_value from table(fun.vpipe(t1.tp_objeto(+))))
		and nvl(t1.sufixo, 'N/A') <> 'N/A'
		and ( (prm_screen <> 'SCR_CUSTOMIZACAO') or (prm_screen = 'SCR_CUSTOMIZACAO' and t1.st_personalizado = 'S') )    -- tratamento para consulta customizda 
		order by t1.grupo, t1.cd_tipo, t1.ordem, t1.label;

	ws_attrib	crs_attrib%rowtype;
	ws_count	number;
	ws_default	varchar2(4000);


begin

	ws_count := 0;

	open crs_attrib;
	loop
		fetch crs_attrib into ws_attrib;
			exit when crs_attrib%notfound;

		ws_count := ws_count + 1;

		if ws_attrib.cd_prop = 'DASH_MARGIN' then
			ws_default := fun.getprop(prm_objeto,ws_attrib.cd_prop, prm_screen);
		elsif ws_attrib.cd_prop = 'ORDEM' then
			ws_default := fun.getprop(prm_objeto,ws_attrib.cd_prop,prm_screen=>prm_screen, prm_usuario => gbl.getUsuario);
		else
			ws_default := fun.getprop(prm_objeto,ws_attrib.cd_prop,prm_screen=>prm_screen);
		end if;
		ws_default := fcl.fpdata(ws_default,'',ws_attrib.vl_default,ws_default);

		prm_cd_prop(ws_count) := ws_attrib.cd_prop;
		prm_prop(ws_count)    := ws_default;
		prm_rotulo(ws_count)  := ws_attrib.label;
		prm_tipo(ws_count)    := ws_attrib.cd_tipo;
		prm_sufixo(ws_count)  := ws_attrib.sufixo;
		prm_script(ws_count)  := ws_attrib.script;
		prm_list(ws_count)    := ws_attrib.validacao;
		prm_grupo(ws_count)   := ws_attrib.grupo;
		prm_hint(ws_count)    := ws_attrib.hint;
		prm_ordem(ws_count)   := ws_attrib.ordem;

	end loop;
	close crs_attrib;

end ARRGETPROP;

procedure keywords as

begin

	htp.p('<script>');
		htp.prn('const ');
		for i in(select cd_constante, vl_constante from bi_constantes) loop
			htp.prn(i.cd_constante||' = "'||fun.lang(i.vl_constante)||'", ');
		end loop;
		htp.prn('TR_END = "";');
	htp.p('</script>');

	htp.p('<style>ul#filterlist::after { content: "'||fun.lang('FILTROS')||'"; } ul#destaquelist::after { content: "'||fun.lang('DESTAQUES')||'"; }</style>');

end keywords;


procedure POSICIONA_OBJETO	( prm_objeto	char	default null,
				prm_usuario   char    default null,
				prm_screen	char	default null,
				prm_browser   char    default 'DEFAULT' ) as

	cursor crs_object_location is
		SELECT	posx, posy, nvl(zindex,'auto') as zindex
		FROM	OBJECT_LOCATION
		WHERE	owner = prm_usuario and
			navegador = prm_browser and
			screen    = prm_screen and
			object_id = prm_objeto;

	ws_location			crs_object_location%rowtype;

begin
	/*fcl.refresh_Session;*/
	open crs_object_location;
	loop
		fetch crs_object_location into ws_location;
			exit when crs_object_location%notfound;
		htp.print( '<script> moveinit(document.getElementById('''||prm_objeto||'''),'''||ws_location.posx||''','''||ws_location.posy||''','''||ws_location.zindex||''');</script>' );
	end loop;
	close crs_object_location;

end POSICIONA_OBJETO;


/* >>>>>>> Salva posi&ccedil;&atilde;o do objeto!.*/


procedure SALVA_POSICAO	( prm_objeto varchar2 default null,
						prm_screen varchar2 default null,
						prm_posx   varchar2 default '0',
						prm_posy   varchar2 default '0',
						prm_zindex varchar2 default null,
						prm_tipo   varchar2 default 'posicao' ) as

begin
	/*fcl.refresh_Session;*/
	if prm_tipo = 'posicao' then
		if instr(prm_objeto, 'ARTICLE') > 0 then
			if length(prm_zindex) > 0 then
				update OBJECT_LOCATION set zindex = prm_zindex
				where	owner = 'DWU' and
					navegador = 'DEFAULT' and
					screen = prm_screen and
					object_id = prm_objeto;
			end if;
			if length(prm_posy) > 0 then
				update OBJECT_LOCATION set posy = prm_posy
				where	owner = 'DWU' and
					navegador = 'DEFAULT' and
					screen = prm_screen and
					object_id = prm_objeto;
			end if;
			commit;
		elsif instr(prm_objeto, 'SECTION') > 0 then
			update OBJECT_LOCATION set zindex = prm_zindex
				where	owner = 'DWU' and
					navegador = 'DEFAULT' and
					screen = prm_screen and
					object_id = prm_objeto;
			commit;
		else
			update OBJECT_LOCATION set posx = prm_posx, posy = prm_posy, zindex = prm_zindex
				where	owner = 'DWU' and
					navegador = 'DEFAULT' and
					screen = prm_screen and
					object_id = prm_objeto;
			commit;
		end if;
	elsif prm_tipo = 'porcentagem' then
			update OBJECT_LOCATION set porcentagem = prm_zindex
			where	owner = 'DWU' and
				navegador = 'DEFAULT' and
				screen = prm_screen and
				object_id = prm_objeto;
			commit;
		
	else
		update OBJECT_LOCATION set posx = prm_posx
			where	owner = 'DWU' and
				navegador = 'DEFAULT' and
				screen = prm_screen and
				object_id = prm_objeto;
			commit;
	end if;
exception when others then
	rollback;
	htp.p(sqlerrm);
end SALVA_POSICAO;


procedure SETPOS( prm_locais	char	default null ) as

	ws_textot	long;
	ws_objeto	long;
	ws_posx		long;
	ws_posy		long;
	ws_check	varchar2(60);
	ws_format	char(1);

begin
	/*fcl.refresh_Session;*/
	ws_textot := prm_locais;
	ws_format := 'V';

	if  fun.setem(prm_locais,'||') then
		ws_format := 'I';
		htp.p('XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX');
	end if;

	loop
		if  ws_textot = 'Y' or instr(ws_textot,'|') = 0 or ws_format = 'I' then
			exit;
		end if;

		ws_objeto := substr(ws_textot, 1 ,instr(ws_textot,'|')-1);
		ws_textot := replace(ws_textot, ws_objeto||'|', '');

		ws_posx := substr(ws_textot, 1 ,instr(ws_textot,'|')-1);
		ws_textot := replace(ws_textot, ws_posx||'|', '');

		ws_posy := substr(ws_textot, 1 ,instr(ws_textot,'|')-1);
		ws_textot := replace(ws_textot, ws_posy||'|', '');

		if  instr(ws_textot,'|') = 0 then
		ws_posy := ws_textot;
		ws_textot := 'Y';
		end if;

		begin
		select	navegador into ws_check
		from	OBJECT_LOCATION
		where	owner = fun.WHO and
			navegador = 'DEFAULT' and
			object_id = ws_objeto;
		update  OBJECT_LOCATION set posx = ws_posx, posy = ws_posy
		where	owner = fun.WHO and
			navegador = 'DEFAULT' and
			object_id = ws_objeto;
		exception
		when others	then
		insert into OBJECT_LOCATION values ('DWU','DEFAULT', 'erro', ws_objeto, ws_posx, ws_posy, 'auto', '0');
		end;

		commit;

	end loop;

end SETPOS;

procedure iniciar ( prm_screen varchar2 default null ) as

	ws_usuario         	varchar2(80);
	ws_admin           	varchar2(80);
	ws_owner_bi        	varchar2(20); 

	cursor c_usuarios is 
		select 	nvl(show_only,'N')			   as show_only, 
				nvl(tp_ordem_coluna,'M')       as tp_ordem_coluna, 
				nvl(cd_tela_inicial,'DEFAULT') as cd_tela_inicial,
				app                            as app
		  from usuarios 
		 where usu_nome = ws_usuario ;

	ws_padrao          	varchar2(40);
	ws_show_only       	varchar2(2);
	ws_cor_default     	varchar2(10);
	ws_url_default     	varchar2(800);
	ws_css             	varchar2(80);
	ws_count           	number;
	ws_test 	       	varchar2(200);
	ws_tela_inicial    	varchar2(50);
	ws_abriu_info_user 	varchar2(1); 
	wr_usuarios        	c_usuarios%rowtype; 
	ws_netwall_externo 	varchar2(1); 
	ws_nouser          	exception;

begin

	ws_usuario  := gbl.getUsuario;
	ws_admin    := nvl(gbl.getNivel, 'N');
	ws_owner_bi := nvl(fun.ret_var('OWNER_BI'),'DWU') ; 
		
	open  c_usuarios; 
	fetch c_usuarios into wr_usuarios; 
	close c_usuarios; 
	
	ws_show_only := nvl(wr_usuarios.show_only,'N'); 

	if ws_show_only = 'X' then -- Usuário não encontrado 
		htp.p(fun.pagina_html_aviso('USU&Aacute;RIO '||ws_usuario||' SEM ACESSO AO SISTEMA OU BLOQUEADO, CONTATE UM ADMINISTRADOR!', null)); 
	elsif fun.check_sys = 'OPEN' then
		
		select decode(count(*),0,'N','S') into ws_netwall_externo from user_netwall where tp_net_address = 'E'; 
		
		if  fun.check_user(ws_usuario) and ( fun.check_netwall(ws_usuario) or ws_netwall_externo = 'S') then
			if owa_util.get_cgi_env('HTTP_USER_AGENT') like '%MSIE 6.0%' then
				htp.p('Seu navegador esta desatualizado! Atualize para uma vers&atilde;o mais recente, ou altere para um navegador com mais recursos.');
			elsif owa_util.get_cgi_env('HTTP_USER_AGENT') like '%MSIE 7.0%' then
				htp.p('Seu navegador esta desatualizado! Atualize para uma vers&atilde;o mais recente, ou altere para um navegador com mais recursos.');
			elsif owa_util.get_cgi_env('HTTP_USER_AGENT') like '%MSIE 8.0%' then
				htp.p('Seu navegador esta desatualizado! Atualize para uma vers&atilde;o mais recente, ou altere para um navegador com mais recursos.');
			elsif owa_util.get_cgi_env('HTTP_USER_AGENT') like '%MSIE 9.0%' then
				htp.p('Seu navegador esta desatualizado! Atualize para uma vers&atilde;o mais recente, ou altere para um navegador com mais recursos.');
			else

				htp.p('<!DOCTYPE html>');

				htp.p('<html id="html" oncontextmenu="donut(event); return false;">');

				htp.p('<head>');

					-- monta variáveis CSS com os nomes do arquivos de imagens (deve ser chamado somente no head )
					fcl.monta_css_var_arquivos; 

					-- Carrega as variáveis de TEMA utilizadas no CSS 
					begin
						select fun.getprop('DEFAULT','TEMA', prm_usuario => ws_usuario) into ws_css from dual;
						htp.p('<link rel="stylesheet" href="'||ws_owner_bi||'.fcl.download?arquivo='||nvl(ws_css, 'ideativo')||'.css">');
					exception when others then
						htp.p('<link rel="stylesheet" href="'||ws_owner_bi||'.fcl.download?arquivo=ideativo.css">');
						ws_css := 'ideativo';
					end;

					htp.p('<link rel="stylesheet" href="'||ws_owner_bi||'.fcl.download?arquivo=default-min.css">');  -- chama arquivo CSS 
					
					htp.p('<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />');
					htp.p('<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />');
					htp.p('<meta name="google" content="notranslate" />');
					htp.p('<meta name="theme-color" content="#9a9a9a"/>');
					htp.p('<title>UpQuery</title>');

					fcl.keywords;

					if ws_admin = 'A' THEN
						FCL.VERIFICA_JOB;
					END IF;

					htp.p('<meta http-equiv="Pragma" content="no-cache"/>');
					htp.p('<meta http-equiv="Expires" content="timestamp"/>');
					htp.p('<meta http-equiv="cache-control" content="max-age=0" />');
					htp.p('<meta http-equiv="cache-control" content="no-cache" />');
					htp.p('<meta name="apple-mobile-web-app-capable" content="yes" />');
					htp.p('<meta name="mobile-web-app-capable" content="yes" />');
					htp.p('<meta name="viewport" content="width=device-width,user-scalable=no, initial-scale=1">');
					htp.p('<link rel="favicon" type="image/png" href="'||fun.r_gif('upquery-icon','PNG')||'" />');
					htp.p('<link rel="icon" type="image/png" href="'||fun.r_gif('ipad','PNG')||'" />');
					htp.p('<link rel="icon" type="image/png" href="'||fun.r_gif('ipad','SVG')||'" />');
					htp.p('<link rel="shortcut icon apple-touch-icon" href="'||fun.r_gif('ipad','PNG')||'" />');
					htp.p('<link rel="apple-touch-icon" href="'||fun.r_gif('ipad','PNG')||'" />');
					htp.p('<link rel="apple-touch-startup-image" href="'||fun.r_gif('logo','PNG')||'">');
					htp.p('<link rel="json" href="'||ws_owner_bi||'.fcl.download?arquivo=manifest.json">');
					htp.p('<meta name="apple-mobile-web-app-status-bar-style" content="black">');
					if nvl(prm_screen, 'N/A') <> 'N/A' then
						htp.p('<script>setTimeout(function(){ if(!document.getElementById(''starting'')){ shscr('''||prm_screen||'''); } else { tempoteste = setInterval(function(){ if(!document.getElementById(''starting'')){ clearInterval(tempoteste); shscr('''||prm_screen||'''); } }, 500); } document.getElementById(''main'').style.setProperty(''background-color'', ''transparent''); }, 3800);</script>');
					end if;
                    -- bibliotecas novas para gerar pdf das páginas
                    htp.p('<script src="'||ws_owner_bi||'.fcl.download?arquivo=jspdf.umd-min.js"></script>');
                    htp.p('<script src="'||ws_owner_bi||'.fcl.download?arquivo=html2canvas-min.js"></script>');
                    htp.p('<script src="'||ws_owner_bi||'.fcl.download?arquivo=html2pdf-min.js"></script>');
				htp.headClose;

				begin
					select nvl(cor_fundo, '#FFFFFF'), nvl(url_fundo, fun.r_gif('bg','PNG')) into ws_cor_default, ws_url_default from all_screens where screen = 'DEFAULT' and rownum = 1;
					--if instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'Safari/') <> 0 and instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'Chrome/') = 0 then
					--	select nvl(cor_fundo, '#FFFFFF'), nvl(url_fundo, fun.r_gif('bg','JPG')) into ws_cor_default, ws_url_default from all_screens where screen = 'DEFAULT' and rownum = 1;
					--else
					--	select nvl(cor_fundo, '#FFFFFF'), nvl(url_fundo, fun.r_gif('bg','PNG')) into ws_cor_default, ws_url_default from all_screens where screen = 'DEFAULT' and rownum = 1;
					--end if;
				exception when others then
					ws_cor_default := '#FFFFFF';
					ws_url_default := fun.r_gif('bg','PNG');
					--if (instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'Safari/') <> 0 and instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'Chrome/') = 0) or 
					--   (instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'Android') <> 0) or (instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'iPhone') <> 0) then
					--	ws_url_default := fun.r_gif('bg','JPG');
					--else 
					--	ws_url_default := fun.r_gif('bg','PNG');
					--end if;
				end;

				begin
					ws_url_default := fun.subpar(ws_url_default, 'DEFAULT');
				exception when others then
					ws_url_default := ws_url_default;
				end;

				htp.p('<body id="princp" class="slide-'||ws_show_only||'" onload="start();">');
					htp.p('<div id="extra">');

						htp.p('<input type="hidden" name="moviment" id="movimento" value="yes" />');
						htp.p('<input type="hidden" name="current_sc" id="current_screen" value="DEFAULT" />');
						htp.p('<input type="hidden" id="usuario" value="'||ws_usuario||'" />');
						htp.p('<input type="hidden" id="admin" value="'||ws_admin||'" />');
						htp.p('<input type="hidden" name="usu-tp_ordem_coluna" id="usu-tp_ordem_coluna" value="'||wr_usuarios.tp_ordem_coluna||'" />');  -- Propriedade de usuário 
						htp.p('<input type="hidden" name="sis-netwall-externo" id="sis-netwall-externo" value="'||ws_netwall_externo||'" />');           -- Faz validação de netwall com ip externo (S/N)
						htp.p('<input type="hidden" name="mobile-permission" id="mobile-permission" value="' || wr_usuarios.app|| '|' || fun.lang('Sem permiss&atilde;o para conex&atilde;o via app.') || '" />');           -- Faz validação de netwall com ip externo (S/N)
						
						htp.p('<input type="hidden" name="ndrobj" id="drill_obj" value="NOC" />');
						htp.p('<input type="hidden" name="reconx" id="refcon" value="N" />');
						htp.p('<input type="hidden" name="ndrtogo" id="drill_go" value="" />');
						htp.p('<input type="hidden" name="ndrobjx" id="drill_x" value="" />');
						htp.p('<input type="hidden" name="ndrobjy" id="drill_y" value="" />');
						htp.p('<input type="hidden" name="ndrshow" id="drill_show" value="" />');
						htp.p('<input type="hidden" name="agent" id="agent" value="'||owa_util.get_cgi_env('HTTP_USER_AGENT')||'" />');
						htp.p('<input type="hidden" name="id_atualizar_menu" id="id_atualizar_menu" value="S" />');

						if ws_show_only = 'S' then
							for i in(select screen, time from user_sequence t1 where usuario = ws_usuario order by ordem) loop
								htp.p('<input type="hidden" class="show_only" value="'||i.screen||'" data-time="'||i.time||'" />');
							end loop;
						end if;

						begin
							select nvl(CONTEUDO, 'PORTUGUESE') into ws_padrao
							from   PARAMETRO_USUARIO
							where  cd_usuario = ws_usuario and
							cd_padrao='CD_LINGUAGEM';
						exception when others then
							ws_padrao := 'PORTUGUESE';
						end;

						htp.p('<input type="hidden" id="xe" value="'||nvl(fun.ret_var('XE'), 'N')||'">');

						htp.p('<input type="hidden" id="user-language" value="'||ws_padrao||'">');
						htp.p('<input type="hidden" id="sys-language" value="'||fun.ret_var('LANG_SYS')||'">');
						htp.p('<div id="layer">');
							htp.p('<div class="layer-fundo"></div>');
							htp.p('<div class="layer-spin spin5"></div>');
							htp.p('<div class="layer-spin spin4"></div>');
							htp.p('<div class="layer-spin spin3"></div>');
							htp.p('<div class="layer-spin spin2"></div>');
							htp.p('<div class="layer-spin spin1"></div>');
							htp.p('<div class="layer-icon"></div>');
					
							htp.p('<a title="'||fun.lang('Cancelar')||'" onclick=" try { window.stop(); var layer = document.getElementById(''layer''); layer.children[1].classList.remove(''visivel'');  layer.children[0].classList.remove(''open''); layer.children[2].classList.remove(''open''); alerta(''feed-fixo'', '''||fun.lang('Carregamento dos objetos foi interrompido!')||'''); if(document.getElementById(''layer'').className == ''ativo''){ loading(); } } catch(e){ document.execCommand(''Stop'', false); document.getElementById(''layer'').setAttribute(''class'',''''); } ">X</a>');
						htp.p('</div>');
					
						if nvl(ws_show_only, 'N') <> 'S' then
							fcl.userinfo ();
							if g_abriu_tela_infouser = 'N' then 
								fcl.notice_popup_mount (prm_tipo => 'INICIO' ); 
							end if; 
						end if;


						htp.p('<div id="obs-field"></div>');

						htp.p('<div id="text-talk" class="" data-objeto="" data-line="" onmouseleave="if(event.relatedTarget != null){ clearInterval(textTalk); }">');
							htp.p('<div class="list_container">');
							htp.p('</div>');
							
							htp.p('<div class="chat_container">');
								htp.p('<h4>'||fun.lang('MENSAGENS')||'</h4>');
								htp.p('<ul id="campo"></ul>');
								htp.p('<input id="fieldmsg" type="text" placeholder="'||fun.lang('Digite a mensagem')||'" onkeypress=" if(event.which == 13){ send_textPost(this.parentNode.getAttribute(''data-objeto''), this.parentNode.getAttribute(''data-line'')); }" />');
								
								htp.p('<div class="talk-block">');
									htp.p('<a class="script" onclick="ajax(''list'', ''text_post'', ''prm_objeto=&prm_line=&prm_group=''+this.nextElementSibling.title, true, ''campo'');"></a>');
									fcl.fakeoption('usuario-msg', fun.lang('Lista de usu&aacute;rios'), '', 'lista-usuarios-msgs', 'N', 'N');
									fcl.fakeoption('tempo-msg', fun.lang('Tempo da mensagem'), '', 'lista-msg-tempo', 'N', 'N');
								htp.p('</div>');

								htp.p('<div style="width: 100%; display: flex; margin: 10px 0;">');
								
									htp.p('<a class="addpurple" onclick="send_textPost('', '');">'||fun.lang('ENVIAR MENSAGEM')||'</a>');
									
									
									htp.p('<img id="sendmail" onclick="this.classList.toggle(''selected'');" src="'||fun.r_gif('email','PNG')||'" />');
									htp.p('<img id="sendsms" onclick="this.classList.toggle(''selected'');" src="'||fun.r_gif('cell','PNG')||'" />');

								htp.p('</div>');
							htp.p('</div>');
						htp.p('</div>');

						fcl.perfil;

						fcl.float_menu(prm_screen);


						if ws_admin = 'A' then
							htp.p('<div id="screenres">');
								htp.p('<div class="s1920"><span>1920x1080(iphone6+)</span></div>');
								htp.p('<div class="s1334"><span>1334x750(iphone6)</span></div>');
								htp.p('<div class="s1280"><span>1280x720</span></div>');
								htp.p('<div class="s1136"><span>1136x640(iphone5)</span></div>');
								htp.p('<div class="s1024"><span>1024x768(ipad)</span></div>');
								htp.p('<div class="s960"><span>960x640(iphone4)</span></div>');
							htp.p('</div>');
							htp.p('<div id="rule"></div>');
						end if;

						htp.p('<div id="float-space" class="float invisible">');
							htp.p('<a class="link" onclick="var filhos = document.getElementById(''float-space-inner'').children; for(i=0;i<filhos.length;i++){ if(filhos[i].children[2].className.indexOf(''float'') != -1){ var multi = filhos[i].children[2].children[0].children; var multivar = ''''; for(b=0;b<multi.length;b++){ if(multi[b].selected == true){ multivar = multivar+''|''+multi[b].value; }} ajax(''fly'', ''save_float'', ''ws_conteudo=''+encodeURIComponent(multivar)+''&ws_padrao=''+filhos[i].id);} else { if(filhos[i].children[2]){ ajax(''fly'', ''save_float'', ''ws_conteudo=''+encodeURIComponent(filhos[i].children[2].value)+''&ws_padrao=''+filhos[i].id);} } } setTimeout(function(){ shscr(document.getElementById(''current_screen'').value) }, 500*filhos.length); document.getElementById(''float-space'').classList.toggle(''invisible'');">ALTERAR</a>');
						htp.p('</div>');

						htp.p('<div id="float-filter2" class="float invisible">');
							htp.p('<a class="link" onclick="var filhos = document.getElementById(''float-filter-inner'').children; for(i=0;i<filhos.length;i++){ if(filhos[i].children[2].className.indexOf(''float'') != -1){ var multi = filhos[i].children[2].children[0].children; var multivar = ''''; for(b=0;b<multi.length;b++){ if(multi[b].selected == true){ multivar = multivar+''|''+multi[b].value; }} ajax(''fly'', ''save_float_filter'', ''prm_conteudo=''+encodeURIComponent(multivar)+''&prm_coluna=''+filhos[i].id+''&prm_screen=''+document.getElementById(''current_screen'').value); } else { if(filhos[i].children[0]){ ajax(''fly'', ''save_float_filter'', ''prm_conteudo=''+encodeURIComponent(filhos[i].children[0].value)+''&prm_coluna=''+filhos[i].id.replace(''_FILTER'', '''')+''&prm_screen=''+document.getElementById(''current_screen'').value); } } } setTimeout(function(){ shscr(document.getElementById(''current_screen'').value); }, 100*filhos.length); document.getElementById(''float-filter'').classList.toggle(''invisible'');">ALTERAR</a>');
						htp.p('</div>');

						if ws_show_only <> 'S' then
							htp.p('<div id="call-options" style="display: none;">');

								htp.p('<div id="space-options"></div>');
								htp.p('<a class="border" onclick="var space = document.getElementById(''space''); if(parseInt(space.style.width) > 0){ space.style.setProperty(''width'', ''0''); space.style.overflowY = ''hidden''; this.className=''border''; } else { if(parseInt(maxCall()) > 0){ space.style.setProperty(''width'', maxCall()); space.style.overflowY = ''scroll''; this.className=''border open'';} }"></a>');
							htp.p('</div>');
						end if;

						htp.p('<ul id="filterlist" class="filtro hidden" ontouchend="this.className = ''filtro hidden'';" onmouseleave="this.className = ''filtro hidden''; this.setAttribute(''data-desc'', '''');"></ul>');

						htp.p('<ul id="destaquelist" class="filtro hidden" ontouchend="this.className = ''filtro hidden'';" onmouseleave="this.className = ''filtro hidden''; this.setAttribute(''data-desc'', '''');"></ul>');

						fcl.alerta;

						htp.p('<a id="saving"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"viewBox="0 0 468.293 468.293" style="enable-background:new 0 0 468.293 468.293;" xml:space="preserve"> <path style="fill:#2D92BA;" d="M433.951,468.293H34.341c-10.345,0-18.732-8.386-18.732-18.732V18.732C15.61,8.386,23.996,0,34.341,0 h345.82c28.322,28.322,44.2,44.2,72.522,72.522v377.039C452.683,459.906,444.296,468.293,433.951,468.293z"/> <path style="fill:#E0E5E8;" d="M322.648,177.518H118.191c-10.345,0-18.732-8.386-18.732-18.732V0h241.92v158.787 C341.38,169.132,332.994,177.518,322.648,177.518z"/> <path style="fill:#647989;" d="M281.782,151.198h-43.707c-3.448,0-6.244-2.796-6.244-6.244V32.564c0-3.448,2.796-6.244,6.244-6.244 h43.707c3.448,0,6.244,2.795,6.244,6.244v112.39C288.026,148.403,285.23,151.198,281.782,151.198z"/> <g> <path style="fill:#3B566A;" d="M85.527,443.426H41.82v-37.463c0-3.448,2.795-6.244,6.244-6.244h31.22 c3.448,0,6.244,2.795,6.244,6.244V443.426z"/> <path style="fill:#3B566A;" d="M426.473,443.426h-43.707v-37.463c0-3.448,2.796-6.244,6.244-6.244h31.22 c3.448,0,6.244,2.795,6.244,6.244V443.426z"/> </g> <g> <rect x="41.822" y="433.308" style="fill:#D4D5DB;" width="43.707" height="10.115"/> <rect x="382.764" y="433.308" style="fill:#D4D5DB;" width="43.707" height="10.115"/> </g> <path style="fill:#EBEFF2;" d="M359.009,302.076v166.212H109.315V302.076c0-10.366,8.367-18.732,18.732-18.732h212.23 C350.58,283.344,359.009,291.71,359.009,302.076z"/> <path style="fill:#4EBD9E;" d="M359.009,302.076v25.849H109.315v-25.849c0-10.366,8.367-18.732,18.732-18.732h212.23 C350.58,283.344,359.009,291.71,359.009,302.076z"/> <g> <path style="fill:#D4D5DB;" d="M334.065,354.881H134.259c-3.451,0-6.244,2.796-6.244,6.244c0,3.448,2.793,6.244,6.244,6.244 h199.806c3.451,0,6.244-2.796,6.244-6.244C340.309,357.676,337.516,354.881,334.065,354.881z"/> <path style="fill:#D4D5DB;" d="M334.065,391.123H134.259c-3.451,0-6.244,2.796-6.244,6.244c0,3.448,2.793,6.244,6.244,6.244 h199.806c3.451,0,6.244-2.796,6.244-6.244C340.309,393.919,337.516,391.123,334.065,391.123z"/> <path style="fill:#D4D5DB;" d="M334.065,427.365H134.259c-3.451,0-6.244,2.796-6.244,6.244c0,3.448,2.793,6.244,6.244,6.244 h199.806c3.451,0,6.244-2.796,6.244-6.244C340.309,430.161,337.516,427.365,334.065,427.365z"/> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg></a>');

						if ws_admin = 'A' then
							htp.p('<div id="debug" data-value="0">');
							htp.p('<input autocomplete="on" list="debug-list" id="debug-in" type="text" value="" style="width: 92%; margin-top: 6px; max-width: none; height: 22px;" onkeypress="debug(event.which);"/>');
							htp.p('<a title="'||fun.lang('fechar')||'" style="color: #FFF; font-size: 12px; font-weight: bold; margin: 14px 0 14px 5px;" onclick="this.parentNode.className=''''; document.getElementById(''debug'').setAttribute(''data-value'', 0);">'||fun.lang('FECHAR')||'</a>');
							htp.p('<input type="hidden" value="" id="debug-key">');
							htp.p('<datalist id="debug-list">');
									htp.p('<option value="dashboard">');
									htp.p('<option value="rule">');
									htp.p('<option value="query">');
									htp.p('<option value="screen">');
									htp.p('<option value="grid(Y,X)">');
									htp.p('<option value="upload">');
									htp.p('<option value="padrao">');
									htp.p('<option value="help">');
								htp.p('</datalist>');
							htp.p('</div>');
						end if;
						
						-- DIV painel de busca por palavras
						htp.p('<div id="panel-default" class="">');
							htp.p('<div class="panel-heading"></div>');
							htp.p('<div class="panel-body">');
								htp.p('<div class="search row">');
									htp.p('<div class="col-xs-6">');
										htp.p('<span id="closeSearch" class="closerP">');
											htp.p('<svg width="8" height="13" viewBox="0 0 8 13" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6.0031 12.223L0.267578 6.49724L6.0031 0.771484L7.34139 2.10749L2.94416 6.49724L7.34139 10.887L6.0031 12.223Z" fill="#191147"/></svg>');
										htp.p('</span>');
										htp.p('<input type="text" name="keyword" class="form-control input-sm" placeholder="">');
										htp.p('<a id="backSearch" title="Anterior">Anterior</a>');
										htp.p('<a id="nextSearch" title="Pr&oacute;xima">Pr&oacute;xima</a>');
										htp.p('<a id="searchCount"></a>');
										--htp.p('<a id="closeSearchP" title="Fechar">X</a>');
									htp.p('</div>');
								htp.p('</div>');
							htp.p('</div>');
						htp.p('</div>');

					htp.p('</div>');   -- fecha a DIV extra 
					
					
					if nvl(prm_screen, 'N/A') <> 'N/A' then
						ws_url_default := '';
					end if;

					/* força hardware aceleration */
					if fun.ret_var('GPU') = 'S' then
						htp.p('<style> div#main div.dragme { transform: translate3d(0, 0, 0); -moz-transform: translate3d(0, 0, 0); -webkit-transform: translate3d(0, 0, 0); } </style>');
					end if;
					
					htp.p('<div id="screen-props" style="display: none;">');

						htp.p('<style>');
						htp.p('div#main { background-color: '||ws_cor_default||'; }');
						htp.p('div#main:before { background-image: url('||ws_url_default||'); background-repeat: '||nvl(fun.getprop('DEFAULT','REPEAT'), 'no-repeat')||'; background-position: '||nvl(fun.getprop('DEFAULT','IMG_POS'), 'center')||'; background-size: inherit; }');
						htp.p('</style>');

					htp.p('</div>');

					-- Abre div MAIN 
					if ws_admin = 'A' then 
						htp.p('<div id="main">');
					else
						htp.p('<div id="main" class="usuario">');
					end if;
					htp.p('</div>');   -- fecha div MAIN 

					htp.p('<div id="main-ext" style="position: absolute; top: 0; left: 0; width: 100%;"></div>');


					if length(fun.ret_var('JS_ADICIONAL')) > 0 then
						for i in(select column_value from table(fun.vpipe((fun.ret_var('JS_ADICIONAL'))))) loop
							htp.p('<script src="'||ws_owner_bi||'.fcl.download?arquivo='||lower(trim(i.column_value))||'.js"></script>');
						end loop;
					end if;

					if length(fun.ret_var('CSS_ADICIONAL')) > 0 then
						for i in(select column_value from table(fun.vpipe((fun.ret_var('CSS_ADICIONAL'))))) loop
							htp.p('<link rel="stylesheet" href="'||ws_owner_bi||'.fcl.download?arquivo='||lower(trim(i.column_value))||'.css">');
						end loop;
					end if;

					if ws_admin = 'A' then
						htp.p('<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.min.js"></script>');
					end if;

					htp.p('<script>const OWNER_BI = "'||ws_owner_bi||'", USUARIO = "'||ws_usuario||'", ADMIN = "'||ws_admin||'", LAYER = document.getElementById(''layer''), MAIN = document.getElementById(''main''), PRINCP = document.getElementById(''princp'');</script>');

					htp.p('<script src="'||ws_owner_bi||'.fcl.download?arquivo=calendar.js"></script>');
					htp.p('<script src="'||ws_owner_bi||'.fcl.download?arquivo=default-min.js"></script>');
					htp.p('<script src="'||ws_owner_bi||'.fcl.download?arquivo=vanilla-masker.js"></script>');
					htp.p('<script src="'||ws_owner_bi||'.fcl.download?arquivo=qrcode.min.js"></script>');
					htp.p('<script src="'||ws_owner_bi||'.fcl.download?arquivo=echarts.5.1.js"></script>');
					htp.p('<script src="'||ws_owner_bi||'.fcl.download?arquivo=xlsx.mini.min.js"></script>');  -- converte somente para XLSX		 
					
					select count(*) into ws_count from objetos where tp_objeto = 'MAPAGEOLOC'; 

					if ws_count > 0 then
						htp.p('<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDkr75GOMHoiIk1Va2KOd6nLaa0nBM35AM&libraries=visualization"></script>');
					end if;

					htp.p('<link rel="stylesheet" href="'||ws_owner_bi||'.fcl.download?arquivo=pell.min.css">');
					htp.p('<script type="text/javascript" src="'||ws_owner_bi||'.fcl.download?arquivo=pell.min.js"></script>');
					htp.p('<link href="https://fonts.googleapis.com/css?family=Courier+Prime" rel="stylesheet" type="text/css">');
					htp.p('<link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet" type="text/css">');
					htp.p('<link href="https://fonts.googleapis.com/css?family=Quicksand" rel="stylesheet" type="text/css">');
					htp.p('<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro&display=swap" rel="stylesheet" type="text/css">'); 
					htp.p('<link rel="stylesheet" href="'||ws_owner_bi||'.fcl.download?arquivo=bro.css">');
					htp.p('<script type="text/javascript" src="'||ws_owner_bi||'.fcl.download?arquivo=mark.min.js"></script>');
					htp.p('<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js" defer></script>');

				htp.p('</body>');

				htp.p('</html>');
				-- Abre Tela inicial/default do usuário -- Se não foi passado tela inicial na abertura do BI - A chamada é feita somente depois que do termino do carregamento
				if nvl(prm_screen, 'N/A') = 'N/A' then   

					if wr_usuarios.cd_tela_inicial <> 'DEFAULT' then 
						htp.p('<script>setTimeout(function(){ if(!document.getElementById(''starting'')){ shscr('''||wr_usuarios.cd_tela_inicial||''');  } else { tempoteste = setInterval(function(){ if(!document.getElementById(''starting'')){ clearInterval(tempoteste); shscr('''||wr_usuarios.cd_tela_inicial||'''); } }, 500); } }, 2000);</script>');
					end if; 

				end if; 

			end if;

		else
			
			IF WS_USUARIO = 'NOUSER' THEN

				htp.p(fun.pagina_html_aviso('SESS&Atilde;O ENCERRADA, ATUALIZE A P&Aacute;GINA DO NAVEGADOR!', null)); 

			ELSE

				htp.p(fun.pagina_html_aviso('USU&Aacute;RIO '||ws_usuario||' SEM ACESSO AO SISTEMA!', null)); 

			END IF;

		end if;
	else
		htp.p(fun.pagina_html_aviso( 'SISTEMA EM MANUTEN&Ccedil;&Atilde;O!', null)); 
	end if;
exception 
	when others then
		htp.p(sqlerrm);
end iniciar;



procedure GPS( prm_posicao	varchar	default null ) as

begin
	insert into log_eventos values(sysdate, 'Localiza&ccedil;&atilde;o-['||prm_posicao||']', gbl.getUsuario, 'LOCAL', 'GPS', '01');
exception when others then
	htp.p(sqlerrm);
end GPS;

procedure DATA ( prm_objeto	    varchar	 default null,
				prm_parametros varchar2 default null,
				prm_screen     varchar2 default null ) as

	ws_cd_ponto		PONTO_AVALIACAO.cd_ponto%type;
	ws_nm_ponto		PONTO_AVALIACAO.nm_ponto%type;
	ws_ds_ponto		PONTO_AVALIACAO.ds_ponto%type;
	ws_tp_renovacao		PONTO_AVALIACAO.tp_renovacao%type;
	ws_cd_micro_visao PONTO_AVALIACAO.cd_micro_visao%type;
	ws_parametros		PONTO_AVALIACAO.parametros%type;
	ws_vl_salvo		PONTO_AVALIACAO.vl_salvo%type;
	ws_cs_parametros	PONTO_AVALIACAO.cs_parametros%type;
	ws_cs_coluna		PONTO_AVALIACAO.cs_coluna%type;
	ws_cs_agrupador		PONTO_AVALIACAO.cs_agrupador%type;
	ws_cs_rp		PONTO_AVALIACAO.cs_rp%type;
	ws_cs_colup		PONTO_AVALIACAO.cs_colup%type;

	ws_cd_objeto		OBJETOS.cd_objeto%type;
	ws_nm_objeto		OBJETOS.nm_objeto%type;
	ws_tp_objeto		OBJETOS.tp_objeto%type;
	ws_cd_usuario		OBJETOS.cd_usuario%type;
	ws_atributos		OBJETOS.atributos%type;
	ws_ds_objeto		OBJETOS.ds_objeto%type;

	ws_obj			varchar2(60);
	ws_tip			varchar2(60);
	ws_referencia		varchar2(60);

begin
	/*fcl.refresh_Session;*/
	select cd_objeto, 	nm_objeto,    tp_objeto,    cd_usuario,    atributos,    ds_objeto    into
		ws_cd_objeto,	ws_nm_objeto, ws_tp_objeto, ws_cd_usuario, ws_atributos, ws_ds_objeto
	from   OBJETOS
	where  cd_objeto=prm_objeto;

	ws_obj := trim(prm_objeto);
	ws_tip := trim(ws_tp_objeto);

	select cd_ponto,    nm_ponto,    ds_ponto,    tp_renovacao,    cd_micro_visao,    parametros,    vl_salvo,    cs_parametros,    cs_coluna,    cs_agrupador,    cs_rp,    cs_colup    into
		ws_cd_ponto, ws_nm_ponto, ws_ds_ponto, ws_tp_renovacao, ws_cd_micro_visao, ws_parametros, ws_vl_salvo, ws_cs_parametros, ws_cs_coluna, ws_cs_agrupador, ws_cs_rp, ws_cs_colup
	from   PONTO_AVALIACAO
	where  cd_ponto = prm_objeto;
	fcl.charout('1|1', ws_cd_micro_visao, ws_cd_objeto, prm_screen);

end DATA;


procedure DATALINK ( prm_gif         varchar2 default null,
					prm_link        varchar2 default null,
					prm_type        varchar2 default 'GIF',
					prm_alt         varchar2 default null,
					prm_panel       varchar2 default 'COLUNA',
					prm_form        varchar2 default null,
					prm_select	     varchar2 default null,
					prm_url	     varchar2 default null,
					prm_comando     varchar2 default null,
					prm_id          varchar2 default null,
					prm_idgif       varchar2 default null,
					prm_addscript   varchar2 default null,
					prm_attrib      varchar2 default 'title',
					prm_cattributes varchar2 default null,
					prm_hideb       varchar2 default null ) as

	ws_showcom		varchar2(100);
	ws_hideb		varchar2(100) := ' ';

begin
	/*fcl.refresh_Session;*/
	if  prm_hideb = 'HIDE' then
		ws_hideb := ' style=" display: none; " ';
	end if;

	if  prm_panel = 'NOSHOW' then
		ws_showcom := '';
	else
		ws_showcom := 'hdobj('||chr(39)||'telosa'||chr(39)||','||chr(39)||''||chr(39)||');';
	end if;

	if  prm_comando in ('SAVE','INSGRF','INSPAV','EDPROP','INSPTR','DLPROP') then
		if  prm_comando = 'INSPAV' then
			htp.p(htf.tabledata('<a href="'||prm_link||'" >'||htf.img(fun.r_gif(prm_gif, prm_type),  calt => prm_alt,  cattributes => fcl.fpdata(prm_idgif,'','',' id="'||prm_idgif||'"')||' onclick="carrega('''||prm_url||'?ws_par_sumary='||'''+document.getElementById('''||prm_form||''').'||prm_attrib||'+'''||'&ws_par_tipo='||'''+document.getElementById(''seecol_type'').value'||'+'''||'&ws_par_seecol='||'''+document.getElementById(''seecolx'').value'||'); '||prm_addscript||' '||ws_showcom||' " border="0" ')||'</a>','center','','','','','border="0" '||ws_hideb||' width="1%" id="'||prm_id||'" '||prm_cattributes));
		else
			if  prm_comando = 'INSGRF' then
				htp.p(htf.tabledata('<a href="'||prm_link||'" >'||htf.img(fun.r_gif(prm_gif, prm_type),  calt => prm_alt,  cattributes => fcl.fpdata(prm_idgif,'','',' id="'||prm_idgif||'"')||' onclick="'||prm_addscript||'carrega('''||prm_url||'?ws_par_sumary='||'''+document.getElementById('''||prm_form||''').'||prm_attrib||'+'''||'&ws_par_tipo='||'''+document.getElementById(''seecol_type'').value'||'+'''||'&ws_par_seecol='||'''+document.getElementById(''seecolx'').value'||'+'''||'&ws_par_colunas='||'''+document.getElementById(''col_''+parent.document.getElementById(''seecol_content'').value).value); '||prm_addscript||' '||ws_showcom||' " border="0" ')||'</A>','center','','','','','border="0" '||ws_hideb||' width="1%" id="'||prm_id||'" '||prm_cattributes));
			else
				htp.p(htf.tabledata('<a href="'||prm_link||'" >'||htf.img(fun.r_gif(prm_gif, prm_type),  calt => prm_alt,  cattributes => fcl.fpdata(prm_idgif,'','',' id="'||prm_idgif||'"')||' onclick="carrega('''||prm_url||'?ws_par_sumary='||'''+document.getElementById('''||prm_form||''').'||prm_attrib||'); '||prm_addscript||' '||ws_showcom||' " border="0" ')||'</A>','center','','','','','border="0" '||ws_hideb||' width="1%" id="'||prm_id||'" '||prm_cattributes));
			end if;
		end if;
	else
		if  prm_gif = 'NOGIF' then
			htp.p('<a href="'||prm_link||'">'||htf.img(fun.r_gif(prm_gif, prm_type ), cattributes => 'border="0" '||fun.IFNOTNULL(prm_id,' id="'||prm_id||'"'))||' </a>');
		else
			if  nvl(prm_form,'NODATA') <> 'NODATA' then
				htp.p(htf.tabledata('<a href="'||prm_link||'" >'||htf.img(fun.r_gif(prm_gif, prm_type ), calt => prm_alt,  cattributes => fcl.fpdata(prm_idgif,'','',' id="'||prm_idgif||'"')||' onclick="document.location.href='''||prm_url||'&prm_comando='||prm_comando||'|'||'''+document.'||prm_form||'.'||prm_select||'.options[document.'||prm_form||'.'||prm_select||'.selectedIndex].value;" border="0" '||fun.IFNOTNULL(prm_id,' id="'||prm_id||'"'))||'</a>','center','','','','','border="0" '||ws_hideb||' width="1%"  id="'||prm_id||'" '||prm_cattributes));
			else
				if  prm_panel = 'COLUNA' then
					htp.p(htf.tabledata('<a href="'||prm_link||'" >'||htf.img(fun.r_gif(prm_gif, prm_type ), calt => prm_alt,  cattributes => prm_cattributes||fcl.fpdata(prm_idgif,'','',' id="'||prm_idgif||'"')||' title="'||prm_alt||'" border="0" ')||'</a>','center','','','','','border="0" '||ws_hideb||' width="1%" '||fun.IFNOTNULL(prm_id,' id="'||prm_id||'"'||prm_cattributes)));
				else
					htp.p('<a href="'||prm_link||'">'||htf.img(fun.r_gif(prm_gif, prm_type ), cattributes => prm_cattributes||fcl.fpdata(prm_idgif,'','',' id="'||prm_idgif||'" ')||ws_hideb||' border="0" '||fun.IFNOTNULL(prm_id,' id="'||prm_id||'"'||prm_cattributes)));
				end if;
			end if;
		end if;
	end if;

end DATALINK;


procedure FORMSELECTOPTION(
			ctext       in varchar2,
			cvalue	    in varchar2,
			cattributes in varchar2 DEFAULT NULL,
			cselected   in varchar2 DEFAULT NULL ) as
begin
	htp.print('<option value="'||cvalue||'" '||fun.IFNOTNULL(cselected,' SELECTED ')||fun.IFNOTNULL(cattributes,' '||cattributes)||'>'||ctext||' </option>');
end FORMSELECTOPTION;

function HTEXTO ( j_texto	   char	default null,
				j_size	   char	default null,
				j_cor		   char	default null,
				j_href	   char	default null,
				cattributes  char	default null )  return varchar2 as

begin
	return('<font '||fun.IFNOTNULL(j_size,' size="'||j_size||'"')||fun.IFNOTNULL(j_cor,' color="'||j_cor||'"')||fun.IFNOTNULL(cattributes,' '||cattributes)||'>'||fun.IFNOTNULL(j_href,' <a href="'||j_href||'" >')||j_texto||fun.IFNOTNULL(j_href,' </a>')||'</font>');
end HTEXTO;

procedure NEGADO ( j_objeto char default null ) as

begin

	htp.p( '<div align="CENTER">' || htf.bold( '<FONT size="5">&nbsp;'|| j_objeto ||'&nbsp;</font>') || '</font>' || '</div>');
end NEGADO;

procedure NOPEN( prm_nome	char	default null ) as
begin
	htp.p('<'||prm_nome||'>');

end NOPEN;

procedure NCLOSE( prm_nome	char	default null ) as
begin
	htp.p('</'||prm_nome||'>');

end NCLOSE;

/*
DUMP_SCREEN - Carrega area de execução branca
*/

procedure dump_screen as

begin
	htp.p('Clear...');
end dump_screen;


procedure OPENAPPLET( ccodbase     in varchar2,
			ccode	   in varchar2,
			cname	   in varchar2 default null,
			cattributes  in varchar2 default null ) as
begin
	htp.print('<APPLET CODEBASE ="'||rtrim(ccodbase)||'" CODE = "'||rtrim(ccode)||'" NAME = "'||rtrim(cname)||'" '||cattributes||' >');

end OPENAPPLET;


procedure CLOSEAPPLET as

begin
	htp.print(' </APPLET> ');

end CLOSEAPPLET;

/*
NULOPASS - NULLO
*/

procedure NULOPASS as

begin
	htp.print(' XX ');

end NULOPASS;

/*
TABLEDATAOPEN - Abre Dados de Tabela
*/

procedure TABLEDATAOPEN( calign	     in varchar2 DEFAULT NULL,
						ccolspan    in varchar2 DEFAULT NULL,
			cattributes in varchar2 DEFAULT NULL,
			crowspan    in varchar2 DEFAULT NULL ) as

begin
	htp.print('<td '||fun.IFNOTNULL(calign,' align="'||calign||'" ')||fun.IFNOTNULL(crowspan,' rowspan="'||crowspan||'" ')||fun.IFNOTNULL(ccolspan,' colspan="'||ccolspan||'" ')||fun.IFNOTNULL(cattributes,' '||cattributes)||' >');
end TABLEDATAOPEN;

/*
TABLEDATACLOSE - Fecha Dados de Tabela
*/

procedure TABLEDATACLOSE as

begin

	htp.print(' </td> ');

end TABLEDATACLOSE;

--!!
procedure LOAD_TABLES ( prm_order varchar2 default '1',
						prm_dir   varchar2 default '1' ) as

	cursor crs_visoes is
	select nm_micro_visao, nm_tabela, ds_micro_visao, cd_grupo_funcao, count(cd_ponto) as ponto, observacao
	from micro_visao t1
	left join ponto_avaliacao t2 on t2.cd_micro_visao = t1.nm_micro_visao
	group by nm_micro_visao, nm_tabela, ds_micro_visao, cd_grupo_funcao, observacao

	order by
		case when prm_dir = '1' then decode(prm_order, '1', nm_micro_visao, '2', nm_tabela, '3', ds_micro_visao, '4', cd_grupo_funcao, nm_micro_visao) end asc,
		case when prm_dir = '2' then decode(prm_order, '1', nm_micro_visao, '2', nm_tabela, '3', ds_micro_visao, '4', cd_grupo_funcao, nm_micro_visao) end desc;

	ws_visao    crs_visoes%rowtype;

	ws_tmp		long;
	ws_count	number;
	ws_primeiro	varchar2(60);
	ws_dir      number := 1;
	ws_padrao   varchar2(80) := 'PORTUGUESE';
	ws_admin    varchar2(20);

	ws_noaccess   exception;
begin

	ws_admin := nvl(gbl.getNivel, 'N');

	if ws_admin <> 'A' then
		raise ws_noaccess;
	end if;

	--htp.p($$plsql_unit) procedure que chamou

	begin
		select CONTEUDO into ws_padrao
		from   PARAMETRO_USUARIO
		where  cd_usuario = gbl.getUsuario and
			cd_padrao='CD_LINGUAGEM';
	exception
		when others then
			ws_padrao := 'PORTUGUESE';
	end;

	/*fcl.refresh_Session;*/
	htp.p('<table class="linha">');
		htp.p('<thead>');
			htp.p('<tr>');
				htp.p('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''LOAD_TABLES'', ''prm_order=1&prm_dir=''+dir, false, ''content'');">VIEW</th>');

				htp.p('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''LOAD_TABLES'', ''prm_order=2&prm_dir=''+dir, false, ''content'');">'||fun.lang('TABELA')||'</th>');
				htp.p('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''LOAD_TABLES'', ''prm_order=3&prm_dir=''+dir, false, ''content'');">'||fun.lang('DESCRI&Ccedil;&Atilde;O')||'</th>');

				htp.p('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''LOAD_TABLES'', ''prm_order=4&prm_dir=''+dir, false, ''content'');">'||fun.lang('CATEGORIA')||'</th>');
				htp.p('<th>'||fun.lang('OBSERVA&Ccedil;&Atilde;O')||'</th>');
				htp.p('<th></th>');
			htp.p('</tr>');
		htp.p('</thead>');


		if to_number(prm_dir) = 1 then
				ws_dir := 2;
			end if;

			htp.p('<tbody id="ajax" data-dir="'||ws_dir||'">');
			open crs_visoes;
				loop
					fetch crs_visoes into ws_visao;
					exit when crs_visoes%notfound;
						htp.p('<tr>');
							htp.p('<td class="longname"><a title="'||fun.lang('Alterar colunas')||'" class="link" onclick="viewDetalhes('''||ws_visao.nm_micro_visao||''');">'||fun.utranslate('NM_MICRO_VISAO', 'MICRO_VISAO', ws_visao.nm_micro_visao, ws_padrao)||'</a></td>');

							htp.p('<td class="fake-list">');
								htp.p('<a class="script" onclick="saveView(this, '''||ws_visao.nm_micro_visao||''', ''tabela'');"></a>');
								fcl.fakeoption(ws_visao.nm_micro_visao, '', ws_visao.nm_tabela, 'lista-tabelas', 'S', 'N', '');
							htp.p('</td>');
							
							htp.p('<td>');
								htp.p('<input maxlength="60" class="lang" data-default="'||ws_visao.nm_micro_visao||'" type="text" title="'||ws_visao.ds_micro_visao||'" id="'||ws_visao.nm_micro_visao||'_desc" onblur="blurView(this, '''||ws_visao.nm_micro_visao||''');" value="'||fun.utranslate('DS_MICRO_VISAO', 'MICRO_VISAO', ws_visao.ds_micro_visao, ws_padrao)||'" />');
								htp.p('<a class="fakelang" onclick="fakeLang('''||ws_visao.nm_micro_visao||'_desc'', ''MICRO_VISAO|DS_MICRO_VISAO|''+document.getElementById('''||ws_visao.nm_micro_visao||'_desc'').title);">L</a>');
							htp.p('</td>');
							
							htp.p('<td>');
								htp.p('<a class="script" onclick="saveView(this, '''||ws_visao.nm_micro_visao||''', ''grupo'');"></a>');
								fcl.fakeoption(ws_visao.nm_micro_visao||'_grupo', '', ws_visao.cd_grupo_funcao, 'lista-grupos', 'N', 'N', '');
							htp.p('</td>');

							htp.p('<td>');
								htp.p('<textarea onblur="saveView(this, '''||ws_visao.nm_micro_visao||''', ''observacao'');">'||ws_visao.observacao||'</textarea>');
							htp.p('</td>');

							if ws_visao.ponto = 0 then
								htp.p('<td>');
									fcl.button_lixo('dl_view','prm_view', ws_visao.nm_micro_visao, prm_tag => 'a');
								htp.p('</td>');
							else
								htp.p('<td><a class="noremove" title="'||fun.lang('Imposs&iacute;vel excluir!')||'">X</a></td>');
							end if;
						htp.p('</tr>');
				end loop;
			close crs_visoes;
		htp.p('</tbody>');
	htp.p('</table>');
exception 
	when ws_noaccess then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
END LOAD_TABLES;


--!!
procedure new_view ( prm_nome varchar2 default null,
					prm_tabela varchar2 default null,
					prm_desc varchar2 default null,
					prm_grupo varchar2 default null ) as

	ws_count     number;
	ws_desc      varchar2(200);
	ws_admin     varchar2(20);

	ws_error     exception;
	ws_duplicado exception;
	ws_noadmin   exception;
	ws_limite_nome exception;

begin

	ws_admin := nvl(gbl.getNivel, 'N');

	if ws_admin <> 'A' then
		raise ws_noadmin;
	end if;
	
	/*fcl.refresh_Session;*/
	ws_desc := fun.converte(prm_desc);

	if length(prm_nome) > 80 then 
		raise ws_limite_nome;
	end if;

	if length(prm_tabela) > 80 then 
		raise ws_limite_nome;
	end if;

	select count(*) into ws_count from micro_visao where nm_micro_visao = upper(trim(prm_nome));

	if ws_count = 0 then

		begin
		
			insert into micro_visao (NM_MICRO_VISAO, nm_TABELA, DS_MICRO_VISAO, CD_GRUPO_FUNCAO, DT_ULTIMA_ALTERACAO, CD_USUARIO) 
				values(upper(trim(prm_nome)), upper(trim(prm_tabela)), trim(ws_desc), prm_grupo, sysdate, 'DWU');
			
			ws_count := SQL%ROWCOUNT;
			
			if ws_count = 1 then
				commit;
			else
				rollback;
				raise ws_error;
			end if;
			
			fcl.padrao_colunas(upper(trim(prm_tabela)),upper(trim(prm_nome)));
			insert into traducao_colunas values('MICRO_VISAO', 'NM_MICRO_VISAO', fun.ret_var('LANG_SYS'), upper(trim(prm_nome)), upper(trim(prm_nome)), 'T', 'N');

			insert into traducao_colunas values('MICRO_VISAO', 'DS_MICRO_VISAO', fun.ret_var('LANG_SYS'), trim(ws_desc), trim(ws_desc), 'T', 'N');
			commit;
			
		exception when others then
			raise ws_error;
		end;
	else
		raise ws_duplicado;
	end if;
exception

	when ws_limite_nome then
		htp.p('FAIL'||fun.lang('Nome da vis&atilde;o ou tabela n&atilde;o pode ter mais que 80 caracteres')||'!');
	when ws_noadmin then
		htp.p('Sem permiss&atilde;o!');
	when ws_duplicado then
		htp.p('FAIL'||fun.lang('View j&aacute; existe')||'!');
	when ws_error then
		htp.p('FAIL'||fun.lang('Imposs&iacute;vel criar a view')||'!');
	when others then
		htp.p(sqlerrm);

end new_view;

--!!
procedure save_view ( prm_view  varchar2 default null,
					prm_valor varchar2 default null,
					prm_tipo  varchar2 default null ) as
	
	ws_converte varchar2(800);
	ws_admin    varchar2(20);

	ws_noadmin  exception;
begin
	
	ws_admin := nvl(gbl.getNivel, 'N');

	if ws_admin <> 'A' then
		raise ws_noadmin;
	end if;
	
	ws_converte := fun.converte(prm_valor);

	if prm_tipo = 'desc' then
		begin
			update micro_visao
			set ds_micro_visao = trim(ws_converte)
			where nm_micro_visao = upper(trim(prm_view));
		
		exception when others then
			htp.p('#alert '||fun.lang('Erro ao alterar a descri&ccedil;&atilde;o!')||'');
		end;
	elsif prm_tipo = 'grupo' then
		begin

			update micro_visao
			set cd_grupo_funcao = trim(ws_converte)
			where nm_micro_visao = upper(trim(prm_view));
		
		exception when others then
			htp.p('#alert '||fun.lang('Erro ao alterar a tabela!')||'');
		end;
	elsif prm_tipo = 'observacao' then
		begin

			update micro_visao
			set observacao = trim(ws_converte)
			where nm_micro_visao = upper(trim(prm_view));

		exception when others then
			htp.p('#alert '||fun.lang('Erro ao alterar a observa&ccedil;&atilde;o!')||'');
		end;
	else
		begin

			update micro_visao
			set nm_tabela = trim(ws_converte)
			where nm_micro_visao = upper(trim(prm_view));

		exception when others then
			htp.p('#alert '||fun.lang('Erro ao alterar a tabela!')||'');
		end;

	end if;

exception
	when ws_noadmin then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end save_view;

/*
List Box
*/

procedure listbox (	prm_campo	    varchar2 default null,
					prm_tmp_field	varchar2 default null,
					prm_script	    varchar2 default null,
					prm_default	    varchar2 default null,
					prm_list	    varchar2 default null,
					prm_atrib       varchar2 default null,
					prm_obj         varchar2 default null,
					prm_classe      varchar2 default null ) as   -- 19/01/2022 - Adicionando parametro prm_classe 

	ws_agrupador	       long;
	ws_texto	           long;
	ws_textot	           long;
	ws_nm_var	           long;
	ws_ct_var	           long;
	ws_prop                long;
	ws_count               number;
	ws_campo               long;
	ws_scrip_efeito        varchar2(2000);

begin

	/*fcl.refresh_Session;*/
	
	ws_texto        := prm_list;
	ws_scrip_efeito := fun.attrib_temporeal(prm_atrib, prm_obj);
	ws_agrupador    := substr(ws_texto, 1 ,instr(ws_texto,'|')-1);
	ws_texto        := substr(ws_texto, instr(ws_texto,'|')+1, length(ws_texto));
	ws_textot       := ws_texto;
	ws_prop         := '';
	ws_campo        := substr(prm_campo, 1, length(prm_campo)-3);

	if  ws_agrupador = '$opc' then
		
		if prm_classe is null then 
		htp.p('<select name="'||prm_campo||'codeop" onchange="document.getElementById('||chr(39)||prm_tmp_field||chr(39)||').value=this.options[this.selectedIndex].value;" '||ws_scrip_efeito||'>');
		else    
		htp.p('<select name="'||prm_campo||'codeop" onchange="this.value=this.options[this.selectedIndex].value;" '||ws_scrip_efeito||' '||prm_classe||'>');
		end if;    

		loop
			if  ws_textot = 'Y' or instr(ws_textot,'|') = 0 then
			exit;
			end if;
			ws_textot := ws_texto;
			ws_nm_var := substr(ws_textot, 1 ,instr(ws_textot,'|')-1);
			ws_textot := substr(ws_textot, instr(ws_textot,'|')+1, length(ws_textot));

			if  instr(ws_textot,'|') = 0 then
				ws_ct_var := ws_textot;
				ws_textot := 'Y';
			else
				ws_ct_var := substr(ws_textot, 1, instr(ws_textot,'|')-1);
			end if;

			if prm_default = ws_nm_var then
				if nvl(prm_classe,' ') like '%prop_col_n%' then 
				htp.p('<option selected="selected" hidden="true" value="'||ws_nm_var||'" '||fpdata(prm_default,ws_ct_var,'','')||'>'||fun.lang(ws_ct_var)||'</option>');
				else
				htp.p('<option selected="selected" value="'||ws_nm_var||'" '||fpdata(prm_default,ws_ct_var,'','')||'>'||fun.lang(ws_ct_var)||'</option>');  
				end if;    
			else
				htp.p('<option value="'||ws_nm_var||'" '||fpdata(prm_default,ws_ct_var,'','')||'>'||fun.lang(ws_ct_var)||'</option>');
			end if;

			ws_texto := substr(ws_textot, instr(ws_textot,'|')+1, length(ws_textot));

		end loop;
		htp.p('</select>');
	end if;

end listbox;


procedure load_tipos as

	ws_dir      number := 1;
	ws_admin    varchar2(20);
	ws_noaccess exception;

begin

	ws_admin := nvl(gbl.getNivel, 'N');

	if ws_admin <> 'A' then
		raise ws_noaccess;
	end if;

	htp.p('<div class="searchbar">');

		htp.p('<select id="viewobj" onchange="ajax(''list'', ''list_objetos'', ''prm_tipo=''+this.nextElementSibling.value+''&prm_screen=''+tela+''&prm_visao=''+this.value, true, ''ajax''); ">');
			htp.p(fun.list_view('T'));
		htp.p('</select>');

		htp.p('<select name="colgrp" id="lisobj" onchange="ajax(''list'', ''list_objetos'', ''prm_tipo=''+this.value+''&prm_screen=''+tela+''&prm_visao=''+this.previousElementSibling.value, true, ''ajax''); document.getElementById(''tipo-objeto'').value = this.value;">');
			htp.p('<option selected disabled hidden value="CONSULTA">'||fun.lang('BUSCA POR TIPO DE OBJETO')||'</option>');
			htp.p('<option value="">'||fun.lang('TODOS')||'</option>');
			for i in(select distinct tp_objeto, decode(tp_objeto, 'SCREEN', 'TELA', 'CALL_LIST', 'MENU', 'HEATMAP', 'MAPA DE CALOR', 'MAPAGEOLOC','GEOLOCALIZA&Ccedil;&Atilde;O', tp_objeto) as objeto FROM OBJETOS where tp_objeto not in ('UPGETPAR', 'CH_PASS', 'OBJETO') order by tp_objeto) loop
				htp.p('<option value="'||trim(i.tp_objeto)||'">'||fun.lang(i.objeto)||'</option>');
			end loop;
		htp.p('</select>');

	htp.p('</div>');
	
	htp.p('<input id="tipo-objeto" type="hidden" value="CONSULTA">');

	htp.p('<table class="linha">');
		htp.p('<thead>');
		htp.p('<tr>');
				htp.p('<th><a class="red" onclick="var objt = document.getElementById(''tipo-objeto'').value; var dir = order(''notsame'', ''ajax''); ajax(''list'', ''list_objetos'', ''prm_tipo=''+objt+''&prm_screen=''+tela+''&prm_order=1&prm_dir=''+dir+''&prm_visao=''+document.getElementById(''viewobj'').value, false, ''ajax''); console.log(objt+dir);">VIEW</th>');
				htp.p('<th><a class="red" onclick="var objt = document.getElementById(''tipo-objeto'').value; var dir = order(''notsame'', ''ajax''); ajax(''list'', ''list_objetos'', ''prm_tipo=''+objt+''&prm_screen=''+tela+''&prm_order=2&prm_dir=''+dir+''&prm_visao=''+document.getElementById(''viewobj'').value, false, ''ajax'');">'||fun.lang('NOME')||'</th>');
				htp.p('<th><a class="red" onclick="var objt = document.getElementById(''tipo-objeto'').value; var dir = order(''notsame'', ''ajax''); ajax(''list'', ''list_objetos'', ''prm_tipo=''+objt+''&prm_screen=''+tela+''&prm_order=3&prm_dir=''+dir+''&prm_visao=''+document.getElementById(''viewobj'').value, false, ''ajax'');">'||fun.lang('ID')||'</th>');
				htp.p('<th><a class="red" onclick="var objt = document.getElementById(''tipo-objeto'').value; var dir = order(''notsame'', ''ajax''); ajax(''list'', ''list_objetos'', ''prm_tipo=''+objt+''&prm_screen=''+tela+''&prm_order=4&prm_dir=''+dir+''&prm_visao=''+document.getElementById(''viewobj'').value, false, ''ajax'');">'||fun.lang('CATEGORIA')||'</th>');
				htp.p('<th></th>');
				htp.p('<th></th>');
				htp.p('<th></th>');
				htp.p('<th></th>');
				htp.p('<th></th>');
			htp.p('</tr>');
		htp.p('</thead>');
		htp.p('<tbody id="ajax" data-dir="'||ws_dir||'">');
		htp.p('</tbody>');
	htp.p('</table>');

exception
	when ws_noaccess then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end load_tipos;


procedure save_obj ( prm_nome varchar2 default null,
					prm_atributo varchar2 default null,
					prm_grupo varchar2 default null,
					prm_tipo varchar2 default null,
					prm_visao varchar2 default null ) as

	ws_count    number;
	ws_codigo   varchar2(200);
	ws_browser  varchar2(200);
	ws_visao    varchar2(200);
	ws_atributo varchar2(200);
	ws_nome     varchar2(200);
	ws_usuario  varchar2(80);

	ws_fail     exception;
	ws_nouser   exception;

begin
	/*fcl.refresh_Session;*/

	ws_usuario  := gbl.getUsuario;

	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if;


	ws_nome     := fun.converte(prm_nome);
	ws_atributo := fun.converte(prm_atributo);

	ws_visao := upper(trim(prm_visao));

	if prm_tipo = 'BROWSER' then
		Select 'SRC_'||trim((Select Sid From V$session Where Audsid = Sys_Context('userenv','sessionid'))||
		(Select Serial# From V$session Where Audsid = Sys_Context('userenv','sessionid'))||
		to_char(sysdate,'yymmddhhmiss')) into ws_codigo From Dual;

		Select 'BRO_'||to_char(sysdate,'yymmddhhmiss') into ws_browser From Dual;
		
		
		begin
			for b in(select usu_nome from usuarios where usu_nome not in (SELECT grantee
			FROM table_privileges
			WHERE owner = nvl(fun.ret_var('OWNER_TABLE_DATA'),'DWU') 
			AND table_name = 'BRO'
			) and trim(usu_nome) <> trim(ws_usuario) and status <> 'A' and trim(usu_nome) in (select trim(username) from all_users)  ) loop
				EXECUTE IMMEDIATE 'grant execute on '||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.BRO to "'||upper(trim(b.usu_nome))||'" ';
			end loop;
		end;

		insert into micro_data values (ws_browser, ws_visao, ws_nome, prm_grupo, sysdate, 'DWU');
		insert into objetos (cd_objeto, cd_grupo, nm_objeto, subtitulo, tp_objeto, cd_usuario, atributos, dt_ultima, ds_objeto) values (ws_browser, prm_grupo, trim(ws_nome), '', upper(prm_tipo), ws_usuario, '', sysdate, '');
		
		insert into objetos (cd_objeto, cd_grupo, nm_objeto, subtitulo, tp_objeto, cd_usuario, atributos, dt_ultima, ds_objeto) values (ws_codigo, prm_grupo, trim(ws_nome), '', 'SCREEN', ws_usuario, '', sysdate, '');
		insert into all_screens( owner, screen, descricao, dt_criacao, publico, timer, flex_flow, url_fundo,dispositivo, or_item ) values ( 'DWU', ws_codigo, ws_nome, sysdate, 'S', 0, 'column',  '','desktop', '00');
		insert into object_location (owner, navegador, screen, object_id, posx, posy, zindex, porcentagem) values ('DWU', 'DEFAULT', ws_codigo, ws_browser, '100px', '100px', '2', '0');
		insert into user_screens (usuario, screen, status) values ('DWU', ws_codigo, 'A');
		commit;
		
		begin

			insert into data_coluna (cd_micro_data, cd_coluna, nm_rotulo, nm_mascara, cd_ligacao, st_chave, st_branco, st_default, st_alinhamento, st_invisivel, formula, tipo, ds_alinhamento, tipo_input, tamanho, validacao, ordem, permissao)
							  select ws_browser	,trim(column_name), replace(replace(replace(trim(column_name), 'NM_', ''), 'CD_', ''), 'ST_', ''), '', 'SEM', decode(nullable, 'N', '1', '0'), '', '', 'left', 'N', '', '', 'left', decode(data_type, 'NUMBER', 'number', 'text'), data_length, '', '99', 'W' 
								from all_tab_columns 
							   where table_name = ws_visao;   

			commit;


		exception when others then
			raise ws_fail;
		end;
	elsif prm_tipo = 'CONSULTA' then 
		fcl.save_consulta(ws_visao, ws_nome, ws_nome, '', '', '', prm_grupo, '', ''); 
	else
		if prm_tipo = 'SCREEN' then
			Select 'SRC_'||trim((Select Sid From V$session Where Audsid = Sys_Context('userenv','sessionid'))||
			(Select Serial# From V$session Where Audsid = Sys_Context('userenv','sessionid'))||
			to_char(sysdate,'yymmddhhmiss')) into ws_codigo From Dual;
		else
			Select 'OBJ_'||trim((Select Sid From V$session Where Audsid = Sys_Context('userenv','sessionid'))||
			(Select Serial# From V$session Where Audsid = Sys_Context('userenv','sessionid'))||
			to_char(sysdate,'yymmddhhmiss')) into ws_codigo From Dual;
		end if;
			
		if prm_tipo = 'RELATORIO' then
			ws_atributo := replace(trim(ws_atributo), ''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download?arquivo=', '');
		else
			ws_atributo := trim(ws_atributo);
		end if;
		
		if (prm_tipo = 'ICONE' or prm_tipo = 'IMAGE') and nvl(ws_atributo, 'N/A') = 'N/A' then
			ws_atributo := ''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download?arquivo=ipad.png';
		end if;

		insert into objetos (cd_objeto, cd_grupo, nm_objeto, subtitulo, tp_objeto, cd_usuario, atributos, dt_ultima, ds_objeto) values (ws_codigo, prm_grupo, trim(ws_nome), '', upper(prm_tipo), ws_usuario, ws_atributo, sysdate, '');
		insert into OBJECT_ATTRIB select 'DWU','DEFAULT','DEFAULT', ws_codigo, cd_prop, vl_default from OBJECT_PADRAO where tp_objeto = prm_tipo;

		if prm_tipo = 'FILE' then
			insert into CALL_LIST
			(cd_list, cd_objeto, POSX, POSY )
			values
			(ws_visao, ws_codigo, '', '' );
		end if;

		if prm_tipo = 'SCREEN' then
			insert into all_screens
				( owner, screen, descricao, dt_criacao, publico, timer, flex_flow, url_fundo, or_item )
			values
				( 'DWU', ws_codigo, ws_nome, sysdate, 'S', 0, 'column',  ws_atributo, '00');

			insert into USER_SCREENS
				(USUARIO, SCREEN, STATUS)
			values
			('DWU', ws_codigo, 'A');
		end if;

		commit;

	end if;

		
exception 
	when ws_nouser then
		htp.p('Sem permiss&atilde;o!');
	when ws_fail then
		rollback;
		htp.p('ERROCOLUNA');
		insert into bi_log_sistema values(sysdate, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - SAVE_OBJ', ws_usuario, 'ERRO');
		commit;
	when others then
		rollback;
		htp.p('FAIL');
		insert into bi_log_sistema values(sysdate, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - SAVE_OBJ', ws_usuario, 'ERRO');
		commit;
end save_obj;


/*
LOAD_MVIEW - Carrega ListBox MView
*/

procedure LOAD_MVIEW ( PRM_CD_GRUPO char default null,
			PRM_MVISAO   char default null ) as

	cursor crs_visao is
			select	rtrim(nm_micro_visao) as nm_micro_visao
			from 	MICRO_VISAO
			where	cd_grupo_funcao = prm_cd_grupo
			order by nm_micro_visao;

	ws_visao	crs_visao%rowtype;
	ws_tmp		long;
	ws_count	number;
	ws_primeiro	varchar2(60);

begin
	/*fcl.refresh_Session;*/
	ws_count := 0;

	ws_tmp := '<script>';
	ws_tmp := ws_tmp||'var incrx=parent.document.getElementById(''lmview''); ';
	ws_tmp := ws_tmp||'incrx.innerHTML = '||chr(39);
	ws_tmp := ws_tmp||'<select NAME="colgrp" id="grpnm" style="font-size: 10px;" onchange=" carrega(''LOAD_COLUMNS?prm_micro_visao=''+this.options[this.selectedIndex].value);">';

	ws_primeiro := '%First%';
	open crs_visao;
	loop
		fetch crs_visao into ws_visao;
			exit when crs_visao%notfound;
		if  PRM_MVISAO = ws_visao.nm_micro_visao then
			ws_tmp := ws_tmp||'<option selected value="'||ws_visao.nm_micro_visao||'">'||ws_visao.nm_micro_visao||'</option>';
			ws_primeiro := ws_visao.nm_micro_visao;
		else
			ws_tmp := ws_tmp||'<option value="'||ws_visao.nm_micro_visao||'">'||ws_visao.nm_micro_visao||'</option>';
		end if;
		if  ws_primeiro = '%First%' then
			ws_primeiro := ws_visao.nm_micro_visao;
		end if;
		ws_count := ws_count + 1;
	end loop;
	close crs_visao;

	if  ws_count > 0 then
		ws_tmp := ws_tmp||'</option>'||chr(39)||'</script>';
		ws_tmp := ws_tmp||'<script> parent.phdobj('||chr(39)||'rptype'||chr(39)||','||chr(39)||chr(39)||'); </script>';
		ws_tmp := ws_tmp||'<script> parent.phdobj('||chr(39)||'ins_direct_gid'||chr(39)||','||chr(39)||chr(39)||'); </script>';
		ws_tmp := ws_tmp||'<script> parent.phdobj('||chr(39)||'ins_coluna_gid'||chr(39)||','||chr(39)||chr(39)||'); </script>';
		ws_tmp := ws_tmp||'<script> parent.phdobj('||chr(39)||'ins_linha_gid'||chr(39)||','||chr(39)||chr(39)||'); </script>';
		ws_tmp := ws_tmp||'<script> parent.phdobj('||chr(39)||'ins_agrupadores_gid'||chr(39)||','||chr(39)||chr(39)||'); </script>';
		ws_tmp := ws_tmp||'<script> parent.phdobj('||chr(39)||'ins_calc_gid'||chr(39)||','||chr(39)||chr(39)||'); </script>';
		ws_tmp := ws_tmp||'<script> parent.phdobj('||chr(39)||'ls_mfiltro'||chr(39)||','||chr(39)||chr(39)||'); </script>';
		htp.p(ws_tmp);
		fcl.load_columns(ws_primeiro);
	else
		ws_tmp := '<script>';
		ws_tmp := ws_tmp||'var incrx=parent.document.getElementById(''lmview''); ';
		ws_tmp := ws_tmp||'incrx.innerHTML = '||chr(39)||chr(39)||'; ';
		ws_tmp := ws_tmp||'var incry=parent.document.getElementById(''lagrupadores''); ';
		ws_tmp := ws_tmp||'incry.innerHTML = '||chr(39)||chr(39)||'; ';
		ws_tmp := ws_tmp||'var incrz=parent.document.getElementById(''lvalores''); ';
		ws_tmp := ws_tmp||'incrz.innerHTML = '||chr(39)||chr(39)||'; </script>';
		ws_tmp := ws_tmp||'<script> parent.phdobj('||chr(39)||'rptype'||chr(39)||','||chr(39)||'none'||chr(39)||'); </script>';
		ws_tmp := ws_tmp||'<script> parent.phdobj('||chr(39)||'ins_direct_gid'||chr(39)||','||chr(39)||'none'||chr(39)||'); </script>';
		ws_tmp := ws_tmp||'<script> parent.phdobj('||chr(39)||'ins_coluna_gid'||chr(39)||','||chr(39)||'none'||chr(39)||'); </script>';
		ws_tmp := ws_tmp||'<script> parent.phdobj('||chr(39)||'ins_linha_gid'||chr(39)||','||chr(39)||'none'||chr(39)||'); </script>';
		ws_tmp := ws_tmp||'<script> parent.phdobj('||chr(39)||'ins_agrupadores_gid'||chr(39)||','||chr(39)||'none'||chr(39)||'); </script>';
		ws_tmp := ws_tmp||'<script> parent.phdobj('||chr(39)||'ins_calc_gid'||chr(39)||','||chr(39)||'none'||chr(39)||'); </script>';
		ws_tmp := ws_tmp||'<script> parent.phdobj('||chr(39)||'ls_mfiltro'||chr(39)||','||chr(39)||'none'||chr(39)||'); </script>';
		htp.p(ws_tmp);
	end if;

END LOAD_MVIEW; 


/* >>>>>>> LOAD_MVIEW - Carrega ListBox Tabelas*/

--!!
procedure load_crocks ( prm_visao    varchar2 default null,
						prm_valores  varchar2 default null,
						prm_busca    varchar2 default null,
						prm_completo varchar2 default 'S',
						prm_ordem    varchar2 default '1',
						prm_dir      varchar2 default '1' ) as

	cursor crs_cols is
		select cd_coluna, nm_rotulo, origem 
		from ( select cd_coluna, max(nm_rotulo) as nm_rotulo, max(origem) as origem 
				from ( select column_name as cd_coluna, '' as nm_rotulo, 'T' as origem
						from all_tab_columns 
						where owner      = nvl(upper(fun.ret_var('OWNER_TABLE_DATA')),'DWU')
						and table_name = (select nm_tabela from micro_visao where nm_micro_visao = prm_visao) 
						and upper(column_name) like '%'||upper(nvl(prm_busca, column_name))||'%'
						
						union all
						
						select cd_coluna, nm_rotulo, 'S' as origem
						from micro_coluna
						where cd_micro_visao = prm_visao 
						and cd_coluna is not null and ( upper(cd_coluna) like '%'||upper(nvl(prm_busca, cd_coluna))||'%' or
														upper(nm_rotulo) like '%'||upper(nvl(prm_busca, nm_rotulo))||'%'
														)
					) group by cd_coluna 

			) order by case when prm_dir = '1' then decode(prm_ordem, '1', cd_coluna, '2', nm_rotulo, cd_coluna) end asc,
						case when prm_dir = '2' then decode(prm_ordem, '1', cd_coluna, '2', nm_rotulo, cd_coluna) end desc;


	ws_cols crs_cols%rowtype;
	ws_red    	number;
	ws_orange 	number;
	ws_class  	varchar2(20) := '';
	ws_padrao 	varchar2(40) := 'PORTUGUESE';
	ws_temp	  	varchar(2000);
	ws_colunasTemplate	varchar2(2000):= '';
	ws_count	number;
	ws_noadmin 	exception;

begin

	/*begin
		select CONTEUDO into ws_padrao
		from   PARAMETRO_USUARIO
		where  cd_usuario = gbl.getUsuario and
			cd_padrao='CD_LINGUAGEM';
	exception
		when others then
			ws_padrao := 'PORTUGUESE';
	end;*/

	if nvl(gbl.getNivel, 'N') <> 'A' then

		raise ws_noadmin;

	end if;

	ws_padrao := gbl.getLang;

	--htp.p(ws_padrao);

	if prm_completo = 'S' then

	--htp.p('<div id="ajax" style="min-width: 195px; float: left; margin-top: 2px; width: 210px; overflow-x: hidden; height: calc(100% - 2px);">');
		
		if length(prm_visao) > 0 then

			htp.p('<input placeholder="'||fun.lang('BUSCA POR NOME OU R&Oacute;TULO')||'" type="text" class="searchcolumn" oninput="var busca = document.getElementById(''painel-colunas'').children[0].value; var dir = document.getElementById(''painel-colunas'').getAttribute(''data-dir''); call(''load_crocks'', ''prm_visao='||prm_visao||'&prm_valores='||prm_valores||'&prm_busca=''+busca+''&prm_completo=N&prm_ordem=1&prm_dir=''+dir).then(function(resposta){ document.getElementById(''ajax-lista'').innerHTML = resposta; }); document.getElementById(''content'').innerHTML = '''';" value="'||prm_busca||'"  />');
			htp.p('<a class="busca-colunas" onclick="call(''load_crocks'', ''prm_visao='||prm_visao||'&prm_valores='||prm_valores||'&prm_busca=''+this.previousElementSibling.value+''&prm_completo=N'').then(function(resposta){ document.getElementById(''ajax-lista'').innerHTML = resposta; });">');
				htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" 	 width="485.213px" height="485.213px" viewBox="0 0 485.213 485.213" style="enable-background:new 0 0 485.213 485.213;" 	 xml:space="preserve"> <g> 	<g> 		<path d="M363.909,181.955C363.909,81.473,282.44,0,181.956,0C81.474,0,0.001,81.473,0.001,181.955s81.473,181.951,181.955,181.951 			C282.44,363.906,363.909,282.437,363.909,181.955z M181.956,318.416c-75.252,0-136.465-61.208-136.465-136.46 			c0-75.252,61.213-136.465,136.465-136.465c75.25,0,136.468,61.213,136.468,136.465 			C318.424,257.208,257.206,318.416,181.956,318.416z"/> 		<path d="M471.882,407.567L360.567,296.243c-16.586,25.795-38.536,47.734-64.331,64.321l111.324,111.324 			c17.772,17.768,46.587,17.768,64.321,0C489.654,454.149,489.654,425.334,471.882,407.567z"/> 	</g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
			htp.p('</a>');

		end if;
		
	end if;

		htp.p('<div id="container-colunas">');
		
			htp.p('<ul id="ajax-lista" data-dir="'||prm_dir||'">');

				htp.p('<li class="arrowline firstline">');
					htp.p('<span><a class="red" onclick="var busca = document.getElementById(''painel-colunas'').children[0].value; var dir = order(''notsame'', ''ajax-lista''); call(''load_crocks'', ''prm_visao=''+document.getElementById(''micro-visao'').title+''&prm_valores=''+document.getElementById(''painel-colunas'').getAttribute(''data-colunas'')+''&prm_busca=''+busca+''&prm_ordem=1&prm_dir=''+dir+''&prm_completo=N'').then(function(resposta){ document.getElementById(''ajax-lista'').innerHTML = resposta; }); document.getElementById(''content'').innerHTML = '''';">'||fun.lang('NOME')||'</a></span>');
					htp.p('<span class="rotulo"><a class="red" onclick="var busca = document.getElementById(''painel-colunas'').children[0].value; var dir = order(''notsame'', ''ajax-lista''); call(''load_crocks'', ''prm_visao=''+document.getElementById(''micro-visao'').title+''&prm_valores=''+document.getElementById(''painel-colunas'').getAttribute(''data-colunas'')+''&prm_busca=''+document.getElementById(''painel-colunas'').children[0].value+''&prm_ordem=2&prm_dir=''+dir+''&prm_completo=N'').then(function(resposta){ document.getElementById(''ajax-lista'').innerHTML = resposta; }); document.getElementById(''content'').innerHTML = '''';">'||fun.lang('R&Oacute;TULO')||'</a></span>');
					htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="292.362px" height="292.362px" viewBox="0 0 292.362 292.362" style="enable-background:new 0 0 292.362 292.362;" xml:space="preserve"> <g> <path d="M286.935,69.377c-3.614-3.617-7.898-5.424-12.848-5.424H18.274c-4.952,0-9.233,1.807-12.85,5.424 		C1.807,72.998,0,77.279,0,82.228c0,4.948,1.807,9.229,5.424,12.847l127.907,127.907c3.621,3.617,7.902,5.428,12.85,5.428 		s9.233-1.811,12.847-5.428L286.935,95.074c3.613-3.617,5.427-7.898,5.427-12.847C292.362,77.279,290.548,72.998,286.935,69.377z"/> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>'); 
				htp.p('</li>');
				
				ws_temp:='';

				BEGIN

					select formula into ws_colunasTemplate from micro_coluna where cd_micro_visao = prm_visao and cd_coluna in 
					(select column_value from table(fun.vpipe(prm_valores)) where column_value in 
					(select cd_coluna from micro_coluna where cd_micro_visao = prm_visao and st_agrupador = 'TPT')
					);
					


						for o in (select column_value from table(fun.vpipe(ws_colunasTemplate)))
						loop
							
						
						ws_temp := ws_temp||'|'||o.column_value;

						end loop;


					ws_temp:=ws_temp||'|';

				EXCEPTION

					when OTHERS then

						ws_temp:='';

				END;
				
				open crs_cols;

					loop
						fetch crs_cols into ws_cols;
						exit when crs_cols%notfound;

						ws_orange:=0;
						ws_red := 0;

						for i in (select column_value from table(fun.vpipe(prm_valores))) loop
							if ws_cols.cd_coluna like i.column_value then

								ws_red := ws_red+1;

							end if;			

						end loop;
						if (instr(ws_temp,'|'||ws_cols.cd_coluna||'|')>0)  then

							ws_orange:=ws_orange+1;
							
						end if;


						if ws_red > 0 then
							ws_class := 'used';
						end if;
						if ws_orange >0 then
							ws_class:='used_temp';
						end if;


						htp.p('<li title="'||ws_cols.cd_coluna||'" onclick="arrow(this, '''||ws_cols.cd_coluna||''', ''click'');" class="arrowline '||ws_class||'" id="'||ws_cols.cd_coluna||'id" data-origem="'||ws_cols.origem||'">');
							htp.p('<span>'||ws_cols.cd_coluna||'</span>');

							htp.p('<span class="rotulo">'||fun.utranslate('NM_ROTULO', prm_visao, ws_cols.nm_rotulo, ws_padrao)||'</span>');

							--if ws_red > 0 then
								--htp.p('<a class="arrow red" onclick="arrow(this, '''||ws_cols.cd_coluna||''', ''click'');">></a>');
								--htp.p('<svg version="1.1" class="used" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="292.362px" height="292.362px" viewBox="0 0 292.362 292.362" style="enable-background:new 0 0 292.362 292.362;" xml:space="preserve"> <g> <path d="M286.935,69.377c-3.614-3.617-7.898-5.424-12.848-5.424H18.274c-4.952,0-9.233,1.807-12.85,5.424 		C1.807,72.998,0,77.279,0,82.228c0,4.948,1.807,9.229,5.424,12.847l127.907,127.907c3.621,3.617,7.902,5.428,12.85,5.428 		s9.233-1.811,12.847-5.428L286.935,95.074c3.613-3.617,5.427-7.898,5.427-12.847C292.362,77.279,290.548,72.998,286.935,69.377z"/> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>'); 

							--else
								--htp.p('<a class="arrow" onclick="arrow(this, '''||ws_cols.cd_coluna||''', ''click'');">></a>');
								htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="292.362px" height="292.362px" viewBox="0 0 292.362 292.362" style="enable-background:new 0 0 292.362 292.362;" xml:space="preserve"> <g> <path d="M286.935,69.377c-3.614-3.617-7.898-5.424-12.848-5.424H18.274c-4.952,0-9.233,1.807-12.85,5.424 		C1.807,72.998,0,77.279,0,82.228c0,4.948,1.807,9.229,5.424,12.847l127.907,127.907c3.621,3.617,7.902,5.428,12.85,5.428 		s9.233-1.811,12.847-5.428L286.935,95.074c3.613-3.617,5.427-7.898,5.427-12.847C292.362,77.279,290.548,72.998,286.935,69.377z"/> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>'); 

							--end if;

						htp.p('</li>');

						ws_class := '';
					end loop;

				close crs_cols;
				
			htp.p('</ul>');

		htp.p('</div>');
	/*if prm_completo = 'S' then	
		
		htp.p('</div>');
		
	end if;*/
exception
	when ws_noadmin then
		htp.p(fun.lang('Sem permiss&atilde;o!'));
	when others then
		htp.p(sqlerrm);
end load_crocks;

--!!
procedure exclude_column ( prm_coluna varchar2 default null,
						prm_visao varchar2 default null ) as

		ws_count   number;
		ws_used    exception;
		ws_noadmin exception;
	begin

		if gbl.getNivel <> 'A' then
			raise ws_noadmin;
		end if;
		
		select count(*) into ws_count from ponto_avaliacao where cd_micro_visao = prm_visao and (cs_colup = prm_coluna or cs_agrupador = prm_coluna or cs_coluna = prm_coluna);
		if ws_count = 0 then
			delete from micro_coluna where cd_coluna = prm_coluna and cd_micro_visao = prm_visao;
			commit;
			htp.p('OK');
		else
			raise ws_used;
		end if;

	exception
		when ws_noadmin then
			htp.p('Sem permiss&atilde;o!');
		when ws_used then
			htp.p('#alert '||fun.lang('impossivel completar solicita&ccedil;&atilde;o, coluna usada no sistema')||'!');
		when others then
			htp.p('#alert '||fun.lang('impossivel completar solicita&ccedil;&atilde;o')||'!');
end exclude_column;

--!!
procedure load_column ( prm_visao   varchar2 default null,
						prm_name    varchar2 default null,
						prm_screen  varchar2 default null ) as

	/*cursor crs_mascaras is
	select CD_MASCARA, DS_MASCARA from MASCARAS
	order by ds_mascara desc;
	ws_mascara crs_mascaras%rowtype;*/

	

	cursor crs_valores is
	select st_gera_rel, st_agrupador, nm_mascara, cd_ligacao, st_com_codigo, st_alinhamento, st_resumido, st_negrito, 
		st_invisivel, nm_unidade, hint, rotulo_c, formula, color, decode(nvl(nm_rotulo, 'N/A'), 'N/A', '', ' - '||nm_rotulo) as rotulo, 
		nm_rotulo, flexcol, limite, quebra_texto, url, anotacao, st_alinhamento_cab
	from micro_coluna where cd_coluna = prm_name and cd_micro_visao = prm_visao;
	ws_valor crs_valores%rowtype;

	ws_agrupador     varchar2(2000);
	ws_length        number;
	ws_count         number;
	ws_padrao        varchar2(80) := 'PORTUGUESE';
	ws_retorno       varchar2(500); 
	ws_style_formula varchar2(200); 

	ws_noadmin   exception;

begin

		if gbl.getNivel <> 'A' then
			raise ws_noadmin;
		end if;

		/*fcl.refresh_Session;*/
		open crs_valores;
			loop
				fetch crs_valores into ws_valor;
				exit when crs_valores%notfound;
			end loop;
		close crs_valores;

		select count(*) into ws_count from micro_coluna where cd_coluna = prm_name and cd_micro_visao = prm_visao;

		if ws_count = 0 then
			insert into micro_coluna ( cd_micro_visao, cd_coluna, nm_rotulo, st_gera_rel, st_agrupador, nm_mascara, cd_ligacao, st_com_codigo, st_alinhamento, st_resumido, st_negrito, st_invisivel, nm_unidade, formula, tipo, rotulo_c, color, hint, flexcol, url, anotacao) values (prm_visao, prm_name, '', 'S', 'SEM', 'SEM', 'SEM', 'N', 'LEFT', 'N', 'S', 'N', '', '', 'T', '', '', '', '', '', '');
			commit;
		end if;

		--htp.p('<a class="remove column" title="'||fun.lang('Remover coluna')||'">X</a>');

		fcl.button_lixo('dl_column', 'prm_view|prm_coluna', prm_visao||'|'||prm_name, prm_tag => 'a');

		if ws_valor.st_agrupador = 'TPT' then

			select length(formula) into ws_length from micro_coluna where cd_micro_visao = prm_visao and cd_coluna = prm_name;

			if ws_length > 0 then
			
				select formula into ws_agrupador 
				from micro_coluna 
				where cd_micro_visao = prm_visao 
				and cd_coluna = prm_name;
			end if;

			htp.p('<a style="display: block; width: 100%; text-align: center; margin: 20px 0 4px 0;" class="link" onclick="var valores = this.nextElementSibling.getElementsByClassName(''linha''); var valor = ''''; for(i=0;i<valores.length;i++){ valor = valores[i].title+''|''+valor; } fakeOption(valor, ''group-template'', ''coluna-add'', '''||prm_visao||''', '''||prm_name||''');">ADICIONAR COLUNA</a>');
			
			htp.p('<ul id="colunac" style="float: none; width: 170px; margin: 0 auto;" data-default="'||ws_agrupador||'" onmouseleave="saveTpt(document.querySelector(''.medida''), '''||prm_visao||''', '''||prm_name||''');" data-tipo="pivot" class="medida" data-type="lista">');

				if ws_length > 0 then
					FOR I IN(SELECT COLUMN_VALUE AS COLUNA , T2.NM_ROTULO AS ROTULO  FROM TABLE(FUN.VPIPE((ws_agrupador))) T1,MICRO_COLUNA T2 
								WHERE T2.CD_MICRO_VISAO = PRM_VISAO 
								AND T2.CD_COLUNA = COLUMN_VALUE) 
					LOOP
							
						HTP.P('<li onclick="swapColumn(this);" title="'||I.COLUNA||'" class="linha">'||I.COLUNA||' - '||I.ROTULO||'<span onclick="this.parentNode.remove(); saveTpt(document.querySelector(''.medida''), '''||PRM_VISAO||''', '''||PRM_NAME||''');">X</span></li>');
						HTP.P('<li onclick="swapSquare(this);" class="square"></li>');
					END LOOP;
				end if;
			htp.p('</ul>');
		else
			
			begin
				select CONTEUDO into ws_padrao
				from   PARAMETRO_USUARIO
				where  cd_usuario = gbl.getUsuario and
					cd_padrao='CD_LINGUAGEM';
			exception
				when others then
					ws_padrao := 'PORTUGUESE';
			end;
			
			htp.p('<ul class="colunas_att">');

				htp.p('<li class="columnline">');
					htp.p('<span class="label">'||fun.lang('R&oacute;tulo')||'</span>');
					htp.p('<textarea onkeypress="if(!input(event, ''rotulo'')){ event.preventDefault(); }" class="" style="resize: none; height: 32px;" maxlength="40" data-default="'||fun.utranslate('NM_ROTULO', prm_visao, ws_valor.nm_rotulo, ws_padrao)||'" id="'||prm_name||'_rotulo" title="'||ws_valor.nm_rotulo||'" onblur="arrow(this, '''||prm_name||''', ''NM_ROTULO'');">'||fun.utranslate('NM_ROTULO', prm_visao, ws_valor.nm_rotulo, ws_padrao)||'</textarea>');
					htp.p('<a class="fakelang mini" onclick="fakeLang('''||prm_name||'_rotulo'', '''||prm_visao||'|NM_ROTULO|''+this.previousElementSibling.title, ''cd'');">L</a></span>');
				htp.p('</li>');

				htp.p('<li class="columnline row">');
					htp.p('<span class="label">'||fun.lang('Negrito')||'</span>');
					htp.p('<a class="script" onclick="ajax(''fly'', ''save_column'', ''prm_visao='||prm_visao||'&prm_name='||prm_name||'&prm_campo=ST_NEGRITO&prm_valor=''+this.nextElementSibling.title);"></a>');

					if ws_valor.st_negrito <> 'S' then
						htp.p('<span class="checkbox m2" data-positive="S" data-negative="N" title="'||ws_valor.st_negrito||'"></span>');
					else
						htp.p('<span class="checkbox m2 checked" data-positive="S" data-negative="N" title="'||ws_valor.st_negrito||'"></span>');
					end if;

					htp.p('<span class="label" style="margin: 0 16px;">'||fun.lang('Cor da coluna')||'</span>');
					htp.p('<input style="width: 60px; margin: 0 6px 0 0;" type="text" name="p_color" value="'||ws_valor.color||'" size="19" onblur=" var valor = encodeURIComponent(this.value); ajax(''fly'', ''save_column'', ''prm_visao='||prm_visao||'&prm_name='||prm_name||'&prm_campo=COLOR&prm_valor=''+valor); noerror('''', '''||fun.lang('Cor alterada com sucesso!')||''', ''msg'');" />');
					htp.p('<input style="width: 14px;" onchange="this.previousElementSibling.value = this.value; var valor = encodeURIComponent(this.value); ajax(''fly'', ''save_column'', ''prm_visao='||prm_visao||'&prm_name='||prm_name||'&prm_campo=COLOR&prm_valor=''+valor); noerror('''', '''||fun.lang('Cor alterada com sucesso!')||''', ''msg'');" type="color" value="'||ws_valor.color||'" />');

				htp.p('</li>');

				htp.p('<li class="columnline">');

					htp.p('<span class="label">'||fun.lang('Alinhamento Coluna')||'</span>');						
						htp.formSelectOpen( cname => 'p_st_alinhamento', cattributes => 'onchange=" ajax(''fly'', ''save_column'', ''prm_visao='||prm_visao||'&prm_name='||prm_name||'&prm_campo=ST_ALINHAMENTO&prm_valor=''+this.value); "');
						
							if ws_valor.st_alinhamento = 'CENTER' then
								htp.p('<option value="CENTER" selected>Centro</option>');
							else
								htp.p('<option value="CENTER">Centro</option>');
							end if;
						
							if nvl(ws_valor.st_alinhamento,'LEFT') = 'LEFT' then
								htp.p('<option value="LEFT" selected>Esquerda</option>');
							else
								htp.p('<option value="LEFT">Esquerda</option>');
							end if;
						
							if ws_valor.st_alinhamento = 'RIGHT' then
								htp.p('<option value="RIGHT" selected>Direita</option>');
							else
								htp.p('<option value="RIGHT">Direita</option>');
							end if;
						
						htp.formSelectClose;
						
				htp.p('</li>');

				htp.p('<li class="columnline">');

					htp.p('<span class="label">'||fun.lang('Alinhamento Cabe&ccedil;alho')||'</span>');						
						htp.formSelectOpen( cname => 'st_alinhamento_cab', cattributes => 'onchange=" ajax(''fly'', ''save_column'', ''prm_visao='||prm_visao||'&prm_name='||prm_name||'&prm_campo=ST_ALINHAMENTO_CAB&prm_valor=''+this.value); "');

							if nvl(ws_valor.st_alinhamento_cab,'DEFAULT') = 'DEFAULT' then
								htp.p('<option value="DEFAULT" selected>Mesmo alinhamento coluna</option>');
							else
								htp.p('<option value="DEFAULT">Mesmo alinhameto coluna</option>');
							end if;

							if ws_valor.st_alinhamento_cab = 'CENTER' then
								htp.p('<option value="CENTER" selected>Centro</option>');
							else
								htp.p('<option value="CENTER">Centro</option>');
							end if;

							if ws_valor.st_alinhamento_cab = 'LEFT' then
								htp.p('<option value="LEFT" selected>Esquerda</option>');
							else
								htp.p('<option value="LEFT">Esquerda</option>');
							end if;

							if ws_valor.st_alinhamento_cab = 'RIGHT' then
								htp.p('<option value="RIGHT" selected>Direita</option>');
							else
								htp.p('<option value="RIGHT">Direita</option>');
							end if;

						htp.formSelectClose;

				htp.p('</li>');

				htp.p('<li class="columnline" data-campo="HINT">');
					htp.p('<span class="label">Hint</span>');
					htp.p('<input type="text" maxlength="200" class="listener" value="'||ws_valor.hint||'" />');
				htp.p('</li>');

				htp.p('<li class="columnline" data-campo="ROTULO_C">');
					htp.p('<span class="label">'||fun.lang('R&oacute;tulo customizado')||'</span>');
					htp.p('<textarea onkeypress="/*if(!input(event, ''rotulo'')){ event.preventDefault(); }*/" class="listener" style="resize: none; height: 64px;" maxlength="4000" data-default="'||ws_valor.rotulo_c||'" >'||ws_valor.rotulo_c||'</textarea>');
				htp.p('</li>');

				htp.p('<li class="columnline" data-campo="URL">');
					htp.p('<span class="label">'||fun.lang('Imagem')||'</span>');
					htp.p('<input type="text" class="listener" maxlength="200" data-default="'||trim(ws_valor.url)||'" id="url-coluna" value="'||trim(ws_valor.url)||'" />');
				htp.p('</li>');


			htp.p('</ul>');
			htp.p('<ul class="colunas_att">');

				htp.p('<li class="columnline">');
					htp.p('<span class="label">'||fun.lang('M&aacute;scara')||'</span>');
					htp.p('<a class="script" onclick="call(''save_column'', ''prm_visao='||prm_visao||'&prm_name='||prm_name||'&prm_campo=NM_MASCARA&prm_valor=''+document.getElementById(''lista-mascara'').title).then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } });"></a>');
					fcl.fakeoption('lista-mascara', ''||ws_valor.nm_mascara||'', ''||ws_valor.nm_mascara||'', 'lista-mascara', 'N', 'N', '');
				htp.p('</li>');
				
				htp.p('<li class="columnline row">');
					htp.p('<span class="label">'||fun.lang('Gerar total')||'</span>');
					htp.p('<a class="script" onclick="ajax(''fly'', ''save_column'', ''prm_visao='||prm_visao||'&prm_name='||prm_name||'&prm_campo=ST_GERA_REL&prm_valor=''+this.nextElementSibling.title);"></a>');
					if ws_valor.st_gera_rel <> 'S' then
						htp.p('<span class="checkbox m2" data-positive="S" data-negative="N" title="'||ws_valor.st_gera_rel||'"></span>');
					else
						htp.p('<span class="checkbox m2 checked" data-positive="S" data-negative="N" title="'||ws_valor.st_gera_rel||'"></span>');
					end if;

					htp.p('<span class="label">'||fun.lang('Incluir c&oacute;digo')||'</span>');
					htp.p('<a class="script" onclick="ajax(''fly'', ''save_column'', ''prm_visao='||prm_visao||'&prm_name='||prm_name||'&prm_campo=ST_COM_CODIGO&prm_valor=''+this.nextElementSibling.title);"></a>');
					if ws_valor.st_com_codigo <> 'S' then
						htp.p('<span class="checkbox m2" data-positive="S" data-negative="N" title="'||ws_valor.st_com_codigo||'"></span>');
					else
						htp.p('<span class="checkbox m2 checked" data-positive="S" data-negative="N" title="'||ws_valor.st_com_codigo||'"></span>');
					end if;
				htp.p('</li>');
				
				htp.p('<li class="columnline">');
					htp.p('<span class="label">'||fun.lang('Agrupador')||'</span>');
					htp.p('<select onchange=" ajax(''fly'', ''save_column'', ''prm_visao='||prm_visao||'&prm_name='||prm_name||'&prm_campo=ST_AGRUPADOR&prm_valor=''+this.value); ">');
						if ws_valor.st_agrupador = 'SEM' then
							htp.p('<option value="SEM" selected="selected">'||fun.lang('Sem')||'</option>');
						else
							htp.p('<option value="SEM">'||fun.lang('Sem')||'</option>');
						end if;
						if ws_valor.st_agrupador = 'SUM' then
							htp.p('<option value="SUM" selected="selected">Sum</option>');
						else
							htp.p('<option value="SUM">Sum</option>');
						end if;
						if ws_valor.st_agrupador = 'AVG' then
							htp.p('<option value="AVG" selected="selected">Avg</option>');
						else
							htp.p('<option value="AVG">Avg</option>');
						end if;
						if ws_valor.st_agrupador = 'MAX' then
							htp.p('<option value="MAX" selected="selected">Max</option>');
						else
							htp.p('<option value="MAX">Max</option>');
						end if;
						if ws_valor.st_agrupador = 'MIN' then
							htp.p('<option value="MIN" selected="selected">Min</option>');
						else
							htp.p('<option value="MIN" >Min</option>');
						end if;
						if ws_valor.st_agrupador = 'EXT' then
							htp.p('<option value="EXT" selected="selected">Ext</option>');
						else
							htp.p('<option value="EXT">Ext</option>');
						end if;
						if ws_valor.st_agrupador = 'PSM' then
							htp.p('<option value="PSM" selected="selected" title="trunc((ratio_to_report(sum(FORMULA)) over ()*100))">Psm</option>');
						else
							htp.p('<option value="PSM" title="trunc((ratio_to_report(sum(FORMULA)) over ()*100))">Psm</option>');
						end if;
						if ws_valor.st_agrupador = 'PCT' then
							htp.p('<option value="PCT" selected="selected" title="trunc((ratio_to_report(count(distinct FORMULA)) over ()*100))">Pct</option>');
						else
							htp.p('<option value="PCT" title="trunc((ratio_to_report(count(distinct FORMULA)) over ()*100))">Pct</option>');
						end if;
						if ws_valor.st_agrupador = 'CNT' then
							htp.p('<option value="CNT" selected="selected" title="count(distinct FORMULA)">CNT</option>');
						else
							htp.p('<option value="CNT" title="count(distinct FORMULA)">CNT</option>');
						end if;
						if ws_valor.st_agrupador = 'MED' then
							htp.p('<option value="MED" selected="selected">Med</option>');
						else
							htp.p('<option value="MED">Med</option>');
						end if;
						if ws_valor.st_agrupador = 'MOD' then
							htp.p('<option value="MOD" selected="selected">Mod</option>');
						else
							htp.p('<option value="MOD">Mod</option>');
						end if;
					htp.p('</select>');
				htp.p('</li>');
				
				htp.p('<li class="columnline">');
					htp.p('<span class="label">'||fun.lang('Liga&ccedil;&atilde;o')||'</span>');
					htp.p('<a class="script" onclick="call(''save_column'', ''prm_visao='||prm_visao||'&prm_name='||prm_name||'&prm_campo=CD_LIGACAO&prm_valor=''+document.getElementById(''lista-taux-fixa'').title).then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } });"></a>');
					fcl.fakeoption('lista-taux-fixa', ''||ws_valor.cd_ligacao||'', ''||ws_valor.cd_ligacao||'', 'lista-taux-fixa', 'N', 'N');
				htp.p('</li>');
				
				htp.p('<li class="columnline" data-campo="NM_UNIDADE">');
					htp.p('<span class="label">'||fun.lang('Unidade de medida')||'</span>');
					htp.p('<input type="text" class="listener" maxlength="20" data-default="'||ws_valor.nm_unidade||'" value="'||ws_valor.nm_unidade||'" />');
				htp.p('</li>');

				htp.p('<li class="columnline" data-campo="FLEXCOL">');
					htp.p('<span class="label">'||fun.lang('Flexcol')||'</span>');
					htp.p('<input type="text" class="listener" maxlength="80" data-default="'||ws_valor.flexcol||'" value="'||ws_valor.flexcol||'" />');
				htp.p('</li>');

				htp.p('<li class="columnline row" data-campo="LIMITE">');

				htp.p('<span class="label">'||fun.lang('Quebra de texto')||'</span>');
				htp.p('<a class="script" onclick="ajax(''fly'', ''save_column'', ''prm_visao='||prm_visao||'&prm_name='||prm_name||'&prm_campo=QUEBRA_TEXTO&prm_valor=''+this.nextElementSibling.title);"></a>');

				if ws_valor.quebra_texto = 'S' then
					htp.p('<span class="checkbox m2 checked" data-positive="S" data-negative="N" title="S"></span>');
				else
					htp.p('<span class="checkbox m2" data-positive="S" data-negative="N" title="N"></span>');
				end if;

				htp.p('<span style="margin-left: 7px; margin-right: 7px;" class="label">'||fun.lang('Limite do texto')||'</span>');
				htp.p('<input type="text" class="listener" data-default="'||ws_valor.limite||'"  value="'||ws_valor.limite||'" />');

				htp.p('</li>');
				
			htp.p('</ul>');

			htp.p('<ul class="colunas_att full">');
				htp.p('<li class="columnline" data-campo="ANOTACAO">');
					htp.p('<span class="label">'||fun.lang('Anota&ccedil;&atilde;o')||'</span>');
					htp.p('<textarea style="height: 100px;" maxlength="3000" class="listener" data-default="'||trim(ws_valor.anotacao)||'" id="anotacao-coluna">'||trim(ws_valor.anotacao)||'</textarea>');
				htp.p('</li>');
			htp.p('</ul>');
			
			ws_style_formula := 'style="color:initial;"'; 

			if ws_valor.formula is not null then 
				ws_retorno := null; 
				fun.valida_formula ('COLUNA', ws_valor.formula, prm_screen, null, prm_visao, prm_name, prm_retorno => ws_retorno); 
				if ws_retorno like 'ERRO|%' then 
					ws_style_formula := 'style="color: var(--vermelho-secundario);"'; 
					ws_retorno := substr(ws_retorno, instr(ws_retorno,'|',1,1)+1, instr(ws_retorno,'|',1,2) - (instr(ws_retorno,'|',1,1)+1) )||'.'; 
				else 
					ws_retorno := null;	
				end if; 
			end if; 	

			htp.p('<ul class="colunas_att full">');
				htp.p('<li class="columnline" data-campo="FORMULA">');
					htp.p('<span class="label">'||fun.lang('F&oacute;rmula')); 
						htp.p('<a class="addpurple" onclick="valida_formula();" style="margin-left: 15px;height: 8px; padding: 1px 10px 3px 10px;margin: 0px 0px 0px 15px;" title="Validar f&oacute;rmula">Validar</a>');
					htp.p('</span>');
					htp.p('<textarea spellcheck="false" maxlength="3000" class="listener" '||ws_style_formula||' data-default="'||trim(ws_valor.formula)||'" id="formula-coluna" data-startkey="" data-lastkey="" data-search="" onkeyup="auto(this, event, '''||prm_visao||''');">'||trim(ws_valor.formula)||'</textarea>');
					htp.p('<span id="erro_coluna_formula" >'||ws_retorno||'</span>'); 
				htp.p('</li>');
			htp.p('</ul>');
			htp.p('<ul id="auto-complete-formula" class="auto off"></ul>');

		end if;
exception 
	when ws_noadmin then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p('#alert '||fun.lang('impossivel completar solicita&ccedil;&atilde;o')||'!');
		htp.p(sqlerrm);
end load_column;

procedure auto_complete ( prm_visao   varchar2 default null,
						prm_letters varchar2 default null ) as

	cursor crs_auto is
		select cd_coluna, nm_rotulo, formula from micro_coluna
		where cd_micro_visao = prm_visao
		and upper(cd_coluna) like upper(prm_letters||'%')
		and rownum < 8;
	ws_auto crs_auto%rowtype;

begin

	open crs_auto;
		loop
			fetch crs_auto into ws_auto;
			exit when crs_auto%notfound;
				htp.p('<li title="'||ws_auto.formula||'" onclick="autoClick(this);">'||ws_auto.cd_coluna||'</li>');
		end loop;
	close crs_auto;

end auto_complete;


--!!
procedure save_column ( prm_visao  varchar2 default null,
						prm_name   varchar2 default null,
						prm_campo  varchar2 default null,
						prm_valor  varchar2 default null,
						prm_screen varchar2 default null ) as


	ws_count    number;
	ws_padrao   varchar2(40);
	ws_converte varchar2(4000);
	ws_usuario  varchar2(80);
	ws_retorno  varchar2(500); 

	ws_nouser   exception;

begin
	/*fcl.refresh_Session;*/
	ws_usuario := gbl.getUsuario;

	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if;

	ws_converte := fun.converte(prm_valor);

	select count(*) into ws_count from PARAMETRO_USUARIO where cd_usuario = ws_usuario and cd_padrao='CD_LINGUAGEM';

	if ws_count = 1 then
		select nvl(CONTEUDO, 'PORTUGUESE') into ws_padrao
		from   PARAMETRO_USUARIO
		where  cd_usuario = ws_usuario and
		cd_padrao='CD_LINGUAGEM';
	else
		ws_padrao := 'PORTUGUESE';
	end if;

	select count(*) into ws_count from micro_coluna where cd_micro_visao = prm_visao and cd_coluna = prm_name;

	if ws_count < 2 then
		if ws_count = 0 then
			insert into micro_coluna ( cd_micro_visao, cd_coluna, nm_rotulo, st_gera_rel, st_agrupador, nm_mascara, cd_ligacao, st_com_codigo, st_alinhamento, st_resumido, st_negrito, st_invisivel, nm_unidade, formula, tipo, rotulo_c, color, hint, flexcol, url, anotacao ) values (prm_visao, prm_name, '', 'S', 'SEM', 'SEM', 'SEM', 'N', 'LEFT', 'N', 'S', 'N', '', '', 'T', '', '', '', '', '', '');
		end if;
		case prm_campo
			when 'NM_ROTULO' then

				select count(*) into ws_count from traducao_colunas where cd_tabela = prm_visao and cd_coluna = 'NM_ROTULO' and cd_linguagem = ws_padrao and lang_default = (select nm_rotulo from micro_coluna where cd_micro_visao = prm_visao and cd_coluna = prm_name) and tipo = 'C';

				if ws_count = 0 then
					insert into traducao_colunas values (prm_visao, 'NM_ROTULO', ws_padrao, trim(ws_converte), trim(ws_converte), 'C', 'N');
				else
					update traducao_colunas
					set texto = trim(ws_converte)
					where cd_tabela = prm_visao
					and tipo = 'C'
					and cd_coluna = 'NM_ROTULO'
					and cd_linguagem = ws_padrao
					and lang_default = (select nm_rotulo from micro_coluna where cd_micro_visao = prm_visao and cd_coluna = prm_name);

					if ws_padrao = fun.ret_var('LANG_SYS') then
						update traducao_colunas
						set lang_default = trim(ws_converte)
						where cd_tabela = prm_visao
						and cd_coluna = 'NM_ROTULO'
						and tipo = 'C'
						and lang_default = (select nm_rotulo from micro_coluna where cd_micro_visao = prm_visao and cd_coluna = prm_name);
					end if;
				end if;
				
				--if ws_padrao = fun.ret_var('LANG_SYS') then
					
					update micro_coluna
					set nm_rotulo = ws_converte
					where cd_micro_visao = prm_visao and cd_coluna = prm_name;
					commit; 

					htp.p('#alert '||fun.lang('R&oacute;tulo alterado com sucesso')||'!');
				/*else
					htp.p('#alert '||fun.lang('R&oacute;tulo alterado com sucesso')||'!');
				end if;*/
				
			when 'ST_GERA_REL' then
				update micro_coluna
				set st_gera_rel = upper(trim(ws_converte))
				where cd_micro_visao = prm_visao and cd_coluna = prm_name;
				htp.p('#alert '||fun.lang('Gerar total alterado com sucesso')||'!');
			when 'ST_AGRUPADOR' then
				update micro_coluna
				set st_agrupador = upper(trim(ws_converte))
				where cd_micro_visao = prm_visao and cd_coluna = prm_name;
				htp.p('#alert '||fun.lang('Agrupador alterado com sucesso')||'!');
			when 'NM_MASCARA' then
				update micro_coluna
				set nm_mascara = upper(trim(ws_converte))
				where cd_micro_visao = prm_visao and cd_coluna = prm_name;
				htp.p('#alert '||fun.lang('Mascara alterada com sucesso')||'!');
			when 'CD_LIGACAO' then
				update micro_coluna
				set cd_ligacao = nvl(upper(trim(ws_converte)), 'SEM')
				where cd_micro_visao = prm_visao and cd_coluna = prm_name;
				htp.p('#alert '||fun.lang('Liga&ccedil;&atilde;o alterada com sucesso')||'!');
			when 'ST_COM_CODIGO' then
				update micro_coluna
				set st_com_codigo = upper(trim(ws_converte))
				where cd_micro_visao = prm_visao and cd_coluna = prm_name;
				htp.p('#alert '||fun.lang('Com c&oacute;digo alterado com sucesso')||'!');
			when 'ST_ALINHAMENTO' then
				update micro_coluna
				set st_alinhamento = upper(trim(ws_converte))
				where cd_micro_visao = prm_visao and cd_coluna = prm_name;
				htp.p('#alert '||fun.lang('Alinhamento alterado com sucesso')||'!');
			when 'ST_ALINHAMENTO_CAB' then
				update micro_coluna
				set st_alinhamento_cab = upper(trim(ws_converte))
				where cd_micro_visao = prm_visao and cd_coluna = prm_name;
				htp.p('#alert '||fun.lang('Alinhamento do cabe&ccedilalho alterado com sucesso')||'!');
			when 'ST_RESUMIDO' then
				update micro_coluna
				set st_resumido = upper(trim(ws_converte))
				where cd_micro_visao = prm_visao and cd_coluna = prm_name;
				htp.p('#alert '||fun.lang('Resumido alterado com sucesso')||'!');
			when 'ST_NEGRITO' then
				update micro_coluna
				set st_negrito = upper(trim(ws_converte))
				where cd_micro_visao = prm_visao and cd_coluna = prm_name;
				htp.p('#alert '||fun.lang('Negrito alterado com sucesso')||'!');
			when 'ST_INVISIVEL' then
				update micro_coluna
				set st_invisivel = upper(trim(ws_converte))
				where cd_micro_visao = prm_visao and cd_coluna = prm_name;
				htp.p('#alert '||fun.lang('Invis&iacute;vel alterado com sucesso')||'!');
			when 'NM_UNIDADE' then
				update micro_coluna
				set nm_unidade = trim(ws_converte)
				where cd_micro_visao = prm_visao and cd_coluna = prm_name;

				htp.p(fun.lang('Unidade alterada com sucesso')||'!');

			when 'HINT' then
				update micro_coluna
				set hint = trim(ws_converte)
				where cd_micro_visao = prm_visao and cd_coluna = prm_name;

				htp.p(fun.lang('Hint alterado com sucesso')||'!');

			when 'LIMITE' then
				update micro_coluna
				set limite = trim(ws_converte)
				where cd_micro_visao = prm_visao and cd_coluna = prm_name;

				htp.p(fun.lang('Limite alterado com sucesso')||'!');

			when 'ROTULO_C' then
				update micro_coluna
				set rotulo_c = trim(ws_converte)
				where cd_micro_visao = prm_visao and cd_coluna = prm_name;

				htp.p(fun.lang('R&oacute;tulo alterado com sucesso')||'!');

			when 'COLOR' then
				update micro_coluna
				set color = trim(ws_converte)
				where cd_micro_visao = prm_visao and cd_coluna = prm_name;
				htp.p('#alert '||fun.lang('Cor alterada com sucesso')||'!');
			when 'FLEXCOL' then
				update micro_coluna
				set flexcol = trim(ws_converte)
				where cd_micro_visao = prm_visao and cd_coluna = prm_name;

				htp.p(fun.lang('Flexcol alterada com sucesso')||'!');

			when 'URL' then
				update micro_coluna
				set url = trim(ws_converte)
				where cd_micro_visao = prm_visao and cd_coluna = prm_name;

				htp.p(fun.lang('Imagem alterada com sucesso')||'!');
			
			when 'ANOTACAO' then
				update micro_coluna
				set anotacao = trim(ws_converte)
				where cd_micro_visao = prm_visao and cd_coluna = prm_name;

				htp.p(fun.lang('Anota&ccedil;&atilde;o alterada com sucesso')||'!');

			when 'FORMULA' then

				update micro_coluna
					set formula = trim(ws_converte)
					where cd_micro_visao = prm_visao 
					and cd_coluna      = prm_name;
				
				delete from object_attrib where cd_prop = 'TPT' and cd_object = prm_name and owner <> 'DWU';

				-- valida a fórmula 
				ws_retorno := null; 
				fun.valida_formula ('COLUNA',  ws_converte, prm_screen, null, prm_visao, prm_name, prm_retorno => ws_retorno); 
				if ws_retorno like 'ERRO|%' then 
					ws_retorno := substr(ws_retorno, instr(ws_retorno,'|',1,1)+1, instr(ws_retorno,'|',1,2)-(instr(ws_retorno,'|',1,1)+1) ); 
				else 
					ws_retorno := null;	
				end if; 

				htp.p('OK|'||fun.lang('F&oacute;rmula alterada com sucesso')||'|'||ws_retorno);

      when 'QUEBRA_TEXTO' then 
				update micro_coluna
				set QUEBRA_TEXTO = trim(ws_converte)
				where cd_micro_visao = prm_visao and cd_coluna = prm_name;

				htp.p('OK|'||fun.lang('Quebra texto foi alterado com sucesso')||'|'||ws_retorno);

			else
				htp.p(''||fun.lang('erro no case, campo n&atilde;o especificado')||'');
		end case;

		update micro_visao set dt_ultima_alteracao = sysdate 
		 where nm_micro_visao = prm_visao;

	else
		htp.p('#alert '||fun.lang('Micro coluna n&atilde;o encontrada com nome e a view definidos!')||'');
	end if;
exception 
	when ws_nouser then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p('#alert '||fun.lang('Erro ao alterar')||'!');
end save_column;


procedure testa_formula ( prm_tabela  varchar2 default null,
						prm_coluna  varchar2 default null,
						prm_screen  varchar2 default null ) as
						
	ws_sql     varchar2(4000);
	ws_cursor  integer;
	ws_tabela  varchar2(400);
	ws_formula varchar2(400);
						
begin

	select nm_tabela into ws_tabela from micro_visao where upper(nm_micro_visao) = upper(prm_tabela);
	
	ws_formula := fun.xcalc(prm_coluna, prm_tabela, 'SRC_12723150427125752');

	ws_sql := 'select '||ws_formula||' from '||nvl(fun.ret_var('OWNER_TABLE_DATA'),'DWU')||'.'||ws_tabela;
	
	ws_cursor := dbms_sql.open_cursor;
	dbms_sql.parse(ws_cursor, ws_sql, DBMS_SQL.NATIVE);
	dbms_sql.close_cursor(ws_cursor);
	
exception 
	when others then
		htp.p('FAIL '||sqlerrm);
end testa_formula;


procedure LOAD_COLUMNS ( PRM_MICRO_VISAO char default null ) as

	cursor crs_visao is
			select	rtrim(nm_micro_visao) as nm_micro_visao
			from 	MICRO_VISAO
			where	cd_grupo_funcao = prm_micro_visao
			order by nm_micro_visao;

	ws_visao	crs_visao%rowtype;
	ws_tmp		long;
	ws_counter	number;

	type ws_tmcolunas		is table of	MICRO_COLUNA%ROWTYPE
						index by pls_integer;

	cursor nc_colunas is		select * from MICRO_COLUNA where cd_micro_visao = prm_micro_visao;

	ret_mcol			ws_tmcolunas;

begin
	/*fcl.refresh_Session;*/
	open nc_colunas;
	loop
		fetch nc_colunas bulk collect into ret_mcol limit 2000;
		exit when nc_colunas%NOTFOUND;
	end loop;
	close nc_colunas;

	ws_tmp := '<script>';
	ws_tmp := ws_tmp||'var incrx=parent.document.getElementById(''lagrupadores''); ';
	ws_tmp := ws_tmp||'incrx.innerHTML = '||chr(39);
	ws_tmp := ws_tmp||'<select name="colagp" id="agrp" style="font-size: 10px;" >';

	ws_counter := 0;
	loop
		ws_counter := ws_counter + 1;
		if  ws_counter > ret_mcol.COUNT then
		exit;
		end if;
		if  ret_mcol(ws_counter).st_agrupador = 'SEM' then
		ws_tmp := ws_tmp||'<option value="'||ret_mcol(ws_counter).cd_coluna||'" >'||ret_mcol(ws_counter).nm_rotulo||' </option>';
		end if;
	end loop;
	ws_tmp := ws_tmp||'</select>'||chr(39)||';</script>';

	ws_tmp := ws_tmp||'<script>';
	ws_tmp := ws_tmp||'var incrx=parent.document.getElementById(''lvalores''); ';
	ws_tmp := ws_tmp||'incrx.innerHTML = '||chr(39);
	ws_tmp := ws_tmp||'<select NAME="colval" id="agvl" style="font-size: 10px;" >';
	ws_counter := 0;
	loop
		ws_counter := ws_counter + 1;
		if  ws_counter > ret_mcol.COUNT then
		exit;
		end if;
		if  ret_mcol(ws_counter).st_agrupador <> 'SEM' or ret_mcol(ws_counter).tipo='C' then
			ws_tmp := ws_tmp||'<option value="'||ret_mcol(ws_counter).cd_coluna||'" >'||ret_mcol(ws_counter).nm_rotulo||' </option>';
		end if;
	end loop;
	ws_tmp := ws_tmp||'</select>'||chr(39)||';</script>';

	htp.p(ws_tmp);

END LOAD_COLUMNS;

--!!
procedure dl_column ( prm_view   varchar2 default null,
					prm_coluna varchar2 default null ) as

	ws_erro    exception;
	ws_noadmin exception;

begin
	
	if gbl.getNivel <> 'A' then
		raise ws_noadmin;
	end if;
	
	begin
		delete from micro_coluna where cd_coluna = prm_coluna and cd_micro_visao = prm_view;
		commit;

		htp.p('#alert '||fun.lang('Coluna excluida do sistema')||'!');
		
		insert into bi_log_sistema values (sysdate, 'Coluna '||prm_coluna||' excluida da view '||prm_view, gbl.getUsuario, 'EVENTO');
		commit;
	exception when others then
		raise ws_erro;
	end;
exception
	when ws_noadmin then
		htp.p('Sem permiss&atilde;o!');
	when ws_erro then
		htp.p('#alert '||fun.lang('Erro ao excluir a coluna')||'!');
	when others then
		htp.p(sqlerrm);
end dl_column;



procedure INITCAB (	ws_xcount	in out 	number,
					ws_scol		in out 	number,
					prm_coluna	in out 	varchar2,
					ws_mode		in out 	varchar2,
					cd_ligacao	in out 	varchar2,
					st_com_codigo   in out  varchar2,
					ws_content_ant	in out 	long,
					prm_micro_visao	varchar2 default null,
					prm_objid       varchar2 default null,
					prm_invisible   in out 	number ) as

			ws_mascara     varchar2(400);
			ws_count       number;
			ws_colspan     number;
			ws_alinhamento varchar2(400);
			ws_negrito     varchar2(400);
			ws_fix         varchar2(400);

begin
	/*fcl.refresh_Session;*/
		ws_count := 0;
		if length(fun.getprop(prm_objid,'CALCULADA')) > 0 then
			for i in (select column_value as valor from table(fun.vpipe((fun.getprop(prm_objid,'CALCULADA'))))) loop
				if instr(i.valor, '<') > 0 then
					ws_count := ws_count+1;
				end if;
			end loop;
		end if;

		if length(fun.getprop(prm_objid,'CALCULADA')) > 0 then
			for i in (select column_value as valor from table(fun.vpipe((fun.getprop(prm_objid,'CALCULADA'))))) loop
				if instr(i.valor, '>') > 0 then
					ws_count := ws_count+1;
				end if;
			end loop;
		end if;
	
	ws_colspan := ((ws_xcount*ws_scol)+ws_count)-(prm_invisible*ws_xcount);

	select st_alinhamento, st_negrito into ws_alinhamento, ws_negrito from MICRO_COLUNA where cd_micro_visao = prm_micro_visao and cd_coluna = prm_coluna;

		if trim(ws_alinhamento) = 'RIGHT' then
			if(trim(ws_negrito) = 'S') then
				ws_fix := ws_fix||' dir bld';
			else
				ws_fix := ws_fix||' dir';
			end if;
		elsif trim(ws_alinhamento) = 'CENTER' then
			if(rtrim(ws_negrito) = 'S') then
				ws_fix := ws_fix||' cen bld';
			else
				ws_fix := ws_fix||' cen';
			end if;
		else
			if(rtrim(ws_negrito) = 'S') then
				ws_fix := ws_fix||' bld';
			end if;
		end if;

	ws_fix := trim(ws_fix);

	htp.prn('<th class="'||ws_fix||'" colspan="'||ws_colspan||'" title="ws_xcount => '||ws_xcount||', ws_scol => '||ws_scol||', ws_count => '||ws_count||'">');
		if  cd_ligacao <> 'SEM' then
			if  st_com_codigo = 'S' then
				ws_content_ant := ws_content_ant||'-'||fun.cdesc(ws_content_ant,cd_ligacao);
			else
				ws_content_ant := fun.cdesc(ws_content_ant,cd_ligacao);
			end if;
		end if;
		begin
			select nm_mascara into ws_mascara from micro_coluna t1 where t1.cd_coluna = prm_coluna and t1.cd_micro_visao = prm_micro_visao and rownum = 1;
			htp.p(trim(fun.utranslate('NM_ROTULO', prm_micro_visao, fun.ifmascara(ws_content_ant,ws_mascara, prm_micro_visao, prm_coluna, '', '', '', ''))));
		exception when others then
			htp.p(trim(fun.utranslate('NM_ROTULO', prm_micro_visao, ws_content_ant)));
		end;
		htp.p('</th>');

end INITCAB;


procedure av_prop ( ws_par_sumary varchar2, 
					ws_type       varchar2 default 'NOSUB', 
					prm_screen    varchar2 default 'DEFAULT' ) as

	ws_count			number;
	ws_counter          number;
	ws_mascara			varchar2(30);
	ws_cd_prop			DBMS_SQL.VARCHAR2_TABLE;
	ws_prop				DBMS_SQL.VARCHAR2_TABLE;
	ws_rotulo			DBMS_SQL.VARCHAR2_TABLE;
	ws_tipo				DBMS_SQL.VARCHAR2_TABLE;
	ws_sufixo			DBMS_SQL.VARCHAR2_TABLE;
	ws_script			DBMS_SQL.VARCHAR2_TABLE;
	ws_list				DBMS_SQL.VARCHAR2_TABLE;
	ws_grupo            DBMS_SQL.VARCHAR2_TABLE;
	ws_hint			    DBMS_SQL.VARCHAR2_TABLE;
	ws_title            varchar2(60);
	ws_visao            varchar2(40);
	ws_grupo_start      varchar2(60);
	ws_ordem            DBMS_SQL.NUMBER_TABLE;
	ws_width            varchar2(20);
	ws_valor            varchar2(3000);
	ws_tipo_obj         varchar2(40);
	ws_order            number;
	ws_readonly         varchar2(60) := '';
	ws_usuario          varchar2(80);
	ws_admin            varchar2(80);
	ws_desc             varchar2(500); 

	ws_nouser           exception;

begin

	ws_usuario := gbl.getUsuario;

	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if;

	ws_admin   := gbl.getNivel;

	select tp_objeto into ws_tipo_obj from objetos where cd_objeto = ws_par_sumary;

	fcl.arrgetprop( trim(ws_par_sumary), ws_cd_prop, ws_prop, ws_rotulo, ws_tipo, ws_sufixo, ws_script, ws_list, ws_grupo, ws_hint, ws_ordem, prm_screen);

	htp.formOpen( cattributes => 'name="pontoa" id="saveap" style="display: none;" ', ctarget => '', curl => ''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.save_prop', cmethod => 'post');
		ws_count := 0;
		loop
			ws_count := ws_count + 1;
			if  ws_count > ws_prop.COUNT then
				exit;
			end if;
			htp.p( '<input class="array_nomes"  id="'||'xd_'||ws_cd_prop(ws_count)||ws_count||'" value="'||ws_cd_prop(ws_count)||'" >' );
			htp.p( '<input class="array_transf" id="'||'id_'||ws_cd_prop(ws_count)||ws_count||'" value="'||ws_prop(ws_count)||'" >' );
		end loop;
		htp.formHidden( cname => 'prm_objeto' , cvalue => ws_par_sumary, cattributes => 'id="obj" ');
		htp.formHidden( cname => 'prm_screen' , cvalue => '', cattributes => 'id="tnm_screen" ' );
	htp.formClose;

	htp.p('<div class="itens" style="width: 346px;" data-obj="'||ws_par_sumary||'" style="position: relative;" data-save="false" onmouseleave="if(event.relatedTarget != null){ save(''saveprop''); if(document.getElementById('''||ws_par_sumary||''')){ document.getElementById('''||ws_par_sumary||''').classList.remove(''destacada''); } }" onmouseenter="if(document.getElementById('''||ws_par_sumary||''')){ document.getElementById('''||ws_par_sumary||''').classList.add(''destacada''); }" onscroll="">');
	htp.p('<h2 class="fixed">'||fun.lang('ATRIBUTOS')||'</h2>');

	if ws_tipo_obj <> 'FLOAT_PAR' and ws_tipo_obj <> 'FLOAT_FILTER' then
		select to_char(100/count(distinct grupo), '999')||'%' into ws_width from bi_object_padrao where tp_objeto = ws_tipo_obj;
	
		ws_count := 0;
		htp.p('<div class="abas">');

			for i in (select distinct grupo from bi_object_padrao where tp_objeto = ws_tipo_obj) loop
				if i.grupo = ws_grupo(1) then
					htp.p('<a style="width: '||ws_width||';" class="green" data-for="form-'||i.grupo||'" onclick="toggleAba(this);">'||fun.lang(i.grupo)||'</a>');
				else
					htp.p('<a style="width: '||ws_width||';" class="" data-for="form-'||i.grupo||'" onclick="toggleAba(this);">'||fun.lang(i.grupo)||'</a>');
				end if;
			end loop;

		htp.p('</div>');
	
	else
		htp.p('<div class="abas">');
			htp.p('<a style="width: 100%;" class="green" data-for="form-RECURSO">'||fun.lang('RECURSO')||'</a>');
		htp.p('</div>');
	end if;

	htp.p('<ul class="form aba" id="form-'||ws_grupo(1)||'">');

	ws_count := 0;
	ws_grupo_start := 'N/A';
	loop
		ws_count := ws_count + 1;
		if  ws_count > ws_prop.COUNT then
			htp.p('</ul>');
			exit;
		end if;

		if ws_count = 1 then
			ws_grupo_start := ws_grupo(ws_count);
		end if;


		if ws_grupo(ws_count) <> ws_grupo_start then
			htp.p('</ul>');
			htp.p('<ul class="form aba closed" id="form-'||ws_grupo(ws_count)||'" style="overflow: auto; height: calc(100% - '||ws_width||'px);">');
			ws_grupo_start := ws_grupo(ws_count);
		end if;

		begin

			if ws_rotulo(ws_count) <> 'Vertical' and ws_cd_prop(ws_count) <> 'CALCULADA_M' and ws_cd_prop(ws_count) <> 'CALCULADA_N'  
			and ws_cd_prop(ws_count) <> 'DASH_MARGIN' and ws_cd_prop(ws_count) <> 'DASH_MARGIN_RIGHT' and ws_cd_prop(ws_count) <> 'DASH_MARGIN_BOT' 
			and ws_cd_prop(ws_count) <> 'DASH_MARGIN_LEFT' and NOT ( ws_tipo(ws_count) like '%\_FO' escape '\' and trim(ws_cd_prop(ws_count)) like '%\_N' ESCAPE '\' )  
			and NOT ( ws_cd_prop(ws_count) = 'VISIVEL' and ws_tipo_obj in ('BARRAS','COLUNAS','LINHAS') ) then
			
				if ws_cd_prop(ws_count) <> 'DASH_MARGIN_TOP' then
					htp.p('<li title="'||ws_hint(ws_count)||'" data-default="'||ws_prop(ws_count)||'" data-prop="'||ws_cd_prop(ws_count)||'">');

					htp.p('<span class="before">'||fun.lang(ws_rotulo(ws_count))||'</span>');
					htp.p('<span class="after'||ws_readonly||'" id="'||ws_par_sumary||'_'||ws_cd_prop(ws_count)||'">');

				end if;

				if ws_rotulo(ws_count) = 'Agrupadores' and ws_admin = 'A' then  
					select cd_micro_visao into ws_visao from ponto_avaliacao where cd_ponto = ws_par_sumary and rownum = 1;
					htp.p('<span id="micro-visao" style="display: none;" title="'||ws_visao||'">'||ws_visao||'</span>');
					htp.p('<a class="script" onclick="call(''alter_agrupadores'', ''prm_objeto='||ws_par_sumary||'&prm_agrupadores=''+this.nextElementSibling.title+''&prm_tipo=AGRUPADORES'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } }); "></a>');
					fcl.fakeoption('agrupador_'||ws_par_sumary, 'Escolha um agrupador', fun.getprop(ws_par_sumary, 'AGRUPADORES'), 'lista-valor', 'N', 'S', 'micro-visao');
				
				elsif ws_cd_prop(ws_count) = 'OCULTAR_SUBTOTAL' then 

					select cd_micro_visao into ws_visao from ponto_avaliacao where cd_ponto = ws_par_sumary and rownum = 1;
					ws_valor := nvl(fun.getprop(ws_par_sumary, ws_cd_prop(ws_count)),'NENHUM'); 

					if ws_valor in ('NENHUM','TODOS') then 
						ws_desc := ws_valor;
					else 	
						select substr(listagg(nvl(fun.check_rotuloc(column_value, t2.cd_micro_visao), nm_rotulo),',') within group (order by 1),1,499) into ws_desc 
						  from micro_coluna t2, table(fun.vpipe(ws_valor)) t1  
						 where t2.cd_micro_visao = ws_visao 
						   and t2.cd_coluna      = t1.column_value; 
					end if; 

					htp.p('<span id="micro-visao" style="display: none;" title="'||ws_visao||'">'||ws_visao||'</span>');
					htp.p('<a class="script" onclick="call(''alter_attrib'', ''prm_objeto='||ws_par_sumary||'&prm_prop='||ws_cd_prop(ws_count)||'&prm_value=''+encodeURIComponent(this.nextElementSibling.title)+''&prm_usuario='').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } });"></a>');
					fcl.fakeoption(ws_cd_prop(ws_count)||'_'||ws_par_sumary, 'Subtotais', ws_valor, 'lista-ocultar_subtotal', 'N', 'S', 'micro-visao', prm_adicional => ws_par_sumary, prm_desc => ws_desc);

				elsif ws_cd_prop(ws_count) = 'HIDDEN' and ws_tipo_obj in ('LINHAS', 'BARRAS', 'COLUNAS') then

					select cd_micro_visao into ws_visao from ponto_avaliacao where cd_ponto = ws_par_sumary and rownum = 1;
					htp.p('<span id="micro-visao" style="display: none;" title="'||ws_visao||'">'||ws_visao||'</span>');
					htp.p('<a class="script" onclick="call(''alter_attrib'', ''prm_objeto='||ws_par_sumary||'&prm_prop=HIDDEN&prm_value=''+encodeURIComponent(this.nextElementSibling.title)+''&prm_usuario='').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } });"></a>');
					fcl.fakeoption('hidden_'||ws_par_sumary, 'Valores para ocultar', fun.getprop(ws_par_sumary, 'HIDDEN'), 'lista-valor-usado', 'N', 'S', 'micro-visao', prm_fixed =>'COLUNAS', prm_adicional => ws_par_sumary);

				elsif ws_cd_prop(ws_count) = 'VISIVEL' and ws_admin = 'A' then
					select cd_micro_visao into ws_visao from ponto_avaliacao where cd_ponto = ws_par_sumary and rownum = 1;
					htp.p('<a class="link" onclick="fakeOption('''||ws_par_sumary||''', ''VISIVEL'', ''visivel'', '''||ws_visao||''', '''||prm_screen||''' );">'||fun.lang('ALTERAR')||'</a>');
				elsif ws_cd_prop(ws_count) = 'SUBQUERY' and ws_admin = 'A' then
					htp.p('<a class="script" onclick="update_prop('''||ws_par_sumary||''', ''SUBQUERY'', this.nextElementSibling.title); /*document.querySelector(''.itens'').setAttribute(''data-alterado'', ''T'');*/"></a>');
					fcl.fakeoption('micro-coluna', 'Escolha uma subquery', fun.getprop(ws_par_sumary,'SUBQUERY'), 'lista-agrupador', 'N', 'S', 'micro-visao');
				elsif ws_cd_prop(ws_count) = 'ENCADEADO' and ws_admin = 'A' then
					htp.p('<a class="script" onclick="call(''alter_attrib'', ''prm_objeto='||ws_par_sumary||'&prm_prop=ENCADEADO&prm_value=''+this.nextElementSibling.title+''&prm_usuario='').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } });"></a>');
					fcl.fakeoption('padrao-encadeado', 'Escolha padrao para encadear', fun.getprop(ws_par_sumary,'ENCADEADO'), 'lista-padroes-unicos', 'N', 'S', 'micro-visao');
				elsif ws_cd_prop(ws_count) = 'ENCADEADO_GERAL' and ws_admin = 'A' then
					htp.p('<a class="script" onclick="call(''alter_attrib'', ''prm_objeto='||ws_par_sumary||'&prm_prop=ENCADEADO_GERAL&prm_value=''+this.nextElementSibling.title+''&prm_usuario='').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } });"></a>');
					fcl.fakeoption('padrao-encadeado_geral', 'Escolha filtro de usu&aacute;rio', fun.getprop(ws_par_sumary,'ENCADEADO_GERAL'), 'lista-filtros-usuarios', 'N', 'S', 'micro-visao', prm_desc => replace(fun.getprop(ws_par_sumary,'ENCADEADO_GERAL'),'|',', ') );
				elsif ws_cd_prop(ws_count) = 'COMANDO' and ws_admin = 'A' then
					htp.p('<a class="script" onclick="call(''alter_attrib'', ''prm_objeto='||ws_par_sumary||'&prm_prop=COMANDO&prm_value=''+this.nextElementSibling.title+''&prm_usuario=DWU'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } });"></a>');
					fcl.fakeoption(ws_par_sumary||'_fake', '', fun.getprop(ws_par_sumary, 'COMANDO'), 'lista-procedures', 'N', 'N');
				elsif ws_cd_prop(ws_count) = 'FILTROS' and ws_admin = 'A' then
					htp.p('<a class="link" title="'||FUN.LANG('Filtros')||'" onclick="titulo(this, ''c''); closeSideBar(''popupmenu''); telaSup(''objeto'', '''||ws_par_sumary||'''); telaSup(''visao'', '''||ws_visao||'''); carregaPainel(''list_ofiltro_float'', '''||ws_par_sumary||'|'||ws_visao||'''); carrega(''list_ofiltro?ws_par_sumary='||ws_par_sumary||'&prm_visao='||ws_visao||'''); curtain(''enabled'');">'||FUN.LANG('ALTERAR')||'</a>');
				elsif ws_cd_prop(ws_count)   = 'EXECUCAO' then
					htp.p('<a class="script" onclick="ajax(''fly'', ''alter_attrib'', ''prm_objeto='||ws_par_sumary||'&prm_prop=EXECUCAO&prm_value=''+this.nextElementSibling.title+''&prm_usuario=DWU'', true);"></a>');
					if fun.getprop(ws_par_sumary,'EXECUCAO') = 'EXCLUSIVA' then
						htp.p('<span class="checkbox checked" data-positive="EXCLUSIVA" data-negative="" title="'||fun.getprop(ws_par_sumary,'EXECUCAO')||'"></span>');
					else
						htp.p('<span class="checkbox" data-positive="EXCLUSIVA" data-negative="" title="'||fun.getprop(ws_par_sumary,'EXECUCAO')||'"></span>');
					end if;
				
				elsif ws_cd_prop(ws_count) = 'ESPACAMENTO' then
					ws_order := 4;
					
					for i in 1..4 loop
						
						ws_valor := '';
						
						begin
							select valor into ws_valor from(select column_value as valor, rownum as linha from table(fun.vpipe(fun.getprop(ws_par_sumary, 'ESPACAMENTO')))) where linha = i;
						
						exception when others then
							ws_valor := '';
						
						end;

						case
							when ws_order = 4 then
								htp.p('<input type="text" title="Margem interna superior" style="order: '||ws_order||'; width: 30px;" onblur="this.parentNode.parentNode.parentNode.setAttribute(''data-alterado'', ''T'');" value="'||ws_valor||'" />');
							
							when ws_order = 3 then
								htp.p('<input type="text" title="Margem interna direita" style="order: '||ws_order||'; width: 30px;" onblur="this.parentNode.parentNode.parentNode.setAttribute(''data-alterado'', ''T'');" value="'||ws_valor||'" />');
							
							when ws_order = 2 then
								htp.p('<input type="text" title="Margem interna inferior" style="order: '||ws_order||'; width: 30px;" onblur="this.parentNode.parentNode.parentNode.setAttribute(''data-alterado'', ''T'');" value="'||ws_valor||'" />');
							
							when ws_order = 1 then
								htp.p('<input type="text" title="Margem interna esquerda" style="order: '||ws_order||'; width: 30px;" onblur="this.parentNode.parentNode.parentNode.setAttribute(''data-alterado'', ''T'');" value="'||ws_valor||'" />');
						
						end case;

						ws_order := ws_order-1;
						
					end loop;

				elsif ws_cd_prop(ws_count) = 'DASH_MARGIN_TOP' then
					
					if ws_tipo_obj in ('CONSULTA', 'PONTEIRO', 'VALOR', 'BARRAS', 'COLUNAS', 'PIZZA', 'LINHAS', 'MAPA', 'FILE', 'TEXTO', 'ICONE', 'IMAGE','MAPAGEOLOC','SANKEY','SCATTER','RADAR','CALENDARIO') then

						htp.p('<li title="Margem do dashboard" data-default="" data-prop="">');
									
							htp.p('<span class="before" style="margin-right: 48px;">Margem no dashboard</span>');

							htp.p('<input type="number" min="0" style="order: 1; width: 32px; height: 16px; text-indent: 0;" onblur="call(''save_prop'', ''prm_prop=DASH_MARGIN_LEFT&prm_valor=''+this.value+''px&prm_objeto='||ws_par_sumary||'&prm_url_default=&prm_screen='||prm_screen||''').then(function(resposta){ if(resposta.indexOf(''#alert'') == -1){ alerta(''feed-fixo'', TR_AL); } });" onchange="document.getElementById('''||ws_par_sumary||''').style.setProperty(''margin-left'', this.value+''px''); document.getElementById('''||ws_par_sumary||''').style.setProperty(''max-width'', ''calc(100% - ''+this.value+''px - ''+this.nextElementSibling.nextElementSibling.value+''px'');" value="'||replace(lower(fun.getprop(ws_par_sumary, 'DASH_MARGIN_LEFT', prm_screen)),'px','')||'" />');
							
							htp.p('<span style="order: 2; display: flex; flex-flow: column;">');
								htp.p('<input type="number" min="0" style="order: 1; width: 32px; height: 16px; text-indent: 0;" onblur="call(''save_prop'', ''prm_prop=DASH_MARGIN_TOP&prm_valor=''+this.value+''px&prm_objeto='||ws_par_sumary||'&prm_url_default=&prm_screen='||prm_screen||''').then(function(resposta){ if(resposta.indexOf(''#alert'') == -1){ alerta(''feed-fixo'', TR_AL); } });" onchange="document.getElementById('''||ws_par_sumary||''').style.setProperty(''margin-top'', this.value+''px'');" value="'||replace(lower(fun.getprop(ws_par_sumary, 'DASH_MARGIN_TOP', prm_screen)),'px','')||'" />');
								htp.p('<input type="number" min="0" style="order: 2; width: 32px; height: 16px; margin-top: 28px; text-indent: 0;" onblur="call(''save_prop'', ''prm_prop=DASH_MARGIN_BOT&prm_valor=''+this.value+''px&prm_objeto='||ws_par_sumary||'&prm_url_default=&prm_screen='||prm_screen||''').then(function(resposta){ if(resposta.indexOf(''#alert'') == -1){ alerta(''feed-fixo'', TR_AL); } });" onchange="document.getElementById('''||ws_par_sumary||''').style.setProperty(''margin-bottom'', this.value+''px'');" value="'||replace(lower(fun.getprop(ws_par_sumary, 'DASH_MARGIN_BOT', prm_screen)),'px','')||'" />');
							htp.p('</span>');

							htp.p('<input type="number" min="0" style="order: 3; width: 32px; height: 16px; text-indent: 0;" onblur="call(''save_prop'', ''prm_prop=DASH_MARGIN_RIGHT&prm_valor=''+this.value+''px&prm_objeto='||ws_par_sumary||'&prm_url_default=&prm_screen='||prm_screen||''').then(function(resposta){ if(resposta.indexOf(''#alert'') == -1){ alerta(''feed-fixo'', TR_AL); } });" onchange="document.getElementById('''||ws_par_sumary||''').style.setProperty(''margin-right'', this.value+''px''); document.getElementById('''||ws_par_sumary||''').style.setProperty(''max-width'', ''calc(100% - ''+this.previousElementSibling.previousElementSibling.value+''px - ''+this.value+''px'');" value="'||replace(lower(fun.getprop(ws_par_sumary, 'DASH_MARGIN_RIGHT', prm_screen)),'px','')||'" />');

						htp.p('</li>');
							
					end if;

				elsif ws_cd_prop(ws_count) = 'CORES' and ws_admin = 'A' then
					
					htp.p('<input type="text" value="'||fun.getprop(ws_par_sumary, 'CORES')||'" />');
					
				elsif ws_cd_prop(ws_count) = 'ESTADOS' then
					htp.p('<a class="script" id="objeto-estado-script" title="'||ws_par_sumary||'" onclick="ajax(''fly'', ''alter_attrib'', ''prm_objeto='||ws_par_sumary||'&prm_prop=ESTADOS&prm_value=''+this.nextElementSibling.title+''&prm_usuario=DWU'', true);"></a>');
					

					fcl.fakeoption('objeto-estado', 'Escolha os estados', fun.getprop(ws_par_sumary, 'ESTADOS'), 'lista-estados', 'N', 'S', 'objeto-estado-script', '', '');
					
				elsif ws_cd_prop(ws_count) = 'REGIOES' then
					htp.p('<a class="script" id="objeto-regiao-script" title="'||ws_par_sumary||'" onclick="ajax(''fly'', ''alter_attrib'', ''prm_objeto='||ws_par_sumary||'&prm_prop=REGIOES&prm_value=''+this.nextElementSibling.title+''&prm_usuario=DWU'', true);"></a>');
					

					fcl.fakeoption('objeto-regioes', 'Escolha as regioes', fun.getprop(ws_par_sumary, 'REGIOES'), 'lista-regioes', 'N', 'S', 'objeto-regiao-script', '', '');
					
				elsif ws_rotulo(ws_count) = 'Cor das colunas' and ws_admin = 'A' then
					htp.p('<a class="link" onclick="fakeOption('''||ws_par_sumary||''', ''Cor das colunas'', ''cor-coluna'', '''||ws_par_sumary||''');">'||fun.lang('ALTERAR')||'</a>');
				elsif ws_rotulo(ws_count) = 'Calculada' and ws_admin = 'A' then
					htp.p('<a class="link" onclick="fakeOption('''||ws_par_sumary||''', ''Colunas calculadas'', ''calculada'', '''||ws_par_sumary||''');">'||fun.lang('ALTERAR')||'</a>');
				
				-- Novo tipo de attributo para informar propriedades de mais de uma coluna - 18/01/2021
				------------------------------------------------------------------------------------------------------
				elsif (ws_tipo(ws_count) like '%\_FO' escape '\')  and ws_admin = 'A' then
					htp.p('<a class="link" onclick="fakeOption('''||ws_par_sumary||''', '''||ws_rotulo(ws_count)||''', '''||ws_cd_prop(ws_count)||''', '''||ws_par_sumary||''');">'||fun.lang('ALTERAR')||'</a>');

				elsif ws_rotulo(ws_count) = 'Limitadores' and ws_admin = 'A' then
					select cd_ligacao into ws_visao from parametro_padrao where cd_padrao = replace(ws_par_sumary, '_FILTER', '') and rownum = 1;
					htp.p('<span id="micro-visao" style="display: none;" title="'||ws_visao||'">'||ws_visao||'</span>');
					htp.p('<a class="script" id="objeto-limitador-script" title="'||replace(ws_par_sumary, '_FILTER', '')||'" onclick="ajax(''fly'', ''alter_attrib'', ''prm_objeto='||replace(ws_par_sumary, '_FILTER', '')||'&prm_prop=LIMITADORES&prm_value=''+encodeURIComponent(this.nextElementSibling.title)+''&prm_usuario=DWU'', true); alerta(''feed-fixo'', TR_AL);"></a>');
					
					begin
						select propriedade into ws_valor from object_attrib where cd_prop = 'LIMITADORES' and cd_object = replace(ws_par_sumary, '_FILTER', '');
						
						fcl.fakeoption(replace(ws_par_sumary, '_FILTER', ''), 'Escolha os limitadores', ws_valor, 'lista-limitador', 'N', 'S', 'micro-visao', '', '');
					exception when others then
						fcl.fakeoption(replace(ws_par_sumary, '_FILTER', ''), 'Escolha os limitadores', fun.getprop(replace(ws_par_sumary, '_FILTER', ''), 'LIMITADORES'), 'lista-limitador', 'N', 'S', 'micro-visao', '', '');
					end;
				elsif ws_cd_prop(ws_count) = 'IMG' then
					htp.p('<a class="script" onclick="var url = '''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download?arquivo=''+this.nextElementSibling.title; update_prop('''||ws_par_sumary||''', ''img_valor'', url); document.getElementById('''||ws_par_sumary||''').querySelector(''.img_container'').children[0].setAttribute(''src'', url);"></a>');
					fcl.fakeoption('fake_img', 'Imagem', replace(upper(ws_prop(ws_count)), ''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download?arquivo=', ''), 'lista-arquivo-imagem', 'S', 'N');
				elsif ws_cd_prop(ws_count) = 'MARKER_STYLE' then
					ws_valor := fun.getprop(ws_par_sumary,'MARKER_STYLE'); 
					select upper(max(ds_marcador)) into ws_desc 
					from bi_mapa_marcador where cd_marcador = ws_valor;
					htp.p('<a class="script" onclick="call(''alter_attrib'', ''prm_objeto='||ws_par_sumary||'&prm_prop=MARKER_STYLE&prm_value=''+this.nextElementSibling.title+''&prm_usuario='').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } });"></a>');
					fcl.fakeoption('estilo-marcador', 'Escolha o estilo padrao dos marcadores do mapa', ws_valor, 'lista-mapa-marcador', 'N', 'N', 'micro-visao', prm_desc => ws_desc );
				elsif ws_cd_prop(ws_count) = 'MARKER_HIDE' then

					ws_valor := fun.getprop(ws_par_sumary,'MARKER_HIDE'); 
					htp.p('<a class="script" onclick="call(''alter_attrib'', ''prm_objeto='||ws_par_sumary||'&prm_prop=MARKER_HIDE&prm_value=''+this.nextElementSibling.title+''&prm_usuario='').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } });"></a>');
					fcl.fakeoption('oculta-marcador', 'Escolha informa&ccedil;&otilde;es a ocultar.', ws_valor, 'oculta-mapa-marcador', 'N', 'S', 'micro-visao' );

				elsif ws_cd_prop(ws_count) = 'USUARIO_ANOTACAO' then
					if nvl(fun.ret_var('ANOT_HABILITA'),'N') = 'S' then 
						ws_valor := fun.getprop(ws_par_sumary,'USUARIO_ANOTACAO'); 
						ws_desc  :=  ws_valor; 
						if ws_desc = 'DWU' then 
							ws_desc := 'TODOS'; 
						end if; 	
						htp.p('<a class="script" onclick="var ele = this.nextElementSibling,valor  = ele.title, valor2 = ''''; if ((''|''+valor+''|'').indexOf(''|NENHUM|'') != -1 ){  valor = ''NENHUM'';  valor2 = ''NENHUM'';} else if ((''|''+valor+''|'').indexOf(''|DWU|'') != -1 ) {  valor = ''DWU'';  valor2 = ''TODOS'';}'||
														'call(''alter_attrib'', ''prm_objeto='||ws_par_sumary||'&prm_prop=USUARIO_ANOTACAO&prm_value=''+valor+''&prm_usuario='').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); ele.title = valor; if (valor2 != '''') {ele.children[0].innerHTML = valor2}} else { alerta(''feed-fixo'', TR_ER); } });"></a>');
						fcl.fakeoption('usuario-anotacao', 'Selecione Usu&aacute;rios.', ws_valor, 'lista-usuarios-grupos-prop', 'N', 'S', prm_desc => ws_desc );
					end if; 
				else
					
					if ws_rotulo(ws_count) = 'Ordem' and ws_admin = 'A' then
						begin
							select propriedade into ws_valor from object_attrib where cd_prop = 'ORDEM' and owner = 'DWU' and cd_object = ws_par_sumary;
							fcl.inputp( ws_tipo(ws_count), ws_count, nvl(ws_valor, ws_prop(ws_count)), trim(ws_par_sumary), ws_sufixo(ws_count), ws_cd_prop(ws_count), ws_script(ws_count), ws_list(ws_count));
							htp.p('<input style="cursor: pointer; font-size: 11px; width: 60px; position: absolute; right: 205px;" type="button" value="DEFAULT" onclick="if(confirm(''Essa op&ccedil;&atilde;o vai alterar a ordem deste objeto em todos os usu&aacute;rios para o valor digitado, deseja prosseguir?'')){ ajax(''fly'', ''alter_ordem_geral'', ''prm_valor=''+encodeURIComponent(this.previousElementSibling.value)+''&prm_objeto='||ws_par_sumary||'''); }"/>');
						exception when others then
							fcl.inputp( ws_tipo(ws_count), ws_count, ws_prop(ws_count), trim(ws_par_sumary), ws_sufixo(ws_count), ws_cd_prop(ws_count), ws_script(ws_count), ws_list(ws_count));
							htp.p('<input style="cursor: pointer; font-size: 11px; width: 60px; position: absolute; right: 205px;" type="button" value="DEFAULT" onclick="if(confirm(''Essa op&ccedil;&atilde;o vai alterar a ordem deste objeto em todos os usu&aacute;rios para o valor digitado, deseja prosseguir?'')){ ajax(''fly'', ''alter_ordem_geral'', ''prm_valor=''+encodeURIComponent(this.previousElementSibling.value)+''&prm_objeto='||ws_par_sumary||'''); }"/>');
						
						end;
					else
						fcl.inputp( ws_tipo(ws_count), ws_count, ws_prop(ws_count), trim(ws_par_sumary), ws_sufixo(ws_count), ws_cd_prop(ws_count), ws_script(ws_count), ws_list(ws_count));
					end if;

				end if;
				
				htp.p('</span>');
				
				htp.p('</li>');
		
			end if;

		exception when others then
			htp.p('');
		end;

	end loop;


	htp.p('</div>');
	
	fcl.closer_menu;
	
exception 
	when ws_nouser then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
end av_prop;

procedure update_attrib (   prm_valorU   varchar2,
							prm_propU    varchar2,
							prm_objetoU  varchar2,
							prm_usuarioU varchar2,
							prm_screenU  varchar2 ) as
begin 

	update object_attrib set propriedade = prm_valorU 
	where  cd_prop   = prm_propU 
	and    cd_object = prm_objetoU 
	and    owner     = prm_usuarioU
	and    screen    = prm_screenU;
		
	if sql%notfound then
		insert into object_attrib (owner, navegador, screen, cd_object, cd_prop, propriedade) 
		values(prm_usuarioU, 'DEFAULT', prm_screenU, prm_objetoU, prm_propU, prm_valorU);
	end if;
	commit;

end update_attrib;


procedure alter_attrib ( prm_objeto  varchar2 default null,
						prm_prop    varchar2 default null,
						prm_value   varchar2 default null,
						prm_usuario varchar2 default null,
						prm_screen  varchar2 default null ) as

	ws_count   number;
	ws_valor   varchar2(800);
	ws_screen  varchar2(100);
	ws_objeto  varchar2(200); 
	ws_drill   varchar2(1); 
	ws_admin   varchar2(10);
	ws_tp_objeto varchar(100);

begin

	ws_valor := fun.converte(prm_value);
	if prm_prop = 'ORDEM' then  -- propriedades controladas por TELA 
		ws_screen := nvl(prm_screen,'DEFAULT');
	else 
		ws_screen := 'DEFAULT'; 	
	end if; 	

	select nvl(min(tp_objeto),'N/A') into ws_tp_objeto
	from objetos
	where cd_objeto = prm_objeto;

	if prm_prop in ('ALTURA', 'LARGURA') and ws_tp_objeto = 'BROWSER' then
	
		if ws_valor <> 'N/A' then
			update_attrib(ws_valor, prm_prop, prm_objeto, nvl(prm_usuario, 'DWU'), ws_screen);
		else
			delete object_attrib  
			where cd_prop   = prm_prop 
			and cd_object = prm_objeto 
			and owner     = nvl(prm_usuario, owner)
			and screen    = ws_screen;
		end if;
		
	end if;

	if ws_valor <> 'N/A' then
		update_attrib(ws_valor, prm_prop, prm_objeto, nvl(prm_usuario, 'DWU'), ws_screen);
	else
		delete object_attrib  
		where cd_prop   = prm_prop 
		and cd_object = prm_objeto 
		and owner     = nvl(prm_usuario, owner)
		and screen    = ws_screen;
	end if;

	commit;

end alter_attrib;


procedure get_par ( ws_par_sumary varchar2 default null,
					ws_type varchar2 default 'NOSUB' ) as

	cursor crs_attrib is
		select	cd_padrao,
			nm_padrao,
			tp_padrao,
			cd_ligacao,
		(select nvl(conteudo,'') from PARAMETRO_USUARIO where cd_usuario = nvl(gbl.getUsuario,'DWU') and PARAMETRO_USUARIO.cd_padrao=PARAMETRO_PADRAO.cd_padrao) as conteudo
		from PARAMETRO_PADRAO where status = 'A' order by ordem;
	ws_attrib	crs_attrib%rowtype;

	ws_count			number;
	ws_mascara			varchar2(30);
	ws_padrao           varchar2(80) := 'PORTUGUESE';

	ws_cd_padrao			DBMS_SQL.VARCHAR2_TABLE;
	ws_nm_padrao			DBMS_SQL.VARCHAR2_TABLE;
	ws_tp_padrao			DBMS_SQL.VARCHAR2_TABLE;
	ws_cd_ligacao			DBMS_SQL.VARCHAR2_TABLE;
	ws_conteudo				DBMS_SQL.VARCHAR2_TABLE;

begin
	/*fcl.refresh_Session;*/
	ws_count := 0;

	open crs_attrib;
	loop
		fetch crs_attrib into ws_attrib;
			exit when crs_attrib%notfound;

		ws_count := ws_count + 1;
		ws_cd_padrao(ws_count)	:= ws_attrib.cd_padrao;
		ws_nm_padrao(ws_count)	:= ws_attrib.nm_padrao;
		ws_tp_padrao(ws_count)	:= ws_attrib.tp_padrao;
		ws_cd_ligacao(ws_count)	:= ws_attrib.cd_ligacao;
		ws_conteudo(ws_count)	:= ws_attrib.conteudo;

	end loop;
	close crs_attrib;

	begin
		select CONTEUDO into ws_padrao
		from   PARAMETRO_USUARIO
		where  cd_usuario = gbl.getUsuario and
			cd_padrao='CD_LINGUAGEM';
	exception
		when others then
			ws_padrao := 'PORTUGUESE';
	end;

	htp.formOpen( cattributes => ' name="pontoa" id="saveap" ', ctarget => '', curl => ''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.save_par', cmethod => 'post');
	if  ws_type <> 'NOSUB' then
		htp.p( '<input type="hidden" name="ws_type"  id="'||'xd_ws_type" value="SUBMIT" >' );
	end if;
	ws_count := 0;
	loop
		ws_count := ws_count + 1;
		if  ws_count > ws_cd_padrao.COUNT then
			exit;
		end if;
		htp.p( '<input type="hidden" class="array_nomes"  id="'||'xd_'||ws_cd_padrao(ws_count)||ws_count||'" value="'||ws_cd_padrao(ws_count)||'" >' );
		htp.p( '<input type="hidden" class="array_transf" id="'||'id_'||ws_cd_padrao(ws_count)||ws_count||'" value="'||ws_conteudo(ws_count)||'" >' );
	end loop;
	htp.formClose;

	htp.p('<div class="itens" data-obj="'||ws_par_sumary||'" data-save="false" style="font-size: 13px;" onmouseleave="if(event.relatedTarget != null){ var screen = document.getElementById(''current_screen'').value; var transf = document.getElementsByClassName(''array_transf''); var nomes = document.getElementsByClassName(''array_nomes''); var x = ''''; for(i=0;i<transf.length;i++){ x = x+''x=''+encodeURIComponent(transf[i].value)+''&''; } var y = ''''; for(i=0;i<nomes.length;i++){ y = y+''y=''+nomes[i].value+''&''; } y = y.slice(0, -1); x = x.slice(0, -1); ajax(''fly'', ''save_par'', y+''&''+x, '''', ''false''); carrega(''ajscreen?prm_screen=''+screen); alerta(''feed-fixo'', TR_AL); ajax(''fly'', ''js_log'', ''prm_msg=''+encodeURIComponent(x)+''&prm_url=&prm_line=&prm_tipo=PARAMETRO'', false); }">');

	ws_count := 0;

	htp.p('<h2 class="fixed">Entrada de parâmetros</h2>');

	htp.p('<ul class="form">');

	loop
		ws_count := ws_count + 1;
		if  ws_count > ws_cd_padrao.COUNT then
			exit;
		end if;

		htp.p('<li data-hint="'||fun.utranslate('NM_PADRAO', 'PARAMETRO_PADRAO', ws_nm_padrao(ws_count), ws_padrao)||'">');
			fcl.inputp( ws_tp_padrao(ws_count), ws_count, ws_conteudo(ws_count), 'NO', '', ws_cd_padrao(ws_count), rtrim(ws_cd_ligacao(ws_count)), '');
		htp.p('</li>');
	end loop;

	htp.p('</ul>');

	htp.p('</div>');

	exception when others then
	htp.p(sqlerrm);

end get_par;

--!!
procedure get_float  ( prm_screen varchar2 default null ) as

	cursor crs_objetos (prm_tipo varchar2) is
	select cd_objeto, nm_objeto
	from objetos t1
	left join parametro_padrao t2 on t2.cd_padrao = t1.cd_objeto
	left join object_attrib t3 on cd_object = t1.cd_objeto and cd_prop = 'PRIORIDADE' 
	where tp_objeto = prm_tipo and 
	t1.cd_objeto in (select object_id from object_location where screen = prm_screen)
	order by t3.propriedade, t2.ordem;
	

	ws_objeto crs_objetos%rowtype;

	ws_count	 number;
	ws_min       number := 1;
	ws_mascara	 varchar2(30);
	ws_codigo    varchar2(300);
	ws_descricao varchar2(600);
	ws_selected  number;
	ws_cursor	 integer;
	ws_linhas	 integer;
	ws_par_emp	 varchar2(900);
	ws_sql		 varchar2(32000);
	ws_check     varchar2(250);
	ws_limitador varchar2(2000);
	ws_display   varchar2(40);
	ws_multiple  varchar2(40);
	ws_float     varchar2(40);
	ws_order     varchar2(40);
	ws_padrao    varchar2(40);
	ws_desc      varchar2(200);
	ws_tipo      varchar2(40);
	ws_ligacao   varchar2(40);
	ws_ordem     varchar2(10);
	ws_conteudo  varchar2(32000);
	ws_cont_aux  varchar2(32000);
	ws_cont_desc varchar2(32000);
	ws_desc_aux  varchar2(32000); 
	ws_formato   varchar2(80);
	ws_user      varchar2(10) := '';
	ws_exist     number;
	ws_multi     varchar2(20) := 'S';
	ws_usuario   varchar2(80);
	ws_admin     varchar2(80);
	ws_linguagem varchar2(80) := 'PORTUGUESE';
	ws_propMask	 varchar2(200);
	WS_ESCOLHA   varchar2(200);
	ws_qt_desc   integer; 
	ws_lim_itens integer;  
	ws_class_adic varchar2(200); 
	ws_prop_vazio varchar2(10); 

	ws_nouser    exception;

begin

	ws_usuario  := gbl.getUsuario;
	ws_admin    := nvl(gbl.getNivel, 'N');

	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if;

	/*if ws_admin = 'A' then
		ws_usuario := 'DWU';
	end if;*/

	/*begin
		select CONTEUDO into ws_linguagem
		from   PARAMETRO_USUARIO
		where  cd_usuario = ws_usuario and
			cd_padrao='CD_LINGUAGEM';
	exception
		when others then
			ws_linguagem := 'PORTUGUESE';
	end;*/

	ws_linguagem := gbl.getLang;

	ws_selected := 0;

	htp.p('<div class="itens" id="get_float" data-alterado="F">');

		htp.p('<h2 style="display: none !important;">'||fun.lang('FLOAT')||'</h2>');

		select count(*) into ws_exist from objetos where tp_objeto = 'FLOAT_PAR' and cd_objeto in (select object_id from object_location where screen = prm_screen);

		/* verificar depois aqui */

		if  ws_admin <> 'A' then
			ws_user := 'user';
		end if;

		--<svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 477.389 477.389" style="enable-background:new 0 0 477.389 477.389;" xml:space="preserve"> <g> <g> <path d="M451.209,68.647c-16.787-16.799-39.564-26.234-63.312-26.226v0c-23.739-0.056-46.516,9.376-63.266,26.197L209.056,184.194 c-22.867,22.903-31.609,56.356-22.869,87.518c2.559,9.072,11.988,14.352,21.06,11.793c9.072-2.559,14.352-11.988,11.793-21.06 c-5.388-19.271,0.018-39.95,14.148-54.118L348.763,92.768c21.608-21.613,56.646-21.617,78.259-0.008 c21.613,21.608,21.617,56.646,0.009,78.259L311.456,286.594c-7.574,7.584-17.193,12.797-27.682,15.002 c-9.228,1.921-15.151,10.959-13.23,20.187c1.652,7.935,8.657,13.613,16.762,13.588c1.193,0.001,2.383-0.125,3.55-0.375 c16.951-3.575,32.494-12.007,44.732-24.269l115.576-115.558C486.114,160.243,486.134,103.598,451.209,68.647z"/> </g> </g> <g> <g> <path d="M290.702,206.142c-2.559-9.072-11.988-14.352-21.06-11.793s-14.352,11.988-11.793,21.06 c5.388,19.271-0.018,39.95-14.148,54.118L128.125,385.103c-21.608,21.613-56.646,21.617-78.259,0.008 c-21.613-21.608-21.617-56.646-0.009-78.259l115.576-115.593c7.562-7.582,17.17-12.795,27.648-15.002 c9.243-1.849,15.237-10.84,13.388-20.082s-10.84-15.237-20.082-13.388c-0.113,0.023-0.225,0.046-0.337,0.071 c-16.954,3.579-32.502,12.011-44.749,24.269L25.725,282.703c-34.676,35.211-34.242,91.865,0.969,126.541 c34.827,34.297,90.731,34.301,125.563,0.008l115.575-115.593C290.7,270.756,299.442,237.303,290.702,206.142z"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>

		if ws_exist > 0 then
			htp.p('<ul data-hint="'||fun.lang('PAR&Acirc;METROS')||'" class="form float_list '||ws_user||'" id="form-parametro" >');
		else
			htp.p('<ul class="form float_list '||ws_user||'" id="form-parametro">');
		end if;

			open crs_objetos('FLOAT_PAR');
				loop
					fetch crs_objetos into ws_objeto;
					exit when crs_objetos%notfound;
					
					select cd_padrao, nm_padrao, tp_padrao, cd_ligacao, ordem,
					(select nvl(conteudo,'') from PARAMETRO_USUARIO where cd_usuario = ws_usuario and PARAMETRO_USUARIO.cd_padrao=PARAMETRO_PADRAO.cd_padrao and rownum = 1) as conteudo
					into ws_padrao, ws_desc, ws_tipo, ws_ligacao, ws_ordem, ws_conteudo
					from PARAMETRO_PADRAO
					where cd_padrao = ws_objeto.cd_objeto order by nm_padrao asc;

					htp.p('<li title="'||ws_objeto.cd_objeto||'" data-hint="'||fun.utranslate('NM_PADRAO', 'PARAMETRO_PADRAO', ws_desc, ws_linguagem)||'">');

					ws_prop_vazio := nvl(fun.getprop(trim(replace(ws_objeto.cd_objeto, 'padrao_', '')), 'VAZIO'),'S'); 
					if ws_prop_vazio = 'S' then
						ws_min := 0;
					else 
						ws_min := 1; 
					end if;
					ws_lim_itens := null; 
					begin 
						ws_lim_itens := fun.getprop(replace(ws_objeto.cd_objeto, 'padrao_', ''), 'LIMITE_ITENS');
					exception when others then 	
						null;
					end; 	

					ws_conteudo := nvl(ws_conteudo,nvl(fun.getprop(ws_objeto.cd_objeto,'VALOR_DEFAULT'),''));

					if fun.getprop(ws_objeto.cd_objeto, 'MULTI') = 'S' /*and ws_padrao <> 'DATA'*/ then -- Verificar essa condição, porque atualmente FLOAT_PAR não aceita multipla seleção 

						htp.p('<input readonly type="hidden" id="visao_'||ws_objeto.cd_objeto||'" title="'||ws_ligacao||'" value="'||ws_ligacao||'">');
						htp.p('<input readonly type="text" class="float_title"  title="'||ws_padrao||'" value="'||fun.utranslate('NM_PADRAO', 'PARAMETRO_PADRAO', ws_desc, ws_linguagem)||'">');
						
						htp.p('<a class="script" onclick="saveFloat(this.nextElementSibling.title, '''||ws_objeto.cd_objeto||''');"></a>');

						ws_class_adic := ''; 
						if ws_conteudo like '%$[NOT]%' then 
							ws_class_adic := ' reverse ';
						end if; 		

						IF FUN.UTRANSLATE('NM_PADRAO', 'PARAMETRO_PADRAO', WS_DESC, WS_LINGUAGEM) <> WS_OBJETO.CD_OBJETO THEN
							FCL.FAKEOPTION('padrao_'||WS_OBJETO.CD_OBJETO, '', WS_CONTEUDO, 'lista-padroes-filtros', 'N', 'S', 'visao_'||WS_OBJETO.CD_OBJETO, FUN.UTRANSLATE('NM_PADRAO', 'PARAMETRO_PADRAO', WS_DESC, WS_LINGUAGEM)||' - '||WS_OBJETO.CD_OBJETO, WS_CONTEUDO, 'true', PRM_MIN => WS_MIN, PRM_LIMITE => ws_lim_itens, prm_class_adic => ws_class_adic);
						ELSE
							FCL.FAKEOPTION('padrao_'||WS_OBJETO.CD_OBJETO, '', WS_CONTEUDO, 'lista-padroes-filtros', 'N', 'S', 'visao_'||WS_OBJETO.CD_OBJETO, WS_OBJETO.CD_OBJETO, WS_CONTEUDO, 'true', PRM_MIN => WS_MIN, PRM_LIMITE => ws_lim_itens, prm_class_adic => ws_class_adic);
						END IF;

						if ws_admin = 'A' then
							fcl.button_lixo('dl_obj','prm_tela|prm_cod', prm_screen||'|'||ws_padrao, prm_objeto=> ws_objeto.cd_objeto, prm_tag => 'a');						
						else
							htp.p('<a class="remove" style="display: none;" title="Fechar">X</a>');
						end if;

					else

						/* testar input de ano, calendario, inteiro */
						case ws_tipo 
						
							when 'TEXTO' then
								ws_propMask := fun.getprop(ws_objeto.cd_objeto,'MASCARA');
								htp.p('<input class="float_title" readonly="" type="text" title="'||ws_objeto.cd_objeto||'" value="'||ws_objeto.nm_objeto||'">');
								
								IF nvl(ws_propMask,'N/A')<>'N/A' THEN
									htp.p('<input placeholder="'||(replace(replace(upper(ws_propMask), 'G', '.'), 'D', ','))||'" oninput=" this.value = VMasker.toPattern(this.value, '''||replace(replace(upper(ws_propMask), 'G', '.'), 'D', ',')||''')" onblur="saveFloat(this.value, '''||ws_objeto.cd_objeto||''');" type="text" value="'||ws_conteudo||'">');
								ELSE
									htp.p('<input placeholder="'||ws_propMask||'" onblur="saveFloat(this.value, '''||ws_objeto.cd_objeto||''');" type="text" value="'||ws_conteudo||'">');
								END IF;

							when 'DATA' then  -- Data com calendário 
								-- Converte para português porque o Calendar está em português e a data no banco está em inglês  
								ws_conteudo := replace(replace(replace(replace(replace(replace(replace(InitCap(ws_conteudo),'-Feb-','-Fev-'),'-Apr-','-Abr-'),'-May-','-Mai-'),'-Aug-','-Ago-'),'-Sep-','-Set-'),'-Oct-','-Out-'),'-Dec-','-Dez-');

								htp.p('<input class="float_title" readonly="" type="text" title="'||ws_objeto.cd_objeto||'" value="'||ws_objeto.nm_objeto||'">');
								if owa_util.get_cgi_env('HTTP_USER_AGENT') like '%iPhone%'  then
									htp.p('<input readonly="readonly" style="font-size: 18px;" type="text" data-vazio="'||ws_prop_vazio||'" data-tipofloat="PAR" id="data_id_'||ws_objeto.cd_objeto||'" onfocus="calendar.set(this.id);" ontouchend="this.blur();" value="'||ws_conteudo||'" />');
								else
									htp.p('<input readonly="readonly" type="text" data-vazio="'||ws_prop_vazio||'" data-tipofloat="PAR" id="data_id_'||ws_objeto.cd_objeto||'" onfocus="calendar.set(this.id);" ontouchend="this.blur();" value="'||ws_conteudo||'" />');
								end if;
							when 'DATA2' then -- Data sem calendário 
								htp.p('<input class="float_title" readonly="" type="text" title="'||ws_objeto.cd_objeto||'" value="'||ws_objeto.nm_objeto||'">');
								htp.p('<input onblur="saveFloat(this.value, '''||ws_objeto.cd_objeto||''');" placeholder="DD/MM/YY" type="text" id="data_'||'id_'||ws_objeto.cd_objeto||'" oninput="this.value = VMasker.toPattern(this.value, ''99/99/99'');" value="'||ws_conteudo||'" />');
							else
								htp.p('<input readonly type="hidden" id="visao_'||ws_objeto.cd_objeto||'" title="'||ws_ligacao||'" value="'||ws_ligacao||'">');
								htp.p('<input readonly type="text" class="float_title" title="'||ws_padrao||'" value="'||fun.utranslate('NM_PADRAO', 'PARAMETRO_PADRAO', ws_desc, ws_linguagem)||'">');
								
								htp.p('<a class="script" onclick="saveFloat(this.nextElementSibling.title, '''||ws_objeto.cd_objeto||''');"></a>');
								
								ws_formato := fun.getprop(ws_objeto.cd_objeto, 'FORMATO');

								for i in(select column_value from table(fun.vpipe(ws_conteudo))) loop
									if ws_formato = '1' or i.column_value = fun.cdesc(i.column_value, ws_ligacao) then
										ws_cont_desc := ws_cont_desc||', '||i.column_value;
									elsif ws_formato = '2' then
										ws_cont_desc := ws_cont_desc||', '||fun.cdesc(i.column_value, ws_ligacao);
									else
										ws_cont_desc := ws_cont_desc||', '||i.column_value||' - '||fun.cdesc(i.column_value, ws_ligacao);
									end if;
								end loop;

								ws_class_adic := ''; 
								if ws_conteudo like '%$[NOT]%' then 
									ws_class_adic := ' reverse ';
								end if; 		
								
								
								/*****************
								ws_cont_desc := substr(trim(ws_cont_desc), 2, 999);
							
								if fun.cdesc(ws_conteudo, ws_ligacao) <> ws_conteudo then

									-- mostrar somente código, descrição ou ambos 
									if ws_formato = 'CD' then
										fcl.fakeoption('padrao_'||ws_objeto.cd_objeto, '', ws_conteudo, 'lista-padroes', 'S', 'N', 'visao_'||ws_objeto.cd_objeto, '', ws_conteudo, prm_desc => ws_cont_desc, prm_min => ws_min, prm_limite => ws_lim_itens);
									elsif ws_formato = 'DS' then
										fcl.fakeoption('padrao_'||ws_objeto.cd_objeto, '', fun.cdesc(ws_conteudo, ws_ligacao), 'lista-padroes', 'S', 'N', 'visao_'||ws_objeto.cd_objeto, '', ws_conteudo, prm_desc => ws_cont_desc, prm_min => ws_min, prm_limite => ws_lim_itens);
									else
										fcl.fakeoption('padrao_'||ws_objeto.cd_objeto, '', ws_conteudo||' - '||fun.cdesc(ws_conteudo, ws_ligacao), 'lista-padroes', 'S', 'N', 'visao_'||ws_objeto.cd_objeto, '', ws_conteudo, prm_desc => ws_cont_desc, prm_min => ws_min, prm_limite => ws_lim_itens);
									end if;

								else
									fcl.fakeoption('padrao_'||ws_objeto.cd_objeto, '', ws_conteudo, 'lista-padroes', 'S', 'N', 'visao_'||ws_objeto.cd_objeto, '', ws_conteudo, prm_min => ws_min, prm_limite => ws_lim_itens);
								end if;
								*****************/ 
								ws_cont_desc := substr(trim(ws_cont_desc), 2, 999);
								ws_cont_aux  := ws_conteudo;

								if fun.cdesc(ws_conteudo, ws_ligacao) <> ws_conteudo then
									if    ws_formato = 'CD' then 	ws_cont_aux := ws_conteudo; 
									elsif ws_formato = 'DS' then    ws_cont_aux := fun.cdesc(ws_conteudo, ws_ligacao);
									else 							ws_cont_aux := ws_conteudo||' - '||fun.cdesc(ws_conteudo, ws_ligacao);
									end if;
								end if;

								fcl.fakeoption('padrao_'||ws_objeto.cd_objeto, '', ws_cont_aux, 'lista-padroes-filtros', 'S', 'N',      'visao_'||ws_objeto.cd_objeto, '', ws_conteudo, prm_desc => ws_cont_desc, prm_min => ws_min, prm_limite => ws_lim_itens, prm_class_adic => ws_class_adic);

						end case;

						ws_cont_desc := '';
						
						if ws_admin = 'A' then
							htp.p('<a class="propriedades" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||ws_padrao||'&prm_screen=''+tela);"></a>');
							fcl.button_lixo('dl_obj','prm_tela|prm_cod', prm_screen||'|'||ws_padrao , prm_objeto=> ws_objeto.cd_objeto, prm_tag => 'a');							
						else
							htp.p('<a class="remove" style="display: none;" title="Fechar">X</a>');
						end if;
						
					end if;

					if nvl(fun.getprop(ws_padrao, 'ENCADEADO'), 'N/A') <> 'N/A' then
						htp.p('<a class="chain" title="'||fun.lang('Encadeado com o float')||' '||fun.getprop(ws_padrao, 'ENCADEADO')||'" style="background-image: url('''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download?arquivo=link.svg''); background-size: 18px; position: relative; height: 18px; width: 18px; transform: rotate(45deg); margin: 0 4px; cursor: default;"></a>');
					end if;

					htp.p('</li>');

				end loop;
			close crs_objetos;

		htp.p('</ul>');

		select count(*) into ws_exist from objetos where tp_objeto = 'FLOAT_FILTER' and cd_objeto in (select object_id from object_location where screen = prm_screen);
		
		/* verificar depois aqui */
		if ws_exist > 0 then
			htp.p('<ul data-hint="'||fun.lang('FILTROS')||'" class="form float_list '||ws_user||'" id="form-filtro">');
		else
			htp.p('<ul class="form float_list '||ws_user||'" id="form-filtro">');
		end if;
		
			open crs_objetos('FLOAT_FILTER');
				loop
					fetch crs_objetos into ws_objeto;
					exit when crs_objetos%notfound;

						select cd_padrao, nm_padrao, tp_padrao, cd_ligacao, ordem
						into ws_padrao, ws_desc, ws_tipo, ws_ligacao, ws_ordem
						from PARAMETRO_PADRAO
						where cd_padrao = ws_objeto.cd_objeto order by nm_padrao asc;

						ws_prop_vazio := nvl(fun.getprop(ws_objeto.cd_objeto, 'VAZIO'),'S'); 
						if ws_prop_vazio = 'S' then
							ws_min := 0;
						else 
							ws_min := 1;
						end if;
						ws_lim_itens := null; 
						begin 
							ws_lim_itens := fun.getprop(replace(ws_objeto.cd_objeto, 'padrao_', ''), 'LIMITE_ITENS');
						exception when others then 	
							null;
						end; 	

						begin
							ws_conteudo := '';
							select count(*) into ws_count from float_filter_item where cd_usuario = ws_usuario and cd_coluna = trim(ws_padrao) and screen = prm_screen;
							if ws_count <> 0 then
								-- Alterado para usar o xmlagg, pois o listagg tem limite de 4000 caracteres 
								-- select listagg(conteudo, '|') within group (order by cd_coluna) into ws_conteudo from float_filter_item where cd_usuario = ws_usuario and cd_coluna = trim(ws_padrao) and screen = prm_screen group by cd_coluna;
								select rtrim(xmlagg(xmlelement(e,conteudo,'|').extract('//text()') order by conteudo).getclobval(),'|') into ws_conteudo from float_filter_item where cd_usuario = ws_usuario and cd_coluna = trim(ws_padrao) and screen = prm_screen group by cd_coluna;
							end if;
						exception when others then
							htp.p(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
						end;
					
						htp.p('<li data-hint="'||fun.utranslate('NM_PADRAO', 'PARAMETRO_PADRAO', ws_desc, ws_linguagem)||'" title="'||ws_objeto.cd_objeto||'">');

							htp.p('<input readonly type="hidden" id="visao_'||ws_objeto.cd_objeto||'" title="'||ws_ligacao||'" value="'||ws_ligacao||'">');
							htp.p('<input class="float_title" readonly type="text" title="'||ws_padrao||'" value="'||fun.utranslate('NM_PADRAO', 'PARAMETRO_PADRAO', ws_desc, ws_linguagem)||'">');
							htp.p('<a class="script" onclick="var objlista = this.nextElementSibling;  document.getElementById(''get_float'').setAttribute(''data-alterado'', ''T''); call(''save_float_filter'', ''prm_conteudo=''+encodeURIComponent(this.nextElementSibling.title)+''&prm_coluna='||ws_objeto.cd_objeto||'&prm_screen=''+tela).then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', resposta.split(''|'')[1]); ws_erro_selecao = true; } } ) ;"></a>');
							
							ws_formato := fun.getprop(ws_objeto.cd_objeto, 'FORMATO');
							ws_cont_desc := '';
							ws_qt_desc   := 0; 
							for i in(select column_value from table(fun.vpipe(ws_conteudo))) loop

								if ws_qt_desc <> -1 then  
									ws_qt_desc := ws_qt_desc + 1; 
									if ws_formato = '1' or i.column_value = fun.cdesc(replace(i.column_value, '$[NOT]', ''), ws_ligacao) then
										ws_desc_aux := i.column_value;
									elsif ws_formato = '2' then
										ws_desc_aux := fun.cdesc(replace(i.column_value, '$[NOT]', ''), ws_ligacao);
									else
										ws_desc_aux := replace(i.column_value, '$[NOT]', '')||' - '||fun.cdesc(replace(i.column_value, '$[NOT]', ''), ws_ligacao);
									end if;
									if length(ws_cont_desc||', '||ws_desc_aux) < 32000 then 
										ws_cont_desc := ws_cont_desc||', '||ws_desc_aux;
									else 	
										ws_qt_desc := -1; 
									end if; 	
								end if; 
							end loop;

							begin
								if fun.getprop(ws_objeto.cd_objeto, 'MULTI') <> 'S' then
									ws_multi     := 'N';
								else
									ws_multi     := 'S';
								end if;
							exception when others then
								ws_multi     := 'S';
							end;

							ws_cont_desc := substr(trim(ws_cont_desc), 2, 999);

							/************
							if fun.utranslate('NM_PADRAO', 'PARAMETRO_PADRAO', ws_desc, ws_linguagem) <> ws_objeto.cd_objeto then

								-- mostrar somente código, descrição ou ambos 
								if ws_formato = 'CD' then
									fcl.fakeoption('padrao_'||ws_objeto.cd_objeto, '', ws_conteudo, 'lista-padroes-filtros', 'S', ws_multi, 'visao_'||ws_objeto.cd_objeto, '', ws_objeto.cd_objeto||'|'||prm_screen, ws_cont_desc, prm_reverse => 'true', prm_min => ws_min, prm_limite => ws_lim_itens );
								elsif ws_formato = 'DS' then
									fcl.fakeoption('padrao_'||ws_objeto.cd_objeto, '', ws_conteudo, 'lista-padroes-filtros', 'S', ws_multi, 'visao_'||ws_objeto.cd_objeto, '', ws_objeto.cd_objeto||'|'||prm_screen, ws_cont_desc, prm_reverse => 'true', prm_min => ws_min, prm_limite => ws_lim_itens );
								else
									fcl.fakeoption('padrao_'||ws_objeto.cd_objeto, '', ws_conteudo, 'lista-padroes-filtros', 'S', ws_multi, 'visao_'||ws_objeto.cd_objeto, '', ws_objeto.cd_objeto||'|'||prm_screen, ws_cont_desc, prm_reverse => 'true', prm_min => ws_min, prm_limite => ws_lim_itens );
								end if;
									
							else
								fcl.fakeoption('padrao_'||ws_objeto.cd_objeto, '', ws_conteudo, 'lista-padroes-filtros', 'S', ws_multi, 'visao_'||ws_objeto.cd_objeto, '', ws_objeto.cd_objeto||'|'||prm_screen, ws_cont_desc, prm_reverse => 'true', prm_min => ws_min, prm_limite => ws_lim_itens );
							end if;
							***********************/ 
							
							ws_class_adic := ''; 
							if ws_conteudo like '%$[NOT]%' then 
								ws_class_adic := ' reverse ';
							end if; 		

							if ws_tipo = 'DATA' then

								ws_conteudo := replace(replace(replace(replace(replace(replace(replace(InitCap(ws_conteudo),'-Feb-','-Fev-'),'-Apr-','-Abr-'),'-May-','-Mai-'),'-Aug-','-Ago-'),'-Sep-','-Set-'),'-Oct-','-Out-'),'-Dec-','-Dez-');

								if owa_util.get_cgi_env('HTTP_USER_AGENT') like '%iPhone%'  then
									htp.p('<input readonly="readonly" style="font-size: 18px;" type="text" data-vazio="'||ws_prop_vazio||'" data-tipofloat="FILTER" data-multi="'||ws_multi||'" id="data_id_'||ws_objeto.cd_objeto||'" onfocus="calendar.set(this.id);" ontouchend="this.blur();" value="'||ws_conteudo||'" />');
								else
									htp.p('<input readonly="readonly" type="text" data-vazio="'||ws_prop_vazio||'" data-tipofloat="FILTER" data-multi="'||ws_multi||'" id="data_id_'||ws_objeto.cd_objeto||'" onfocus="calendar.set(this.id);" ontouchend="this.blur();" value="'||ws_conteudo||'" />');
								end if;

							else 
								fcl.fakeoption('padrao_'||ws_objeto.cd_objeto, '', ws_conteudo, 'lista-padroes-filtros', 'S', ws_multi, 'visao_'||ws_objeto.cd_objeto, '', ws_objeto.cd_objeto||'|'||prm_screen, ws_cont_desc, prm_reverse => 'true', prm_min => ws_min, prm_limite => ws_lim_itens, prm_class_adic => ws_class_adic );
							end if;
							
							ws_cont_desc := '';
							
							if ws_admin = 'A' then
								htp.p('<a class="propriedades" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||ws_padrao||'&prm_screen=''+tela);"></a>');
								fcl.button_lixo('dl_obj','prm_cod|prm_tela', ws_padrao||'|'||prm_screen , prm_objeto=> ws_objeto.cd_objeto);
							else
								htp.p('<a style="display: none;" class="remove" id="'||ws_objeto.cd_objeto||'fechar" title="Fechar">X</a>');
							end if;

							if ws_min = 0 then -- Se não for obrigatório pelo menos um item, adiciona a opção limpar filtro
								htp.p('<a class="limpa-filtro" data-padrao="'||ws_padrao||'" data-screen="'||prm_screen||'" data-usuario="'||ws_usuario||'" onclick="limpar_filter('''||ws_padrao||''','''||prm_screen||''','''||ws_usuario||''');" title="Limpar op&ccedil;&otilde;es selecionadas">');
									htp.p('<svg class="limpa-filtro" xmlns="http://www.w3.org/2000/svg" version="1.0" width="512.000000pt" height="512.000000pt" viewBox="0 0 512.000000 512.000000" preserveAspectRatio="xMidYMid meet"><g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)" fill="#000000" stroke="none"><path d="M3445 5109 c-333 -49 -634 -237 -824 -517 -47 -70 -112 -200 -135 -269 l-18 -53 -972 0 c-1084 0 -1043 2 -1112 -67 -20 -20 -43 -52 -52 -72 -20 -48 -20 -138 1 -177 9 -17 303 -422 653 -900 351 -478 651 -891 668 -918 l31 -49 5 -956 5 -956 22 -41 c61 -115 199 -165 304 -111 52 26 596 432 655 489 23 22 55 65 70 96 l29 57 5 705 c5 667 6 707 24 740 10 19 122 177 249 350 127 173 231 316 232 317 0 1 43 -7 95 -17 121 -26 330 -28 446 -5 727 140 1157 884 908 1575 -170 474 -631 795 -1134 789 -52 -1 -122 -5 -155 -10z m390 -318 c482 -127 764 -611 640 -1096 -21 -79 -85 -214 -140 -291 -54 -75 -173 -187 -249 -232 -164 -100 -311 -137 -515 -130 -123 4 -146 8 -239 40 -370 128 -612 460 -612 841 0 106 12 183 42 277 99 309 366 544 686 605 105 20 283 13 387 -14z m-1412 -938 c11 -205 76 -401 191 -578 68 -105 218 -258 318 -325 37 -25 68 -47 68 -50 0 -3 -99 -141 -220 -305 -120 -165 -231 -324 -245 -353 -53 -108 -55 -133 -55 -848 l0 -660 -242 -183 -243 -183 -5 884 c-5 959 -2 893 -60 1008 -12 24 -293 414 -625 866 -332 453 -606 828 -610 834 -4 7 262 10 858 10 l864 0 6 -117z"/><path d="M3260 4342 c-67 -34 -97 -115 -70 -188 6 -15 56 -73 110 -129 l100 -101 -96 -94 c-52 -52 -102 -107 -110 -122 -41 -79 11 -188 101 -208 66 -15 102 4 213 113 l102 101 98 -96 c110 -109 127 -120 187 -120 84 -2 147 61 147 146 0 60 -11 76 -120 189 l-96 97 101 103 c72 72 104 113 111 139 32 117 -81 220 -195 177 -15 -5 -73 -55 -128 -110 l-100 -99 -90 91 c-127 128 -184 152 -265 111z"/></g></svg>');
								htp.p('</a>');	
							end if; 	

							if nvl(fun.getprop(ws_padrao, 'ENCADEADO'), 'N/A') <> 'N/A' then
								htp.p('<a class="chain" title="Encadeado com o float '||fun.getprop(ws_padrao, 'ENCADEADO')||'" style="background-image: url('''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download?arquivo=link.svg''); background-size: 18px; position: relative; height: 18px; width: 18px; transform: rotate(45deg); margin: 0 4px; cursor: default;"></a>');
							end if;

						htp.p('</li>');

				end loop;

			close crs_objetos;

		htp.p('</ul>');
		
	htp.p('</div>');
	
	/*htp.p('<a class="backreload" onclick="this.parentNode.classList.remove(''open''); setTimeout(function(){ shscr(tela); }, 500);">'||fun.lang('FECHAR E RECARREGAR'));
		htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" 	 width="511.63px" height="511.631px" viewBox="0 0 511.63 511.631" style="enable-background:new 0 0 511.63 511.631;" 	 xml:space="preserve"> <g> 	<path d="M496.5,233.842c-30.841-76.706-114.112-115.06-249.823-115.06h-63.953V45.693c0-4.952-1.809-9.235-5.424-12.85 		c-3.617-3.617-7.896-5.426-12.847-5.426c-4.952,0-9.235,1.809-12.85,5.426L5.424,179.021C1.809,182.641,0,186.922,0,191.871 		c0,4.948,1.809,9.229,5.424,12.847L151.604,350.9c3.619,3.613,7.902,5.428,12.85,5.428c4.947,0,9.229-1.814,12.847-5.428 		c3.616-3.614,5.424-7.898,5.424-12.848v-73.094h63.953c18.649,0,35.349,0.568,50.099,1.708c14.749,1.143,29.413,3.189,43.968,6.143 		c14.564,2.95,27.224,6.991,37.979,12.135c10.753,5.144,20.794,11.756,30.122,19.842c9.329,8.094,16.943,17.7,22.847,28.839 		c5.896,11.136,10.513,24.311,13.846,39.539c3.326,15.229,4.997,32.456,4.997,51.675c0,10.466-0.479,22.176-1.428,35.118 		c0,1.137-0.236,3.375-0.715,6.708c-0.473,3.333-0.712,5.852-0.712,7.562c0,2.851,0.808,5.232,2.423,7.136 		c1.622,1.902,3.86,2.851,6.714,2.851c3.046,0,5.708-1.615,7.994-4.853c1.328-1.711,2.561-3.806,3.71-6.283 		c1.143-2.471,2.43-5.325,3.854-8.562c1.431-3.237,2.43-5.513,2.998-6.848c24.17-54.238,36.258-97.158,36.258-128.756 		C511.63,291.039,506.589,259.344,496.5,233.842z"/> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
	htp.p('</a>');*/
	
	fcl.closer_menu;

exception 
	when ws_nouser then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
end get_float;

--!!
procedure get_float_filter  ( prm_screen varchar2 default null ) as

	cursor crs_attrib(prm_objeto varchar2) is
		select cd_padrao, nm_padrao, tp_padrao, cd_ligacao, ordem,
		(select nvl(conteudo,' ') from float_filter_item where cd_usuario = gbl.getUsuario and float_filter_item.cd_coluna=PARAMETRO_PADRAO.cd_padrao and rownum = 1) as conteudo
		from PARAMETRO_PADRAO
		where cd_padrao = prm_objeto order by nm_padrao asc;

	ws_attrib	crs_attrib%rowtype;

	ws_count			number;
	ws_mascara			varchar2(30);

	ws_cd_padrao		DBMS_SQL.VARCHAR2_TABLE;
	ws_nm_padrao		DBMS_SQL.VARCHAR2_TABLE;
	ws_tp_padrao		DBMS_SQL.VARCHAR2_TABLE;
	ws_cd_ligacao		DBMS_SQL.VARCHAR2_TABLE;
	ws_conteudo			DBMS_SQL.VARCHAR2_TABLE;
	ws_cdesc            varchar2(60);

	ws_codigo           varchar2(300);
	ws_descricao        varchar2(600);
	ws_selected         number;
	ws_cursor	 integer;
	ws_linhas	 integer;

	ws_par_emp	 varchar2(900);

	ws_sql		 varchar2(2000);
	ws_check     varchar2(250);
	ws_display   varchar2(40);
	ws_multiple  varchar2(40);
	ws_float     varchar2(40);
	ws_limitador varchar2(2000);
	ws_order     varchar2(40);
	ws_usuario   varchar2(80);
	ws_admin     varchar2(80);
	ws_padrao    varchar2(80) := 'PORTUGUESE';

	ws_nouser    exception;

begin
	
	ws_usuario := gbl.getUsuario;
	ws_admin   := gbl.getNivel;

	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if;

	begin
		select CONTEUDO into ws_padrao
		from   PARAMETRO_USUARIO
		where  cd_usuario = ws_usuario and
			cd_padrao='CD_LINGUAGEM';
	exception
		when others then
			ws_padrao := 'PORTUGUESE';
	end;

	ws_selected := 0;
	ws_count := 0;

	htp.p('<div class="itens" onmouseleave="">');

	htp.p('<h2>'||fun.lang('PARAMETROS')||'</h2>');
	if ws_admin <> 'A' then
		htp.p('<ul class="float_list user">');
	else
		htp.p('<ul class="float_list">');
	end if;

	for a in (select object_id, tipo from (select object_id, (select tp_objeto from objetos where cd_objeto = t1.object_id) as tipo from object_location t1 where screen = prm_screen) where tipo = 'FLOAT_FILTER') loop

		htp.p('<li>');

			open crs_attrib(a.object_id);
			fetch crs_attrib into ws_attrib;
			close crs_attrib;

			case fun.getprop(ws_attrib.cd_padrao, 'ORDEM')
				when 1 then
					ws_order := 'ORDER BY 1 ASC';
				when 2 then
					ws_order := 'ORDER BY 1 DESC';
				when 3 then
					ws_order := 'ORDER BY 2 ASC';
				when 4 then
					ws_order := 'ORDER BY 2 DESC';
				else
					ws_order := '';
			end case;


			if ws_admin = 'A' then
				fcl.button_lixo('dl_obj','prm_cod|prm_tela', ws_attrib.cd_padrao||'|'||prm_screen);
			end if;

			htp.p('<div id="'||a.object_id||'_ds" class="" title="'||a.object_id||'" >'||fun.utranslate('NM_PADRAO', 'PARAMETRO_PADRAO', ws_attrib.nm_padrao, ws_padrao)||'</div>');

			begin
				select nvl(propriedade, 'N/A') into ws_limitador from object_attrib where cd_object = ''||trim(a.object_id)||'' and cd_prop = 'LIMITADORES';
			exception when others then
				ws_limitador := 'N/A';
			end;

			for i in(select nds_cd_codigo, nds_cd_empresa, nds_cd_descricao, nds_tfisica from CODIGO_DESCRICAO where nds_tabela = upper(ws_attrib.cd_ligacao) or nds_tfisica = upper(ws_attrib.cd_ligacao)) loop
				if ws_limitador <> 'N/A' then
					ws_par_emp := ' where '||rtrim(i.nds_cd_codigo)||' in (select column_value from table(fun.vpipe((select propriedade from object_attrib where cd_object = '''||trim(a.object_id)||''' and cd_prop = ''LIMITADORES'' and rownum = 1))))';
				else
					ws_par_emp := '';
				end if;

				ws_sql := 'select '||rtrim(i.nds_cd_codigo)||', '||rtrim(i.nds_cd_descricao)||' from '||nvl(fun.ret_var('OWNER_TABLE_DATA'),'DWU')||'.'||rtrim(i.nds_tfisica)||ws_par_emp||' '||ws_order;

				ws_cursor := dbms_sql.open_cursor;

				dbms_sql.parse(ws_cursor, ws_sql, DBMS_SQL.NATIVE);
				dbms_sql.define_column(ws_cursor, 1, ws_codigo, 300);
				dbms_sql.define_column(ws_cursor, 2, ws_descricao, 600);

				ws_linhas := dbms_sql.execute(ws_cursor);

				select count(*) into ws_count from object_attrib where cd_object = a.object_id and cd_prop = 'MULTI';

				if ws_count > 0 then
					select propriedade into ws_multiple from object_attrib where cd_object = a.object_id and cd_prop = 'MULTI';
					if ws_multiple = 'S' then
						ws_multiple := 'multiple';
					else
						ws_multiple := '';
					end if;
				else
					ws_multiple := 'multiple';
				end if;

				select count(*) into ws_count from object_attrib where cd_object = a.object_id and cd_prop = 'FLOAT';

				if ws_count > 0 then
					select propriedade into ws_float from object_attrib where cd_object = a.object_id and cd_prop = 'FLOAT';
					if ws_float = 'S' then
						ws_float := 'horizontal';
					else
						ws_float := '';
					end if;
				else
					ws_float := '';
				end if;

				htp.p('<select title="'||fun.lang('ctrl para selecionar op&ccedil;&otilde;es deslizando')||'" '||ws_multiple||' class="selector '||ws_float||'">');

				loop
					ws_linhas := dbms_sql.fetch_rows(ws_cursor);
					if  ws_linhas <> 1 then
						exit;
					end if;

					dbms_sql.column_value(ws_cursor, 1, ws_codigo);
					dbms_sql.column_value(ws_cursor, 2, ws_descricao);

					ws_check := 'this.classList.toggle(''selected'');';

					select count(*) into ws_selected from float_filter_item where cd_usuario = ws_usuario and cd_coluna = ws_attrib.cd_padrao and trim(conteudo) = trim(ws_codigo) and screen = prm_screen;

					if ws_selected = 1 then
						htp.p('<option ondblclick="if(this.selected == true){ this.selected = false; }" selected value="'||trim(ws_codigo)||'">'||ws_descricao||'</option>');
					else
						htp.p('<option ondblclick="if(this.selected == true){ this.selected = false; }" value="'||trim(ws_codigo)||'">'||ws_descricao||'</option>');
					end if;

				end loop;
				dbms_sql.close_cursor(ws_cursor);
				htp.p('</select>');
			end loop;

		htp.p('</li>');

	end loop;

	htp.p('</ul>');

exception 
	when ws_nouser then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end get_float_filter;

procedure limpar_float_filter ( prm_filtro	varchar2 default null,
								prm_usuario	varchar2 default null,
								prm_screen  varchar2 default null ) as

	ws_usuario 		varchar2(100);
	ws_count_filtro	number;
	ws_nodata		exception;

begin
	ws_usuario := nvl(prm_usuario,gbl.getusuario);

	if prm_filtro is not null then

		begin

			select count(*) into ws_count_filtro 
			from float_filter_item
			where cd_usuario = ws_usuario
			and screen	  = prm_screen
			and cd_coluna  = prm_filtro;
			
			if ws_count_filtro > 0 then
				delete float_filter_item where cd_usuario = ws_usuario and screen = prm_screen and cd_coluna = prm_filtro;
				commit;
			else
				raise ws_nodata;
			end if;

		end;
		
	else
		delete float_filter_item where cd_usuario = ws_usuario and screen = prm_screen;
		if SQL%ROWCOUNT > 0 then
			commit;
		else
			raise ws_nodata;
		end if;

	end if;

	htp.p('OK');

exception
	when ws_nodata then
		htp.p('Erro');
	when others then
		htp.p(sqlerrm); 

end limpar_float_filter;

/* Edita Parametros */

procedure ch_pwd as

ws_email  varchar2(60) := '';
ws_number varchar2(60) := '';
ws_nome   varchar2(120);
ws_usuario varchar2(80);

cursor crs_linguagens is
select nm_lang
from language
where ativo = 'S';

ws_linguagem crs_linguagens%rowtype;

begin
	/*fcl.refresh_Session;*/

	ws_usuario := gbl.getUsuario;

	select usu_email, usu_completo, usu_number into ws_email, ws_nome, ws_number from usuarios where trim(usu_nome) = ws_usuario;
	/*select  into ws_nome from usuarios where trim(usu_nome) = gbl.getUsuario;
	select usu_twitter into ws_twitter from usuarios where trim(usu_nome) = gbl.getUsuario;
	select  into ws_number from usuarios where trim(usu_nome) = gbl.getUsuario;*/

	htp.p('<div id="smartcard">');


	htp.formOpen( cattributes => ' name="pontoa" id="saveap" ', ctarget => '', curl => ''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.save_pwd', cmethod => 'post');
			htp.p('<ul>');
				htp.p('<li class="readonly"><label>Login:</label><input type="text"  value="'||ws_usuario||'" readonly /></li>');
				htp.p('<li><label>'||fun.lang('Nome completo')||':</label><input id="completo" type="text" value="'||ws_nome||'"/></li>');

				htp.p('<li><label>'||fun.lang('Digite a nova senha')||':</label><input id="senha1" type="password" name="p_senha" value="" maxlength="28" placeholder="'||fun.lang('Digite a nova senha')||'" /></li>');
				--htp.p('<li><label>'||fun.lang('Digite novamente a Senha')||':</label><input type="password" id="senha2" name="p_senha2"  value="" maxlength="28" placeholder="'||fun.lang('repita a senha')||'"/></li>');
				htp.p('<li><label>Email:</label><input type="text" onkeypress="return input(event, ''email'');"  id="email" name="email" value="'||ws_email||'" maxlength="40" placeholder="Email"/></li>');
				htp.p('<li><label>'||fun.lang('Telefone')||':</label><input type="text" id="number" name="number" oninput="this.value = VMasker.toPattern(this.value, ''(99)9999-9999'');" value="'||ws_number||'" maxlength="40" placeholder="'||fun.lang('Telefone')||'"/></li>');
				
				/*htp.p('<li><label>'||fun.lang('Linguagem')||':</label><select id="linguagem">');
				open crs_linguagens;
					loop
						fetch crs_linguagens into ws_linguagem;
						exit when crs_linguagens%notfound;
							htp.p('<option value="'||ws_linguagem.nm_lang||'">'||ws_linguagem.nm_lang||'</option>');
					end loop;
				close crs_linguagens;
				htp.p('</select></li>');
				htp.p('<li><label>'||fun.lang('Tema')||':</label><input list="color-theme" type="color" value=""/>');
				htp.p('<datalist id="color-theme">');
					htp.p('<option value="#065182"/>');
					htp.p('<option value="#555555"/>');
					htp.p('<option value="#AAAAAA"/>');
					htp.p('<option value="#00CC00"/>');
				htp.p('</datalist>');
			htp.p('</ul>');
		htp.formClose;*/
	htp.p('</div>');

end ch_pwd;

/* Lista de Objetos por Tipo */

procedure list_objetos (  prm_tipo      varchar2 default 'CONSULTA',
						prm_screen    varchar2 default null,
						prm_order     varchar2 default '1',
						prm_dir       varchar2 default '1',
						prm_visao     varchar2 default null ) as

	CURSOR CRS_OBJ IS
		SELECT CD_OBJETO, COD, VISAO, NM_OBJETO, CD_GRUPO, NM_GRUPO, TP_OBJETO
		FROM ( 
			SELECT CD_OBJETO, COD, NVL(T3.CD_MICRO_VISAO, 'N/A') AS VISAO, 
			NM_OBJETO, T1.CD_GRUPO, NM_GRUPO,T1.TP_OBJETO
			FROM OBJETOS T1
			LEFT JOIN GRUPOS_FUNCAO T2 ON T2.CD_GRUPO = T1.CD_GRUPO
			LEFT JOIN PONTO_AVALIACAO T3 ON T3.CD_PONTO = T1.CD_OBJETO
			WHERE TRIM(T1.TP_OBJETO) = NVL(TRIM(PRM_TIPO), TRIM(T1.TP_OBJETO))
			ORDER BY
			CASE WHEN PRM_DIR = '1' THEN DECODE(PRM_ORDER, '1', VISAO, '2', NM_OBJETO, '3', T1.CD_GRUPO, VISAO) END ASC,
			CASE WHEN PRM_DIR = '2' THEN DECODE(PRM_ORDER, '1', VISAO, '2', NM_OBJETO, '3', T1.CD_GRUPO, VISAO) END DESC
		)
		WHERE VISAO = NVL(PRM_VISAO, VISAO)
		ORDER BY 
			CASE WHEN PRM_DIR = '1' THEN DECODE(PRM_ORDER, '1', VISAO, '2', NM_OBJETO, '3', CD_GRUPO,'4',NM_GRUPO, VISAO) END ASC,	
			CASE WHEN PRM_DIR = '2' THEN DECODE(PRM_ORDER, '1', VISAO, '2', NM_OBJETO, '3', CD_GRUPO,'4',NM_GRUPO, VISAO) END DESC;

	WS_OBJ		CRS_OBJ%ROWTYPE;

	WS_PADRAO VARCHAR2(80) := 'PORTUGUESE';

BEGIN
	

	BEGIN

		SELECT CONTEUDO 
		  INTO WS_PADRAO
		  FROM PARAMETRO_USUARIO
		 WHERE CD_USUARIO 	= GBL.GETUSUARIO 
		   AND CD_PADRAO	='CD_LINGUAGEM';

	EXCEPTION
		WHEN OTHERS THEN
			WS_PADRAO := 'PORTUGUESE';
	END;

	OPEN CRS_OBJ;
	LOOP
		FETCH CRS_OBJ INTO WS_OBJ;
		EXIT WHEN CRS_OBJ%NOTFOUND;

		HTP.P('<tr>');
			HTP.P('<TD>'||WS_OBJ.VISAO||'</TD>');
			HTP.P('<TD>'||FUN.UTRANSLATE('NM_OBJETO', WS_OBJ.CD_OBJETO, WS_OBJ.NM_OBJETO, WS_PADRAO)||'</TD>');
			HTP.P('<TD>'||WS_OBJ.CD_OBJETO||'</TD>');
			HTP.P('<TD TITLE="'||WS_OBJ.CD_GRUPO||'">'||WS_OBJ.NM_GRUPO||'</TD>');
			
			CASE WS_OBJ.TP_OBJETO
				WHEN 'SCREEN' THEN

					HTP.P('<td></td>');
					HTP.P('<td></td>');
					HTP.P('<td></td>');
					HTP.P('<td colspan=""></td>');

				WHEN 'BROWSER' THEN
					
					HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="titulo(this, ''c''); call_save(''''); carregaPainel(''browser'', '''||WS_OBJ.CD_OBJETO||'|'||WS_OBJ.NM_OBJETO||'''); ajax(''list'', ''browserConfig'', ''prm_microdata='||WS_OBJ.CD_OBJETO||''', false, ''content'', '''', '''', ''BRO''); curtain(''enabled'');">'||FUN.LANG('COLUNAS')||'</a></td>');
					HTP.P('<td></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td></td>');

				WHEN 'PIZZA' THEN

					HTP.P('<td></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Filtros')||'" onclick="titulo(this, ''c''); call_save(''''); telaSup(''objeto'', '''||WS_OBJ.CD_OBJETO||'''); telaSup(''visao'', '''||WS_OBJ.VISAO||'''); carregaPainel(''list_ofiltro'', '''||WS_OBJ.CD_OBJETO||'|'||WS_OBJ.VISAO||''');  carrega(''list_ofiltro?ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_visao='||WS_OBJ.VISAO||'''); curtain(''enabled'');">'||FUN.LANG('FILTRO')||'</a></td>');
					
				WHEN 'ROSCA' THEN

					HTP.P('<td></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Filtros')||'" onclick="titulo(this, ''c''); call_save(''''); telaSup(''objeto'', '''||WS_OBJ.CD_OBJETO||'''); telaSup(''visao'', '''||WS_OBJ.VISAO||'''); carregaPainel(''list_ofiltro'', '''||WS_OBJ.CD_OBJETO||'|'||WS_OBJ.VISAO||'''); carrega(''list_ofiltro?ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_visao='||WS_OBJ.VISAO||'''); curtain(''enabled'');">'||FUN.LANG('FILTRO')||'</a></td>');
				
				WHEN 'LINHAS' THEN

					HTP.P('<td></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Filtros')||'" onclick="titulo(this, ''c''); call_save(''''); telaSup(''objeto'', '''||WS_OBJ.CD_OBJETO||'''); telaSup(''visao'', '''||WS_OBJ.VISAO||'''); carregaPainel(''list_ofiltro'', '''||WS_OBJ.CD_OBJETO||'|'||WS_OBJ.VISAO||'''); carrega(''list_ofiltro?ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_visao='||WS_OBJ.VISAO||'''); curtain(''enabled'');">'||FUN.LANG('FILTRO')||'</a></td>');
				
				WHEN 'BARRAS' THEN
					HTP.P('<td></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Filtros')||'" onclick="titulo(this, ''c''); call_save(''''); telaSup(''objeto'', '''||WS_OBJ.CD_OBJETO||'''); telaSup(''visao'', '''||WS_OBJ.VISAO||'''); carregaPainel(''list_ofiltro'', '''||WS_OBJ.CD_OBJETO||'|'||WS_OBJ.VISAO||'''); carrega(''list_ofiltro?ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_visao='||WS_OBJ.VISAO||'''); curtain(''enabled'');">'||FUN.LANG('FILTRO')||'</a></td>');
				
				WHEN 'COLUNAS' THEN

					HTP.P('<td></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Filtros')||'" onclick="titulo(this, ''c''); call_save(''''); telaSup(''objeto'', '''||WS_OBJ.CD_OBJETO||'''); telaSup(''visao'', '''||WS_OBJ.VISAO||'''); carregaPainel(''list_ofiltro'', '''||WS_OBJ.CD_OBJETO||'|'||WS_OBJ.VISAO||'''); carrega(''list_ofiltro?ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_visao='||WS_OBJ.VISAO||'''); curtain(''enabled'');">'||FUN.LANG('FILTRO')||'</a></td>');
				
				WHEN 'PONTEIRO' THEN

					HTP.P('<td></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Filtros')||'" onclick="titulo(this, ''c''); call_save(''''); telaSup(''objeto'', '''||WS_OBJ.CD_OBJETO||'''); telaSup(''visao'', '''||WS_OBJ.VISAO||'''); carregaPainel(''list_ofiltro'', '''||WS_OBJ.CD_OBJETO||'|'||WS_OBJ.VISAO||'''); carrega(''list_ofiltro?ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_visao='||WS_OBJ.VISAO||'''); curtain(''enabled'');">'||FUN.LANG('FILTRO')||'</a></td>');
				
				WHEN 'IMAGE' THEN

					HTP.P('<td></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
					HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td></td>');
				
				WHEN 'TEXTO' THEN

					HTP.P('<td></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
					HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td></td>');
				
				WHEN 'CALL_LIST' THEN

					HTP.P('<td></td>');
					HTP.P('<td></td>');
					HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_call'', ''prm_object='||WS_OBJ.CD_OBJETO||'&prm_screen=''+document.getElementById(''current_screen'').value); ">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td></td>');
				
				WHEN 'RELATORIO' THEN

					HTP.P('<td></td>');
					HTP.P('<td></td>');
					HTP.P('<td ><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary=''+encodeURIComponent('''||WS_OBJ.CD_OBJETO||'''));">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td></td>');
				
				WHEN 'FLOAT_PAR' THEN

					HTP.P('<td></td>');
					HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
					HTP.P('<td></td>');
					HTP.P('<td></td>');
				
				WHEN 'FLOAT_FILTER' THEN

					HTP.P('<td></td>');					
					HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
					HTP.P('<td></td>');
					HTP.P('<td></td>');
				
				WHEN 'VALOR' THEN

					HTP.P('<td></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary=''+encodeURIComponent('''||WS_OBJ.CD_OBJETO||''')); ">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Filtros')||'" onclick="titulo(this, ''c''); call_save(''''); telaSup(''objeto'', '''||WS_OBJ.CD_OBJETO||'''); telaSup(''visao'', '''||WS_OBJ.VISAO||'''); carregaPainel(''list_ofiltro'', '''||WS_OBJ.CD_OBJETO||'|'||WS_OBJ.VISAO||'''); carrega(''list_ofiltro?ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_visao='||WS_OBJ.VISAO||'''); curtain(''enabled'');">'||FUN.LANG('FILTRO')||'</a></td>');
				
				WHEN 'ICONE' THEN

					HTP.P('<td></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
					HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td></td>');
				
				WHEN 'FILE' THEN

					HTP.P('<td></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
					HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td></td>');
				
				WHEN 'MAPA' THEN

					HTP.P('<td></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
					HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td></td>');
				
				WHEN 'ORGANOGRAMA' THEN

					HTP.P('<td></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
					HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td></td>');
				
				WHEN 'MAPAGEOLOC' THEN

					HTP.P('<td></td>');
					HTP.P('<td><a class="link" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
					HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Filtros')||'" onclick="titulo(this, ''c''); call_save(''''); telaSup(''objeto'', '''||WS_OBJ.CD_OBJETO||'''); telaSup(''visao'', '''||WS_OBJ.VISAO||'''); carregaPainel(''list_ofiltro'', '''||WS_OBJ.CD_OBJETO||'|'||WS_OBJ.VISAO||'''); carrega(''list_ofiltro?ws_par_sumary=''+encodeURIComponent('''||WS_OBJ.CD_OBJETO||''')+''&prm_visao='||WS_OBJ.VISAO||'''); curtain(''enabled'');">'||FUN.LANG('FILTRO')||'</a></td>');					
				
				WHEN 'HEATMAP' THEN

					HTP.P('<td></td>');
					HTP.P('<td colspan=""><a class="link" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
					HTP.P('<td></td>');
					HTP.P('<td></td>');
				
				WHEN 'SCRIPT' THEN

					HTP.P('<td></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
					HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td></td>');
				
				WHEN 'CONSULTA' THEN

					HTP.P('<td><a class="link" title="'||FUN.LANG('Alterar Consulta')||'" onclick="carrega(''consulta?prm_objeto=''+encodeURIComponent('''||WS_OBJ.CD_OBJETO||''')+''&prm_visao='||WS_OBJ.VISAO||'''); carregaPainel(''data_table'', '''||WS_OBJ.VISAO||'|'||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('COLUNAS')||'</a></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary=''+encodeURIComponent('''||WS_OBJ.CD_OBJETO||''')+''&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary=''+encodeURIComponent('''||WS_OBJ.CD_OBJETO||'''));">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Filtros')||'" onclick="titulo(this, ''c''); call_save(''''); telaSup(''objeto'', '''||WS_OBJ.CD_OBJETO||'''); telaSup(''visao'', '''||WS_OBJ.VISAO||'''); carregaPainel(''list_ofiltro'', '''||WS_OBJ.CD_OBJETO||'|'||WS_OBJ.VISAO||'''); carrega(''list_ofiltro?ws_par_sumary=''+encodeURIComponent('''||WS_OBJ.CD_OBJETO||''')+''&prm_visao='||WS_OBJ.VISAO||'''); curtain(''enabled'');">'||FUN.LANG('FILTRO')||'</a></td>');
				
				WHEN 'SANKEY' THEN

					HTP.P('<td></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Filtros')||'" onclick="titulo(this, ''c''); call_save(''''); telaSup(''objeto'', '''||WS_OBJ.CD_OBJETO||'''); telaSup(''visao'', '''||WS_OBJ.VISAO||'''); carregaPainel(''list_ofiltro'', '''||WS_OBJ.CD_OBJETO||'|'||WS_OBJ.VISAO||'''); carrega(''list_ofiltro?ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_visao='||WS_OBJ.VISAO||'''); curtain(''enabled'');">'||FUN.LANG('FILTRO')||'</a></td>');

				WHEN 'SCATTER' THEN

					HTP.P('<td></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Filtros')||'" onclick="titulo(this, ''c''); call_save(''''); telaSup(''objeto'', '''||WS_OBJ.CD_OBJETO||'''); telaSup(''visao'', '''||WS_OBJ.VISAO||'''); carregaPainel(''list_ofiltro'', '''||WS_OBJ.CD_OBJETO||'|'||WS_OBJ.VISAO||'''); carrega(''list_ofiltro?ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_visao='||WS_OBJ.VISAO||'''); curtain(''enabled'');">'||FUN.LANG('FILTRO')||'</a></td>');

				WHEN 'RADAR' THEN

					HTP.P('<td></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Filtros')||'" onclick="titulo(this, ''c''); call_save(''''); telaSup(''objeto'', '''||WS_OBJ.CD_OBJETO||'''); telaSup(''visao'', '''||WS_OBJ.VISAO||'''); carregaPainel(''list_ofiltro'', '''||WS_OBJ.CD_OBJETO||'|'||WS_OBJ.VISAO||'''); carrega(''list_ofiltro?ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_visao='||WS_OBJ.VISAO||'''); curtain(''enabled'');">'||FUN.LANG('FILTRO')||'</a></td>');
				
				WHEN 'CALENDARIO' THEN

					HTP.P('<td></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Filtros')||'" onclick="titulo(this, ''c''); call_save(''''); telaSup(''objeto'', '''||WS_OBJ.CD_OBJETO||'''); telaSup(''visao'', '''||WS_OBJ.VISAO||'''); carregaPainel(''list_ofiltro'', '''||WS_OBJ.CD_OBJETO||'|'||WS_OBJ.VISAO||'''); carrega(''list_ofiltro?ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_visao='||WS_OBJ.VISAO||'''); curtain(''enabled'');">'||FUN.LANG('FILTRO')||'</a></td>');


				ELSE

					HTP.P('<td></td>');						
					HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary=''+encodeURIComponent('''||WS_OBJ.CD_OBJETO||''')+''&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary=''+encodeURIComponent('''||WS_OBJ.CD_OBJETO||'''));">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td></td>');

			END CASE;

			if WS_OBJ.CD_OBJETO = 'SCR_CUSTOMIZACAO' then 
				htp.p('<td><a title="'||fun.lang('Sem permissão')||'" class="noremove">X</a></td>');	
			else	
				HTP.P('<td>');
					FCL.BUTTON_LIXO('dl_object','prm_object', WS_OBJ.CD_OBJETO);
				HTP.P('<td>');
			end if;

		htp.tableRowClose;
	end loop;
	close crs_obj;

	htp.p('</tr>');

end list_objetos;

--!!
procedure list_vpadrao ( prm_order varchar2 default '1',
						prm_dir   varchar2 default '1' ) as

	cursor crs_vpadrao is
	select cd_padrao, nm_padrao, tp_padrao, cd_ligacao, status, ordem,t2.tp_objeto as tp_objeto
      from PARAMETRO_PADRAO t1
      left join  objetos t2 on t1.cd_padrao = t2.cd_objeto
	order by
		case when prm_dir = '1' then decode(prm_order, '1', cd_padrao, '2', nm_padrao, '3', tp_padrao, '4', cd_ligacao, '5', status, '6', ordem,'7', tp_objeto, cd_padrao) end asc,
		case when prm_dir = '2' then decode(prm_order, '1', cd_padrao, '2', nm_padrao, '3', tp_padrao, '4', cd_ligacao, '5', status, '6', ordem,'7', tp_objeto, cd_padrao) end desc;

	ws_vpadrao	crs_vpadrao%rowtype;

	ws_dir 	   number := 1;
	ws_count   number;
	ws_float   varchar2(200);
	ws_padrao  varchar2(80)  := 'PORTUGUESE';
	ws_usuario varchar2(80);

	ws_noacess exception;
	
begin

	ws_usuario := gbl.getUsuario;
	
	if gbl.getNivel <> 'A' or ws_usuario = 'NOUSER' then
		raise ws_noacess;
	end if;
	
	begin
		select CONTEUDO into ws_padrao
		from   PARAMETRO_USUARIO
		where  cd_usuario = ws_usuario and
			cd_padrao='CD_LINGUAGEM';
	exception
		when others then
			ws_padrao := 'PORTUGUESE';
	end;

	/*fcl.refresh_Session;*/
	htp.p('<table class="linha">');
		htp.p('<thead>');
			htp.p('<tr>');
				htp.p('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_vpadrao'', ''prm_order=1&prm_dir=''+dir, false, ''content'');">'||fun.lang('C&Oacute;DIGO')||'</a></th>');
				htp.p('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_vpadrao'', ''prm_order=2&prm_dir=''+dir, false, ''content'');">'||fun.lang('NOME')||'</a></th>');
				htp.p('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_vpadrao'', ''prm_order=3&prm_dir=''+dir, false, ''content'');">'||fun.lang('TIPO')||'</a></th>');
				htp.p('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_vpadrao'', ''prm_order=4&prm_dir=''+dir, false, ''content'');">'||fun.lang('LOV')||'</a></th>');
				htp.p('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_vpadrao'', ''prm_order=5&prm_dir=''+dir, false, ''content'');">STATUS</a></th>');
				htp.p('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_vpadrao'', ''prm_order=6&prm_dir=''+dir, false, ''content'');">'||fun.lang('ORDEM')||'</a></th>');
				htp.p('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_vpadrao'', ''prm_order=7&prm_dir=''+dir, false, ''content'');">'||fun.lang('FLOAT')||'</a></th>');
				htp.p('<th style="width: 10px"></th>');
			htp.p('</tr>');
		htp.p('</thead>');

		if to_number(prm_dir) = 1 then ws_dir := 2; end if;

		htp.p('<tbody id="ajax" data-dir="'||ws_dir||'">');
		open crs_vpadrao;
			loop
				fetch crs_vpadrao into ws_vpadrao;
				exit when crs_vpadrao%notfound;
				htp.p('<tr>');
					htp.p('<td><span class="text lang" id="'||ws_vpadrao.cd_padrao||'_cd"  title="'||ws_vpadrao.cd_padrao||'">'||fun.utranslate('CD_PADRAO', 'PARAMETRO_PADRAO', ws_vpadrao.cd_padrao, ws_padrao)||'</span><a class="fakelang" onclick="fakeLang('''||ws_vpadrao.cd_padrao||'_cd'', ''PARAMETRO_PADRAO|CD_PADRAO|''+this.previousElementSibling.title, ''cd'');">L</a></td>');
					htp.p('<td>');
						htp.p('<input type="text" onblur="call(''alter_padrao'', ''prm_padrao='||ws_vpadrao.cd_padrao||'&prm_campo=nome&prm_valor=''+this.value).then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', '''||fun.lang('Campo alterado com sucesso')||'!''); } else { alerta(''feed-fixo'', '''||fun.lang('Erro ao alterar')||'!''); } });" class="text lang" id="'||ws_vpadrao.cd_padrao||'_nome" title="'||ws_vpadrao.nm_padrao||'" value="'||fun.utranslate('NM_PADRAO', 'PARAMETRO_PADRAO', ws_vpadrao.nm_padrao, ws_padrao)||'" />');
						htp.p('<a class="fakelang" onclick="fakeLang('''||ws_vpadrao.cd_padrao||'_nome'', ''PARAMETRO_PADRAO|NM_PADRAO|''+this.previousElementSibling.title);">L</a>');
					htp.p('</td>');
					
					htp.p('<td>');
					htp.p('<a class="script" onclick="call(''alter_padrao'', ''prm_padrao='||ws_vpadrao.cd_padrao||'&prm_campo=tipo&prm_valor=''+this.nextElementSibling.title).then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', '''||fun.lang('Campo alterado com sucesso')||'!''); } else { alerta(''feed-fixo'', '''||fun.lang('Erro ao alterar')||'!''); } });"></a>');
					--fcl.fakeoption('filtro-condicao-'||ws_counter||'', '', ws_filtro.condicao, 'lista-condicoes', 'N', 'N', '', '', '', fun.dcondicao(ws_filtro.condicao));
					fcl.fakeoption('fake_tipo_'||ws_vpadrao.cd_padrao, fun.vpcondicao(ws_vpadrao.tp_padrao), ws_vpadrao.tp_padrao, 'lista-tipos', 'N', 'N', '', '', '', fun.vpcondicao(ws_vpadrao.tp_padrao));
					htp.p('</td>');
					htp.p('<td>');
						htp.p('<a class="script" onclick="call(''alter_padrao'', ''prm_padrao='||ws_vpadrao.cd_padrao||'&prm_campo=ligacao&prm_valor=''+this.nextElementSibling.title).then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', '''||fun.lang('Campo alterado com sucesso')||'!''); } else { alerta(''feed-fixo'', '''||fun.lang('Erro ao alterar')||'!''); } });"></a>');
						fcl.fakeoption('fake_cdesc_'||ws_vpadrao.cd_padrao, ws_vpadrao.cd_ligacao, ws_vpadrao.cd_ligacao, 'lista-lovs', 'N', 'N', '');
					htp.p('</td>');
					
					htp.p('<td>');
						htp.p('<select onchange="call(''alter_padrao'', ''prm_padrao='||ws_vpadrao.cd_padrao||'&prm_campo=status&prm_valor=''+this.value).then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } }); ">');
							if ws_vpadrao.status = 'A' then
								htp.p('<option value="A" selected="checked">'||fun.lang('Ativo')||'</option>');
								htp.p('<option value="I">'||fun.lang('Inativo')||'</option>');
							else
								htp.p('<option value="A">'||fun.lang('Ativo')||'</option>');
								htp.p('<option value="I" selected="checked">'||fun.lang('Inativo')||'</option>');
							end if;
						htp.p('</select>');
					htp.p('</td>');
					htp.p('<td>');
						htp.p('<select onchange="call(''alter_padrao'', ''prm_padrao='||ws_vpadrao.cd_padrao||'&prm_campo=ordem&prm_valor=''+this.value).then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } });">');
							fcl.numericOptions(9, ws_vpadrao.ordem);
						htp.p('</select>');
					htp.p('</td>');
					
					select count(*) into ws_count from objetos where cd_objeto = ws_vpadrao.cd_padrao and tp_objeto in ('FLOAT_PAR', 'FLOAT_FILTER');
					
					if ws_count > 0 then
						
						select tp_objeto into ws_float from objetos where cd_objeto = ws_vpadrao.cd_padrao and tp_objeto in ('FLOAT_PAR', 'FLOAT_FILTER') and rownum = 1;
						htp.p('<td>');
							htp.p('<select disabled class="readonly">');
								htp.p('<option selected disabled value="'||ws_float||'">'||replace(ws_float, 'FLOAT_', '')||'</option>');
							htp.p('</select>');
						htp.p('</td>');
					else
					
						htp.p('<td>');
						
							htp.p('<select onchange="var dis = this; call(''savegd'', ''p_cd_micro_visao=&p_funcao=G&p_cd_objeto='||ws_vpadrao.cd_padrao||'&p_nm_objeto='||ws_vpadrao.nm_padrao||'&p_atributos=&fakeoption=GERAL&p_tp_objeto=''+this.value+''&p_ds_objeto=&p_cs_colup='').then(function(resposta){ if(!resposta.includes(''FAIL'')){ alerta(''feed-fixo'', TR_CR); dis.setAttribute(''disabled'', ''disabled''); } else { alerta(''feed-fixo'', TR_CR); } });">');
								htp.p('<option selected disabled hidden>'||fun.lang('GERAR FLOAT')||'</option>');
								htp.p('<option value="FLOAT_FILTER">FILTER</option>');
								htp.p('<option value="FLOAT_PAR">PAR</option>');
							htp.p('</select>');
						
							/*htp.p('<td style="white-space: nowrap; width: 6%;"><a class="link" title="'||fun.lang('Criar FloatPar')||'" onclick="call(''savegd'', ''p_cd_micro_visao=&p_funcao=G&p_cd_objeto='||ws_vpadrao.cd_padrao||'&p_nm_objeto='||ws_vpadrao.nm_padrao||'&p_atributos=&fakeoption=GERAL&p_tp_objeto=FLOAT_PAR&p_ds_objeto=&p_cs_colup='').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_CR); } else { alerta(''feed-fixo'', TR_CR); } });">FLOATPAR</a></td>');
							htp.p('<td style="white-space: nowrap; width: 6%;">');
							if ws_vpadrao.cd_ligacao <> 'SEM' then
								htp.p('<a class="link" id="'||ws_vpadrao.cd_padrao||'_floatfilter" title="'||fun.lang('Criar FloatFilter')||'" onclick="call(''savegd'', ''p_cd_micro_visao=&p_funcao=G&p_cd_objeto='||ws_vpadrao.cd_padrao||'&p_nm_objeto='||ws_vpadrao.nm_padrao||'&p_atributos=&fakeoption=GERAL&p_tp_objeto=FLOAT_FILTER&p_ds_objeto=&p_cs_colup='').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_CR); } else { alerta(''feed-fixo'', TR_CR); } });">FLOATFILTER</a></td>');
							else
								htp.p('<a class="invisible" id="'||ws_vpadrao.cd_padrao||'_floatfilter" title="'||fun.lang('Criar FloatFilter')||'" onclick="call(''savegd'', ''p_cd_micro_visao=&p_funcao=G&p_cd_objeto='||ws_vpadrao.cd_padrao||'&p_nm_objeto='||ws_vpadrao.nm_padrao||'&p_atributos=&fakeoption=GERAL&p_tp_objeto=FLOAT_FILTER&p_ds_objeto=&p_cs_colup='').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_CR); } else { alerta(''feed-fixo'', TR_CR); } });">FLOATFILTER</a></td>');
							end if;*/
						
						htp.p('</td>');
					end if;
					htp.p('<td>');
						fcl.button_lixo('dl_vp','ws_par_sumary', ws_vpadrao.cd_padrao);
					htp.p('</td>');
				htp.tableRowClose;
			end loop;
		close crs_vpadrao;
		htp.p('</tbody>');
	htp.tableClose;
exception
	when ws_noacess then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end list_vpadrao;


procedure alter_padrao ( prm_padrao varchar2 default null,
						prm_campo  varchar2 default null,
						prm_valor  varchar2 default null ) as

	ws_count number;
	ws_fail  exception;
	ws_nome varchar2(200);

begin

	case prm_campo
		when 'status' then
			update parametro_padrao set status = prm_valor where cd_padrao = prm_padrao;
		when 'nome' then
			ws_nome := fun.converte(prm_valor);
			fcl.update_prop(prm_padrao, 'nome', ws_nome);
			update parametro_padrao set nm_padrao = ws_nome where cd_padrao = prm_padrao;
		when 'ligacao' then
			update parametro_padrao set cd_ligacao = prm_valor where cd_padrao = prm_padrao;
		when 'tipo' then
			update parametro_padrao set tp_padrao = prm_valor where cd_padrao = prm_padrao;
		when 'ordem' then
			update parametro_padrao set ordem = prm_valor where cd_padrao = prm_padrao;
		else
			htp.p('#alert '||fun.lang('Erro ao atualizar')||'!');
	end case;

	ws_count := SQL%ROWCOUNT;

	if ws_count <> 0 then
		commit;
	else
		raise ws_fail;
	end if;

exception when others then
	htp.p('FAIL'); 
end alter_padrao;

procedure add_padrao( prm_padrao  varchar2 default null,
					prm_nome    varchar2 default null,
					prm_tipo    varchar2 default null,
					prm_ligacao varchar2 default null,
					prm_status  varchar2 default null,
					prm_ordem   number   default 1,
					prm_float   varchar2 default null ) as

	ws_count  		number;
	ws_fail   		exception;
	ws_exist  		exception;
	ws_floatNull 	exception;
	ws_nome   		varchar2(200);
	ws_funcao 		varchar2(10);

begin

	select count(*) into ws_count from objetos where cd_objeto = upper(trim(prm_padrao));

	if ws_count <> 0 then
		raise ws_exist;
	end if;

	if nvl(prm_float, 'N/A') = 'N/A' or prm_float = 'GERAR FLOAT' then
		raise ws_floatNull;
	end if;

	ws_nome := fun.converte(prm_nome);

	select count(*) into ws_count from parametro_padrao where cd_padrao = upper(trim(prm_padrao));
	if ws_count = 0 then

		insert into parametro_padrao values (upper(trim(prm_padrao)), trim(ws_nome), prm_tipo, prm_ligacao, prm_status, prm_ordem);

		ws_count := SQL%ROWCOUNT;

		if ws_count <> 0 then

			commit;

			if nvl(prm_ligacao, 'N/A') <> 'N/A' then
				ws_funcao := 'G';
			end if; 

			if nvl(prm_float, 'N/A') <> 'N/A' or prm_float <> 'GERAR FLOAT' then
				fcl.savegd(p_cd_micro_visao => '', p_funcao => 'G', p_cd_objeto => prm_padrao, p_nm_objeto => prm_nome, p_atributos => '', fakeoption => 'GERAL', p_tp_objeto => prm_float);
			else
				raise ws_floatNull;
			end if; 

			insert into traducao_colunas values ('PARAMETRO_PADRAO', 'CD_PADRAO', fun.ret_var('LANG_SYS'), upper(trim(prm_padrao)), upper(trim(prm_padrao)), 'T', 'N');
			insert into traducao_colunas values ('PARAMETRO_PADRAO', 'NM_PADRAO', fun.ret_var('LANG_SYS'), trim(ws_nome), trim(ws_nome), 'T', 'N');
			commit;

		else
			raise ws_fail;
		end if;

	else
		raise ws_fail;
	end if;

exception
	when ws_exist then
		htp.p('FAIL DUPLICADO '||fun.lang('Padr&atilde;o j&aacute; existe')||'!');
	when ws_floatNull then
		rollback;
		htp.p('FAIL FLOAT '||fun.lang('N&atilde;o foi escolhido o float')||'!');
	when ws_fail then
		htp.p('FAIL');
	when others then
		htp.p('FAIL');
end add_padrao;


procedure list_ofiltro ( ws_par_sumary varchar2 default null,
						prm_visao     varchar2 default null,
						prm_order     varchar2 default '1',
						prm_dir       varchar2 default '1' ) as

	ws_id_custom    varchar2(10) := 'N'; 

	cursor crs_filtro(prm_usuario varchar2, prm_admin varchar2) is
		select cd_coluna, condicao, conteudo, micro_visao, ligacao, st_agrupado, cd_filtro, cd_criado
		from FILTROS
		where (cd_usuario = prm_usuario or prm_admin = 'A'or ( prm_admin='N' and prm_usuario in (select usuario from admin_options where (permissao = 'FILTERS_EX' or permissao = 'FILTERS_ADD') and status ='S')) or (ws_id_custom = 'S' and cd_usuario = 'DWU') ) 
		and cd_objeto = ws_par_sumary 
		and tp_filtro = 'objeto'
		order by
		case when prm_dir = '1' then decode(prm_order, '1', cd_coluna, '2', condicao, '3', conteudo, '4', ligacao, '5', st_agrupado, cd_coluna) end asc,
		case when prm_dir = '2' then decode(prm_order, '1', cd_coluna, '2', condicao, '3', conteudo, '4', ligacao, '5', st_agrupado, cd_coluna) end desc;

	ws_filtro	crs_filtro%rowtype;

	cursor crs_filtrob(prm_usuario varchar2, prm_admin varchar2) is
		select cd_coluna, condicao, conteudo, micro_visao, ligacao, st_agrupado, cd_usuario, decode(cd_usuario,'DWU','TODOS',cd_usuario) nm_usuario, cd_filtro, cd_criado
		from FILTROS
		where (cd_usuario = prm_usuario or prm_admin = 'A') and cd_objeto  = ws_par_sumary  and tp_filtro = 'objeto'
		order by
		case when prm_dir = '1' then decode(prm_order, '1', cd_coluna, '2', condicao, '3', conteudo, '4', ligacao, '5', st_agrupado, cd_coluna) end asc,
		case when prm_dir = '2' then decode(prm_order, '1', cd_coluna, '2', condicao, '3', conteudo, '4', ligacao, '5', st_agrupado, cd_coluna) end desc;

	ws_filtrob	crs_filtrob%rowtype;

	cursor crs_colunas is
		select distinct(cd_coluna), nm_rotulo, '#000000' as color
		from micro_coluna
		where cd_coluna not in (select column_value from table(fun.vpipe((select cs_coluna||'|'||cs_agrupador||'|'||parametros from ponto_avaliacao where cd_ponto = ws_par_sumary))) where length(trim(column_value)) > 0) and
		cd_micro_visao = prm_visao

		union all

		select distinct(cd_coluna), nm_rotulo, '#CC0000' as color
		from micro_coluna
		where cd_coluna in (select column_value from table(fun.vpipe((select cs_coluna||'|'||cs_agrupador||'|'||parametros from ponto_avaliacao where cd_ponto = ws_par_sumary))) where length(trim(column_value)) > 0) and
		cd_micro_visao = prm_visao
		order by nm_rotulo asc;
	ws_colunas crs_colunas%rowtype;

	ws_ligacao		varchar2(200);
	ws_condicao		varchar2(80);
	ws_agrupador	varchar2(20);

	ws_posx			varchar2(80);
	ws_posy			varchar2(80);

	ws_count    	number;
	ws_counter  	number := 0;
	ws_dir      	number := 1;
	ws_tipo     	varchar2(80);
	ws_usuario  	varchar2(80);
	ws_admin    	varchar2(80);

	ws_nouser   	exception;

begin
	/*fcl.refresh_Session;*/

	ws_usuario   := gbl.getUsuario;
	ws_admin     := gbl.getNivel;

	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if;

	select tp_objeto, nvl(id_customizado,'N') into ws_tipo, ws_id_custom 
	  from objetos 
	 where cd_objeto = ws_par_sumary;
 
	htp.p('<a class="script" id="filtro-visao" title="'||prm_visao||'"></a>');

	htp.p('<table class="linha">');
		htp.p('<thead>');
			htp.p('<tr>');
				--if ws_tipo = 'BROWSER' then
					htp.p('<th>'||fun.lang('USU&Aacute;RIO')||'</th>');
				--end if;
				htp.p('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_ofiltro'', ''ws_par_sumary='||ws_par_sumary||'&prm_visao='||prm_visao||'&prm_order=1&prm_dir=''+dir, false, ''content'');">'||fun.lang('COLUNA')||'</a></th>');
				htp.p('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_ofiltro'', ''ws_par_sumary='||ws_par_sumary||'&prm_visao='||prm_visao||'&prm_order=2&prm_dir=''+dir, false, ''content'');">'||fun.lang('CONDI&Ccedil;&Atilde;O')||'</a></th>');
				htp.p('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_ofiltro'', ''ws_par_sumary='||ws_par_sumary||'&prm_visao='||prm_visao||'&prm_order=3&prm_dir=''+dir, false, ''content'');">'||fun.lang('VALOR')||'</a></th>');
				if ws_tipo <> 'BROWSER' then
					htp.p('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_ofiltro'', ''ws_par_sumary='||ws_par_sumary||'&prm_visao='||prm_visao||'&prm_order=4&prm_dir=''+dir, false, ''content'');">'||fun.lang('LIGA&Ccedil;&Atilde;O')||'</a></th>');
					htp.p('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_ofiltro'', ''ws_par_sumary='||ws_par_sumary||'&prm_visao='||prm_visao||'&prm_order=5&prm_dir=''+dir, false, ''content'');">'||fun.lang('AGRUPADO')||'</a></th>');
				end if;
				htp.p('<th></th>');
			htp.p('</tr>');
		htp.p('</thead>');

		if to_number(prm_dir) = 1 then ws_dir := 2; end if;

			htp.p('<tbody id="ajax" data-dir="'||ws_dir||'">');
			if ws_tipo = 'BROWSER' then
				

				open crs_filtrob(ws_usuario, ws_admin);
				loop
					fetch crs_filtrob into ws_filtrob;
					exit when crs_filtrob%notfound;

					ws_counter := ws_counter+1;

					htp.p('<tr>');
						if ws_filtrob.cd_criado = ws_usuario or ws_admin = 'A' then

							if ws_admin = 'A' then
							
								htp.p('<td>');
									htp.p('<a class="script" onclick="call(''edit_filtro'',''prm_key='||ws_filtrob.cd_filtro||'&prm_valor=''+encodeURIComponent(document.getElementById(''filtro-usuario-'||ws_counter||''').title)+''&prm_tipo=USUARIO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
									fcl.fakeoption('filtro-usuario-'||ws_counter, 'Lista de usuarios', ws_filtrob.cd_usuario, 'lista-usuarios', 'N', 'N', '', '', prm_desc => ws_filtrob.nm_usuario);
								htp.p('</td>');
							
							else
							
								htp.p('<td class="readonly"><input type="text" readonly id="filtro-usuario-'||ws_counter||'" data-default="'||ws_filtrob.cd_usuario||'" value="'||ws_filtrob.cd_usuario||'" /></td>');
							
							end if;
						
							
							htp.p('<td class="fake-list" >');
								/*fcl.fakeoption('filtro-coluna-'||ws_counter, '', ws_filtrob.cd_coluna, 'lista-colunas', 'S', 'N', 'filtro-visao', '');*/
								htp.p('<a class="script" onclick="call(''edit_filtro'',''prm_key='||ws_filtrob.cd_filtro||'&prm_valor=''+encodeURIComponent(document.getElementById(''filtro-coluna-'||ws_counter||''').title)+''&prm_tipo=COLUNA'').then(function(resposta){ if(resposta.indexOf(''Erro'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
								fcl.fakeoption('filtro-coluna-'||ws_counter, '', ws_filtrob.cd_coluna, 'lista-coluna', 'N', 'N', 'filtro-visao', '');
							htp.p('</td>');
							
							/*htp.p('<td><select id="filtro-condicao-'||ws_counter||'" data-default="'||ws_filtrob.condicao||'" onchange="filter('''||ws_par_sumary||''', '''', '''||ws_counter||''', ''CONDICAO'', this.id);">');
								fcl.condicoes('selected', ws_filtrob.condicao);
							htp.formSelectClose;
							htp.p('</td>');

							htp.p('<td><input data-default="'||ws_filtrob.conteudo||'" id="filtro-conteudo-'||ws_counter||'" onblur="if(this.value.length > 0){ if(this.value != this.getAttribute(''data-default'')){ filter('''||ws_par_sumary||''', '''', '''||ws_counter||''', ''CONTEUDO'', this.id); this.setAttribute(''data-default'', this.value); }}" onkeyup="checkPar(this.id, '''||ws_filtrob.micro_visao||''');" value="'||ws_filtrob.conteudo||'" /></td>');
							*/
							
							htp.p('<td>');
								htp.p('<a class="script" onclick="call(''edit_filtro'',''prm_key='||ws_filtrob.cd_filtro||'&prm_valor=''+encodeURIComponent(document.getElementById(''filtro-condicao-'||ws_counter||''').title)+''&prm_tipo=CONDICAO'').then(function(resposta){ if(resposta.indexOf(''Erro'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
								fcl.fakeoption('filtro-condicao-'||ws_counter||'', '', ws_filtrob.condicao, 'lista-condicoes', 'N', 'N', '', '', '', fun.dcondicao(ws_filtrob.condicao));
							htp.p('</td>');
							
							
							htp.p('<td>');
								
								htp.p('<a class="script" onclick="call(''edit_filtro'',''prm_key='||ws_filtrob.cd_filtro||'&prm_valor=''+encodeURIComponent(document.getElementById(''filtro-conteudo-'||ws_counter||''').title)+''&prm_tipo=CONTEUDO'').then(function(resposta){ if(resposta.indexOf(''Erro'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
								
								begin
								
									select cd_ligacao,st_agrupador into ws_ligacao,ws_agrupador 
									  from micro_coluna 
									 where cd_coluna 	  = ws_filtrob.cd_coluna 
									   and cd_micro_visao = prm_visao;

									if ws_ligacao <> 'SEM' then
										fcl.fakeoption('filtro-conteudo-'||ws_counter, '', ws_filtrob.conteudo, 'lista-valores-browser', 'S', 'N', 'filtro-visao', '', 'filtro-coluna-'||ws_counter||'', fun.cdesc(ws_filtrob.conteudo, ws_ligacao));
									else
										fcl.fakeoption('filtro-conteudo-'||ws_counter, ws_filtrob.conteudo, ws_filtrob.conteudo, 'lista-valores-browser', 'S', 'N', 'filtro-visao', '','filtro-coluna-'||ws_counter||'');
									end if;
								
								exception when others then
									
									fcl.fakeoption('filtro-conteudo-'||ws_counter, ws_filtrob.conteudo, ws_filtrob.conteudo, 'lista-valores-browser', 'S', 'N', 'filtro-visao', '', 'filtro-coluna-'||ws_counter||'');
								
								end;
								
							htp.p('</td>');
							
							
							
							htp.p('<td class="noborder invisible"><input type="hidden" id="filtro-ligacao-'||ws_counter||'" data-default="'||ws_filtrob.ligacao||'" /></td>');
							htp.p('<td class="noborder invisible"><input type="hidden" id="filtro-agrupado-'||ws_counter||'" data-default="'||ws_filtrob.st_agrupado||'" /></td>');
							
							htp.p('<td>');
								fcl.button_lixo('dl_ofiltro','prm_key', ws_filtrob.cd_filtro);
							htp.p('</td>');

						
						else
						
							htp.p('<td class="readonly"><input type="text" readonly id="filtro-usuario-'||ws_counter||'" data-default="'||ws_filtrob.cd_usuario||'" value="'||ws_filtrob.cd_usuario||'" /></td>');


							
							htp.p('<td class="readonly"><input type="text" id="filtro-coluna-'||ws_counter||'" data-default="'||ws_filtrob.cd_coluna||'" value="'||ws_filtrob.cd_coluna||'"/></td>');
							
							htp.p('<td class="readonly"><input type="text" id="filtro-condicao-'||ws_counter||'" data-default="'||ws_filtrob.condicao||'" value="'||ws_filtrob.condicao||'"/></td>');

							htp.p('<td class="readonly"><input data-default="'||ws_filtrob.conteudo||'" id="filtro-conteudo-'||ws_counter||'" onblur="if(this.value.length > 0){ if(this.value != this.getAttribute(''data-default'')){ filter('''||ws_par_sumary||''', '''', '''||ws_counter||''', ''CONTEUDO'', this.id); this.setAttribute(''data-default'', this.value); }}" onkeyup="checkPar(this.id, '''||ws_filtrob.micro_visao||''');" value="'||ws_filtrob.conteudo||'" /></td>');
							htp.p('<td class="noborder invisible"><input type="hidden" id="filtro-ligacao-'||ws_counter||'" data-default="'||ws_filtrob.ligacao||'" /></td>');
							htp.p('<td class="noborder invisible"><input type="hidden" id="filtro-agrupado-'||ws_counter||'" data-default="'||ws_filtrob.st_agrupado||'" /></td>');
							
							htp.p('<td><a title="'||fun.lang('Excluir')||'" class="noremove">X</a></td>');
						end if;
					htp.p('</tr>');
				end loop;
				close crs_filtrob;

			else
				open crs_filtro(ws_usuario, ws_admin);
				loop
					fetch crs_filtro into ws_filtro;
					exit when crs_filtro%notfound;

					ws_counter := ws_counter+1;

					htp.p('<tr>');

							htp.p('<td class="readonly"><input type="text" readonly id="filtro-usuario-'||ws_counter||'" data-default="'||ws_filtro.cd_criado||'" value="'||ws_filtro.cd_criado||'" /></td>');


							htp.p('<td class="fake-list" >');
								htp.p('<a class="script" onclick="call(''edit_filtro'',''prm_key='||ws_filtro.cd_filtro||'&prm_valor=''+encodeURIComponent(document.getElementById(''filtro-coluna-'||ws_counter||''').title)+''&prm_tipo=COLUNA'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
								if substr(ws_par_sumary, 1, 4) <> 'OBJ_' then 
									fcl.fakeoption('filtro-coluna-'||ws_counter, '', ws_filtro.cd_coluna, 'lista-coluna', 'N', 'N', 'filtro-visao', '');
								else
									fcl.fakeoption('filtro-coluna-'||ws_counter, '', ws_filtro.cd_coluna, 'lista-colunas', 'N', 'N', 'filtro-visao', '');
								end if;
							htp.p('</td>');
							
							htp.p('<td>');
								htp.p('<a class="script" onclick="call(''edit_filtro'',''prm_key='||ws_filtro.cd_filtro||'&prm_valor=''+encodeURIComponent(document.getElementById(''filtro-condicao-'||ws_counter||''').title)+''&prm_tipo=CONDICAO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
								fcl.fakeoption('filtro-condicao-'||ws_counter||'', '', ws_filtro.condicao, 'lista-condicoes', 'N', 'N', '', '', '', fun.dcondicao(ws_filtro.condicao));
							htp.p('</td>');

							htp.p('<td>');
								
								htp.p('<a class="script" onclick="call(''edit_filtro'',''prm_key='||ws_filtro.cd_filtro||'&prm_valor=''+encodeURIComponent(document.getElementById(''filtro-conteudo-'||ws_counter||''').title)+''&prm_tipo=CONTEUDO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
								
								begin
								
									select cd_ligacao,st_agrupador into ws_ligacao,ws_agrupador 
									  from micro_coluna 
									 where cd_coluna 	  = ws_filtro.cd_coluna 
									   and cd_micro_visao = prm_visao;
								
									if ws_ligacao <> 'SEM' then
										fcl.fakeoption('filtro-conteudo-'||ws_counter, '', ws_filtro.conteudo, 'lista-valores', 'S', 'N', 'filtro-visao', '', 'filtro-coluna-'||ws_counter, fun.cdesc(ws_filtro.conteudo, ws_ligacao));
									else
										fcl.fakeoption('filtro-conteudo-'||ws_counter, '', ws_filtro.conteudo, 'lista-valores', 'S', 'N', 'filtro-visao', '', 'filtro-coluna-'||ws_counter);
									end if;
								
								exception when others then
								
									fcl.fakeoption('filtro-conteudo-'||ws_counter, '', ws_filtro.conteudo, 'lista-valores', 'S', 'N', 'filtro-visao', '', 'filtro-coluna-'||ws_counter);
								
								end;
							
							htp.p('</td>');
							
							htp.p('<td>');
							
								htp.p('<select id="filtro-ligacao-'||ws_counter||'" data-default="'||ws_filtro.ligacao||'" onchange="call(''edit_filtro'',''prm_key='||ws_filtro.cd_filtro||'&prm_valor=''+this.value+''&prm_tipo=LIGACAO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });">');

									if ws_filtro.ligacao = 'and' then
										htp.p('<option value="and" selected>and</option>');
										htp.p('<option value="or">or</option>');
									else
										htp.p('<option value="and">and</option>');
										htp.p('<option value="or" selected>or</option>');
									end if;
								htp.p('</select>');

							htp.p('</td>');

							htp.p('<td>');

								if ws_agrupador <> 'SEM' then
									htp.p('<select id="filtro-agrupado-'||ws_counter||'" data-default="'||ws_filtro.st_agrupado||'" onchange="call(''edit_filtro'',''prm_key='||ws_filtro.cd_filtro||'&prm_valor=''+this.value+''&prm_tipo=AGRUPADO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });">');
								else
									htp.p('<select class="readonly" id="filtro-agrupado-'||ws_counter||'" data-default="'||ws_filtro.st_agrupado||'" onchange="call(''edit_filtro'',''prm_key='||ws_filtro.cd_filtro||'&prm_valor=''+this.value+''&prm_tipo=AGRUPADO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });">');
								end if;

									if ws_filtro.st_agrupado = 'S' then
										htp.p('<option value="S" selected>'||fun.lang('Agrupado')||'</option>');
										htp.p('<option value="N">'||fun.lang('N&atilde;o agrupado')||'</option>');
									else
										htp.p('<option value="S">'||fun.lang('Agrupado')||'</option>');
										htp.p('<option value="N" selected>'||fun.lang('N&atilde;o agrupado')||'</option>');
									end if;
								htp.p('</select>');
							htp.p('</td>');

							if fun.check_admin('FILTERS_EX') or ws_admin = 'A' or ws_id_custom = 'S' then
								htp.p('<td>');
									fcl.button_lixo('dl_ofiltro','prm_key', ws_filtro.cd_filtro);
								htp.p('</td>');
							else
								htp.p('<td><a title="'||fun.lang('Sem permiss&atilde;o')||'" class="noremove">X</a></td>');
							end if;

					htp.p('</tr>');
				end loop;
				close crs_filtro;
			end if;
		htp.p('</tbody>');
	htp.tableClose;
exception
	when ws_nouser then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end list_ofiltro;

--!!
procedure list_sfiltro( ws_par_sumary varchar2 default null,
						prm_order varchar2 default '1',
						prm_dir   varchar2 default '1') as

	cursor crs_filtro is
		select cd_objeto, cd_coluna, condicao, conteudo, micro_visao, ligacao, cd_filtro
		from FILTROS
		where cd_usuario = 'DWU'
		and tp_filtro = 'objeto' 
	  	and cd_objeto = ws_par_sumary  
		
		order by case when prm_dir = '1' then decode(prm_order, '1', micro_visao, '2', cd_coluna, '3', condicao, '4', conteudo, ligacao) end asc,
				 case when prm_dir = '2' then decode(prm_order, '1', micro_visao, '2', cd_coluna, '3', condicao, '4', conteudo, ligacao) end desc;

	ws_filtro	crs_filtro%rowtype;

	ws_ligacao	varchar2(200);
	ws_condicao	varchar2(80);
	ws_usuario  varchar2(80);
	ws_posx		varchar2(80);
	ws_posy		varchar2(80);
	ws_counter  number := 0;
	ws_dir      number := 1;
	ws_nouser   exception;

begin
	
	ws_usuario := gbl.getUsuario;

	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if;

	htp.p('<table class="linha">');
		htp.p('<thead>');
			htp.p('<tr>');
				htp.p('<th><a style="width: 23%;" class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_sfiltro'', ''ws_par_sumary='||ws_par_sumary||'&prm_order=1&prm_dir=''+dir, false, ''content'');">VIEW</th>');
				htp.p('<th><a style="width: 23%;" class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_sfiltro'', ''ws_par_sumary='||ws_par_sumary||'&prm_order=2&prm_dir=''+dir, false, ''content'');">'||fun.lang('COLUNA')||'</a></th>');
				htp.p('<th><a style="width: 23%;" class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_sfiltro'', ''ws_par_sumary='||ws_par_sumary||'&prm_order=3&prm_dir=''+dir, false, ''content'');">'||fun.lang('CONDI&Ccedil;&Atilde;O')||'</a></th>');
				htp.p('<th><a style="width: 23%;">'||fun.lang('VALOR')||'</a></th>');
				htp.p('<th><a style="width: 23%;">'||fun.lang('LIGA&Ccedil;&Atilde;O')||'</a></th>');
				htp.p('<th><a style="width: 8%;"></a></th>');
			htp.p('</tr>');
		htp.p('</thead>');

		if to_number(prm_dir) = 1 then
				ws_dir := 2;
			end if;
		
			htp.p('<tbody id="ajax" data-dir="'||ws_dir||'">');
		
		--htp.p('<tbody id="ajax">');
			open crs_filtro;
			loop
				fetch crs_filtro into ws_filtro;
					exit when crs_filtro%notfound;
					ws_counter := ws_counter +1;
				htp.p('<tr>');
					htp.p('<td id="filtro-visao" title="'||ws_filtro.micro_visao||'">'||ws_filtro.micro_visao||'</td>');
					
					htp.p('<td class="fake-list" >');
						htp.p('<a class="script" onclick="call(''edit_filtro'',''prm_key='||ws_filtro.cd_filtro||'&prm_valor=''+encodeURIComponent(document.getElementById(''filtro-coluna-'||ws_counter||''').title)+''&prm_tipo=COLUNA'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
						fcl.fakeoption('filtro-coluna-'||ws_counter, '', ws_filtro.cd_coluna, 'lista-colunas', 'N', 'N', 'filtro-visao', '');
					htp.p('</td>');

					htp.p('<td>');
						htp.p('<a class="script" onclick="call(''edit_filtro'',''prm_key='||ws_filtro.cd_filtro||'&prm_valor=''+encodeURIComponent(document.getElementById(''filtro-condicao-'||ws_counter||''').title)+''&prm_tipo=CONDICAO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
						fcl.fakeoption('filtro-condicao-'||ws_counter||'', '', ws_filtro.condicao, 'lista-condicoes', 'N', 'N', '', '', '', fun.dcondicao(ws_filtro.condicao));
					htp.p('</td>');
					
					htp.p('<td>');
						htp.p('<a class="script" onclick="call(''edit_filtro'',''prm_key='||ws_filtro.cd_filtro||'&prm_valor=''+encodeURIComponent(document.getElementById(''filtro-conteudo-'||ws_counter||''').title)+''&prm_tipo=CONTEUDO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
						
						begin
						
							select cd_ligacao into ws_ligacao from micro_coluna where cd_coluna = ws_filtro.cd_coluna and cd_micro_visao = ws_filtro.micro_visao;
						
							if ws_ligacao <> 'SEM' then
								fcl.fakeoption('filtro-conteudo-'||ws_counter, '', ws_filtro.conteudo, 'lista-valores', 'S', 'N', 'filtro-visao', '', 'filtro-coluna-'||ws_counter, fun.cdesc(ws_filtro.conteudo, ws_ligacao));
							else
								fcl.fakeoption('filtro-conteudo-'||ws_counter, '', ws_filtro.conteudo, 'lista-valores', 'S', 'N', 'filtro-visao', '', 'filtro-coluna-'||ws_counter);
							end if;
						
						exception when others then
						
							fcl.fakeoption('filtro-conteudo-'||ws_counter, ws_filtro.conteudo, ws_filtro.conteudo, 'lista-valores', 'S', 'N', 'filtro-visao', '', 'filtro-coluna-'||ws_counter);
						
						end;
					htp.p('</td>');

					htp.p('<td>');
						htp.p('<select id="filtro-ligacao-'||ws_counter||'" data-default="'||ws_filtro.ligacao||'" onchange="call(''edit_filtro'',''prm_key='||ws_filtro.cd_filtro||'&prm_valor=''+this.value+''&prm_tipo=LIGACAO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });">');
							if ws_filtro.ligacao = 'and' then
								htp.p('<option value="and" selected>and</option>');
								htp.p('<option value="or">or</option>');
							else
								htp.p('<option value="and">and</option>');
								htp.p('<option value="or" selected>or</option>');
							end if;
						htp.p('</select>');
					htp.p('</td>');

					htp.p('<td>');
						fcl.button_lixo('dl_ofiltro','prm_key', ws_filtro.cd_filtro);	
					htp.p('</td>');
					

				htp.tableRowClose;
			end loop;
			close crs_filtro;
		htp.p('</tbody>');
	htp.p('</table>');
exception
	when ws_nouser then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end list_sfiltro;

procedure lista_sfiltro( prm_visao varchar2 default null ) as
	cursor crs_coluna is
		select nm_rotulo, cd_coluna
		from micro_coluna where cd_micro_visao = prm_visao and nm_rotulo <> ''''
		order by cd_coluna;

	ws_coluna	crs_coluna%rowtype;

	ws_count  number;
	ws_padrao varchar2(80) := 'PORTUGUESE';

begin
	/*fcl.refresh_Session;*/
	
	begin
		select CONTEUDO into ws_padrao
		from   PARAMETRO_USUARIO
		where  cd_usuario = gbl.getUsuario and
			cd_padrao='CD_LINGUAGEM';
	exception
		when others then
			ws_padrao := 'PORTUGUESE';
	end;
	
	select count(cd_coluna) into ws_count from micro_coluna where cd_micro_visao = prm_visao;
	if ws_count > 0 then
	htp.formSelectOpen( cname => 'px_coluna', cattributes => ' id="cd_coluna"');
		open crs_coluna;
		loop
		fetch crs_coluna into ws_coluna;
			exit when crs_coluna%notfound;
		fcl.formSelectOption( '['||ws_coluna.cd_coluna||'] '||fun.utranslate('NM_ROTULO', prm_visao, ws_coluna.nm_rotulo, ws_padrao),ws_coluna.cd_coluna, '','');
		end loop;
		close crs_coluna;
	htp.formSelectClose;
	else
		htp.p('<select><option>'||fun.lang('Nenhuma coluna com esta view')||'.</option></select>');
	end if;
end lista_sfiltro;


procedure list_go ( prm_objeto varchar2 default null,
					prm_order varchar2 default '5',
					prm_dir varchar2 default '1' ) as

	cursor crs_togo is
		select t1.cd_goto_objeto, t1.cd_objeto, cod, nm_objeto nome, decode(tp_objeto,'MAPAGEOLOC','GEOLOCALIZA&Ccedil;&Atilde;O',tp_objeto) as tipo, cd_objeto_go, cd_micro_visao visao, ordem, 
		       t3.tp_objeto, t1.ds_complemento, t1.cs_coluna, t1.cs_agrupador, t1.cs_colup, t1.orderby
		  from goto_objeto t1
		  left join  ponto_avaliacao on cd_ponto = t1.cd_objeto_go
	  	  left join  objetos t3 on t3.cd_objeto  = t1.cd_objeto_go
		 where t1.cd_usuario = 'DWU' 
		   and t1.cd_objeto  = prm_objeto
		 order by case when prm_dir = '1' then decode(prm_order, '1', cd_micro_visao, '2', t1.cd_objeto_go, '3', cod, '4', tipo, '5', upper(nm_objeto), '6', t1.ds_complemento, '7', t1.cs_coluna, '8', t1.cs_agrupador, '9', t1.cs_colup, '10', t1.orderby, t1.ordem) end asc,
		 		  case when prm_dir = '2' then decode(prm_order, '1', cd_micro_visao, '2', t1.cd_objeto_go, '3', cod, '4', tipo, '5', upper(nm_objeto), '6', t1.ds_complemento, '7', t1.cs_coluna, '8', t1.cs_agrupador, '9', t1.cs_colup, '10', t1.orderby, t1.ordem) end desc,
				  t1.ordem;

	ws_togo		crs_togo%rowtype;
	ws_ligacao	varchar2(200);
	ws_condicao	varchar2(80);
	ws_posx		varchar2(80);
	ws_posy		varchar2(80);
	ws_grupo    varchar2(40) := '999999999';
	ws_dir      number := 1;
	ws_linha         integer; 
	ws_ex_permissao  boolean;
	ws_eventoGravar   varchar2(500); 
	ws_evento         varchar2(500); 
	ws_onkeypress_int varchar2(200); 
	ws_obj_html       varchar2(200); 
begin

	ws_eventoGravar   := ' "requestDefault(''goto_update'', ''prm_objeto='||prm_objeto||'&prm_objeto_go=#GO#&prm_cd_goto=''+#CD#+''&prm_campo=#CAMPO#&prm_valor=''+#VALOR#,this,#VALOR#,'''',''FCL'');"'; 
	ws_onkeypress_int := ' onkeypress="if(!input(event, ''integer'')) {event.preventDefault();} else {proxCampo(event,this);}"'; 

	ws_ex_permissao := fun.check_admin('DRILLS_EX');

	htp.p('<table class="linha" id="cadastro_drill">');
		htp.p('<thead>');
			htp.p('<tr>');
				htp.p('<th title="Nome da vis&atilde;o do objeto">       <a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_go'', ''prm_objeto='||prm_objeto||'&prm_order=1&prm_dir=''+dir, false, ''content'');">VIEW</a></th>');
				htp.p('<th title="Identificado do objeto">               <a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_go'', ''prm_objeto='||prm_objeto||'&prm_order=2&prm_dir=''+dir, false, ''content'');">ID</a></th>');
				-- htp.p('<th title="C&oacute;digo do objeto">              <a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_go'', ''prm_objeto='||prm_objeto||'&prm_order=3&prm_dir=''+dir, false, ''content'');">C&Oacute;D.</a></th>');
				htp.p('<th title="Tipo do objeto">                       <a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_go'', ''prm_objeto='||prm_objeto||'&prm_order=4&prm_dir=''+dir, false, ''content'');">'||fun.lang('TIPO')||'</a></th>');
				htp.p('<th title="Descrição/Nome do objeto/drill">       <a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_go'', ''prm_objeto='||prm_objeto||'&prm_order=5&prm_dir=''+dir, false, ''content'');">'||fun.lang('NOME DA DRILL')||'</a></th>');				
				htp.p('<th title="Complemento do título do objeto" style="width: 90px;">      <a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_go'', ''prm_objeto='||prm_objeto||'&prm_order=6&prm_dir=''+dir, false, ''content'');">'||fun.lang('NOME T&Iacute;TULO')||'</a></th>');		
				htp.p('<th title="Colunas agrupadoras para a drill">     <a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_go'', ''prm_objeto='||prm_objeto||'&prm_order=7&prm_dir=''+dir, false, ''content'');">'||fun.lang('AGRUPADORES')||'</a></th>');				
				htp.p('<th title="Colunas de valores para a drill">      <a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_go'', ''prm_objeto='||prm_objeto||'&prm_order=8&prm_dir=''+dir, false, ''content'');">'||fun.lang('VALORES')||'</a></th>');
				htp.p('<th title="Colunas de Pivot para a drill">        <a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_go'', ''prm_objeto='||prm_objeto||'&prm_order=9&prm_dir=''+dir, false, ''content'');">'||fun.lang('PIVOT')||'</a></th>');
				htp.p('<th title="Ordem dos dados do objeto (order by)" style="width: 120px;"> <a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_go'', ''prm_objeto='||prm_objeto||'&prm_order=10&prm_dir=''+dir, false, ''content'');">'||fun.lang('ORDENA&Ccedil;&Atilde;O')||'</a></th>');				
				htp.p('<th title="Ordem na lista de drills" style="width: 65px;">              <a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_go'', ''prm_objeto='||prm_objeto||'&prm_order=11&prm_dir=''+dir, false, ''content'');">'||fun.lang('ORDEM')||'</a></th>');										
				htp.p('<th></th>');
			htp.p('</tr>');
		htp.p('</thead>');

		if to_number(prm_dir) = 1 then ws_dir := 2; end if;

		htp.p('<tbody id="ajax" data-dir="'||ws_dir||'">');

			ws_linha := 0 ;
			for ws_togo in crs_togo loop 
				ws_linha    := ws_linha + 1; 
				ws_evento   := replace(ws_eventoGravar,'#GO#',ws_togo.cd_objeto_go); 
				ws_evento   := replace(ws_evento,'#CD#', ws_togo.cd_goto_objeto); 
				ws_obj_html := ws_togo.cd_objeto_go||'trl'||ws_togo.cd_goto_objeto; 

				htp.p('<tr id="'||ws_togo.cd_objeto_go||'TR">');
					htp.p('<td title="'||ws_togo.visao||'">'||ws_togo.visao||'</td>');
					htp.p('<td title="'||ws_togo.cd_objeto_go||'">'||ws_togo.cd_objeto_go||'</td>');
					htp.p('<td title="'||ws_togo.tipo||'">'||ws_togo.tipo||'</td>');
					htp.p('<td title="'||ws_togo.nome||'">'||ws_togo.nome||'</td>');

					if ws_togo.tipo not in ('SCREEN','RELATORIO') then 
						htp.p('<td><input id="prm_ds_complemento_'||ws_linha||'" value="'||ws_togo.ds_complemento||'" data-default="'||ws_togo.ds_complemento||'" onblur='||replace(replace(ws_evento,'#CAMPO#','DS_COMPLEMENTO'),'#VALOR#','this.value')||'></td>');
					else 
						htp.p('<td></td>');	
					end if; 	
					htp.p('<td style="max-width: 120px !important;">');
						if ws_togo.tipo not in ('SCREEN','RELATORIO') then 
							htp.p('<a class="script" data-default="'||ws_togo.cs_coluna||'" onclick='||replace(replace(ws_evento,'#CAMPO#','CS_COLUNA'),'#VALOR#','this.nextElementSibling.title')||'></a>');
							fcl.fakeoption('prm_cs_coluna_'||ws_linha, ws_togo.cs_coluna, ws_togo.cs_coluna, 'lista-agrupador', 'N', 'S', prm_visao => ws_togo.visao);
						end if;	
					htp.p('</td>');
					htp.p('<td style="max-width: 120px !important;">');
						if ws_togo.tipo not in ('SCREEN','RELATORIO') then 
							htp.p('<a class="script" data-default="'||ws_togo.cs_agrupador||'" onclick='||replace(replace(ws_evento,'#CAMPO#','CS_AGRUPADOR'),'#VALOR#','this.nextElementSibling.title')||'></a>');
							fcl.fakeoption('prm_cs_agrupador_'||ws_linha, ws_togo.cs_agrupador, ws_togo.cs_agrupador, 'lista-valor', 'N', 'S',  prm_visao => ws_togo.visao);						
						end if;	
					htp.p('</td>');
					htp.p('<td style="max-width: 120px !important;">');
						if ws_togo.tp_objeto = 'CONSULTA' then 
							htp.p('<a class="script" data-default="'||ws_togo.cs_colup||'" onclick='||replace(replace(ws_evento,'#CAMPO#','CS_COLUP'),'#VALOR#','this.nextElementSibling.title')||'></a>');
							fcl.fakeoption('prm_cs_colup_'||ws_linha, ws_togo.cs_colup, ws_togo.cs_colup, 'lista-pivot', 'N', 'S',  prm_visao => ws_togo.visao);						
						end if; 
					htp.p('</td>');

					htp.p('<td style="max-width: 120px !important;">'); 
						if ws_togo.tipo not in ('SCREEN','RELATORIO') then 
							htp.p('<input style="width: 60px !important; min-width: 60px !important;" id="prm_orderby_'||ws_linha||'" value="'||ws_togo.orderby||'" data-default="'||ws_togo.orderby||'" onblur='||replace(replace(ws_evento,'#CAMPO#','ORDERBY'),'#VALOR#','this.value')||'>');
							htp.p('<input style="cursor: pointer; font-size: 9px; width: 50px !important; min-width: 50px !important" type="button" value="DEFAULT" onclick="if(confirm(''Essa op&ccedil;&atilde;o vai alterar a ordem desta Drill em todos os usu&aacute;rios para o valor digitado, deseja prosseguir?'')){ ajax(''fly'', ''alter_ordem_geral'', ''prm_valor=''+encodeURIComponent(this.previousElementSibling.value)+''&prm_objeto='||ws_obj_html||'''); }"/>');						
						end if;	
					htp.p('</td>');

					htp.p('<td>');
						htp.p('<input style="min-width: 50px !important;" type="number" value="'||ws_togo.ordem||'" data-default="'||ws_togo.ordem||'" onblur='||replace(replace(ws_evento,'#CAMPO#','ORDEM'),'#VALOR#','this.value')||' '||ws_onkeypress_int||'>');
					htp.p('</td>'); 
					
					htp.p('<td>');
						if ws_ex_permissao then
							fcl.button_lixo('goto_delete','prm_objeto|prm_objeto_go|prm_cd_goto', ws_togo.cd_objeto||'|'||ws_togo.cd_objeto_go||'|'||ws_togo.cd_goto_objeto);
						else
							htp.p('<a class="noremove">X</a>');
						end if;
					htp.p('</td>');

				htp.p('</tr>');

			end loop;

		htp.p('</tbody>');
	htp.tableClose;

end list_go;

procedure listgo_objetos ( prm_objeto varchar2 default null,
						prm_visao  varchar2 default null,
						prm_campo  varchar2 default null ) as


	cursor crs_drills is
	select cd_objeto, cod, nm_objeto, tp_objeto, visao from (select cd_objeto, cod, nm_objeto, tp_objeto, (select cd_micro_visao from ponto_avaliacao where cd_ponto = cd_objeto) as visao
	from objetos
	where cd_objeto not in(select cd_objeto_go from goto_objeto where cd_objeto = trim(prm_objeto)) and
	tp_objeto in (select column_value from table(fun.vpipe(prm_campo)))) where
	(visao = prm_visao or tp_objeto = prm_visao)
	order by tp_objeto, cd_objeto;

	ws_drill crs_drills%rowtype;
	
	ws_tipo   varchar2(80);
	ws_padrao varchar2(80) := 'PORTUGUESE';
begin

	ws_tipo := 'N/A';
	
	begin
		select CONTEUDO into ws_padrao
		from   PARAMETRO_USUARIO
		where  cd_usuario = gbl.getUsuario and
			cd_padrao='CD_LINGUAGEM';
	exception
		when others then
			ws_padrao := 'PORTUGUESE';
	end;

	htp.p('<option selected readonly disabled>'||fun.lang('Escolha um objeto')||'</option>');
	open crs_drills;
		loop
			fetch crs_drills into ws_drill;
			exit when crs_drills%notfound;
			if  trim(ws_drill.tp_objeto) <> trim(ws_tipo) then
				htp.p('<optgroup label="'||upper(trim(ws_drill.tp_objeto))||'"></optgroup>');
				ws_tipo := trim(ws_drill.tp_objeto);
			end if;
			htp.p('<option value="'||ws_drill.cd_objeto||'">'||fun.utranslate('NM_OBJETO', ws_drill.cd_objeto, ws_drill.nm_objeto, ws_padrao)||' - ['||nvl(ws_drill.cod, ws_drill.cd_objeto)||'] - '||ws_drill.tp_objeto||'</option>');
		end loop;
	close crs_drills;

	if prm_campo = 'CONSULTA|ORGANOGRAMA|SCRIPTS' then
		htp.p('<optgroup label="SCRIPTS"></optgroup>');
		for i in(select cd_objeto, cod, nm_objeto, tp_objeto from objetos where tp_objeto = 'SCRIPT') loop
			htp.p('<option value="'||i.cd_objeto||'">'||fun.utranslate('NM_OBJETO', i.cd_objeto, i.nm_objeto, ws_padrao)||' - ['||nvl(i.cod, i.cd_objeto)||'] - '||i.tp_objeto||'</option>');
		end loop;
	end if;

end listgo_objetos;


procedure list_call_end( prm_objeto varchar2 default null,
						prm_screen varchar2 default null ) as

	/*cursor crs_objeto is
		select cd_objeto, nm_objeto, tp_objeto
		from objetos where tp_objeto = 'FILE'
		order by cd_objeto;

	ws_objeto	crs_objeto%rowtype;*/

	
	cursor crs_togo is
		select cll.cd_list as cd_objeto, cll.cd_objeto as cd_objeto_go, ordem,
		(select nm_item from call_name name where name.cd_objeto=CLL.cd_objeto and name.screen=trim(prm_screen)) as nm_item,
		obj.tp_objeto as tipo,
		obj.atributos as att,
		obj.nm_objeto as nome
		from call_list cll, objetos obj
		where
			cll.cd_list  = prm_objeto and
			fun.CHECK_PERMISSAO(cll.cd_objeto) = 'S' and
			obj.cd_objeto=cll.cd_objeto and
			obj.tp_objeto = 'FILE'
		order by ordem asc;

	ws_togo		crs_togo%rowtype;
	ws_count number;

begin

	
	htp.p('<table class="linha">');
		htp.p('<thead>');
			htp.p('<tr>');
				htp.p('<th>'||fun.lang('OBJETO')||'</th>');
				htp.p('<th>'||fun.lang('NOME')||'</th>');
				htp.p('<th>URL/'||fun.lang('ARQUIVO')||'</th>');
				htp.p('<th></th>');
			htp.p('</tr>');
		htp.p('</thead>');
		htp.p('<tbody id="ajax">');

			open crs_togo;
				loop
					fetch crs_togo into ws_togo;
					exit when crs_togo%notfound;
					htp.p('<tr>');
						htp.p('<td>'||ws_togo.cd_objeto_go||'</td>');
						htp.p('<td>'||ws_togo.nome||'</td>');
						htp.p('<td>'||ws_togo.att||'</td>');
						htp.p('<td>');
							fcl.button_lixo('dl_call','p_cd_objeto|p_cd_objeto_go', prm_objeto||'|'||ws_togo.cd_objeto_go);
						htp.p('</td>');
						--htp.p('<td class="noborder" id="'||ws_togo.cd_objeto_go||'linha"><a class="remove" title="'||fun.lang('Excluir')||'" onclick="var row = this.parentNode.parentNode; row.classList.add(''removing''); call(''dl_call'', ''p_cd_objeto='||prm_objeto||'&p_cd_objeto_go='||ws_togo.cd_objeto_go||''').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ row.remove(); alerta(''feed-fixo'', TR_EX); } else { row.classList.remove(''removing''); alerta(''feed-fixo'', TR_EX); } });">X</a></td>');
					htp.p('</tr>');
				end loop;
			close crs_togo;
		
		htp.p('</tbody>');
	htp.p('</table>');

end list_call_end;

--!!
procedure list_call ( prm_objeto varchar2 default null,
					prm_screen varchar2 default null ) as

	cursor crs_togo is
		select cll.cd_list as cd_objeto, cll.cd_objeto as cd_objeto_go, nvl(ordem,0), cll.ordem,
		(select nm_item from call_name name where name.cd_objeto=CLL.cd_objeto and name.screen=trim(prm_screen)) as nm_item,
		pa.cd_micro_visao as visao,
		obj.tp_objeto as tipo,
		obj.atributos as att,
		obj.nm_objeto as nome
		from call_list cll, objetos obj, ponto_avaliacao pa
		where
			cll.cd_list  = prm_objeto and
			fun.CHECK_PERMISSAO(cll.cd_objeto) = 'S' and
			obj.cd_objeto=cll.cd_objeto and
			pa.cd_ponto=cll.cd_objeto and
			obj.tp_objeto <> 'FILE' and tp_objeto <> 'RELATORIO'
		order by ordem asc;

	ws_togo		crs_togo%rowtype;

	cursor crs_scripts is
	select obj.cd_objeto as cd_objeto, cll.cd_objeto as cd_objeto_go, nm_objeto as nm_item, tp_objeto, cll.ordem as ordem, obj.atributos as att
	from objetos obj, call_list cll
	where tp_objeto = 'SCRIPT'and 
	cll.cd_objeto = obj.cd_objeto and
	cll.cd_list  = prm_objeto;

	ws_script crs_scripts%rowtype;

	cursor crs_relatorios is
	select obj.cd_objeto as cd_objeto, cll.cd_objeto as cd_objeto_go, nm_objeto as nm_item, tp_objeto, cll.ordem as ordem, obj.atributos as att
	from objetos obj, call_list cll
	where tp_objeto = 'RELATORIO' and
	cll.cd_objeto = obj.cd_objeto and
	cll.cd_list  = prm_objeto;

	ws_relatorio crs_relatorios%rowtype;

	cursor crs_files is
		select cll.cd_list as cd_objeto, cll.cd_objeto as cd_objeto_go, ordem,
		(select nm_item from call_name name where name.cd_objeto=CLL.cd_objeto and name.screen=trim(prm_screen)) as nm_item,
		obj.tp_objeto as tipo,
		obj.atributos as att,
		obj.nm_objeto as nome
		from call_list cll, objetos obj
		where
			cll.cd_list  = prm_objeto and
			fun.CHECK_PERMISSAO(cll.cd_objeto) = 'S' and
			obj.cd_objeto=cll.cd_objeto and
			obj.tp_objeto = 'FILE'
		order by ordem asc;

	ws_file		crs_files%rowtype;

	ws_ligacao	varchar2(200);
	ws_condicao	varchar2(80);
	ws_posx		varchar2(80);
	ws_posy		varchar2(80);
	ws_grupo 	varchar2(40) := '999999999';
	ws_count 	number := 0;

	ws_nouser	exception;

begin

	if gbl.getUsuario = 'NOUSER' then
		raise ws_nouser;
	end if;

	htp.p('<table class="linha">');
		htp.p('<thead>');
			htp.p('<tr>');
				htp.p('<th>VIEW</th>');
				htp.p('<th>ID</th>');
				htp.p('<th>'||fun.lang('NOME')||'</th>');
				htp.p('<th>'||fun.lang('TEXTO DO BOT&Atilde;O')||'</th>');
				htp.p('<th>'||fun.lang('ORDEM')||'</th>');
				htp.p('<th></th>');
			htp.p('</tr>');
		htp.p('</thead>');
		htp.p('<tbody id="ajax">');
			open crs_togo;
			loop
				fetch crs_togo into ws_togo;
				exit when crs_togo%notfound;
				ws_count := ws_count+1;
					htp.p('<tr>');
						htp.p('<td style="white-space: nowrap; padding-right: 5px;">'||ws_togo.visao||'</td>');
						htp.p('<td style="white-space: nowrap; padding-right: 5px;">'||ws_togo.cd_objeto_go||'</td>');
						htp.p('<td style="white-space: nowrap; text-overflow: ellipsis;">'||ws_togo.nome||'</td>');
						htp.p('<td><div title="nome no bot&atilde;o" style="min-height: 25px;" class="editable" onblur=" if(this.textContent != ''''){ document.getElementById('''||ws_togo.cd_objeto_go||'menu'').childNodes[0].innerHTML = this.textContent; } else { document.getElementById('''||ws_togo.cd_objeto_go||'menu'').childNodes[0].text =  '''||ws_togo.nome||'''; } ajax(''fly'', ''update_call'', ''prm_item=''+this.textContent+''&prm_list='||prm_objeto||'&prm_objeto='||ws_togo.cd_objeto_go||'&prm_screen='||prm_screen||'&prm_acao=1'', ''true''); "contenteditable="true" >'||ws_togo.nm_item||'</div></td>');
						htp.p('<td>');
								htp.p('<select title="'||fun.lang('ordem do bot&atilde;o')||'" onchange=" ajax(''fly'', ''update_call'', ''prm_item=''+this.value+''&prm_list='||prm_objeto||'&prm_objeto='||ws_togo.cd_objeto_go||'&prm_screen='||prm_screen||'&prm_acao=2'', ''true''); ">');
									fcl.numericOptions(20, ws_togo.ordem);
							htp.p('</select>');
						htp.p('</td>');
							htp.p('<td id="'||ws_togo.cd_objeto_go||'linha"><a class="remove" title="'||fun.lang('Excluir')||'" onclick="var row = this.parentNode.parentNode; row.classList.add(''removing''); call(''dl_call'', ''p_cd_objeto='||prm_objeto||'&p_cd_objeto_go='||ws_togo.cd_objeto_go||''').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ row.remove(); alerta(''feed-fixo'', TR_EX); } else { row.classList.remove(''removing''); alerta(''feed-fixo'', TR_EX); } });">X</a></td>');
					htp.p('</tr>');
			end loop;
			close crs_togo;

			open crs_scripts;
			loop
				fetch crs_scripts into ws_script;
				exit when crs_scripts%notfound;
				ws_count := ws_count+1;
					htp.p('<tr>');
						htp.p('<td style="white-space: nowrap; padding-right: 5px;">N/A</td>');
						htp.p('<td style="white-space: nowrap; padding-right: 5px;">'||ws_script.cd_objeto_go||'</td>');
						htp.p('<td style="white-space: nowrap; text-overflow: ellipsis;">'||ws_script.nm_item||'</td>');
						htp.p('<td><div title="nome no bot&atilde;o" style="min-height: 25px;" class="editable" onblur=" if(this.textContent != ''''){ ajax(''fly'', ''update_call'', ''prm_item=''+this.textContent+''&prm_list='||prm_objeto||'&prm_objeto='||ws_script.cd_objeto_go||'&prm_screen='||prm_screen||'&prm_acao=1'', ''true''); }" contenteditable="true" >'||ws_script.nm_item||'</div></td>');
						htp.p('<td>');
							htp.p('<select title="'||fun.lang('ordem do bot&atilde;o')||'" onchange=" ajax(''fly'', ''update_call'', ''prm_item=''+this.value+''&prm_list='||prm_objeto||'&prm_objeto='||ws_script.cd_objeto_go||'&prm_screen='||prm_screen||'&prm_acao=2'', ''true''); ">');
								fcl.numericOptions(20, ws_script.ordem);
							htp.p('</select>');
						htp.p('</td>');
						htp.p('<td>');
							fcl.button_lixo('dl_call','p_cd_objeto|p_cd_objeto_go', prm_objeto||'|'||ws_togo.cd_objeto_go);
						htp.p('</td>');

					htp.p('</tr>');
			end loop;
			close crs_scripts;

			open crs_relatorios;
			loop
				fetch crs_relatorios into ws_relatorio;
				exit when crs_relatorios%notfound;
				ws_count := ws_count+1;
					htp.p('<tr>');
						htp.p('<td style="white-space: nowrap; padding-right: 5px;">N/A</td>');
						htp.p('<td style="white-space: nowrap; padding-right: 5px;">'||ws_relatorio.cd_objeto_go||'</td>');
						htp.p('<td style="white-space: nowrap; text-overflow: ellipsis;">'||fun.cdesc(ws_relatorio.cd_objeto_go,'DESC_CONSULTA')||'</td>');
						htp.p('<td><div title="nome no bot&atilde;o" style="min-height: 25px;" class="editable" onblur=" if(this.textContent != ''''){ ajax(''fly'', ''update_call'', ''prm_item=''+this.textContent+''&prm_list='||prm_objeto||'&prm_objeto='||ws_relatorio.cd_objeto_go||'&prm_screen='||prm_screen||'&prm_acao=1'', ''true''); }" contenteditable="true" >'||ws_relatorio.nm_item||'</div></td>');
						htp.p('<td>');
							htp.p('<select title="'||fun.lang('ordem do bot&atilde;o')||'" onchange=" ajax(''fly'', ''update_call'', ''prm_item=''+this.value+''&prm_list='||prm_objeto||'&prm_objeto='||ws_relatorio.cd_objeto_go||'&prm_screen='||prm_screen||'&prm_acao=2'', ''true''); ">');
								fcl.numericOptions(20, ws_relatorio.ordem);
							htp.p('</select>');
						htp.p('</td>');

						htp.p('<td>');
							fcl.button_lixo('dl_call','p_cd_objeto|p_cd_objeto_go', prm_objeto||'|'||ws_relatorio.cd_objeto_go);
						htp.p('</td>');
													
					htp.p('</tr>');
			end loop;
			close crs_relatorios;

			open crs_files;
			loop
				fetch crs_files into ws_file;
				exit when crs_files%notfound;
				ws_count := ws_count+1;
					htp.p('<tr>');
						htp.p('<td style="white-space: nowrap; padding-right: 5px;">N/A</td>');
						htp.p('<td style="white-space: nowrap; padding-right: 5px;">'||ws_file.cd_objeto_go||'</td>');
						htp.p('<td style="white-space: nowrap; text-overflow: ellipsis;">'||ws_file.nome||' - '||ws_file.att||'</td>');
						htp.p('<td><div title="nome no bot&atilde;o" style="min-height: 25px;" class="editable" onblur=" if(this.textContent != ''''){ ajax(''fly'', ''update_call'', ''prm_item=''+this.textContent+''&prm_list='||prm_objeto||'&prm_objeto='||ws_file.cd_objeto_go||'&prm_screen='||prm_screen||'&prm_acao=1'', ''true''); }" contenteditable="true" >'||ws_file.nm_item||'</div></td>');
						htp.p('<td>');
							htp.p('<select title="'||fun.lang('ordem do bot&atilde;o')||'" onchange=" ajax(''fly'', ''update_call'', ''prm_item=''+this.value+''&prm_list='||prm_objeto||'&prm_objeto='||ws_file.cd_objeto_go||'&prm_screen='||prm_screen||'&prm_acao=2'', ''true''); ">');
								fcl.numericOptions(20, ws_file.ordem);
							htp.p('</select>');
						htp.p('</td>');
						htp.p('<td>');
							fcl.button_lixo('dl_call','p_cd_objeto|p_cd_objeto_go', prm_objeto||'|'||ws_file.cd_objeto_go);
						htp.p('</td>');
					htp.p('</tr>');
			end loop;
			close crs_files;

		htp.p('</tbody>');
	htp.tableClose;
exception 
	when ws_nouser then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end list_call;


procedure update_call( prm_item varchar2 default null,
					prm_list varchar2 default null,
					prm_objeto varchar2 default null,
					prm_screen varchar2 default null,
					prm_acao integer default 1) as


	ws_count number;
begin
	/*fcl.refresh_Session;*/
	if trim(prm_item) <> '''' then
		if prm_acao = 1 then
			select count(*) into ws_count from call_name where cd_list = prm_list and screen = prm_screen and cd_objeto = prm_objeto;
			if ws_count = 0 then
				insert into call_name values(prm_item, prm_list, prm_objeto, prm_screen);
				commit;
			else
				update call_name set nm_item = prm_item
				where cd_list = prm_list and cd_objeto = prm_objeto and screen = prm_screen;
				commit;
			end if;
		else
			update call_list set ORDEM = prm_item
			where cd_list = prm_list and cd_objeto = prm_objeto;
			commit;
		end if;
	else
		delete from call_name
		where cd_list = prm_list and cd_objeto = prm_objeto and screen = prm_screen;
		commit;
	end if;

end update_call;


--!!
procedure edit_ofiltro ( p_item         char     default '1',
						new_cd_objeto  varchar2 default null,
						new_cd_coluna  varchar2 default null,
						new_condicao   varchar2 default null,
						new_conteudo   varchar2 default null,
						prm_ligacao	varchar2 default 'and',
						prm_visao      varchar2 default null,
						prm_agrupado   char     default 'N',
						prm_usuario    varchar2 default null ) as


		ws_condicao	varchar2(80);
		ws_count    number;
		ws_agrupado char(1);
		ws_inc      number := 0;
		ws_key      number := 0;

		cursor crs_colunas is
		select cd_micro_visao, cd_coluna, nm_rotulo
		from micro_coluna
		where cd_micro_visao = prm_visao
		order by cd_coluna desc;
		

	ws_colunas crs_colunas%rowtype;

	ws_tipo           varchar2(80);
	ws_conteudo       varchar2(2000);
	ws_usuario        varchar2(80);
	ws_qt_custom      number; 
	
	ws_nouser   exception;
begin

	/*fcl.refresh_Session;*/

	ws_usuario := gbl.getUsuario;

	select count(*) into ws_qt_custom from objetos where cd_objeto = new_cd_objeto and nvl(id_customizado,'N') = 'S'; 

	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if;

	ws_conteudo := fun.converte(new_conteudo);

	select tp_objeto into ws_tipo from objetos where cd_objeto = new_cd_objeto;

	if fun.check_admin('FILTERS_ADD') or instr(new_cd_objeto, 'BRO') > 0 or ws_qt_custom > 0 then

		select count(*) into ws_count from micro_coluna where cd_coluna = new_cd_coluna and cd_micro_visao = prm_visao and st_agrupador = 'SEM' and rownum = 1;
		if ws_count = 1 then
			ws_agrupado := 'N';
		else
			ws_agrupado := prm_agrupado;
		end if;
			
		select nvl2(max(cd_filtro), max(cd_filtro), 0)+1 into ws_key from filtros;

		loop
		
			ws_inc := ws_inc+1;
		
			select count(*) into ws_count from filtros where cd_filtro = ws_key;
		
			if ws_count > 0 then
				select ws_key+ws_inc into ws_key from filtros;
			else
				exit;
			end if;
		end loop;

		insert into filtros (cd_usuario, cd_objeto, micro_visao, cd_coluna, condicao, conteudo, ligacao, st_agrupado, cd_filtro, tp_filtro, cd_criado)
        values (nvl(prm_usuario, 'DWU'), new_cd_objeto, prm_visao, new_cd_coluna, new_condicao, ws_conteudo, prm_ligacao, ws_agrupado, ws_key, 'objeto', ws_usuario);
		insert into bi_log_sistema (dt_log, ds_log, nm_usuario, nm_procedure) values (sysdate, 'Filtro #'||new_cd_coluna||' Valor #'||new_conteudo||' criado com sucesso no Obj #'||new_cd_objeto||'', ws_usuario, 'EVENTO');
		commit;

	else

		htp.p('#alert '||fun.lang('Sem permiss&atilde;o')||'!');

	end if;
exception 
	when ws_nouser then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end edit_ofiltro;


--!!
procedure edit_sfiltro ( p_item          char default '1',
						new_cd_objeto   varchar2 default null,
						new_micro_visao varchar2 default null,
						new_cd_coluna   varchar2 default null,
						new_condicao	 varchar2 default null,
						new_conteudo	 varchar2 default null,
						new_ligacao	 varchar2 default 'and' ) as


	ws_max      number;
	ws_count    number;
	ws_key      number := 0;
	ws_inc      number := 0;
	ws_condicao	varchar2(80);
	ws_usuario  varchar2(80);
	ws_conteudo varchar2(800);

	ws_nouser   exception;
	ws_fail     exception;
begin
	
	/*fcl.refresh_Session;*/

	ws_usuario := gbl.getUsuario;

	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if;

	ws_conteudo := fun.converte(new_conteudo);
	
	select nvl2(max(cd_filtro), max(cd_filtro), 0)+1 into ws_key from filtros;
	
	loop
	
		ws_inc := ws_inc+1;
	
		select count(*) into ws_count from filtros where cd_filtro = ws_key;
	
		if ws_count > 0 then
			select ws_key+ws_inc into ws_key from filtros;
		else
			exit;
		end if;
	end loop;
	
	
	insert into filtros
		(cd_usuario, cd_objeto, micro_visao, cd_coluna, condicao, conteudo, ligacao, st_agrupado, cd_filtro, tp_filtro, cd_criado)
	values
		('DWU', new_cd_objeto, new_micro_visao, new_cd_coluna, new_condicao, ws_conteudo, new_ligacao, 'N', ws_key, 'objeto', ws_usuario);
	
	ws_count := SQL%ROWCOUNT;
	
	if ws_count = 1 then
		commit;
	else
		raise ws_fail;
	end if;
		
exception 
	when ws_nouser then
		htp.p('Sem permiss&atilde;o!');
	when ws_fail then
		htp.p('FAIL');
	when others then
		htp.p('FAIL');
end edit_sfiltro;


/* Lista de Variavel Padrão */

--!!
procedure list_cdesc ( prm_order varchar2 default '1',
					prm_dir varchar2 default '1' ) as

	cursor crs_cdesc is
		select nds_tabela, nds_owner, nds_tfisica, nds_cd_empresa, nds_cd_codigo, nds_cd_descricao, tipo, nr_ordem_select
		from CODIGO_DESCRICAO
		order by
		case when prm_dir = '1' then decode(prm_order, '1', tipo, '2', nds_tabela, '3', nds_tfisica, '4', nds_cd_empresa, '5', nds_cd_codigo, '6', nds_cd_descricao, '7', nds_tabela,nr_ordem_select ) end asc,
		case when prm_dir = '2' then decode(prm_order, '1', tipo, '2', nds_tabela, '3', nds_tfisica, '4', nds_cd_empresa, '5', nds_cd_codigo, '6', nds_cd_descricao, '7', nds_tabela, nr_ordem_select) end desc;

	ws_cdesc	crs_cdesc%rowtype;
	ws_dir number := 1;

	ws_noadmin exception;
begin
	
	if gbl.getNivel <> 'A' then
		raise ws_noadmin;
	end if;

	htp.p('<table class="linha">');
		htp.p('<thead>');
			htp.p('<tr>');
				htp.p('<th style="width: 10%;"><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_cdesc'', ''prm_order=1&prm_dir=''+dir, false, ''content'');">'||fun.lang('TIPO')||'</a></th>');
				htp.p('<th style="width: 20%;"><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_cdesc'', ''prm_order=2&prm_dir=''+dir, false, ''content'');">'||fun.lang('NOME')||'</a></th>');
				htp.p('<th style="width: 20%;"><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_cdesc'', ''prm_order=3&prm_dir=''+dir, false, ''content'');">'||fun.lang('TABELA')||'</a></th>');
				htp.p('<th style="width: 20%;"><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_cdesc'', ''prm_order=4&prm_dir=''+dir, false, ''content'');">'||fun.lang('C&Oacute;DIGO')||'</a></th>');
				htp.p('<th style="width: calc(16% - 11px);"><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_cdesc'', ''prm_order=5&prm_dir=''+dir, false, ''content'');">'||fun.lang('DESCRI&Ccedil;&Atilde;O')||'</a></th>');
				htp.p('<th style="width: calc(10% - 11px);"><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_cdesc'', ''prm_order=6&prm_dir=''+dir, false, ''content'');">'||fun.lang('ORDEM')||'</a></th>');
				htp.p('<th style="width: 22px;"></th>');
			htp.p('<tr>');
		htp.p('</thead>');

		if to_number(prm_dir) = 1 then ws_dir := 2; end if;

			htp.p('<tbody id="ajax" data-dir="'||ws_dir||'">');
			open crs_cdesc;
				loop
					fetch crs_cdesc into ws_cdesc;
					exit when crs_cdesc%notfound;
						htp.p('<tr>');
								htp.p('<td style="width: 10%;">'||ws_cdesc.tipo||'</td>');
								htp.p('<td style="width: 16%;">'||ws_cdesc.nds_tabela||'</td>');

								if ws_cdesc.tipo = 'LISTA' then
									htp.p('<td><input id="prm_nome_lista'||ws_cdesc.nds_tabela||'" data-min="1" data-default="'||ws_cdesc.nds_tabela||'" onblur="'||'requestDefault(''update_cdesc'', ''prm_nome_id='||ws_cdesc.nds_tabela||'&prm_conteudo=''+this.value,this,this.value,'''',''FCL'')'||'" value="'||ws_cdesc.nds_tfisica||'" /></td>');
								else
									htp.p('<td style="width: 20%;">'||ws_cdesc.nds_tfisica||'</td>');
								end if;

								htp.p('<td style="width: 20%;">'||ws_cdesc.nds_cd_codigo||'</td>');
								htp.p('<td style="width: calc(20% - 22px);">'||ws_cdesc.nds_cd_descricao||'</td>');
								htp.p('<td style="width: 10%;">');
									htp.p('<select id="prm_ordem_select'||ws_cdesc.nds_tabela||'" data-min="1" data-default="'||ws_cdesc.nds_tabela||'" onblur="'||'requestDefault(''update_nr_ordem_select'', ''prm_nome_id='||ws_cdesc.nds_tabela||'&prm_conteudo=''+this.value,this,this.value,'''',''FCL'')'||'" value="'||ws_cdesc.nr_ordem_select||'">');
										if ws_cdesc.nr_ordem_select = 'CD' then
											htp.p('<option value="CA">'||fun.lang('Cod Crescente')||'</option>');
											htp.p('<option value="CD" selected="checked">'||fun.lang('Cod Decrescente')||'</option>');
											htp.p('<option value="DA">'||fun.lang('Desc Crescente')||'</option>');
											htp.p('<option value="DD">'||fun.lang('Desc Decrescente')||'</option>');
										elsif ws_cdesc.nr_ordem_select = 'DA' then
											htp.p('<option value="CA">'||fun.lang('Cod Crescente')||'</option>');
											htp.p('<option value="CD">'||fun.lang('Cod Decrescente')||'</option>');
											htp.p('<option value="DA" selected="checked">'||fun.lang('Desc Crescente')||'</option>');
											htp.p('<option value="DD">'||fun.lang('Desc Decrescente')||'</option>');
										elsif ws_cdesc.nr_ordem_select = 'DD' then
											htp.p('<option value="CA">'||fun.lang('Cod Crescente')||'</option>');
											htp.p('<option value="CD">'||fun.lang('Cod Decrescente')||'</option>');
											htp.p('<option value="DA">'||fun.lang('Desc Crescente')||'</option>');
											htp.p('<option value="DD" selected="checked">'||fun.lang('Desc Decrescente')||'</option>');
										else
											htp.p('<option value="CA" selected="checked">'||fun.lang('Cod Crescente')||'</option>');
											htp.p('<option value="CD">'||fun.lang('Cod Decrescente')||'</option>');
											htp.p('<option value="DA">'||fun.lang('Desc Crescente')||'</option>');
											htp.p('<option value="DD">'||fun.lang('Desc Decrescente')||'</option>');
										end if;
									htp.p('</select>');
								htp.p('</td>');
							
							htp.p('<td>');
								if ws_cdesc.nds_tabela IN ('MASCARAS','DESC_CONSULTA','MICRO_COLUNA') then -- Não permite excluir a Lista de valroes da tabela MASCARAS
									htp.p('<a class="noremove" onclick="alerta(''msg'', '''||fun.lang('Lista de valores n&atilde;o pode ser excluida')||''');" title="'||fun.lang('Lista de valores n&atilde;o pode ser excluida.')||'">X</a>');
								else
									fcl.button_lixo('dl_cd','ws_par_sumary', ws_cdesc.nds_tabela);
								end if;	
							htp.p('<td>');
								
							--htp.p('<td style="width: 22px;"><a title="'||fun.lang('Excluir')||'" onclick="if(confirm('''||fun.lang('Confirmar exclus&atilde;o')||'?'')){ var row = this.parentNode.parentNode; row.classList.add(''removing''); call(''dl_cd'', ''ws_par_sumary='||ws_cdesc.nds_tabela||''').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ row.remove(); alerta(''feed-fixo'', TR_EX); } else { row.classList.remove(''removing''); alerta(''feed-fixo'', TR_ER); } }); }" class="remove">X</a></td>');
						htp.p('</tr>');
				end loop;
			close crs_cdesc;
		htp.p('</tbody>');
	htp.tableClose;
exception
	when ws_noadmin then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end list_cdesc;

procedure update_cdesc(prm_nome_id varchar2 default null,
					   prm_conteudo varchar2 default null) as

	ws_count integer;

begin

	select count(*) into ws_count
	from CODIGO_DESCRICAO 
	where nds_tabela = trim(prm_nome_id);

	if ws_count > 0 then
		update CODIGO_DESCRICAO
		set nds_tfisica = prm_conteudo
		where nds_tabela = trim(prm_nome_id);

		htp.p('OK|Lista alterada com sucesso!');
	end if;

	commit;

end update_cdesc;

procedure update_nr_ordem_select(prm_nome_id varchar2 default null,
					   prm_conteudo varchar2 default null) as

	ws_count integer;

begin

	select count(*) into ws_count
	from CODIGO_DESCRICAO 
	where nds_tabela = trim(prm_nome_id);

	if ws_count > 0 then
		update CODIGO_DESCRICAO
		set nr_ordem_select = prm_conteudo
		where nds_tabela = trim(prm_nome_id);

		htp.p('OK|Lista alterada com sucesso!');
	end if;

	commit;

end update_nr_ordem_select;


/* Lista de Variavel Padrão */


procedure list_sinal as

	cursor crs_sinal is
	select cd_sinal, ds_sinal, tp_sinal, fx_01, fx_02, fx_03, fx_04, fx_05
	from SINAIS order by cd_sinal asc;

	ws_sinal	crs_sinal%rowtype;

	cursor crs_colunas is
	select t1.cd_usuario, decode(t1.cd_usuario,'DWU','TODOS',t1.cd_usuario) nm_usuario, t2.cod, t1.cd_objeto, t2.nm_objeto, t1.cd_coluna, t1.cd_sinal/*, fun.utranslate('CD_SINAL', 'SINAIS', t1.cd_sinal) as sinal*/
	from sinal_coluna t1
	left join objetos t2
	on t2.cd_objeto = t1.cd_objeto
	order by cd_coluna asc;

	ws_coluna crs_colunas%rowtype;

	ws_count    number;
	ws_padrao   varchar2(80) := 'PORTUGUESE';
	ws_usuario  varchar2(80);
	ws_noaccess exception;

begin
	/*fcl.refresh_Session;*/

	ws_usuario := gbl.getUsuario;

	if ws_usuario = 'NOUSER' or gbl.getNivel <> 'A' then
		raise ws_noaccess;
	end if;

	begin
		select CONTEUDO into ws_padrao
		from   PARAMETRO_USUARIO
		where  cd_usuario = ws_usuario and
			cd_padrao='CD_LINGUAGEM';
	exception
		when others then
			ws_padrao := 'PORTUGUESE';
	end;
	
	htp.p('<ul style="display: flex; flex-flow: row; flex-wrap: wrap;">');
	
		htp.p('<li style="flex-basis: 100%; display: flex; flex-flow: row wrap;">');
	
			htp.p('<h2 style="width: 100%;">'||fun.lang('LISTA DE SINALIZADORES')||'</h2>');

			htp.p('<table class="linha"><thead>');
			htp.p('<tr>');
				htp.p('<th>'||fun.lang('SINAL')||'</th>');
				htp.p('<th>'||fun.lang('DESCRI&Ccedil;&Atilde;O')||'</th>');
				htp.p('<th>'||fun.lang('IMAGEM')||'</th>');
				htp.p('<th>'||fun.lang('FAIXA 1')||'</th>');
				htp.p('<th>'||fun.lang('FAIXA 2')||'</th>');
				htp.p('<th>'||fun.lang('FAIXA 3')||'</th>');
				htp.p('<th>'||fun.lang('FAIXA 4')||'</th>');
				htp.p('<th>'||fun.lang('FAIXA 5')||'</th>');
				htp.p('<th></th>');
			htp.p('</tr>');
			htp.p('</thead><tbody>');

			open crs_sinal;
				loop
					fetch crs_sinal into ws_sinal;
					exit when crs_sinal%notfound;
					htp.p('<tr>');
						htp.p('<td><span id="'||ws_sinal.cd_sinal||'_sinal" title="'||ws_sinal.cd_sinal||'">'||fun.utranslate('CD_SINAL', 'SINAIS', ws_sinal.cd_sinal, ws_padrao)||'</span><a style="margin-left: 3px;" class="fakelang" onclick="fakeLang(this.previousElementSibling.id, ''SINAIS|CD_SINAL|''+this.previousElementSibling.title, ''cd'');">L</a></td>');
						htp.p('<td><span id="'||ws_sinal.cd_sinal||'_desc" title="'||ws_sinal.ds_sinal||'">'||fun.utranslate('DS_SINAL', 'SINAIS', ws_sinal.ds_sinal, ws_padrao)||'</span><a style="margin-left: 3px;" class="fakelang" onclick="fakeLang('''||ws_sinal.cd_sinal||'_desc'', ''SINAIS|DS_SINAL|''+this.previousElementSibling.title);">L</a></td>');
						htp.p('<td>');
							htp.p('<a class="script" onclick="call(''update_sinal'', ''prm_sinal='||ws_sinal.cd_sinal||'&prm_tipo=tp_sinal&prm_valor=''+this.nextElementSibling.title).then(function(resposta){ if(resposta.indexOf(''fail'') == -1){ alerta('''', TR_AL); } else { alerta('''', TR_ER); } });"></a>');
							if ws_sinal.tp_sinal is null then 
								fcl.fakeoption(''||ws_sinal.cd_sinal||'_fake', 'Escolha os icones', ws_sinal.tp_sinal, 'lista-sinais-opcoes', 'N', 'N', prm_desc => '' );
							else 
								fcl.fakeoption(''||ws_sinal.cd_sinal||'_fake', 'Escolha os icones', ws_sinal.tp_sinal, 'lista-sinais-opcoes', 'N', 'N', prm_desc => htf.img(fun.r_gif('ind'||ws_sinal.tp_sinal||'_1', 'PNG' ))||htf.img(fun.r_gif('ind'||ws_sinal.tp_sinal||'_2', 'PNG' ))||htf.img(fun.r_gif('ind'||ws_sinal.tp_sinal||'_3', 'PNG' ))||htf.img(fun.r_gif('ind'||ws_sinal.tp_sinal||'_4', 'PNG' ))||htf.img(fun.r_gif('ind'||ws_sinal.tp_sinal||'_5', 'PNG' )));								
							end if; 	
						htp.p('</td>');
						htp.p('<td><input type="text" maxlength="40" value="'||ws_sinal.fx_01||'" onblur="call(''update_sinal'', ''prm_sinal='||ws_sinal.cd_sinal||'&prm_tipo=fx_01&prm_valor=''+this.value).then(function(resposta){ if(resposta.indexOf(''fail'') == -1){ alerta('''', TR_AL); } else { alerta('''', TR_ER); } });"></td>');
						htp.p('<td><input type="text" maxlength="40" value="'||ws_sinal.fx_02||'" onblur="call(''update_sinal'', ''prm_sinal='||ws_sinal.cd_sinal||'&prm_tipo=fx_02&prm_valor=''+this.value).then(function(resposta){ if(resposta.indexOf(''fail'') == -1){ alerta('''', TR_AL); } else { alerta('''', TR_ER); } });"></td>');
						htp.p('<td><input type="text" maxlength="40" value="'||ws_sinal.fx_03||'" onblur="call(''update_sinal'', ''prm_sinal='||ws_sinal.cd_sinal||'&prm_tipo=fx_03&prm_valor=''+this.value).then(function(resposta){ if(resposta.indexOf(''fail'') == -1){ alerta('''', TR_AL); } else { alerta('''', TR_ER); } });"></td>');
						htp.p('<td><input type="text" maxlength="40" value="'||ws_sinal.fx_04||'" onblur="call(''update_sinal'', ''prm_sinal='||ws_sinal.cd_sinal||'&prm_tipo=fx_04&prm_valor=''+this.value).then(function(resposta){ if(resposta.indexOf(''fail'') == -1){ alerta('''', TR_AL); } else { alerta('''', TR_ER); } });"></td>');
						htp.p('<td><input type="text" maxlength="40" value="'||ws_sinal.fx_05||'" onblur="call(''update_sinal'', ''prm_sinal='||ws_sinal.cd_sinal||'&prm_tipo=fx_05&prm_valor=''+this.value).then(function(resposta){ if(resposta.indexOf(''fail'') == -1){ alerta('''', TR_AL); } else { alerta('''', TR_ER); } });"></td>');
						
						select count(*) into ws_count 
						from sinal_coluna t1
						where cd_sinal = ws_sinal.cd_sinal; 

						if ws_count = 0 then
							htp.p('<td><a class="remove" title="'||fun.lang('Excluir')||'" onclick="if(confirm(TR_CE)){ var row = this.parentNode.parentNode; row.classList.add(''removing''); call(''dl_sn'', ''ws_par_sumary='||ws_sinal.cd_sinal||''').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ row.remove(); alerta(''feed-fixo'', TR_EX); } else { row.classList.remove(''removing''); alerta(''feed-fixo'', resposta.replace(''FAIL '','''')); } }); }">X</a></td>');
						else
							htp.p('<td><a class="noremove" title="'||fun.lang('Imposs&iacute;vel Excluir')||'">X</a></td>');
						end if;
					htp.p('</tr>');
				end loop;
			close crs_sinal;

			htp.p('</tbody>');
			htp.p('<tbody id="ajax_sinal"></tbody>');
			htp.p('</table>');

		htp.p('</li>');
		
		htp.p('<li style="flex-basis: 100%; display: flex; flex-flow: row wrap;">');	
			htp.p('<h2 style="width: 100%;">'||fun.lang('COLUNAS COM SINALIZADORES')||'</h2>');
				
				htp.p('<table class="linha"><tbody>');
				htp.p('<tr>');
					htp.p('<th>'||fun.lang('USU&Aacute;RIO')||'</th>');
					htp.p('<th>'||fun.lang('OBJETO')||'</th>');
					htp.p('<th>'||fun.lang('COLUNA')||'</th>');
					htp.p('<th>'||fun.lang('SINAL')||'</th>');
					htp.p('<th></th>');
				htp.p('</tr>');
				open crs_colunas;
					loop
						fetch crs_colunas into ws_coluna;
						exit when crs_colunas%notfound;
							htp.p('<tr>');
								htp.p('<td>'||ws_coluna.nm_usuario||'</td>');
								htp.p('<td>'||nvl(ws_coluna.cod, ws_coluna.cd_objeto)||' - '||ws_coluna.nm_objeto||'</td>');
								htp.p('<td>'||ws_coluna.cd_coluna||'</td>');
								htp.p('<td>'||fun.utranslate('CD_SINAL', 'SINAIS', ws_coluna.cd_sinal, ws_padrao)||'</td>');
								
								htp.p('<td>');
									fcl.button_lixo('delete_csinal','d_usuario|d_pa|d_coluna|d_sinal', trim(ws_coluna.cd_usuario)||'|'||ws_coluna.cd_objeto||'|'||ws_coluna.cd_coluna||'|'||ws_coluna.cd_sinal);
								htp.p('</td>');
								
								--htp.p('<td><a class="remove" onclick="if(confirm(TR_CE)){ var row = this.parentNode.parentNode; row.classList.add(''removing''); call(''delete_csinal'', ''d_usuario='||trim(ws_coluna.cd_usuario)||'&d_pa='||ws_coluna.cd_objeto||'&d_coluna='||ws_coluna.cd_coluna||'&d_sinal='||ws_coluna.cd_sinal||''').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ row.remove(); alerta(''feed-fixo'', TR_EX); } else { row.classList.remove(''removing''); alerta(''feed-fixo'', TR_ER); } }); }" title="'||fun.lang('Excluir')||'">X</td>');
							htp.p('</tr>');
					end loop;
				close crs_colunas;
			htp.p('</tbody>');
			htp.p('<tbody id="ajax_csinal">');
			htp.p('</tbody>');
			htp.p('</table>');
		
		htp.p('</li>');
		
	htp.p('</ul>');
exception
	when ws_noaccess then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end list_sinal;


procedure save_sinal ( par_name   varchar2 default 'Novo',
					par_nameds varchar2 default null,
					par_sinais number   default 1) as
					
	ws_count     number;
	ws_cd_sinal  varchar2(800);
	ws_ds_sinal  varchar2(800);
	ws_msg       varchar2(200); 
	ws_fail      exception;
begin
	
	ws_cd_sinal := upper(trim(fun.converte(par_name)));
	ws_ds_sinal := trim(fun.converte(par_nameds));
	
	select count(*) into ws_count 
	from SINAIS 
	where cd_sinal = ws_cd_sinal; 
	if ws_count > 0 then 
		ws_msg := 'FAIL DUPLICADO Sinalizador j&aacute; existente';
		raise ws_fail;
	end if; 

	insert into SINAIS (cd_sinal,    ds_sinal,    tp_sinal,  fx_01, fx_02, fx_03, fx_04, fx_05) 
				values (ws_cd_sinal, ws_ds_sinal, par_sinais, '', '', '', '', '');
	ws_count := SQL%ROWCOUNT;
	if ws_count <> 0 then
		commit;
	else
		ws_msg := 'FAIL';
		raise ws_fail;
	end if;
	
	insert into traducao_colunas values ('SINAIS', 'CD_SINAL', fun.ret_var('LANG_SYS'), ws_cd_sinal, ws_cd_sinal, 'T', 'N');
	insert into traducao_colunas values ('SINAIS', 'DS_SINAL', fun.ret_var('LANG_SYS'), ws_ds_sinal, ws_ds_sinal, 'T', 'N');

exception
	when ws_fail then
		htp.p(ws_msg);
	when others then
		htp.p('FAIL');
end save_sinal;

procedure delete_csinal( d_usuario varchar2 default null,
						d_pa varchar2 default null,
						d_coluna varchar2 default null,
						d_sinal varchar2 default null ) as

	ws_count number;

begin
	/*fcl.refresh_Session;*/
	select count(*) into ws_count from sinal_coluna where d_usuario = cd_usuario and d_pa = cd_objeto and d_coluna = cd_coluna and d_sinal = cd_sinal;
	if ws_count = 1 then
		delete from sinal_coluna where d_usuario = cd_usuario and d_pa = cd_objeto and d_coluna = cd_coluna and d_sinal = cd_sinal;
	elsif ws_count > 1 then
		htp.p('#alert '||fun.lang('Impossivel excluir, valor duplicado')||'!');
	else
		htp.p('#alert '||fun.lang('Impossivel excluir, valor inexistente')||'!');
	end if;

	exception when others then
	htp.p(''||fun.lang('Sinal de coluna n&atilde;o foi excluido')||'.');

end delete_csinal;

procedure insert_csinal ( i_usuario varchar2 default null,
						i_pa      varchar2 default null,
						i_coluna  varchar2 default null,
						i_sinal   varchar2 default null ) as
	ws_count number;
	ws_fail  exception;
begin
	/*fcl.refresh_Session;*/
	select count(*) into ws_count from sinal_coluna where cd_usuario = trim(i_usuario) and cd_objeto = trim(i_pa) and cd_coluna = trim(i_coluna);
	if ws_count = 0 then
		insert into sinal_coluna values(trim(i_usuario), trim(i_pa), trim(i_coluna), trim(i_sinal));
	end if;
	
	ws_count := SQL%ROWCOUNT;
	
	if ws_count <> 0 then
		commit;
	else
		raise ws_fail;
	end if;

exception 
	when ws_fail then
		htp.p('FAIL');
	when others then
		htp.p('FAIL');
end insert_csinal;



procedure list_mapa_marcador (prm_order varchar2 default 'NR_ORDEM',
							prm_dir   varchar2 default '1' ) as 

	cursor c_marca is select * from bi_mapa_marcador t order by nr_ordem ; 

	type type_marca	is table of	bi_mapa_marcador%ROWTYPE index by pls_integer;
	
	wr_marca            type_marca;

	ws_count        	number;
	ws_checked      	varchar2(20); 
	ws_onkeypress  		varchar2(300); 
	ws_onkeypress_int   varchar2(300); 
	ws_onkeypress_num   varchar2(300); 				
	ws_onblur       	varchar2(300); 
	ws_onchange         varchar2(500); 
	ws_onclick          varchar2(500); 
	ws_classe           varchar2(20); 
	ws_disabled_dwu 	varchar2(15); 	
	ws_disabled_svg 	varchar2(15); 
	ws_disabled_img 	varchar2(15); 
	ws_id_marcador  	varchar2(100); 
	ws_svg_scale        varchar2(20);
	ws_svg_fillopacity  varchar2(20); 
	ws_style_cor        varchar2(50); 
	ws_style_cor2       varchar2(50); 

	ws_style_fillcolor    varchar2(50); 
	ws_style_fillopacity  varchar2(50); 
	ws_style_rotate       varchar2(50); 
	ws_style_scale        varchar2(50); 
	ws_style_svg	      varchar2(200);
	ws_img                varchar2(32000); 
	ws_tipo_img           varchar2(15); 
	ws_order              varchar2(200); 
	ws_style              varchar2(30); 
	ws_style2             varchar2(30);   
	ws_dir                number; 
	ws_usuario  varchar2(80);
	ws_noaccess exception;

begin
	ws_usuario := gbl.getUsuario;
	if ws_usuario = 'NOUSER' or gbl.getNivel <> 'A' then
		raise ws_noaccess;
	end if;

	ws_order := prm_order;
	if nvl(prm_dir,'1') <> '1' then 
		ws_order := ws_order||' desc ' ;
	end if;	
	EXECUTE IMMEDIATE 'SELECT * FROM  bi_mapa_marcador order by '||ws_order BULK COLLECT INTO wr_marca;

	ws_onclick := ' onclick="var dir = order('''', ''list_mapa_marcador''); ajax(''list'', ''list_mapa_marcador'', ''prm_order=''+this.getAttribute(''data-col'')+''&prm_dir=''+dir, false, ''content'');" '; 
	ws_style   := 'style="width:';
	ws_style2  := 'px !important;"'; 

	htp.p('<ul style="display: flex; flex-flow: row; flex-wrap: wrap;">');
	
		htp.p('<li style="flex-basis: 100%; display: flex; flex-flow: row wrap;">');
	
			htp.p('<table class="linha">'); 
			htp.p('<thead>');

			htp.p('<tr>');
				htp.p('<th class="red" '||ws_style||'110'||ws_style2||ws_onclick||' data-col="cd_marcador"    title="C&oacute;digo do marcador."    >'||fun.lang('C&Oacute;DIGO')||'</th>');
				htp.p('<th class="red" '||ws_style||'180'||ws_style2||ws_onclick||' data-col="ds_marcador"    title="Descri&ccedil;&atilde;o do marcador" >'||fun.lang('DESCRI&Ccedil;&Atilde;O')||'</th>');
				htp.p('<th class="red" '||ws_style||' 50'||ws_style2||ws_onclick||' data-col="nr_ordem"       title="Ordem de exibi&ccedil;&atilde;oo do marcador na tela."    >'||fun.lang('ORDEM')||'</th>');
				htp.p('<th class="red" '||ws_style||'100'||ws_style2||ws_onclick||' data-col="label_color"    title="Cor da fonte do label do marcador."    >'||fun.lang('COR FONTE')||'</th>');
				htp.p('<th class="red" '||ws_style||' 70'||ws_style2||ws_onclick||' data-col="label_fontsize" title="Tamanho da fonte do label em Pixels." >'||fun.lang('TAM.FONTE')||'</th>');
				htp.p('<th class="red" '||ws_style||' 70'||ws_style2||ws_onclick||' data-col="label_fontweight" title="Fonte do label em negrito.">'||fun.lang('NEGRITO')||'</th>');
				htp.p('<th             '||ws_style||' 80'||ws_style2||' title="Tipo de imagem do marcador.">'      ||fun.lang('TIPO')||'</th>');
				htp.p('<th             '||ws_style||'100'||ws_style2||' title="Exemplo da imagem do marcador.">'   ||fun.lang('IMAGEM')||'</th>');
				htp.p('<th class="red" '||ws_style||'100'||ws_style2||ws_onclick||' data-col="svg_path"        title="Vetor/Path que representa a imagem SVG"  >'||fun.lang('PATH SVG')||'</th>');
				htp.p('<th class="red" '||ws_style||'120'||ws_style2||ws_onclick||' data-col="svg_fillcolor"   title="Cor da imagem SVG.">'||fun.lang('COR DO SVG')||'</th>');
				htp.p('<th class="red" '||ws_style||' 50'||ws_style2||ws_onclick||' data-col="svg_fillopacity" title="Opacidade da imagem SVG, informar valor de 0 a 1, exemplo: 0,5">'||fun.lang('OPAC.')||'</th>');
				htp.p('<th class="red" '||ws_style||' 50'||ws_style2||ws_onclick||' data-col="svg_scale"       title="Tamanho da imagem SVG.">'||fun.lang('ESCALA')||'</th>');
				htp.p('<th class="red" '||ws_style||' 50'||ws_style2||ws_onclick||' data-col="svg_rotation"    title="Rotação em graus da imagem SVG.">'||fun.lang('ROTA&Ccedil;&Atilde;O')||'</th>');
				htp.p('<th class="red" '||ws_style||'150'||ws_style2||ws_onclick||' data-col="img_url"         title="URL do arquivo da imagem, se a imagem j&aacute; existir no BI basta colocar o nome do arquivo.">'||fun.lang('ARQUIVO IMG')||'</th>');
				htp.p('<th class="red" '||ws_style||' 50'||ws_style2||ws_onclick||' data-col="img_height"      title="Altura da imagem.">'||fun.lang('ALT.IMG')||'</th>');
				htp.p('<th class="red" '||ws_style||' 50'||ws_style2||ws_onclick||' data-col="img_width"       title="c da imagem.">'||fun.lang('LARG.IMG')||'</th>');
				htp.p('<th></th>');
			htp.p('</tr>');

			htp.p('</thead>');

			ws_dir := 1;
			if to_number(prm_dir) = 1 then
				ws_dir := 2;
			end if;

			htp.p('<tbody id="list_mapa_marcador" data-dir="'||ws_dir||'">');

			ws_onkeypress     := ' onkeypress="proxCampo(event,this);"'; 
			ws_onkeypress_int := ' onkeypress="if(!input(event, ''integer'')) {event.preventDefault();} else {proxCampo(event,this);}"'; 
			ws_onkeypress_num := ' onkeypress="if(!input(event, ''number'')) {event.preventDefault();} else {proxCampo(event,this);}"'; 			
			ws_style_cor      := ' style="min-width: 15px; margin-left: 5px;" '; 
			ws_style_cor2     := ' style="min-width:30px; width: 70px !important;" '; 

			--for a in c_marca loop 
			for i in 1 .. wr_marca.COUNT loop 

				ws_disabled_dwu := ''; 
				if wr_marca(i).nm_usuario = 'DWU' then 
					ws_disabled_dwu := ' disabled ';
					ws_classe       := ' '; 
					ws_onblur       := ''; 
					ws_onchange     := ''; 
					ws_onclick      := ''; 
				else 
					ws_classe       := ' editable '; 
					ws_onblur       := ' onblur="marcadorEvent(''onblur'', this, '''  ||wr_marca(i).cd_marcador||''');" '; 
					ws_onchange     := ' onchange="marcadorEvent(''onblur'', this, '''||wr_marca(i).cd_marcador||''');" '; 
					ws_onclick      := ' onclick="marcadorEvent(''onblur'', this, ''' ||wr_marca(i).cd_marcador||''');" '; 
				end if; 


				ws_id_marcador     := replace(replace(wr_marca(i).cd_marcador,' ',''),'-','');
				ws_svg_fillopacity := replace(wr_marca(i).svg_fillopacity,'.',',');  
				if substr(ws_svg_fillopacity,1,1) = ',' then 
					ws_svg_fillopacity := '0'||ws_svg_fillopacity; 
				end if;

				ws_svg_scale       := replace(wr_marca(i).svg_scale,'.',',');  
				if substr(ws_svg_scale,1,1) = ',' then 
					ws_svg_scale := '0'||ws_svg_scale; 
				end if;


				if wr_marca(i).nm_usuario = 'DWU' then 
					htp.p('<tr class="desabilitado">');
				else 
					htp.p('<tr>');
				end if; 		
					htp.p('<td><input type="text" disabled   value="'||wr_marca(i).cd_marcador||'"/></td>');
					htp.p('<td><input type="text"   '||ws_disabled_dwu||' class="'||ws_classe||'"                value="'||wr_marca(i).ds_marcador       ||'" data-ant="'||wr_marca(i).ds_marcador     ||'" data-coluna="ds_marcador" ' ||ws_onblur||' '||ws_onkeypress||'/></td>');
					htp.p('<td><input type="number" '||ws_disabled_dwu||' class="'||ws_classe||'"  min="0"       value="'||wr_marca(i).nr_ordem          ||'" data-ant="'||wr_marca(i).nr_ordem        ||'" data-coluna="nr_ordem" '    ||ws_onblur||' '||ws_onkeypress_int||'/></td>');
					htp.p('<td>');
						htp.p('<input type="color"  '||ws_disabled_dwu||' class="'||ws_classe||'" '||ws_style_cor|| ' value="'||wr_marca(i).label_color       ||'" data-ant="'||wr_marca(i).label_color     ||'" data-coluna="label_color" '||ws_onchange||' '||ws_onkeypress||'/>');						
						htp.p('<input type="text"   '||ws_disabled_dwu||' class="'||ws_classe||'" '||ws_style_cor2||' value="'||wr_marca(i).label_color       ||'" data-ant="'||wr_marca(i).label_color     ||'" data-coluna="label_color" '||ws_onblur  ||' '||ws_onkeypress||'/>');						
					htp.p('</td>');
					htp.p('<td><input type="text"  '||ws_disabled_dwu||' class="'||ws_classe||'"                value="'||wr_marca(i).label_fontsize    ||'" data-ant="'||wr_marca(i).label_fontsize  ||'" data-coluna="label_fontsize" '||ws_onblur||' '||ws_onkeypress_int||'/></td>');

					ws_checked := null; 
					if wr_marca(i).label_fontweight is not null then 
						ws_checked := ' checked ';
					end if; 	
					htp.p('<td><input type="checkbox" '||ws_disabled_dwu||' '||ws_checked||' value="'||wr_marca(i).label_fontweight||'"  data-ant="'||wr_marca(i).label_fontweight||'" data-coluna="label_fontweight" '||ws_onchange||' /></td>');										

					-- Monta a imagem SVG ou arquivo 
					ws_disabled_img := '';
					ws_disabled_svg := '';
					ws_img          := ''; 					
					if wr_marca(i).img_url is not null then 
						ws_tipo_img     := 'ARQ'; 
						ws_disabled_svg := ' disabled ';
						ws_img          := wr_marca(i).img_url;
						if upper(wr_marca(i).img_url) not like '%HTTP%' then 
							ws_img := nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download?arquivo='||wr_marca(i).img_url; 
						end if; 				
						ws_img := '<img src="'||ws_img||'">'; 
					else 
						ws_tipo_img           := 'SVG';
						ws_disabled_img       := ' disabled ';
						ws_style_fillcolor    := '';
						ws_style_fillopacity  := '';
						ws_style_rotate       := '';
						ws_style_scale        := '';
						ws_style_svg          := ''; 
						--
						if wr_marca(i).svg_path is not null then  
							if wr_marca(i).svg_fillcolor   is not null then     ws_style_fillcolor   := ' fill:'||wr_marca(i).svg_fillcolor||' ';                end if; 
							if wr_marca(i).svg_fillopacity is not null then     ws_style_fillopacity := ' fill-opacity:'||wr_marca(i).svg_fillopacity||' ';     end if; 
							if wr_marca(i).svg_rotation    is not null then     ws_style_rotate      := ' rotate('||wr_marca(i).svg_rotation||'deg) ';           end if;
							
							ws_style_svg := 'style="'||ws_style_fillcolor||';'||ws_style_fillopacity||';transform:'||ws_style_rotate||' '||ws_style_scale||';"'; 
							ws_img := '<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" '||
											'viewBox="0 0 160 160" '||ws_style_svg||'> <path d="'||wr_marca(i).svg_path||'"/></svg>' ; 
						end if;
					end if; 	

					htp.p('<td><input id="td_tipo_svg" type="text" disabled value="'||ws_tipo_img||'"/></td>');
					htp.p('<td classe="svg_imagem_marcador">'||ws_img||'</td>'); 


					htp.p('<td><input id="td_input_svg_path" type="text" '||ws_disabled_dwu||' '||ws_disabled_svg||' class="'||ws_classe||'" value="'||wr_marca(i).svg_path          ||'" data-ant="'||wr_marca(i).svg_path        ||'" data-coluna="svg_path" '       ||'" '||ws_onblur||' '||ws_onkeypress||'/></td>');
					htp.p('<td>');
						htp.p('<input type="color" '||ws_disabled_dwu||' '||ws_disabled_svg||' class="'||ws_classe||'" '||ws_style_cor|| ' value="'||wr_marca(i).svg_fillcolor ||'" data-ant="'||wr_marca(i).svg_fillcolor ||'" data-coluna="svg_fillcolor" '||ws_onchange||' '||ws_onkeypress||'/>');						
						htp.p('<input type="text"  '||ws_disabled_dwu||' '||ws_disabled_svg||' class="'||ws_classe||'" '||ws_style_cor2||' value="'||wr_marca(i).svg_fillcolor ||'" data-ant="'||wr_marca(i).svg_fillcolor ||'" data-coluna="svg_fillcolor" '||ws_onblur  ||' '||ws_onkeypress||'/>');						
					htp.p('</td>');

					htp.p('<td><input type="text" '||ws_disabled_dwu||' '||ws_disabled_svg||' class="'||ws_classe||'" value="'||ws_svg_fillopacity       ||'" data-ant="'||ws_svg_fillopacity||'" data-coluna="svg_fillopacity" '||ws_onblur||' '||ws_onkeypress_num||'/></td>');
					htp.p('<td><input type="text" '||ws_disabled_dwu||' '||ws_disabled_svg||' class="'||ws_classe||'" value="'||ws_svg_scale             ||'" data-ant="'||ws_svg_scale      ||'" data-coluna="svg_scale" '      ||ws_onblur||' '||ws_onkeypress_num||'/></td>');
					htp.p('<td><input type="text" '||ws_disabled_dwu||' '||ws_disabled_svg||' class="'||ws_classe||'" value="'||wr_marca(i).svg_rotation ||'" data-ant="'||wr_marca(i).svg_rotation    ||'" data-coluna="svg_rotation" '   ||ws_onblur||' '||ws_onkeypress_int||'/></td>');

					if wr_marca(i).nm_usuario = 'DWU' or wr_marca(i).img_url is null then
						htp.p('<td><input type="text" disabled  class="'||ws_classe||'" value="'||wr_marca(i).img_url  ||'" data-coluna="svg_rotation" /></td>');
					else 	
						htp.p('<td class="fake-list">');
							htp.p('<a class="script" onclick="marcadorEvent(''onblur'', this, '''||wr_marca(i).cd_marcador||''');"></a>');
							fcl.fakeoption('prm_img_url_'||ws_id_marcador||'', 'Imagem', wr_marca(i).img_url, 'lista-arquivo-imagem', 'N', 'N', prm_min => 1, prm_adicional => 'IMG_URL');
						htp.p('</td>');
					end if; 

					htp.p('<td><input type="text" '||ws_disabled_dwu||' '||ws_disabled_img||' class="'||ws_classe||'" value="'||wr_marca(i).img_height        ||'" data-ant="'||wr_marca(i).img_height      ||'" data-coluna="img_height" '     ||ws_onblur||' '||ws_onkeypress_int||'/></td>');
					htp.p('<td><input type="text" '||ws_disabled_dwu||' '||ws_disabled_img||' class="'||ws_classe||'" value="'||wr_marca(i).img_width         ||'" data-ant="'||wr_marca(i).img_width       ||'" data-coluna="img_width" '      ||ws_onblur||' '||ws_onkeypress_int||'/></td>');

					select count(*) into ws_count 
					from object_attrib 
					where cd_prop               = 'MARKER_STYLE'
					and nvl(propriedade,'NA') = wr_marca(i).cd_marcador; 

					if ws_count > 0 or wr_marca(i).nm_usuario = 'DWU' then
						htp.p('<td><a class="noremove" title="'||fun.lang('Exclus&atilde;o n&atilde;o permitida.')||'">X</a></td>');
					else
						htp.p('<td><a class="remove" title="'||fun.lang('Excluir')||'" onclick="marcadorEvent(''remove'', this, '''||wr_marca(i).cd_marcador||''');">X</a></td>');
					end if;

				htp.p('</tr>');

			end loop;

			htp.p('</tbody>');
			htp.p('</table>');

		htp.p('</li>');
	htp.p('</ul>');
exception
	when ws_noaccess then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end list_mapa_marcador;




procedure update_mapa_marcador ( prm_chave     varchar2 default null,  
								prm_campo     varchar2 default null,
								prm_conteudo  varchar2 default null) as
	ws_comando     varchar2(300); 
	ws_ds_erro     varchar2(200);
	ws_ds_erro_2   varchar2(500); 
	ws_usuario     varchar2(100); 
	ws_conteudo    varchar2(32000); 
	ws_conteudo_n  number; 

	ws_raise_erro exception; 
begin 
	--
	ws_usuario := gbl.getUsuario;
	if ws_usuario = 'NOUSER' or gbl.getNivel <> 'A' then
		ws_ds_erro := 'Sem permiss&atilde;o!'; 
		raise ws_raise_erro;
	end if;
	--
	ws_conteudo := trim(prm_conteudo); 
	ws_comando  := 'update '||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.bi_mapa_marcador set '||prm_campo||' = :b1 where cd_marcador = '''||prm_chave||''' '; 		
	begin 
		if upper(prm_campo) in ('LABEL_FONTSIZE', 'SVG_FILLOPACITY', 'SVG_STROKEOPACITY', 'SVG_SCALE', 'SVG_ROTATION', 'IMG_HEIGHT', 'IMG_WIDTH', 'NR_ORDEM') then 
			ws_conteudo_n := to_number(ws_conteudo,'999999999999999999D9999999999','NLS_NUMERIC_CHARACTERS='''||fun.ret_var('POINT')||''''); 
			execute immediate ws_comando using in ws_conteudo_n;
		else 
			execute immediate ws_comando using in ws_conteudo;
		end if; 	
		commit; 
	exception when others then 
		ws_ds_erro   := 'Erro atualizando registro, verifique log do sistema';
		ws_ds_erro_2 := substr(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE,1,3000); 	
		raise ws_raise_erro; 		
	end; 	
	--
	htp.p('OK|Marcador atualizado com sucesso|');
	--
	exception
		when ws_raise_erro then
			if ws_ds_erro_2 is not null then 
				insert into bi_log_sistema (dt_log, ds_log, nm_usuario, nm_procedure) values (sysdate, 'update_mapa_marcador:'||ws_ds_erro_2, ws_usuario, 'ERRO');			
				commit; 
			end if; 
			htp.p('ERRO|'||ws_ds_erro||'|');
		when others then
			ws_ds_erro := 'Erro na atualiza&ccedil;&atilde;o, verifique o log de erros';
			insert into bi_log_sistema (dt_log, ds_log, nm_usuario, nm_procedure) values (sysdate, 'update_mapa_marcador(others):'||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, ws_usuario, 'ERRO');
			commit;
			htp.p('ERRO|'||ws_ds_erro||'|');		
end update_mapa_marcador; 


procedure delete_mapa_marcador ( prm_chave     varchar2 default null) as

	ws_ds_erro     varchar2(200);
	ws_usuario     varchar2(100); 

	ws_raise_erro exception; 

begin 
	--
	ws_usuario := gbl.getUsuario;
	if ws_usuario = 'NOUSER' or gbl.getNivel <> 'A' then
		ws_ds_erro := 'Sem permiss&atilde;o!';
		raise ws_raise_erro;
	end if;
	--
	delete bi_mapa_marcador where cd_marcador = prm_chave; 
	--
	htp.p('OK|Marcador excluido com sucesso|');
	--
	exception
		when ws_raise_erro then
			htp.p('ERRO|'||ws_ds_erro||'|');
		when others then
			ws_ds_erro := 'Erro na atualiza&ccedil;&atilde;o, verifique o log de erros';
			insert into bi_log_sistema (dt_log, ds_log, nm_usuario, nm_procedure) values (sysdate, 'update_mapa_marcador(others):'||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, ws_usuario, 'ERRO');
			commit;
			htp.p('ERRO|'||ws_ds_erro||'|');		
end delete_mapa_marcador; 


procedure insert_mapa_marcador (prm_cd_marcador          varchar2 default null, 
								prm_ds_marcador          varchar2 default null,
								prm_label_fontfamily     varchar2 default null,
								prm_label_color          varchar2 default null,
								prm_label_fontsize       number   default null,
								prm_label_fontweight     varchar2 default null,
								prm_img_url              varchar2 default null,
								prm_svg_path             varchar2 default null,
								prm_svg_fillcolor        varchar2 default null,
								prm_svg_fillopacity      varchar2 default null,
								prm_svg_strokeopacity    number   default null,
								prm_svg_scale            varchar2 default null,
								prm_svg_rotation         number   default null,
								prm_img_height           number   default null,
								prm_img_width            number   default null,
								prm_nr_ordem             number   default null ) as
	ws_count       		 integer; 
	ws_ds_erro     		 varchar2(200);
	ws_usuario     		 varchar2(100); 
	ws_cd_marcador 		 varchar2(50); 

	ws_svg_path             varchar2(32000);
	ws_svg_fillcolor        varchar2(100);
	ws_svg_fillopacity      varchar2(100);
	ws_svg_strokeopacity    number;
	ws_svg_scale            number;
	ws_svg_rotation         number;
	ws_img_url              varchar2(100);
	ws_img_height           number;
	ws_img_width            number;

	ws_raise_erro exception; 
begin 
	--
	ws_usuario := gbl.getUsuario;
	if ws_usuario = 'NOUSER' or gbl.getNivel <> 'A' then
		ws_ds_erro := 'Sem permiss&atilde;o!';
		raise ws_raise_erro;
	end if;
	--
	if prm_nr_ordem	between 100 and 200 then 
		ws_ds_erro := 'Ordem deve ser menor que 100 ou maior que 200';
		raise ws_raise_erro;
	end if; 
	--
	ws_cd_marcador := upper(prm_cd_marcador); 
	select count(*) into ws_count from bi_mapa_marcador 
	where cd_marcador = ws_cd_marcador; 
	if ws_count > 0 then 
		ws_ds_erro := 'Marcador j&aacute; existe';
		raise ws_raise_erro;
	end if; 
	--
	begin 
		ws_svg_fillopacity := replace(prm_svg_fillopacity,',','.'); 
		ws_svg_scale       := replace(prm_svg_scale,',','.'); 
	exception when others then 
		ws_ds_erro := 'Erro, conte&uacute;do inv&aacute;lido para os campos OPACIDADE ou TAMANHO da imagem';
		raise ws_raise_erro;	
	end ;
	--
	ws_svg_path          := prm_svg_path         ;
	ws_svg_fillcolor     := prm_svg_fillcolor    ;  
	ws_svg_strokeopacity := prm_svg_strokeopacity;  
	ws_svg_rotation      := prm_svg_rotation     ;  
	ws_img_url           := prm_img_url          ;  
	ws_img_height        := prm_img_height       ;  
	ws_img_width         := prm_img_width        ;  
	-- 
	if ws_img_url is not null then 
		ws_svg_path          := null;
		ws_svg_fillcolor     := null;  
		ws_svg_strokeopacity := null;  
		ws_svg_rotation      := null;  
	else 
		ws_img_url           := null;  
		ws_img_height        := null;  
		ws_img_width         := null;  
	end if; 
	--
	insert into bi_mapa_marcador 
			( cd_marcador       , ds_marcador       , nr_ordem          , 
			label_fontfamily  , label_color       , label_fontsize    , label_fontweight  , 
			svg_path          , svg_fillcolor     , svg_fillopacity   , svg_strokeopacity , svg_scale         , svg_rotation      , 
			img_url           , img_height        , img_width         , nm_usuario        )
	values  ( ws_cd_marcador       , prm_ds_marcador      , prm_nr_ordem         , 
			prm_label_fontfamily , prm_label_color      , prm_label_fontsize   , prm_label_fontweight , 
			ws_svg_path          , ws_svg_fillcolor     , ws_svg_fillopacity   , ws_svg_strokeopacity ,  ws_svg_scale        , ws_svg_rotation     , 
			ws_img_url           , ws_img_height        , ws_img_width         , ws_usuario       ) ; 	  
	--
	htp.p('OK|Marcador inserido com sucesso|');
	--
	exception
		when ws_raise_erro then
			htp.p('ERRO|'||ws_ds_erro||'|');
		when others then
			ws_ds_erro := 'Erro inserindo marcador, verifique o log de erros';
			insert into bi_log_sistema (dt_log, ds_log, nm_usuario, nm_procedure) values (sysdate, 'insert_mapa_marcador(others):'||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, ws_usuario, 'ERRO');
			commit;
			htp.p('ERRO|'||ws_ds_erro||'|');		
end insert_mapa_marcador; 



procedure user_permissao_list (prm_usuario  varchar2 ) as 

	cursor c_permissao is 
		select * from user_permissao 
		 where cd_usuario = prm_usuario 
		order by cd_permissao;

	ws_usuario  varchar2(80);
	ws_noaccess exception;

begin
	ws_usuario := gbl.getUsuario;
	if ws_usuario = 'NOUSER' or (gbl.getNivel <> 'A' and fun.user_permissao(ws_usuario, 'TELAS_USUARIOS') <> 'S') then
		raise ws_noaccess;
	end if;


	htp.p('<ul style="display: flex; flex-flow: row; flex-wrap: wrap;">');
	
		htp.p('<li style="flex-basis: 100%; display: flex; flex-flow: row wrap;">');
	
			htp.p('<table class="linha">'); 
			htp.p('<thead>');

			htp.p('<tr>');
				htp.p('<th data-col="cd_permissao"    title="Identificador/C&oacute;digo do tipo de permiss&atilde;o." >'||fun.lang('PERMISS&Atilde;O')||'</th>');
				htp.p('<th data-col="ds_permissao"    title="Descri&ccedil;&aatilde;o da permiss&atilde;o."            >'||fun.lang('DESCRI&Ccedil;&Atilde;O PERMISS&Atilde;O')||'</th>');
				htp.p('<th data-col="dt_permissao"    title="Data de libera&ccedil;&atilde;o da permiss&atilde;o."     >'||fun.lang('LIBERA&Ccedil;&Atilde;O')||'</th>');
				htp.p('<th></th>');
			htp.p('</tr>');

			htp.p('</thead>');

			htp.p('<tbody id="ajax">');

				for a in c_permissao loop 
					htp.p('<tr>');
						htp.p('<td>'||a.cd_permissao||'</td>');
						htp.p('<td>'||fun.lista_padrao_ds('USER_PERMISSAO',a.cd_permissao)||'</td>');
						htp.p('<td>'||to_char(a.dt_permissao,'dd/mm/yyyy')||'</td>');					
						htp.p('<td>');
							fcl.button_lixo('user_permissao_delete','prm_usuario|prm_permissao', a.cd_usuario||'|'||a.cd_permissao, prm_tag => 'a', prm_pkg => 'FCL');
						htp.p('</td>');
					htp.p('</tr>');
				end loop;
			htp.p('</tbody>');
			htp.p('</table>');

		htp.p('</li>');
	htp.p('</ul>');

	htp.p('<div class="listar"><a onclick="carregaPainel(''usuarios'');  carrega(''list_users''); call_save(''''); document.getElementById(''titulo'').innerHTML = '''||fun.lang('Usu&aacute;rios')||''';">'||fun.lang('Listar usu&aacute;rios')||'</a></div>');

exception
	when ws_noaccess then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end user_permissao_list;

procedure user_permissao_insert (prm_usuario   varchar2,
                                 prm_permissao varchar2 ) as 

	ws_usuario  varchar2(80);
	ws_noaccess exception;

begin
	ws_usuario := gbl.getUsuario;
	if ws_usuario = 'NOUSER' or (gbl.getNivel <> 'A' and fun.user_permissao(ws_usuario, 'TELAS_USUARIOS') <> 'S') then
		raise ws_noaccess;
	end if;
	for a in (select column_value as permissao from table(fun.vpipe(prm_permissao)) where trim(column_value) is not null ) loop 
		begin 
			insert into  user_permissao (cd_usuario, cd_permissao, dt_permissao) values (prm_usuario, a.permissao, sysdate); 
		exception 
			when dup_val_on_index then -- Se já existe não faz nada 
				null;	
		end; 
	end loop; 

    htp.p('OK|Registro inserido com sucesso');

exception
	when ws_noaccess then
		htp.p('ERRO|sem permiss&atilde;o, fa&ccedil;a o login no sistema novamente');
	when others then
		htp.p('ERRO|Erro Inserido registro, verifique o log de erros do sistema');
		insert into bi_log_sistema values(sysdate, 'user_permissao_insert - '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, ws_usuario, 'ERRO');
		commit; 
end user_permissao_insert;


procedure user_permissao_delete (prm_usuario   varchar2,
                                 prm_permissao varchar2 ) as 
	ws_usuario  varchar2(80);
	ws_noaccess exception;
begin
	ws_usuario := gbl.getUsuario;
	if ws_usuario = 'NOUSER' or gbl.getNivel <> 'A' then
		raise ws_noaccess;
	end if;

	delete user_permissao where cd_usuario = prm_usuario and cd_permissao = prm_permissao;  

    htp.p('OK|Registro exclu&iacute;do com sucesso');

exception
	when ws_noaccess then
		htp.p('ERRO|sem permiss&atilde;o, fa&ccedil;a o login no sistema novamente');
	when others then
		htp.p('ERRO|Erro excluindo registro, verifique o log de erros do sistema');
		insert into bi_log_sistema values(sysdate, 'user_permissao_delete - '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, ws_usuario, 'ERRO');
		commit; 
end user_permissao_delete;



procedure float_menu ( prm_screen varchar2 default null ) as

	cursor crs_itens(prm_usuario varchar2, prm_admin varchar2) is
		select cd_objeto, cod, objetos.cd_grupo, nm_grupo, nm_objeto, nvl(cor_fundo,'#FFFFFF') cor_fundo, url_fundo, dispositivo,nvl(trim(or_grupo),objetos.cd_grupo) as or_grupo, nvl(trim(or_item),nm_objeto) as or_objeto
		  from OBJETOS, all_screens, GRUPOS_FUNCAO
		 where tp_objeto            = 'SCREEN' 
		   and all_screens.publico  = 'S' 
		   and cd_objeto            = screen(+) 
		   and objetos.cd_grupo     = grupos_funcao.cd_grupo 
		   and (prm_admin = 'A' 
					or	screen in (select screen from user_screens where usuario in (select cd_group from gusers_itens where cd_usuario = prm_usuario) 
					or usuario = prm_usuario)
					or objetos.cd_grupo in ( select screen from user_screens where usuario = prm_usuario )
				) 
	order by GRUPOS_FUNCAO.ordem, or_grupo, or_objeto;

	ws_itens	crs_itens%rowtype;

	ws_count	    		number		:= 0;
	ws_cgrupo	    		number		:= 0;
	ws_citem	    		number		:= 1;
	ws_ctn_usu				number      := 0;
	ws_grupo_ant    		varchar2(40)	:= 'FIRST_TIME';
	ws_size         		number;
	ws_show_only    		varchar2(1);
	ws_admin        		varchar2(80);
	ws_usuario      		varchar2(80);
	ws_padrao       		varchar2(80) := 'PORTUGUESE';
	ws_qt_tela_fav        	number; 
	ws_qt_aviso_sistema   	number;
	ws_qt_aviso_nao_lido  	number; 
	ws_count_obj			number;
	ws_count_dispositivo	number;
	ws_visibility         	varchar2(40); 
	ws_qt_abas            	integer;
	ws_geral_closed       	varchar2(10);
	ws_etl_closed         	varchar2(10);
	ws_usu_closed		  	varchar2(10);
	ws_class_green          varchar2(20); 
	ws_width                varchar2(10); 

begin

	ws_admin   := gbl.getNivel;
	ws_usuario := gbl.getUsuario;

	select count(*) into ws_qt_tela_fav
	from objetos obj,  favoritos  fav 
	where obj.cd_objeto = fav.cd_objeto 
	and obj.tp_objeto = 'SCREEN'
	and fav.usuario   = gbl.getUsuario;

	/*fcl.refresh_Session;*/
	select nvl(show_only, 'N') into ws_show_only from usuarios where usu_nome = ws_usuario;
	htp.p('<iframe onload="go = (this.contentWindow || this.contentDocument); if(go.document.body.innerHTML != ''''){ document.getElementById(''content'').innerHTML = go.document.body.innerHTML; go.document.body.innerHTML = ''''; this.src=''''; }" name="workarea" id="frame" class="frame"></iframe>');
	htp.p('<iframe onload="go = (this.contentWindow || this.contentDocument); if(go.document.body.innerHTML != ''''){ document.getElementById(''painel'').innerHTML = go.document.body.innerHTML; go.document.body.innerHTML = ''''; this.src=''''; }" name="workarea" id="newmenu" class="frame"></iframe>');
	htp.p('<iframe id="noload" class="frame" onload=""></iframe>');
	htp.p('<div id="layer2" onload="document.getElementsByTagName(''div'').style.visibility = ''hidden''"></div>');
	htp.p('<div id="layer3">');
	htp.p('</div>');

	htp.p('<a id="prev" onclick="cycle(document.querySelector(''.scaled'').id, ''prev'');" title="'||fun.lang('anterior')||'"><</a>');
	htp.p('<a id="next" onclick="cycle(document.querySelector(''.scaled'').id, ''next'');" title="'||fun.lang('pr&oacute;ximo')||'">></a>');

	htp.p('<div id="starting">');
		
		htp.p('<img style="margin-top: 11%; max-width: 44%;" src="'||fun.r_gif('logo_upquery','PNG')||'" />');
		--if instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'Safari/') <> 0 and instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'Chrome/') = 0 then
		--	htp.p('<img style="margin-top: 11%; max-width: 44%;" src="'||fun.r_gif('logo_upquery','JPG')||'" />');
		--else
		--	htp.p('<img style="margin-top: 11%; max-width: 44%;" src="'||fun.r_gif('logo_upquery','PNG')||'" />');
		--end if;

		htp.p('<small style="display: inline-block; font-size: 10px; width: 20px;">ver. ');
			htp.p(gbl.getVersion);
		htp.p('</small>');
		/*htp.p('<progress id="loading-bar" style="width: 600px; margin: 10px auto; display: block;" value="1" max="100"></progress>');*/

		htp.p('<div id="loading-bar">');
			htp.p('<div class="container-bar">');
				htp.p('<div class="progress-bar"></div>');
			htp.p('</div>');
		htp.p('</div>');

	htp.p('</div>');   -- fecha DIV starting


	htp.p('<div id="donut">');
		/*htp.p('<a class="circle" title="'||fun.lang('Recarregar sem cache')||'" onmousedown="window.location.reload(true);" ontouchstart="window.location.reload(true);"><img style="margin-top: 5px;" src="'||fun.r_gif('home','png')||'" /><span class="texto">PRINCIPAL</span></a>');
		htp.p('<a class="circle" title="'||fun.lang('Parametro')||'" onclick="loadAttrib(''get_float'', ''prm_screen=''+tela);"><span class="texto">FLOAT</span></a>');*/

		
		htp.p('<a class="circle" title="'||fun.lang('Sincronizar objetos da tela')||'" onmousedown="shscr(document.getElementById(''current_screen'').value);" ontouchend="shscr(document.getElementById(''current_screen'').value);">');
			htp.p('<img style="margin-top: 4px; margin-left: -1px;" src="'||fun.r_gif('sinchronize','png')||'" />');
			/*htp.p('<svg class="sync" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"viewBox="0 0 85.168 85.168" style="enable-background:new 0 0 85.168 85.168;" xml:space="preserve"> <g> <path d="M61.696,14.999l-4.126,4.457c8.806,5.774,13.923,16.353,12.184,27.41c-1.146,7.288-5.063,13.694-11.027,18.037 c-5.206,3.791-11.43,5.615-17.777,5.252l1.09-1.144c-0.021-0.001-0.044,0.002-0.065,0.001l4.129-4.332l-3.813-3.639l-8.188,8.596 l-0.002-0.003l-3.533,3.71l3.811,3.636l0.002-0.001l8.593,8.189l3.536-3.71l-5.565-5.302c7.616,0.36,15.066-1.853,21.315-6.403 c7.261-5.286,12.028-13.084,13.424-21.956C77.741,34.694,71.897,22.14,61.696,14.999z"/> <path d="M15.415,38.302c1.146-7.288,5.063-13.694,11.027-18.037c5.206-3.791,11.43-5.615,17.777-5.252l-1.09,1.144 c0.021,0.001,0.044-0.002,0.065-0.001l-4.129,4.332l3.813,3.639l8.188-8.596l0.002,0.003l3.533-3.71L50.79,8.188l-0.002,0.001 L42.195,0l-3.536,3.71l5.565,5.302c-7.616-0.36-15.066,1.853-21.315,6.403c-7.261,5.286-12.028,13.084-13.424,21.956 C7.425,50.475,13.27,63.029,23.47,70.17l4.126-4.457C18.793,59.937,13.676,49.359,15.415,38.302z"/> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');*/
			htp.p('<span class="texto">'||fun.lang('SINCRONIZAR')||'</span>');
		htp.p('</a>');
		
		/******* 04/07/2022 - Desativado botão de centralização ou não das Drills - Por padrão todas as Drills devem ser abertas no centro da tela
		select count(*) into ws_count from object_attrib where owner = ws_usuario and cd_prop = 'DRILL' and propriedade = 'CENTER';
		if ws_count = 1 then
			htp.p('<a class="circle" title="'||fun.lang('Centralizar drill ao abrir')||'" onmousedown="this.classList.toggle(''select''); ajax(''fly'', ''alter_value'', ''prm_object=DEFAULT&prm_prop=DRILL&prm_valor1=CENTER&prm_valor2=LADDER&prm_screen=DEFAULT''); " style="font-size: 26px;" >');
			htp.p('<span class="img">C</span>');
			htp.p('<span class="texto">'||fun.lang('CENTRO')||'</span>');
			htp.p('</a>');
		else
			htp.p('<a class="circle select" title="'||fun.lang('Centralizar drill ao abrir')||'" onmousedown="this.classList.toggle(''select''); ajax(''fly'', ''alter_value'', ''prm_object=DEFAULT&prm_prop=DRILL&prm_valor1=CENTER&prm_valor2=LADDER&prm_screen=DEFAULT''); " style="font-size: 26px;" >');
				htp.p('<span class="img">C</span>');
				htp.p('<span class="texto">'||fun.lang('CENTRO')||'</span>');
			htp.p('</a>');
		end if;
		******************/ 

		ws_count := 0;
		-- TELA DE FAVORITOS / FOI REMOVIDO O ICONE DE TELAS FAVORITADAS DENTRO DO MENU AO CLICKAR COM BOTÂO DIREITO NA TELA
			--htp.p('<a class="circle" title="'||fun.lang('Objetos favoritados')||'" onmousedown="let fun = function(){ ajax(''list'', ''favoritos'', ''prm_screen=''+tela, false, ''attriblist''); }; attReopen(fun, ''attriblist'');">'); 
			--htp.p('<span class="img" style="color: #333; font-size: 34px; text-shadow: 0 0 1px #000; left: calc(50% - 13px);">');
			--	htp.p('<svg style="height: 26px; width: 26px; margin-top: 4px; margin-left: 2px;" version="1.1" id="Camada_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 1280 1280" style="enable-background:new 0 0 1280 1280;" xml:space="preserve"><path d="M1247.7,595.5c-1-36.4-18.4-65.4-44.9-88.4c-31.3-27.2-69.4-34.9-110.4-34.7c-37.2,0.2-74.4,0.3-111.5,0.4c-2.3-55.1-1.5-170.3,0.9-192.3c1.6-14.8,4.4-29.3,8.7-43.4c8.2-26.5,22-51.6,44.7-74.8c12.9-13.1,21.5-79.5-40.8-76.3C944.3,85,894.1,84.2,844,83.8v-0.4c-50.1,0.4-100.3,1.2-150.4,2.3c-62.3-3.2-53.7,63.2-40.8,76.3c22.7,23.1,36.5,48.2,44.7,74.8c4.3,14.1,7.1,28.6,8.7,43.4c2.4,22,3.2,137.8,0.9,192.7c-2.5,0-5.1,0-7.6,0c-37.1,0.1-64.9-15.7-83.1-47.4c-17.7-30.8-33.3-62.8-51.5-93.3c-8.8-14.7-19.4-29.3-32.3-40.4c-29-24.8-63.8-35.2-102.1-34.8c-47.4,0.5-94.8,0.1-142.2,0.1c-36.1,0-72.3,0-108.4,0c-43.7,0-82,14.8-111,47.1c-22.1,24.5-33.7,54.5-33.6,88.9c0.4,238.4,0.4,476.8,0,715.2c-0.1,32.7,12,60,30,85.7c1.3,1.9,2.8,3.7,4.5,5.4c32.5,31.6,71.3,45.7,116.7,45.5c151.6-0.6,303.1-0.2,454.7-0.2c152.3,0,304.7,0,457-0.1c11.2,0,22.6-0.4,33.6-2.3c52.3-9.1,90.2-37.4,109.2-87.4c5.5-14.4,6.8-31.1,6.8-46.8c0.5-151.8,0.3-303.6,0.3-455.5C1247.9,633.6,1248.2,614.5,1247.7,595.5z M724,129h106h29h106c0,0,14-4,13,21s-38,66-42,92c-2.8,18.5-1.6,154-0.7,230.9l0,0c0,0.3,0,0.6,0,0.9c0,0.6,0,1.2,0,1.8c0,1.4,0,2.7,0,4c0,1.1,0,2.2,0,3.2c0,0.2,0,0.3,0,0.5c0,1.4,0,2.8,0.1,4.2c0,0.2,0,0.3,0,0.5c0,0.6,0,1.2,0,1.8c0,0,0,0.1,0,0.1c0,1.4,0,2.8,0.1,4.1c0,0.2,0,0.4,0,0.7c0,1.2,0,2.3,0,3.4c0,0.4,0,0.7,0,1.1c0,0.3,0,0.6,0,0.8c0,0.3,0,0.5,0,0.8c0,1.1,0,2.1,0,3.1c0,0.1,0,0.3,0,0.4c0,0.5,0,1,0,1.4c0,0.1,0,0.3,0,0.4c0,0.4,0,0.8,0,1.3c0,0.2,0,0.4,0,0.6c0,0.4,0,0.7,0,1.1c0,0.2,0,0.4,0,0.6c0,0.3,0,0.5,0,0.8c0,1.3,0,2.6,0.1,3.8c0,0.8,0,1.5,0,2.2c0,0,0,0,0,0.1c0,0.4,0,0.8,0,1.1c0,0.1,0,0.2,0,0.3c0,0.1,0,0.2,0,0.3c0,1.2,0,2.2,0,3.1c0,0.4,0,0.8,0,1.2c0,0,0,0.1,0,0.1c0,0.6,0,1.2,0,1.6c0,0.2,0,0.4,0,0.6l0,0c0,0.5,0,0.8,0,0.8L1063,661l15,25l-196,14.8l-37.5,2.4l-37.8-2.4L611,686l15-25l127-135.3c0,0,0-0.3,0-0.9l0,0c0-0.2,0-0.5,0-0.7c0-0.2,0-0.4,0-0.7c0-0.2,0-0.5,0-0.8c0-0.2,0-0.5,0-0.7c0-1,0-2.2,0.1-3.6c0-1,0-2,0-3.2c0-0.1,0-0.2,0-0.2c0-0.2,0-0.4,0-0.6c0-0.8,0-1.7,0-2.6c0,0,0,0,0-0.1c0-0.4,0-0.9,0-1.3c0-0.2,0-0.3,0-0.5c0-0.4,0-0.7,0-1.1c0-1.4,0-2.8,0.1-4.3c0-0.8,0-1.6,0-2.5c0-1,0-2.1,0-3.2c0-0.3,0-0.5,0-0.8c0-0.3,0-0.6,0-1c0-0.3,0-0.6,0-0.9c0.1-5.4,0.1-11.4,0.2-17.8c0-0.2,0-0.5,0-0.7c0.9-75.9,2.2-216.8-0.7-235.6c-4-26-41-67-42-92S724,129,724,129zM169.4,310.4c68.7-0.9,137.5-0.5,206.3-0.6c20.2,0,40.4-0.2,60.6,0c35.6,0.5,62,16,78.9,47.7c13.4,25.2,27.2,50.2,41.3,75c7.4,13,15.7,25.4,24.9,40.1c-164.1,0-325.6,0-488.1,0c-0.4-3.1-1.1-6-1.1-8.9c-0.1-24.5,0.5-48.9-0.2-73.4C90.7,347.2,130,311,169.4,310.4z M1190.9,1122.1c-5,40.1-36.2,67.8-79.5,70.7c-4.6,0.3-9.3,0.3-14,0.3c-303.9,0-607.8,0-911.7,0.1c-24,0-46.5-4.4-65-20.5c-18.9-16.4-29-36.9-29-62.9C92.2,918.3,92,726.9,92,535.5c0-3,0.3-6.1,0.5-10.8c5.8,0,10.5,0,15.1,0c182.3,0,364.5,0,546.8,0c14.1,0,28.1,0,42.2,0c-3.7,8-8.3,15.4-13.7,21.4c-37,41-79.4,77.3-116.9,117.9c-13.7,14.9-20,36.6-29.7,55.2C557,727.9,738.4,743,809,741.9c10.3,146,25.2,284.9,35,423.7v0.4c9.8-138.8,24.7-277.7,35-423.7c70.6,1.1,252-13.9,272.8-22.6c-9.7-18.6-15.9-40.4-29.7-55.2c-37.6-40.6-79.9-76.9-116.9-117.9c-5.5-6.1-10.2-13.6-13.9-21.7c36.9,0,73.8,0,110.7-0.1c28.5-0.1,52.6,9.4,71.7,29.7c13.6,14.4,17.8,33.2,17.8,52.8c0,69.1,0,138.2,0,207.3c0,97.1,0,194.1,0,291.2C1191.5,1111.2,1191.5,1116.7,1190.9,1122.1z"/></svg>');
			--htp.p('</span><span class="texto">'||fun.lang('FAVORITOS')||'</span></a>');	
		
		if ws_admin = 'A' then
			htp.p('<a class="circle" title="'||fun.lang('Excluir objetos da tela')||'" style="color: #444; font-size: 20px;" onmousedown="call_save(''''); titulo(this, ''c''); curtain(''enabled''); carrega(''obj_on_screen?prm_screen=''+document.getElementById(''current_screen'').value);">');
			htp.p('<span class="img"><svg style="height: 24px; width: 24px; margin-top: 5px; opacity: 0.7;" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"width="774.266px" height="774.266px" viewBox="0 0 774.266 774.266" style="enable-background:new 0 0 774.266 774.266;"xml:space="preserve"> <g> <g> <path d="M640.35,91.169H536.971V23.991C536.971,10.469,526.064,0,512.543,0c-1.312,0-2.187,0.438-2.614,0.875 C509.491,0.438,508.616,0,508.179,0H265.212h-1.74h-1.75c-13.521,0-23.99,10.469-23.99,23.991v67.179H133.916 c-29.667,0-52.783,23.116-52.783,52.783v38.387v47.981h45.803v491.6c0,29.668,22.679,52.346,52.346,52.346h415.703 c29.667,0,52.782-22.678,52.782-52.346v-491.6h45.366v-47.981v-38.387C693.133,114.286,670.008,91.169,640.35,91.169z M285.713,47.981h202.84v43.188h-202.84V47.981z M599.349,721.922c0,3.061-1.312,4.363-4.364,4.363H179.282 c-3.052,0-4.364-1.303-4.364-4.363V230.32h424.431V721.922z M644.715,182.339H129.551v-38.387c0-3.053,1.312-4.802,4.364-4.802 H640.35c3.053,0,4.365,1.749,4.365,4.802V182.339z"/> <rect x="475.031" y="286.593" width="48.418" height="396.942"/> <rect x="363.361" y="286.593" width="48.418" height="396.942"/> <rect x="251.69" y="286.593" width="48.418" height="396.942"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg></span>');
			htp.p('<span class="texto">'||fun.lang('EXCLUIR')||'</span>');
			htp.p('</a>');
		end if;
		
		if ws_admin = 'A' then
			htp.p('<a class="circle" title="'||fun.lang('Configura&ccedil;&otilde;es da tela')||'" onmousedown="carregaPainel(''''); if(document.getElementById(''current_screen'').value != ''SANDBOX''){ call_save(''savescr''); loadAttrib(''screen_prop'', ''ws_par_sumary=''+document.getElementById(''current_screen'').value); } else { alerta(''feed-fixo'', '''||fun.lang('op&ccedil;&atilde;o indispon&iacute;vel!')||'''); } "><img style="margin-top: 6px;" src="'||fun.r_gif('frame','png')||'" /><span class="texto">'||fun.lang('PROPRIEDADE')||'</span></a>');
		end if;

		if ws_admin = 'A' then
			htp.p('<a class="circle" title="'||fun.lang('Inserir objeto')||'" onmousedown="closeSideBar(''attriblist''); document.getElementById(''attriblist'').classList.toggle(''open''); ajax(''list'', ''lista_objetos'', '''', false, ''attriblist'');"><img style="margin-top: 6px; margin-left: 1px;" src="'||fun.r_gif('folder','png')||'" /><span class="texto">'||fun.lang('OBJETOS')||'</span></a>');
		end if;

		if ws_admin = 'A' then
			htp.p('<a class="circle" title="'||fun.lang('Filtro de tela')||'" onmousedown="titulo(this, ''n''); call_save(''''); carrega(''list_sfiltro?ws_par_sumary=''+document.getElementById(''current_screen'').value); curtain(''enabled''); carregaPainel(''filtro'');"><img style="margin-top: 8px;" src="'||fun.r_gif('filter_donut','png')||'" /><span class="texto">'||fun.lang('FILTRO')||'</span></a>');
		end if;

		if ws_admin = 'A' then
			htp.p('<a class="circle" title="'||fun.lang('Novo objeto')||'" onmousedown="ajax(''quick'', ''quick_create'', ''prm_nome=&prm_tipo=OBJETO&prm_parametros=&prm_visao=&prm_coluna=&prm_grupo=&prm_obj_ant=&prm_filtro=&prm_screen=''+tela, false);">');
				htp.p('<span class="img" style="color: #444; font-size: 42px; text-shadow: 0 0 1px #000;">+</span>');
				htp.p('<span class="texto">'||fun.lang('CRIAR OBJETO')||'</span>');
			htp.p('</a>');
		end if;
		
		htp.p('<a class="circle" title="'||fun.lang('Importar')||'" onmousedown="titulo(this, ''c''); call_save(''''); curtain(''enabled''); call(''main'', '''', ''imp'').then(function(resposta){ document.getElementById(''content'').innerHTML = resposta; }); "><span class="img" style="color: #333; font-size: 34px; text-shadow: 0 0 1px #000;">');
			htp.p('<svg style="height: 34px; width: 24px; fill: #333; margin-left: 2px;" version="1.1"  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve"> <g> <g> <path d="M495.343,45.601H221.818c-9.199,0-16.657,7.458-16.657,16.657V91.18H16.657C7.458,91.18,0,98.638,0,107.837v341.906 c0,9.199,7.458,16.657,16.657,16.657h341.918c9.199,0,16.657-7.458,16.657-16.657V261.25h120.112 c9.199,0,16.657-7.458,16.657-16.657V62.257C512,53.058,504.542,45.601,495.343,45.601z M341.918,433.086H33.313V124.493h171.847 v113.21l-40.56,40.56l-13.646-13.647c-9.057-9.059-24.555-4.896-27.867,7.467l-18.612,69.462 c-3.297,12.295,7.966,23.731,20.4,20.401l69.462-18.612c12.38-3.319,16.515-18.821,7.467-27.868l-13.647-13.647l40.565-40.565 h113.197V433.086z M478.687,227.936H238.48c0-101.027-0.006-146.919-0.006-149.022h240.212V227.936z"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
		htp.p('</span><span class="texto">'||fun.lang('IMPORTAR')||'</span></a>');

        -- Função imprimir usando html2pdf
        htp.p('<a class="circle" title="Gerar PDF a partir da p&aacute;gina" onmousedown="imprimir_pagina()">');
            htp.p('<span class="img" style="color: #333; font-size: 34px; text-shadow: 0 0 1px #000;">');
                htp.p(fun.ret_svg('exportar'));
            htp.p('</span><span class="texto">'||fun.lang('EXPORTAR')||'</span>');
        htp.p('</a>');

		-- ÚLTIMA ATUALIZAÇÃO DA VIEW
		htp.p('<a id="atu_view" class="circle invisible" onclick="ajax(''list'',''atu_view'',''prm_screen=''+tela+''&prm_objeto='', false,''attriblist'');if(!document.getElementById(''attriblist'').classList.contains(''open'')){document.getElementById(''attriblist'').classList.add(''open'');}else{document.getElementById(''attriblist'').classList.remove(''open'');}">');
			htp.p('<span class="img"><svg xmlns="http://www.w3.org/2000/svg" style="height: 24px; width: 24px; margin-top: 5px; opacity: 0.7;" viewBox="0 0 48 48" ><title>Stopwatch</title><g id="_11_-_20" data-name="11 - 20"><g id="Stopwatch"><path d="M38.1,14.312l1.455-1.454.793.793a1,1,0,0,0,1.414-1.414l-3-3a1,1,0,1,0-1.414,1.414l.792.793L36.688,12.9A18.892,18.892,0,0,0,25,8.051V7h2a2,2,0,0,0,2-2V4a2,2,0,0,0-2-2H21a2,2,0,0,0-2,2V5a2,2,0,0,0,2,2h2V8.051A18.892,18.892,0,0,0,11.312,12.9L9.858,11.444l.792-.793A1,1,0,1,0,9.236,9.237l-3,3A1,1,0,1,0,7.65,13.651l.793-.793L9.9,14.312a19,19,0,1,0,28.2,0ZM21,4h6V5H21Zm3,40A17,17,0,1,1,41,27,17.019,17.019,0,0,1,24,44Z"/><path d="M24,12A15,15,0,1,0,39,27,15.017,15.017,0,0,0,24,12ZM35,28h1.949a12.919,12.919,0,0,1-3.088,7.447l-1.376-1.376a1,1,0,1,0-1.414,1.414l1.376,1.376A12.926,12.926,0,0,1,25,39.949V38a1,1,0,0,0-2,0v1.949a12.926,12.926,0,0,1-7.447-3.088l1.376-1.376a1,1,0,1,0-1.414-1.414l-1.376,1.376A12.919,12.919,0,0,1,11.051,28H13a1,1,0,0,0,0-2H11.051a12.919,12.919,0,0,1,3.088-7.447l1.376,1.376a1,1,0,1,0,1.414-1.414l-1.376-1.376A12.926,12.926,0,0,1,23,14.051V16a1,1,0,0,0,2,0V14.051a12.926,12.926,0,0,1,7.447,3.088l-1.376,1.376a1,1,0,1,0,1.414,1.414l1.376-1.376A12.919,12.919,0,0,1,36.949,26H35a1,1,0,0,0,0,2Z"/><path d="M27.827,17.761a1,1,0,0,0-1.306.541l-2.367,5.714c-.052,0-.1-.016-.154-.016a3.03,3.03,0,1,0,2,.781l2.367-5.713A1,1,0,0,0,27.827,17.761ZM24,28a1,1,0,1,1,1-1A1,1,0,0,1,24,28Z"/></g></g></svg></span>');
			htp.p('<span class="texto" >'||fun.lang('ATUALIZA&Ccedil;&Otilde;ES')||'</span>');
		htp.p('</a>');

		/*htp.p('<a id="atu_view" class="circle invisible" onclick="ajax(''list'',''atu_view'',''prm_screen='||prm_screen||'&prm_objeto='', false,''attriblist'');if(!document.getElementById(''attriblist'').classList.contains(''open'')){document.getElementById(''attriblist'').classList.add(''open'');}else{document.getElementById(''attriblist'').classList.remove(''open'');>');
			htp.p('<span class="img" style="color: #333; font-size: 34px; text-shadow: 0 0 1px #000; padding-top: 6px; height: 34px;">');
				htp.p('<svg xmlns="http://www.w3.org/2000/svg" style="height: 24px; width: 24px; margin-top: 5px; opacity: 0.7;" viewBox="0 0 48 48" ><title>Stopwatch</title><g id="_11_-_20" data-name="11 - 20"><g id="Stopwatch"><path d="M38.1,14.312l1.455-1.454.793.793a1,1,0,0,0,1.414-1.414l-3-3a1,1,0,1,0-1.414,1.414l.792.793L36.688,12.9A18.892,18.892,0,0,0,25,8.051V7h2a2,2,0,0,0,2-2V4a2,2,0,0,0-2-2H21a2,2,0,0,0-2,2V5a2,2,0,0,0,2,2h2V8.051A18.892,18.892,0,0,0,11.312,12.9L9.858,11.444l.792-.793A1,1,0,1,0,9.236,9.237l-3,3A1,1,0,1,0,7.65,13.651l.793-.793L9.9,14.312a19,19,0,1,0,28.2,0ZM21,4h6V5H21Zm3,40A17,17,0,1,1,41,27,17.019,17.019,0,0,1,24,44Z"/><path d="M24,12A15,15,0,1,0,39,27,15.017,15.017,0,0,0,24,12ZM35,28h1.949a12.919,12.919,0,0,1-3.088,7.447l-1.376-1.376a1,1,0,1,0-1.414,1.414l1.376,1.376A12.926,12.926,0,0,1,25,39.949V38a1,1,0,0,0-2,0v1.949a12.926,12.926,0,0,1-7.447-3.088l1.376-1.376a1,1,0,1,0-1.414-1.414l-1.376,1.376A12.919,12.919,0,0,1,11.051,28H13a1,1,0,0,0,0-2H11.051a12.919,12.919,0,0,1,3.088-7.447l1.376,1.376a1,1,0,1,0,1.414-1.414l-1.376-1.376A12.926,12.926,0,0,1,23,14.051V16a1,1,0,0,0,2,0V14.051a12.926,12.926,0,0,1,7.447,3.088l-1.376,1.376a1,1,0,1,0,1.414,1.414l1.376-1.376A12.919,12.919,0,0,1,36.949,26H35a1,1,0,0,0,0,2Z"/><path d="M27.827,17.761a1,1,0,0,0-1.306.541l-2.367,5.714c-.052,0-.1-.016-.154-.016a3.03,3.03,0,1,0,2,.781l2.367-5.713A1,1,0,0,0,27.827,17.761ZM24,28a1,1,0,1,1,1-1A1,1,0,0,1,24,28Z"/></g></g></svg>');
			htp.p('</span>');
			htp.p('<span class="texto" style="font-size:8px;">'||fun.lang('ÚLTIMA ATUALIZAÇÃO')||'</span>');
		htp.p('</a>');*/
		

		-- Favoritar tela 
		htp.p('<a class="circle" title="'||fun.lang('Favoritar tela')||'" onmousedown="loading(); ajax(''return'', ''favoritar'', ''prm_objeto=''+document.getElementById(''current_screen'').value+''+&prm_acao=incluir_tela'', false); loading(); alerta(''feed-fixo'', respostaAjax.split(''|'')[1]); if (respostaAjax.split(''|'')[0] == ''OK'') {   document.getElementById(''id_atualizar_menu'').value = ''S''; }">'); 
		htp.p('<span class="img" style="color: #333; font-size: 34px; text-shadow: 0 0 1px #000; left: calc(50% - 13px);">');
			htp.p('<svg style="height: 26px; width: 26px; margin-top: 4px;" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" 	 width="613.408px" height="613.408px" viewBox="0 0 613.408 613.408" style="enable-background:new 0 0 613.408 613.408;" 	 xml:space="preserve"> <g> 	<path d="M605.254,168.94L443.792,7.457c-6.924-6.882-17.102-9.239-26.319-6.069c-9.177,3.128-15.809,11.241-17.019,20.855 		l-9.093,70.512L267.585,216.428h-142.65c-10.344,0-19.625,6.215-23.629,15.746c-3.92,9.573-1.71,20.522,5.589,27.779 		l105.424,105.403L0.699,613.408l246.635-212.869l105.423,105.402c4.881,4.881,11.45,7.467,17.999,7.467 		c3.295,0,6.632-0.709,9.78-2.002c9.573-3.922,15.726-13.244,15.726-23.504V345.168l123.839-123.714l70.429-9.176 		c9.614-1.251,17.727-7.862,20.813-17.039C614.472,186.021,612.136,175.801,605.254,168.94z M504.856,171.985 		c-5.568,0.751-10.762,3.232-14.745,7.237L352.758,316.596c-4.796,4.775-7.466,11.242-7.466,18.041v91.742L186.437,267.481h91.68 		c6.757,0,13.243-2.669,18.04-7.466L433.51,122.766c3.983-3.983,6.569-9.176,7.258-14.786l3.629-27.696l88.155,88.114 		L504.856,171.985z"/> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
		htp.p('</span><span class="texto">'||fun.lang('FAVORITAR TELA')||'</span></a>');

		-- Adicionar na tela inicial 
		htp.p('<a class="circle" title="'||fun.lang('Definir como tela inicial')||'" onmousedown="userEvent(document.getElementById(''current_screen'').value, '''||trim(ws_usuario)||''', ''cd_tela_inicial'');"><span class="img" style="color: #333; font-size: 34px; text-shadow: 0 0 1px #000;">');
			htp.p('<svg style="height: 26px; width: 26px; margin-top: 4px; left: calc(50% - 13px);" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 480"><path d="M467.43,222l-.03-.03c-19.57-14.97-102.55-88.55-163.4-139.35v30.86c31.07,26.53,61.95,53.55,93.4,79.7l.17-.16,50.89,43.24c9.35,7.95,.61,22.28-11.69,18.9-1.85-.51-3.59-1.39-5.06-2.63l-51.59-43.84,.21-.18c-25.5-21.56-50.88-43.31-76.33-64.97v28.61c34.25,29.08,65.83,56.07,65.83,56.07,0-.33,.58,1.34,.58,1.34v.94c-.21,13.4-2.41,166.87-2.42,214.8,.06,2.27,.14,5.54-3.31,5.55-15.53,0-50.76,0-72.06,0v-74.17c0-18.89-17.07-34.26-38.05-34.26h-27.94c-20.98,0-38.05,15.37-38.05,34.26v74.17c-21.3,0-56.53,0-72.06,0-3.45-.02-3.37-3.28-3.31-5.55-.01-47.93-2.22-201.4-2.41-214.8,0-.62-.01-.94-.01-.94,0,0,.58-1.67,.58-1.34,0,0,30.24-25.85,63.63-54.2v-28.61c-24.72,21.04-49.37,42.16-74.13,63.1l.21,.18-51.59,43.84c-1.47,1.25-3.21,2.13-5.06,2.63-12.3,3.38-21.04-10.96-11.69-18.9l50.89-43.24,.17,.16c30.71-25.53,60.87-51.9,91.21-77.83v-30.9C114.37,135.17,33.13,207.18,13.79,221.97l-.03,.03c-33.65,30.44,19.45,71.75,51.9,44.07l23.16-19.68c.28-.23,.73-.07,.73,.27,.01,46.6,.41,163.92,.27,209.49-.02,6.13,1.35,11.33,7.8,14.78,.07,.04,.15,.06,.23,.06H383.33c.08,0,.16-.02,.23-.06,6.45-3.45,7.82-8.65,7.8-14.78-.14-45.58,.26-162.9,.27-209.49,0-.34,.45-.51,.73-.27l23.16,19.68c32.46,27.68,85.56-13.63,51.9-44.07Zm-195.2,227.36h-63.28v-72.67c0-8.77,7.93-15.91,17.67-15.91h27.94c9.74,0,17.67,7.14,17.67,15.91v72.67Z"/><path d="M153.72,218.64l-.72,.64c.28-.08,.53-.27,.72-.64Z"/><path d="M377.01,219.28l-.72-.64c.19,.37,.44,.56,.72,.64Z"/><path d="M311.51,6c3.88,1.47,5.33,4.39,5.18,8.39-.11,3.13,0,6.27-.03,9.4-.06,5.65-2.47,8.09-8.16,8.1-18.81,.03-37.63,.01-56.44,.01-26.92,0-53.84,0-80.76,0-8.12,0-9.82-1.74-9.83-9.97,0-2.38,.16-4.77-.04-7.13-.32-3.97,1.1-6.91,4.61-8.81h145.45Z"/><path d="M290.64,45.06V173.92h-103.04V45.06h103.04Z"/><path d="M145.15,224.9c3.05-2.89,6.17-5.71,9.15-8.67,9.13-9.07,18.16-18.24,27.36-27.24,1.08-1.05,2.95-1.83,4.45-1.84,35.26-.1,70.52-.09,105.78-.02,1.36,0,3.1,.45,4.02,1.36,11.94,11.76,23.77,23.64,35.61,35.5,.42,.42,.73,.95,1.32,1.73H145.74l-.59-.82Z"/><path d="M257.12,239.01c-5.97,32.85-11.89,65.38-17.81,97.92h-.53c-5.92-32.53-11.84-65.08-17.81-97.92h36.15Z"/></svg>'); 
		htp.p('</span><span class="texto">'||fun.lang('TELA INICIAL')||'</span></a>');


		select count(*) into ws_count from usuarios where usu_nome = ws_usuario and upload = 'S';
		if ws_count = 1 or ws_admin = 'A' then
			htp.p('<a class="circle" title="Upload" onmousedown="document.getElementById(''titulo'').innerHTML = ''UPLOAD''; call_save(''''); curtain(''enabled''); carregaPainel(''upload''); carrega(''uploaded'');"><img style="margin-top: 6px; height: 22px;" src="'||fun.r_gif('upload','png')||'" /><span class="texto">UPLOAD</span></a>');
		end if;
		
	htp.p('</div>');  -- fecha DIV donut 

	if ws_admin = 'A' or fun.user_permissao(ws_usuario, 'TELAS_ETL') = 'S' or fun.user_permissao(ws_usuario, 'TELAS_USUARIOS') = 'S' then 

		htp.p('<ul id="prefdrop" class="hidden" onmouseenter="this.focus();" onmouseleave="/*this.classList.remove(''hover'');*/">');

			-- Define a largura de cada aba 
			ws_qt_abas := 0;
			if ws_admin = 'A' or fun.user_permissao(ws_usuario, 'TELAS_USUARIOS') = 'S' then 
				ws_qt_abas := ws_qt_abas + 1;
			end if; 
			if fun.user_permissao(ws_usuario, 'TELAS_ETL') = 'S' then 
				ws_qt_abas := ws_qt_abas + 1;			
			end if;
			if ws_qt_abas = 1 then
				ws_width := '100%';
			elsif ws_qt_abas = 2 then
				ws_width := '50%';
			end if; 	

			-- Define as abas do menu
			ws_class_green  := 'green';
			htp.p('<div class="abas abas-config">'); 
				if ws_admin = 'A' or fun.user_permissao(ws_usuario, 'TELAS_USUARIOS') = 'S' then 
					htp.p('<a id="id_prefprop-geral" title="Parametriza&ccedil;&otilde;es e cadastros gerais" style="width: '||ws_width||'; border: none;" class="aba '||ws_class_green||'" data-for="form-prefdrop-geral" onclick="toggleAba(this);">CONFIG.</a>');
					ws_class_green  := ' '; 					
				end if; 
				if fun.user_permissao(ws_usuario, 'TELAS_ETL') = 'S' then 
					htp.p('<a id="id_prefdrop-etl"   title="Parametriza&ccedil;&otilde;es do processo de ETL" style="width: '||ws_width||'; border: none;" class="aba '||ws_class_green||'" data-for="form-prefdrop-etl"   onclick="toggleAba(this);">ETL</a>');
					ws_class_green := ' ';
				end if;	
			htp.p('</div>'); 


			-- Define a situação inicial de cada aba
			ws_geral_closed := 'closed';
			ws_etl_closed   := 'closed';
			if ws_admin = 'A' or fun.user_permissao(ws_usuario, 'TELAS_USUARIOS') = 'S' then 
				ws_geral_closed := ''; -- Inicia com a aba Geral aberta 
			else 
				ws_etl_closed   := ''; -- Inicia com a aba ETL aberta 
			end if; 

				
		    -- Monta conteudo da aba geral 
			htp.p('<ul id="form-prefdrop-geral" class="form-config '||ws_geral_closed||'" onmouseenter="this.focus();">');
			if ws_admin = 'A' then 

				htp.p('<li><a title="'||fun.lang('Acessos')||'" data-menu="" data-refresh="acessos" data-refresh-ativo="S" data-carrega="acessos" data-attrib="" onclick="carregaPainel('''');">');
					htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="94px" height="82px" viewBox="0 0 94 82" style="enable-background:new 0 0 94 82;" xml:space="preserve"><path d="M53.131,0C30.902,0,12.832,17.806,12.287,39.976H0l18.393,20.5l18.391-20.5H22.506C23.045,23.468,36.545,10.25,53.131,10.25c16.93,0,30.652,13.767,30.652,30.75S70.061,71.75,53.131,71.75c-6.789,0-13.059-2.218-18.137-5.966l-7.029,7.521C34.904,78.751,43.639,82,53.131,82C75.703,82,94,63.645,94,41S75.703,0,53.131,0z M49.498,19v23.45l15.027,15.024l4.949-4.949L56.5,39.55V19H49.498z"/><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g></svg>');
					htp.p('<span>'||fun.lang('Acessos')||'</span>');
				htp.p('</a></li>');

				htp.p('<li><a title="'||fun.lang('Colunas')||'" data-menu="list_crocks" data-refresh="" data-carrega="_" data-attrib="">');
					--htp.p('<svg height="16px" version="1.1" viewBox="0 0 16 16" width="16px" xmlns="http://www.w3.org/2000/svg" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns" xmlns:xlink="http://www.w3.org/1999/xlink"><title/><defs/><g fill="none" fill-rule="evenodd" id="Icons with numbers" stroke="none" stroke-width="1"><g fill="#FFFFFF" id="Group" transform="translate(-432.000000, -288.000000)"><path d="M433,292 L446,292 L446,301 L433,301 Z M434,293 L434,300 L437,300 L437,293 Z M438,293 L438,300 L441,300 L441,293 Z M442,293 L442,300 L445,300 L445,293 Z M442,293" id="Rectangle 174"/></g></g></svg>');
					htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="35px" height="35px" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35;" xml:space="preserve"> <g> <g> <rect width="6.119" height="35"/> <rect x="9.615" width="6.133" height="35"/> <rect x="19.245" width="6.116" height="35"/> <rect x="28.873" width="6.127" height="35"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
					htp.p('<span>'||fun.lang('Colunas')||'</span>');
				htp.p('</a></li>');

				/*htp.p('<li><a title="Configura&ccedil;&atilde;o" data-menu="conteudo" data-refresh="" data-carrega="" data-attrib="list_vconteudo">');
					htp.p('<svg enable-background="new 0 0 24 24" height="24px"  version="1.1" viewBox="0 0 24 24" width="24px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path clip-rule="evenodd" d="M21.521,10.146c-0.41-0.059-0.846-0.428-0.973-0.82l-0.609-1.481  c-0.191-0.365-0.146-0.935,0.1-1.264l0.99-1.318c0.246-0.33,0.227-0.854-0.047-1.162l-1.084-1.086  c-0.309-0.272-0.832-0.293-1.164-0.045l-1.316,0.988c-0.33,0.248-0.898,0.293-1.264,0.101l-1.48-0.609  c-0.395-0.126-0.764-0.562-0.82-0.971l-0.234-1.629c-0.057-0.409-0.441-0.778-0.85-0.822c0,0-0.255-0.026-0.77-0.026  c-0.514,0-0.769,0.026-0.769,0.026c-0.41,0.044-0.794,0.413-0.852,0.822l-0.233,1.629c-0.058,0.409-0.427,0.845-0.82,0.971  l-1.48,0.609C7.48,4.25,6.912,4.206,6.582,3.958L5.264,2.969c-0.33-0.248-0.854-0.228-1.163,0.045L3.017,4.1  C2.745,4.409,2.723,4.932,2.971,5.262l0.988,1.318C4.208,6.91,4.252,7.479,4.061,7.844L3.45,9.326  c-0.125,0.393-0.562,0.762-0.971,0.82L0.85,10.377c-0.408,0.059-0.777,0.442-0.82,0.853c0,0-0.027,0.255-0.027,0.77  s0.027,0.77,0.027,0.77c0.043,0.411,0.412,0.793,0.82,0.852l1.629,0.232c0.408,0.059,0.846,0.428,0.971,0.82l0.611,1.48  c0.191,0.365,0.146,0.936-0.102,1.264l-0.988,1.318c-0.248,0.33-0.308,0.779-0.132,0.994c0.175,0.217,0.677,0.752,0.678,0.754  s0.171,0.156,0.375,0.344s1.042,0.449,1.372,0.203l1.317-0.99c0.33-0.246,0.898-0.293,1.264-0.1l1.48,0.609  c0.394,0.125,0.763,0.562,0.82,0.971l0.233,1.629c0.058,0.408,0.441,0.779,0.852,0.822c0,0,0.255,0.027,0.769,0.027  c0.515,0,0.77-0.027,0.77-0.027c0.409-0.043,0.793-0.414,0.85-0.822l0.234-1.629c0.057-0.408,0.426-0.846,0.82-0.971l1.48-0.611  c0.365-0.191,0.934-0.146,1.264,0.102l1.318,0.99c0.332,0.246,0.854,0.227,1.164-0.047l1.082-1.084  c0.273-0.311,0.293-0.834,0.047-1.164l-0.99-1.318c-0.246-0.328-0.291-0.898-0.1-1.264l0.609-1.48  c0.127-0.393,0.562-0.762,0.973-0.82l1.627-0.232c0.41-0.059,0.779-0.441,0.822-0.852c0,0,0.027-0.255,0.027-0.77  s-0.027-0.77-0.027-0.77c-0.043-0.41-0.412-0.794-0.822-0.853L21.521,10.146z M12,15C10.343,15,9,13.656,9,12  C9,10.343,10.343,9,12,9c1.657,0,3,1.344,3,3C15,13.656,13.656,15,12,15z" fill-rule="evenodd"/></svg>');
					htp.p('<span>'||fun.lang('Configura&ccedil;&atilde;o')||'</span>');
				htp.p('</a></li>');*/

				htp.p('<li><a title="'||fun.lang('Destaques')||'" data-menu="efeito" data-refresh="" data-carrega="blink_coluna" data-attrib="">');
					htp.p('<svg enable-background="new -1.23 -8.789 141.732 141.732" height="141.732px" version="1.1" viewBox="-1.23 -8.789 141.732 141.732" width="141.732px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="Livello_100"><path d="M139.273,49.088c0-3.284-2.75-5.949-6.146-5.949c-0.219,0-0.434,0.012-0.646,0.031l-42.445-1.001l-14.5-37.854   C74.805,1.824,72.443,0,69.637,0c-2.809,0-5.168,1.824-5.902,4.315L49.232,42.169L6.789,43.17c-0.213-0.021-0.43-0.031-0.646-0.031   C2.75,43.136,0,45.802,0,49.088c0,2.1,1.121,3.938,2.812,4.997l33.807,23.9l-12.063,37.494c-0.438,0.813-0.688,1.741-0.688,2.723   c0,3.287,2.75,5.952,6.146,5.952c1.438,0,2.766-0.484,3.812-1.29l35.814-22.737l35.812,22.737c1.049,0.806,2.371,1.29,3.812,1.29   c3.393,0,6.143-2.665,6.143-5.952c0-0.979-0.25-1.906-0.688-2.723l-12.062-37.494l33.806-23.9   C138.15,53.024,139.273,51.185,139.273,49.088"/></g><g/></svg>');
					htp.p('<span>'||fun.lang('Destaques')||'</span>');
				htp.p('</a></li>');

				--- comentado por não ser usada 04/11/2022
				/*htp.p('<li><a title="Etl" data-menu="etl" data-refresh="" data-carrega="etl" data-attrib="" data-package="etl">');
					htp.p('<svg enable-background="new 0 0 500 500" height="500px"  version="1.1" viewBox="0 0 500 500" width="500px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path clip-rule="evenodd" d="M73.333,285.841c0,97.85,79.316,177.168,177.167,177.168  c97.846,0,177.168-79.318,177.168-177.168c0-79.497-52.332-146.731-124.475-169.172l-0.087-0.087  c-6.913-2.635-11.723-9.272-11.723-16.992c0-9.99,8.18-18.17,18.172-18.17h4.543c12.537,0,22.716-10.178,22.716-22.714  c0-12.538-10.179-22.715-22.716-22.715H186.901c-12.536,0-22.713,10.177-22.713,22.715c0,12.536,10.177,22.714,22.713,22.714h4.543  c9.996,0,18.173,8.18,18.173,18.17c0,7.906-5.09,14.632-12.086,17.177c-16.716,5.173-32.344,12.804-46.607,22.44l-16.717-16.727  c-6.272-6.264-16.626-6.264-22.898,0L87.143,146.66c-6.268,6.264-6.268,16.619,0,22.891l16.717,16.716  C84.601,214.702,73.333,248.95,73.333,285.841z M227.787,176.815c0-12.536,10.177-22.713,22.713-22.713  c12.537,0,22.715,10.177,22.715,22.713c0,12.539-10.178,22.716-22.715,22.716C237.964,199.531,227.787,189.354,227.787,176.815z   M118.761,285.841c0-12.535,10.177-22.711,22.713-22.711s22.713,10.176,22.713,22.711c0,12.537-10.177,22.716-22.713,22.716  S118.761,298.378,118.761,285.841z M336.814,285.841c0-12.535,10.175-22.711,22.712-22.711c12.535,0,22.715,10.176,22.715,22.711  c0,12.537-10.18,22.716-22.715,22.716C346.989,308.557,336.814,298.378,336.814,285.841z M227.787,394.867  c0-12.537,10.177-22.712,22.713-22.712c12.537,0,22.715,10.175,22.715,22.712c0,12.539-10.178,22.715-22.715,22.715  C237.964,417.582,227.787,407.406,227.787,394.867z M340.715,220.611l-73.678,73.687c-6.9,6.896-18.081,6.896-24.989,0  c-6.902-6.913-6.902-18.089,0-24.985l73.683-73.686c6.904-6.903,18.084-6.903,24.984,0  C347.62,202.529,347.62,213.709,340.715,220.611z"/></svg>');
					htp.p('<span>Etl</span>');
				htp.p('</a></li>');*/

				htp.p('<li><a data-menu="no-menu" data-carrega="" data-attrib="list_vconteudo" data-refresh=""   title="'||fun.lang('Configura&ccedil;&otilde;es')||'">');
					htp.p('<svg  version="1.1" viewBox="0 0 24 24"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path clip-rule="evenodd" d="M21.521,10.146c-0.41-0.059-0.846-0.428-0.973-0.82l-0.609-1.481  c-0.191-0.365-0.146-0.935,0.1-1.264l0.99-1.318c0.246-0.33,0.227-0.854-0.047-1.162l-1.084-1.086  c-0.309-0.272-0.832-0.293-1.164-0.045l-1.316,0.988c-0.33,0.248-0.898,0.293-1.264,0.101l-1.48-0.609  c-0.395-0.126-0.764-0.562-0.82-0.971l-0.234-1.629c-0.057-0.409-0.441-0.778-0.85-0.822c0,0-0.255-0.026-0.77-0.026  c-0.514,0-0.769,0.026-0.769,0.026c-0.41,0.044-0.794,0.413-0.852,0.822l-0.233,1.629c-0.058,0.409-0.427,0.845-0.82,0.971  l-1.48,0.609C7.48,4.25,6.912,4.206,6.582,3.958L5.264,2.969c-0.33-0.248-0.854-0.228-1.163,0.045L3.017,4.1  C2.745,4.409,2.723,4.932,2.971,5.262l0.988,1.318C4.208,6.91,4.252,7.479,4.061,7.844L3.45,9.326  c-0.125,0.393-0.562,0.762-0.971,0.82L0.85,10.377c-0.408,0.059-0.777,0.442-0.82,0.853c0,0-0.027,0.255-0.027,0.77  s0.027,0.77,0.027,0.77c0.043,0.411,0.412,0.793,0.82,0.852l1.629,0.232c0.408,0.059,0.846,0.428,0.971,0.82l0.611,1.48  c0.191,0.365,0.146,0.936-0.102,1.264l-0.988,1.318c-0.248,0.33-0.308,0.779-0.132,0.994c0.175,0.217,0.677,0.752,0.678,0.754  s0.171,0.156,0.375,0.344s1.042,0.449,1.372,0.203l1.317-0.99c0.33-0.246,0.898-0.293,1.264-0.1l1.48,0.609  c0.394,0.125,0.763,0.562,0.82,0.971l0.233,1.629c0.058,0.408,0.441,0.779,0.852,0.822c0,0,0.255,0.027,0.769,0.027  c0.515,0,0.77-0.027,0.77-0.027c0.409-0.043,0.793-0.414,0.85-0.822l0.234-1.629c0.057-0.408,0.426-0.846,0.82-0.971l1.48-0.611  c0.365-0.191,0.934-0.146,1.264,0.102l1.318,0.99c0.332,0.246,0.854,0.227,1.164-0.047l1.082-1.084  c0.273-0.311,0.293-0.834,0.047-1.164l-0.99-1.318c-0.246-0.328-0.291-0.898-0.1-1.264l0.609-1.48  c0.127-0.393,0.562-0.762,0.973-0.82l1.627-0.232c0.41-0.059,0.779-0.441,0.822-0.852c0,0,0.027-0.255,0.027-0.77  s-0.027-0.77-0.027-0.77c-0.043-0.41-0.412-0.794-0.822-0.853L21.521,10.146z M12,15C10.343,15,9,13.656,9,12  C9,10.343,10.343,9,12,9c1.657,0,3,1.344,3,3C15,13.656,13.656,15,12,15z" fill-rule="evenodd"/></svg>');
					htp.p('<span>'||fun.lang('Config')||'</span>');
				htp.p('</a></li>');

				htp.p('<li><a title="'||fun.lang('Filtros De Usu&aacute;rios')||'" data-menu="filtrou" data-refresh="" data-carrega="filtro_geral" data-attrib="">');
					--htp.p('<svg enable-background="new 0 0 32 32" height="32px" version="1.1" viewBox="0 0 32 32" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:svg="http://www.w3.org/2000/svg"><g><rect fill="none" height="32" width="32"/></g><g id="filter_x5F_settings"><rect height="6" width="4" x="16"/><polygon points="30,9 26,5 26,8 2,8 2,10.001 26,10.001 26,13  "/><polygon points="10,16 2,16 2,17.999 10,17.999 10,21 14,17 10,13  "/><path d="M28,24v-2.002h-1.663c-0.063-0.211-0.145-0.412-0.245-0.605l1.187-1.188l-1.416-1.414l-1.165,1.166   c-0.22-0.123-0.452-0.221-0.697-0.295V18h-2v1.662c-0.229,0.068-0.446,0.158-0.652,0.27l-1.141-1.141l-1.415,1.416l1.14,1.139   c-0.112,0.207-0.202,0.424-0.271,0.654H18v2h1.662c0.073,0.246,0.172,0.479,0.295,0.697l-1.165,1.164l1.413,1.416l1.188-1.188   c0.192,0.102,0.394,0.182,0.605,0.246V28H24v-1.666c0.229-0.068,0.445-0.158,0.651-0.27l1.212,1.213l1.414-1.416l-1.212-1.211   c0.111-0.205,0.201-0.422,0.27-0.65H28z M22.999,24.498c-0.829-0.002-1.498-0.67-1.501-1.5c0.003-0.828,0.672-1.498,1.501-1.5   c0.829,0.002,1.498,0.672,1.5,1.5C24.497,23.828,23.828,24.496,22.999,24.498z"/><path d="M23,14c-1.054,0-2.061,0.19-3,0.522V12h-4v5.347c-1.249,1.546-2,3.511-2,5.653c0,2.142,0.751,4.106,2,5.651V32h4v-0.523   C20.939,31.809,21.946,32,23,32c4.971-0.002,8.998-4.029,9-9C31.998,18.027,27.971,14,23,14z M23,29.883   c-3.801-0.01-6.876-3.084-6.885-6.883c0.009-3.801,3.084-6.876,6.885-6.885c3.799,0.008,6.874,3.084,6.883,6.885   C29.874,26.799,26.799,29.873,23,29.883z"/></g></svg>');
					htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="971.986px" height="971.986px" viewBox="0 0 971.986 971.986" style="enable-background:new 0 0 971.986 971.986;" xml:space="preserve"> <g> <path d="M370.216,459.3c10.2,11.1,15.8,25.6,15.8,40.6v442c0,26.601,32.1,40.101,51.1,21.4l123.3-141.3 c16.5-19.8,25.6-29.601,25.6-49.2V500c0-15,5.7-29.5,15.8-40.601L955.615,75.5c26.5-28.8,6.101-75.5-33.1-75.5h-873 c-39.2,0-59.7,46.6-33.1,75.5L370.216,459.3z"/> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
					htp.p('<span>'||fun.lang('Filtros')||'</span>');
				htp.p('</a></li>');

				htp.p('<li><a title="'||fun.lang('Categorias')||'" data-menu="grupos" data-refresh="" data-carrega="grupos" data-attrib="">');
					htp.p('<svg height="32px" style="enable-background:new 0 0 32 32;" version="1.1" viewBox="0 0 32 32" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g/><g id="share"><path d="M28,24c-0.973,0-1.832,0.391-2.523,0.965l-6.098-4.352C19.766,19.816,20,18.941,20,18   c0-1.293-0.422-2.488-1.117-3.465l7.133-7.137C26.609,7.746,27.262,8,28,8c2.211,0,4-1.789,4-4s-1.789-4-4-4s-4,1.789-4,4   c0,0.738,0.254,1.391,0.602,1.984l-7.133,7.137C16.484,12.418,15.297,12,14,12c-2.289,0-4.258,1.301-5.27,3.191l-4.816-1.609   C3.719,12.684,2.957,12,2,12c-1.105,0-2,0.895-2,2s0.895,2,2,2c0.504,0,0.953-0.203,1.305-0.512l4.789,1.598   C8.047,17.387,8,17.688,8,18c0,3.312,2.688,6,6,6c1.648,0,3.145-0.668,4.23-1.746l6.059,4.324C24.117,27.023,24,27.496,24,28   c0,2.207,1.789,4,4,4s4-1.793,4-4S30.211,24,28,24z"/></g></svg>');
					htp.p('<span>'||fun.lang('Categorias')||'</span>');
				htp.p('</a></li>');

				htp.p('<li><a title="'||fun.lang('Grupos De Usu&aacute;rios')||'" data-menu="gusuarios" data-refresh="" data-carrega="gusuarios" data-attrib="">');
					htp.p('<svg enable-background="new 0 0 32 32" height="32px" version="1.1" viewBox="0 0 32 32" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:svg="http://www.w3.org/2000/svg"><g><rect fill="none" height="32" width="32"/></g><g id="group_x5F_full"><g><path d="M8,20c0-2,0-10,0-10s0.005-0.45,0.239-1C6.16,9,4,9,4,9s-2,0-2,2v7c0,2,2,2,2,2v10h6v-8C10,22,8,22,8,20z M8,8    c0.52,0,1.001-0.144,1.427-0.376c0.059-0.036,0.125-0.068,0.188-0.103C10.446,6.988,11,6.061,11,5c0-1.657-1.343-3-3-3    S5,3.343,5,5S6.343,8,8,8z M28,9h-4.238C23.995,9.55,24,10,24,10s0,8,0,10s-2,2-2,2v8h6V20c0,0,2,0,2-2s0-7,0-7S30,9,28,9z     M22.38,7.519c0.065,0.035,0.134,0.068,0.194,0.105C23,7.856,23.48,8,24,8c1.657,0,3-1.343,3-3s-1.343-3-3-3s-3,1.343-3,3    C21,6.059,21.552,6.985,22.38,7.519z M16,8c1.657,0,3-1.343,3-3s-1.343-3-3-3s-3,1.343-3,3S14.343,8,16,8z M22,11c0,0,0-2-2-2    c-0.5,0-8,0-8,0s-2,0-2,2v7c0,2,2,2,2,2v10h8V20c0,0,2,0,2-2S22,11,22,11z"/></g></g></svg>');
					htp.p('<span>'||fun.lang('Grupos')||'</span>');
				htp.p('</a></li>');

				htp.p('<li><a title="Logs" data-menu="log" data-refresh="" data-carrega="logs" data-attrib="">');
					htp.p('<svg enable-background="new 0 0 500 500" height="500px" version="1.1" viewBox="0 0 500 500" width="500px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path clip-rule="evenodd" d="M177.317,104.632c0,40.158,32.525,72.685,72.683,72.685  c40.158,0,72.685-32.527,72.685-72.685c0-40.158-32.526-72.683-72.685-72.683C209.842,31.949,177.317,64.474,177.317,104.632z   M177.317,259.086v163.538h-22.715c-12.536,0-22.713,10.175-22.713,22.716c0,12.536,10.177,22.711,22.713,22.711h190.794  c12.537,0,22.717-10.175,22.717-22.711c0-12.541-10.18-22.716-22.717-22.716h-22.711V233.648c0-11.083-8.91-19.991-19.991-19.991  H154.602c-12.536,0-22.713,10.177-22.713,22.713c0,12.538,10.177,22.715,22.713,22.715H177.317z" /></svg>');
					htp.p('<span>Logs</span>');
				htp.p('</a></li>');

				htp.p('<li><a title="Lov" data-menu="lov" data-refresh="" data-carrega="list_cdesc" data-attrib="">');
					htp.p('<svg contentStyleType="text/css" enable-background="new 0 0 2048 2048" height="2048px" preserveAspectRatio="xMidYMid meet" version="1.1" viewBox="15.0 0 1777.0 2048" width="1777.0px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" zoomAndPan="magnify"><path d="M381,1748c0,53.333-18.167,95.333-54.5,126s-81.5,46-135.5,46c-70.667,0-128-22-172-66l57-88c32.667,30,68,45,106,45  c19.333,0,36.167-4.833,50.5-14.5s21.5-23.833,21.5-42.5c0-42.667-35-61.333-105-56l-26-56c5.333-6.667,16.167-21.167,32.5-43.5  s30.5-40.333,42.5-54s24.333-26.5,37-38.5v-1c-10.667,0-26.833,0.333-48.5,1s-37.833,1-48.5,1v53H32v-152h333v88l-95,115  c34,8,61,24.333,81,49S381,1714,381,1748z M383,1121v159H21c-4-24-6-42-6-54c0-34,7.833-65,23.5-93s34.5-50.667,56.5-68  s44-33.167,66-47.5c22-14.333,40.833-28.833,56.5-43.5s23.5-29.667,23.5-45c0-16.667-4.833-29.5-14.5-38.5S203.667,877,187,877  c-30.667,0-57.667,19.333-81,58l-85-59c16-34,39.833-60.5,71.5-79.5S159.333,768,198,768c48.667,0,89.667,13.833,123,41.5  s50,65.167,50,112.5c0,33.333-11.333,63.833-34,91.5c-22.667,27.667-47.667,49.167-75,64.5s-52.5,32.167-75.5,50.5  s-34.833,35.833-35.5,52.5h127v-60H383z M1792,1440v192c0,8.667-3.167,16.167-9.5,22.5s-13.833,9.5-22.5,9.5H544  c-8.667,0-16.167-3.167-22.5-9.5s-9.5-13.833-9.5-22.5v-192c0-9.333,3-17,9-23s13.667-9,23-9h1216c8.667,0,16.167,3.167,22.5,9.5  S1792,1431.333,1792,1440z M384,541v99H49v-99h107c0-27.333,0.167-68,0.5-122s0.5-94.333,0.5-121v-12h-2  c-5.333,11.333-22,29.333-50,54l-71-76l136-127h106v404H384z M1792,928v192c0,8.667-3.167,16.167-9.5,22.5s-13.833,9.5-22.5,9.5H544  c-8.667,0-16.167-3.167-22.5-9.5s-9.5-13.833-9.5-22.5V928c0-9.333,3-17,9-23s13.667-9,23-9h1216c8.667,0,16.167,3.167,22.5,9.5  S1792,919.333,1792,928z M1792,416v192c0,8.667-3.167,16.167-9.5,22.5s-13.833,9.5-22.5,9.5H544c-8.667,0-16.167-3.167-22.5-9.5  S512,616.667,512,608V416c0-8.667,3.167-16.167,9.5-22.5s13.833-9.5,22.5-9.5h1216c8.667,0,16.167,3.167,22.5,9.5  S1792,407.333,1792,416z"/></svg>');
					htp.p('<span>Lov</span>');
				htp.p('</a></li>');

				htp.p('<li><a title="'||fun.lang('M&aacute;scaras')||'" data-menu="mask" data-refresh="" data-carrega="mask" data-attrib="">');
					htp.p('<svg enable-background="new 0 0 500 500" version="1.1" viewBox="0 0 500 500" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path clip-rule="evenodd" d="M36.992,416.569c0,20.078,16.262,36.344,36.34,36.344h118.111  c20.079,0,36.343-16.266,36.343-36.344V271.202c0-20.079-16.264-36.342-36.343-36.342h-58.328c-10.089,0-18.17-8.177-18.17-18.17  c0-3.271,0.815-5.542,0.815-5.542c13.264-43.977,46.785-79.227,89.762-94.852l0.18-0.182c12.997-5.54,22.083-18.445,22.083-33.437  c0-20.077-16.264-36.341-36.343-36.341c-4.906,0-9.536,0.998-13.804,2.723l-1.644,0.64C94.68,81.405,36.992,160.45,36.992,253.03  V416.569z M273.215,416.569c0,20.078,16.262,36.344,36.341,36.344h118.112c20.078,0,36.34-16.266,36.34-36.344V271.202  c0-20.079-16.262-36.342-36.34-36.342h-58.33c-10.088,0-18.169-8.177-18.169-18.17c0-3.362,0.813-5.542,0.813-5.542  c13.267-43.977,46.787-79.227,89.765-94.852l0.18-0.182c12.995-5.54,22.081-18.445,22.081-33.437  c0-20.077-16.262-36.341-36.34-36.341c-4.906,0-9.538,0.998-13.805,2.723l-1.644,0.64C330.903,81.405,273.215,160.45,273.215,253.03  V416.569z"/></svg>');
					htp.p('<span>'||fun.lang('M&aacute;scaras')||'</span>');
				htp.p('</a></li>');

				/*htp.p('<li><a title="Notifica&ccedil;&otilde;es" data-menu="" data-refresh="" data-carrega="notify_list" onclick="carregaPainel('''');" data-attrib="">');
				htp.p('<svg enable-background="new 0 0 500 500" height="500px" version="1.1" viewBox="0 0 500 500" width="500px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path clip-rule="evenodd" d="M36.992,445.34c0,12.536,10.175,22.711,22.713,22.711h381.592  c12.536,0,22.711-10.175,22.711-22.711c0-12.541-10.175-22.716-22.711-22.716h-49.974L271.935,47.12  c-3.174-8.907-11.535-15.171-21.435-15.171c-9.902,0-18.26,6.264-21.44,15.083L109.675,422.624h-49.97  C47.167,422.624,36.992,432.799,36.992,445.34z M168.731,377.198l19.079-63.6h125.382l19.078,63.6H168.731z M212.338,231.83  l21.81-72.685h32.705l21.806,72.685H212.338z" /></svg>');
				htp.p('<span>'||fun.lang('Notifica&ccedil;&otilde;es')||'</span>');
				htp.p('</a></li>');*/

				htp.p('<li><a title="'||fun.lang('Objetos')||'" data-menu="objetos" data-refresh="" data-carrega="load_tipos" data-attrib="">');
					htp.p('<svg enable-background="new 0 0 500 500" height="500px" version="1.1" viewBox="0 0 500 500" width="500px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path clip-rule="evenodd" d="M276.353,330.091l26.44,26.44c8.712,8.721,22.791,8.721,31.516,0  c8.729-8.723,8.729-22.814,0-31.526l-26.346-26.44l26.346-26.349c0,0-99.756-42.613-103.845-44.156  c-2.184-0.82-4.455-1.272-6.815-1.272c-10.54,0-19.075,8.45-19.075,18.898c0,2.453,0.45,4.725,1.276,6.814  c1.543,3.905,44.15,104.031,44.15,104.031L276.353,330.091z M31.949,417.582c0,20.079,16.264,36.341,36.34,36.341h363.421  c20.078,0,36.34-16.262,36.34-36.341V81.42c0-20.079-16.262-36.343-36.34-36.343H68.29c-20.077,0-36.34,16.264-36.34,36.343V417.582  z M97.367,172.274h305.267c11.084,0,19.99,8.903,19.99,19.989v196.24c0,11.085-8.906,19.992-19.99,19.992H97.367  c-11.083,0-19.991-8.907-19.991-19.992v-196.24C77.375,181.178,86.284,172.274,97.367,172.274z M77.375,113.219  c0-12.539,10.177-22.713,22.714-22.713c12.538,0,22.713,10.174,22.713,22.713c0,12.536-10.175,22.713-22.713,22.713  C87.553,135.932,77.375,125.755,77.375,113.219z M159.145,113.219c0-12.539,10.177-22.713,22.713-22.713  c12.539,0,22.716,10.174,22.716,22.713c0,12.536-10.177,22.713-22.716,22.713C169.322,135.932,159.145,125.755,159.145,113.219z   M240.914,113.219c0-12.539,10.177-22.713,22.715-22.713c12.537,0,22.712,10.174,22.712,22.713  c0,12.536-10.175,22.713-22.712,22.713C251.091,135.932,240.914,125.755,240.914,113.219z"/></svg>');
					htp.p('<span>'||fun.lang('Objetos')||'</span>');
				htp.p('</a></li>');

				htp.p('<li><a title="'||fun.lang('Padr&atilde;o de Par&acirc;metros')||'" data-menu="param" data-refresh="" data-carrega="list_vpadrao" data-attrib="">');
					htp.p('<svg enable-background="new 0 0 500 500" height="500px" version="1.1" viewBox="0 0 500 500" width="500px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path clip-rule="evenodd" d="M314.099,250H186.901c-12.536,0-22.713,10.175-22.713,22.715  c0,12.537,10.177,22.712,22.713,22.712h127.198c12.537,0,22.716-10.175,22.716-22.712C336.814,260.175,326.636,250,314.099,250z   M314.099,331.771H186.901c-12.536,0-22.713,10.175-22.713,22.711s10.177,22.716,22.713,22.716h127.198  c12.537,0,22.716-10.18,22.716-22.716S326.636,331.771,314.099,331.771z M73.333,431.711c0,20.078,16.264,36.34,36.343,36.34  h281.648c20.078,0,36.345-16.262,36.345-36.34V122.802c0-20.077-16.267-36.341-36.345-36.341h-74.049  c-6.263-31.071-33.797-54.512-66.774-54.512c-32.98,0-60.512,23.441-66.774,54.512h-74.051c-20.079,0-36.343,16.264-36.343,36.341  V431.711z M138.75,131.889h43.607v16.353c0,11.081,8.909,19.989,19.991,19.989h96.301c11.08,0,19.991-8.909,19.991-19.989v-16.353  h43.607c11.081,0,19.992,8.909,19.992,19.991v250.754c0,11.084-8.911,19.99-19.992,19.99H138.75  c-11.083,0-19.989-8.906-19.989-19.99V151.879C118.761,140.797,127.667,131.889,138.75,131.889z M227.787,100.089  c0-12.537,10.177-22.714,22.713-22.714c12.537,0,22.715,10.177,22.715,22.714c0,12.538-10.178,22.713-22.715,22.713  C237.964,122.802,227.787,112.627,227.787,100.089z"/></svg>');
					htp.p('<span>'||fun.lang('Padr&otilde;es')||'</span>');
				htp.p('</a></li>');

				htp.p('<li><a title="'||fun.lang('Processos')||'" data-menu="" data-refresh="processos" data-refresh-ativo="S" data-carrega="processos" onclick="carregaPainel('''');" data-attrib="" data-url="prm_completo=S">');
					htp.p('<svg enable-background="new 0 0 500 500" height="500px" version="1.1" viewBox="0 0 500 500" width="500px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path clip-rule="evenodd" d="M349.938,127.345c0,12.539,10.18,22.715,22.717,22.715  c12.535,0,22.711-10.177,22.711-22.715c0-12.536-10.176-22.713-22.711-22.713C360.118,104.632,349.938,114.809,349.938,127.345z   M349.938,272.715c0,12.537,10.18,22.712,22.717,22.712c12.535,0,22.711-10.175,22.711-22.712c0-12.54-10.176-22.715-22.711-22.715  C360.118,250,349.938,260.175,349.938,272.715z M31.949,331.771c0,20.074,16.264,36.341,36.34,36.341h154.454v25.072  c-4.453,2.999-8.269,6.815-11.268,11.268H100.089c-12.537,0-22.714,10.179-22.714,22.716c0,12.535,10.177,22.711,22.714,22.711  h111.386c7.355,10.997,19.804,18.172,33.981,18.172c14.18,0,26.616-7.175,33.983-18.172h120.469  c12.54,0,22.715-10.176,22.715-22.711c0-12.537-10.175-22.716-22.715-22.716H279.44c-3-4.452-6.817-8.269-11.269-11.268v-25.072  h163.539c20.078,0,36.34-16.267,36.34-36.341V68.29c0-20.077-16.262-36.34-36.34-36.34H68.29c-20.077,0-36.34,16.264-36.34,36.34  V331.771z M97.367,77.375h305.267c11.084,0,19.99,8.905,19.99,19.991v59.959c0,11.086-8.906,19.991-19.99,19.991H97.367  c-11.083,0-19.991-8.905-19.991-19.991V97.367C77.375,86.28,86.284,77.375,97.367,77.375z M97.367,222.744h305.267  c11.084,0,19.99,8.904,19.99,19.989v59.961c0,11.081-8.906,19.991-19.99,19.991H97.367c-11.083,0-19.991-8.91-19.991-19.991v-59.961  C77.375,231.648,86.284,222.744,97.367,222.744z"/></svg>');
					htp.p('<span>'||fun.lang('Processos')||'</span>');
				htp.p('</a></li>');

				htp.p('<li><a title="'||fun.lang('Sinalizador')||'" data-menu="sinal" data-refresh="" data-carrega="list_sinal" data-attrib="">');
					htp.p('<svg enable-background="new 0 0 500 500" height="500px" version="1.1" viewBox="0 0 500 500" width="500px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path clip-rule="evenodd" d="M341.864,135.423c0,12.536,10.175,22.713,22.716,22.713  c12.536,0,22.711-10.177,22.711-22.713c0-12.538-10.175-22.715-22.711-22.715C352.039,112.708,341.864,122.885,341.864,135.423z   M183.045,456.5c14.002,14.092,36.716,14.092,50.788,0l222.051-220.592c8.902-8.904,13.354-20.625,13.179-32.346V76.002  c0-24.895-20.179-45.063-45.064-45.063h-127.56c-11.724-0.182-23.441,4.268-32.353,13.176L43.499,266.162  c-14.09,14.076-14.09,36.791,0,50.792L183.045,456.5z M305.524,135.423c0-32.615,26.437-59.056,59.056-59.056  c32.615,0,59.052,26.441,59.052,59.056s-26.437,59.055-59.052,59.055C331.961,194.478,305.524,168.038,305.524,135.423z"/></svg>');
					htp.p('<span>'||fun.lang('Sinalizador')||'</span>');
				htp.p('</a></li>');

				htp.p('<li><a title="'||fun.lang('Usu&aacute;rios')||'" data-menu="usuarios" data-refresh="" data-carrega="list_users" data-attrib="">');
					--htp.p('<svg enable-background="new -0.709 -3.459 141.732 141.732" height="141.732px" version="1.1" viewBox="-0.709 -3.459 141.732 141.732" width="141.732px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="Livello_101"><path d="M70.157,78.355c17.968,0,32.535-17.541,32.535-39.178C102.692,17.54,88.125,0,70.157,0S37.623,17.541,37.623,39.178   C37.623,60.815,52.189,78.355,70.157,78.355 M70.157,78.355c-37.146,0-67.548,24.904-70.157,56.46h140.314   C137.705,103.26,107.304,78.355,70.157,78.355"/></g><g id="Livello_1_1_"/></svg>');
					htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="45.532px" height="45.532px" viewBox="0 0 45.532 45.532" style="enable-background:new 0 0 45.532 45.532;" xml:space="preserve"> <g> <path d="M22.766,0.001C10.194,0.001,0,10.193,0,22.766s10.193,22.765,22.766,22.765c12.574,0,22.766-10.192,22.766-22.765 S35.34,0.001,22.766,0.001z M22.766,6.808c4.16,0,7.531,3.372,7.531,7.53c0,4.159-3.371,7.53-7.531,7.53 c-4.158,0-7.529-3.371-7.529-7.53C15.237,10.18,18.608,6.808,22.766,6.808z M22.761,39.579c-4.149,0-7.949-1.511-10.88-4.012 c-0.714-0.609-1.126-1.502-1.126-2.439c0-4.217,3.413-7.592,7.631-7.592h8.762c4.219,0,7.619,3.375,7.619,7.592 c0,0.938-0.41,1.829-1.125,2.438C30.712,38.068,26.911,39.579,22.761,39.579z"/> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
					htp.p('<span>'||fun.lang('Usu&aacute;rios')||'</span>');
				htp.p('</a></li>');

				htp.p('<li><a title="'||fun.lang('View')||'" data-menu="visoes" data-refresh="" data-carrega="load_tables" data-attrib="">');
					htp.p('<svg enable-background="new 0 0 500 500" height="500px" version="1.1" viewBox="0 0 500 500" width="500px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path clip-rule="evenodd" d="M195.448,250.001c0,30.078,24.434,54.513,54.513,54.513  c30.078,0,54.513-24.435,54.513-54.513v-0.453c-5.819,5.905-13.805,9.539-22.715,9.539c-17.539,0-31.798-14.264-31.798-31.799  c0-12.626,7.443-23.623,18.08-28.712c-5.631-1.997-11.718-3.087-18.08-3.087C219.882,195.488,195.448,219.926,195.448,250.001z   M455.839,219.017c-33.804-42.97-116.113-114.384-205.79-114.384c-89.762,0-172.162,71.415-205.967,114.384  c-7.63,9.814-11.809,20.444-12.083,30.984c0.275,10.541,4.453,21.171,12.083,30.983c33.806,42.979,116.115,114.383,205.879,114.383  s172.074-71.404,205.878-114.383c7.718-9.813,11.898-20.442,12.173-30.983C467.737,239.461,463.557,228.831,455.839,219.017z   M249.961,340.854c-50.147,0-90.855-40.703-90.855-90.853c0-50.151,40.708-90.855,90.855-90.855  c50.146,0,90.854,40.704,90.854,90.855C340.814,300.15,300.106,340.854,249.961,340.854z"/></svg>');
					htp.p('<span>'||fun.lang('Vis&otilde;es')||'</span>');
				htp.p('</a></li>');
				
				htp.p('<li><a title="'||fun.lang('Importar')||'" data-menu="import" data-refresh="" data-carrega="main" data-package="imp" data-attrib="">');
					htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve"> <g> <g> <path d="M495.343,45.601H221.818c-9.199,0-16.657,7.458-16.657,16.657V91.18H16.657C7.458,91.18,0,98.638,0,107.837v341.906 c0,9.199,7.458,16.657,16.657,16.657h341.918c9.199,0,16.657-7.458,16.657-16.657V261.25h120.112 c9.199,0,16.657-7.458,16.657-16.657V62.257C512,53.058,504.542,45.601,495.343,45.601z M341.918,433.086H33.313V124.493h171.847 v113.21l-40.56,40.56l-13.646-13.647c-9.057-9.059-24.555-4.896-27.867,7.467l-18.612,69.462 c-3.297,12.295,7.966,23.731,20.4,20.401l69.462-18.612c12.38-3.319,16.515-18.821,7.467-27.868l-13.647-13.647l40.565-40.565 h113.197V433.086z M478.687,227.936H238.48c0-101.027-0.006-146.919-0.006-149.022h240.212V227.936z"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
					htp.p('<span>'||fun.lang('Importar')||'</span>');
				htp.p('</a></li>');

				/*htp.p('<li><a title="Edi&ccedil;&atilde;o de Views" data-menu="editview" data-refresh="" data-carrega="edit_dado" data-attrib="" data-ace="edit-view">');
					htp.p('<svg enable-background="new 0 0 32 32" height="32px" version="1.1" viewBox="0 0 32 32" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:svg="http://www.w3.org/2000/svg"><g><rect fill="none" height="32" width="32"/></g><g id="document_x5F_text_x5F_edit"><path d="M24,14.059V5.584L18.414,0H0v32h24v-0.059c4.499-0.5,7.998-4.309,8-8.941C31.998,18.366,28.499,14.556,24,14.059z    M17.998,2.413L21.586,6h-3.588V2.413z M2,30V1.998h14v6.001h6v6.06c-1.752,0.194-3.352,0.89-4.652,1.941H4v2h11.517   c-0.412,0.616-0.743,1.289-0.994,2H4v2h10.059C14.022,22.329,14,22.661,14,23c0,2.829,1.308,5.351,3.349,7H2z M23,29.883   c-3.801-0.009-6.876-3.084-6.885-6.883c0.009-3.801,3.084-6.876,6.885-6.885c3.799,0.009,6.874,3.084,6.883,6.885   C29.874,26.799,26.799,29.874,23,29.883z M20,12H4v2h16V12z"/><g><polygon points="22,27 19,27 19,24   "/><rect height="4.243" transform="matrix(-0.7071 0.7071 -0.7071 -0.7071 56.5269 20.5858)" width="7.071" x="20.464" y="19.879"/></g></g></svg>');
					htp.p('<span>'||fun.lang('Edi&ccedil;&atilde;o')||'</span>');
				htp.p('</a></li>');*/

				htp.p('<li><a title="SQL" data-menu="" data-refresh="" data-carrega="sqlparse" data-attrib="" data-ace="sqlquery">');
					htp.p('<svg enable-background="new 0 0 32 32" height="32px" version="1.1" viewBox="0 0 32 32" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:svg="http://www.w3.org/2000/svg"><g><rect fill="none" height="32" width="32"/></g><g id="database_x5F_run"><path d="M29.998,17.348V4.999c0.027-0.272-0.205-1.715-2.102-2.851C26.012,0.997,22.598,0.004,16.002,0   C9.403,0.004,5.989,0.997,4.103,2.148C2.208,3.283,1.975,4.726,2.002,4.999v22.74c-0.035,0.353,0.305,1.628,2.176,2.525   C6.045,31.19,9.417,31.994,16,32c1.978-0.002,3.66-0.076,5.104-0.204C21.716,31.927,22.349,32,22.999,32   c4.971-0.002,8.999-4.03,9.001-9.001C31.999,20.856,31.248,18.893,29.998,17.348z M16,30c-6.414,0.007-9.541-0.821-10.924-1.524   c-0.694-0.35-0.987-0.648-1.075-0.78c-0.018-0.027,0.009-0.047,0.002-0.062L4,7.783C4.037,7.806,4.065,7.83,4.103,7.852   C5.989,9.001,9.403,9.993,16.002,10c6.596-0.006,10.01-0.999,11.895-2.147C27.934,7.83,27.963,7.805,28,7.783v7.735   C26.569,14.561,24.85,14,22.999,14c-4.972,0.002-8.998,4.027-9,8.999c0.001,2.822,1.301,5.338,3.333,6.988   C16.902,29.995,16.465,30.001,16,30z M22.999,29.998c-3.865-0.006-6.992-3.133-7-6.999c0.008-3.865,3.135-6.991,7-7   c3.866,0.009,6.993,3.135,6.999,7C29.992,26.865,26.865,29.992,22.999,29.998z"/><polygon points="22,19 22,27 26,23  "/></g></svg>');
					htp.p('<span>Sql</span>');
				htp.p('</a></li>');

				if nvl(fun.ret_var('COM_ATIVO'),'N') = 'S' then
					htp.p('<li><a title="Report via E-mail" data-menu="report" data-refresh="report" data-refresh-pkg="com" data-refresh-ativo="N" data-carrega="report" data-package="com" data-attrib="" data-ace="">');
						htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve"> <g> <g> <path d="M467,80.609H45c-24.813,0-45,20.187-45,45v260.782c0,24.813,20.187,45,45,45h422c24.813,0,45-20.187,45-45V125.609 C512,100.796,491.813,80.609,467,80.609z M461.127,110.609l-6.006,5.001L273.854,266.551c-10.346,8.614-25.364,8.614-35.708,0 L56.879,115.61l-6.006-5.001H461.127z M30,132.267L177.692,255.25L30,353.543V132.267z M467,401.391H45 c-7.248,0-13.31-5.168-14.699-12.011l171.445-114.101l17.204,14.326c10.734,8.938,23.893,13.407,37.051,13.407 c13.158,0,26.316-4.469,37.051-13.407l17.204-14.326l171.444,114.1C480.31,396.224,474.248,401.391,467,401.391z M482,353.543 l-147.692-98.292L482,132.267V353.543z"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
						htp.p('<span>Report</span>');
					htp.p('</a></li>');
				end if;

				if gbl.getNivelUpquery (ws_usuario) = 'A' then
					htp.p('<li><a title="UPDATE" data-menu="autoupdate_tela" data-refresh="" data-carrega="autoUpdate_tela" data-attrib="" data-ace="">');
						htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve"> <g> <g> <polygon points="371.425,135.5 371.425,60 141.425,60 141.425,135.5 60.212,135.5 256.425,331.713 452.639,135.5 		"/> </g> </g> <g> <g> <rect x="141.43" width="230" height="30"/> </g> </g> <g> <g> <rect x="319.78" y="392" width="112.65" height="120"/> </g> </g> <g> <g> <polygon points="154.286,302 1.212,302 61.212,362 214.286,362 		"/> </g> </g> <g> <g> <rect x="82.42" y="392" width="207.35" height="120"/> </g> </g> <g> <g> <polygon points="358.565,302 298.565,362 452.788,362 510.788,302 		"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
						htp.p('<span>Update</span>');
					htp.p('</a></li>');
				end if;

				htp.p('<li><a title="'||fun.lang('Tokens')||'" data-menu="" data-refresh="tokens" data-refresh-ativo="S" data-carrega="tokens" data-attrib="" onclick="carregaPainel('''');">');
					htp.p('<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Layer_1" x="0px" y="0px" viewBox="0 0 64 64" style="enable-background:new 0 0 64 64;" xml:space="preserve"><path  d="M58.01,0.55H6.1c-3.06,0-5.54,2.48-5.54,5.54v51.91c0,3.06,2.48,5.54,5.54,5.54h51.91  c3.06,0,5.54-2.48,5.54-5.54V6.1C63.55,3.03,61.07,0.55,58.01,0.55z M14.72,20.73c-0.42-1.27-0.17-2.53,0.41-3.71  c0.21-0.42,0.27-0.62-0.21-0.9c-2.8-1.61-3.9-2.25-6.69-3.88c-0.15-0.09-0.32-0.15-0.49-0.18c-0.21-0.03-0.55,0.44-0.6-0.02  c-0.04-0.41,0.21-0.87,0.66-1.08c0.11-0.05,0.29,0.01,0.27,0.13c-0.17,0.76,0.51,0.76,0.89,0.99c2.59,1.55,3.52,2.06,6.12,3.59  c0.4,0.24,0.7,0.4,1.12-0.09c0.54-0.63,1.31-1.03,2.11-1.26c0.45-0.13,0.61-0.31,0.65-0.78c0.26-3.05,0.58-6.09,0.84-9.13  c0.05-0.52,0.32-1.16-0.47-1.46c0.36-0.35,0.71-0.35,1.01-0.25c0.22,0.07,1.05,0.12,0.21,0.61c-0.2,0.12-0.16,0.3-0.18,0.46  c-0.3,3.19-0.6,6.38-0.91,9.58c-0.05,0.55,0.06,0.73,0.67,0.73c1.57,0.01,2.89,0.68,3.87,1.89c0.4,0.49,0.69,0.47,1.18,0.21  c5.94-3.08,10.69-6.14,16.64-9.2c0.18-0.09,0.37-0.17,0.56-0.27c1.83-0.91,3.26-0.45,4.21,1.38c1.41,2.71,2.79,5.42,4.18,8.14  c1.85,3.6,3.71,7.2,5.56,10.81c0.17,0.34,0.33,0.68,0.54,1.11c-0.8,0-1.49,0-2.13,0L45.01,9.27l-1.56,0.8l9.32,18.08  c-0.49,0-0.99,0-1.53,0l-8.63-16.75l-1.56,0.8l8.22,15.94c-0.51,0-1.02,0-1.53,0l-7.53-14.6l-1.56,0.8l7.12,13.8  c-0.42,0-0.84,0.01-1.26,0.02c-0.55,0.01-0.84-0.16-1.09-0.66c-1.76-3.49-3.57-6.94-5.32-10.43c-0.34-0.68-0.63-0.71-1.27-0.37  c-7.17,3.72-14.36,7.4-21.53,11.1c-0.49,0.25-0.98,0.37-1.53,0.36c-2.08-0.02-3.75-0.03-5.83,0.01c-0.59,0.01-0.77-0.18-0.77-0.75  c0-1.28,0.63-2.11,1.73-2.67c1.92-0.98,3.41-1.98,5.35-2.95C14.73,21.55,14.92,21.34,14.72,20.73z M54.64,36.71  c-2.92,7.95-5.85,15.89-8.75,23.84c-0.24,0.66-0.52,0.93-1.26,0.9c-1.66-0.07-3.33-0.05-5,0c-0.59,0.02-0.81-0.21-1-0.73  c-3.02-8.22-6.07-16.43-9.09-24.66c-0.18-0.49-0.38-0.71-0.94-0.69c-1.34,0.04-2.68,0.06-4.02,0c-0.71-0.03-0.82,0.24-0.82,0.87  c0.02,8.07,0,16.14,0.03,24.21c0,0.82-0.21,1.04-1.01,1.01c-1.58-0.07-3.16-0.06-4.73,0c-0.7,0.02-0.88-0.17-0.88-0.88  c0.03-8.04,0-16.08,0.04-24.12c0.01-0.95-0.28-1.11-1.14-1.09c-2.71,0.06-5.42,0-8.13,0.04c-0.64,0.01-0.8-0.19-0.78-0.8  c0.05-1.13,0.07-2.27-0.01-3.39c-0.06-0.81,0.26-0.89,0.96-0.89c6.46,0.03,12.92,0.01,19.38,0.01c1.99,0,3.99,0.02,5.98-0.01  c0.55-0.01,0.83,0.1,1.01,0.69c2.47,8.07,5.32,16.02,7.54,24.17c0.05,0.17,0.14,0.32,0.24,0.56c0.59-2.03,1.11-3.99,1.72-5.93  c1.97-6.24,3.98-12.47,5.95-18.71c0.18-0.57,0.4-0.81,1.04-0.79c1.96,0.05,3.93,0.02,5.99,0.02C56.18,32.5,55.41,34.61,54.64,36.71z  "/></svg>');
					htp.p('<span>'||fun.lang('Tokens')||'</span>');
				htp.p('</a></li>');

				htp.p('<li><a title="'||fun.lang('Marcadores Geolocaliza&ccedil;&atilde;o')||'" data-menu="mapa_marcador" data-refresh="" data-carrega="list_mapa_marcador" data-attrib="">');
					htp.p('<svg viewBox="0 0 140 140" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path clip-rule="evenodd" d="M117.87,58.42c0-21.66-17.56-39.23-39.23-39.23s-39.23,17.56-39.23,39.23c0,0-.98,39.46,39.23,79.66,40.2-40.2,39.23-79.66,39.23-79.66Zm-39.23,15.94c-8.85,0-16.03-7.18-16.03-16.03s7.17-16.03,16.03-16.03,16.03,7.18,16.03,16.03-7.17,16.03-16.03,16.03Z"/></svg>');
					htp.p('<span>'||fun.lang('Marcadores')||'</span>');
				htp.p('</a></li>');

                htp.p('<li><a title="'||fun.lang('Avisos')||'" data-menu="avisos" data-refresh=""  data-refresh-pkg="" data-refresh-ativo="N" data-carrega="avisos" data-package="cfg" data-attrib="">');
					htp.p('<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 1280 1280" xml:space="preserve"><path clip-rule="evenodd" d="M1123.84,1046.53c-32.39-65.58-64.67-131.22-97.83-196.4c-33.5-65.83-39.67-135.18-38.94-209.15  c0.84-85.46,3-170.1,2.82-255.57c-0.25-117.03-49.54-220.45-131.2-288.26C769.53,16.96,669.91,13.2,641.64,11.91v-0.16  c-0.5,0.03-1.06,0.06-1.64,0.08c-0.58-0.03-1.13-0.06-1.64-0.08v0.16c-28.28,1.3-127.89,5.05-217.06,85.25  c-81.66,67.81-130.95,171.23-131.2,288.26c-0.18,85.47,1.98,170.11,2.82,255.57c0.73,73.97-5.44,143.32-38.94,209.15  c-33.16,65.18-65.44,130.82-97.83,196.4c-19.55,39.58-7.67,70.57,36.6,70.66c82.4,0.17,164.8,0.27,247.19-0.18  c13-0.07,19.58,2.25,23.95,16.79c23.66,78.73,95.11,128.01,174.46,134.22v0.24c0.55-0.03,1.09-0.08,1.64-0.12  c0.55,0.04,1.09,0.08,1.64,0.12v-0.24c79.35-6.22,150.8-55.49,174.46-134.22c4.37-14.54,10.95-16.86,23.95-16.79  c82.39,0.45,164.79,0.35,247.19,0.18C1131.51,1117.1,1143.39,1086.11,1123.84,1046.53z M640,1189.43  c-41.84-6.09-65.29-35.47-76.01-75.77c29.71,0,47.26,0,74.37,0c1.08,0,2.16,0,3.27,0c27.12,0,44.66,0,74.37,0  C705.29,1153.96,681.84,1183.34,640,1189.43z M975.77,1023.53c-121.9-0.58-215.14-0.04-335.77,0c-120.63-0.03-213.88-0.57-335.77,0  c-19.32,0.09-16.46-4.57-7.06-24c34.14-70.62,61.35-114.95,84.71-190.59c13.34-43.19,9.9-96.53,9.88-141.93  c-0.05-94.66,2.92-189.34,4.24-283.98c1.36-97.45,26.82-161.38,104.47-230.56C530.29,130.66,577.3,97.62,640,96.1  c62.7,1.52,109.71,34.56,139.54,56.37c77.65,69.18,103.11,133.11,104.47,230.56c1.32,94.64,4.29,189.32,4.24,283.98  c-0.02,45.4-3.46,98.74,9.88,141.93c23.36,75.64,50.57,119.97,84.71,190.59C992.23,1018.96,995.09,1023.62,975.77,1023.53z"></path></svg>');
					htp.p('<span>'||fun.lang('Avisos')||'</span>');
				htp.p('</a></li>');


			elsif fun.user_permissao(ws_usuario, 'TELAS_USUARIOS') = 'S' then 

				htp.p('<li><a title="'||fun.lang('Usu&aacute;rios')||'" data-menu="usuarios" data-refresh="" data-carrega="list_users" data-attrib="">');
					htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="45.532px" height="45.532px" viewBox="0 0 45.532 45.532" style="enable-background:new 0 0 45.532 45.532;" xml:space="preserve"> <g> <path d="M22.766,0.001C10.194,0.001,0,10.193,0,22.766s10.193,22.765,22.766,22.765c12.574,0,22.766-10.192,22.766-22.765 S35.34,0.001,22.766,0.001z M22.766,6.808c4.16,0,7.531,3.372,7.531,7.53c0,4.159-3.371,7.53-7.531,7.53 c-4.158,0-7.529-3.371-7.529-7.53C15.237,10.18,18.608,6.808,22.766,6.808z M22.761,39.579c-4.149,0-7.949-1.511-10.88-4.012 c-0.714-0.609-1.126-1.502-1.126-2.439c0-4.217,3.413-7.592,7.631-7.592h8.762c4.219,0,7.619,3.375,7.619,7.592 c0,0.938-0.41,1.829-1.125,2.438C30.712,38.068,26.911,39.579,22.761,39.579z"/> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
					htp.p('<span>'||fun.lang('Usu&aacute;rios')||'</span>');
				htp.p('</a></li>');

				htp.p('<li><a title="'||fun.lang('Grupos De Usu&aacute;rios')||'" data-menu="gusuarios" data-refresh="" data-carrega="gusuarios" data-attrib="">');
					htp.p('<svg enable-background="new 0 0 32 32" height="32px" version="1.1" viewBox="0 0 32 32" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:svg="http://www.w3.org/2000/svg"><g><rect fill="none" height="32" width="32"/></g><g id="group_x5F_full"><g><path d="M8,20c0-2,0-10,0-10s0.005-0.45,0.239-1C6.16,9,4,9,4,9s-2,0-2,2v7c0,2,2,2,2,2v10h6v-8C10,22,8,22,8,20z M8,8    c0.52,0,1.001-0.144,1.427-0.376c0.059-0.036,0.125-0.068,0.188-0.103C10.446,6.988,11,6.061,11,5c0-1.657-1.343-3-3-3    S5,3.343,5,5S6.343,8,8,8z M28,9h-4.238C23.995,9.55,24,10,24,10s0,8,0,10s-2,2-2,2v8h6V20c0,0,2,0,2-2s0-7,0-7S30,9,28,9z     M22.38,7.519c0.065,0.035,0.134,0.068,0.194,0.105C23,7.856,23.48,8,24,8c1.657,0,3-1.343,3-3s-1.343-3-3-3s-3,1.343-3,3    C21,6.059,21.552,6.985,22.38,7.519z M16,8c1.657,0,3-1.343,3-3s-1.343-3-3-3s-3,1.343-3,3S14.343,8,16,8z M22,11c0,0,0-2-2-2    c-0.5,0-8,0-8,0s-2,0-2,2v7c0,2,2,2,2,2v10h8V20c0,0,2,0,2-2S22,11,22,11z"/></g></g></svg>');
					htp.p('<span>'||fun.lang('Grupos')||'</span>');
				htp.p('</a></li>');

				htp.p('<li><a title="'||fun.lang('Filtros De Usu&aacute;rios')||'" data-menu="filtrou" data-refresh="" data-carrega="filtro_geral" data-attrib="">');
					htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="971.986px" height="971.986px" viewBox="0 0 971.986 971.986" style="enable-background:new 0 0 971.986 971.986;" xml:space="preserve"> <g> <path d="M370.216,459.3c10.2,11.1,15.8,25.6,15.8,40.6v442c0,26.601,32.1,40.101,51.1,21.4l123.3-141.3 c16.5-19.8,25.6-29.601,25.6-49.2V500c0-15,5.7-29.5,15.8-40.601L955.615,75.5c26.5-28.8,6.101-75.5-33.1-75.5h-873 c-39.2,0-59.7,46.6-33.1,75.5L370.216,459.3z"/> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
					htp.p('<span>'||fun.lang('Filtros')||'</span>');
				htp.p('</a></li>');
			
			end if;

			htp.p('</ul>');			

			-- Monta conteudo da aba ETL 
			htp.p('<ul id="form-prefdrop-etl" class="form-config '||ws_etl_closed||'" onmouseenter="this.focus();">');

				htp.p('<li><a title="'||fun.lang('Agendador de tarefas')||'" data-menu="etl_run" data-refresh="etl_run_list" data-refresh-pkg="etl" data-carrega="etl_run_list" data-package="etl" data-attrib="">');
				--htp.p('<li><a title="'||fun.lang('Agendador de tarefas')||'" data-menu="etl_run" data-refresh="" data-refresh-pkg="etl" data-carrega="etl_run_list" data-package="etl" data-attrib="">');
					htp.p('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M17 3v-2c0-.552.447-1 1-1s1 .448 1 1v2c0 .552-.447 1-1 1s-1-.448-1-1zm-12 1c.553 0 1-.448 1-1v-2c0-.552-.447-1-1-1-.553 0-1 .448-1 1v2c0 .552.447 1 1 1zm13 13v-3h-1v4h3v-1h-2zm-5 .5c0 2.481 2.019 4.5 4.5 4.5s4.5-2.019 4.5-4.5-2.019-4.5-4.5-4.5-4.5 2.019-4.5 4.5zm11 0c0 3.59-2.91 6.5-6.5 6.5s-6.5-2.91-6.5-6.5 2.91-6.5 6.5-6.5 6.5 2.91 6.5 6.5zm-14.237 3.5h-7.763v-13h19v1.763c.727.33 1.399.757 2 1.268v-9.031h-3v1c0 1.316-1.278 2.339-2.658 1.894-.831-.268-1.342-1.111-1.342-1.984v-.91h-9v1c0 1.316-1.278 2.339-2.658 1.894-.831-.268-1.342-1.111-1.342-1.984v-.91h-3v21h11.031c-.511-.601-.938-1.273-1.268-2z"/></svg>');
					htp.p('<span>'||fun.lang('Tarefas')||'</span>');
				htp.p('</a></li>');

				htp.p('<li><a title="'||fun.lang('Conex&otilde;es')||'" data-menu="etl_conexoes" data-refresh="" data-carrega="etl_conexoes_list" data-package="etl" data-attrib="">');
					htp.p('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M1 3.488c0-1.926 4.656-3.488 10-3.488 5.345 0 10 1.562 10 3.488s-4.655 3.487-10 3.487c-5.344 0-10-1.561-10-3.487zm10 9.158c5.345 0 10-1.562 10-3.487v-2.44c-2.418 1.738-7.005 2.256-10 2.256-3.006 0-7.588-.523-10-2.256v2.44c0 1.926 4.656 3.487 10 3.487zm0 5.665c.34 0 .678-.007 1.011-.019.045-1.407.537-2.7 1.342-3.745-.839.067-1.643.1-2.353.1-3.006 0-7.588-.523-10-2.256v2.434c0 1.925 4.656 3.486 10 3.486zm1.254 1.97c-.438.02-.861.03-1.254.03-2.995 0-7.582-.518-10-2.256v2.458c0 1.925 4.656 3.487 10 3.487 1.284 0 2.526-.092 3.676-.256-1.155-.844-2.02-2.055-2.422-3.463zm10.746-1.781c0 2.485-2.017 4.5-4.5 4.5s-4.5-2.015-4.5-4.5 2.017-4.5 4.5-4.5 4.5 2.015 4.5 4.5zm-2.166-1.289l-2.063.557.916-1.925-1.387.392-1.466 3.034 1.739-.472-1.177 2.545 3.438-4.131z"/></svg>');
					htp.p('<span>'||fun.lang('Conex&otilde;es')||'</span>');
				htp.p('</a></li>');

				htp.p('<li><a title="'||fun.lang('A&ccedil;&otilde;es')||'" data-menu="etl_step" data-refresh="" data-carrega="etl_step_list" data-package="etl" data-attrib="">');
					htp.p('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 2c5.514 0 10 4.486 10 10s-4.486 10-10 10-10-4.486-10-10 4.486-10 10-10zm0-2c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm-3 17v-10l9 5.146-9 4.854z"/></svg>');
					htp.p('<span>'||fun.lang('A&ccedil;&otilde;es')||'</span>');
				htp.p('</a></li>');

				htp.p('<li><a title="'||fun.lang('Fila Integrador')||'" data-menu="" data-refresh="etl_fila_list"  data-refresh-pkg="etl" data-refresh-ativo="N" data-carrega="etl_fila_list" data-package="etl" data-attrib="">');
					htp.p('<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" id="Layer_1" ><g fill="rgb(0,0,0)"><path d="m14 3h-9v1h9z"></path><path d="m14 6h-9v1h9z"></path><path d="m14 9h-6.5v1h6.5z"></path><path d="m14 12h-9v1h9z"></path><path d="m2 7 3.5 2.5-3.5 2.5z"></path></g></svg>');					
					htp.p('<span>'||fun.lang('Fila Integrador')||'</span>');
				htp.p('</a></li>');

			htp.p('</ul>');			

		htp.p('</ul>');

	end if;


	/********************************
	if fun.user_permissao(ws_usuario, 'TELAS_USUARIOS') = 'S' then 
		htp.p('<ul id="prefdrop" class="hidden" onmouseenter="this.focus();" onmouseleave="">');

			ws_qt_abas := 0;
			if fun.user_permissao(ws_usuario, 'TELAS_USUARIOS') = 'S' then 
				ws_qt_abas := ws_qt_abas + 1;
			end if; 	

			if ws_qt_abas > 1 then 
					if fun.user_permissao(ws_usuario, 'TELAS_USUARIOS') = 'S' then 
						htp.p('<a id="id_prefdrop-etl"   title="Parametriza&ccedil;&otilde;es do processo de ETL" style="width: 50%; border: none;" class="aba "      data-for="form-prefdrop-etl"   onclick="toggleAba(this);">ETL</a>');
					end if;	
				htp.p('</div>'); 
			end if; 

			ws_usu_closed   := 'closed';
			if ws_admin = 'A' then 
				ws_geral_closed := '';
			else 
				ws_usu_closed   := '';
			end if; 		

		htp.p('<ul id="form-prefdrop-etl" class="form-config '||ws_usu_closed||'" onmouseenter="this.focus();">');

				htp.p('<li><a title="'||fun.lang('Usu&aacute;rios')||'" data-menu="usuarios" data-refresh="" data-carrega="list_users" data-attrib="">');
					--htp.p('<svg enable-background="new -0.709 -3.459 141.732 141.732" height="141.732px" version="1.1" viewBox="-0.709 -3.459 141.732 141.732" width="141.732px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="Livello_101"><path d="M70.157,78.355c17.968,0,32.535-17.541,32.535-39.178C102.692,17.54,88.125,0,70.157,0S37.623,17.541,37.623,39.178   C37.623,60.815,52.189,78.355,70.157,78.355 M70.157,78.355c-37.146,0-67.548,24.904-70.157,56.46h140.314   C137.705,103.26,107.304,78.355,70.157,78.355"/></g><g id="Livello_1_1_"/></svg>');
					htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="45.532px" height="45.532px" viewBox="0 0 45.532 45.532" style="enable-background:new 0 0 45.532 45.532;" xml:space="preserve"> <g> <path d="M22.766,0.001C10.194,0.001,0,10.193,0,22.766s10.193,22.765,22.766,22.765c12.574,0,22.766-10.192,22.766-22.765 S35.34,0.001,22.766,0.001z M22.766,6.808c4.16,0,7.531,3.372,7.531,7.53c0,4.159-3.371,7.53-7.531,7.53 c-4.158,0-7.529-3.371-7.529-7.53C15.237,10.18,18.608,6.808,22.766,6.808z M22.761,39.579c-4.149,0-7.949-1.511-10.88-4.012 c-0.714-0.609-1.126-1.502-1.126-2.439c0-4.217,3.413-7.592,7.631-7.592h8.762c4.219,0,7.619,3.375,7.619,7.592 c0,0.938-0.41,1.829-1.125,2.438C30.712,38.068,26.911,39.579,22.761,39.579z"/> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
					htp.p('<span>'||fun.lang('Usu&aacute;rios')||'</span>');
				htp.p('</a></li>');

				htp.p('<li><a title="'||fun.lang('Grupos De Usu&aacute;rios')||'" data-menu="gusuarios" data-refresh="" data-carrega="gusuarios" data-attrib="">');
					htp.p('<svg enable-background="new 0 0 32 32" height="32px" version="1.1" viewBox="0 0 32 32" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:svg="http://www.w3.org/2000/svg"><g><rect fill="none" height="32" width="32"/></g><g id="group_x5F_full"><g><path d="M8,20c0-2,0-10,0-10s0.005-0.45,0.239-1C6.16,9,4,9,4,9s-2,0-2,2v7c0,2,2,2,2,2v10h6v-8C10,22,8,22,8,20z M8,8    c0.52,0,1.001-0.144,1.427-0.376c0.059-0.036,0.125-0.068,0.188-0.103C10.446,6.988,11,6.061,11,5c0-1.657-1.343-3-3-3    S5,3.343,5,5S6.343,8,8,8z M28,9h-4.238C23.995,9.55,24,10,24,10s0,8,0,10s-2,2-2,2v8h6V20c0,0,2,0,2-2s0-7,0-7S30,9,28,9z     M22.38,7.519c0.065,0.035,0.134,0.068,0.194,0.105C23,7.856,23.48,8,24,8c1.657,0,3-1.343,3-3s-1.343-3-3-3s-3,1.343-3,3    C21,6.059,21.552,6.985,22.38,7.519z M16,8c1.657,0,3-1.343,3-3s-1.343-3-3-3s-3,1.343-3,3S14.343,8,16,8z M22,11c0,0,0-2-2-2    c-0.5,0-8,0-8,0s-2,0-2,2v7c0,2,2,2,2,2v10h8V20c0,0,2,0,2-2S22,11,22,11z"/></g></g></svg>');
					htp.p('<span>'||fun.lang('Grupos')||'</span>');
				htp.p('</a></li>');

				htp.p('<li><a title="'||fun.lang('Filtros De Usu&aacute;rios')||'" data-menu="filtrou" data-refresh="" data-carrega="filtro_geral" data-attrib="">');
					--htp.p('<svg enable-background="new 0 0 32 32" height="32px" version="1.1" viewBox="0 0 32 32" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:svg="http://www.w3.org/2000/svg"><g><rect fill="none" height="32" width="32"/></g><g id="filter_x5F_settings"><rect height="6" width="4" x="16"/><polygon points="30,9 26,5 26,8 2,8 2,10.001 26,10.001 26,13  "/><polygon points="10,16 2,16 2,17.999 10,17.999 10,21 14,17 10,13  "/><path d="M28,24v-2.002h-1.663c-0.063-0.211-0.145-0.412-0.245-0.605l1.187-1.188l-1.416-1.414l-1.165,1.166   c-0.22-0.123-0.452-0.221-0.697-0.295V18h-2v1.662c-0.229,0.068-0.446,0.158-0.652,0.27l-1.141-1.141l-1.415,1.416l1.14,1.139   c-0.112,0.207-0.202,0.424-0.271,0.654H18v2h1.662c0.073,0.246,0.172,0.479,0.295,0.697l-1.165,1.164l1.413,1.416l1.188-1.188   c0.192,0.102,0.394,0.182,0.605,0.246V28H24v-1.666c0.229-0.068,0.445-0.158,0.651-0.27l1.212,1.213l1.414-1.416l-1.212-1.211   c0.111-0.205,0.201-0.422,0.27-0.65H28z M22.999,24.498c-0.829-0.002-1.498-0.67-1.501-1.5c0.003-0.828,0.672-1.498,1.501-1.5   c0.829,0.002,1.498,0.672,1.5,1.5C24.497,23.828,23.828,24.496,22.999,24.498z"/><path d="M23,14c-1.054,0-2.061,0.19-3,0.522V12h-4v5.347c-1.249,1.546-2,3.511-2,5.653c0,2.142,0.751,4.106,2,5.651V32h4v-0.523   C20.939,31.809,21.946,32,23,32c4.971-0.002,8.998-4.029,9-9C31.998,18.027,27.971,14,23,14z M23,29.883   c-3.801-0.01-6.876-3.084-6.885-6.883c0.009-3.801,3.084-6.876,6.885-6.885c3.799,0.008,6.874,3.084,6.883,6.885   C29.874,26.799,26.799,29.873,23,29.883z"/></g></svg>');
					htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="971.986px" height="971.986px" viewBox="0 0 971.986 971.986" style="enable-background:new 0 0 971.986 971.986;" xml:space="preserve"> <g> <path d="M370.216,459.3c10.2,11.1,15.8,25.6,15.8,40.6v442c0,26.601,32.1,40.101,51.1,21.4l123.3-141.3 c16.5-19.8,25.6-29.601,25.6-49.2V500c0-15,5.7-29.5,15.8-40.601L955.615,75.5c26.5-28.8,6.101-75.5-33.1-75.5h-873 c-39.2,0-59.7,46.6-33.1,75.5L370.216,459.3z"/> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
					htp.p('<span>'||fun.lang('Filtros')||'</span>');
				htp.p('</a></li>');

				htp.p('</ul>');			

		htp.p('</ul>');

	end if;
	**********************************/ 

	if ws_show_only <> 'S' then

	--htp.p('<div id="pushsyncbg"><img id="pushsync" src="'||fun.r_gif('sinchronize','png')||'" /></div>');

	htp.p('<div id="menup">');

		if nvl(prm_screen, 'N/A') = 'N/A' then
			htp.p('<a id="upquery" title="'||fun.lang('UpQuery')||'" onclick="closeSideBar(''popupmenu''); popupmenu(''screengroup'', '''');"><img src="'||fun.r_gif('ipad', 'PNG' )||'" /></a>');
		end if;

		htp.p('<div id="popupmenu"></div>');
		
		begin
			select CONTEUDO into ws_padrao
			from   PARAMETRO_USUARIO
			where  cd_usuario  = ws_usuario and
					cd_padrao	='CD_LINGUAGEM';
		exception
			when others then
				ws_padrao := 'PORTUGUESE';
		end;

		htp.p('<a id="screens"><select id="floatops" onchange="changeScreen();">');
			htp.p('<option value="X" style="font-weight: bold; color: #000;" selected>MENU</option>');
			open crs_itens(ws_usuario, ws_admin);
			loop
				fetch crs_itens into ws_itens;
				exit when crs_itens%notfound;
				
					if  (ws_grupo_ant <> ws_itens.cd_grupo or ws_grupo_ant='FIRST_TIME') then
						ws_cgrupo := ws_cgrupo + 1;
						ws_citem  := 1;

						if ws_admin = 'A' then
							htp.p('<optgroup label="'||ws_cgrupo||'-'||fun.utranslate('NM_GRUPO', 'GRUPOS_FUNCAO', ws_itens.nm_grupo, ws_padrao)||'"></optgroup>');
						else
							-- select para pegar a quantidade de objetos que o usuário possuí liberado para ele (ws_count_obj) e que não seja desktop o dispositivo, condição feita para não trazer a tela do menu vazia caso a mesma só possua telas para desktop
							SELECT COUNT(*)
							  INTO WS_COUNT_DISPOSITIVO
							  FROM OBJETOS, ALL_SCREENS, GRUPOS_FUNCAO
							 WHERE UPPER(TP_OBJETO) 						 = 'SCREEN'
							   AND ALL_SCREENS.PUBLICO 						 = 'S'
							   AND CD_OBJETO 								 = SCREEN(+)
							   AND OBJETOS.CD_GRUPO 						 = GRUPOS_FUNCAO.CD_GRUPO
							   AND GRUPOS_FUNCAO.CD_GRUPO 					 = WS_ITENS.CD_GRUPO
							   AND UPPER(NVL(ALL_SCREENS.DISPOSITIVO,'N/A')) <> 'DESKTOP'
							   AND ( UPPER(WS_ADMIN) 						 = 'A' 
							    		OR SCREEN 			IN ( SELECT SCREEN FROM USER_SCREENS WHERE USUARIO IN ( SELECT CD_GROUP FROM GUSERS_ITENS WHERE CD_USUARIO = WS_USUARIO) OR USUARIO = WS_USUARIO)
										OR OBJETOS.CD_GRUPO IN ( SELECT SCREEN FROM USER_SCREENS WHERE USUARIO = WS_USUARIO )
									);

							if  ws_count_dispositivo > 0   then
								htp.p('<optgroup label="'||fun.utranslate('NM_GRUPO', 'GRUPOS_FUNCAO', ws_itens.nm_grupo, ws_padrao)||'"></optgroup>');
							elsif (instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'iPhone') = 0 and instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'Android') = 0) THEN
								htp.p('<optgroup label="'||fun.utranslate('NM_GRUPO', 'GRUPOS_FUNCAO', ws_itens.nm_grupo, ws_padrao)||'"></optgroup>');
							end if;

						end if;

					end if;


				if ((instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'iPhone') > 0 or instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'Android') > 0) and nvl(ws_itens.dispositivo, '0') <> 'desktop' and nvl(ws_itens.dispositivo, '0') <> 'nenhum') or ((instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'iPhone') = 0 and instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'Android') = 0) and nvl(ws_itens.dispositivo, '0') <> 'mobile' and nvl(ws_itens.dispositivo, '0') <> 'nenhum') or ws_admin = 'A' then

					if ws_admin = 'A' then
						htp.p('<option data-bg="'||ws_itens.cor_fundo||'" data-url="'||ws_itens.url_fundo||'" data-size="'||fun.getprop(ws_itens.cd_objeto,'IMG_SIZE')||'" data-pos="'||fun.getprop(ws_itens.cd_objeto,'IMG_POS')||'" data-repeat="'||fun.getprop(ws_itens.cd_objeto,'REPEAT')||'" value="'||ws_itens.cd_objeto||'">    '||ws_cgrupo||'.'||to_char(ws_citem,'00')||'-'||fun.subpar(fun.utranslate('NM_OBJETO', ws_itens.cd_objeto, ws_itens.nm_objeto, ws_padrao), ws_itens.cd_objeto)||'</option>');
					else
						htp.p('<option data-bg="'||ws_itens.cor_fundo||'" data-url="'||ws_itens.url_fundo||'" data-size="'||fun.getprop(ws_itens.cd_objeto,'IMG_SIZE')||'" data-pos="'||fun.getprop(ws_itens.cd_objeto,'IMG_POS')||'" data-repeat="'||fun.getprop(ws_itens.cd_objeto,'REPEAT')||'" value="'||ws_itens.cd_objeto||'"> - '||fun.subpar(fun.utranslate('NM_OBJETO', ws_itens.cd_objeto, ws_itens.nm_objeto, ws_padrao), ws_itens.cd_objeto)||'</option>');
					end if;
				end if;

				ws_citem := ws_citem + 1;
				ws_count := ws_count + 1;
				ws_grupo_ant := ws_itens.cd_grupo;
				
			end loop;
			close crs_itens;

		htp.p('</select></a>');
		
        -- REMOVIDO O ALFINETE DE FAVORITAR CONFORME CAR 309a		
		htp.p('<a id="favoritos" class="" title="'||fun.lang('Objetos Favoritos')||'"><svg style="height: 26px; width: 26px; margin: 4px;" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" 	 width="613.408px" height="613.408px" viewBox="0 0 613.408 613.408" style="enable-background:new 0 0 613.408 613.408;" 	 xml:space="preserve"> <g> 	<path d="M605.254,168.94L443.792,7.457c-6.924-6.882-17.102-9.239-26.319-6.069c-9.177,3.128-15.809,11.241-17.019,20.855 		l-9.093,70.512L267.585,216.428h-142.65c-10.344,0-19.625,6.215-23.629,15.746c-3.92,9.573-1.71,20.522,5.589,27.779 		l105.424,105.403L0.699,613.408l246.635-212.869l105.423,105.402c4.881,4.881,11.45,7.467,17.999,7.467 		c3.295,0,6.632-0.709,9.78-2.002c9.573-3.922,15.726-13.244,15.726-23.504V345.168l123.839-123.714l70.429-9.176 		c9.614-1.251,17.727-7.862,20.813-17.039C614.472,186.021,612.136,175.801,605.254,168.94z M504.856,171.985 		c-5.568,0.751-10.762,3.232-14.745,7.237L352.758,316.596c-4.796,4.775-7.466,11.242-7.466,18.041v91.742L186.437,267.481h91.68 		c6.757,0,13.243-2.669,18.04-7.466L433.51,122.766c3.983-3.983,6.569-9.176,7.258-14.786l3.629-27.696l88.155,88.114 		L504.856,171.985z"/> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg></a>');		
		--htp.p('<a id="favoritos_telas" title="'||fun.lang('Telas Favoritas')||'"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M16 2v17.582l-4-3.512-4 3.512v-17.582h8zm2-2h-12v24l6-5.269 6 5.269v-24z"/></svg>');		

		-- ATIVO O FECHAR DRILLS DA BARRA DO TOPO DO MENU E ADICIONADO NO MENU CENTRAL
		htp.p('<a id="eraser" class="visible" title="'||fun.lang('Fechar drills')||'" onclick="var drills = document.querySelectorAll(''.drill''); for(i=0;i<drills.length;i++){ drills[i].remove();  }">');
		  htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"width="360px" height="360px" viewBox="0 0 360 360" style="enable-background:new 0 0 360 360;" xml:space="preserve"> <g> <g> <path d="M348.994,102.946L250.04,3.993c-5.323-5.323-13.954-5.324-19.277,0l-153.7,153.701l118.23,118.23l153.701-153.7 C354.317,116.902,354.317,108.271,348.994,102.946z"/> <path d="M52.646,182.11l-41.64,41.64c-5.324,5.322-5.324,13.953,0,19.275l98.954,98.957c5.323,5.322,13.954,5.32,19.277,0 l41.639-41.641L52.646,182.11z"/> <polygon points="150.133,360 341.767,360 341.767,331.949 182.806,331.949 		"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
		htp.p('</a>');
	
		htp.p('<a id="call-menu" class="invisible" title="'||fun.lang('Menu')||'"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 24 24" enable-background="new 0 0 24 24" width="512px" height="512px"> <g> <path d="M24,3c0-0.6-0.4-1-1-1H1C0.4,2,0,2.4,0,3v2c0,0.6,0.4,1,1,1h22c0.6,0,1-0.4,1-1V3z" fill="#FFFFFF"/> <path d="M24,11c0-0.6-0.4-1-1-1H1c-0.6,0-1,0.4-1,1v2c0,0.6,0.4,1,1,1h22c0.6,0,1-0.4,1-1V11z" fill="#FFFFFF"/> <path d="M24,19c0-0.6-0.4-1-1-1H1c-0.6,0-1,0.4-1,1v2c0,0.6,0.4,1,1,1h22c0.6,0,1-0.4,1-1V19z" fill="#FFFFFF"/> </g> </svg></a>');
		
		htp.p('<a id="float-filter" class="invisible" title="'||fun.lang('Filtros de usu&aacute;rio')||'"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"width="56.805px" height="56.805px" viewBox="0 0 56.805 56.805" style="enable-background:new 0 0 56.805 56.805;"xml:space="preserve"> <g> <g id="_x32_7"> <g> <path d="M56.582,4.352c-0.452-1.092-1.505-1.796-2.685-1.796H2.908c-1.18,0-2.233,0.704-2.685,1.796 c-0.451,1.091-0.204,2.336,0.63,3.171l20.177,20.21V53.02c0,0.681,0.55,1.229,1.229,1.229c0.68,0,1.229-0.549,1.229-1.229V27.223 c0-0.327-0.13-0.64-0.36-0.87L2.591,5.782c-0.184-0.185-0.14-0.385-0.098-0.487C2.537,5.19,2.646,5.019,2.908,5.019h50.99 c0.26,0,0.37,0.173,0.414,0.276c0.042,0.103,0.086,0.303-0.099,0.487L33.679,26.353c-0.23,0.23-0.36,0.543-0.36,0.87v18.412 c0,0.681,0.55,1.229,1.229,1.229c0.681,0,1.229-0.55,1.229-1.229V27.732l20.177-20.21C56.785,6.688,57.033,5.443,56.582,4.352z"/> </g> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg></a>');
		--LUPA DE PESQUISA PARA DISPOSITIVOS MOVEIS
		htp.p('<a id="search-mobile" class="invisible" title="'||fun.lang('Busca por palavras')||'"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Camada_1" x="0px" y="0px" viewBox="0 0 394 394" style="enable-background:new 0 0 394 394;" xml:space="preserve"><style type="text/css">.st0{fill:#FFFFFF;}</style><path  d="M381.52,338.18c-21-20.99-41.96-42.02-63.01-62.96c-5.1-5.08-11.28-8.19-18.62-8.52  c-2.3-0.1-3.93-1.29-5.47-2.85c-6.33-6.37-24.33-24.3-34.66-34.69c16.91-23.09,26.92-51.54,26.96-82.33  C286.82,68.98,224.36,6.33,146.57,6.28C68.89,6.22,6.73,68.62,6.19,146.25C5.67,221.51,68.18,287.09,146.18,286.7  c31.81,0.03,61.15-10.5,84.71-28.26c10.46,10.39,28.52,28.52,34.96,34.95c1.34,1.34,2.44,2.63,2.52,4.77  c0.25,7.02,2.91,13.18,7.84,18.13c21.48,21.56,42.91,43.19,64.71,64.43c8.5,8.29,19.12,9.86,30.27,5.81  c10.08-3.67,15.66-11.5,18.63-21.47c0-3.99,0-7.98,0-11.98C387.97,347.59,385.7,342.36,381.52,338.18z M146.23,254.49  C82.47,254.33,38.05,202.58,38.2,146.4C38.22,86.61,86.77,37.94,146.63,38.25c60.01,0.31,107.92,47.48,107.94,108.17  C254.59,206.6,207.13,254.64,146.23,254.49z"/></svg></a>');
		--BOTÃO VOLTAR DRILL TIPO SCREEN
		htp.p('<a id="back"  title="'||fun.lang('Voltar')||'" class="invisible" onclick=" if(document.getElementById(''layer'').className == ''ativo''){ try { window.stop(); var layer = document.getElementById(''layer''); layer.children[1].classList.remove(''visivel'');  layer.children[0].classList.remove(''open''); layer.children[2].classList.remove(''open''); alerta(''feed-fixo'', '''||fun.lang('Carregamento interrompido, voltando a tela anterior.')||'''); if(document.getElementById(''layer'').className == ''ativo''){ loading(); } } catch(e){ document.execCommand(''Stop'', false); document.getElementById(''layer'').setAttribute(''class'',''''); }}  this.className = ''invisible''; shscr(this.getAttribute(''data-screen'')); this.setAttribute(''data-screen'', '''');">');
			htp.p('<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" fill="#AAAAAA" height="32px" version="1.1" id="Camada_1" x="0px" y="0px" viewBox="0 0 32 32" style="enable-background:new 0 0 32 32;" xml:space="preserve"><polygon  points="16.2,5.2 12.8,5.2 3.5,16.1 12.6,26.8 16,26.8 8.5,17.8 28.5,17.5 28.5,14.6 8.5,14.8 "/></svg>');
		htp.p('</a>');
	
		htp.p('<input type="hidden" id="tmpp" value="aba0" />');
		htp.p('<input type="hidden" id="cort" value="" />');
		htp.p('<input type="hidden" id="grupof" value="" />');

		htp.p('<a id="atu_view" class="invisible">');
			htp.p('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" style="margin-top: 2px;><title>Stopwatch</title><g id="_11_-_20" data-name="11 - 20"><g id="Stopwatch"><path d="M38.1,14.312l1.455-1.454.793.793a1,1,0,0,0,1.414-1.414l-3-3a1,1,0,1,0-1.414,1.414l.792.793L36.688,12.9A18.892,18.892,0,0,0,25,8.051V7h2a2,2,0,0,0,2-2V4a2,2,0,0,0-2-2H21a2,2,0,0,0-2,2V5a2,2,0,0,0,2,2h2V8.051A18.892,18.892,0,0,0,11.312,12.9L9.858,11.444l.792-.793A1,1,0,1,0,9.236,9.237l-3,3A1,1,0,1,0,7.65,13.651l.793-.793L9.9,14.312a19,19,0,1,0,28.2,0ZM21,4h6V5H21Zm3,40A17,17,0,1,1,41,27,17.019,17.019,0,0,1,24,44Z"/><path d="M24,12A15,15,0,1,0,39,27,15.017,15.017,0,0,0,24,12ZM35,28h1.949a12.919,12.919,0,0,1-3.088,7.447l-1.376-1.376a1,1,0,1,0-1.414,1.414l1.376,1.376A12.926,12.926,0,0,1,25,39.949V38a1,1,0,0,0-2,0v1.949a12.926,12.926,0,0,1-7.447-3.088l1.376-1.376a1,1,0,1,0-1.414-1.414l-1.376,1.376A12.919,12.919,0,0,1,11.051,28H13a1,1,0,0,0,0-2H11.051a12.919,12.919,0,0,1,3.088-7.447l1.376,1.376a1,1,0,1,0,1.414-1.414l-1.376-1.376A12.926,12.926,0,0,1,23,14.051V16a1,1,0,0,0,2,0V14.051a12.926,12.926,0,0,1,7.447,3.088l-1.376,1.376a1,1,0,1,0,1.414,1.414l1.376-1.376A12.919,12.919,0,0,1,36.949,26H35a1,1,0,0,0,0,2Z"/><path d="M27.827,17.761a1,1,0,0,0-1.306.541l-2.367,5.714c-.052,0-.1-.016-.154-.016a3.03,3.03,0,1,0,2,.781l2.367-5.713A1,1,0,0,0,27.827,17.761ZM24,28a1,1,0,1,1,1-1A1,1,0,0,1,24,28Z"/></g></g></svg>');
		htp.p('</a>');

		htp.p('<div id="tela-atual">');
		htp.p('</div>');

		--tela de criação de consulta customizada
		select count(*) into ws_count from bi_custom_permissao where nm_usuario = ws_usuario;
		if ws_count > 0 then
			htp.p('<a id="atalho_customizacao" class="visible" title="'||fun.lang('Gerar consulta')||'" onclick="shscr(''SCR_CUSTOMIZACAO'');" >'); 
				htp.p('<svg style="margin: 2px 2px 2px 5px; height: 30px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M497.079 254.87c-8.128-8.117-18.339-12.904-28.925-14.374l-.002-179.133c0-9.864-7.997-17.86-17.86-17.86H17.861c-9.863 0-17.86 7.997-17.86 17.86v129.73l-.001.035v259.511c0 9.863 7.997 17.86 17.86 17.86h432.434c9.863 0 17.86-7.997 17.86-17.86V355.77l28.933-28.933c19.908-19.909 19.864-52.133-.008-71.967zM35.721 79.222H432.43v94.04H35.721v-94.04zm396.713 129.765v39.814c-5.179 3.537-2.881 1.641-55.467 54.228h-125.03v-94.041h180.497zM216.217 432.778H35.72v-94.029h180.497v94.029zm0-129.751H35.72v-94.04h180.497v94.04zm75.029 90.728l-5.689 39.023h-33.621v-94.029h89.31l-44.955 44.955a17.847 17.847 0 00-5.045 10.051zm141.188 39.023h-41.289l41.289-41.289v41.289zm-85.241-6.563l-25.115 3.664 3.66-25.108 86.732-86.732 21.449 21.449-86.726 86.727zm124.636-124.637l-12.653 12.653-21.449-21.449 12.647-12.647c5.894-5.894 15.544-5.904 21.467.012 5.876 5.866 5.94 15.479-.012 21.431z"/></svg>'); 
			htp.p('</a>');
		end if;

		htp.p('<a title="Entrada de Parametros" onclick="carregaPainel(''''); titulo(this, ''n''); curtain(''enabled''); savepar(); carrega('||chr(39)||'get_par'||chr(39)||'); ">');
		

		if nvl(prm_screen, 'N/A') = 'N/A' then 
			if nvl(fun.ret_var('ATIVAR_CHAT'),'N') = 'S' then 
				htp.p('<a id="verify-post" data-ajax="'||fun.init_text_post||'" title="'||fun.lang('verificar mensagens')||'" onclick="closeSideBar(''text-talk''); openText();">');
					htp.p('<svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512.001 512.001" style="enable-background:new 0 0 512.001 512.001; heigth:32px;" xml:space="preserve"> <g> <g> <g> <path d="M468.53,306.575c-4.14-10.239-15.798-15.188-26.038-11.046c-10.241,4.14-15.187,15.797-11.047,26.038L455,379.833 l-69.958-30.839c-5.064-2.232-10.827-2.267-15.917-0.095c-23.908,10.201-49.52,15.373-76.124,15.373 c-107.073,0-179-83.835-179-162.136c0-89.402,80.299-162.136,179-162.136s179,72.734,179,162.136 c0,6.975-0.65,15.327-1.781,22.913c-1.63,10.925,5.905,21.102,16.83,22.732c10.926,1.634,21.103-5.905,22.732-16.83 c1.431-9.59,2.219-19.824,2.219-28.815c0-54.33-23.006-105.308-64.783-143.543C405.936,20.809,351.167,0,293.001,0 S180.067,20.809,138.784,58.592c-37.332,34.168-59.66,78.516-63.991,126.335C27.836,216.023,0.001,265.852,0.001,319.525 c0,33.528,10.563,65.34,30.67,92.717L1.459,484.504c-3.051,7.546-1.224,16.189,4.621,21.855 c3.809,3.694,8.828,5.642,13.925,5.642c2.723-0.001,5.469-0.556,8.063-1.7l84.229-37.13c21.188,7.887,43.585,11.88,66.703,11.88 c0.5,0,0.991-0.039,1.482-0.075c33.437-0.253,65.944-9.048,94.098-25.507c25.218-14.744,45.962-34.998,60.505-58.917 c14.199-2.55,28.077-6.402,41.547-11.551l107.301,47.3c2.595,1.143,5.34,1.7,8.063,1.7c5.097-0.001,10.117-1.949,13.926-5.642 c5.845-5.666,7.672-14.308,4.621-21.855L468.53,306.575z M179.002,445c-0.273,0-0.539,0.03-0.81,0.041 c-20.422-0.104-40.078-4.118-58.435-11.95c-5.089-2.173-10.852-2.138-15.916,0.095l-46.837,20.646l15.109-37.375 c2.793-6.909,1.512-14.799-3.322-20.47c-18.835-22.097-28.79-48.536-28.79-76.462c0-31.961,13.445-62.244,36.969-85.206 c7.324,39.925,27.989,78.117,59.162,108.119c38.791,37.333,90.101,58.961,145.506,61.565 C255.626,429.608,218.402,445,179.002,445z"/> <circle cx="292.001" cy="203" r="20"/> <circle cx="372.001" cy="203" r="20"/> <circle cx="212.001" cy="203" r="20"/> </g> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
				htp.p('</a>'); 
			end if; 	
		end if;
		
		htp.p('<a class="info" onclick="closeSideBar(''perfil''); document.getElementById(''perfil'').classList.toggle(''open'');" title="'||ws_usuario||'">'||ws_usuario||'</a>');

		if ws_admin = 'N' then
		
			select count(*) into ws_ctn_usu from var_conteudo where usuario = ws_usuario;
			if ws_ctn_usu > 0 then
				htp.p('<a id="config" title="'||fun.lang('Configura&ccedil;&atilde;o')||'">');
					htp.p('<svg style="height: 20px; width: 20px; margin: 8px;" enable-background="new 0 0 24 24" height="24px" version="1.1" viewBox="0 0 24 24" width="24px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path clip-rule="evenodd" d="M21.521,10.146c-0.41-0.059-0.846-0.428-0.973-0.82l-0.609-1.481  c-0.191-0.365-0.146-0.935,0.1-1.264l0.99-1.318c0.246-0.33,0.227-0.854-0.047-1.162l-1.084-1.086  c-0.309-0.272-0.832-0.293-1.164-0.045l-1.316,0.988c-0.33,0.248-0.898,0.293-1.264,0.101l-1.48-0.609  c-0.395-0.126-0.764-0.562-0.82-0.971l-0.234-1.629c-0.057-0.409-0.441-0.778-0.85-0.822c0,0-0.255-0.026-0.77-0.026  c-0.514,0-0.769,0.026-0.769,0.026c-0.41,0.044-0.794,0.413-0.852,0.822l-0.233,1.629c-0.058,0.409-0.427,0.845-0.82,0.971  l-1.48,0.609C7.48,4.25,6.912,4.206,6.582,3.958L5.264,2.969c-0.33-0.248-0.854-0.228-1.163,0.045L3.017,4.1  C2.745,4.409,2.723,4.932,2.971,5.262l0.988,1.318C4.208,6.91,4.252,7.479,4.061,7.844L3.45,9.326  c-0.125,0.393-0.562,0.762-0.971,0.82L0.85,10.377c-0.408,0.059-0.777,0.442-0.82,0.853c0,0-0.027,0.255-0.027,0.77  s0.027,0.77,0.027,0.77c0.043,0.411,0.412,0.793,0.82,0.852l1.629,0.232c0.408,0.059,0.846,0.428,0.971,0.82l0.611,1.48  c0.191,0.365,0.146,0.936-0.102,1.264l-0.988,1.318c-0.248,0.33-0.308,0.779-0.132,0.994c0.175,0.217,0.677,0.752,0.678,0.754  s0.171,0.156,0.375,0.344s1.042,0.449,1.372,0.203l1.317-0.99c0.33-0.246,0.898-0.293,1.264-0.1l1.48,0.609  c0.394,0.125,0.763,0.562,0.82,0.971l0.233,1.629c0.058,0.408,0.441,0.779,0.852,0.822c0,0,0.255,0.027,0.769,0.027  c0.515,0,0.77-0.027,0.77-0.027c0.409-0.043,0.793-0.414,0.85-0.822l0.234-1.629c0.057-0.408,0.426-0.846,0.82-0.971l1.48-0.611  c0.365-0.191,0.934-0.146,1.264,0.102l1.318,0.99c0.332,0.246,0.854,0.227,1.164-0.047l1.082-1.084  c0.273-0.311,0.293-0.834,0.047-1.164l-0.99-1.318c-0.246-0.328-0.291-0.898-0.1-1.264l0.609-1.48  c0.127-0.393,0.562-0.762,0.973-0.82l1.627-0.232c0.41-0.059,0.779-0.441,0.822-0.852c0,0,0.027-0.255,0.027-0.77  s-0.027-0.77-0.027-0.77c-0.043-0.41-0.412-0.794-0.822-0.853L21.521,10.146z M12,15C10.343,15,9,13.656,9,12  C9,10.343,10.343,9,12,9c1.657,0,3,1.344,3,3C15,13.656,13.656,15,12,15z" fill-rule="evenodd"/></svg>');
				htp.p('</a>');
			end if;

		end if;

		htp.p('<a id="go-doc" title="'||fun.lang('Conhecimento')||'" href="http://cloud.upquery.com/conhecimento/dwu.doc.main" target="_blank" rel="noopener noreferrer" >');
			htp.p('<svg style="height: 24px; width: 24px; margin: 5px;margin-right: 7px;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Camada_1" x="0px" y="0px" viewBox="0 0 1280 1280" style="enable-background:new 0 0 1280 1280;" xml:space="preserve"><g><g><path  d="M587.55,715.61c3-64.72,8-101.72,69-134.72c111.81-60.49,119.01-115.53,104-195c-17-90-78-96-101-94    c-43.77,3.81-114,14-107,132.58v95.4h-99.22v-86.61c0-140.58,67.78-220.92,202.09-220.92c134.31,0,204.6,80.33,204.6,220.92    c0,76.57-8.47,140.63-103.47,196.63c-39.75,23.43-64,15-67,90.74v47.26l-102,0.44V715.61z"/></g><g><path  d="M589.55,836.89h100v223h-100V836.89z"/></g><path  d="M640,1256c-83.14,0-163.81-16.29-239.79-48.43c-73.36-31.03-139.23-75.44-195.79-131.99   c-56.56-56.56-100.97-122.43-131.99-195.79C40.29,803.82,24,723.14,24,640s16.29-163.81,48.43-239.79   c31.03-73.36,75.44-139.23,131.99-195.79S326.85,103.46,400.21,72.43C476.19,40.29,556.86,24,640,24s163.81,16.29,239.79,48.43   c73.36,31.03,139.23,75.44,195.79,131.99c56.56,56.55,100.97,122.43,131.99,195.79C1239.71,476.19,1256,556.86,1256,640   s-16.29,163.82-48.43,239.79c-31.03,73.36-75.44,139.23-131.99,195.79c-56.56,56.56-122.43,100.97-195.79,131.99   C803.81,1239.71,723.14,1256,640,1256z M640,123.47c-69.75,0-137.39,13.65-201.04,40.57c-61.5,26.01-116.75,63.26-164.2,110.72   c-47.45,47.45-84.7,102.7-110.72,164.2c-26.92,63.65-40.57,131.29-40.57,201.04s13.65,137.39,40.57,201.04   c26.01,61.5,63.26,116.75,110.72,164.2c47.45,47.45,102.7,84.7,164.2,110.72c63.65,26.92,131.29,40.57,201.04,40.57   s137.39-13.65,201.04-40.57c61.5-26.01,116.75-63.26,164.2-110.72c47.45-47.45,84.7-102.7,110.72-164.2   c26.92-63.65,40.57-131.29,40.57-201.04s-13.65-137.39-40.57-201.04c-26.01-61.5-63.26-116.75-110.72-164.2   c-47.45-47.45-102.7-84.7-164.2-110.72C777.39,137.12,709.75,123.47,640,123.47z"/></g></svg>');
		htp.p('</a>');
		
		-- Icone Avisos/Notice (NÃO ABRE em dispositivos móveis)
		if instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'iPhone') = 0 and instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'Android') = 0 then
			notice_get_count (ws_qt_aviso_sistema, ws_qt_aviso_nao_lido); 
			if ws_qt_aviso_sistema > 0 then 
				htp.p('<a title="'||fun.lang('Avisos')||'" onclick="notice_popup_open(0,''MENU'');" >');  
					
					--Removido o teste da vaiavel ws_qt_aviso_nao_lido e setado ws_visibility direto como hidden. Deixado para o js decidir o momento para por o circulo.
					
					ws_visibility := 'style="visibility: hidden;"'; 
					
					/*if ws_qt_aviso_nao_lido = 0 then 
						ws_visibility := 'style="visibility: hidden"';
					end if;*/ 	
					htp.p('<span id="notice-menup-circle"'||ws_visibility||'></span>');  			
					htp.p('<span id="notice-menup-count"' ||ws_visibility||'>'||ws_qt_aviso_nao_lido||'</span>');  			
					htp.p('<svg style="height: 24px; width: 24px; margin: 5px;margin-right: 7px;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Camada_1" x="0px" y="0px" viewBox="0 0 1280 1280" style="enable-background:new 0 0 1280 1280;" xml:space="preserve"><path class="st1" d="M1123.84,1046.53c-32.39-65.58-64.67-131.22-97.83-196.4c-33.5-65.83-39.67-135.18-38.94-209.15  c0.84-85.46,3-170.1,2.82-255.57c-0.25-117.03-49.54-220.45-131.2-288.26C769.53,16.96,669.91,13.2,641.64,11.91v-0.16  c-0.5,0.03-1.06,0.06-1.64,0.08c-0.58-0.03-1.13-0.06-1.64-0.08v0.16c-28.28,1.3-127.89,5.05-217.06,85.25  c-81.66,67.81-130.95,171.23-131.2,288.26c-0.18,85.47,1.98,170.11,2.82,255.57c0.73,73.97-5.44,143.32-38.94,209.15  c-33.16,65.18-65.44,130.82-97.83,196.4c-19.55,39.58-7.67,70.57,36.6,70.66c82.4,0.17,164.8,0.27,247.19-0.18  c13-0.07,19.58,2.25,23.95,16.79c23.66,78.73,95.11,128.01,174.46,134.22v0.24c0.55-0.03,1.09-0.08,1.64-0.12  c0.55,0.04,1.09,0.08,1.64,0.12v-0.24c79.35-6.22,150.8-55.49,174.46-134.22c4.37-14.54,10.95-16.86,23.95-16.79  c82.39,0.45,164.79,0.35,247.19,0.18C1131.51,1117.1,1143.39,1086.11,1123.84,1046.53z M640,1189.43  c-41.84-6.09-65.29-35.47-76.01-75.77c29.71,0,47.26,0,74.37,0c1.08,0,2.16,0,3.27,0c27.12,0,44.66,0,74.37,0  C705.29,1153.96,681.84,1183.34,640,1189.43z M975.77,1023.53c-121.9-0.58-215.14-0.04-335.77,0c-120.63-0.03-213.88-0.57-335.77,0  c-19.32,0.09-16.46-4.57-7.06-24c34.14-70.62,61.35-114.95,84.71-190.59c13.34-43.19,9.9-96.53,9.88-141.93  c-0.05-94.66,2.92-189.34,4.24-283.98c1.36-97.45,26.82-161.38,104.47-230.56C530.29,130.66,577.3,97.62,640,96.1  c62.7,1.52,109.71,34.56,139.54,56.37c77.65,69.18,103.11,133.11,104.47,230.56c1.32,94.64,4.29,189.32,4.24,283.98  c-0.02,45.4-3.46,98.74,9.88,141.93c23.36,75.64,50.57,119.97,84.71,190.59C992.23,1018.96,995.09,1023.62,975.77,1023.53z"/></svg>');
			
			end if; 			
		end if; 
	--Habilita o menu de configurações de 3 pontos.  
		if ws_admin = 'A' or fun.user_permissao(ws_usuario, 'TELAS_ETL') = 'S' or fun.user_permissao(ws_usuario, 'TELAS_USUARIOS') = 'S' then
		
			htp.p('<a title="'||fun.lang('Configura&ccedil;&otilde;es')||'" onclick="closeSideBar(''prefdrop''); document.getElementById(''prefdrop'').classList.toggle(''hover'');">');
				htp.p('<svg style="height: 25px; width: 25px; margin: 5px;" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve"> <g> <g> <g> <circle cx="256" cy="256" r="64"/> <circle cx="256" cy="448" r="64"/> <circle cx="256" cy="64" r="64"/> </g> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
			htp.p('</a>');
		end if;

		htp.p('<a class="logout" title="Logoff" onclick="var loc = window.location.toString(); loc = loc.replace(loc.split(''.com'').pop(), ''''); if(confirm(TR_SS)){ call(''xlogout'', '''').then(function(){ alerta(''feed-fixo'', TR_SE); setTimeout(function(){ window.location.reload(true); }, 1000); }); }">');
			htp.p('<svg style="height: 25px; width: 25px; margin: 5px;" enable-background="new 0 0 141.732 141.732" height="141.732px" version="1.1" viewBox="0 0 141.732 141.732" width="141.732px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="Livello_34"><path d="M108.527,66.186l-42.209-42.21c-2.498-2.494-6.547-2.494-9.046,0c-2.495,2.498-2.495,6.547,0,9.045L88.996,64.74H6.365   c-3.532,0-6.398,2.869-6.398,6.398c0,3.53,2.867,6.396,6.398,6.396h82.629L57.7,108.829c-2.495,2.493-2.495,6.548,0,9.041   c2.499,2.498,6.55,2.498,9.046,0l42.208-42.21c0.149-0.147,0.291-0.305,0.425-0.468c0.064-0.071,0.11-0.147,0.169-0.229   c0.067-0.091,0.145-0.181,0.203-0.277c0.06-0.093,0.111-0.185,0.169-0.275c0.051-0.087,0.104-0.169,0.151-0.26   c0.05-0.095,0.094-0.192,0.139-0.289c0.045-0.093,0.091-0.184,0.13-0.277c0.039-0.095,0.068-0.191,0.104-0.283   c0.038-0.106,0.076-0.201,0.107-0.304c0.025-0.102,0.049-0.194,0.073-0.291c0.025-0.106,0.058-0.21,0.075-0.318   c0.021-0.108,0.035-0.225,0.054-0.339c0.015-0.094,0.03-0.186,0.041-0.276c0.041-0.42,0.041-0.842,0-1.261   c-0.011-0.096-0.026-0.188-0.041-0.278c-0.019-0.113-0.029-0.229-0.054-0.337c-0.021-0.108-0.05-0.212-0.075-0.319   c-0.024-0.097-0.048-0.191-0.073-0.291c-0.031-0.102-0.069-0.199-0.107-0.304c-0.029-0.095-0.062-0.191-0.104-0.286   c-0.04-0.095-0.085-0.186-0.13-0.277c-0.045-0.098-0.089-0.196-0.139-0.291c-0.051-0.089-0.105-0.172-0.151-0.258   c-0.058-0.094-0.109-0.187-0.169-0.278c-0.062-0.095-0.136-0.184-0.203-0.275c-0.059-0.077-0.104-0.154-0.169-0.228   c-0.197-0.243-0.423-0.466-0.657-0.678C108.659,66.333,108.595,66.257,108.527,66.186 M141.732,141.846V-0.001H65.353v10.912   h65.469v120.024H65.353v10.907h76.379V141.846z"/></g><g /></svg>');
		htp.p('</a>');
		

	htp.p('</div>');

	else
		htp.p('<div id="show_only_screen" onclick="return false;">');
			
			htp.p('<div id="show_only_bar"></div>');

			
			htp.p('<div id="show_comandos">');
				
				htp.p('<span class="backward">');
					htp.p('<?xml version="1.0" encoding="iso-8859-1"?><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"viewBox="0 0 57 57" style="enable-background:new 0 0 57 57;" xml:space="preserve"> <path d="M56.461,8.625c-0.333-0.172-0.73-0.145-1.036,0.069L29,27.277V9.5c0-0.373-0.208-0.716-0.539-0.888 c-0.333-0.172-0.731-0.146-1.036,0.07l-27,19C0.158,27.869,0,28.175,0,28.5s0.158,0.631,0.425,0.817l27,19 C27.597,48.439,27.798,48.5,28,48.5c0.157,0,0.315-0.037,0.461-0.112C28.792,48.216,29,47.873,29,47.5V29.723l26.425,18.583 c0.172,0.12,0.373,0.182,0.575,0.182c0.157,0,0.315-0.037,0.461-0.112C56.792,48.203,57,47.86,57,47.487V9.513 C57,9.14,56.792,8.797,56.461,8.625z"/> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
				htp.p('</span>');
				
				htp.p('<span class="pause">');
					htp.p('<?xml version="1.0" encoding="iso-8859-1"?><svg style="height: 38px; margin-top: 2px;" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"viewBox="0 0 232.679 232.679" style="enable-background:new 0 0 232.679 232.679;" xml:space="preserve"> <g id="Pause"> <path style="fill-rule:evenodd;clip-rule:evenodd;" d="M80.543,0H35.797c-9.885,0-17.898,8.014-17.898,17.898v196.883 c0,9.885,8.013,17.898,17.898,17.898h44.746c9.885,0,17.898-8.013,17.898-17.898V17.898C98.44,8.014,90.427,0,80.543,0z M196.882,0 h-44.746c-9.886,0-17.899,8.014-17.899,17.898v196.883c0,9.885,8.013,17.898,17.899,17.898h44.746 c9.885,0,17.898-8.013,17.898-17.898V17.898C214.781,8.014,206.767,0,196.882,0z"/> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
				htp.p('</span>');
				
				htp.p('<span class="forward">');
					htp.p('<?xml version="1.0" encoding="iso-8859-1"?><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"viewBox="0 0 57 57" style="enable-background:new 0 0 57 57;" xml:space="preserve"> <path d="M56.575,27.683l-27-19c-0.306-0.216-0.703-0.242-1.036-0.07C28.208,8.784,28,9.127,28,9.5v17.777L1.575,8.694 C1.27,8.481,0.872,8.453,0.539,8.625C0.208,8.797,0,9.14,0,9.513v37.975c0,0.373,0.208,0.716,0.539,0.888 C0.685,48.45,0.843,48.487,1,48.487c0.202,0,0.403-0.062,0.575-0.182L28,29.723V47.5c0,0.373,0.208,0.716,0.539,0.888 C28.685,48.463,28.843,48.5,29,48.5c0.202,0,0.404-0.062,0.575-0.183l27-19C56.842,29.131,57,28.825,57,28.5 S56.842,27.869,56.575,27.683z"/> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
				htp.p('</span>');

				htp.p('<span class="logout" title="Logoff" onclick="var loc = window.location.toString(); loc = loc.replace(loc.split(''.com'').pop(), ''''); if(confirm(TR_SS)){ call(''xlogout'', '''').then(function(){ alerta(''feed-fixo'', TR_SE); setTimeout(function(){ window.location.reload(true); }, 1000); }); }">');
					htp.p('<svg style="height: 25px; width: 25px; margin: 8px;" enable-background="new 0 0 141.732 141.732" height="141.732px" version="1.1" viewBox="0 0 141.732 141.732" width="141.732px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="Livello_34"><path d="M108.527,66.186l-42.209-42.21c-2.498-2.494-6.547-2.494-9.046,0c-2.495,2.498-2.495,6.547,0,9.045L88.996,64.74H6.365   c-3.532,0-6.398,2.869-6.398,6.398c0,3.53,2.867,6.396,6.398,6.396h82.629L57.7,108.829c-2.495,2.493-2.495,6.548,0,9.041   c2.499,2.498,6.55,2.498,9.046,0l42.208-42.21c0.149-0.147,0.291-0.305,0.425-0.468c0.064-0.071,0.11-0.147,0.169-0.229   c0.067-0.091,0.145-0.181,0.203-0.277c0.06-0.093,0.111-0.185,0.169-0.275c0.051-0.087,0.104-0.169,0.151-0.26   c0.05-0.095,0.094-0.192,0.139-0.289c0.045-0.093,0.091-0.184,0.13-0.277c0.039-0.095,0.068-0.191,0.104-0.283   c0.038-0.106,0.076-0.201,0.107-0.304c0.025-0.102,0.049-0.194,0.073-0.291c0.025-0.106,0.058-0.21,0.075-0.318   c0.021-0.108,0.035-0.225,0.054-0.339c0.015-0.094,0.03-0.186,0.041-0.276c0.041-0.42,0.041-0.842,0-1.261   c-0.011-0.096-0.026-0.188-0.041-0.278c-0.019-0.113-0.029-0.229-0.054-0.337c-0.021-0.108-0.05-0.212-0.075-0.319   c-0.024-0.097-0.048-0.191-0.073-0.291c-0.031-0.102-0.069-0.199-0.107-0.304c-0.029-0.095-0.062-0.191-0.104-0.286   c-0.04-0.095-0.085-0.186-0.13-0.277c-0.045-0.098-0.089-0.196-0.139-0.291c-0.051-0.089-0.105-0.172-0.151-0.258   c-0.058-0.094-0.109-0.187-0.169-0.278c-0.062-0.095-0.136-0.184-0.203-0.275c-0.059-0.077-0.104-0.154-0.169-0.228   c-0.197-0.243-0.423-0.466-0.657-0.678C108.659,66.333,108.595,66.257,108.527,66.186 M141.732,141.846V-0.001H65.353v10.912   h65.469v120.024H65.353v10.907h76.379V141.846z"/></g><g /></svg>');
				htp.p('</span>');
				
			htp.p('</div>');
			
		htp.p('</div>');

		htp.p('<div style="display: none !important;" class="info">'||ws_usuario||'</div>');
		htp.p('<input type="hidden" id="floatops"/>');
		htp.p('<input type="hidden" id="space"/>');
		htp.p('<style>a#float-icon, a#float-icon-filter, span.closed, a.turn { display: none !important; } body { background: transparent !important; } html {  } </style>');

	end if;


	htp.p('<div id="telasup" data-visao="" data-objeto="">');
	
		htp.p('<ul id="abas">');
			
		htp.p('</ul>');

		htp.p('<h1 id="titulo"></h1>');
		htp.p('<h4 id="info" style="font-size: 10px;"></h4>');
		htp.p('<div id="scroll">');
			htp.p('<div id="painel"></div>');
			htp.p('<div id="content"></div>');

			htp.p('<a id="back_sup" style="display:none;" title="'||fun.lang('RETORNA PARA TELA ANTERIOR')||'">');
				htp.p('<svg clip-rule="evenodd" fill-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m9.474 5.209s-4.501 4.505-6.254 6.259c-.147.146-.22.338-.22.53s.073.384.22.53c1.752 1.754 6.252 6.257 6.252 6.257.145.145.336.217.527.217.191-.001.383-.074.53-.221.293-.293.294-.766.004-1.057l-4.976-4.976h14.692c.414 0 .75-.336.75-.75s-.336-.75-.75-.75h-14.692l4.978-4.979c.289-.289.287-.761-.006-1.054-.147-.147-.339-.221-.53-.221-.191-.001-.38.071-.525.215z" fill-rule="nonzero"/></svg>');
			htp.p('</a>');

			htp.p('<a id="refresh_sup" style="display:none;" title="'||fun.lang('ATIVA/INATIVA REFRESH DA TELA')||'">');
				htp.p('<svg clip-rule="evenodd" fill-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m3.508 6.726c1.765-2.836 4.911-4.726 8.495-4.726 5.518 0 9.997 4.48 9.997 9.997 0 5.519-4.479 9.999-9.997 9.999-5.245 0-9.553-4.048-9.966-9.188-.024-.302.189-.811.749-.811.391 0 .715.3.747.69.351 4.369 4.012 7.809 8.47 7.809 4.69 0 8.497-3.808 8.497-8.499 0-4.689-3.807-8.497-8.497-8.497-3.037 0-5.704 1.597-7.206 3.995l1.991.005c.414 0 .75.336.75.75s-.336.75-.75.75h-4.033c-.414 0-.75-.336-.75-.75v-4.049c0-.414.336-.75.75-.75s.75.335.75.75z" fill-rule="nonzero"/></svg>');
			htp.p('</a>');

			htp.p('<a id="fechar_sup" data-reloads="false" data-reloado="false" title="'||fun.lang('FECHAR TELA')||'">');
				htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="612px" height="612px" viewBox="0 0 612 612" style="enable-background:new 0 0 612 612;width: 18px;height: 18px;" xml:space="preserve"> <g> 	<g id="cross"> 		<g> 			<polygon points="612,36.004 576.521,0.603 306,270.608 35.478,0.603 0,36.004 270.522,306.011 0,575.997 35.478,611.397 				306,341.411 576.521,611.397 612,575.997 341.459,306.011 			"></polygon> 		</g> 	</g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
			htp.p('</a>');
			htp.p('<a id="salvar" title="'||fun.lang('Salvar')||'" onclick=" document.getElementById(''fakelist'').setAttribute(''class'', ''''); var iframe = document.getElementById(''content'').getElementsByTagName(''form''); var enviar = iframe[0]; var user = document.getElementById(''form-ajax''); if(user){ var nome = user.childNodes[1].childNodes[1].value; var completo = user.childNodes[3].childNodes[1].value; var status = user.childNodes[5].childNodes[1].value; var email = user.childNodes[7].childNodes[1].value; if(user.childNodes[9]){ var senha = user.childNodes[9].childNodes[1].value; } else { var senha = ''''; } ajax(''main'', ''save_user'', ''usu_nome_n=''+nome+''&usu_completo_n=''+completo+''&status_n=''+status+''&usu_email_n=''+email+''&usu_senha=''+senha+''&prm_permissao=none'', ''true'', ''ajax''); carrega(''list_users''); } else { if(enviar){ enviar.submit(); alerta(''msg'','''');  } else { alerta(''msg'','''||fun.lang('op&ccedil;&atilde;o salvar indispon&iacute;vel')||'!''); } } if(document.getElementById(''list_coluna'')){ alerta(''msg'', '''||fun.lang('Altera&ccedil;&atilde;o salva com sucesso')||'!''); } else { call_save(''''); } ">');
				htp.p('<img alt="'||fun.lang('salvar')||'" src="'||fun.r_gif('disquete','gif')||'" />');
			htp.p('</a>');
		htp.p('</div>');    -- fecha div scroll
		htp.p('<span id="progress-bar"></span>');
		htp.p('<small id="msg"></small>');
	htp.p('</div>');  -- fecha div telasup 

	htp.p('<div id="fakelist" data-campo="" onclick="if((event.offsetX < 300 && event.offsetX > 275) || (window.innerWidth < 500 && window.matchMedia(''(orientation: portrait)'').matches && event.offsetX < 221 && event.offsetX > 193)){ this.className=''''; /*document.querySelector(''.itens'').innerHTML = '''';*/  }" onmouseleave="" onblur="">');
		fcl.closer_menu;
	htp.p('</div>');
	htp.p('<div id="attriblist" class="vertical" onclick="attribList('''||ws_itens.cd_objeto||''');">');
	htp.p('</div>');
	htp.p('<div id="floatlist" class="horizontal"></div>');

exception when others then 
	insert into bi_log_sistema values(sysdate, 'FLOAT_MENU - '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, ws_usuario, 'ERRO');

end float_menu;


procedure closer_menu as

begin
	
	htp.p('<span class="closer">');
		htp.p('<svg width="8" height="13" viewBox="0 0 8 13" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6.0031 12.223L0.267578 6.49724L6.0031 0.771484L7.34139 2.10749L2.94416 6.49724L7.34139 10.887L6.0031 12.223Z" fill="#191147"/></svg>');
	htp.p('</span>');
	
end closer_menu;

procedure atu_view (prm_screen 	varchar2 default null,
						
					prm_objeto	varchar2 default null) as

	cursor crs_atu_view is
		SELECT DISTINCT
			mi1.nm_micro_visao          AS nm_micro_visao,
			mi1.ds_micro_visao          AS ds_micro_visao,
			mi1.dt_ultima_atualizacao   AS dt_ultima_atualizacao
		FROM
			micro_visao       mi1,
			ponto_avaliacao   po1,
			object_location   ol3,
			object_location   ol2,
			object_location   ol1
		WHERE
			mi1.nm_micro_visao = po1.cd_micro_visao
			AND po1.cd_ponto = ol3.object_id
			AND ol3.screen = ol2.object_id
			AND ol2.screen = ol1.object_id
			AND ol2.object_id LIKE 'ARTICLE%'
			AND ol1.screen = prm_screen
			AND ol1.object_id LIKE 'SECTION%'
			AND prm_screen IS NOT NULL
			AND exists (select 1 from all_tables t2      -- somente tabelas (desconsidera visões baseadas em views)
						where t2.owner      = nvl(fun.ret_var('OWNER_TABLE_DATA'),'DWU') 
						and t2.table_name = nm_tabela
						) 	   
		UNION ALL
		SELECT DISTINCT
			mi1.nm_micro_visao          AS nm_micro_visao,
			mi1.ds_micro_visao          AS ds_micro_visao,
			mi1.dt_ultima_atualizacao   AS dt_ultima_atualizacao
		FROM
			micro_visao       mi1,
			ponto_avaliacao   po1
		WHERE
			mi1.nm_micro_visao = po1.cd_micro_visao
			AND po1.cd_ponto = prm_objeto
			AND prm_screen IS NULL
			AND exists (select 1 from all_tables t2      -- somente tabelas (desconsidera visões baseadas em views)
						where t2.owner      = nvl(fun.ret_var('OWNER_TABLE_DATA'),'DWU') 
						and t2.table_name = nm_tabela
						) ;
	
	ws_view 	crs_atu_view%ROWTYPE;




begin
	htp.p('<div id="box_atu">');

		htp.p('<h2 id="tit_atu">&Uacute;ltimas Atualiza&ccedil;&otilde;es</h2>');

		
		htp.p('<ul class="form">');
				htp.p('<li style="font-weight: bolder;">');
					--htp.p('<span class="before">Nome</span>');
					--htp.p('<span class="before newModel">Descri&ccedil;&atilde;o</span>');
					htp.p('<span class="before newModel">Nome</span>');
					htp.p('<span class="before newModel">Data</span>');
				htp.p('</li>');

					for ws_view in crs_atu_view 
					loop
						htp.p('<li>');
							--htp.p('<span class="before">'||ws_view.nm_micro_visao||'</span>');
							htp.p('<span class="before newModel" title="'||ws_view.nm_micro_visao||'">'||ws_view.ds_micro_visao||'</span>');
							htp.p('<span class="before newModel">'||to_char(ws_view.dt_ultima_atualizacao, 'DD/MM/YYYY HH24:MI')||'</span>');
						htp.p('</li>');
					end loop;
				
		htp.p('</ul>');
	htp.p('</div>');

	fcl.closer_menu;
		
exception
when others then
	htp.p('!OK');

end atu_view;


procedure call_list( prm_call varchar2 default null,
					prm_posicao varchar2 default null,
					prm_screen varchar2 default null ) as

	cursor crs_itens is
		select	CLL.cd_objeto,
			OBJ.nm_objeto    as nm_objeto,
			OBJ.tp_objeto    as tp_objeto,
			OBJ.atributos    as attrib,
			callname.nm_item as nm_item
		from	CALL_LIST CLL
		LEFT JOIN
		OBJETOS OBJ on OBJ.cd_objeto = CLL.cd_Objeto
		LEFT JOIN
		call_name callname on callname.cd_objeto = CLL.cd_Objeto and callname.screen = trim(prm_screen)
		where	CLL.cd_list = prm_call and (
			( 
				CLL.cd_objeto not in ( select cd_objeto from OBJECT_RESTRICTION where USUARIO = user and st_restricao = 'I' ) and
				CLL.cd_objeto not in ( select cd_objeto from OBJECT_RESTRICTION where USUARIO = 'DWU' and st_restricao = 'X' )
			)
			or
			( 
				CLL.cd_objeto not in ( select cd_objeto from OBJECT_RESTRICTION where USUARIO = user and st_restricao = 'I' ) and
				CLL.cd_objeto in ( select cd_objeto from OBJECT_RESTRICTION where USUARIO = 'DWU' and st_restricao = 'X' ) AND
				CLL.cd_objeto in ( select cd_objeto from OBJECT_RESTRICTION where USUARIO = user and st_restricao = 'L' )
			)

		) and CLL.cd_objeto not in ( select cd_objeto from OBJETOS OBJ where OBJ.tp_objeto='SCRIPT' ) and
		CLL.cd_objeto in (select cd_objeto from OBJETOS) and
		( OBJ.cd_usuario = user or OBJ.cd_usuario = 'DWU' or user = 'DWU' or obj.cd_usuario = gbl.getusuario)
		order by CLL.ordem, OBJ.nm_objeto;

	ws_itens	crs_itens%rowtype;

	cursor crs_scripts is
		select	cd_objeto,
			(select nm_objeto from OBJETOS OBJ where OBJ.cd_objeto = replace(CLLS.cd_Objeto, '[SCRIPT]', '')) as nm_objeto,
			(select nm_item from call_name name where name.cd_objeto = replace(CLLS.cd_Objeto, '[SCRIPT]', '') and name.screen=trim(prm_screen)) as nm_item
		from	CALL_LIST CLLS
		where	cd_list=prm_call and
				(
		( cd_objeto not in ( select cd_objeto from OBJECT_RESTRICTION where USUARIO = user and st_restricao = 'I' ) and
		cd_objeto not in ( select cd_objeto from OBJECT_RESTRICTION where USUARIO = 'DWU' and st_restricao = 'X' )

		)
		or
		( cd_objeto not in ( select cd_objeto from OBJECT_RESTRICTION where USUARIO = user and st_restricao = 'I' ) and
		cd_objeto in ( select cd_objeto from OBJECT_RESTRICTION where USUARIO = 'DWU' and st_restricao = 'X' ) AND
				cd_objeto in ( select cd_objeto from OBJECT_RESTRICTION where USUARIO = user and st_restricao = 'L' )
		)

		) and cd_objeto in ( select cd_objeto from OBJETOS OBJ where OBJ.tp_objeto='SCRIPT' )
		order by ordem asc;

	ws_script	crs_scripts%rowtype;

	ws_titulo	varchar2(400);
	ws_tipo     varchar2(40);
	
	ws_url      varchar2(60)  := '';
	ws_alt      varchar2(60)  := '';
	ws_att      varchar2(200) := '';
	ws_padrao   varchar2(80)  := 'PORTUGUESE';
	ws_usuario  varchar2(80);
	ws_admin    varchar2(20);

begin
	/*fcl.refresh_Session;*/
	select nm_objeto into ws_titulo
	from OBJETOS
	where cd_objeto=prm_call and tp_objeto='CALL_LIST';

	ws_usuario := gbl.getUsuario;
	ws_admin   := gbl.getNivel;

	begin
		select CONTEUDO into ws_padrao
		from   PARAMETRO_USUARIO
		where  cd_usuario = ws_usuario and
			cd_padrao='CD_LINGUAGEM';
	exception
		when others then
			ws_padrao := 'PORTUGUESE';
	end;
	
	if ws_admin = 'A' then
		ws_url := ''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download?arquivo=';
		htp.p('<span title="'||fun.lang('Op&ccedil;&otilde;es')||'" class="options closed" id="'||rtrim(prm_call)||'more">');
			htp.p('<span class="preferencias" title="'||fun.lang('Propriedades')||'"></span>');
			htp.p('<span class="lightbulb" title="'||fun.lang('Lista do Menu')||'"></span>');
			--htp.p('<span class="removeobj" title="Excluir"></span>');
			--htp.p('<span>');
			fcl.button_lixo('dl_obj', prm_objeto=> prm_call);
			--htp.p('</span>');
		htp.p('</span>');
		
		--htp.p('<a class="fechar" id="'||trim(prm_call)||'fechar" title="'||fun.lang('Fechar')||'">X</a>');
		htp.p('<h2>'||fun.utranslate('NM_OBJETO', prm_call, ws_titulo, ws_padrao)||'</h2>');
	else
		ws_url := ''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download_tab?prm_arquivo=';
		ws_alt := '&prm_alternativo=';
		htp.p('<span title="'||fun.lang('Op&ccedil;&otilde;es')||'" class="options closed" id="'||rtrim(prm_call)||'more" style="max-width: 34px;">');
			htp.p('<span class="lightbulb" title="'||fun.lang('Lista do Menu')||'"></span>');
		htp.p('</span>');
		htp.p('<h2>'||fun.utranslate('NM_OBJETO', prm_call, ws_titulo, ws_padrao)||'</h2>');
	end if;
		htp.p('<ul id="space-options">');
		
		open crs_itens;
			loop
			fetch crs_itens into ws_itens;
			exit when crs_itens%notfound;
				ws_tipo := ws_itens.tp_objeto;
				
				if ws_itens.attrib <> 'N/A' and ws_itens.tp_objeto <> 'RELATORIO' then
					ws_att :=  'download="'||ws_itens.attrib||'" href="'||ws_url||ws_itens.attrib||ws_alt||'"';
				end if;
				
				if trim(nvl(ws_itens.nm_item,'')) <> '''' then
					htp.p('<li class="'||ws_tipo||'" id="'||ws_itens.cd_objeto||'menu"><a '||ws_att||'>'||fun.subpar(ws_itens.nm_item, prm_screen)||'</a></li>');
				else
					htp.p('<li class="'||ws_tipo||'" id="'||ws_itens.cd_objeto||'menu"><a '||ws_att||'>'||fun.subpar(fun.utranslate('NM_OBJETO', ws_itens.cd_objeto, ws_itens.nm_objeto, ws_padrao), prm_screen)||'</a></li>');
				end if;
			end loop;
		close crs_itens;

		open crs_scripts;
			loop
				fetch crs_scripts into ws_script;
				exit when crs_scripts%notfound;
				if trim(ws_script.nm_item) <> '''' then
					htp.p('<li class="SCRIPT" id="'||ws_script.cd_objeto||'menu"><a onclick="appendar('''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.obj.show_objeto?prm_objeto='||ws_script.cd_objeto||'&PRM_ZINDEX=2&prm_posx=100px&prm_posy=100px&prm_screen=''+tela, '''', false); setTimeout(function(){ remover(''script-load''); }, 10000);">'||ws_script.nm_item||'</a></li>');
				else
					htp.p('<li class="SCRIPT" id="'||ws_script.cd_objeto||'menu"><a onclick="appendar('''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.obj.show_objeto?prm_objeto='||ws_script.cd_objeto||'&PRM_ZINDEX=2&prm_posx=100px&prm_posy=100px&prm_screen=''+tela, '''', false); setTimeout(function(){ remover(''script-load''); }, 10000);">'||ws_script.nm_objeto||'</a></li>');
				end if;
			end loop;
		close crs_scripts;

		htp.p('</ul>');
		
end call_list;


procedure dl_gadg ( prm_objeto varchar2 default null ) as

begin
	/*fcl.refresh_Session;*/
	begin
		delete from OBJETOS where cd_objeto = prm_objeto;
		commit;
	exception when others then
		htp.p(fun.lang('Objeto n&atilde;o foi excluido')||'.');
	end;
end dl_gadg;


/* Edita Propriedades Ponto */


procedure ponto_av ( prm_micro_visao varchar2 default null,
					ws_par_sumary 	varchar2 default null,
					ws_par_tipo	varchar2 default null,
					ws_par_seecol	varchar2 default null,
					prm_zindex     varchar2 default null,
					ws_par_linhas	varchar2 default null,
					ws_par_colunas	varchar2 default null ) as

	cursor crs_ponto_avaliacao is
			select * from PONTO_AVALIACAO where cd_ponto = ws_par_sumary and cd_usuario = 'DWU';

	ws_pavl	crs_ponto_avaliacao%rowtype;

	cursor crs_objetos is
			select * from OBJETOS where rtrim(cd_objeto) = trim(ws_par_sumary) and trim(tp_objeto) = trim(ws_par_tipo);

	ws_pobj		crs_objetos%rowtype;

	ws_grupo	varchar2(40);

	ws_micro_visao	varchar2(40);
	ws_par_saida	long;
	ws_funcao	    char(1);
	ws_retorno	    varchar2(30);
	ws_count		number;

	ws_lista	DBMS_SQL.VARCHAR2_TABLE;

	ws_accesso	exception;
	ws_tabela    varchar2(40);
	ws_valores   varchar2(2000) := '';
	ws_screen  	 varchar2(200);
	ws_agrupador varchar2(200) := '';
	ws_colup     varchar2(200) := '';
	ws_coluna    varchar2(200) := '';
	ws_padrao    varchar2(80)  := 'PORTUGUESE';

begin
	/*fcl.refresh_Session;*/
	open crs_objetos;
	fetch crs_objetos into ws_pobj;
	close crs_objetos;

	if  nvl(ws_pobj.cd_objeto,'%#%') <> ws_par_sumary then
		ws_funcao       := 'G';
		ws_par_saida    := ws_par_sumary;
		ws_micro_visao  := substr(ws_par_saida, 1 ,instr(ws_par_saida,'|')-1);
		ws_par_saida    := replace(ws_par_saida,ws_micro_visao||'|','');
	else
		open crs_ponto_avaliacao;
		fetch crs_ponto_avaliacao into ws_pavl;
		close crs_ponto_avaliacao;
		ws_funcao      := 'R';
		ws_micro_visao := ws_pavl.cd_micro_visao;
		ws_par_saida   := ws_pavl.parametros;
	end if;


	begin
		select cs_coluna||'|'||cs_agrupador||'|'||cs_colup into ws_valores from PONTO_AVALIACAO where cd_ponto = ws_par_sumary and cd_usuario = 'DWU';
		
		select cs_agrupador into ws_agrupador from PONTO_AVALIACAO where cd_ponto = ws_par_sumary and cd_usuario = 'DWU';
		
		select cs_colup into ws_colup from PONTO_AVALIACAO where cd_ponto = ws_par_sumary and cd_usuario = 'DWU';
		
		select cs_coluna into ws_coluna from PONTO_AVALIACAO where cd_ponto = ws_par_sumary and cd_usuario = 'DWU';
	end;

	begin
		select CONTEUDO into ws_padrao
		from   PARAMETRO_USUARIO
		where  cd_usuario = gbl.getUsuario and
			cd_padrao='CD_LINGUAGEM';
	exception
		when others then
			ws_padrao := 'PORTUGUESE';
	end;
	
	
	ws_valores := replace(ws_valores, '||', '|');

	htp.p('<div class="itens" style="width: 346px;" onmouseleave="if(event.relatedTarget != null){ save(''savepa''); }">');
		htp.p('<h2 class="fixed">'||fun.lang('PROPRIEDADES')||'</h2>');

		htp.formOpen( cattributes => 'name="pontoa" id="savepa" style="margin: 0;"', curl =>''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.savepa', cmethod => 'post', ctarget => '');
		htp.p('<form name="pontoa" id="savepa" style="margin: 0;">');

			if ws_par_sumary <> '''' then
				htp.p('<input type="hidden" value="'||ws_par_sumary||'" class="p_parametros">');
			else
				htp.p('<input type="hidden" value="'||ws_par_sumary||'" class="p_parametros">');
			end if;
			htp.p('<input type="hidden" value="'||ws_funcao||'" class="p_funcao">');

			htp.p('<input type="hidden" value="" class="pcs_parametros">');
			if  ws_par_tipo not in ('PIZZA','ROSCA', 'LINHAS','BARRAS', 'COLUNAS', 'MAPA','SANKEY','SCATTER','RADAR','CALENDARIO') then
				htp.p('<input type="hidden" value="'||ws_pavl.cs_coluna||'" class="pcs_coluna">');
			end if;
			if  ws_par_tipo in ('PIZZA','ROSCA', 'LINHAS','BARRAS', 'COLUNAS', 'MAPA','SANKEY','SCATTER','RADAR', 'CALENDARIO') then
				htp.p('<input type="hidden" value="'||ws_par_sumary||'" class="pcs_agrupador">');
			else
				htp.p('<input type="hidden" value="'||ws_pavl.cs_agrupador||'" class="pcs_agrupador">');
			end if;
			htp.p('<input type="hidden" value="'||ws_pavl.cs_rp||'" class="pcs_rp">');
			htp.p('<input type="hidden" value="'||ws_pavl.cs_colup||'" class="pcs_colup">');

		htp.p('<ul class="form">');

			if prm_micro_visao <> '''' then
				select nm_tabela into ws_tabela from micro_visao where nm_micro_visao = prm_micro_visao;
				htp.p('<li class="readonly">');
					htp.p('<span class="before">'||fun.lang('Micro vis&atilde;o')||'</span>');
					htp.p('<span class="after">');	
						if (ws_funcao = 'R') then
							htp.p('<input type="text" readonly="true"id="ponto-visao" title="'||ws_micro_visao||'" class="p_cd_micro_visao" value="'||prm_micro_visao||'" />');
						else
							htp.p('<input style="width: 200px;" type="text" readonly="true" id="ponto-visao" title="'||ws_micro_visao||'" class="p_cd_micro_visao" value="'||prm_micro_visao||'" />');
						end if;
					htp.p('</span>');
					if ws_funcao = 'R' then
						/*htp.p('<input type="text" readonly="true"id="ponto-visao" title="'||ws_micro_visao||'" class="p_cd_micro_visao" value="'||prm_micro_visao||'" />'); */
						htp.p('<a title="'||fun.lang('Colunas')||'" class="colunaprop" onclick="document.getElementById(''attriblist'').classList.remove(''open''); curtain(''enabled''); titulo(this, ''n''); call_save(''''); carregaPainel(''list_crocks&prm_default='||ws_micro_visao||'''); telaSup(''visao'','''||prm_micro_visao||''');">');
							htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" xml:space="preserve"> <g> <g> <g> <circle cx="256" cy="256" r="64"></circle> <circle cx="256" cy="448" r="64"></circle> <circle cx="256" cy="64" r="64"></circle> </g> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
						htp.p('</a>');
					else
						/*htp.p('<input style="width: 200px;" type="text" readonly="true" id="ponto-visao" title="'||ws_micro_visao||'" class="p_cd_micro_visao" value="'||prm_micro_visao||'" />'); */
						htp.p('<a title="'||fun.lang('Colunas')||'" class="colunaprop" onclick="document.getElementById(''attriblist'').classList.remove(''open''); titulo(this, ''n''); call_save(''''); carregaPainel(''list_crocks&prm_default='||ws_micro_visao||'''); telaSup(''visao'','''||prm_micro_visao||''');">');
							htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" xml:space="preserve"> <g> <g> <g> <circle cx="256" cy="256" r="64"></circle> <circle cx="256" cy="448" r="64"></circle> <circle cx="256" cy="64" r="64"></circle> </g> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
						htp.p('</a>');
					end if;
				htp.p('</li>');
				htp.p('<li class="readonly">');
					htp.p('<span class="before">'||fun.lang('Tabela')||'</span>');
					htp.p('<span class="after">');
						htp.p('<input type="text" readonly="true" title="'||ws_tabela||'" class="" value="'||ws_tabela||'" />');
					htp.p('</span>');
				htp.p('</li>');
			else
				select nm_tabela into ws_tabela from micro_visao where nm_micro_visao = ws_micro_visao;
					htp.p('<li>');
						htp.p('<span class="before">'||fun.lang('Micro vis&atilde;o')||'</span>');
						htp.p('<span class="after">');
							if ws_funcao = 'R' then
								htp.p('<input type="text" readonly="true" id="ponto-visao" title="'||ws_micro_visao||'" class="p_cd_micro_visao" value="'||ws_micro_visao||'" />');
							else
								htp.p('<input style="width: 200px;" type="text" readonly="true" title="'||ws_micro_visao||'" id="ponto-visao" class="p_cd_micro_visao" value="'||ws_micro_visao||'" />');
							end if;
						htp.p('</span>');
						htp.p('<a title="'||fun.lang('Colunas')||'" class="colunaprop" onclick="document.getElementById(''attriblist'').classList.remove(''open''); titulo(this, ''n''); call_save(''''); carregaPainel(''list_crocks&prm_default='||ws_micro_visao||'''); ajax(''list'', ''load_crocks'', ''prm_visao='||ws_micro_visao||'&prm_valores='||ws_valores||''', true, ''ajax-lista''); telaSup(''visao'','''||prm_micro_visao||''');">');
							htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" xml:space="preserve"> <g> <g> <g> <circle cx="256" cy="256" r="64"></circle> <circle cx="256" cy="448" r="64"></circle> <circle cx="256" cy="64" r="64"></circle> </g> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
						htp.p('</a>');
				htp.p('</li>');
				htp.p('<li>');
					htp.p('<span class="before">'||fun.lang('Tabela')||'</span>');
					htp.p('<span class="after">');
						htp.p('<input type="text" readonly="true" title="'||ws_tabela||'" class="" value="'||ws_tabela||'" />');
					htp.p('</span>');
				htp.p('</li>');
			end if;


			if ws_pobj.cd_objeto <> '''' then
				htp.p('<li class="readonly">');
					htp.p('<span class="before">ID</span>');
					htp.p('<span class="after">');  
						if (ws_funcao = 'R') then
							htp.p('<input required="required" type="text" class="p_cd_ponto" name="" '||fpdata(ws_funcao,'R',' readonly="yes" ','')||' value="'||ws_pobj.cd_objeto||'" size="30" maxlength="20" >');
						else
							htp.p('<input required="required" type="text" class="p_cd_ponto" name="" '||fpdata(ws_funcao,'R',' readonly="yes" ','')||' value="'||ws_pobj.cd_objeto||'" size="30" maxlength="20" >');
						end if;
					htp.p('</span>');
				htp.p('</li>');
			else
				htp.p('<li>');
					htp.p('<span class="before">ID</span>');
					htp.p('<span class="after">');	
						if (ws_funcao = 'R') then
							htp.p('<td class="readonly"><input required="required" type="text" class="p_cd_ponto" name="" '||fpdata(ws_funcao,'R',' ','')||' value="" size="30" maxlength="20" ></td>');
						else
							htp.p('<td><input required="required" type="text" class="p_cd_ponto" name="" '||fpdata(ws_funcao,'R',' ','')||' value="" size="30" maxlength="20" ></td>');
						end if;
					htp.p('</span>');
				htp.p('</li>');
			end if;

			htp.p('<li>');
				htp.p('<span class="before">'||fun.lang('Nome')||'</span>');
				htp.p('<span class="after">');
					htp.p('<input required="required" type="text" onblur="update_prop('''||ws_par_sumary||''', ''nome'', this.value);" title="'||ws_pobj.nm_objeto||'" value="'||fun.utranslate('NM_OBJETO', ws_par_sumary, ws_pobj.nm_objeto, ws_padrao)||'" size="50" maxlength="80" />');
				htp.p('</span>');
				htp.p('<a class="fakelang mini" onclick="fakeLang('''||ws_par_sumary||'_nome'', '''||ws_par_sumary||'|NM_OBJETO|''+this.previousElementSibling.children[0].title);">L</a>');
			htp.p('</li>');

			htp.p('<li>');
				htp.p('<span class="before">'||fun.lang('Subtitulo')||'</span>');
				htp.p('<span class="after">');    
					htp.p('<input required="required" type="text" onblur="update_prop('''||ws_par_sumary||''', ''subtitulo'', this.value);" title="'||ws_pobj.subtitulo||'" value="'||fun.utranslate('NM_OBJETO', ws_par_sumary, ws_pobj.subtitulo, ws_padrao)||'" size="50" maxlength="200" />');
				htp.p('</span>');
				htp.p('<a class="fakelang mini" onclick="fakeLang(''fake_atributo'', '''||ws_par_sumary||'|SUBTITULO|''+this.previousElementSibling.children[0].title);">L</a>');
			htp.p('</li>');

			begin
				select count(*) into ws_count from objetos where cd_objeto = trim(ws_par_sumary);
				if ws_count = 1 then
					select cd_grupo into ws_grupo from objetos where cd_objeto = trim(ws_par_sumary);
				else
					ws_grupo := '';
				end if;
			end;
			
			
			htp.p('<li>');
				htp.p('<span class="before">'||fun.lang('Categoria')||'</span>');
				htp.p('<span class="after">');
					htp.p('<a class="script" onclick="update_prop('''||ws_par_sumary||''', ''grupo'', this.nextElementSibling.title);"></a>');
					fcl.fakeoption('fake-grupo', fun.lang('Escolha uma categoria'), ws_grupo, 'lista-grupos', 'N', 'N', '');
				htp.p('</span>');
			htp.p('</li>');
			
			if ws_par_tipo = 'CONSULTA' then
				htp.p('<li>');
					htp.p('<span class="before">'||fun.lang('Coluna')||'</span>');
					htp.p('<span class="after">');
						htp.p('<a class="script" onclick="update_prop('''||ws_par_sumary||''', ''coluna'', this.nextElementSibling.title);"></a>');
						fcl.fakeoption('coluna-principal', fun.lang('Escolha uma coluna'), ws_coluna, 'lista-pivot', 'N', 'S', 'ponto-visao');
					htp.p('</span>');
				htp.p('</li>');
				
				if ws_par_tipo <> 'BROWSER' then
					htp.p('<li>');
						htp.p('<span class="before">'||fun.lang('Agrupador')||'</span>');
						htp.p('<span class="after">');
							htp.p('<a class="script" onclick="update_prop('''||ws_par_sumary||''', ''agrupador'', this.nextElementSibling.title);"></a>');
							fcl.fakeoption('coluna-agrupador', fun.lang('Escolha um agrupador'), ws_agrupador, 'lista-valor', 'N', 'S', 'ponto-visao');
						htp.p('</span>');
					htp.p('</li>');
				end if;
				
				htp.p('<li>');
					htp.p('<span class="before">'||fun.lang('Pivot')||'</span>');
					htp.p('<span class="after">');
						htp.p('<a class="script" onclick="update_prop('''||ws_par_sumary||''', ''colup'', this.nextElementSibling.title);"></a>');
						fcl.fakeoption('coluna-pivot', fun.lang('Escolha um pivot'), ws_colup, 'lista-pivot', 'N', 'S', 'ponto-visao');
					htp.p('</span>');
				htp.p('</li>');
			end if;

			if ws_par_tipo in ('VALOR') then
				
				htp.p('<li>');
					htp.p('<span class="before">'||fun.lang('Colunas utilizadas')||'</span>');
					htp.p('<span class="after">');
						htp.p('<a onclick="fakeOption(''fakecolumn'', '''||fun.lang('COLUNAS')||''', ''colunav'', '''||ws_par_sumary||''');" class="link">'||fun.lang('ALTERAR')||'</a>');
					htp.p('</span>');
				htp.p('</li>');
			end if;

			if ws_par_tipo in ('PIZZA','ROSCA','LINHAS','BARRAS','COLUNAS','MAPA','SANKEY','SCATTER','RADAR', 'CALENDARIO') then
				htp.p('<li>');
					htp.p('<span class="before">'||fun.lang('Coluna')||'</span>');
					htp.p('<span class="after">');
						htp.p('<select class="pcs_coluna">');
							if  ws_funcao = 'R' then
								ws_retorno := fun.ret_list(ws_pavl.cs_coluna,ws_lista);
							else
								ws_retorno := fun.ret_list(ws_par_colunas,ws_lista);
							end if;
							for i in ws_lista.FIRST..ws_lista.LAST
							loop
								fcl.formSelectOption( fun.cdesc(ws_lista(i),'MICRO_COLUNA'),ws_lista(i));
							end loop;
						htp.formSelectClose;
					htp.p('</span>');
				htp.p('</li>');
			end if;
			
			htp.p('<li data-hint="'||fun.lang('Log Di&aacute;rio')||'" style="display: none;">');
				htp.p(htf.formCheckbox( '', cchecked=> fpdata(ws_pavl.ar_diario,'S','CHECKED',''), cattributes => 'class="p_ar_diario" style="font-size: 10px; width: 14px;"'));
			htp.p('</li>');

			htp.p('<li data-hint="'||fun.lang('Log Mensal')||'" style="display: none;">');
				htp.p(htf.formCheckbox( '', cchecked=> fpdata(ws_pavl.ar_mensal,'S','CHECKED',''), cattributes => 'class="p_ar_mensal" style="font-size: 10px; width: 14px;"'));
			htp.p('</li>');

			htp.p('<li data-hint="'||fun.lang('Log Anual')||'" style="display: none;">');
				htp.p(htf.formCheckbox( '', cchecked=> fpdata(ws_pavl.ar_anual,'S','CHECKED',''), cattributes => 'class="p_ar_anual" style="font-size: 10px; width: 14px;"'));
			htp.p('</li>');

			htp.p('<li data-hint="View" style="display: none;">');
				htp.formSelectOpen( cname => '', cattributes => ' class="p_cd_visao"');
					fcl.formSelectOption( fun.lang('Publica'),'T', fpdata(ws_pavl.cd_visao,'T','SELECTED',''));
					fcl.formSelectOption( fun.lang('Privada'),'U', fpdata(ws_pavl.cd_visao,'U','SELECTED',''));
				htp.formSelectClose;
			htp.p('</li>');

			htp.p('<li data-hint="'||fun.lang('Renova&ccedil;&atilde;o')||'" style="display: none;">');
				htp.formSelectOpen( cname => '', cattributes => ' class="p_tp_renovacao"');
					fcl.formSelectOption( fun.lang('Online'),'O', fpdata(ws_pavl.tp_renovacao,'O','SELECTED',''));
					fcl.formSelectOption( fun.lang('Noturna'),'N', fpdata(ws_pavl.tp_renovacao,'N','SELECTED',''));
				htp.formSelectClose;
			htp.p('</li>');


			htp.p('<li>');
				htp.p('<span class="before">'||fun.lang('Descritivo')||'</span>');
				htp.p('<span class="after">');
					htp.p('<textarea style="max-width: 180px; height: 36px;" onblur="update_prop('''||ws_par_sumary||''', ''descritivo'', this.value);">'||ws_pavl.ds_ponto||'</textarea>');
				htp.p('</span>');
			htp.p('</li>');

			htp.p('<li>');
				htp.p('<span class="before">'||fun.lang('Tipo')||'</span>');
				htp.p('<span class="after">');
					htp.formText( cname => 'p_tipo', csize => '12', cattributes => 'class="p_tipo" readonly="yes" style="background: #BBB; width: 200px;"', cvalue => ws_par_tipo );
				htp.p('</span>');
			htp.p('</li>');
			begin
				htp.p('<li>');
					htp.p('<span class="before">'||fun.lang('Utilizado em')||'</span>');
					htp.p('<span class="after">');
						htp.p('<textarea disabled style="max-width: 220px; height: 45px; resize: none;">');
						begin
							for i in (select screen as tela from object_location where object_id = trim(ws_par_sumary)) loop
								if instr(i.tela, 'ARTICLE') > 0 then
									select (select screen from object_location t2 where t2.object_id = t1.screen) into ws_screen from object_location t1 where t1.object_id = i.tela;
								else
									ws_screen := i.tela;
								end if;
								select nm_objeto into ws_screen from objetos where cd_objeto = ws_screen;
								htp.p(ws_screen);
							end loop;
						exception when others then
							htp.p('');
						end;
						htp.p('</textarea>');
					htp.p('</span>');
				htp.p('</li>');
			end;

			/*htp.p('<li data-hint="Dimens&otilde;es da consulta"><a class="link" onclick="fakeOption(document.querySelector(''.p_cd_ponto'').value, ''DIMENS&Otilde;ES'', ''consulta_dimensoes'', document.querySelector(''.p_cd_micro_visao'').value);">DIMENS&Otilde;ES</a></li>'); */

		htp.p('</ul>');

		htp.formClose;

	htp.p('</div>');
	
	fcl.closer_menu;

exception when others then
	htp.p(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
end ponto_av;






/* Edita Parametros Padrão */

procedure edit_vpadrao ( ws_par_sumary 	varchar2 default null ) as

	cursor crs_vpadrao is
		select cd_padrao, nm_padrao, tp_padrao, cd_ligacao, status, ordem from PARAMETRO_PADRAO
		where cd_padrao = ws_par_sumary
		order by ordem;

	ws_vpadrao	crs_vpadrao%rowtype;

	cursor crs_cdesc is
		select nds_tabela from CODIGO_DESCRICAO;

	ws_cdesc crs_cdesc%rowtype;

	ws_par_saida long;
	ws_funcao char(1);
	ws_retorno varchar2(30);
	ws_cont number;

	ws_lista DBMS_SQL.VARCHAR2_TABLE;

	ws_accesso exception;

begin
	/*fcl.refresh_Session;*/
	open crs_vpadrao;
	fetch crs_vpadrao into ws_vpadrao;
	close crs_vpadrao;

	if  nvl(ws_vpadrao.cd_padrao,'%#%') <> ws_par_sumary or ws_par_sumary='NOVO' then
		ws_funcao := 'G';
	else
		ws_funcao := 'R';
	end if;

	htp.formOpen( cattributes => 'name="pontoa" id="savevp"', curl =>''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.savevp', cmethod => 'post', ctarget => '');

	htp.p('<table class="form">');
	htp.p('<input type="hidden" class="p_funcao" value="'||ws_funcao||'" />');

	htp.tableRowOpen;
		htp.p('<td>'||fun.lang('PADR&Atilde;O')||':</td>');
		htp.p('<td><input type="text" class="p_cd_padrao" '||fpdata(ws_funcao,'R',' readonly="yes" ','')||' value="'||ws_vpadrao.cd_padrao||'" class="up" size="30" maxlength="20"></td>');
	htp.tableRowClose;

	htp.tableRowOpen;
		htp.p('<td>'||fun.lang('NOME')||':</td>');
		htp.p('<td><input type="text" class="p_nm_padrao" value="'||ws_vpadrao.nm_padrao||'" size="30" maxlength="80"></td>');
	htp.tableRowClose;

	htp.tableRowOpen;
		htp.p('<td>'||fun.lang('TIPO')||':</td>');
		htp.p('<td>');
			htp.formSelectOpen( cname => '', cattributes => 'class="p_tp_padrao"');
			fcl.formSelectOption(fun.lang('Sem'), 'SEM', fpdata(ws_vpadrao.tp_padrao,'SEM', 'SELECTED',''),'');
			fcl.formSelectOption(fun.lang('Data'), 'DATA', fpdata(ws_vpadrao.tp_padrao,'DATA', 'SELECTED',''),'');
			fcl.formSelectOption(fun.lang('M&ecirc;s'), 'MES', fpdata(ws_vpadrao.tp_padrao,'MES', 'SELECTED',''),'');
			fcl.formSelectOption(fun.lang('Ano'), 'ANO', fpdata(ws_vpadrao.tp_padrao,'ANO', 'SELECTED',''),'');
			fcl.formSelectOption(fun.lang('Texto'), 'TEXTO', fpdata(ws_vpadrao.tp_padrao,'TEXTO', 'SELECTED',''),'');
			fcl.formSelectOption(fun.lang('Inteiro'),'INTEIRO', fpdata(ws_vpadrao.tp_padrao,'INTEIRO', 'SELECTED',''),'');
			fcl.formSelectOption(fun.lang('Número'),	'NUMERO', fpdata(ws_vpadrao.tp_padrao,'NUMERO',	'SELECTED',''),'');
			htp.formSelectClose;
		htp.p('</td>');
	htp.tableRowClose;

	htp.tableRowOpen;
		htp.p('<td>'||fun.lang('VIS&Iacute;VEL')||':</td>');
		htp.p('<td>');
			htp.formSelectOpen( cname => '', cattributes => 'class="p_status"');
			fcl.formSelectOption(fun.lang('Sim'), 'A', fpdata(ws_vpadrao.tp_padrao,'A', 'SELECTED',''),'');
			fcl.formSelectOption(fun.lang('N&atilde;o'), 'I', fpdata(ws_vpadrao.tp_padrao,'I', 'SELECTED',''),'');
			htp.formSelectClose;
		htp.p('</td>');
	htp.tableRowClose;

	htp.tableRowOpen;
		htp.p('<td>'||fun.lang('LIGA&Ccedil;&Atilde;O')||':</td>');
		htp.p('<td>');
			htp.formSelectOpen( cname => '', cattributes => 'class="p_cd_ligacao"');
			fcl.formSelectOption(fun.lang('Sem Liga&ccedil;&atilde;o'),'SEM');
			open crs_cdesc;
			loop
				fetch crs_cdesc into ws_cdesc;
				exit when crs_cdesc%notfound;
						fcl.formSelectOption( ws_cdesc.nds_tabela,ws_cdesc.nds_tabela, fpdata(ws_vpadrao.cd_ligacao,ws_cdesc.nds_tabela,'SELECTED',''));
				end loop;
			close crs_cdesc;
			htp.formSelectClose;
		htp.p('</td>');
	htp.tableRowClose;
	htp.formClose;
	htp.tableClose;

	htp.p('<div class="listar"><a onclick=" call_save(''''); carrega(''list_vpadrao''); ">'||fun.lang('Listar par&acirc;metros')||'</a></div>');

end edit_vpadrao;


--!!
procedure ed_gadg ( ws_par_sumary varchar2, 
					prm_tipo      varchar2 default null,
					prm_tipo_graf varchar2 default null ) as

	cursor crs_objetos is
	select * from OBJETOS where cd_objeto = ws_par_sumary;

	ws_obj crs_objetos%rowtype;

	cursor crs_agrupadores is
	select column_value, (select max(nm_rotulo) from micro_coluna where cd_coluna = column_value) as coluna from table(fun.vpipe((select cs_agrupador from ponto_avaliacao where cd_ponto = ws_par_sumary)));

	ws_agrupador crs_agrupadores%rowtype;

	ws_micro_visao   varchar2(80);
	ws_ronly         varchar2(40);
	ws_par_saida     long;
	ws_funcao        char(1);
	ws_grupo         varchar2(40);
	ws_micro_count   number;
	ws_count         number;
	ws_tabela        varchar2(40);
	ws_valor         varchar2(800);
	ws_screen        varchar2(2000);
	ws_cs_coluna     varchar2(600);
	ws_cs_agrupador  varchar2(600);
	ws_parametros    varchar2(600);
	-- ws_ready_count   number;
	ws_visao_count   number;
	ws_colup         varchar2(600);
	ws_padrao        varchar2(80) := 'PORTUGUESE';
	ws_usuario       varchar2(40);
	ws_admin		 varchar2(10);
	ws_desc			 varchar2(40);
	ws_nouser        exception;
	ws_custom           varchar2(1)   := 'N'; 
	ws_fakeoption_adic  varchar2(20)  := null; 
	ws_cd_prop          varchar2(100) := null;
	ws_altera_visao     varchar2(1);
	ws_multi_selecao    varchar2(1);
begin
	
	ws_usuario := gbl.getUsuario;

	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if;

	ws_admin := nvl(gbl.getNivel, 'N');

	open crs_objetos;
	fetch crs_objetos into ws_obj;
	close crs_objetos;

	if nvl(ws_obj.id_customizado,'N') = 'S'  then 
		ws_custom          := 'S';
		ws_fakeoption_adic := 'CUSTOMIZADO'; 
	end if;

	if ws_obj.cd_objeto <> ws_par_sumary or ws_par_sumary='NOVO' then
		ws_funcao := 'G';
	else
		ws_funcao := 'R';
	end if;

	if ws_obj.tp_objeto <> nvl(prm_tipo_graf, ws_obj.tp_objeto) then
		ws_obj.tp_objeto := prm_tipo_graf;
		commit;
	end if;

	htp.p('<div class="itens" data-obj="'||ws_par_sumary||'" style="width: 346px;" onmouseleave="if(document.getElementById('''||ws_par_sumary||''')){ document.getElementById('''||ws_par_sumary||''').classList.remove(''destacada''); }" onmouseenter="if(document.getElementById('''||ws_par_sumary||''')){ document.getElementById('''||ws_par_sumary||''').classList.add(''destacada''); }">');

		htp.p('<h2>'||fun.lang('PROPRIEDADES')||'</h2>');

		htp.p('<ul class="form">');
	
		-- select nvl(sign(length(max(cd_micro_visao))), 0) into ws_ready_count  from ponto_avaliacao where cd_ponto = ws_par_sumary ; 	
		ws_micro_visao  := null;
		ws_valor        := null;
		ws_tabela       := null;
		ws_cs_coluna    := null;
		ws_cs_agrupador := null;
		begin 
			select cd_micro_visao, parametros,    cs_coluna,    cs_agrupador,    cs_coluna||'|'||cs_agrupador||'|'||cs_colup, (select max(nm_tabela) from micro_visao where nm_micro_visao = cd_micro_visao)  
			into ws_micro_visao, ws_parametros, ws_cs_coluna, ws_cs_agrupador, ws_valor, ws_tabela  
			from ponto_avaliacao 
			where cd_ponto = ws_par_sumary;
		exception when others then  null;
		end; 

		ws_altera_visao := 'N'; 
		if ws_micro_visao is null or (ws_micro_visao is not null and (ws_parametros is null and ws_cs_coluna is null and ws_cs_agrupador is null)) then 
			ws_altera_visao := 'S'; 
		end if; 

		if ws_obj.tp_objeto not in ('IMAGE', 'TEXTO', 'ICONE', 'BROWSER', 'RELATORIO') then -- retirado o comentario do relatorio para que volte ocultar a micro-visão nas propriedades

			if ws_altera_visao = 'N' then  -- Não pode mais alterar a micro visão 

				if length(ws_micro_visao) > 0 then
					htp.p('<li class="readonly">');
				else
					htp.p('<li style="display: none;">');
				end if;

					htp.p('<span class="before">'||fun.lang('MICRO VIS&Atilde;O')||'</span>');
					htp.p('<span class="after">');     
						htp.p('<input type="text" readonly="true" id="micro-visao" class="p_cd_micro_visao" title="'||ws_micro_visao||'" value="'||ws_micro_visao||'" />');
					htp.p('</span>'); 
					
					if ws_custom <> 'S' or ws_admin = 'A' then 
						--htp.p('<a title="'||fun.lang('Colunas')||'" class="colunaprop" onclick="document.getElementById(''attriblist'').classList.remove(''open''); titulo(this, ''n''); curtain(''enabled''); call_save(''''); carregaPainel(''list_crocks'', '''||ws_par_sumary||'''); /*ajax(''list'', ''load_crocks'', ''prm_visao='||ws_micro_visao||'&prm_valores='||ws_valor||''', true, ''ajax-lista''); loader(''ajax-lista'');*/ telaSup(''visao'','''||ws_micro_visao||'''); ajax(''fly'', ''remove_coluna'', ''prm_visao='||ws_micro_visao||''', ''true'');">');
						htp.p('<a title="'||fun.lang('Colunas')||'" class="colunaprop" onclick="var v_micro_visao = document.querySelector(''.itens'').querySelector(''#micro-visao'').title; document.getElementById(''attriblist'').classList.remove(''open''); titulo(this, ''n''); curtain(''enabled''); call_save(''''); carregaPainel(''list_crocks'', '''||ws_par_sumary||''');  telaSup(''visao'', v_micro_visao); ajax(''fly'', ''remove_coluna'', ''prm_visao='' + v_micro_visao, ''true'');">');						
							htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" xml:space="preserve"> <g> <g> <g> <circle cx="256" cy="256" r="64"></circle> <circle cx="256" cy="448" r="64"></circle> <circle cx="256" cy="64" r="64"></circle> </g> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
						htp.p('</a>');
					end if; 

				htp.p('</li>');
			else
				htp.p('<li>');
					htp.p('<span class="before">'||fun.lang('MICRO VIS&Atilde;O')||'</span>');
					htp.p('<span class="after">');    
						htp.p('<a class="script" onclick="update_prop(document.getElementById(''ident'').value, ''view'', this.nextElementSibling.title); document.querySelector(''.itens'').setAttribute(''data-alterado'', ''T''); telaSup(''visao'', this.nextElementSibling.title );"></a>');
						
						if ws_custom = 'S' or ws_admin = 'A'	then 
							fcl.fakeoption('micro-visao', fun.lang('Escolha uma view'), ws_micro_visao, 'lista-views-custom', 'N', 'N', '');						
						else 
							fcl.fakeoption('micro-visao', fun.lang('Escolha uma view'), ws_micro_visao, 'lista-views', 'N', 'N', '');						
						end if;	

					htp.p('</span>');
					
					if ws_custom <> 'S' or ws_admin = 'A' then 
						htp.p('<a title="'||fun.lang('Colunas')||'" class="colunaprop" onclick="var v_micro_visao = document.querySelector(''.itens'').querySelector(''#micro-visao'').title; document.getElementById(''attriblist'').classList.remove(''open''); titulo(this, ''n''); curtain(''enabled''); call_save(''''); carregaPainel(''list_crocks'', '''||ws_par_sumary||''');  telaSup(''visao'', v_micro_visao ); ajax(''fly'', ''remove_coluna'', ''prm_visao='' + v_micro_visao, ''true'');">');
							htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" xml:space="preserve"> <g> <g> <g> <circle cx="256" cy="256" r="64"></circle> <circle cx="256" cy="448" r="64"></circle> <circle cx="256" cy="64" r="64"></circle> </g> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
						htp.p('</a>');
					end if; 

				htp.p('</li>');
				
			end if;

			-- 03/10/2022 - desativado- já está carregando essas variáveis antes 
			-- if ws_obj.tp_objeto in ('PIZZA', 'ROSCA', 'LINHAS', 'BARRAS','COLUNAS', 'CONSULTA') and ws_ready_count = 1 then
			--    select cd_micro_visao, cs_coluna, cs_agrupador into ws_micro_visao, ws_cs_coluna, ws_cs_agrupador from ponto_avaliacao where cd_ponto = ws_par_sumary;
			--end if;

		end if;

		-- Tabela física do Browser 
		select count(*) into ws_micro_count from micro_data where nm_micro_data = ws_micro_visao;
		if ws_micro_count >= 1 then
			select nm_tabela into ws_tabela from micro_data where nm_micro_data = ws_micro_visao;
			if length(ws_tabela) > 0 then
				htp.p('<li class="readonly">');
			else
				htp.p('<li style="display: none;">');
			end if;
				htp.p('<span class="before">'||fun.lang('Tabela')||'</span>');  
				htp.p('<span class="after">');
					htp.p('<input type="text" readonly="true" title="'||ws_tabela||'" value="'||ws_tabela||'" />');
				htp.p('</span>');
			htp.p('</li>');
		else 
			if ws_custom <> 'S' then   -- Não é browser (não te micri_data) e não é consulta customizada 
				if ws_altera_visao = 'N' then  -- Se não pode mais alterar a visão, pode mostrar a tabela da visão 
					if length(ws_tabela) > 0 then
						htp.p('<li class="readonly">');
					else
						htp.p('<li style="display: none;">');
					end if;
						htp.p('<span class="before">'||fun.lang('Tabela F&iacute;sica Micro Vis&atildeo')||'</span>');  
						htp.p('<span class="after">');
							htp.p('<input type="text" readonly="true" title="'||ws_tabela||'" value="'||ws_tabela||'" />');
						htp.p('</span>');
					htp.p('</li>');
				end if; 

				-- Nova propriedade para lançar tabela física do objeto para a tabela da micro visão 
				IF ws_obj.tp_objeto <>'TEXTO' THEN
					ws_cd_prop := fun.GETPROP (ws_obj.cd_objeto, 'TABELA_FISICA_OBJETO', null, 'DWU', ws_obj.tp_objeto); 
					htp.p('<li>');
						htp.p('<span class="before">'||fun.lang('Tabela F&iacute;sica Objeto')||'</span>');
						htp.p('<span class="after">');
							htp.p('<input id="'||ws_par_sumary||'_TABELA_FISICA_OBJETO'||'" type="text" data-default="'||ws_cd_prop||'" onkeyup="if(this.value != this.getAttribute(''data-default'')){ ajax(''input'', ''check_data'', ''prm_valor=''+this.value+''&prm_tabela=TABELA_FISICA_OBJETO&prm_true=error&prm_false=ok'', true, '''||ws_par_sumary||'_TABELA_FISICA_OBJETO''); }" onblur="if(this.value != this.getAttribute(''data-default'')){ if(this.classList.contains(''error'')){alerta(''feed-fixo'', ''Tabela f&iacute;sica n&atilde;o existente da base de dados''); } else { update_prop('''||ws_par_sumary||''', ''TABELA_FISICA_OBJETO'', this.value); this.setAttribute(''data-default'', this.value); this.classList.remove(''ok''); }}"  value="'||ws_cd_prop||'" maxlength="80" >');
						htp.p('</span>');
					htp.p('</li>');
				END IF;
			end if;
		end if; 

		htp.p('<li style="display: none;"><input type="hidden" class="p_funcao" value="'||ws_funcao||'"/></li>');

		htp.p('<li class="readonly">');
			htp.p('<span class="before">ID</span>');
			htp.p('<span class="after">');
				htp.p('<input type="text" readonly id="ident" data-default="'||ws_par_sumary||'" class="p_cd_objeto" value="'||ws_obj.cd_objeto||'" >');
			htp.p('</span>');
		htp.p('</li>');

		if ws_custom <> 'S' or ws_admin = 'A' then 
			htp.p('<li>');
				htp.p('<span class="before">COD</span>');
				htp.p('<span class="after">');
					htp.p('<input id="'||ws_par_sumary||'cod" type="text" data-default="'||ws_obj.cod||'" onkeyup="if(this.value != this.getAttribute(''data-default'')){ ajax(''input'', ''check_data'', ''prm_valor=''+this.value+''&prm_tabela=objetos'', true, '''||ws_par_sumary||'cod''); }" onblur="if(this.value != this.getAttribute(''data-default'')){ if(!this.classList.contains(''error'')){ update_prop('''||ws_par_sumary||''', ''COD'', this.value); this.setAttribute(''data-default'', this.value); this.classList.remove(''ok''); }}"  value="'||ws_obj.cod||'" maxlength="80" >');
				htp.p('</span>');
			htp.p('</li>');
		end if;

		htp.p('<li>');
			htp.p('<span class="before">'||fun.lang('Nome')||'</span>');
			htp.p('<span class="after">');
				htp.p('<textarea onkeypress="if(!input(event, ''nobr'')){ event.preventDefault(); }" onblur="update_prop(document.getElementById(''ident'').value, ''nome'', this.value);" title="'||ws_obj.nm_objeto||'" value="'||replace(ws_obj.nm_objeto, '"', '&quot;')||'" size="50" maxlength="80">'||replace(ws_obj.nm_objeto, '"', '&quot;')||'</textarea>');
			htp.p('</span>');
			htp.p('<a class="fakelang mini" onclick="fakeLang('''||ws_obj.nm_objeto||'_nome'', '''||ws_par_sumary||'|NM_OBJETO|''+this.previousElementSibling.children[0].title);">L</a>');
		htp.p('</li>');

		if ws_obj.tp_objeto not in ('BROWSER','TEXTO')  then

			htp.p('<li>');
				htp.p('<span class="before">'||fun.lang('Subt&iacute;tulo')||'</span>');
				htp.p('<span class="after">');
					htp.p('<input type="text" onblur="update_prop(document.getElementById(''ident'').value, ''subtitulo'', this.value);" title="'||ws_obj.subtitulo||'" value="'||replace(ws_obj.subtitulo, '"', '&quot;')||'" size="4000" maxlength="4000">');
				htp.p('</span>');
				htp.p('<a class="fakelang mini" onclick="fakeLang(''fake_atributo'', '''||ws_par_sumary||'|SUBTITULO|''+this.previousElementSibling.children[0].title);">L</a>');
			htp.p('</li>');

		end if;

		if ws_obj.tp_objeto in ('FILE', 'ICONE', 'IMAGE') then
			htp.p('<li data-hint="URL">');
				htp.p('<span class="before">'||fun.lang('URL')||'</span>');
				htp.p('<span class="after">');
					htp.p('<a class="script" onclick="var url = '''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download?arquivo=''+this.nextElementSibling.title; update_prop(document.getElementById(''ident'').value, ''atributos'', url); if (document.getElementById('''||ws_par_sumary||'_gr'')) {document.getElementById('''||ws_par_sumary||'_gr'').setAttribute(''src'', url); };"></a>');
					fcl.fakeoption('fake_img', 'Imagem ou arquivo', replace((ws_obj.atributos), ''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download?arquivo=', ''), 'lista-arquivo-imagem', 'S', 'N');
					/*htp.p('<input id="opt-a" onchange="" type="text" class="p_atributos" value="'||ws_obj.atributos||'" size="50">');
					htp.p('<span style="max-width: 14px !important; min-width: 14px !important; background: url('||fun.r_gif('seta', 'PNG')||') no-repeat scroll center #FFF; background-position-x: center !important; margin: 0;" class="fakeoption" title="'||ws_grupo||'" id="fake_img" onclick="if(document.getElementById(''fakelist'').className == ''''){ if(document.getElementById(''attriblist'').className == ''open''){ fakelist.style.setProperty(''left'', ''355px''); } ajax(''list'', ''fakelist'', ''prm_ident=opt-a&prm_titulo=IMG&prm_campo=img&prm_visao='', false, ''fakelist''); } document.getElementById(''fakelist'').classList.toggle(''visible'');"></span>'); */
				htp.p('</span>');
			htp.p('</li>');
		elsif ws_obj.tp_objeto in ('TEXTO', 'MARQUEE') then
			
			begin
				select CONTEUDO into ws_padrao
				from   PARAMETRO_USUARIO
				where  cd_usuario = ws_usuario and
					cd_padrao='CD_LINGUAGEM';
			exception
				when others then
					ws_padrao := 'PORTUGUESE';
			end;
			
			htp.p('<li>');
				htp.p('<span class="before">'||fun.lang('Texto')||'</span>');
				htp.p('<span class="after">');
					htp.p('<textarea type="text" id="fake_atributo" onblur="update_prop(document.getElementById(''ident'').value, ''atributos'', encodeURIComponent(this.value));" class="p_atributos" title="'||ws_obj.atributos||'" size="80" maxlength="800">'||replace(fun.utranslate('ATRIBUTOS', ws_par_sumary, ws_obj.atributos, ws_padrao), '"', '&quot;')||'</textarea>');
				htp.p('</span>');
				htp.p('<a class="fakelang mini" onclick="fakeLang(''fake_atributo'', '''||ws_par_sumary||'|ATRIBUTOS|''+this.previousElementSibling.children[0].title);">L</a>');
			htp.p('</li>');
		elsif ws_obj.tp_objeto = 'RELATORIO' then
			htp.p('<li>');
				htp.p('<span class="before">'||fun.lang('CONSULTA')||'</span>');
				/* htp.p('<span style="height: 16px; float: right; width: 0px; background: url('||fun.r_gif('seta', 'PNG')||') no-repeat scroll center 6px #FFF;" class="fakeoption" title="'||ws_grupo||'" id="fake_img" onclick="if(document.getElementById(''fakelist'').className == ''''){ if(document.getElementById(''attriblist'').className == ''open''){ fakelist.style.setProperty(''left'', ''355px''); } ajax(''list'', ''fakelist'', ''prm_ident=opt-a&prm_titulo=IMG&prm_campo=img&prm_visao='', false, ''fakelist''); } document.getElementById(''fakelist'').classList.toggle(''visible'');"></span>');*/
				htp.p('<span class="after">');
					/* htp.p('<input id="opt-a" type="text" class="p_atributos" onblur="update_prop(document.getElementById(''ident'').value, ''atributos'', this.value);" value="'||ws_obj.atributos||'" size="50">'); */
					begin
						select cod into ws_valor from objetos where cd_objeto = ws_obj.atributos;
					exception when others then
						ws_valor := '';
					end;

					htp.p('<a class="script" onclick="update_prop(document.getElementById(''ident'').value, ''atributos'', this.nextElementSibling.title);"></a>');
					fcl.fakeoption('fake-consulta', 'Escolha a consulta', ws_obj.atributos, 'lista-consultas', 'N', 'N', '', prm_desc => ws_valor);
				htp.p('</span>');
			htp.p('</li>');
		end if;

		if ws_custom <> 'S' or ws_admin = 'A' then 
			htp.p('<li>');
				if ws_par_sumary <> 'NOVO' then
					select t1.cd_grupo, nm_grupo into ws_grupo, ws_desc 
					from objetos t1
					left join grupos_funcao t2 on t2.cd_grupo = t1.cd_grupo
					where cd_objeto = trim(ws_par_sumary);
				else
					ws_grupo := '';
				end if;

				htp.p('<span class="before">'||fun.lang('Categoria')||'</span>');
				htp.p('<span class="after">');
					htp.p('<a class="script" onclick="update_prop(document.getElementById(''ident'').value, ''grupo'', this.nextElementSibling.title);  document.querySelector(''.itens'').setAttribute(''data-alterado'', ''T'');"></a>');
					fcl.fakeoption('fake-grupo', fun.lang('Escolha uma categoria'), ws_grupo, 'lista-grupos', 'N', 'N', '', prm_desc => ws_grupo||' - '||ws_desc);
				htp.p('</span>');
			htp.p('</li>');
		end if;

		htp.p('<li>');
	
			htp.p('<span class="before">'||fun.lang('Tipo')||'</span>');
			htp.p('<span class="after">');
				
				if ws_obj.tp_objeto in ('BARRAS', 'COLUNAS', 'LINHAS', 'PIZZA','PONTEIRO', 'MAPA', 'MAPAGEOLOC','SANKEY','SCATTER','RADAR','CALENDARIO') or (ws_obj.tp_objeto = 'OBJETO' and prm_tipo = 'grafico') then
					htp.p('<select onchange="blockOptions(this)">');
				else
					htp.p('<select class="readonly" readonly disabled>');
				end if;
				
				if ws_obj.tp_objeto in ('PIZZA', 'ROSCA', 'LINHAS', 'BARRAS', 'COLUNAS', 'PONTEIRO', 'MAPA', 'MAPAGEOLOC', 'SANKEY','SCATTER','RADAR','CALENDARIO') then
					fcl.formSelectOption(fun.lang('GR&Aacute;FICO DE BARRAS'), 'BARRAS', fpdata(ws_obj.tp_objeto,'BARRAS', 'SELECTED',''));
					fcl.formSelectOption(fun.lang('GR&Aacute;FICO DE COLUNAS'), 'COLUNAS', fpdata(ws_obj.tp_objeto,'COLUNAS', 'SELECTED',''));
					fcl.formSelectOption(fun.lang('GR&Aacute;FICO DE LINHAS'), 'LINHAS', fpdata(ws_obj.tp_objeto,'LINHAS', 'SELECTED',''));
					fcl.formSelectOption(fun.lang('GR&Aacute;FICO DE PIZZA'), 'PIZZA', fpdata(ws_obj.tp_objeto,'PIZZA', 'SELECTED',''));
					fcl.formSelectOption(fun.lang('GR&Aacute;FICO DE PONTEIRO'), 'PONTEIRO', fpdata(ws_obj.tp_objeto,'PONTEIRO', 'SELECTED',''));
					fcl.formSelectOption(fun.lang('MAPA GEOGR&Aacute;FICO'), 'MAPA', fpdata(ws_obj.tp_objeto,'MAPA', 'SELECTED',''));
					fcl.formSelectOption(fun.lang('MAPA GEOLOCALIZA&Ccedil;&Atilde;O'), 'MAPAGEOLOC', fpdata(ws_obj.tp_objeto,'MAPAGEOLOC', 'SELECTED',''));
					fcl.formSelectOption(fun.lang('GR&Aacute;FICO SANKEY'),              'SANKEY',  fpdata(ws_obj.tp_objeto,'SANKEY', 'SELECTED',''));
					fcl.formSelectOption(fun.lang('GR&Aacute;FICO DE BOLHAS'),           'SCATTER', fpdata(ws_obj.tp_objeto,'SCATTER', 'SELECTED',''));
					fcl.formSelectOption(fun.lang('GR&Aacute;FICO DE RADAR'),            'RADAR',   fpdata(ws_obj.tp_objeto,'RADAR', 'SELECTED',''));
					fcl.formSelectOption(fun.lang('GR&Aacute;FICO DE CALEND&Aacute;RIO'),'CALENDARIO',   fpdata(ws_obj.tp_objeto,'CALENDARIO', 'SELECTED',''));
					update objetos
					set tp_objeto = upper(trim(ws_obj.tp_objeto))
					where upper(trim(cd_objeto)) = upper(trim(ws_par_sumary));
					commit;
				elsif ws_obj.tp_objeto = 'OBJETO' and prm_tipo = 'valor' then
					update objetos
					set tp_objeto = upper(trim('VALOR'))
					where upper(trim(cd_objeto)) = upper(trim(ws_par_sumary));
					commit;
					fcl.formSelectOption(fun.lang('Valor'), 'VALOR', fpdata(ws_obj.tp_objeto,'VALOR', 'SELECTED',''));

				elsif ws_obj.tp_objeto = 'OBJETO' and prm_tipo = 'grafico' then
					update objetos
					set tp_objeto = upper(trim('BARRAS'))
					where upper(trim(cd_objeto)) = upper(trim(ws_par_sumary));
					fcl.formSelectOption(fun.lang('GR&Aacute;FICO DE BARRAS'), 'BARRAS', fpdata(ws_obj.tp_objeto,'BARRAS', 'SELECTED',''));
					fcl.formSelectOption(fun.lang('GR&Aacute;FICO DE COLUNAS'), 'COLUNAS', fpdata(ws_obj.tp_objeto,'COLUNAS', 'SELECTED',''));
					fcl.formSelectOption(fun.lang('GR&Aacute;FICO DE LINHAS'), 'LINHAS', fpdata(ws_obj.tp_objeto,'LINHAS', 'SELECTED',''));
					fcl.formSelectOption(fun.lang('GR&Aacute;FICO DE PIZZA'), 'PIZZA', fpdata(ws_obj.tp_objeto,'PIZZA', 'SELECTED',''));
					fcl.formSelectOption(fun.lang('GR&Aacute;FICO DE PONTEIRO'), 'PONTEIRO', fpdata(ws_obj.tp_objeto,'PONTEIRO', 'SELECTED',''));
					fcl.formSelectOption(fun.lang('MAPA GEOGR&Aacute;FICO'), 'MAPA', fpdata(ws_obj.tp_objeto,'MAPA', 'SELECTED',''));
					fcl.formSelectOption(fun.lang('MAPA GEOLOCALIZA&Ccedil;&Atilde;O'), 'MAPAGEOLOC', fpdata(ws_obj.tp_objeto,'MAPAGEOLOC', 'SELECTED',''));
					fcl.formSelectOption(fun.lang('GR&Aacute;FICO DE SANKEY'),           'SANKEY',  fpdata(ws_obj.tp_objeto,'SANKEY', 'SELECTED',''));					
					fcl.formSelectOption(fun.lang('GR&Aacute;FICO DE BOLHAS'),           'SCATTER', fpdata(ws_obj.tp_objeto,'SCATTER', 'SELECTED',''));
					fcl.formSelectOption(fun.lang('GR&Aacute;FICO DE RADAR'),            'RADAR',   fpdata(ws_obj.tp_objeto,'RADAR', 'SELECTED',''));
					fcl.formSelectOption(fun.lang('GR&Aacute;FICO DE CALEND&Aacute;RIO'),'CALENDARIO',   fpdata(ws_obj.tp_objeto,'CALENDARIO', 'SELECTED',''));
				elsif ws_obj.tp_objeto =  'OBJETO' and prm_tipo = 'consulta' THEN
					update objetos
					set tp_objeto = upper(trim('CONSULTA'))
					where upper(trim(cd_objeto)) = upper(trim(ws_par_sumary));
					fcl.formSelectOption(fun.lang('CONSULTA'), 'CONSULTA', fpdata(ws_obj.tp_objeto,'CONSULTA', 'SELECTED',''));
				elsif ws_obj.tp_objeto = 'MAPAGEOLOC'	THEN		fcl.formSelectOption(fun.lang('MAPA GEOLOCALIZA&Ccedil;&Atilde;O'),  ws_obj.tp_objeto, fpdata(ws_obj.tp_objeto, ws_obj.tp_objeto, 'SELECTED',''));					
				elsif ws_obj.tp_objeto = 'CONSULTA'     THEN		fcl.formSelectOption(fun.lang('CONSULTA'), 							 ws_obj.tp_objeto, fpdata(ws_obj.tp_objeto, ws_obj.tp_objeto, 'SELECTED',''));
				elsif ws_obj.tp_objeto = 'MAPA'         THEN		fcl.formSelectOption(fun.lang('MAPA GEOGR&Aacute;FICO'), 			 ws_obj.tp_objeto, fpdata(ws_obj.tp_objeto, ws_obj.tp_objeto, 'SELECTED',''));
				elsif ws_obj.tp_objeto = 'ORGANOGRAMA'  THEN		fcl.formSelectOption(fun.lang('Organograma'), 						 ws_obj.tp_objeto, fpdata(ws_obj.tp_objeto, ws_obj.tp_objeto, 'SELECTED',''));
				elsif ws_obj.tp_objeto = 'FILE'         THEN		fcl.formSelectOption(fun.lang('FileView'), 							 ws_obj.tp_objeto, fpdata(ws_obj.tp_objeto, ws_obj.tp_objeto, 'SELECTED',''));
				elsif ws_obj.tp_objeto = 'IMAGE'        THEN		fcl.formSelectOption(fun.lang('Imagem'), 							 ws_obj.tp_objeto, fpdata(ws_obj.tp_objeto, ws_obj.tp_objeto,'SELECTED',''));
				elsif ws_obj.tp_objeto = 'CALL_LIST'	THEN		fcl.formSelectOption(fun.lang('Menu'), 								 ws_obj.tp_objeto, fpdata(ws_obj.tp_objeto, ws_obj.tp_objeto, 'SELECTED',''));
				elsif ws_obj.tp_objeto = 'FLOAT_PAR'	THEN		fcl.formSelectOption(fun.lang('Par&acirc;metro'), 					 ws_obj.tp_objeto, fpdata(ws_obj.tp_objeto, ws_obj.tp_objeto, 'SELECTED',''));
				elsif ws_obj.tp_objeto = 'TEXTO'		THEN		fcl.formSelectOption(fun.lang('Texto'), 							 ws_obj.tp_objeto, fpdata(ws_obj.tp_objeto, ws_obj.tp_objeto,'SELECTED',''));
				elsif ws_obj.tp_objeto = 'FLOAT_FILTER' THEN		fcl.formSelectOption(fun.lang('Par&acirc;metro'), 					 ws_obj.tp_objeto, fpdata(ws_obj.tp_objeto, ws_obj.tp_objeto, 'SELECTED',''));
				elsif ws_obj.tp_objeto = 'VALOR'		THEN		fcl.formSelectOption(fun.lang('Valor'), 							 ws_obj.tp_objeto, fpdata(ws_obj.tp_objeto, ws_obj.tp_objeto, 'SELECTED',''));
				elsif ws_obj.tp_objeto = 'RELATORIO'	THEN 		fcl.formSelectOption(fun.lang('Relat&oacute;rio'), 					 ws_obj.tp_objeto, fpdata(ws_obj.tp_objeto, ws_obj.tp_objeto, 'SELECTED',''));
				elsif ws_obj.tp_objeto = 'PONTEIRO'		THEN		fcl.formSelectOption(fun.lang('Ponteiro'), 							 ws_obj.tp_objeto, fpdata(ws_obj.tp_objeto, ws_obj.tp_objeto, 'SELECTED',''));
				end if;
				htp.formSelectClose;
			htp.p('</span>');
		htp.p('</li>');

		if nvl(prm_tipo,'N/A') <> 'valor' then

			if ws_obj.tp_objeto in ('LINHAS', 'BARRAS', 'COLUNAS', 'PIZZA', 'ROSCA', 'MAPA', 'OBJETO', 'CONSULTA', 'MAPAGEOLOC', 'SANKEY', 'SCATTER','RADAR','CALENDARIO')  then
			
				htp.p('<li>');
					htp.p('<span class="before">'||fun.lang('AGRUPADOR')||'</span>');
					htp.p('<span class="after">');    
						htp.p('<a class="script" onclick="update_prop(document.getElementById(''ident'').value, ''coluna'', this.nextElementSibling.title);  document.querySelector(''.itens'').setAttribute(''data-alterado'', ''T'');"></a>');
						if ws_obj.tp_objeto in ('PIZZA', 'ROSCA', 'MAPA', 'PONTEIRO', 'OBJETO', 'CALENDARIO') and nvl(prm_tipo, 'N/A') <> 'consulta' then
							fcl.fakeoption('micro-coluna', 'Escolha uma coluna', ws_cs_coluna, 'lista-agrupador', 'N', 'N', 'micro-visao');
						else
							fcl.fakeoption('micro-coluna', 'Escolha uma coluna', ws_cs_coluna, 'lista-agrupador', 'N', 'S', 'micro-visao', prm_adicional => ws_fakeoption_adic );
						end if;
					htp.p('</span>');
				htp.p('</li>');
				
			end if;

		end if;

		if ws_obj.tp_objeto in ('LINHAS', 'BARRAS', 'COLUNAS', 'PIZZA', 'ROSCA', 'MAPA', 'OBJETO', 'CONSULTA','MAPAGEOLOC','SANKEY','SCATTER','RADAR','CALENDARIO') and NVL(prm_tipo,'N/A') <> 'valor'  then
			htp.p('<li>');
				htp.p('<span class="before">'||fun.lang('VALOR')||'</span>');
				htp.p('<span class="after">');
					htp.p('<a class="script" onclick="update_prop(document.getElementById(''ident'').value, ''agrupador'', this.nextElementSibling.title);  document.querySelector(''.itens'').setAttribute(''data-alterado'', ''T'');"></a>');
					ws_multi_selecao := 'S';
					if ws_obj.tp_objeto in ('SANKEY') and nvl(prm_tipo, 'N/A') <> 'consulta' then
						ws_multi_selecao := 'N';
					end if; 	
					fcl.fakeoption('micro-agrupador', 'Escolha um valor', ws_cs_agrupador, 'lista-valor', 'N', ws_multi_selecao, 'micro-visao', prm_adicional => ws_fakeoption_adic);
				htp.p('</span>');
			htp.p('</li>');
		end if;
		
		if ws_obj.tp_objeto in ('LINHAS', 'BARRAS', 'COLUNAS', 'OBJETO', 'CONSULTA', 'PIZZA', 'SANKEY', 'SCATTER','RADAR','CALENDARIO')  then
			begin
				select cs_colup into ws_colup from ponto_avaliacao where cd_ponto = ws_par_sumary;
			exception when others then
				ws_colup := '';
			end;
		
			
			if ws_obj.tp_objeto = 'PIZZA' or NVL(prm_tipo,'N/A')='valor' then
				htp.p('<li class="invisible">');
			else
				htp.p('<li>');
			end if;
			
				if ws_obj.tp_objeto = 'CONSULTA' then
					htp.p('<span class="before">'||fun.lang('PIVOT')||'</span>');
					htp.p('<span class="after">');
						htp.p('<a class="script" onclick="update_prop(document.getElementById(''ident'').value, ''colup'', this.nextElementSibling.title);  document.querySelector(''.itens'').setAttribute(''data-alterado'', ''T'');"></a>');
						fcl.fakeoption('coluna-pivot', fun.lang('Escolha um pivot'), ws_colup, 'lista-pivot', 'N', 'S', 'micro-visao', prm_adicional => ws_fakeoption_adic);
					htp.p('</span>');
				elsif ws_obj.tp_objeto in ( 'BARRAS', 'LINHAS', 'PIZZA', 'COLUNAS') then
					if ws_custom <> 'S' or ws_admin = 'A' then 
						htp.p('<span class="before">'||fun.lang('AUXILIAR')||'</span>');
						htp.p('<span class="after">');
							htp.p('<a class="script" onclick="update_prop(document.getElementById(''ident'').value, ''sec'', this.nextElementSibling.title);  document.querySelector(''.itens'').setAttribute(''data-alterado'', ''T'');"></a>');
							fcl.fakeoption('coluna-sec', fun.lang('Escolha o auxiliar'), fun.getprop(ws_par_sumary, 'SEC'), 'lista-valor', 'N', 'S', 'micro-visao');
						htp.p('</span>');
					end if;		
				elsif NVL(prm_tipo,'N/A')='valor' then
					htp.p('');
				else

					if NVL(prm_tipo,'N/A') <> 'grafico' and ws_obj.tp_objeto not in ('SANKEY','SCATTER','RADAR','CALENDARIO') then
						htp.p('<span class="before">'||fun.lang('PIVOT')||'</span>');
						htp.p('<span class="after">');
							htp.p('<a class="script" onclick="update_prop(document.getElementById(''ident'').value, ''colup'', this.nextElementSibling.title);  document.querySelector(''.itens'').setAttribute(''data-alterado'', ''T'');"></a>');
							fcl.fakeoption('coluna-pivot', fun.lang('Escolha um pivot'), ws_colup, 'lista-pivot', 'N', 'S', 'micro-visao');
						htp.p('</span>');
					end if;
					
					if NVL(prm_tipo,'N/A') <> 'consulta' and (ws_custom <> 'S' or ws_admin = 'A') then
						if nvl(ws_obj.tp_objeto,'NA') not in ('MAPAGEOLOC','SANKEY','SCATTER','RADAR','CALENDARIO') then 
							htp.p('<span class="before">'||fun.lang('AUXILIAR')||'</span>');
							htp.p('<span class="after">');
								htp.p('<a class="script" onclick="update_prop(document.getElementById(''ident'').value, ''sec'', this.nextElementSibling.title);  document.querySelector(''.itens'').setAttribute(''data-alterado'', ''T'');"></a>');
								fcl.fakeoption('coluna-sec', fun.lang('Escolha o auxiliar'), fun.getprop(ws_par_sumary, 'SEC'), 'lista-valor', 'N', 'S', 'micro-visao');
							htp.p('</span>');
						end if; 
					end if;
				end if;
			
			htp.p('</li>');
		end if;

		if ws_obj.tp_objeto = 'RELATORIO' then

			htp.p('<li>');
				
				htp.p('<span title="Bloquear objetos para usu&aacute;rios do tipo normal" class="before">'||fun.lang('Bloquear objeto')||'</span>');
				
				htp.p('<span class="after">');
					
					htp.p('<a class="script" onclick="call(''alter_attrib'', ''prm_objeto='||ws_par_sumary||'&prm_prop=BLOQ_OBJ&prm_value=''+this.nextElementSibling.title+''&prm_usuario=DWU'').then(function(res){ if(res.indexOf(''#alert'') == -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } });"></a>');
					
					if fun.getprop(ws_par_sumary,'BLOQ_OBJ') = 'S' then
						htp.p('<span class="checkbox checked" data-positive="S" data-negative="N" title="'||fun.getprop(ws_par_sumary,'BLOQ_OBJ')||'"></span>');
					else
						htp.p('<span class="checkbox" data-positive="S" data-negative="N" title="'||fun.getprop(ws_par_sumary,'BLOQ_OBJ')||'"></span>');
					end if;

				htp.p('</span>');
				
			htp.p('</li>');

		end if;
		
		if ws_obj.tp_objeto = 'VALOR' or ws_obj.tp_objeto = 'PONTEIRO' or nvl(prm_tipo,'N/A')='valor' then
			if ws_micro_visao is not null /*ws_ready_count = 1*/  then
				select replace(nvl(parametros, cs_agrupador), '|', '') into ws_valor from ponto_avaliacao where cd_ponto = ws_par_sumary;
			end if;
			htp.p('<li>');
				htp.p('<span class="before">'||fun.lang('VALOR')||'</span>');
				htp.p('<span class="after">');
					htp.p('<a class="script" onclick="update_prop(document.getElementById(''ident'').value, ''parametros'', this.nextElementSibling.title+''|'');  document.querySelector(''.itens'').setAttribute(''data-alterado'', ''T'');"></a>');
					fcl.fakeoption('micro-agrupador', 'Escolha um valor', ws_valor, 'lista-valor-simples', 'N', 'N', 'micro-visao');
				htp.p('</span>');
			htp.p('</li>');
		end if;

		if ws_custom <> 'S' or ws_admin = 'A' then 
			if ws_obj.tp_objeto <> 'TEXTO' then
				htp.p('<li>');
					htp.p('<span class="before">'||fun.lang('Observa&ccedil;&atilde;o')||'</span>');
					htp.p('<span class="after">');
						htp.p('<textarea class="p_ds_objeto" onblur="update_prop(document.getElementById(''ident'').value, ''descritivo'', this.value);">'||ws_obj.ds_objeto||'</textarea>');
					htp.p('</span>');
				htp.p('</li>');
			end if;
		end if;	

		select count(*) into ws_count from object_location where object_id = ws_obj.cd_objeto;

		if ws_count > 0 then

			htp.p('<li>');				
				htp.p('<span class="before">'||fun.lang('Utilizado em')||'</span>');				
				htp.p('<span class="after">');				
					htp.p('<textarea disabled style="max-width: 220px; height: 30px; resize: none;">');

					begin

						for i in (select screen as tela from object_location where object_id = ws_obj.cd_objeto) loop
							if instr(i.tela, 'ARTICLE') > 0 then
								select nvl((select screen from object_location t2 where t2.object_id = t1.screen), 'N/A') into ws_screen from object_location t1 where t1.object_id = i.tela;
							else
								ws_screen := i.tela;
							end if;
							if ws_screen <> 'N/A' then
								select max(nm_objeto) into ws_screen from objetos where cd_objeto = ws_screen;
								if nvl(ws_screen,'N/A') <> 'N/A' then  
									htp.p(ws_screen);
								end if;    
							end if;
						end loop;
					exception when others then
						htp.p('');
					end;

					htp.p('</textarea>');				
				htp.p('</span>');				
			htp.p('</li>');

		end if;

		if ws_custom = 'S' then 
			htp.p('<li>');
				htp.p('<span class="before">'||fun.lang('Liberar para outras Telas')||'</span>');
					htp.p('<span class="after">');
					--htp.p('<select onchange="update_prop(document.getElementById(''ident'').value, ''libera_objeto'', this.nextElementSibling.title);  document.querySelector(''.itens'').setAttribute(''data-alterado'', ''T'');">');
					--htp.p('<select onblur="update_prop(document.getElementById(''ident'').value, ''libera_objeto'', this.nextElementSibling.title);  document.querySelector(''.itens'').setAttribute(''data-alterado'', ''T'');">');	
					htp.p('<select onchange="update_prop(document.getElementById(''ident'').value, ''libera_objeto'', this.value);  document.querySelector(''.itens'').setAttribute(''data-alterado'', ''T''); ">');
						fcl.formSelectOption(fun.lang('SIM'),        'S', fpdata(nvl(ws_obj.id_liberado,'N'),'S', 'SELECTED',''));
						fcl.formSelectOption(fun.lang('N&Atilde;O'), 'N', fpdata(nvl(ws_obj.id_liberado,'N'),'N', 'SELECTED',''));
					htp.formSelectClose;
				htp.p('</span>');
			htp.p('</li>');	
		end if; 


		htp.p('</ul>');

	htp.p('</div>');
	
	fcl.closer_menu;

exception 
	when ws_nouser then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
end ed_gadg;

--!!
procedure ed_call ( prm_object varchar2,
					prm_screen varchar2 default null ) as

	cursor crs_objetos is
	select * from OBJETOS 
	where cd_objeto = prm_object ; 
	-- and cd_usuario = 'DWU'; -- verificar card:Propriedade da tela com erro--

	ws_obj		crs_objetos%rowtype;

	cursor crs_grupos is
	select rtrim(cd_grupo) as cd_grupo,
	rtrim(nm_grupo)	as nm_grupo,
	rtrim(status)	as status,
	rtrim(gif)	as gif
	from GRUPOS_FUNCAO order by ordem, cd_grupo;

	ws_grupo	varchar2(40);

	ws_micro_visao	varchar2(40);
	ws_ronly	varchar2(40);
	ws_par_saida	long;
	ws_funcao	char(1);
	ws_grupof	varchar2(40);
	ws_zindex   varchar2(10);
	ws_padrao   varchar2(80) := 'PORTUGUESE';
	ws_usuario  varchar2(80);

	ws_nouser   exception;
begin
	
	ws_usuario := gbl.getUsuario;

	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if;

	open crs_objetos;
	fetch crs_objetos into ws_obj;
	close crs_objetos;

	begin
		select CONTEUDO into ws_padrao
		from   PARAMETRO_USUARIO
		where  cd_usuario = ws_usuario and
			cd_padrao = 'CD_LINGUAGEM';
	exception
		when others then
			ws_padrao := 'PORTUGUESE';
	end;

	if  ws_obj.cd_objeto <> prm_object or prm_object='NOVO' then
		ws_funcao      := 'G';
	else
		ws_funcao      := 'R';
	end if;

	htp.p('<div class="itens" style="width: 346px;" onmouseleave="if(event.relatedTarget != null){ save(''savecall''); }">');

		htp.p('<h2>'||fun.lang('PROPRIEDADES')||'</h2>');

		htp.formOpen( cattributes => 'name="pontoa" id="saveap"', curl =>''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.savecallist', cmethod => 'post', ctarget => '');
		htp.p('<ul class="form">');
		htp.p('<input type="hidden" value="R" class="p_funcao"/>');

			htp.p('<li class="invisible">');
				htp.p('<input type="hidden" class="p_cd_objeto" value="'||ws_obj.cd_objeto||'">');
			htp.p('</li>');
			
			htp.p('<li data-hint="ID">');
				htp.p('<span class="before">ID</span>');
				htp.p('<span class="after">');
					htp.p('<input type="text" '||fpdata(ws_funcao,'R',' readonly="yes" ','')||' value="'||nvl(ws_obj.cod, ws_obj.cd_objeto)||'">');
				htp.p('</span>');
			htp.p('</li>');

			htp.p('<li>');
				htp.p('<span class="before">'||fun.lang('Nome')||'</span>');
				htp.p('<span class="after">');
					htp.p('<input type="text" title="'||ws_obj.nm_objeto||'" id="'||prm_object||'_nome" class="p_nm_objeto" value="'||fun.utranslate('NM_OBJETO', prm_object, ws_obj.nm_objeto, ws_padrao)||'" onblur="update_prop('''||prm_object||''', ''nome'', this.value);" size="50" maxlength="40">');
				htp.p('</span>');
				htp.p('<a class="fakelang mini" onclick="fakeLang('''||prm_object||'_nome'', '''||prm_object||'|NM_OBJETO|''+this.previousElementSibling.title);">L</a>');
			htp.p('</li>');

			select cd_grupo into ws_grupo from objetos where cd_objeto = trim(prm_object);
				/* htp.p('<li data-hint="'||fun.lang('Grupo de Fun&ccedil;&atilde;o')||'">');
					htp.p('<span style="width: 148px; margin: 2px 0 -3px 2px; background: url('||fun.r_gif('seta', 'PNG')||') no-repeat scroll 98% 6px #FFF;" class="fakeoption" title="'||ws_grupo||'" id="fake_grupo" onclick="fakeOption(''fake_grupo'', ''GRUPOS'', ''grupo'', ''''); ">'||ws_grupo||'</span>');
				htp.p('</li>'); */
				
				htp.p('<li>');
					htp.p('<span class="before">'||fun.lang('Categoria')||'</span>');
					htp.p('<span class="after">');
						htp.p('<a class="script" onclick="update_prop('''||trim(prm_object)||''', ''grupo'', this.nextElementSibling.title);"></a>');
						fcl.fakeoption('fake-grupo', ws_grupo, ws_grupo, 'lista-grupos', 'N', 'N');
					htp.p('</span>');
				htp.p('</li>');

			begin
				select zindex into ws_zindex from object_location where object_id = prm_object and screen = prm_screen;
			exception when others then
				ws_zindex := '5';
			end;

				htp.p('<li>');
					htp.p('<span class="before">'||fun.lang('Ordem do menu')||'</span>');
					htp.p('<span class="after">');
						htp.p('<select onchange="ajax(''pos'', ''salva_posicao'', ''prm_objeto='||prm_object||'&prm_screen=''+document.getElementById(''current_screen'').value+''&prm_posx=&prm_posy=&prm_zindex=''+this.value+''&prm_tipo=posicao'', ''true'');">');
							fcl.numericOptions(5, ws_zindex);
						htp.p('</select>');
					htp.p('</span>');
				htp.p('</li>');

			htp.p('<li>');
				htp.p('<span class="before">'||fun.lang('Descritivo')||'</span>');
				htp.p('<span class="after">');
					htp.p('<textarea onblur="update_prop('''||prm_object||''', ''descritivo'', this.value);">'||ws_obj.ds_objeto||'</textarea>');
				htp.p('</span>');
			htp.p('</li>');

		htp.formClose;
		htp.p('</ul>');

	htp.p('</div>');
	
	fcl.closer_menu;
exception
	when ws_nouser then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end ed_call;


procedure EDIT_SINAL ( ws_par_sumary 	varchar2 default null ) as

	cursor crs_sinal is
			select * from SINAIS
			where CD_SINAL = ws_par_sumary;

	ws_sinal	crs_sinal%rowtype;

	ws_par_saida	long;
	ws_funcao	char(1);
	ws_retorno	varchar2(30);
	ws_cont		number;

	ws_lista	DBMS_SQL.VARCHAR2_TABLE;

	ws_accesso	exception;

begin

	/*fcl.refresh_Session;*/
	open crs_sinal;
	fetch crs_sinal into ws_sinal;
	close crs_sinal;

	if  nvl(ws_sinal.cd_sinal,'%#%') <> ws_par_sumary or ws_par_sumary='NOVO' then
		ws_funcao := 'G';
	else
		ws_funcao := 'R';
	end if;

	htp.p( '<input type="hidden" name="xcaminho"     id="caminho"   value="'||fun.r_gif('path')||'">' );

	htp.formOpen( cattributes => 'name="pontoa" id="savemvi"', curl =>''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.savesign', cmethod => 'post', ctarget => '');

	htp.p('<h2>'||ws_par_sumary||'</h2>');

	htp.p('<table class="form">');

	htp.p('<input type="hidden" value="'||ws_funcao||'" class="p_funcao"/>');

	htp.tableRowOpen;
		htp.p('<td>'||fun.lang('Sinal')||':</td>');
		htp.p('<td><input type="text" style="background: #BBB;" class="p_cd_sinal" '||fpdata(ws_funcao,'R',' readonly="yes" ','')||' value="'||ws_sinal.cd_sinal||'" size="30" maxlength="20" /></td>');
	htp.tableRowClose;

	htp.tableRowOpen;
		htp.p('<td>'||fun.lang('Descri&ccedil;&atilde;o')||':</td>');
		htp.p('<td><input type="text" style="background: #BBB;" class="p_ds_sinal" value="'||ws_sinal.ds_sinal||'" size="50" maxlength="80" readonly/></td>');
	htp.tableRowClose;

	htp.tableRowOpen;
		htp.p('<td>'||fun.lang('Imagem')||':</td>');
		htp.p('<td>');
			htp.formSelectOpen( cname => 'p_tp_sinal', cattributes => 'class="p_tp_sinal" id="jnds_tipo" onchange=" document.getElementById(''sin1'').src='''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download?arquivo=ind''+this.options[this.selectedIndex].value+''_1.png''; document.getElementById(''sin2'').src='''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download?arquivo=ind''+this.options[this.selectedIndex].value+''_2.png''; document.getElementById(''sin3'').src='''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download?arquivo=ind''+this.options[this.selectedIndex].value+''_3.png''; document.getElementById(''sin4'').src='''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download?arquivo=ind''+this.options[this.selectedIndex].value+''_4.png''; document.getElementById(''sin5'').src='''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download?arquivo=ind''+this.options[this.selectedIndex].value+''_5.png''; " ');
			fcl.formSelectOption( '1', '1', '', fpdata(ws_sinal.tp_sinal,'1', 'SELECTED',''));
			fcl.formSelectOption( '2', '2', '', fpdata(ws_sinal.tp_sinal,'2', 'SELECTED',''));
			fcl.formSelectOption( '3', '3', '', fpdata(ws_sinal.tp_sinal,'3', 'SELECTED',''));
			fcl.formSelectOption( '4', '4', '', fpdata(ws_sinal.tp_sinal,'4', 'SELECTED',''));
			fcl.formSelectOption( '5', '5', '', fpdata(ws_sinal.tp_sinal,'5', 'SELECTED',''));
			fcl.formSelectOption( '6', '6', '', fpdata(ws_sinal.tp_sinal,'6', 'SELECTED',''));
			fcl.formSelectOption( '7', '7', '', fpdata(ws_sinal.tp_sinal,'7', 'SELECTED',''));
			fcl.formSelectOption( '8', '8', '', fpdata(ws_sinal.tp_sinal,'8', 'SELECTED',''));
			fcl.formSelectOption( '9', '9', '', fpdata(ws_sinal.tp_sinal,'9', 'SELECTED',''));
			htp.formSelectClose;
		htp.p('</td>');
	htp.tableRowClose;

	htp.tableRowOpen;
		htp.p('<td>'||htf.img(fun.r_gif('ind'||rtrim(ws_sinal.tp_sinal)||'_1', 'PNG' ), cattributes => 'id="sin1"')||fcl.htexto('Faixa 1:','2', cattributes => '')||'</td>');
		htp.p('<td><input type="text" class="p_fx_01" value="'||ws_sinal.fx_01||'" size="30" maxlength="80" ></td>');
	htp.tableRowClose;

	htp.tableRowOpen;
		htp.p('<td>'||htf.img(fun.r_gif('ind'||rtrim(ws_sinal.tp_sinal)||'_2', 'PNG' ), cattributes => 'id="sin2"')||fcl.htexto('Faixa 2:','2', cattributes => '')||'</td>');
		htp.p('<td><input type="text" class="p_fx_02" value="'||ws_sinal.fx_02||'" size="30" maxlength="80" ></td>');
	htp.tableRowClose;

	htp.tableRowOpen;
		htp.p('<td>'||htf.img(fun.r_gif('ind'||rtrim(ws_sinal.tp_sinal)||'_3', 'PNG' ), cattributes => 'id="sin3"')||fcl.htexto('Faixa 3:','2', cattributes => '')||'</td>');
		htp.p('<td><input type="text" class="p_fx_03" value="'||ws_sinal.fx_03||'" size="30" maxlength="80" ></td>');
	htp.tableRowClose;

	htp.tableRowOpen;
		htp.p('<td>'||htf.img(fun.r_gif('ind'||rtrim(ws_sinal.tp_sinal)||'_4', 'PNG' ), cattributes => 'id="sin4"')||fcl.htexto('Faixa 4:','2', cattributes => '')||'</td>');
		htp.p('<td><input type="text" class="p_fx_04" value="'||ws_sinal.fx_04||'" size="30" maxlength="80" ></td>');
	htp.tableRowClose;

	htp.tableRowOpen;
		htp.p('<td>'||htf.img(fun.r_gif('ind'||rtrim(ws_sinal.tp_sinal)||'_5', 'PNG' ), cattributes => 'id="sin5"')||fcl.htexto('Faixa 5:','2', cattributes => '')||'</td>');
		htp.p('<td><input type="text" class="p_fx_05" value="'||ws_sinal.fx_05||'" size="30" maxlength="80" ></td>');
	htp.tableRowClose;

	htp.formClose;
	htp.tableClose;

	htp.p('<div class="listar"><a onclick=" carrega(''list_sinal''); call_save(''''); ">'||fun.lang('Listar sinais')||'</a></div>');

end EDIT_SINAL;


/* Edita Screen */

--!!
procedure screen_prop ( ws_par_sumary varchar2 ) as

	cursor crs_all_screens is
	select * from ALL_SCREENS where screen = ws_par_sumary and owner = 'DWU';

	ws_scr crs_all_screens%rowtype;

	ws_micro_visao 		varchar2(80);
	ws_ronly 			varchar2(80);
	ws_par_saida 		long;
	ws_funcao 			char(1);
	ws_grupof 			varchar2(40);
	ws_valor 			varchar2(80);
	ws_count 			number;
	ws_hidden 			varchar2(200);
	ws_repeat 			varchar2(200);
	ws_manutencao  		varchar2(4);
	ws_atualizando 		varchar2(4);
	ws_pos    			varchar2(200);
	ws_size   			varchar2(200);
	ws_lista  			clob;
	ws_padrao 			varchar2(80) := 'PORTUGUESE';
	ws_desc   			varchar2(2000);
	ws_usuario 			varchar2(80);
	ws_view    			varchar2(80);
	ws_opacidade 		varchar2(80);
	ws_url_token		varchar2(500);
	ws_complemento_url	varchar2(500);
	ws_token   			varchar2(1000);
	ws_nouser  			exception;

	ws_cd_prop			DBMS_SQL.VARCHAR2_TABLE;
	ws_prop				DBMS_SQL.VARCHAR2_TABLE;
	ws_rotulo			DBMS_SQL.VARCHAR2_TABLE;
	ws_tipo				DBMS_SQL.VARCHAR2_TABLE;
	ws_sufixo			DBMS_SQL.VARCHAR2_TABLE;
	ws_script			DBMS_SQL.VARCHAR2_TABLE;
	ws_list				DBMS_SQL.VARCHAR2_TABLE;
	ws_grupo            DBMS_SQL.VARCHAR2_TABLE;
	ws_hint			    DBMS_SQL.VARCHAR2_TABLE;
	ws_ordem            DBMS_SQL.NUMBER_TABLE;
begin
	
	ws_usuario := gbl.getUsuario;

	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if;

	begin
		select CONTEUDO into ws_padrao
		from   PARAMETRO_USUARIO
		where  cd_usuario = ws_usuario and
			cd_padrao='CD_LINGUAGEM';
	exception
		when others then
			ws_padrao := 'PORTUGUESE';
	end;

	if ws_par_sumary <> 'DEFAULT' then
		open crs_all_screens;
		fetch crs_all_screens into ws_scr;
		close crs_all_screens;
		select cd_grupo, ds_objeto into ws_grupof, ws_desc from objetos
		where cd_objeto=ws_par_sumary and tp_objeto='SCREEN';
	else
		ws_scr.screen := 'DEFAULT';
	end if;

	ws_funcao := 'R';

	select count(*) into ws_count from object_location where screen = ws_par_sumary;

	htp.p('<div class="itens" style="width: 346px;">');

	htp.p('<h2>'||fun.lang('PROPRIEDADES'));
    	htp.p('<a title="Duplicar tela" onclick="clone_screen('''||ws_par_sumary||''');">'|| 
	         '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="24" viewBox="0 0 24 20"><path d="M13.508 11.504l.93-2.494 2.998 6.268-6.31 2.779.894-2.478s-8.271-4.205-7.924-11.58c2.716 5.939 9.412 7.505 9.412 7.505zm7.492-9.504v-2h-21v21h2v-19h19zm-14.633 2c.441.757.958 1.422 1.521 2h14.112v16h-16v-8.548c-.713-.752-1.4-1.615-2-2.576v13.124h20v-20h-17.633z"/></svg>'); 
		htp.p('</a>');
	htp.p('</h2>');	

	htp.p('<input type="hidden" class="p_funcao" value="'||ws_funcao||'"/>');

	htp.p('<ul class="form">');

		htp.p('<li class="readonly">');
			htp.p('<span class="before">ID</span>');
			htp.p('<span class="after">');
				if ws_count = 0 and ws_par_sumary <> 'DEFAULT' then
					fcl.button_lixo('dl_object','prm_object', ws_par_sumary);
				end if;
				htp.p('<input type="text" class="p_screen" readonly="true" value="'||ws_scr.screen||'" class="up" size="30" maxlength="20" >');
				htp.p('<input type="hidden" class="act_screen" id="actual_screen" value="" >' );
			htp.p('</span>');
			
		htp.p('</li>');

		if ws_par_sumary = 'DEFAULT' then
			ws_hidden := 'display: none;';
		end if;

		htp.p('<li style="'||ws_hidden||'">');
			htp.p('<span class="before">'||fun.lang('Nome')||'</span>');
			htp.p('<span class="after">');
				if ws_par_sumary = 'DEFAULT' then
					htp.p('<input type="text" onblur="update_prop('''||ws_par_sumary||''', ''nome_tela'', this.value);" title="'||ws_scr.descricao||'" value="DEFAULT"/>');
				else
					htp.p('<input type="text" onblur="update_prop('''||ws_par_sumary||''', ''nome_tela'', this.value);" title="'||ws_scr.descricao||'" value="'||fun.utranslate('NM_OBJETO', ws_par_sumary, ws_scr.descricao, ws_padrao)||'" size="50" maxlength="80" />');
				end if;
			htp.p('</span>');
			
			if ws_par_sumary = 'DEFAULT' then
				htp.p('<a class="fakelang">L</a>');
			else
				htp.p('<a class="fakelang mini" onclick="fakeLang(''screen_nome'', '''||ws_par_sumary||'|NM_OBJETO|''+this.previousElementSibling.title);">L</a>');
			end if;
			
		htp.p('</li>');

		select count(*) into ws_count from objetos where cd_objeto = trim(ws_par_sumary);
		if ws_count = 1 then
			select cd_grupo into ws_grupof from objetos where cd_objeto = trim(ws_par_sumary);
		else
			ws_grupof := '';
		end if;

		htp.p('<li style="'||ws_hidden||'">');
			if ws_par_sumary <> 'DEFAULT' then
				htp.p('<span class="before">'||fun.lang('Categoria')||'</span>');
				htp.p('<span class="after">');
					htp.p('<a class="script" onclick="update_prop('''||ws_par_sumary||''', ''grupo'', this.nextElementSibling.title);"></a>');
					fcl.fakeoption('fake-grupo', fun.lang('Escolha uma categoria'), ws_grupof, 'lista-grupos', 'N', 'N', '');
				htp.p('</span>');
			end if;
		htp.p('</li>');

		/********************* Desativado em 04/10/2022  
		htp.p('<li style="display: none;">');
			htp.p('<span class="before">'||fun.lang('View')||'</span>');
			htp.p('<span class="after">');
				htp.p('<select class="p_publico">');
					fcl.formSelectOption(fun.lang('Publica'),'S', fpdata(ws_scr.publico,'S','SELECTED',''));
					fcl.formSelectOption(fun.lang('Privada'),'N', fpdata(ws_scr.publico,'N','SELECTED',''));
				htp.formSelectClose;
			htp.p('</span>');
		htp.p('</li>');
		***************************************/ 

		if ws_par_sumary <> 'DEFAULT' then

			--ws_view := fun.getprop(ws_par_sumary,'VIEW');
			select max(cd_micro_visao) into ws_view  
			from ponto_avaliacao
			where upper(cd_ponto) = upper(ws_par_sumary);

			htp.p('<li style="'||ws_hidden||'">');
				htp.p('<span class="before">'||fun.lang('Micro vis&atilde;o')||'</span>');
				htp.p('<span class="after">');
					-- htp.p('<input type="text" onblur="update_prop('''||ws_par_sumary||''', ''view'', this.value);" value="'||ws_view||'" size="80" maxlength="80" />');
					htp.p('<a class="script" onclick="update_prop('''||ws_par_sumary||''', ''view'', this.nextElementSibling.title);"></a>');
					fcl.fakeoption('micro-visao', fun.lang('Escolha uma view'), ws_view, 'lista-views', 'N', 'N', '');						
				htp.p('</span>');
			htp.p('</li>');

			/*	Remoção do campo ATUALIZANDO DADOS 22/12/2022
				ws_atualizando := fun.getprop(ws_par_sumary,'ATUALIZANDO');
				
				htp.p('<li>');
					htp.p('<span class="before">ATUALIZANDO DADOS</span>');
					htp.p('<span class="after">');
						htp.p('<a class="script" onclick="update_prop('''||ws_par_sumary||''', ''atualizando'', this.nextElementSibling.title);"></a>');
						if ws_atualizando = 'S' then
							htp.p('<span class="checkbox checked" data-positive="S" data-negative="N" title="'||ws_atualizando||'"></span>');
						else
							htp.p('<span class="checkbox" data-positive="S" data-negative="N" title="'||ws_atualizando||'"></span>');
						end if;
					htp.p('</span>');
				htp.p('</li>');
			*/
		end if;

		htp.p('<li>');
			htp.p('<span class="before">'||fun.lang('Descritivo')||'</span>');
			htp.p('<span class="after">');
				htp.p('<textarea maxlength="1000" onblur="update_prop('''||ws_par_sumary||''', ''descritivo_tela'', this.value);">'||ws_scr.ds_screen||'</textarea>');
			htp.p('</span>');
		htp.p('</li>');

		if ws_par_sumary = 'DEFAULT' then
			begin
				select nvl(cor_fundo, '#FFFFFF'), nvl(url_fundo, fun.r_gif('bg','PNG')) into ws_scr.cor_fundo, ws_scr.url_fundo from all_screens where screen = 'DEFAULT' and rownum = 1;
				--if instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'Safari/') <> 0 and instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'Chrome/') = 0 then
				--	select nvl(cor_fundo, '#FFFFFF'), nvl(url_fundo, fun.r_gif('bg','JPG')) into ws_scr.cor_fundo, ws_scr.url_fundo from all_screens where screen = 'DEFAULT' and rownum = 1;
				--else
				--	select nvl(cor_fundo, '#FFFFFF'), nvl(url_fundo, fun.r_gif('bg','PNG')) into ws_scr.cor_fundo, ws_scr.url_fundo from all_screens where screen = 'DEFAULT' and rownum = 1;
				--end if;
			exception when others then
				ws_scr.cor_fundo := '#FFFFFF';
				ws_scr.url_fundo := fun.r_gif('bg','PNG');
				--if instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'Safari/') <> 0 and instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'Chrome/') = 0 then
				--	ws_scr.url_fundo := fun.r_gif('bg','JPG');
				--else
				--	ws_scr.url_fundo := fun.r_gif('bg','PNG');
				--end if;
			end;
		end if;


		htp.p('<li>');
			htp.p('<span class="before">'||fun.lang('Cor Fundo')||'</span>');
			htp.p('<span class="after">');
				--htp.p('<a class="script" onclick="update_prop('''||ws_par_sumary||''', ''cor_tela'', this.nextElementSibling.title);"></a>');
				--fcl.fakeoption('fake-cores-custom', fun.lang('Escolha uma cor'), ws_scr.cor_fundo, 'lista-cores-custom', 'N', 'S', prm_visao => ws_par_sumary);
				htp.p('<input type="text" value="'||ws_scr.cor_fundo||'" onchange="update_prop('''||ws_par_sumary||''', ''cor_tela'', this.value); this.nextElementSibling.value = this.value;" oninput="document.getElementById(''main'').style.setProperty(''background-color'', this.value);" />');
				--htp.p('<input list="data-list" type="text" style="width: 70px;" onchange="update_prop('''||ws_par_sumary||''', ''cor_tela'', this.value); this.previousElementSibling.value = this.value;" oninput="document.getElementById(''main'').style.setProperty(''background-color'', this.value);" value="'||nvl(ws_scr.cor_fundo, 'transparent')||'"/>');
				htp.p('<datalist id="data-list">');
					htp.p('<option value="transparent">transparent</option>');
				htp.p('</datalist>');
			htp.p('</span>');
		htp.p('</li>');

		

		htp.p('<li>');
			htp.p('<span class="before">PLANO DE FUNDO</span>');
			htp.p('<span class="after">');
				htp.p('<a class="script" onclick="var tipo = ''''; var url = this.nextElementSibling.title; if(url.toUpperCase().indexOf(''EXT='') == -1){ tipo = '''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download?arquivo=''; } update_prop('''||ws_par_sumary||''', ''url_tela'', tipo+url);"></a>');
				fcl.fakeoption('fake_img', 'Imagem', replace(ws_scr.url_fundo, ''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download?arquivo=', ''), 'lista-arquivo-imagem', 'S', 'N');
				/*htp.p('<input type="text" value="'||ws_scr.url_fundo||'" onchange="update_prop('''||ws_par_sumary||''', ''url_tela'', this.value);" size="50" maxlength="200" />');*/
			htp.p('</span>');
		htp.p('</li>');

		ws_opacidade := fun.getprop(ws_par_sumary,'OPACIDADE');
		
		htp.p('<li>');
			htp.p('<span class="before">Transparencia</span>');
			htp.p('<span class="after">');
					htp.p('<input type="number" max="100" step="1" onblur="update_prop('''||ws_par_sumary||''', ''opacidade'', this.value);" oninput="this.value = VMasker.toPattern(this.value, ''999'');" value="'||ws_opacidade||'" />');
			htp.p('</span>');
		htp.p('</li>');

		ws_pos := fun.getprop(ws_par_sumary,'IMG_POS');

		htp.p('<li>');
			htp.p('<span class="before" title="Alinhamento da imagem ex:top ex2:top 200px left 150px ex3:bottom 15vw right 25vw">'||fun.lang('Alinhamento')||'</span>');
			htp.p('<span class="after">');
				htp.p('<input type="text" onblur="update_prop('''||ws_par_sumary||''', ''alinhamento_tela'', this.value);" value="'||ws_pos||'" size="50" maxlength="200" />');
			htp.p('</span>');
		htp.p('</li>');

		ws_size := fun.getprop(ws_par_sumary,'IMG_SIZE');

		htp.p('<li>');
			htp.p('<span class="before" title="Tamanho da imagem ex:200px  ex2:15vw">'||fun.lang('Tamanho')||'</span>');
			htp.p('<span class="after">');
				htp.p('<input type="text" onblur="update_prop('''||ws_par_sumary||''', ''tamanho_tela'', this.value);" value="'||ws_size||'" size="50" maxlength="200" />');
			htp.p('</span>');
		htp.p('</li>');

		ws_repeat := fun.getprop(ws_par_sumary,'REPEAT');

		htp.p('<li>');
			htp.p('<span class="before">'||fun.lang('Repetir')||'</span>');
			htp.p('<span class="after">');
				htp.p('<a class="script" onclick="update_prop('''||ws_par_sumary||''', ''repetir_tela'', this.nextElementSibling.title);"></a>');
				if ws_repeat = 'repeat' then
					htp.p('<span class="checkbox checked" data-positive="repeat" data-negative="no-repeat" title="'||ws_repeat||'"></span>');
				else
					htp.p('<span class="checkbox" data-positive="repeat" data-negative="no-repeat" title="'||ws_repeat||'"></span>');
				end if;
			htp.p('</span>');
		htp.p('</li>');

		
		/*if ws_par_sumary <>'DEFAULT' then
			htp.p('<li style="'||ws_hidden||'">');
				htp.p('<span class="before">'||fun.lang('Ordem Grupo')||'</span>');
				htp.p('<span class="after">');
					htp.p('<input type="text" onblur="update_prop('''||ws_par_sumary||''', ''ordem_tela'', this.value);" value="'||ws_scr.or_grupo||'" size="10" maxlength="10" />');
				htp.p('</span>');
			htp.p('</li>');
		end if;*/

		if ws_par_sumary <> 'DEFAULT' then
			htp.p('<li style="'||ws_hidden||'">');
				htp.p('<span class="before" title="Ordenagem das telas no menu">'||fun.lang('Ordem')||'</span>');
				htp.p('<span class="after">');
					htp.p('<input type="text" onblur="update_prop('''||ws_par_sumary||''', ''item_tela'', this.value);" value="'||ws_scr.or_item||'" size="10" maxlength="10" />');
				htp.p('</span>');
			htp.p('</li>');
		end if;

		htp.p('<li>');
			htp.p('<span class="before">'||fun.lang('Dispositivo')||'</span>');
			htp.p('<span class="after">');
				htp.p('<select onchange="update_prop('''||ws_par_sumary||''', ''dispositivo_tela'', this.value);">');
					htp.p('<option value="">'||fun.lang('QUALQUER UM')||'</option>');
					if ws_scr.dispositivo = 'mobile' then
						htp.p('<option value="desktop">DESKTOP</option>');
						htp.p('<option value="mobile" selected>MOBILE</option>');
						htp.p('<option value="nenhum">NENHUM</option>');
					elsif ws_scr.dispositivo = 'desktop' then
						htp.p('<option value="desktop" selected>DESKTOP</option>');
						htp.p('<option value="mobile">MOBILE</option>');
						htp.p('<option value="nenhum">NENHUM</option>');
					elsif ws_scr.dispositivo = 'nenhum' then
						htp.p('<option value="desktop">DESKTOP</option>');
						htp.p('<option value="mobile">MOBILE</option>');
						htp.p('<option value="nenhum" selected>NENHUM</option>');
					else
						htp.p('<option value="desktop">DESKTOP</option>');
						htp.p('<option value="mobile">MOBILE</option>');
						htp.p('<option value="nenhum">NENHUM</option>');
					end if;
				htp.p('</select>');
			htp.p('</span>');
		htp.p('</li>');

		htp.p('<li style="'||ws_hidden||'">');
			htp.p('<span class="before">'||fun.lang('Alinhamento do dashboard')||'</span>');
			htp.p('<span class="after">');
				htp.p('<select onchange="update_prop('''||ws_par_sumary||''', ''flex_tela'', this.value);">');

					fcl.formSelectOption(fun.lang('Linhas'),'column', fpdata(ws_scr.flex_flow,'column','SELECTED',''));
					fcl.formSelectOption(fun.lang('Colunas'),'row', fpdata(ws_scr.flex_flow,'row','SELECTED',''));

				htp.formSelectClose;
			htp.p('</span>');
		htp.p('</li>');

		htp.p('<li style="'||ws_hidden||'">');

			htp.p('<span class="before">Time Refresh</span>');

			htp.p('<span class="after">');

				htp.p('<select onchange="update_prop('''||ws_par_sumary||''', ''timer_tela'', this.value);">');
					
					if ws_scr.timer = '0' then
						htp.p('<option value="0" selected="selected">'||fun.lang('nunca')||'</option>');
					else
						htp.p('<option value="0">'||fun.lang('nunca')||'</option>');
					end if;
					
					if ws_scr.timer = '60000' then
						htp.p('<option value= "60000" selected="selected">1m</option>');
					else
						htp.p('<option value="60000">1m</option>');
					end if;

					if ws_scr.timer = '120000' then
						htp.p('<option value= "120000" selected="selected">2m</option>');
					else
						htp.p('<option value="120000">2m</option>');
					end if;

					if ws_scr.timer = '180000' then
						htp.p('<option value= "180000" selected="selected">3m</option>');
					else
						htp.p('<option value="180000">3m</option>');
					end if;

					if ws_scr.timer = '240000' then
						htp.p('<option value= "240000" selected="selected">4m</option>');
					else
						htp.p('<option value="240000">4m</option>');
					end if;

					if ws_scr.timer = '300000' then
						htp.p('<option value= "3000000" selected="selected">5m</option>');
					else
						htp.p('<option value="300000">5m</option>');
					end if;

					if ws_scr.timer = '600000' then
						htp.p('<option value="600000" selected="selected">10m</option>');
					else
						htp.p('<option value="600000">10m</option>');
					end if;
					
					if ws_scr.timer = '900000' then
						htp.p('<option value="900000" selected="selected">15m</option>');
					else
						htp.p('<option value="900000">15m</option>');
					end if;

					if ws_scr.timer = '1200000' then
						htp.p('<option value="1200000" selected="selected">20m</option>');
					else
						htp.p('<option value="1200000">20m</option>');
					end if;

					if ws_scr.timer = '1500000' then
						htp.p('<option value="1500000" selected="selected">25m</option>');
					else
						htp.p('<option value="1500000">25m</option>');
					end if;

					if ws_scr.timer = '1800000' then
						htp.p('<option value="1800000" selected="selected">30m</option>');
					else
						htp.p('<option value="1800000">30m</option>');
					end if;

					if ws_scr.timer = '3600000' then
						htp.p('<option value="3600000" selected="selected">1h</option>');
					else
						htp.p('<option value="3600000">1h</option>');
					end if;

					if ws_scr.timer = '5400000' then
						htp.p('<option value="5400000" selected="selected">1h30m</option>');
					else
						htp.p('<option value="5400000">1h30m</option>');
					end if;					

					if ws_scr.timer = '7200000' then
						htp.p('<option value="7200000" selected="selected">2h</option>');
					else
						htp.p('<option value="7200000">2h</option>');
					end if;

				htp.p('</select>');

			htp.p('</span>');

		htp.p('</li>');

		htp.p('<li>');

			htp.p('<span class="before">'||fun.lang('Observa&ccedil;&atilde;o')||'</span>');
			htp.p('<span class="after">');

				htp.p('<textarea onblur="update_prop('''||ws_par_sumary||''', ''descritivo'', this.value);">'||ws_desc||'</textarea>');
				
			htp.p('</span>');

		htp.p('</li>');

		/**ws_count := 1;

		fcl.arrgetprop( trim(ws_par_sumary), ws_cd_prop, ws_prop, ws_rotulo, ws_tipo, ws_sufixo, ws_script, ws_list, ws_grupo, ws_hint, ws_ordem);

		loop
			htp.p('<li>');
				htp.p('<span class="before">'||ws_rotulo(ws_count)||'</span>');
				htp.p('<span class="after">');
					fcl.inputp( ws_tipo(ws_count), ws_count, ws_prop(ws_count), trim(ws_par_sumary), ws_sufixo(ws_count), ws_cd_prop(ws_count), ws_script(ws_count), ws_list(ws_count));
				htp.p('</span>');
			htp.p('</li>');
			ws_count := ws_count +1;
		end loop;*/
	
	if ws_par_sumary <> 'DEFAULT' then
		begin
			/*SELECT LISTAGG(usuario, '|') WITHIN GROUP (ORDER BY screen) into ws_lista
			FROM user_screens where screen = ws_par_sumary
			GROUP BY screen;*/

			htp.p('<li>');
				htp.p('<span class="before">'||fun.lang('PERMISS&Atilde;O')||'</span>');
				htp.p('<span class="after">');
					--htp.p('<a class="script" onclick="update_prop('''||ws_par_sumary||''', ''usuarios-tela'', this.nextElementSibling.title);"></a>');
					-- fcl.fakeoption('fake-usuarios', 'Permiss&otilde;es', '', 'lista-usuarios-grupos', 'N', 'S', '', fun.lang('PERMISS&Atilde;O DE USU&Aacute;RIOS'), ws_par_sumary);
					fcl.fakeoption('fake-usuarios', 'Permiss&otilde;es', '', 'lista-usuarios-grupos', 'N', 'S', '', '', ws_par_sumary);
				htp.p('</span>');
			htp.p('</li>');
		exception when others then
			htp.p('');
		end;

	end if;

			ws_manutencao := fun.getprop(ws_par_sumary,'MANUTENCAO');
			
			htp.p('<li>');
				htp.p('<span class="before">'||fun.lang('MANUTEN&Ccedil;&Atilde;O')||'</span>');
				htp.p('<span class="after">');
					htp.p('<a class="script" onclick="update_prop('''||ws_par_sumary||''', ''manutencao'', this.nextElementSibling.title);"></a>');
					if ws_manutencao = 'S' then
						htp.p('<span class="checkbox checked" data-positive="S" data-negative="N" title="'||ws_manutencao||'"></span>');
					else
						htp.p('<span class="checkbox" data-positive="S" data-negative="N" title="'||ws_manutencao||'"></span>');
					end if;
				htp.p('</span>');
			htp.p('</li>');
			
		if ws_par_sumary <> 'DEFAULT' then
		
			htp.p('<li>');
				htp.p('<span class="before">'||fun.lang('TOKEN')||'</span>');
				htp.p('<span class="after">');
						--htp.p('<a class="script" onclick="update_prop('''||ws_par_sumary||''', ''usuarios-tela'', this.nextElementSibling.title);"></a>');
					htp.p('<a onclick="call(''getToken'', ''prm_usuario='||ws_usuario||'&prm_screen='||ws_par_sumary||''', ''gbl'').then(function(res){ if(res != ''0''){ get(''screen-token'').value = res; alerta(''feed-fixo'', ''Token alterado!''); } });"><svg style="height: 18px;" version="1.1"  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 612 612" style="enable-background:new 0 0 612 612;" xml:space="preserve"> <g> <g> <path d="M175.446,330.878l58.523-58.523c15.499-15.5,15.499-40.63,0-56.13c-15.502-15.499-40.628-15.499-56.13,0l-15.357,15.356 v-80.829c0-3.216,2.622-5.833,5.845-5.833h275.366c3.211,0,5.826,2.617,5.826,5.833v45.581c0,21.919,17.768,39.688,39.688,39.688 c21.919,0,39.688-17.768,39.688-39.688v-45.581c0-46.984-38.219-85.207-85.201-85.207H168.327 c-46.99,0-85.218,38.223-85.218,85.207v80.829l-15.356-15.356c-15.502-15.499-40.628-15.499-56.13,0 c-15.499,15.5-15.499,40.63,0,56.13l58.523,58.523c14.064,14.063,32.762,21.807,52.651,21.807 C142.688,352.685,161.387,344.939,175.446,330.878z"/> <path d="M600.376,339.641l-58.523-58.523c-14.064-14.063-32.762-21.807-52.652-21.807c-19.889,0-38.586,7.746-52.645,21.808 l-58.52,58.523c-15.499,15.502-15.499,40.63,0,56.128c7.751,7.749,17.907,11.625,28.065,11.623 c10.154,0,20.317-3.875,28.065-11.625l15.356-15.357v80.833c0,3.218-2.622,5.837-5.843,5.837H168.31 c-3.211,0-5.828-2.619-5.828-5.837v-45.581c0-21.919-17.766-39.688-39.686-39.688s-39.688,17.768-39.688,39.688v45.581 c0,46.986,38.219,85.211,85.2,85.211h275.366c46.99,0,85.218-38.225,85.218-85.211v-80.826l15.352,15.352 c15.502,15.499,40.628,15.499,56.13,0C615.875,380.271,615.875,355.143,600.376,339.641z"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg></a>');
					htp.p('<textarea id="screen-token" readonly class="readonly" style="width: 170px;"/>');
						ws_complemento_url:='/'||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.show_screen?prm_screen='||ws_par_sumary||'&prm_clear=INFO&prm_token=';
						ws_url_token:= fun.ret_var('URL_CLIENTE');
						ws_token:=null;
						
						for i in (select code as token from bi_token where tela = ws_par_sumary and status = 'D' order by dt_envio desc) loop
							if ws_token is null then
								if ws_url_token is not null then

									ws_token:= ws_url_token||ws_complemento_url||i.token;
								else
									ws_token:=i.token;
								end if;
							else
								if ws_url_token is not null then
									ws_token:= ws_token||chr(13)||chr(13)||ws_url_token||ws_complemento_url||i.token;
								else
									ws_token:= ws_token||chr(13)||chr(13)||i.token;	
								end if;
							end if;

						end loop;
					
						htp.p(nvl(ws_token,''));

					--htp.p('<input type="text" id="screen-token" readonly class="readonly" value="'||ws_token||'" style="width: 170px;"/>');
				htp.p('</textarea>');
			htp.p('</li>');
		
		
		end if;

	htp.p('</ul>');

	htp.p('</div>');

	fcl.closer_menu;

exception 
	when ws_nouser then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
end screen_prop;

--!!
procedure savescr ( p_screen         varchar2 default null,
					p_descricao		 varchar2 default null,
					p_publico		 varchar2 default null,
					p_ds_screen		 varchar2 default null,
					p_funcao		 varchar2 default null,
					p_grupof		 varchar2 default null,
					p_cor_fundo		 varchar2 default null,
					p_url_fundo		 varchar2 default null,
					p_or_grupo		 varchar2 default null,
					p_or_item		 varchar2 default 0,
					p_dispositivo    varchar2 default null,
					act_screen		 varchar2 default null,
					p_timer          number,
					p_flex		     varchar2 default null ) as

	ws_count      number;
	ws_texto      varchar2(200);
	ws_padrao     varchar2(40);
	ws_desc       varchar2(1000);
	ws_descritivo varchar2(1000);
	ws_usuario    varchar2(80);
	
	ws_nouser     exception;

begin
	fcl.refresh_Session;

	ws_usuario    := gbl.getUsuario;

	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if;

	ws_desc       := fun.converte(p_descricao);
	ws_descritivo := fun.converte(p_ds_screen);

	select count(*) into ws_count from PARAMETRO_USUARIO where cd_usuario = ws_usuario and cd_padrao='CD_LINGUAGEM';

	if ws_count = 1 then
		select CONTEUDO into ws_padrao
		from   PARAMETRO_USUARIO
		where  cd_usuario = ws_usuario and
		cd_padrao='CD_LINGUAGEM';
	else
		ws_padrao := 'PORTUGUESE';
	end if;

	if  act_screen = 'DEFAULT' then
		insert into object_location
		select 'DWU', 'DEFAULT',upper(replace(trim(p_screen),' ','_')), OBJECT_ID, POSX, POSY, 'auto', '0'
		from	OBJECT_LOCATION
		where	SCREEN = 'DEFAULT' and
		NAVEGADOR = 'DEFAULT' and
		object_id not in ('toolbar','newquery');
	end if;

	if  p_funcao = 'G' then
		select count(*) into ws_count from ALL_SCREENS where screen = UPPER(TRIM(p_screen));
		if ws_count = 0 then
			insert into ALL_SCREENS
				( owner, screen, descricao, ds_screen, dt_criacao, dt_ultima_alteracao, publico, cor_fundo, url_fundo, or_grupo, or_item, timer )
			values
				( 'DWU', upper(replace(trim(p_screen),' ','_')), ws_desc, p_ds_screen, sysdate, sysdate, p_publico, p_cor_fundo, p_url_fundo, p_or_grupo, p_or_item, (p_timer*1000) );
			insert into OBJETOS (cd_objeto, cd_grupo, nm_objeto, subtitulo, tp_objeto, cd_usuario, atributos, dt_ultima, ds_objeto)
				values ( upper(replace(trim(p_screen),' ','_')), p_grupof, ws_desc, '', 'SCREEN', gbl.getUsuario, '', sysdate, p_ds_screen );
			insert into user_screens values('DWU', upper(replace(trim(p_screen),' ','_')), 'A');
			commit;
		else
			htp.p('#alert '||fun.lang('J&aacute; existe uma tela com este nome')||'!');
		end if;
	else

		select count(*) into ws_count from traducao_colunas
		where cd_tabela = p_screen and
		cd_coluna = 'NM_OBJETO';

		if ws_count = 1 then
			update traducao_colunas
			set texto = ws_desc
			where cd_tabela = p_screen and
			cd_coluna = 'NM_OBJETO' and
			cd_linguagem = ws_padrao and
			lang_default = (select descricao from all_screens where screen = upper(replace(trim(p_screen),' ','_')));

			if ws_padrao = fun.ret_var('LANG_SYS') then
				update traducao_colunas
				set lang_default = ws_desc
				where cd_tabela = p_screen and
				cd_coluna = 'NM_OBJETO' and
				lang_default = (select descricao from all_screens where screen = upper(replace(trim(p_screen),' ','_')));
			end if;
		elsif ws_count = 0 then
			if ws_padrao = fun.ret_var('LANG_SYS') then
				insert into traducao_colunas values (p_screen, 'NM_OBJETO', ws_padrao, ws_desc, ws_desc, 'O', 'N');
			end if;
		else
			htp.p('N');
		end if;

		update ALL_SCREENS set
			descricao 		= ws_desc,
			publico   		= p_publico,
			ds_screen 		= p_ds_screen,
			cor_fundo		= p_cor_fundo,
			url_fundo		= p_url_fundo,
			or_grupo		= p_or_grupo,
			or_item			= p_or_item,
			dt_ultima_alteracao	= sysdate,
			timer           = p_timer,
			dispositivo     = p_dispositivo,
			flex_flow       = p_flex
		where owner = 'DWU' and
			screen = p_screen;
		update OBJETOS set
			cd_grupo		= p_grupof,
			nm_objeto 		= ws_desc,
			ds_objeto 		= p_ds_screen,
			dt_ultima		= sysdate
		where cd_objeto  = p_screen and
			tp_objeto  = 'SCREEN';
		commit;
	end if;

exception 
	when ws_nouser then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end savescr;

/* Salva Ponto */

procedure savepa ( p_vl_salvo       varchar2 default null,
				p_cd_micro_visao	varchar2 default null,
				p_parametros		varchar2 default null,
				p_cd_ponto		varchar2 default null,
				p_nm_ponto		varchar2 default null,
				p_sub_ponto		varchar2 default null,
				p_ar_diario		varchar2 default null,
				p_ar_mensal		varchar2 default null,
				p_ar_anual		varchar2 default null,
				p_filtros		varchar2 default null,
				p_cd_visao		varchar2 default null,
				p_tp_renovacao	varchar2 default null,
				p_ds_ponto		varchar2 default null,
				p_tipo		    varchar2 default null,
				p_funcao		    varchar2 default null,
				fakeoption		varchar2 default null,
				pcs_parametros	varchar2 default '1|1',
				pcs_coluna	 	varchar2 default null,
				pcs_agrupador	varchar2 default null,
				pcs_rp		    varchar2 default 'ROLL',
				pcs_colup	 	varchar2 default null ) as

	prm_ponto  varchar2(20);
	prm_nponto number;
	ws_counter number;
	ws_texto   varchar2(200);
	ws_count   number;
	ws_nome    varchar2(200);

	cursor crs_filtros is
	select CD_COLUNA, CONDICAO, CONTEUDO, LIGACAO
	from filtros
	where MICRO_VISAO = p_cd_micro_visao and CD_OBJETO = (select CD_OBJETO from Filtros where MICRO_VISAO = p_cd_micro_visao and ROWNUM = 1 and tp_filtro = 'objeto')  and tp_filtro = 'objeto';

	ws_filtro crs_filtros%rowtype;

	ws_padrao  varchar2(40);
	ws_ponto   varchar2(800);
	ws_sub     varchar2(800);
	ws_desc    varchar2(800);
	ws_usuario varchar2(80);

	ws_nouser  exception;

begin

	ws_usuario := gbl.getUsuario;

	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if;
	
	ws_ponto   := fun.converte(p_nm_ponto);
	ws_sub     := fun.converte(p_sub_ponto);
	ws_desc    := fun.converte(p_ds_ponto);
	ws_nome    := fun.converte(ws_ponto);

	select count(*) into ws_count from PARAMETRO_USUARIO where cd_usuario = ws_usuario and cd_padrao='CD_LINGUAGEM';

	if ws_count = 1 then
		select CONTEUDO into ws_padrao
		from   PARAMETRO_USUARIO
		where  cd_usuario = ws_usuario and
		cd_padrao='CD_LINGUAGEM';
	else
		ws_padrao := 'PORTUGUESE';
	end if;

	if  p_funcao = 'G' then

		select count(*) into ws_counter from PONTO_AVALIACAO where cd_ponto = upper(replace(p_cd_ponto,' ','_'));
		
		if ws_counter = 0 then
			if  p_tipo not in ('ICONE','CALL_LIST','FILE','IMAGE','TEXTO') then
			insert into PONTO_AVALIACAO
				( vl_salvo, cd_micro_visao, parametros, cd_ponto, nm_ponto, ar_diario, ar_mensal, ar_anual, cd_visao, tp_renovacao, ds_ponto, cd_usuario, dt_ultima, dt_criacao, st_filtros, cs_parametros, cs_coluna, cs_agrupador, cs_rp, cs_colup )
			values
				( trim(p_vl_salvo), trim(p_cd_micro_visao), trim(p_parametros), upper(replace(p_cd_ponto,' ','_')), ws_ponto, fcl.fpdata(p_ar_diario,'on','S','N'), fcl.fpdata(p_ar_mensal,'on','S','N'), fcl.fpdata(p_ar_anual,'on','S','N'), trim(p_cd_visao), trim(p_tp_renovacao), trim(p_ds_ponto), 'DWU', sysdate, sysdate, 'A', pcs_parametros, pcs_coluna, pcs_agrupador, pcs_rp, pcs_colup );
			end if;
			insert into OBJETOS (cd_objeto, cd_grupo, nm_objeto, subtitulo, tp_objeto, cd_usuario, atributos, dt_ultima, ds_objeto) values ( upper(replace(trim(p_cd_ponto),' ','_')), fakeoption, ws_ponto, p_sub_ponto, p_tipo, gbl.getUsuario, '', sysdate, p_ds_ponto );

			insert into OBJECT_ATTRIB select 'DWU','DEFAULT','DEFAULT', upper(replace(trim(p_cd_ponto),' ','_')), cd_prop, vl_default from OBJECT_PADRAO where tp_objeto = p_tipo;
			commit;
		else
			htp.p('#alert '||fun.lang('Ponto de avalia&ccedil;&atilde;o j&aacute; existe')||'!');
		end if;
	else
		if p_tipo not in ('ICONE','CALL_LIST','FILE','IMAGE','TEXTO') then

			update TRADUCAO_COLUNAS
			set texto = ws_nome
			where cd_tabela  = p_cd_ponto and
			cd_coluna   = 'NM_OBJETO' and
			lang_default = (select nm_objeto from objetos where cd_objeto = p_cd_ponto) and
			cd_linguagem = ws_padrao;

			if ws_padrao = fun.ret_var('LANG_SYS') then
				update TRADUCAO_COLUNAS
				set lang_default = ws_nome
				where cd_tabela  = p_cd_ponto and
				cd_coluna   = 'NM_OBJETO' and
				lang_default = (select nm_objeto from objetos where cd_objeto = p_cd_ponto);

				begin
					update PONTO_AVALIACAO set
					vl_salvo	 = trim(p_vl_salvo),
					cd_micro_visao	 = trim(p_cd_micro_visao),
					nm_ponto	 = ws_nome,
					ar_diario	 = fcl.fpdata(p_ar_diario,'on','S','N'),
					ar_mensal	 = fcl.fpdata(p_ar_mensal,'on','S','N'),
					ar_anual	 = fcl.fpdata(p_ar_anual,'on','S','N'),
					cd_visao	 = trim(p_cd_visao),
					tp_renovacao	 = trim(p_tp_renovacao),
					ds_ponto	 = trim(p_ds_ponto),
					dt_ultima	 = sysdate,
					cs_parametros	 = pcs_parametros,
					cs_coluna	 = pcs_coluna,
					cs_agrupador	 = pcs_agrupador,
					cs_rp		 = pcs_rp,
					cs_colup	 = pcs_colup
					where cd_usuario = 'DWU' and cd_ponto = p_cd_ponto;
				exception when others then
					htp.p(sqlerrm);
				end;

			else
				update PONTO_AVALIACAO set
				vl_salvo	 = trim(p_vl_salvo),
				cd_micro_visao	 = trim(p_cd_micro_visao),
				nm_ponto	 = ws_nome,
				ar_diario	 = fcl.fpdata(p_ar_diario,'on','S','N'),
				ar_mensal	 = fcl.fpdata(p_ar_mensal,'on','S','N'),
				ar_anual	 = fcl.fpdata(p_ar_anual,'on','S','N'),
				cd_visao	 = trim(p_cd_visao),
				tp_renovacao	 = trim(p_tp_renovacao),
				ds_ponto	 = trim(p_ds_ponto),
				dt_ultima	 = sysdate,
				cs_parametros	 = pcs_parametros,
				cs_coluna	 = pcs_coluna,
				cs_agrupador	 = pcs_agrupador,
				cs_rp		 = pcs_rp,
				cs_colup	 = pcs_colup
				where cd_usuario = 'DWU' and cd_ponto = p_cd_ponto;
			end if;
		end if;
		if ws_padrao = fun.ret_var('LANG_SYS') then
			update OBJETOS
			set nm_objeto  = ws_nome,
			cd_grupo   = trim(fakeoption),
			ds_objeto  = trim(p_ds_ponto),
			subtitulo  = trim(p_sub_ponto),
			dt_ultima  = sysdate
			where cd_usuario = 'DWU' and cd_objeto = p_cd_ponto; -- verificar card:Propriedade da tela com erro--
		else
			update OBJETOS
			set cd_grupo = trim(fakeoption),
			ds_objeto  = trim(p_ds_ponto),
			subtitulo  = trim(p_sub_ponto),
			dt_ultima  = sysdate
			where cd_usuario = 'DWU' and cd_objeto = p_cd_ponto; -- verificar card:Propriedade da tela com erro--
		end if;
	end if;
exception 
	when ws_nouser then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end savepa;

procedure save_pwd ( prm_senha  		varchar2 default null,
					prm_email  		varchar2 default null,
					prm_number 		varchar2 default null,
					prm_user   		varchar2 default null,
					prm_nome   		varchar2 default null,
					prm_tela_inicial   varchar2 default null) as

	ws_erro             exception;
	ws_cmd              varchar2(4000);
	ws_nokill           exception;
	ws_usuario          varchar2(80);
	ws_vrf              varchar2(10);
	ws_countNumber		number:=0;
	ws_countString		number:=0;
	ws_forcaSenha		exception;

begin
	/*fcl.refresh_Session;*/

	ws_usuario := gbl.getUsuario;
	-- fazer o tratamento da exception. Não altera a senha porém diz que foi alterado com sucesso.
	select regexp_count(prm_senha, '[0-9]'),regexp_count(prm_senha, '[a-zA-Z]') into ws_countNumber,ws_countString from dual;
	--select regexp_count(prm_senha, '[a-z]') into ws_countString from dual;
	if nvl(prm_senha, 'N/A') <> 'N/A' then
		if (length(trim(prm_senha)) > 6) /*and (trim(prm_senha)<>trim(lower(prm_senha)))*/ and (ws_countNumber>0) and (ws_countString>0) then
			
			if nvl(fun.ret_var('XE'), 'N') = 'S' then

				begin
					ws_cmd := 'BEGIN execute immediate '''||fun.ret_var('ALTER_USER')||' alter user '||chr(34)||trim(upper(nvl(prm_user, ws_usuario)))||chr(34)||' identified by '||chr(34)||trim(prm_senha)||chr(34)||' ''; END ';
					fun.EXECUTE_NOW(ws_cmd);
					ws_cmd := 'BEGIN execute immediate ''alter user '||chr(34)||trim(upper(nvl(prm_user, ws_usuario)))||chr(34)||' account unlock''; END ';
					fun.EXECUTE_NOW(ws_cmd);
				exception when others then
					raise ws_erro;
				end;

			else
			
				ws_vrf := fun.digestPassword(prm_user, prm_senha);
				
				if ws_vrf <> 'Y' then
					raise ws_erro;
				end if;

			end if;
			

			begin
				delete from bi_sessao where valor = trim(upper(nvl(prm_user, ws_usuario)));
				commit;
			exception when others then
				raise ws_nokill;
			end;
		else

			raise ws_forcaSenha;

		end if;

	end if;

	if nvl(prm_email, 'N/A') <> 'N/A' then
		update usuarios set
		usu_email = trim(prm_email)
		where trim(usu_nome) = ws_usuario;
	end if;

	if nvl(prm_number, 'N/A') <> 'N/A' then
		update usuarios set
		usu_number = trim(prm_number)
		where trim(usu_nome) = ws_usuario;
	end if;

	if nvl(prm_nome, 'N/A') <> 'N/A' then
		update usuarios set
		usu_completo = trim(prm_nome)
		where trim(usu_nome) = ws_usuario;
	end if;

	update usuarios 
	set cd_tela_inicial = prm_tela_inicial
	where trim(usu_nome)              = ws_usuario
	and nvl(cd_tela_inicial,'N/A') <> NVL(prm_tela_inicial,'N/A');

	insert into log_eventos values(sysdate, 'ATUALIZACAO USUARIO[save_pwd]', ws_usuario, 'TELA', 'USUARIO', '01');
	commit;

	insert into bi_log_sistema values(sysdate, 'Altera&ccedil;&atilde;o de Senha do usu&aacute;rio '||nvl(prm_user, ws_usuario)||'', ws_usuario, 'EVENTO');
	commit;

exception

	when ws_erro then
		htp.p('#alert '||fun.lang('Imposs&iacute;vel alterar a senha, Erro de permiss&atilde;o !'));
		insert into bi_log_sistema values(sysdate, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - SAVE_PWD', ws_usuario, 'ERRO');
		commit;

	when ws_nokill then
		htp.p('#alert '||fun.lang('Senha alterada, mas n&atilde;o foi poss&iacute;vel derrubar a sess&atilde;o')||'!');
		insert into bi_log_sistema values(sysdate, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - SAVE_PWD', ws_usuario, 'ERRO');
		commit;
	when ws_forcaSenha then
		htp.p('#alert '||fun.lang('Erro ao alterar a senha. Sua senha deve conter no m&iacute;nimo 6 d&iacute;gitos, letras e n&uacute;meros ')||'!');
		insert into bi_log_sistema values(sysdate, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - SAVE_PWD', ws_usuario, 'ERRO');
		commit;


	when others then
		if substr(sqlerrm, 0, 9) = 'ORA-01031' then
			htp.p('#alert '||fun.lang('Imposs&iacute;vel alterar a senha, usu&aacute;rio sem privil&eacute;gios para esta opera&ccedil;&atilde;o')||'!');
		else
			htp.p('#alert '||fun.lang('Erro ao alterar os dados')||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
		end if;

end save_pwd;


procedure savecalc ( p_cd_coluna	varchar2 default null,
					p_cd_grupo		varchar2 default null,
					p_nm_rotulo	varchar2 default null,
					p_coluna		varchar2 default null,
					p_objeto		varchar2 default null,
					p_operacao		varchar2 default null,
					p_st_formula	varchar2 default null,
					p_funcao		varchar2 default null,
					p_st_agrupador	varchar2 default null,
					p_mvisao		varchar2 default null ) as

begin
	/*fcl.refresh_Session;*/
	if  p_funcao = 'G' then
		insert into MICRO_COLUNA
		( cd_micro_visao,	cd_coluna,	nm_rotulo,
		st_gera_rel,		st_agrupador,	nm_mascara,
		cd_ligacao,		st_com_codigo,	st_alinhamento,
		st_resumido,		st_negrito,	st_invisivel,
		hint, nm_unidade,		formula,	tipo,
		rotulo_c, color, flexcol, limite, url, anotacao)
		values
			( p_mvisao,		p_cd_coluna,	p_nm_rotulo,
			'N',			p_st_agrupador,	'VALOR',
			'SEM',		'N',		'LEFT',
			'N',			'N',		'N','',
			' ',			p_st_formula,	'C', '', '', '', '', '', '');
	else
		update MICRO_COLUNA set
		nm_rotulo	= rtrim(p_nm_rotulo),
		st_agrupador	= rtrim(p_st_agrupador),
		formula		= p_st_formula
		where
			cd_micro_visao=p_mvisao and
			cd_coluna=p_cd_coluna;
		commit;
	end if;

	fcl.load_mview(p_cd_grupo, p_mvisao);

end savecalc;

/* Salva Parametro Padrão */

procedure savevp ( p_funcao		varchar2 default null,
		p_cd_padrao		varchar2 default null,
		p_nm_padrao		varchar2 default null,
		p_tp_padrao		varchar2 default null,
		p_cd_ligacao		varchar2 default null,
		p_status		    varchar2 default null,
		p_ordem          number default 1 ) as

	ws_tp_padrao		varchar2(20);

begin
	/*fcl.refresh_Session;*/
	if  p_cd_ligacao <> 'SEM' then
		ws_tp_padrao := 'LIGACAO';
	else
		ws_tp_padrao := p_tp_padrao;
	end if;

	if  p_funcao = 'G' then
		insert into PARAMETRO_PADRAO
		( cd_padrao, nm_padrao, tp_padrao, cd_ligacao, status, ordem )
		values
		( upper(p_cd_padrao), p_nm_padrao, ws_tp_padrao, p_cd_ligacao, 'A', p_ordem );
		commit;
	else
		update PARAMETRO_PADRAO set
		nm_padrao  = rtrim(p_nm_padrao),
		tp_padrao  = rtrim(ws_tp_padrao),
		cd_ligacao = rtrim(p_cd_ligacao),
		status = rtrim(p_status),
		ordem = rtrim(p_ordem)
		where  cd_padrao = p_cd_padrao;
		commit;
	end if;

end savevp;

/* Salva Micro Visão */

procedure savegd ( p_cd_micro_visao varchar2 default null,
				p_funcao         varchar2 default null,
				p_cd_objeto		varchar2 default null,
				p_nm_objeto		varchar2 default null,
				p_sub_objeto		varchar2 default null,
				p_atributos		varchar2 default null,
				fakeoption		varchar2 default null,
				p_tp_objeto		varchar2 default null,
				p_ds_objeto		varchar2 default null,
				p_cs_colup       varchar2 default null ) as

	tipo           varchar2(200);
	altura         varchar2(60);
	largura        varchar2(60);
	ws_comb        varchar2(2000);
	ws_count       number;
	ws_texto       varchar2(200);
	ws_padrao      varchar2(40);
	ws_loop1       varchar2(50);
	ws_loop2       varchar2(50);
	ws_cursor	   integer;
	ws_sql		   varchar2(2000);
	ws_codigo      varchar2(30);
	ws_linhas      integer;
	ws_valor       varchar2(2000);
	ws_3d          char(1);
	ws_convert     varchar2(800);
	ws_convert_ds  varchar2(800);
	ws_sub         varchar2(800);
	ws_atrib       varchar2(800);
	ws_usuario     varchar2(80);
begin

	/*fcl.refresh_Session;*/

	ws_usuario    := gbl.getUsuario;

	ws_convert    := fun.converte(p_nm_objeto);
	ws_convert_ds := fun.converte(p_ds_objeto);
	ws_sub        := fun.converte(p_sub_objeto);
	ws_atrib      := fun.converte(p_atributos);

	select count(*) into ws_count from PARAMETRO_USUARIO where cd_usuario = ws_usuario and cd_padrao='CD_LINGUAGEM';

	begin
		if ws_count = 1 then
			select CONTEUDO into ws_padrao
			from   PARAMETRO_USUARIO
			where  cd_usuario = ws_usuario and
			cd_padrao='CD_LINGUAGEM';
		else
			ws_padrao := 'PORTUGUESE';
		end if;
	end;

if p_funcao = 'G' then
	select count(*) into ws_count from OBJETOS where cd_objeto = p_cd_objeto;
	if ws_count = 0 then
		insert into OBJETOS (cd_objeto, cd_grupo, nm_objeto, subtitulo, tp_objeto, cd_usuario, atributos, dt_ultima, ds_objeto) values ( upper(p_cd_objeto), fakeoption, ws_convert, p_sub_objeto, p_tp_objeto, gbl.getUsuario, ws_atrib, sysdate, ws_convert_ds );

		/*LIMITADORES NÃO REVERTIDO*/
		
		begin
			if trim(p_tp_objeto) = 'FLOAT_FILTER' or trim(p_tp_objeto) = 'FLOAT_PAR' then
				select nds_cd_codigo, nds_tfisica into ws_loop1, ws_loop2 from CODIGO_DESCRICAO where nds_tabela = (select cd_ligacao from parametro_padrao where cd_padrao = replace(p_cd_objeto, '_FILTER', ''));
				ws_sql := 'select '||trim(ws_loop1)||' from '||nvl(fun.ret_var('OWNER_TABLE_DATA'),'DWU')||'.'||trim(ws_loop2)||'';
				ws_cursor := dbms_sql.open_cursor;
				dbms_sql.parse(ws_cursor, ws_sql, DBMS_SQL.NATIVE);
				dbms_sql.define_column(ws_cursor, 1, ws_codigo, 60);

				ws_linhas := dbms_sql.execute(ws_cursor);

				loop
					ws_linhas := dbms_sql.fetch_rows(ws_cursor);
					if ws_linhas <> 1 then
						exit;
					end if;

					dbms_sql.column_value(ws_cursor, 1, ws_codigo);
					ws_valor := ws_valor||'|'||ws_codigo;
				end loop;

				insert into OBJECT_ATTRIB values ('DWU','DEFAULT','DEFAULT', p_cd_objeto, 'LIMITADORES', ws_valor);
			end if;
		exception when others then
			htp.p('Limitadores não criados!');
		end;

	else
		htp.p('#alert '||fun.lang('Objeto j&aacute; existe!'));
	end if;
else
	
	if p_tp_objeto = 'TEXTO' then

		select atributos into ws_texto from objetos where cd_objeto = p_cd_objeto;

		update traducao_colunas set
		texto = ws_atrib
		where cd_tabela = p_cd_objeto and
		cd_linguagem = ws_padrao and
		cd_coluna = 'ATRIBUTOS' and
		lang_default = ws_texto;

		if ws_padrao = fun.ret_var('LANG_SYS') then
			update traducao_colunas set
			lang_default = ws_atrib
			where cd_tabela = p_cd_objeto and
			cd_coluna = 'ATRIBUTOS' and
			lang_default = ws_texto;
		end if;

	end if;

	update traducao_colunas set
	texto = ws_convert
	where cd_tabela = p_cd_objeto and
	cd_linguagem = ws_padrao and
	cd_coluna = 'NM_OBJETO' and
	lang_default = (select nm_objeto from objetos where cd_objeto = p_cd_objeto);

	if ws_padrao = fun.ret_var('LANG_SYS') then
		update traducao_colunas set
		lang_default = ws_convert
		where cd_tabela = p_cd_objeto and
		cd_coluna = 'NM_OBJETO' and
		lang_default = (select nm_objeto from objetos where cd_objeto = p_cd_objeto);

		update OBJETOS set
		cd_grupo       = rtrim(fakeoption),
		nm_objeto      = ws_convert,
		subtitulo      = ws_sub,
		tp_objeto      = rtrim(p_tp_objeto),
		cd_usuario   = 'DWU',
		dt_ultima      = sysdate,
		atributos   = p_atributos,
		ds_objeto   = ws_convert_ds
		where  cd_objeto = p_cd_objeto;

		update ponto_avaliacao set
		cs_colup = p_cs_colup,
		nm_ponto = ws_convert
		where cd_ponto = p_cd_objeto;

	else

		update OBJETOS set
		cd_grupo       = rtrim(fakeoption),
		tp_objeto      = rtrim(p_tp_objeto),
		cd_usuario   = 'DWU',
		dt_ultima      = sysdate,
		atributos   = p_atributos,
		ds_objeto   = ws_convert_ds
		where  cd_objeto = p_cd_objeto;

		update ponto_avaliacao set
		cs_colup = p_cs_colup
		where cd_ponto = p_cd_objeto;

		htp.p('');
	end if;

	commit;

end if;

if rtrim(p_tp_objeto) = 'VALOR' then
	htp.p('<script> parent.chartPercent('''||upper(rtrim(p_cd_objeto))||'''); </script>');
end if;

if rtrim(p_tp_objeto) = 'PIZZA' then
	htp.p('<script> parent.chartSlice('''||upper(rtrim(p_cd_objeto))||'''); </script>');
end if;

if rtrim(p_tp_objeto) = 'ROSCA' then
	htp.p('<script> parent.chartDonut('''||upper(rtrim(p_cd_objeto))||'''); </script>');
end if;

if rtrim(p_tp_objeto) = 'BARRAS' then
	htp.p('<script>parent.chart('''||upper(rtrim(p_cd_objeto))||''');</script>');
end if;

if rtrim(p_tp_objeto) = 'COLUNAS' then
	htp.p('<script>parent.chart('''||upper(rtrim(p_cd_objeto))||''');</script>');
end if;

if rtrim(p_tp_objeto) = 'LINHAS' then
	htp.p('<script>parent.chart('''||upper(rtrim(p_cd_objeto))||''');</script>');
end if;

if rtrim(p_tp_objeto) = 'PONTEIRO' then
	htp.p('<script> parent.chartGauge('||chr(39)||upper(rtrim(p_cd_objeto))||chr(39)||'); </script>');
end if;

if rtrim(p_tp_objeto) in ('SANKEY','SCATTER','RADAR') then
	htp.p('<script> parent.chartGauge('||chr(39)||upper(rtrim(p_cd_objeto))||chr(39)||'); </script>');
end if;

exception 
	when others then
		htp.p('FAIL '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
end savegd;


procedure savecallist ( p_funcao    varchar2 default null,
						p_cd_objeto varchar2 default null,
						fakeoption	varchar2 default null,
						p_nm_objeto	varchar2 default null,
						p_ds_objeto	varchar2 default null ) as


	ws_count   number;
	ws_padrao  varchar2(40);
	ws_erro    exception;
	ws_nome    varchar2(800);
	ws_desc    varchar2(800);
	ws_usuario varchar2(80);
begin

	ws_usuario := gbl.getUsuario;

	/*fcl.refresh_Session;*/
	select count(*) into ws_count from PARAMETRO_USUARIO where cd_usuario = ws_usuario and cd_padrao='CD_LINGUAGEM';

	ws_nome  := fun.converte(p_nm_objeto);
	ws_desc  := fun.converte(p_ds_objeto);

	if ws_count = 1 then
		select CONTEUDO into ws_padrao
		from   PARAMETRO_USUARIO
		where  cd_usuario = ws_usuario and
		cd_padrao='CD_LINGUAGEM';
	else
		ws_padrao := 'PORTUGUESE';
	end if;

	if  p_funcao = 'G' then
		insert into OBJETOS
		(cd_objeto, cd_grupo, nm_objeto, subtitulo, tp_objeto, cd_usuario, atributos, dt_ultima, ds_objeto)
		values
		( p_cd_objeto, fakeoption, ws_nome, '', 'CALL_LIST', gbl.getUsuario, '', sysdate, ws_desc );
		commit;
	else

		select count(*) into ws_count
		from   TRADUCAO_COLUNAS
		where  cd_tabela    = p_cd_objeto and
				cd_coluna    = 'NM_OBJETO' and
				cd_linguagem = ws_padrao and
				tipo         = 'O' and
				lang_default = (select nm_objeto from objetos where cd_objeto = p_cd_objeto);

		if  ws_count = 1 then
			update TRADUCAO_COLUNAS set texto = ws_nome
			where  cd_tabela    = p_cd_objeto and
					cd_coluna    = 'NM_OBJETO' and
					cd_linguagem = ws_padrao  and
					tipo         = 'O' and
					lang_default = (select nm_objeto from objetos where cd_objeto = p_cd_objeto);
		else
			if  ws_count = 0 then
				insert into TRADUCAO_COLUNAS values (p_cd_objeto, 'NM_OBJETO', ws_padrao, ws_nome, (select nm_objeto from objetos where cd_objeto = p_cd_objeto), 'O', 'N');
			else
				raise ws_erro;
			end if;
		end if;

		if ws_padrao = fun.ret_var('LANG_SYS') then
			update traducao_colunas
			set lang_default = ws_nome
			where cd_tabela = p_cd_objeto and
			cd_coluna = 'NM_OBJETO' and
			lang_default = (select nm_objeto from objetos where cd_objeto = p_cd_objeto);

			update OBJETOS set
			cd_grupo = rtrim(fakeoption),
			nm_objeto = ws_nome,
			tp_objeto = 'CALL_LIST',
			cd_usuario = 'DWU',
			dt_ultima = sysdate,
			atributos = '',
			ds_objeto = ws_desc
			where cd_objeto = p_cd_objeto;

		else
		update OBJETOS set
			cd_grupo = rtrim(fakeoption),
			tp_objeto = 'CALL_LIST',
			cd_usuario = 'DWU',
			dt_ultima = sysdate,
			atributos = '',
			ds_objeto = ws_desc
			where cd_objeto = p_cd_objeto;
		end if;

		commit;
	end if;
	exception when others then
		htp.p(sqlerrm);
end savecallist;


/* Salva fun.cdesc */


procedure savecd (	p_funcao		        varchar2 default null,
					p_nds_tabela		    varchar2 default null,
					p_nds_owner		  		varchar2 default null,
					p_nds_tfisica	  		varchar2 default null,
					p_nds_cd_empresa	    varchar2 default null,
					p_nds_cd_codigo	    	varchar2 default null,
					p_nds_cd_descricao		varchar2 default null,
					p_tipo          		varchar2 default null  ) as

	ws_count number; 
	ws_converte varchar2(800);

	ws_duplicado exception;

begin

	/*fcl.refresh_Session;*/

	ws_converte := fun.converte(p_nds_tabela);

	select count(*) into ws_count from CODIGO_DESCRICAO where upper(trim(nds_tabela)) = upper(trim(ws_converte));
	
	if ws_count > 0 then
		raise ws_duplicado;
	end if;	
		
		if  p_funcao = 'G' and ws_count = 0 then
			insert into CODIGO_DESCRICAO
				( nds_tabela,   nds_owner,   nds_tfisica,   nds_cd_empresa,   nds_cd_codigo,   nds_cd_descricao,  tipo )
			values
				( upper(trim(ws_converte)), trim(p_nds_owner), trim(p_nds_tfisica), trim(p_nds_cd_empresa), trim(p_nds_cd_codigo), trim(p_nds_cd_descricao), trim(p_tipo) );
			commit;
		else
			update CODIGO_DESCRICAO set
				nds_tabela = upper(trim(ws_converte)),
				nds_owner = trim(nds_owner),
				nds_tfisica = trim(p_nds_tfisica),
				nds_cd_empresa = trim(p_nds_cd_empresa),
				nds_cd_codigo = trim(p_nds_cd_codigo),
				nds_cd_descricao = trim(p_nds_cd_descricao),
				tipo             = trim(p_tipo)
			where nds_tabela = ws_converte;
			commit;
		end if;

		htp.p('ok');
	exception 
		when ws_duplicado then
			htp.p('LOV j&aacute; existe');
			insert into bi_log_sistema values(sysdate, 'Erro ao criar LOV', gbl.getUsuario, 'ERRO');
			commit;
		when others then
			htp.p('Erro ao criar LOV');
			insert into bi_log_sistema values(sysdate, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - LOV OTHERS ', gbl.getUsuario, 'ERRO');
			commit;
end savecd;

procedure update_sinal ( prm_sinal varchar2 default null,
						prm_tipo  varchar2 default null,
						prm_valor varchar2 default null ) as

	ws_count number;

begin

	case prm_tipo
		when 'fx_01' then
			update sinais set fx_01 = prm_valor where cd_sinal = prm_sinal;
		when 'fx_02' then
			update sinais set fx_02 = prm_valor where cd_sinal = prm_sinal;
		when 'fx_03' then
			update sinais set fx_03 = prm_valor where cd_sinal = prm_sinal;
		when 'fx_04' then
			update sinais set fx_04 = prm_valor where cd_sinal = prm_sinal;
		when 'fx_05' then
			update sinais set fx_05 = prm_valor where cd_sinal = prm_sinal;
		when 'tp_sinal' then
			update sinais set tp_sinal = prm_valor where cd_sinal = prm_sinal;
	end case;

	ws_count := sql%rowcount;
	
	if ws_count <> 0 then
		htp.p('OK');
		commit;
	else
		htp.p('FAIL');
		rollback;
	end if;
	
exception when others then
	htp.p('FAIL');
end update_sinal;

procedure savesign ( p_funcao varchar2 default null,
					p_cd_sinal varchar2 default null,
					p_ds_sinal varchar2 default null,
					p_tp_sinal varchar2 default null,
					p_fx_01 varchar2 default null,
					p_fx_02 varchar2 default null,
					p_fx_03 varchar2 default null,
					p_fx_04 varchar2 default null,
					p_fx_05 varchar2 default null ) as

begin
	/*fcl.refresh_Session;*/
	if  p_funcao = 'G' then
		insert into SINAIS
		( cd_sinal, ds_sinal, tp_sinal, fx_01, fx_02, fx_03, fx_04, fx_05 )
		values
		( p_cd_sinal, p_ds_sinal, p_tp_sinal, p_fx_01, p_fx_02, p_fx_03, p_fx_04, p_fx_05 );
		commit;
	else
		update SINAIS set
			ds_sinal = rtrim(p_ds_sinal),
			tp_sinal = rtrim(p_tp_sinal),
			fx_01 = rtrim(p_fx_01),
			fx_02 = rtrim(p_fx_02),
			fx_03 = rtrim(p_fx_03),
			fx_04 = rtrim(p_fx_04),
			fx_05 = rtrim(p_fx_05)
		where  cd_sinal = p_cd_sinal;
		commit;
	end if;

end savesign;


procedure dl_obj ( prm_cod  char     default null,     
				prm_tela char     default null, 
				prm_list varchar2 default null )  as

	ws_chain    varchar2(100);
	ws_count    number;
	ws_tipo     varchar2(100);
	ws_nome     varchar2(200);
	ws_converte varchar2(800);
	ws_usuario  varchar2(80);
	ws_tela     varchar2(80);
    ws_tem_obj  number := 0;

	ws_nouser         exception;
    ws_dash_cheio     exception;
	ws_error          exception;	
begin

	ws_usuario  := gbl.getUsuario;
	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if;
	
	ws_converte := fun.converte(prm_cod);

	begin
		select tp_objeto, nm_objeto into ws_tipo, ws_nome from objetos where cd_objeto = ws_converte;
	exception when others then
		begin 
			select substr(ws_converte, 0, instr(ws_converte, '_')-1) into ws_tipo from dual;
		exception when others then
			ws_tipo := 'OBJETO';
		end;
	end;

	select count(*) into ws_count from objetos where cd_objeto = ws_converte and tp_objeto = 'FLOAT_FILTER';

	if ws_count > 0 then
		delete from float_filter_item where cd_coluna = ws_converte and screen = prm_tela;
	end if;

	ws_count := 0;

	if prm_tela <> 'NOSCREEN' then
        if ws_tipo = 'SECTION' then
            begin
                select count(1) into ws_tem_obj
                from object_location
                where screen in (select object_id from object_location
                                    where screen = ws_converte);
            exception when others then
                raise ws_error;
            end;
            if ws_tem_obj > 0 then
                raise ws_dash_cheio;
            end if;
        end if;
		begin
				delete OBJECT_LOCATION
				where owner     = 'DWU' 
				and navegador = 'DEFAULT' 
				and screen    = prm_tela 
				and object_id in (ws_converte, ws_converte||'_FILTER');
			exception when others then
				raise ws_error;
		end;

		begin
			if instr(ws_converte, 'ARTICLE') <> 0 then
				/* exclui textos */
				delete from objetos
				where tp_objeto = 'TEXTO' 
				and cd_objeto in (select object_id from object_location where screen = ws_converte);
				
				/* exclui todos os objetos dentro do article */
				delete OBJECT_LOCATION
				where owner     = 'DWU' 
				and navegador = 'DEFAULT' 
				and screen    = prm_cod;
				
				/* exclui o article */
				delete OBJECT_LOCATION
				where owner = 'DWU' 
				and navegador = 'DEFAULT' 
				and screen = prm_tela 
				and object_id = prm_cod;
				
				ws_count := 0;
				/* reordena articles */
				for i in(select object_id from object_location where screen = prm_tela and object_id like 'ARTICLE_%' order by to_number(posx) asc) loop
					ws_count := ws_count+1;
					update object_location set posx = ws_count where object_id = i.object_id and screen = prm_tela;
				end loop;
			end if;
		exception when others then
			raise ws_error;
		end;

		begin
			if instr(prm_cod, 'SECTION') <> 0 then
				/* pega todos os objetos dentro dos articles dentro da section e exclui, exclui o article em seguida */
				for i in(select object_id from object_location where screen = prm_cod) loop
					delete from objetos
					where tp_objeto = 'TEXTO' and
					cd_objeto in (select object_id from object_location where screen = i.object_id);

					delete OBJECT_LOCATION
					where owner = 'DWU' and
					navegador = 'DEFAULT' and
					screen = i.object_id;

					delete OBJECT_LOCATION
					where owner = 'DWU' and
					navegador = 'DEFAULT' and
					screen = prm_cod and
					object_id = i.object_id;
				end loop;

				delete OBJECT_LOCATION
				where owner = 'DWU' and
				navegador = 'DEFAULT' and
				screen = prm_tela and
				object_id = prm_cod;
				ws_count := 0;
				for i in(select object_id from object_location where screen = prm_tela and object_id like 'SECTION_%' order by posx asc) loop
					ws_count := ws_count+1;
					update object_location set posx = ws_count where object_id = i.object_id and screen = prm_tela;
				end loop;
			end if;
		exception when others then
			raise ws_error;
		end;

		htp.p('OK');
		commit;

		if nvl(prm_tela, 'DEFAULT') <> 'DEFAULT' then
			if instr(prm_tela, 'ARTICLE') > 0 then
				select screen into ws_tela from object_location where object_id = prm_tela;
				select screen into ws_tela from object_location where object_id = ws_tela;
			else
				ws_tela := prm_tela;
			end if;
			select nm_objeto into ws_tela from objetos where cd_objeto = ws_tela;
			insert into bi_log_sistema values (sysdate, 'Objeto "'||ws_nome||'('||ws_converte||')" do tipo "'||ws_tipo||'", excluido da tela "'||ws_tela||'('||prm_tela||')"', ws_usuario, 'EVENTO');
			commit;
		else	
			insert into bi_log_sistema values (sysdate, 'Objeto "'||ws_nome||'('||ws_converte||')" do tipo "'||ws_tipo||'", excluido', ws_usuario, 'EVENTO');
			commit;
		end if;

	end if;

exception
	when ws_nouser then
		htp.p('Sem permiss&atilde;o!');
    when ws_dash_cheio then
        htp.p('ERRO|Dashboard cont&eacute;m objetos, exclua eles primeiro!');
	when ws_error then
		rollback;
		htp.p('FAIL '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
	when others then
		rollback;
		htp.p('FAIL '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);

end dl_obj;


--!!
procedure dl_vp ( ws_par_sumary	char default null ) as

	ws_count number;

	ws_noadmin exception;
	ws_fail    exception;

begin
	
	if gbl.getNivel <> 'A' then
		raise ws_noadmin;
	end if;
	
	delete PARAMETRO_PADRAO where cd_padrao = ws_par_sumary;
	
	ws_count := SQL%ROWCOUNT;
	
	if ws_count <> 0 then
		commit;
		
		delete from float_filter_item where cd_coluna = trim(ws_par_sumary);
		delete from traducao_colunas where cd_tabela = 'PARAMETRO_PADRAO' and cd_coluna = 'NM_PADRAO' and lang_default = (select nm_padrao from parametro_padrao where cd_padrao = ws_par_sumary);
		delete from traducao_colunas where cd_tabela = 'PARAMETRO_PADRAO' and cd_coluna = 'CD_PADRAO' and lang_default = ws_par_sumary;
		delete from parametro_usuario where cd_padrao = trim(ws_par_sumary);
		delete from object_location where object_id = trim(ws_par_sumary);
		delete from objetos where cd_objeto = trim(ws_par_sumary);
		delete from object_attrib where cd_object = trim(ws_par_sumary);
		commit;
	else
		raise ws_fail;
	end if;

exception 
	when ws_noadmin then
		htp.p('Sem permiss&atilde;o!');
	when ws_fail then
		htp.p('FAIL');
	when others then
		htp.p('FAIL');
end dl_vp;


procedure dl_cd ( ws_par_sumary	char default null ) as

	ws_count   number;
	ws_fail    exception;
	ws_convert varchar2(800);

begin

	/*fcl.refresh_Session;*/

	ws_convert := fun.converte(ws_par_sumary);
	
	delete CODIGO_DESCRICAO where nds_tabela = ws_convert;
	
	ws_count := SQL%ROWCOUNT;
	
	if ws_count <> 0 then
		commit;
	else
		raise ws_fail;
	end if;

exception 
	when ws_fail then
		htp.p('FAIL');
	when others then
		htp.p('FAIL');
end dl_cd;


procedure dl_sn ( ws_par_sumary	char default null ) as

	ws_fail      exception;
	ws_count     number;
	ws_cd_sinal  varchar2(800);
	ws_msg       varchar2(200);
begin
	
	ws_cd_sinal := fun.converte(ws_par_sumary);
	select count(*) into ws_count 
	from sinal_coluna t1
	where cd_sinal = ws_cd_sinal ; 
	if ws_count > 0 then 
		ws_msg := 'FAIL Sinalizador est&aacute; sendo utilizado, n&atilde;o pode ser exclu&iacute;do'; 
		raise ws_fail;
	end if;  

	delete from SINAIS where cd_sinal = ws_cd_sinal;
	ws_count := SQL%ROWCOUNT;
	if ws_count <> 0 then
		delete from traducao_colunas where cd_tabela = 'SINAIS' and cd_coluna = 'DS_SINAL' and lang_default = (select ds_sinal from sinais where cd_sinal = ws_cd_sinal);
		delete from traducao_colunas where cd_tabela = 'SINAIS' and cd_coluna = 'CD_SINAL' and lang_default = ws_cd_sinal;
		commit;
	else
		ws_msg := 'FAIL'; 
		raise ws_fail;
	end if;
	
exception 
	when ws_fail then
		htp.p(ws_msg);
	when others then
		rollback;
		insert into bi_log_sistema (dt_log, ds_log, nm_usuario, nm_procedure ) values (sysdate, 'Erro deletando sinalizador(DL_SN-Others)):'||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, 'DWU', 'ERRO');
		commit;			
		htp.p('FAIL Erro excluindo sinalizador, verifique log do sistema');
end dl_sn;


--!!
procedure dl_ofiltro ( prm_key number default null ) as

	ws_count      number := 0;
	ws_objeto     varchar2(40);
	ws_coluna     varchar2(80);
	ws_conteudo   varchar2(200);
	ws_nome       varchar2(100);
	ws_usuario    varchar2(80);

	ws_nouser     exception;
	ws_fail       exception;

begin

	ws_usuario := gbl.getUsuario;

	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if;

	select cd_objeto, cd_coluna, conteudo into ws_objeto, ws_coluna, ws_conteudo from filtros where cd_filtro = prm_key/* and tp_filtro = 'objeto'*/;
	select nm_objeto into ws_nome from objetos where cd_objeto = ws_objeto;

	delete filtros
	where cd_filtro = prm_key/* and tp_filtro = 'objeto'*/;
	
	ws_count := SQL%ROWCOUNT;
	
	if ws_count <> 0 then
		commit;
		
		insert into bi_log_sistema values (sysdate, 'Usuario excluiu o filtro #'||prm_key||' do objeto ' ||UPPER(ws_nome)||'('||ws_objeto||') com a coluna '||ws_coluna||' com o valor '||upper(ws_conteudo)||'', ws_usuario, 'EVENTO');
		commit;
	else
		raise ws_fail;
	end if;
	
exception 
	when ws_nouser then
		htp.p('Sem permiss&atilde;o!');
	when ws_fail then
		htp.p('FAIL');
	when others then
		htp.p('FAIL');
end dl_ofiltro;


/* Exclui Item List_Call */


procedure dl_call (	p_cd_objeto	varchar2 default null,
					p_cd_objeto_go	varchar2 default null ) as

ws_count number;
ws_tipo varchar2(20);
ws_att long;
begin
	/*fcl.refresh_Session;*/
	select count(*) into ws_count from call_list where cd_list=p_cd_objeto and cd_objeto=p_cd_objeto_go;
	if ws_count > 0 then
		select tp_objeto into ws_tipo from objetos where cd_objeto = p_cd_objeto_go;
		if ws_tipo = 'FILE' then
			select atributos into ws_att from objetos where cd_objeto = p_cd_objeto_go;
			delete from objetos where cd_objeto = p_cd_objeto_go;
			delete from object_location where object_id = p_cd_objeto_go;
			delete from object_attrib where cd_object = p_cd_objeto_go;
		end if;
		delete call_list where cd_list = p_cd_objeto and cd_objeto=p_cd_objeto_go;
	elsif ws_count = 0 then
		htp.p('#alert '||fun.lang('Valor inexistente')||'!');
	end if;
exception when others then
	htp.p('FAIL');
end dl_call;


procedure ajscreen ( prm_screen char default null ) as

	cursor crs_objloc is
	select * from OBJECT_LOCATION where screen = prm_screen and owner = 'DWU' and navegador = 'DEFAULT' and object_id not in ('toolbar','newquery') and object_id in (select cd_objeto from objetos);

	ws_objloc crs_objloc%rowtype;
	ws_tipo  varchar2(40);
	ws_comb  varchar2(2000) := '';
	ws_multi number;

	ws_3d char(1);

begin
	/*fcl.refresh_Session;*/
	open crs_objloc;
		loop
			fetch crs_objloc into ws_objloc;
			exit when crs_objloc%notfound;

			select max(tp_objeto) into ws_tipo
			from OBJETOS
			where cd_objeto=ws_objloc.object_id and cd_usuario=ws_objloc.owner;

			select count(*) into ws_multi
			from TABLE(fun.VPIPE(( select max(cs_agrupador) from PONTO_AVALIACAO where cd_ponto=ws_objloc.object_id )))
			where trim(column_value) is not null;

			select max(cs_colup) into ws_comb from PONTO_AVALIACAO where cd_ponto=ws_objloc.object_id;


			if ws_tipo='ORGANOGRAMA' then
				htp.p('<script> parent.activeorga('||chr(39)||ws_objloc.object_id||chr(39)||','||chr(39)||fun.put_par(ws_objloc.object_id, 'ALTURA', ws_tipo)||chr(39)||','||chr(39)||fun.put_par(ws_objloc.object_id, 'LARGURA', ws_tipo)||chr(39)||'); </script>');
			end if;

			if ws_tipo='MAPA' then
				htp.p('<script>parent.chartMap('''||ws_objloc.object_id||''');</script>');
			end if;

			if ws_tipo='BARRAS' then
				htp.p('<script>parent.chart('''||ws_objloc.object_id||''');</script>');
			end if;

			if ws_tipo='COUNAS' then
				htp.p('<script>parent.chart('''||ws_objloc.object_id||''');</script>');
			end if;
			
			if ws_tipo='HEATMAP' then
				htp.p('<script>parent.heatmap('''||ws_objloc.object_id||''');</script>');
			end if;

			if ws_tipo='VALOR' then
				htp.p('<script> parent.chartPercent('''||ws_objloc.object_id||'''); </script>');
			end if;

			if ws_tipo='PIZZA' then
				htp.p('<script> parent.chartSlice('''||ws_objloc.object_id||'''); </script>');
			end if;

			if ws_tipo='ROSCA' then
				htp.p('<script> parent.chartDonut('''||ws_objloc.object_id||'''); </script>');
			end if;

			if ws_tipo='LINHAS' then
				htp.p('<script> parent.chart('''||ws_objloc.object_id||'''); </script>');
			end if;

			if ws_tipo='PONTEIRO' then
				htp.p('<script> parent.chartGauge('||chr(39)||ws_objloc.object_id||chr(39)||'); </script>');
			end if;

			if ws_tipo in ('SANKEY','SCATTER','RADAR') then
				htp.p('<script>parent.chart('''||ws_objloc.object_id||''');</script>');
			end if;

		end loop;
	close crs_objloc;

exception when others then
	htp.p(sqlerrm);
end ajscreen;

procedure ajobjeto ( prm_objeto char default null ) as

	ws_tipo  varchar2(40);
	ws_comb  varchar2(2000);
	ws_multi number;
	ws_3d    char(1);

begin
	/*fcl.refresh_Session;*/
	select max(tp_objeto) into ws_tipo
	from OBJETOS
	where cd_objeto  = fun.get_cd_obj(prm_objeto)
	  and cd_usuario = fun.who;

	select count(*) into ws_multi
	from TABLE(fun.VPIPE((
		select max(cs_agrupador)
		from PONTO_AVALIACAO
		where cd_ponto=prm_objeto )))
	where trim(column_value) is not null;

	if ws_tipo = 'ORGANOGRAMA' then
		htp.p('<script> parent.activeorga('||chr(39)||prm_objeto||chr(39)||','||chr(39)||fun.put_par(prm_objeto, 'ALTURA', ws_tipo)||chr(39)||','||chr(39)||fun.put_par(prm_objeto, 'LARGURA', ws_tipo)||chr(39)||'); </script>');
	end if;

	if  ws_tipo = 'MAPA' then
		htp.p('<script>parent.chartMap('''||prm_objeto||''');</script>');
	end if;

	if ws_tipo = 'BARRAS' then
		htp.p('<script>parent.chart('''||prm_objeto||''');</script>');
	end if;

	if ws_tipo = 'COLUNAS' then
		htp.p('<script>parent.chart('''||prm_objeto||''');</script>');
	end if;
	
	if ws_tipo='HEATMAP' then
		htp.p('<script>parent.heatmap('''||prm_objeto||''');</script>');
	end if;

	if ws_tipo = 'VALOR' then
		htp.p('<script> parent.chartPercent('''||prm_objeto||'''); </script>');
	end if;

	if ws_tipo = 'PIZZA' then
		htp.p('<script> parent.chartSlice('''||prm_objeto||'''); </script>');
	end if;

	if ws_tipo = 'ROSCA' then
		htp.p('<script> parent.chartDonut('''||prm_objeto||'''); </script>');
	end if;

	if ws_tipo = 'LINHAS' then
		htp.p('<script> parent.chart('''||prm_objeto||'''); </script>');
	end if;

	if ws_tipo = 'PONTEIRO' then
		htp.p('<script> parent.chartGauge('''||prm_objeto||'''); </script>');
	end if;

exception when others then
	htp.p(sqlerrm);
end ajobjeto;

--!!
procedure show_screen ( prm_screen	    varchar2 default null,
						prm_clear	    varchar2 default 'N',
						prm_screen_ant	varchar2 default null,
						prm_refresh     varchar2 default 'N',
						prm_parametro   varchar2 default null,
						prm_tipo        varchar2 default null,
						prm_token       varchar2 default null ) as

	cursor crs_objloc is
		select object_id, posx, posy, screen, zindex, nvl(trim(t2.tp_objeto), 'SECTION') as tipo
		from OBJECT_LOCATION t1
		left join objetos t2 on t2.cd_objeto = t1.object_id
		where screen = prm_screen and
		owner = 'DWU' and
		navegador = 'DEFAULT' and
		object_id not in ('toolbar','newquery') and
		(trim(object_id) in (select trim(cd_objeto) from objetos) or object_id like 'SECTION_%')
		order by zindex;

	ws_objloc	crs_objloc%rowtype;

	ws_timer         number;
	ws_count         number := 1;
	ws_micro_data    varchar2(70);
	ws_data_coluna   varchar2(500) := '';
	ws_show_active   varchar2(2);
	ws_tempo         date;
	ws_dispositivo   varchar2(20);
	ws_ipaddr        varchar2(80);
	ws_exist         number;
	ws_slide         varchar2(20);
	ws_usuario       varchar2(80);
	ws_admin         varchar2(80);
	ws_sessao        varchar2(80); 
	ws_token         number := 1;
	ws_id            varchar2(80);
	ws_show          varchar2(20);
	ws_css           varchar2(2000) := ' ';
	ws_css_regular   varchar2(2000) := ' ';
	ws_css_before    varchar2(2000) := ' ';
	ws_owner_bi      varchar2(100);

	ws_notoken       exception;
	ws_nouser        exception;
	ws_sem_acesso	 exception;


begin

		ws_owner_bi := nvl(fun.ret_var('OWNER_BI'),'DWU') ;

		--email
		if prm_clear = 'R' then 
			begin
				select count(*), max(usuario) into ws_count, ws_usuario 
				from bi_token 
				where trim(code)                    = trim(prm_token) 
				and to_char(dt_envio, 'DD/MM/YY') = to_char(sysdate, 'DD/MM/YY') 
				and status                        = 'D';

				if ws_count = 0 then
					raise ws_notoken;
				end if;

				update bi_token
				set status = 'F' 
				where to_char(dt_envio, 'DD/MM/YY') <> to_char(sysdate, 'DD/MM/YY') 
				and usuario = ws_usuario;
				commit;

				select Sys_Context('userenv','sid') into ws_id From dual;
				ws_sessao := 'ANONYMOUS'||ws_id; 

				gbl.setUsuario(ws_sessao, ws_usuario);
				ws_usuario := gbl.getUsuario;
				ws_admin   := 'N';
				ws_show    := gbl.getNivel(ws_usuario);
			end;

		--infoshow/painel
		elsif prm_clear = 'INFO' then 
			begin

				select count(*), max(usuario) into ws_count, ws_usuario from bi_token 
				where trim(code) = trim(prm_token) 
				and status     = 'D';

				if ws_count = 0 then
					raise ws_notoken;
				end if;
				-- Exclui sessões anonimas do usuário abertas a mais de 11 horas (0,458333 dias )
				delete from bi_sessao 
				where valor = ws_usuario 
				and cod like ('ANONYMOUS%')
				-- and dt_acesso <= (sysdate-(1/24)); 
				and dt_acesso <= (sysdate+(0.458333));    
				commit;

				select Sys_Context('userenv','sid') into ws_id From dual;
				ws_sessao := 'ANONYMOUS'||ws_id; 

				gbl.setUsuario(ws_sessao, ws_usuario);  -- Cria sessão para expirar depois de 12 horas (prazo padrão 0.5 dias )
				ws_usuario := gbl.getUsuario;
				ws_admin   := 'N';
				ws_show    := gbl.getNivel(ws_usuario);

			end;

		--slide_show/painel
		elsif prm_clear = 'F' then

			ws_token := 0;

			for i in 1..owa.num_cgi_vars loop
				htp.p(owa.cgi_var_val(i)||'<br>');
				if owa.cgi_var_val(i) = 'AUTHORIZATION' then
					ws_token := owa.cgi_var_val(i);
					--htp.p(owa.cgi_var_val(i));
				end if;
			end loop;

			select count(*) into ws_count from bi_token 
			where trim(upper(usuario)) = trim(upper(user)) 
			and code                 = ws_token 
			and status               = 'S';

			ws_usuario := user;
			ws_admin   := 'N';
			ws_show    := gbl.getNivel(ws_usuario);
			
		else
			ws_usuario := gbl.getUsuario;
			ws_admin   := gbl.getNivel(ws_usuario);
			ws_show    := gbl.getNivel(ws_usuario);
		end if;

		if nvl(ws_usuario, 'NOUSER') = 'NOUSER' then
			raise ws_nouser;
		end if;

		-- Verifica se o usuário tem permissão de acesso a tela, para qualquer tipo de chamada da show_screen 
		if prm_screen <> 'SCR_CUSTOMIZACAO' then 
			if prm_clear not in ('F', 'R', 'INFO') then
				if fun.check_screen_access(prm_screen, ws_usuario, ws_show) = 0 then
					raise ws_sem_acesso;
				end if;
			end if;			
		end if; 	

		-- Chamada realizada direto pela URL sem passar pelo menu do BI 
		if prm_clear = 'F' or prm_clear = 'R' or prm_clear = 'INFO' then

			if ws_count = 0 then
				raise ws_notoken;
			end if;


			htp.p('<html oncontextmenu="donut(event); return false;">');
				htp.p('<head>');

					htp.p('<input type="hidden" id="usuario" value="'||ws_usuario||'" />');
					htp.p('<input type="hidden" id="admin" value="'||ws_admin||'" />');

					fcl.keywords;

					htp.p('<script>const OWNER_BI = "'||ws_owner_bi||'", USUARIO = "'||ws_usuario||'", ADMIN = "'||ws_admin||'", LAYER = document.getElementById(''layer''), MAIN = document.getElementById(''main''), PRINCP = document.getElementById(''princp'');</script>');

					select count(*) into ws_count from objetos where tp_objeto = 'MAPAGEOLOC'; 
					if ws_count > 0 then
						htp.p('<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDkr75GOMHoiIk1Va2KOd6nLaa0nBM35AM&libraries=visualization"></script>');
					end if;

					htp.p('<script src="'				 ||ws_owner_bi||'.fcl.download?arquivo=echarts.5.1.js"></script>');
					htp.p('<link rel="stylesheet" href="'||ws_owner_bi||'.fcl.downloadOpen?arquivo=tema">');
					htp.p('<script src="'				 ||ws_owner_bi||'.fcl.downloadOpen?arquivo=js"></script>');
					htp.p('<link rel="stylesheet" href="'||ws_owner_bi||'.fcl.downloadOpen?arquivo=css">');

					htp.p('<link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet" type="text/css">');
					htp.p('<link href="https://fonts.googleapis.com/css?family=Quicksand" rel="stylesheet" type="text/css">');
					htp.p('<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro&display=swap" rel="stylesheet" type="text/css">'); 
					htp.p('<link rel="stylesheet" href="'||ws_owner_bi||'.fcl.download?arquivo=bro.css">');
				htp.p('</head>');

				htp.p('<body id="princp" class="usuario" onload="chartAnimation = false; chartRenderer = ''canvas''; renderizaGraficos();">');

					htp.p('<a class="info invisible">'||ws_usuario||'</a>');
					htp.p('<div id="extra" class="slide-N">');
						htp.p('<input type="hidden" name="moviment" id="movimento" value="yes" />');
						htp.p('<input type="hidden" name="current_sc" id="current_screen" value="DEFAULT" />');
						htp.p('<input type="hidden" id="usuario" value="'||ws_usuario||'" />');
						htp.p('<input type="hidden" name="clear" id="clear" value="'||prm_clear||'" />');
						htp.p('<input type="hidden" name="ndrobj" id="drill_obj" value="NOC" />');
						htp.p('<input type="hidden" name="ndrtogo" id="drill_go" value="" />');
						htp.p('<input type="hidden" name="ndrobjx" id="drill_x" value="" />');
						htp.p('<input type="hidden" name="ndrobjy" id="drill_y" value="" />');
						htp.p('<input type="hidden" name="ndrshow" id="drill_show" value="" />');
						htp.p('<input type="hidden" name="data-json" id="data-json-C" value="'||fun.r_gif('brasil_completo','JSON')||'" />');
						htp.p('<input type="hidden" name="data-json" id="data-json-E" value="'||fun.r_gif('brazil_geo','JSON')||'" />');
					htp.p('</div>');

					htp.p('<div id="layer">');
						htp.p('<div class="layer-fundo"></div>');
						htp.p('<div class="layer-spin spin5"></div>');
						htp.p('<div class="layer-spin spin4"></div>');
						htp.p('<div class="layer-spin spin3"></div>');
						htp.p('<div class="layer-spin spin2"></div>');
						htp.p('<div class="layer-spin spin1"></div>');
						htp.p('<div class="layer-icon"></div>');
						htp.p('<a title="'||fun.lang('Cancelar')||'" onclick=" try { window.stop(); var layer = document.getElementById(''layer''); layer.children[1].classList.remove(''visivel'');  layer.children[0].classList.remove(''open''); layer.children[2].classList.remove(''open''); alerta(''feed-fixo'', '''||fun.lang('Carregamento dos objetos foi interrompido!')||'''); if(document.getElementById(''layer'').className == ''ativo''){ loading(); } } catch(e){ document.execCommand(''Stop'', false); document.getElementById(''layer'').setAttribute(''class'',''''); } ">X</a>');
					htp.p('</div>');

					htp.p('<div id="donut">');
						ws_count := 0;
						htp.p('<a class="circle" title="'||fun.lang('Sincronizar objetos da tela')||'" onmousedown="shscr('''||prm_screen||''');" ontouchend="shscr(document.getElementById(''current_screen'').value);"><img style="margin-top: 4px;" src="'||fun.r_gif('sinchronize','png')||'" /><span class="texto">SINCRONIZAR</span></a>');
						htp.p('<a class="circle" style="display: none;" title="'||fun.lang('Recarregar sem cache')||'" onmousedown="window.location.reload(true);" ontouchstart="window.location.reload(true);"><img style="margin-top: 5px;" src="'||fun.r_gif('home','png')||'" /><span class="texto">PRINCIPAL</span></a>');
					htp.p('</div>');

					htp.p('<ul id="feed-fixo"></ul>');


					-- Monta o CSS do backgound da SCREEN pra colocar no style do main 
					------------------------------------------------------------------------------
					background_attrib_monta (prm_screen, ws_css); 
					ws_css_regular := substr(ws_css,1,instr(ws_css,'|') - 1);
					ws_css_before  := substr(ws_css,instr(ws_css,'|')+1, length(ws_css) );

					htp.p('<div id="screen-props" style="display: none;">'); 
						htp.p('<style>div#main { '||ws_css_regular||' }  div#main:before { '||ws_css_before||' } </style>'); 
					htp.p('</div>'); 

					-- Quando é executado através da chamada URL (Painel, email, etc), adiciona a tag MAIN 
					htp.p('<div id="main">');


		end if;

		if ws_show = 'S' then
			-- Adicionado background_attrib_monta tbm para o usuário slide
			------------------------------------------------------------------------------
			if prm_screen <> 'DEFAULT' then
				background_attrib_monta (prm_screen, ws_css); 
				ws_css_regular := substr(ws_css,1,instr(ws_css,'|') - 1);
				ws_css_before  := substr(ws_css,instr(ws_css,'|')+1, length(ws_css) );
				htp.p('<style>div#main { '||ws_css_regular||' }  div#main:before { '||ws_css_before||' } </style>'); 
			end if;

		end if;

		if fun.getprop(prm_screen, 'MANUTENCAO') = 'S' then
			htp.p('<h3 class="maintenance">EM MANUTEN&Ccedil;&Atilde;O</h3>');
		end if;

		if fun.getprop(prm_screen, 'ATUALIZANDO') = 'S' then
			htp.p('<h3 class="updating" title="os dados desta tela est&atilde;o sendo atualizados!">!</h3>');
		end if;


		ws_tempo := sysdate;

		if length(prm_parametro) > 0 and (length(prm_screen_ant) > 0 or prm_clear = 'R') then
				
				delete from FLOAT_FILTER_ITEM FLIT
				where FLIT.CD_COLUNA IN (SELECT DISTINCT CD_COLUNA FROM TABLE(fun.VPIPE_PAR(prm_parametro))) and
				screen=prm_screen and cd_usuario = ws_usuario;
				
				insert into FLOAT_FILTER_ITEM 
				select ws_usuario, prm_screen, cd_coluna, cd_conteudo
				from (SELECT CD_COLUNA, MAX(CD_CONTEUDO) AS CD_CONTEUDO FROM  (TABLE(fun.VPIPE_PAR(prm_parametro)))  GROUP BY CD_COLUNA)
				where cd_coluna in (SELECT DISTINCT CD_COLUNA FROM TABLE(fun.VPIPE_PAR(prm_parametro)) GROUP BY CD_COLUNA) AND
				CD_COLUNA IN (SELECT replace(OBJECT_ID,'_FILTER','') AS CD_COLUNA FROM OBJECT_LOCATION where SCREEN=prm_screen AND (SELECT TP_OBJETO FROM OBJETOS WHERE CD_OBJETO=OBJECT_ID)='FLOAT_FILTER');
				
				commit;

		end if;

		ws_count := 0; 
	
		if prm_screen = 'SCR_CUSTOMIZACAO' then 
		fcl.conteudoCustomizado; 
		else
			open crs_objloc;
			loop
				fetch crs_objloc into ws_objloc;
				exit when crs_objloc%notfound;

				ws_count := ws_count+1;

				if prm_tipo = 'MENU' then
					if ws_objloc.tipo = 'CALL_LIST' then
						obj.show_objeto(ws_objloc.object_id, ws_objloc.posx, ws_objloc.posy, prm_screen => prm_screen, prm_usuario => ws_usuario, prm_admin => ws_admin);
					end if;
				elsif prm_tipo = 'FLOAT' or prm_tipo = 'FLOAT_FILTER' then
					if ws_objloc.tipo = 'FLOAT_PAR' or ws_objloc.tipo = 'FLOAT_FILTER' then
						obj.show_objeto(ws_objloc.object_id, ws_objloc.posx, ws_objloc.posy, prm_screen => prm_screen, prm_usuario => ws_usuario, prm_admin => ws_admin);
					end if;
				else
					if ws_objloc.tipo <> 'CALL_LIST' and ws_objloc.tipo <> 'FLOAT_PAR' and ws_objloc.tipo <> 'FLOAT_FILTER' then
						obj.show_objeto(ws_objloc.object_id, ws_objloc.posx, ws_objloc.posy, prm_screen => prm_screen, prm_zindex => ws_objloc.zindex, prm_usuario => ws_usuario, prm_admin => ws_admin);
					end if;
				end if;
			end loop;
			close crs_objloc;
		end if;	


		select nvl(show_only, 'N') into ws_show_active from usuarios where trim(usu_nome) = ws_usuario;

		if prm_clear NOT IN ('INFO','F','R') then
			if prm_refresh = 'N' and ws_show_active <> 'S' and nvl(prm_tipo, 'MAIN') = 'MAIN' then
				insert into log_eventos values(sysdate, 'accesso: ['||prm_screen||']', ws_usuario, 'TELA', 'ACESSO', '01');
			end if;
		end if;

		if prm_clear = 'F' or prm_clear = 'R' or prm_clear = 'INFO' then 

						htp.p('<ul style="display: none;" id="alerta-template"><li onclick="var template = this; template.classList.remove(''show''); setTimeout(function(){ template.parentNode.removeChild(template); }, 300);"></li></ul>');
					htp.p('</div>');   -- Fecha a div MAIN
				htp.p('</body>');      
			htp.p('</html>');
		end if;	

		-- Quando a show_screen é chamada direto do navegador pela URL tem que executar a icarrega por aqui, quando é chamado pelo BI a icarrega já é executada pela shscr() do JS - 09/02/2022
		if prm_clear in ('INFO','R') then 
			htp.p('<script>icarrega('''||prm_screen||''');</script>');
		end if; 
		
		/****** Retirado essa exclusão, estava derrubando o sistema antes de montar o objeto gráfico de PIZZA 
		if prm_clear IN ('INFO','R') then 
			-- Se for abertura de tela pelo Tvconex ou email, Exclui a sessão atual depois de montar e abrir a tela	
			delete from bi_sessao 
			where valor = ws_usuario 
			and cod   = ws_sessao; 
			commit;
		end if;
		********************************/

exception 
	when ws_notoken then
		htp.p(fun.pagina_html_aviso('Sem permiss&atilde;o de acesso a tela, precisa de um token v&aacute;lido!')); 
		gbl.setUsuario(prm_token);
		insert into bi_log_sistema values (sysdate, 'Tentativa de acesso direta sem token', user, 'EVENTO');
	when ws_nouser then
		gbl.setUsuario(prm_token);
		gbl.setUsuario('ANONYMOUS'||ws_id);
		htp.p(fun.pagina_html_aviso('Sess&atilde;o finalizada por inatividade'));
	when ws_sem_acesso then
		--gbl.setUsuario(prm_token);
		--gbl.setUsuario('ANONYMOUS'||ws_id);
		htp.p(fun.pagina_html_aviso('Usu&aacute;rio sem permiss&atilde;o de acesso a tela!'));
	when others then
		if gbl.getUsuario = 'NOUSER' then
			htp.p('LOGOUT');
		end if;
		htp.p(fun.pagina_html_aviso('Erro na abertura da tela [show_screen]'||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE));
end show_screen;

/* Clear Screen */

procedure load_external( prm_screen varchar2 default null ) as

ws_url varchar2(100);

begin
	select nvl(replace(url_fundo, 'EXT=', ''), '') into ws_url from all_screens where screen = prm_screen and url_fundo like ('EXT=%') and rownum = 1;
	htp.p(ws_url);
exception when others then
	htp.p('');
end load_external;

procedure clear_screen( prm_screen  char default 'DEFAULT',
						prm_nscreen char default null,
						prm_visao   char default 'N' ) as

	cursor crs_objloc is
		select * from OBJECT_LOCATION where screen = prm_screen and owner = 'DWU' and navegador = 'DEFAULT' and object_id not in ('toolbar','newquery');

	ws_objloc	crs_objloc%rowtype;

begin

	htp.p('<script>');

		if prm_visao='S' then
			htp.p('if  (parent.document.getElementById(''lockp'').value==''SIM'') {  ');
			htp.p('parent.document.getElementById(''lockp'').value=''NAO'';');
		end if;

		open crs_objloc;
		loop
			fetch crs_objloc into ws_objloc;
				exit when crs_objloc%notfound;

			htp.p('var delfit=parent.document.getElementById("'||ws_objloc.object_id||'"); ');
			htp.p('if(delfit){ delfit.parentNode.removeChild(delfit); }');

		end loop;
		close crs_objloc;

		if prm_visao = 'S' then
			htp.p(' parent.document.getElementById(''current_screen'').value='||chr(39)||prm_nscreen||chr(39)||';');
			htp.p(' window.parent.apscreen('''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.show_screen?prm_screen='||prm_nscreen||chr(39)||','||chr(39)||upper(replace(trim(prm_nscreen),' ','_'))||chr(39)||'); } ');
		end if;

	htp.p('</script>');
exception when others then
	htp.p(sqlerrm);
end clear_screen;

--!!

procedure inserir_objeto_ant (	prm_article     varchar2 default null, 
								prm_section     varchar2 default 'DEFAULT', 
								prm_pos_atual 	varchar2 default 'DEFAULT', 
								prm_posx   		varchar2 default '0',
								prm_pos_ant     varchar2 default null) as


	ws_count   				number;
	ws_counter 				number;
	ws_usuario 				varchar2(80);
	ws_id      				varchar2(600);
	ws_subid   				varchar2(600);
	ws_bgcolor_section		varchar2(80);
	ws_pos_ant 				varchar2(80);

	ws_nouser  				exception;
	
begin

	ws_pos_ant := prm_pos_ant;
	ws_usuario := gbl.getUsuario;

	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if;
		
	if instr(prm_article, 'SECTION') = 0 then
		
		select 'ARTICLE_'||trim((Select Sid From V$session Where Audsid = Sys_Context('userenv','sessionid'))||(Select Serial# From V$session Where Audsid = Sys_Context('userenv','sessionid'))||to_char(sysdate,'yymmddhhmiss')) into ws_id from dual;
		select count(*) into ws_count from object_location where object_id = ws_id and screen = prm_section;
		if ws_count = 0 then
			select count(*) into ws_count from object_location where screen = prm_section and object_id like 'ARTICLE%';
 			
			ws_count := ws_pos_ant;
			
			/* ws_count := ws_pos_ant||'   '; */

			update object_location
			set posx = posx + 1
			where screen = prm_section 
			and posx >= ws_count
			and object_id like 'ARTICLE%';

			insert into OBJECT_LOCATION (OWNER, NAVEGADOR, SCREEN, OBJECT_ID, POSY, POSX, ZINDEX, PORCENTAGEM) values 
			('DWU', 'DEFAULT', prm_section, ws_id, 'inherit', ws_count, 'column', '100%');

			commit;

			fcl.monta_article(ws_id, prm_section, nvl(ws_count, 1));

		end if;

	end if;


exception 
	when ws_nouser then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end inserir_objeto_ant;

procedure inserir_objeto (	prm_objeto     varchar2 default null, 
							prm_screen     varchar2 default 'DEFAULT', 
							prm_screen_ant varchar2 default 'DEFAULT' ) as

	ws_erro			exception;

	cursor crs_objloc is
		select * from OBJECT_LOCATION 
		where screen 	 = prm_screen_ant 
		and owner 	 = 'DWU' 
		and navegador = 'DEFAULT' 
		and object_id not in ('toolbar','newquery');

	ws_objloc	crs_objloc%rowtype;

	ws_count   				number;
	ws_counter 				number;
	ws_usuario 				varchar2(80);
	ws_id      				varchar2(600);
	ws_subid   				varchar2(600);
	ws_bgcolor_section		varchar2(80);

	ws_nouser  				exception;
	
begin

	ws_usuario := gbl.getUsuario;

	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if;

	ws_count := 0;
	if  prm_screen = 'SHOWSCREEN' then
		open crs_objloc;
			loop
				fetch crs_objloc into ws_objloc;
				exit when crs_objloc%notfound;
			end loop;
		close crs_objloc;
	else
		
		if instr(prm_objeto, 'SECTION') = 0 then
			if instr(prm_objeto, 'ARTICLE') = 0 then
				
				select count(*) into ws_count
				from object_location 
				where object_id = prm_objeto 
				and screen    = prm_screen;

				htp.p(ws_count);
				if ws_count = 0 then
					select count(*)+1 into ws_count
					from object_location 
					where screen = prm_screen;

					insert into OBJECT_LOCATION (OWNER, NAVEGADOR, SCREEN, OBJECT_ID, POSY, POSX, ZINDEX, PORCENTAGEM) values 
					('DWU', 'DEFAULT', prm_screen, prm_objeto, '100px', ws_count, '2', '0');
					commit;
				end if;
			else

				select 'ARTICLE_'||trim((Select Sid From V$session Where Audsid = Sys_Context('userenv','sessionid'))||(Select Serial# From V$session Where Audsid = Sys_Context('userenv','sessionid'))||to_char(sysdate,'yymmddhhmiss')) into ws_id from dual;
				select count(*) into ws_count from object_location where object_id = ws_id and screen = prm_screen;
				if ws_count = 0 then
					select count(*) into ws_count from object_location where screen = prm_screen and object_id like 'ARTICLE%';
					ws_count := ws_count+1;
					insert into OBJECT_LOCATION (OWNER, NAVEGADOR, SCREEN, OBJECT_ID, POSY, POSX, ZINDEX, PORCENTAGEM) values 
					('DWU', 'DEFAULT', prm_screen, ws_id, 'inherit', ws_count, 'column', '100%');
					commit;

					fcl.monta_article(ws_id, prm_screen, nvl(ws_count, 1));

				end if;
			end if;
		else
			select 'SECTION_'||trim((Select Sid From V$session Where Audsid = Sys_Context('userenv','sessionid'))||(Select Serial# From V$session Where Audsid = Sys_Context('userenv','sessionid'))||to_char(sysdate,'yymmddhhmiss')) into ws_id from dual;
			select count(*) into ws_count from object_location where object_id = ws_id and screen = prm_screen;
			if ws_count = 0 then
				select count(*) into ws_count from object_location where screen = prm_screen and object_id like 'SECTION_%';
				insert into OBJECT_LOCATION (OWNER, NAVEGADOR, SCREEN, OBJECT_ID, POSY, POSX, ZINDEX, PORCENTAGEM) values ('DWU', 'DEFAULT', prm_screen, ws_id, 'center', ws_count+1, 'row', '0');
				commit; 
				
				ws_bgcolor_section:=nvl(fun.getprop(ws_id,'BGCOLOR_SECTION'),'TRANSPARENT');

				htp.p('<section class=""  id="'||ws_id||'" style="background:'||ws_bgcolor_section||'; flex-wrap: wrap; order: 1; flex-direction: column;">');
					
					execute immediate 'begin obj.section_submenu (:prm_objeto, :prm_screen, :prm_zindex); end;' using ws_id, prm_screen, 'column';

					/****************
					htp.p('<div class="submenu" onmousedown="event.stopPropagation();">');
						htp.p('<a class="adddash" title="'||fun.lang('adicionar bloco')||'" onclick="dashboard('''', ''insert'', '''||ws_id||''');">+</a>');
						
						htp.p('<select onchange="dashboard(document.getElementById(''current_screen'').value, ''rowcolumn'', '''||ws_id||''',  this.value);">');
							htp.p('<optgroup label="Formato"></optgroup>');
							htp.p('<option value="row" selected>'||fun.lang('Horizontal')||'</option>');
							htp.p('<option value="column">'||fun.lang('Vertical')||'</option>');
						htp.p('</select>');

						htp.p('<input style="left:4px; width:60px;"  title="Cor do Fundo" onkeypress="if(event.which == ''13''){ this.blur(); }" onblur="dashboard('''||prm_screen||''', ''background_section'', '''||ws_id||''', this.value);" value="'||ws_bgcolor_section||'" >');	

						htp.p(fun.excluir_dash(ws_id));

					htp.p('</div>');
					************************/ 
					
					select 'ARTICLE_'||trim((Select Sid From V$session Where Audsid = Sys_Context('userenv','sessionid'))||(Select Serial# From V$session Where Audsid = Sys_Context('userenv','sessionid'))||to_char(sysdate,'yymmddhhmiss')) into ws_subid from dual;
					insert into object_location (owner, navegador, screen, object_id, posy, posx, zindex, porcentagem) values ('DWU', 'DEFAULT', ws_id, ws_subid||'1', 'inherit', 1, 'column', '100%');
					insert into object_location (owner, navegador, screen, object_id, posy, posx, zindex, porcentagem) values ('DWU', 'DEFAULT', ws_id, ws_subid||'2', 'inherit', 2, 'column', '100%');
					commit;
					fcl.monta_article(ws_subid||'1', ws_id, 1);
					fcl.monta_article(ws_subid||'2', ws_id, 2);

				htp.p('</section>');
			end if;
		end if;
		commit;
	end if;

exception 
	when ws_nouser then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end inserir_objeto;


procedure monta_article ( prm_id      varchar2 default null,
						prm_section varchar2 default null, 
						prm_count   number   default 1    ) as

	ws_bgColor_article		varchar2(80);

begin

	ws_bgColor_article:=nvl(fun.getprop(prm_id,'BGCOLOR_ARTICLE'),'TRANSPARENT');

	htp.p('<article id="'||prm_id||'" style="background:'||ws_bgColor_article||'; justify-content: inherit; align-items: inherit; flex-direction: column; order: '||nvl(prm_count, 1)||'; flex-basis: calc(100% - 6.4px);">');
		
		if gbl.getNivel = 'A' then

			htp.p('<div class="articlemenu" onmousedown="event.stopPropagation();">');
				htp.p(fun.excluir_dash(prm_id));
				
				htp.p('<select onchange="dashboard('''||prm_section||''', ''align'', '''||prm_id||''', this.value);">');
					htp.p('<optgroup label="Alinhamento"></optgroup>');
						htp.p('<option value="flex-start">'||fun.lang('Esquerda')||'</option>');
						htp.p('<option value="flex-end">'||fun.lang('Direita')||'</option>');
						htp.p('<option value="center">'||fun.lang('Centro')||'</option>');
						htp.p('<option value="inherit" selected>'||fun.lang('Todo')||'</option>');
				htp.p('</select>');

				htp.p('<select onchange="dashboard('''||prm_section||''', ''rowcolumn'', '''||prm_id||''', this.value);">');
					htp.p('<optgroup label="Formato"></optgroup>');
						htp.p('<option value="row">'||fun.lang('Horizontal')||'</option>');
						htp.p('<option value="column" selected>'||fun.lang('Vertical')||'</option>');
				htp.p('</select>');

				htp.p('<input style="left:52px; width:60px;"  title="Cor do Fundo" onkeypress="if(event.which == ''13''){ this.blur(); }" onblur="dashboard('''||prm_section||''', ''background_article'', '''||prm_id||''', this.value);" value="'||ws_bgColor_article||'" >');	

				htp.p('<input id="'||prm_id||'ordem" onblur="dashboard('''||prm_section||''', ''ordem'', '''||prm_id||''', this.value);" value="'||nvl(prm_count, 1)||'" placeholder="'||fun.lang('ordem')||'" title="'||fun.lang('ORDEM')||'">');

				htp.p('<input onblur="dashboard('''||prm_section||''', ''porcentagem'', '''||prm_id||''', this.value);" value="100%" placeholder="'||fun.lang('medida')||'" title="'||fun.lang('MEDIDA')||'">');
				
				htp.p('<img title="'||fun.lang('Inserir objeto')||'" src="'||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download?arquivo=folder.png" onclick="closeSideBar(''attriblist''); document.getElementById(''attriblist'').classList.toggle(''open''); ajax(''list'', ''lista_objetos'', '''', false, ''attriblist'');">');
				htp.p('<a class="adddash" title="'||fun.lang('adicionar bloco')||'" onclick="dashboard('''', ''insertnv1'', '''||prm_section||''');">+</a>');
			htp.p('</div>');
		end if;

	htp.p('</article>');

end monta_article;

procedure call_insert ( prm_objeto varchar2 default null,
						prm_screen varchar2 default null ) as

begin
	insert into OBJECT_LOCATION (OWNER, NAVEGADOR, SCREEN, OBJECT_ID, POSY, POSX, ZINDEX, PORCENTAGEM) values ('DWU', 'DEFAULT', prm_screen, prm_objeto, '100px', '100px', '2', '0');                
end;


procedure save_points (	prm_objeto 	IN owa_util.ident_arr,
						prm_posx	IN owa_util.ident_arr,
						prm_posy	IN owa_util.ident_arr,
						prm_screen	char default 'DEFAULT') as

	ws_count	number;

begin
	/*fcl.refresh_Session;*/
	for i in prm_objeto.FIRST..prm_objeto.LAST loop
		select count(*) into ws_count
		from   OBJECT_LOCATION
		where  owner = fun.WHO and
		navegador = 'DEFAULT' and
		screen    = prm_screen and
		object_id = trim(prm_objeto(i));

		if  ws_count < 2 then
		
			if  ws_count = 1 then
			update OBJECT_LOCATION set posx = replace(trim(prm_posx(i)),'-',''), posy = replace(trim(prm_posy(i)),'-','')
			where  owner = fun.WHO and
			navegador = 'DEFAULT' and
			screen    = prm_screen and
			object_id = trim(prm_objeto(i));
			commit;
			else
			insert into OBJECT_ATTRIB values ('DWU', 'DEFAULT', prm_screen, prm_objeto(i), replace(trim(prm_posx(i)),'-',''), replace(trim(prm_posy(i)),'-',''));
			commit;
			end if;
		end if;
	end loop;

exception when others then
	htp.p(sqlerrm);
end save_points;


/* Salva Dados */


procedure save_prop ( prm_prop        varchar2 default null,
					prm_valor       varchar2 default null,
					prm_objeto	  varchar2 default null,
					prm_url_default varchar2 default null,
					prm_screen	  varchar2 default 'DEFAULT') as

	ws_count	   number;
	ws_posx		   varchar2(300);
	ws_posy		   varchar2(300);
	tipo           varchar2(300);
	altura         varchar2(60);
	largura        varchar2(60);
	ws_exist	   number;
	ws_converte    varchar2(800);
	ws_usuario	   varchar2(500);
	ws_screen      varchar2(200); 
	ws_count_valor Number;
begin
	ws_usuario:= gbl.getUsuario;
	ws_converte := fun.converte(prm_valor);

	if instr(prm_prop, 'ORDEM') > 0 or instr(prm_prop, 'DASH_MARGIN') > 0 then
		ws_screen := prm_screen;
	else 
		ws_screen := 'DEFAULT';	
	end if;
	--
	update OBJECT_ATTRIB set propriedade = ws_converte
	where owner = 'DWU' and
			navegador = 'DEFAULT' and
			cd_object = prm_objeto and
			cd_prop   = prm_prop and 
			screen 	  = ws_screen;
	if sql%notfound then 
		insert into OBJECT_ATTRIB values ('DWU', 'DEFAULT', ws_screen, trim(prm_objeto), prm_prop, ws_converte);
	end if; 
	--
	if instr(prm_prop, 'ORDEM') > 0 then 
		update OBJECT_ATTRIB set propriedade = ws_converte
		where owner = ws_usuario and
				navegador = 'DEFAULT' and
				cd_object = prm_objeto and
				cd_prop   = prm_prop and 
				screen 	  = ws_screen;
		if sql%notfound then 
			insert into OBJECT_ATTRIB values (ws_usuario, 'DEFAULT', ws_screen, trim(prm_objeto), prm_prop, ws_converte);
		end if; 			
	end if; 
	--
	if instr(prm_prop, 'VALOR_DEFAULT') > 0 then
		select count(*) into ws_count_valor from parametro_usuario where  cd_usuario = 'DWU' and cd_padrao = prm_objeto;
		
		if ws_count_valor > 0 then
			update parametro_usuario
			set conteudo=ws_converte
			where cd_usuario = 'DWU'
			and cd_padrao  = prm_objeto;
		else
			insert into parametro_usuario values ('DWU',prm_objeto,ws_converte,null);
		end if;
		
	end if;
	--
	if instr(prm_prop, 'TOP') > 0 then 
		update OBJECT_ATTRIB set propriedade = upper(ws_converte)
		where 	owner 	  = 'DWU' and
				navegador = 'DEFAULT' and
				cd_object = prm_objeto and
				cd_prop   = prm_prop and 
				screen 	  = ws_screen;
		if sql%notfound then 
			insert into OBJECT_ATTRIB values ('DWU', 'DEFAULT', ws_screen, trim(prm_objeto), prm_prop, upper(ws_converte));
		end if; 			
	end if; 
	
	if (((instr(prm_prop, 'AMOSTRA') > 0 and ws_converte <> '0') or (instr(prm_prop, 'TOP') > 0) and ws_converte <> '0')) and (fun.getprop(prm_objeto,'TP_GRUPO') = 'ROLL') then
		htp.p('#aviso_prop Aten&ccedil;&atilde;o ... N&atilde;o &eacute; recomendado o uso desse atributo juntamente com o atributo AGRUPAMENTO ROLLUP');
	end if;
	--

	commit;

exception 
	when others then
		htp.p('#alert '||sqlerrm);
end save_prop;


procedure save_pa (	prm_objeto		char default null,
					prm_url_default char default null,
					prm_screen		char default 'DEFAULT') as

	ws_count	number;
	ws_posx		varchar2(200);
	ws_posy		varchar2(200);

begin
	/*fcl.refresh_Session;*/
	htp.htmlOpen;
	htp.bodyOpen;

	htp.p('<script> appendar('||chr(39)||''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.obj.show_objeto?prm_objeto='||prm_objeto||'&prm_posx='||ws_posx||'&prm_posy='||ws_posy||'&PRM_ZINDEX=''); </script>');

	htp.bodyClose;
	htp.htmlClose;

exception when others then
	htp.p(sqlerrm);
end save_pa;

procedure save_par ( y IN    owa_util.ident_arr,
					x IN    owa_util.ident_arr,
					ws_type varchar2 default 'NOSUB') as

	ws_count	number;
	ws_conteudo varchar2(40);
	ws_usuario  varchar2(80);

begin

	ws_usuario := gbl.getUsuario;

	for i in x.FIRST..x.LAST
	loop
		select count(*) into ws_count
		from   PARAMETRO_USUARIO
		where  cd_usuario = ws_usuario and
		cd_padrao =  trim(y(i));

		ws_conteudo := replace(x(i), '-SET-', '-SEP-');

		if  ws_count < 2 then
			if  ws_count = 1 then
				update PARAMETRO_USUARIO set conteudo = trim(ws_conteudo)
				where cd_usuario = ws_usuario and
				cd_padrao =  trim(y(i));
				commit;
			else
				insert into PARAMETRO_USUARIO values (ws_usuario, trim(y(i)), trim(x(i)) , '');
				commit;
			end if;
		end if;
	end loop;

exception when others then
	htp.p(sqlerrm);
end save_par;

--!!
procedure save_float (	prm_conteudo varchar2 default null,
						prm_padrao   varchar2 default null,
						prm_screen   varchar2 default null ) as

	ws_count     	number;
	ws_countrow  	number;
	ws_converte  	varchar2(800);
	ws_usuario   	varchar2(80);
	ws_tp_padrao 	varchar2(80);
	ws_propriedade 	varchar2(4000);

	ws_nouser   exception;
	ws_fail     exception;

begin

	ws_usuario  := gbl.getUsuario;

	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if;

	/*if gbl.getNivel = 'A' then
		ws_usuario := 'DWU';
	end if;*/

	ws_converte := fun.converte(prm_conteudo);



	-- Se for tipo DATA com calendário, converte de português para Inglês, porque no banco está com formato de data inglês 
	select nvl(max(tp_padrao),'NA') into ws_tp_padrao from parametro_padrao WHERE CD_PADRAO = prm_padrao;
	if ws_tp_padrao = 'DATA' then  
		ws_converte := replace(replace(replace(replace(replace(replace(replace(ws_converte,'-Fev-','-Feb-'),'-Abr-','-Apr-'),'-Mai-','-May-'),'-Ago-','-Aug-'),'-Set-','-Sep-'),'-Out-','-Oct-'),'-Dez-','-Dec-');
	end if; 

	delete from parametro_usuario where cd_usuario = ws_usuario and cd_padrao = prm_padrao;

	--excluindo os encadeados
	delete from float_filter_item where trim(upper(fun.getprop(trim(upper(cd_coluna)), 'ENCADEADO'))) = trim(upper(prm_padrao)) and cd_usuario = ws_usuario;
	delete from parametro_usuario where trim(upper(fun.getprop(trim(upper(cd_padrao)), 'ENCADEADO'))) = trim(upper(prm_padrao)) and cd_usuario = ws_usuario;


/* for i in(select column_value from table (fun.vpipe(ws_converte))) loop
		insert into parametro_usuario (cd_usuario, cd_padrao, conteudo, pre_load) values (user, prm_padrao, i.column_value, '');
	end loop;*/



	if nvl(trim(prm_conteudo), 'N/A') <> 'N/A' then
		insert into parametro_usuario (cd_usuario, cd_padrao, conteudo, pre_load)
		select ws_usuario, prm_padrao, column_value, '' from table (fun.vpipe(ws_converte));

		
		ws_countrow := SQL%ROWCOUNT;
		
		if ws_countrow <> 0 then
			commit;
			--reset da ordem do usuário ao alterar o filtro quando a consulta é pivotada

			for i in ( select t1.* 
    	     	         from object_attrib t1 
					    where owner   = ws_usuario
						  and screen  = prm_screen 
					      and cd_prop = 'ORDEM' 
						  and exists (select 1 from ponto_avaliacao where cd_ponto = fun.get_cd_obj(t1.cd_object) and length(cs_colup) > 0)  -- tem pivot 
				      	  and nvl(fun.getprop(fun.get_cd_obj(t1.cd_object),'RESTOREORDER'),'N') = 'S' 
						) loop

				--ws_propriedade:= fun.getprop(i.cd_object,'ORDEM',i.screen,'DWU','CONSULTA');
				delete object_attrib 
				 where cd_prop   	= 'ORDEM'
				   and cd_object 	= i.cd_object
				   and screen    	= i.screen
				   and owner     	= i.owner;
		  
			end loop;
			commit;			
	
		else
			raise ws_fail;
		end if;

	end if;

exception 
	when ws_nouser then
		htp.p('Sem permiss&atilde;o!');
	when ws_fail then
		rollback;
		insert into bi_log_sistema (dt_log, ds_log, nm_usuario, nm_procedure ) values (sysdate, 'Erro save_float 1: Erro montando filtro.', ws_usuario, 'ERRO');
		commit;			
		htp.p('FAIL|Erro gravando filtro');
	when others  then
		rollback;
		insert into bi_log_sistema (dt_log, ds_log, nm_usuario, nm_procedure ) values (sysdate, 'Erro save_float 2:'||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, ws_usuario, 'ERRO');
		commit;			
		htp.p('FAIL|Erro gravando filtro');
end save_float;

--!!
procedure save_float_filter ( prm_conteudo varchar2 default null,
							prm_coluna varchar2 default null,
							prm_screen varchar2 default null ) as

	ws_count    	number;
	ws_countrow 	number;
	ws_usuario  	varchar2(80);
	ws_converte 	varchar2(32000);
	ws_qt_filtro    number; 
	ws_propriedade 	varchar2(4000);
	ws_tp_padrao    varchar2(1000);
	
	ws_nouser         exception;
	ws_fail           exception;
	ws_excesso_filtro exception;
	
begin

	ws_usuario := gbl.getUsuario;

	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if;

	ws_converte  := fun.converte(prm_conteudo);
	ws_qt_filtro := length(ws_converte) - length(replace(ws_converte, '|')) ;
	
	if ws_qt_filtro > 1000 then   -- o comando IN do WHERE não aceita mais de 1000 itens 
		raise ws_excesso_filtro; 
	end if; 

	delete from float_filter_item where screen = prm_screen and cd_coluna = replace(prm_coluna, '_FILTER', '') and cd_usuario = ws_usuario;
	
	select nvl(max(tp_padrao),'NA') into ws_tp_padrao from parametro_padrao WHERE CD_PADRAO = prm_coluna;
	if ws_tp_padrao = 'DATA' then  
		ws_converte := replace(replace(replace(replace(replace(replace(replace(ws_converte,'-Fev-','-Feb-'),'-Abr-','-Apr-'),'-Mai-','-May-'),'-Ago-','-Aug-'),'-Set-','-Sep-'),'-Out-','-Oct-'),'-Dez-','-Dec-');
	end if; 
		
	if length(ws_converte) > 0 and ws_converte <> 'TODOS' then
		insert into float_filter_item (cd_usuario, screen, cd_coluna, conteudo )
		select ws_usuario, prm_screen, replace(prm_coluna, '_FILTER', ''), nvl(column_value, 'n/a') 
			from table(fun.vpipe(ws_converte)) 
		where nvl(column_value, 'n/a') <> 'n/a';
	end if;
		
	ws_countrow := SQL%ROWCOUNT;
	
	if ws_countrow <> 0 then
		commit;
		--reset da ordem do usuário ao alterar o filtro quando a consulta é pivotada
		for i in ( select t1.* 
         	         from object_attrib t1 
				    where owner   = ws_usuario 
					  and screen  = prm_screen
				      and cd_prop = 'ORDEM' 
				      and exists (select 1 from ponto_avaliacao where cd_ponto = fun.get_cd_obj(t1.cd_object) and length(cs_colup) > 0)  -- tem pivot 
				      and nvl(fun.getprop(fun.get_cd_obj(t1.cd_object),'RESTOREORDER'),'N') = 'S' 
					) loop

			delete object_attrib 
				where cd_prop  	= 'ORDEM'
				and cd_object 	= i.cd_object
				and screen    	= i.screen
				and owner     	= i.owner;
		  
		end loop;
		
		commit;
	else

		if length(ws_converte) > 0 then 
			raise ws_fail;
		end if; 

	end if;		

exception 
	when ws_nouser then
		htp.p('Sem permiss&atilde;o!');
	when ws_excesso_filtro then
		htp.p('FAIL|Erro gravando filtro, n&atilde;o &eacute; poss&iacute;vel selecionar mais de 1000 itens, foram selecionados '||ws_qt_filtro||' itens');
	when ws_fail then
		rollback;
		insert into bi_log_sistema (dt_log, ds_log, nm_usuario, nm_procedure ) values (sysdate, 'Erro save_float_filter 1: Erro montando filtro.', ws_usuario, 'ERRO');
		commit;			
		htp.p('FAIL|Erro gravando filtro, tente selecionar menos itens ou entre em contato com o administrador do sistema');
	when others  then
		rollback;
		insert into bi_log_sistema (dt_log, ds_log, nm_usuario, nm_procedure ) values (sysdate, 'Erro save_float_filter 2:'||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, ws_usuario, 'ERRO');
		commit;			
		htp.p('FAIL|Erro gravando filtro, tente selecionar menos itens ou entre em contato com o administrador do sistema');
end save_float_filter;


procedure savemv (  p_funcao varchar2 default null,
					p_nm_micro_visao	varchar2 default null,
					p_nm_tabela varchar2 default null,
					p_ds_micro_visao	varchar2 default null,
					p_cd_grupo_funcao varchar2 default null ) as

	ws_count number;

begin
	/*fcl.refresh_Session;*/
	if  p_funcao = 'G' then
		select count(*) into ws_count from micro_visao where nm_micro_visao = upper(p_nm_micro_visao);
		if ws_count = 0 then
			insert into MICRO_VISAO
			( nm_micro_visao, nm_tabela, ds_micro_visao, cd_grupo_funcao , dt_ultima_alteracao, cd_usuario )
			values
			( upper(p_nm_micro_visao), p_nm_tabela, p_ds_micro_visao, p_cd_grupo_funcao, sysdate, 'DWU' );
			commit;
		else
			htp.p('#alert '||fun.lang('Micro vis&atilde;o j&aacute; existe')||'!');
		end if;
	else
		select count(*) into ws_count from micro_visao where nm_micro_visao = upper(p_nm_micro_visao);
		if ws_count = 1 then
			update MICRO_VISAO set
			nm_micro_visao  = upper(rtrim(p_nm_micro_visao)),
			nm_tabela       = rtrim(p_nm_tabela),
			ds_micro_visao  = p_ds_micro_visao,
			cd_grupo_funcao = rtrim(p_cd_grupo_funcao),
			dt_ultima_alteracao = sysdate
			where  nm_micro_visao = p_nm_micro_visao;
			commit;
		else
			htp.p('#alert '||fun.lang('Imposs&iacute;vel alterar micro vis&atilde;o, valor duplicado')||'!');
		end if;
	end if;

end savemv;

procedure goto_insert ( prm_objeto	varchar2 default null,
				        prm_go      varchar2 default null) as

	ws_usuario      varchar2(100); 
	ws_cd_goto		number;
	ws_tipo   		varchar2(4000);
	ws_nome   		varchar2(4000);
	ws_visao  		varchar2(4000);
	ws_erro         varchar2(200); 
	ws_cs_coluna    ponto_avaliacao%rowtype;
	ws_cs_agrupador ponto_avaliacao%rowtype;
	ws_cs_colup     ponto_avaliacao%rowtype;
	ws_raise_erro   exception ; 

begin
	
	ws_usuario := GBL.getUsuario();

	if nvl(prm_go, 'N/A') = 'N/A' then
		ws_erro := 'Selecione ao menos um objeto como Drill'; 
		raise ws_raise_erro; 
	end if; 	

	if not(fun.check_admin('DRILLS_ADD')) then
		ws_erro := 'Sem permiss&atilde;o para cria&ccedil;&atilde;o de drills'; 
		raise ws_raise_erro; 
	end if; 

	for i in(select column_value from table((fun.vpipe(prm_go)))) loop
		--select max(cs_coluna), max(cs_agrupador), max(cs_colup) 
		--  into ws_cs_coluna, ws_cs_agrupador, ws_cs_colup
		--  from ponto_avaliacao a
        -- where cd_ponto = i.column_value;
		select max(cd_goto_objeto)+1 into ws_cd_goto from GOTO_OBJETO; 
		insert into GOTO_OBJETO (cd_usuario, cd_objeto, cd_objeto_go, cd_goto_objeto )
		                 values ('DWU', prm_objeto, i.column_value, ws_cd_goto );
	end loop;
	commit;

	htp.p('OK');
			
exception 
	when ws_raise_erro then 
		htp.p('ERRO|'||fun.lang(ws_erro));
	when others then
		rollback;
		htp.p('ERRO|'||fun.lang('Erro ao adicionar drills, verifique o log de erros do sistema.'));
		insert into bi_log_sistema values (sysdate, 'GOTO_INSERT: '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, ws_usuario, 'ERRO');
		commit;
end goto_insert;


procedure goto_update( prm_objeto 	   varchar2 default null,
				       prm_objeto_go   varchar2 default null,
					   prm_cd_goto     number   default null,
					   prm_campo       varchar2 default null,
					   prm_valor       varchar2 default null) as

	ws_usuario      varchar2(100); 
	ws_count  		number;
	ws_tipo   		varchar2(4000);
	ws_nome   		varchar2(4000);
	ws_visao  		varchar2(4000);
	ws_erro         varchar2(200); 
	ws_comp         varchar2(200); 
	ws_raise_erro   exception ; 

begin
	
	ws_usuario := GBL.getUsuario();

	if not(fun.check_admin('DRILLS_ADD')) then
		ws_erro := 'Sem permiss&atilde;o para cria&ccedil;&atilde;o de drills'; 
		raise ws_raise_erro; 
	end if; 

	update goto_objeto 
	   set ordem          = decode(prm_campo,'ORDEM',          prm_valor, ordem),  
	   	   ds_complemento = decode(prm_campo,'DS_COMPLEMENTO', prm_valor, ds_complemento),  
	       cs_coluna      = decode(prm_campo,'CS_COLUNA',      prm_valor, cs_coluna),  
		   cs_agrupador   = decode(prm_campo,'CS_AGRUPADOR',   prm_valor, cs_agrupador),
		   cs_colup       = decode(prm_campo,'CS_COLUP',       prm_valor, cs_colup),
		   orderby        = decode(prm_campo,'ORDERBY',        prm_valor, orderby)
	 where cd_usuario   = 'DWU'
	   and cd_objeto      = prm_objeto 
	   and cd_objeto_go   = prm_objeto_go 
	   and cd_goto_objeto = prm_cd_goto ; 

	if prm_campo = 'ORDERBY' then 
		if prm_valor is null or length(prm_valor) = 0 then 
			delete object_attrib where cd_object = prm_objeto_go||'trl'||prm_cd_goto and cd_prop = 'ORDEM' and owner in ('DWU',ws_usuario);
		else
			fcl.save_prop ('ORDEM',prm_valor, prm_objeto_go||'trl'||prm_cd_goto, prm_screen => 'DEFAULT');
		end if; 	
	end if; 

	commit;

	htp.p('OK');
			
exception 
	when ws_raise_erro then 
		htp.p('ERRO|'||fun.lang(ws_erro));
	when others then
		rollback;
		htp.p('ERRO|'||fun.lang('Erro ao adicionar drills, verifique o log de erros do sistema.'));
		insert into bi_log_sistema values (sysdate, 'GOTO_UPDATE: '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, ws_usuario, 'ERRO');
		commit;
end goto_update;


procedure goto_delete ( prm_objeto    varchar2 default null,
					    prm_objeto_go varchar2 default null,
						prm_cd_goto   number   default null ) as

	ws_count number;
	ws_erro         varchar2(200);
	ws_raise_erro   exception ; 

begin
	if not(fun.check_admin('DRILLS_EX')) then
		ws_erro := 'Sem permiss&atilde;o para exclus&atilde;o';
		raise ws_raise_erro;
	end if; 

	delete from goto_objeto 
	 where cd_objeto      = trim(prm_objeto) 
	   and cd_objeto_go   = trim(prm_objeto_go)
	   and cd_goto_objeto = prm_cd_goto;
	ws_count := SQL%ROWCOUNT;
	if ws_count = 0 then
		ws_erro := 'Drill n&atilde;o localizada para exclus&atilde;o';
		raise ws_raise_erro; 
	end if;

	delete object_attrib where cd_object = prm_objeto_go||'trl'||prm_cd_goto;

	commit;

	htp.p('OK|'||fun.lang('Registro excluido com sucesso'));
exception
	when ws_raise_erro then 
		htp.p('ERRO|'||fun.lang(ws_erro));
	when others then
		rollback;
		htp.p('ERRO|'||fun.lang('Erro excluindo drill, verifique o log de erros do sistema'));
		insert into bi_log_sistema (dt_log, ds_log, nm_usuario, nm_procedure) values (sysdate, 'goto_delete: '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, gbl.getUsuario, 'ERRO');
		commit;
end goto_delete;



procedure savecall ( prm_objeto	     varchar2 default null,
					prm_objeto_go	 varchar2 default null,
					prm_screen      varchar2 default null ) as


		
	ws_count number;
	ws_fail exception;

begin
	
	/*fcl.refresh_Session;*/
		
	/*for i in(select column_value from table((fun.vpipe(prm_objeto_go)))) loop
		insert into CALL_LIST (cd_list, cd_objeto, POSX, POSY) values (prm_objeto, upper(i.column_value), '', '' );
	end loop;*/

	insert into CALL_LIST (cd_list, cd_objeto, POSX, POSY)
	select prm_objeto, column_value, '', '' from table(fun.vpipe(prm_objeto_go));
	
	ws_count := SQL%ROWCOUNT;
	
	if ws_count <> 0 then
		commit;
	else
		raise ws_fail;
	end if;

exception
	when ws_fail then
		rollback;
		htp.p('FAIL');
	when others then
		rollback;
		htp.p('FAIL');
end savecall;


procedure save_formula( prm_coluna  varchar2 default null,
						prm_formula varchar2 default null,
						prm_tabela  varchar2 default null ) as

begin
	/*fcl.refresh_Session;*/
	update MICRO_COLUNA set
	FORMULA	= prm_formula
	where	trim(cd_micro_visao) = prm_tabela and
	trim(cd_coluna)      = prm_coluna;
	commit;

exception when others then
	htp.p(sqlerrm);
end save_formula;

procedure save_mvisao (	p_cd_coluna		  IN owa_util.ident_arr,
						p_gravacao		  IN owa_util.ident_arr,
						p_nm_rotulo		  IN owa_util.ident_arr,
						p_st_gerar		  IN owa_util.ident_arr,
						p_st_agrupador	  IN owa_util.ident_arr,
						p_nm_mascara	  IN owa_util.ident_arr,
						p_cd_ligacao	  IN owa_util.ident_arr,
						p_st_com_codigo	  IN owa_util.ident_arr,
						p_st_alinhamento  IN owa_util.ident_arr,
						p_st_resumido	  IN owa_util.ident_arr,
						p_st_negrito	  IN owa_util.ident_arr,
						p_st_invisivel	  IN owa_util.ident_arr,
						p_nm_unidade	  IN owa_util.ident_arr,
						p_tabela		  IN VARCHAR2 DEFAULT NULL ) as

	ws_count	number;

begin
	/*fcl.refresh_Session;*/
	htp.htmlOpen;
	htp.bodyOpen;

	for i in p_cd_coluna.FIRST..p_cd_coluna.LAST loop
		if  rtrim(p_gravacao(i)) = '##SEM_LINHA##' and nvl(trim(p_nm_rotulo(i)),'$%%$')<>'$%%$' then
			insert into MICRO_COLUNA ( CD_MICRO_VISAO, CD_COLUNA, NM_ROTULO, ST_GERA_REL, ST_AGRUPADOR, 
									NM_MASCARA, CD_LIGACAO, ST_COM_CODIGO,  ST_ALINHAMENTO, ST_RESUMIDO, 
									ST_NEGRITO, ST_INVISIVEL, NM_UNIDADE, FORMULA, TIPO, 
									ROTULO_C, COLOR, HINT, FLEXCOL, URL, LIMITE, ANOTACAO ) 
							values ( trim(p_tabela), trim(p_cd_coluna(i)), trim(p_nm_rotulo(i)), fcl.fpdata(trim(p_st_gerar(i)),'S','S','N'), trim(p_st_agrupador(i)), 
									trim(p_nm_mascara(i)), trim(p_cd_ligacao(i)), fcl.fpdata(trim(p_st_com_codigo(i)),'S','S','N'), trim(p_st_alinhamento(i)), fcl.fpdata(trim(p_st_resumido(i)),'S','S','N'), 
									fcl.fpdata(trim(p_st_negrito(i)),'S','S','N'), fcl.fpdata(trim(p_st_invisivel(i)),'S','S','N'), trim(p_nm_unidade(i)), '', 'T', 
									'', '', '', '', '', '', '');
			commit;
		end if;

		if  nvl(trim(p_nm_rotulo(i)),'$%%$')<>'$%%$' and rtrim(p_gravacao(i)) <> '##SEM_LINHA##' then
			update MICRO_COLUNA set
				NM_ROTULO      = trim(p_nm_rotulo(i)),
				ST_GERA_REL    = fcl.fpdata(trim(p_st_gerar(i)),'S','S','N'),
				ST_AGRUPADOR   = trim(p_st_agrupador(i)),
				NM_MASCARA     = trim(p_nm_mascara(i)),
				CD_LIGACAO     = trim(p_cd_ligacao(i)),
				ST_COM_CODIGO  = fcl.fpdata(trim(p_st_com_codigo(i)),'S','S','N'),
				ST_ALINHAMENTO = trim(p_st_alinhamento(i)),
				ST_RESUMIDO    = fcl.fpdata(trim(p_st_resumido(i)),'S','S','N'),
				ST_NEGRITO     = fcl.fpdata(trim(p_st_negrito(i)),'S','S','N'),
				ST_INVISIVEL   = fcl.fpdata(trim(p_st_invisivel(i)),'S','S','N'),
				NM_UNIDADE     = trim(p_nm_unidade(i))
			where trim(cd_micro_visao) = trim(p_tabela) 
			and trim(cd_coluna)      = trim(p_gravacao(i));
			commit;
		end if;
	end loop;

	htp.p('<script>parent.history.back(); alerta(''msg'', '''||fun.lang('Alterado com sucesso')||'!'');</script>');

	htp.bodyClose;
	htp.htmlClose;

exception when others then
	htp.p(sqlerrm);
end save_mvisao;

/* Lista de Objetos por Tipo */

procedure list_crocks as

	cursor crs_tabelas is
		select 	NM_MICRO_VISAO, NM_TABELA, CD_GRUPO_FUNCAO
		from micro_visao
		order by CD_GRUPO_FUNCAO, NM_MICRO_VISAO;

	ws_tabelas	crs_tabelas%rowtype;
	ws_tmp		long;
	ws_count	number;
	ws_primeiro	varchar2(60);
	ws_grupo    varchar2(40) := '999999999';
	ws_padrao   varchar2(80) := 'PORTUGUESE';
begin
	/*fcl.refresh_Session;*/
	ws_count := 0;

	begin
		select CONTEUDO into ws_padrao
		from   PARAMETRO_USUARIO
		where  cd_usuario = gbl.getUsuario and
			cd_padrao='CD_LINGUAGEM';
	exception
		when others then
			ws_padrao := 'PORTUGUESE';
	end;

	htp.p('<div style="display: block; width: 580px; margin-bottom: 4px; text-align: center;">
		<select id="list_coluna" style="width: 250px;" onchange=" if(this.options[this.selectedIndex].id != ''''){ loader(''ajax''); ajax(''main'', ''load_crocks'', ''prm_visao=''+this.value, ''true'', ''ajax''); telaSup(''visao'',this.options[this.selectedIndex].id); }">');
			htp.p('<option>'||fun.lang('Escolha uma view')||'</option>');
			open crs_tabelas;
				loop
					fetch crs_tabelas into ws_tabelas;
					exit when crs_tabelas%notfound;
					if ws_grupo <> ws_tabelas.CD_GRUPO_FUNCAO then
						htp.p('<optgroup label="'||fun.utranslate('CD_GRUPO', 'GRUPOS_FUNCAO', ws_tabelas.CD_GRUPO_FUNCAO, ws_padrao)||'"></optgroup>');
						ws_grupo := ws_tabelas.CD_GRUPO_FUNCAO;
					end if;
					htp.p('<option id="'||ws_tabelas.NM_MICRO_VISAO||'" value="'||ws_tabelas.NM_MICRO_VISAO||'">['||fun.utranslate('NM_MICRO_VISAO', 'MICRO_VISAO', ws_tabelas.NM_MICRO_VISAO, ws_padrao)||'] '||ws_tabelas.NM_TABELA||'</option>');
					if  ws_primeiro = '%First%' then
						ws_primeiro := ws_tabelas.NM_TABELA;
					end if;
					ws_count := ws_count + 1;
				end loop;
			close crs_tabelas;
		htp.p('</select>');

	htp.p('<input id="add_coluna" maxlength="25" type="text" class="up" /><a class="add" style="float: none;" title="'||fun.lang('Inserir nova coluna')||'" onclick="coluna = document.getElementById(''add_coluna'').value; if(coluna.trim().length > 1){ visao = document.getElementById(''telasup'').getAttribute(''data-visao''); if(visao.trim().length != 0){ ajax(''fly'', ''savecolumn'', ''p_cd_coluna=''+coluna+''&p_visao=''+visao, false); noerror('''', '''||fun.lang('Coluna adicionada com sucesso')||'!'', ''msg''); ajax(''list'', ''load_crocks'', ''value1=''+document.getElementById(''telasup'').getAttribute(''data-visao''), ''true'', ''ajax''); } else { alerta(''msg'','''||fun.lang('Escolha uma vis&atilde;o')||'!''); }} else { alerta(''msg'','''||fun.lang('Nome da coluna não pode estar em branco')||'!''); }} else { alerta(''msg'','''||fun.lang('Valor inv&aacute;lido, somente letras, números e underscore s&atilde;o permitidos')||'!''); } ">+</a></div>');

	htp.p('<div id="ajax" style="min-width: 195px; float: left; margin-top: 2px; width: 210px; overflow-x: hidden; height: 314px;"></div>');
	htp.p('<div id="fields" class="disabled"></div>');
	htp.p('<div class="listar">');
	htp.p('<a onclick="call_save(''''); carrega(''load_tables''); carregaPainel(''visoes''); document.getElementById(''titulo'').innerHTML= '''||fun.lang('Lista de Views')||'''; ">'||fun.lang('Listar Views')||'</a>');
	htp.p('</div>');


end list_crocks;

--!!
procedure list_users ( prm_order varchar2 default '1',
					prm_dir   varchar2 default '1' ) as

	ws_usuario    varchar2(100); 
	ws_admin_up   varchar2(10);

	cursor c_usuarios (p_status  varchar2) is
	select usu_nome, usu_completo, usu_email, id_usuario_externo,
		   listagg(t2.cd_group,'|') within group (order by t2.cd_group) as grupo,
		   listagg(t3.nm_group,',') within group (order by t3.nm_group) as ds_grupo
	from USUARIOS t1
	left join gusers_itens t2 on t2.cd_usuario = t1.usu_nome
	left join gusers t3 on t3.cd_group = t2.cd_group
	where t1.status = p_status 
	and ( ws_admin_up = 'A' or fun.user_permissao(ws_usuario, 'TELAS_USUARIOS') = 'S' or (ws_admin_up <> 'A' and gbl.getNivelUpquery(t1.usu_nome) <> 'A' ) and t1.usu_nome <> 'DWU')   -- Mostrar usuários UPquery somente se o usuario logado for Upquery
	group by t1.usu_nome, t1.usu_completo, t1.usu_email, t1.id_usuario_externo
	order by case when prm_dir = '1' then decode(prm_order, '1', t1.USU_NOME, '2', t1.USU_COMPLETO, '3', t1.USU_EMAIL, '4', t1.id_usuario_externo, t1.USU_NOME) end asc,
			 case when prm_dir = '2' then decode(prm_order, '1', t1.USU_NOME, '2', t1.USU_COMPLETO, '3', t1.USU_EMAIL, '4', t1.id_usuario_externo, t1.USU_NOME) end desc;

	/* 
	ws_linha crs_lista%rowtype;

	cursor crs_inativos is
	select USU_NOME, USU_COMPLETO, USU_EMAIL, 
		listagg(cd_group,'|') within group (order by cd_group) as grupo 
	from USUARIOS t1
	left join gusers_itens t2 on t2.cd_usuario= t1.usu_nome
	where status = 'I'
	group by USU_NOME, USU_COMPLETO, USU_EMAIL
	order by 
		case when prm_dir = '1' then decode(prm_order, '1', t1.USU_NOME, '2', t1.USU_COMPLETO, '3', t1.USU_EMAIL, t1.USU_NOME) end asc,
		case when prm_dir = '2' then decode(prm_order, '1', t1.USU_NOME, '2', t1.USU_COMPLETO, '3', t1.USU_EMAIL, t1.USU_NOME) end desc;

	ws_inativo crs_inativos%rowtype;
	*/ 

	ws_dir number := 1;
	ws_lock varchar2(80);

	ws_noadmin exception;

begin
	
	if gbl.getNivel <> 'A' and fun.user_permissao(ws_usuario, 'TELAS_USUARIOS') = 'S' then 
		raise ws_noadmin;
	end if;

	ws_usuario  := gbl.getUsuario;
	ws_admin_up := gbl.getNivelUpquery(ws_usuario);

	
	-- usuário ATIVOS 
	htp.p('<table class="linha">');

		htp.p('<thead>');

			htp.p('<tr>');

				htp.p('<th>');
					htp.p('<a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_users'', ''prm_order=1&prm_dir=''+dir, false, ''content'');">'||fun.lang('USU&Aacute;RIO')||'</a>');
				htp.p('</th>');

				htp.p('<th>');
					htp.p('<a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_users'', ''prm_order=2&prm_dir=''+dir, false, ''content'');">'||fun.lang('NOME')||'</a>');
				htp.p('</th>');

				htp.p('<th>');
					htp.p('<a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_users'', ''prm_order=3&prm_dir=''+dir, false, ''content'');">EMAIL</a>');
				htp.p('</th>');

				htp.p('<th>PASSWORD</th>');
				
				htp.p('<th>'||fun.lang('GRUPO')||'</th>');
				
				htp.p('<th>');
					htp.p('<a class="red" title="Identifica&ccedil;&atilde;o &uacute;nica de usu&aacute;rio utilizada normalmente para integra&ccedil;&atilde;o com outros sistemas, n&atilde;o &eacute; obrigat&oacute;ria." onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_users'', ''prm_order=4&prm_dir=''+dir, false, ''content'');">ID USUARIO EXTERNO</a>');
				htp.p('</th>');

				htp.p('<th></th>');
				--htp.p('<th></th>');
				htp.p('<th></th>');

			htp.p('</tr>');

		htp.p('</thead>');

		if to_number(prm_dir) = 1 then
			ws_dir := 2;
		end if;

		htp.p('<tbody id="ajax" class="usuarios" data-dir="'||ws_dir||'">');

			for a in c_usuarios ('A') loop  
				
				htp.p('<tr>');
				
					htp.p('<td>'||a.USU_NOME||'</td>');
					
					htp.p('<td>');
						htp.p('<input onkeypress="proxCampo(event,this);" value="'||a.USU_COMPLETO||'" data-default="'||a.USU_COMPLETO||'" onblur="userEvent(this, '''||a.USU_NOME||''', ''blur'');" class="editable longname"/>');
					htp.p('</td>');
					
					htp.p('<td>');
						htp.p('<input onkeypress="proxCampo(event,this);" value="'||a.USU_EMAIL||'" title="'||a.USU_EMAIL||'" data-default="'||a.USU_EMAIL||'" onblur="userEvent(this, '''||a.USU_NOME||''', ''email'');"  class="editable longname"/>');
					htp.p('</td>');
					
					htp.p('<td>');
						htp.p('<input type="password" placeholder="PASSWORD" data-changed="N" onkeydown="if(event.which == 13){ this.blur(); }  else { this.setAttribute(''data-changed'', ''S''); } " onblur="passChange(this, '''||upper(trim(a.USU_NOME))||''');" />');
					htp.p('</td>');
					
					htp.p('<td>');
						htp.p('<a class="script" onclick="userEvent(this.nextElementSibling, '''||trim(a.USU_NOME)||''', ''grupo'');"></a>');
						fcl.fakeoption('usuario-grupo-'||trim(a.USU_NOME)||'', '', a.grupo, 'lista-gusers', 'N', 'S', '', prm_desc => a.ds_grupo);
					htp.p('</td>');
					
					htp.p('<td>');
						htp.p('<input onkeypress="proxCampo(event,this);" value="'||a.id_usuario_externo||'" data-default="'||a.id_usuario_externo||'" onblur="userEvent(this, '''||a.usu_nome||''', ''id_usuario_externo'');" class="editable longname"/>');
					htp.p('</td>');

					htp.p('<td>');
						htp.p('<a class="addpurple aduser" title="'||trim(a.USU_NOME)||'">'||fun.lang('MAIS OP&Ccedil;&Otilde;ES')||'</a>');
					htp.p('</td>');

					if upper(trim(a.USU_NOME)) = 'DWU' or gbl.getNivelUpquery(a.USU_NOME) = 'A' then

						htp.p('<td>');
							htp.p('<a class="noremove" title="'||fun.lang('Usu&aacute;rio n&atilde;o pode ser exclu&iacute;do.')||'" onclick=" alerta(''msg'', '''||fun.lang('Usu&aacute;rio n&atilde;o pode ser exclu&iacute;do')||'!'');">X</a>');
						htp.p('</td>');

					else

						htp.p('<td>');
							fcl.button_lixo('delete_user', 'usu_nome_d', trim(a.USU_NOME));
						htp.p('</td>');

					end if;
					
				htp.p('</tr>');

			end loop;

		htp.p('</tbody>');

	htp.p('</table>');

	-- Usuários INATIVOS 
	htp.p('<table class="linha">');

		htp.p('<thead>');

			htp.p('<tr>');

				htp.p('<th>');
					htp.p('<a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_users'', ''prm_order=1&prm_dir=''+dir, false, ''content'');">'||fun.lang('USU&Aacute;RIO')||'</a>');
				htp.p('</th>');

				htp.p('<th>');
					htp.p('<a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_users'', ''prm_order=2&prm_dir=''+dir, false, ''content'');">'||fun.lang('NOME')||'</a>');
				htp.p('</th>');

				htp.p('<th>');
					htp.p('<a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_users'', ''prm_order=3&prm_dir=''+dir, false, ''content'');">EMAIL</a>');
				htp.p('</th>');

				htp.p('<th>PASSWORD</th>');
				
				htp.p('<th>'||fun.lang('GRUPO')||'</th>');

				htp.p('<th>');
					htp.p('<a class="red" title="Identifica&ccedil;&atilde;o &uacute;nica de usu&aacute;rio utilizada normalmente para integra&ccedil;&atilde;o com outros sistemas, n&atilde;o &eacute; obrigat&oacute;ria." onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_users'', ''prm_order=4&prm_dir=''+dir, false, ''content'');">ID USUARIO EXTERNO</a>');
				htp.p('</th>');
				
				htp.p('<th></th>');
				--htp.p('<th></th>');
				htp.p('<th></th>');
			
			htp.p('</tr>');
		
		htp.p('</thead>');

		if to_number(prm_dir) = 1 then
			ws_dir := 2;
		end if;

		htp.p('<h2>'||fun.lang('USU&Aacute;RIOS DESATIVADOS')||'</h2>');

		htp.p('<tbody class="usuarios" data-dir="'||ws_dir||'">');
			
			for a in c_usuarios ('I') loop 
				
				htp.p('<tr>');

					htp.p('<td>'||a.USU_NOME||'</td>');

					htp.p('<td>');
						htp.p('<div data-default="'||a.USU_COMPLETO||'" onblur="userEvent(this, '''||trim(a.USU_NOME)||''', ''blur'');" contenteditable="true" class="editable longname">'||a.USU_COMPLETO||'</div>');
					htp.p('</td>');

					--htp.p('<td><div title="'||a.USU_EMAIL||'" data-default="'||a.USU_EMAIL||'" onblur="userEvent(this, '''||trim(a.USU_NOME)||''', ''email'');" contenteditable="true" class="editable longname" class="link">'||a.USU_EMAIL||'</div></td>');
					htp.p('<td>');
						htp.p('<input onkeypress="proxCampo(event,this);" value="'||a.USU_EMAIL||'" title="'||a.USU_EMAIL||'" data-default="'||a.USU_EMAIL||'" onblur="userEvent(this, '''||a.USU_NOME||''', ''email'');"  class="editable longname"/>');
					htp.p('</td>');					
					
					htp.p('<td>');
						htp.p('<input type="password" placeholder="PASSWORD" data-changed="N" onkeypress="if(event.which == 13){ this.blur(); } else { this.setAttribute(''data-changed'', ''S''); }" onblur="passChange(this, '''||upper(trim(a.USU_NOME))||''');"/>');
					htp.p('</td>');

					htp.p('<td>');
						htp.p('<a class="script" onclick="userEvent(this.nextElementSibling, '''||trim(a.USU_NOME)||''', ''grupo'');"></a>');
						fcl.fakeoption('usuario-grupo-'||trim(a.USU_NOME)||'', '', a.grupo, 'lista-gusers', 'N', 'S', '', prm_desc => replace(a.grupo, '|', ', '));
					htp.p('</td>');

					htp.p('<td>');
						htp.p('<input onkeypress="proxCampo(event,this);" value="'||a.id_usuario_externo||'" data-default="'||a.id_usuario_externo||'" onblur="userEvent(this, '''||a.usu_nome||''', ''id_usuario_externo'');" class="editable longname"/>');
					htp.p('</td>');

					htp.p('<td>');
						htp.p('<a class="addpurple aduser" title="'||trim(a.USU_NOME)||'">MAIS OP&Ccedil;&Otilde;ES</a>');
					htp.p('</td>');

					if upper(trim(a.USU_NOME)) = 'DWU' then
						htp.p('<td>');
							htp.p('<a class="noremove" title="'||fun.lang('Imposs&iacute;vel excluir DWU')||'" onclick=" alerta(''msg'', '''||fun.lang('Imposs&iacute;vel excluir DWU')||'!'');">X</a>');
						htp.p('</td>');
					else
						htp.p('<td>');
							fcl.button_lixo('delete_user', 'usu_nome_d', trim(a.USU_NOME));
						htp.p('</td>');
					end if;
					
				htp.p('</tr>');
			
			end loop;
		
		htp.p('</tbody>');

	htp.p('</table>');

exception
	when ws_noadmin then
		htp.p('Sem permiss&atilde;o!');
	when others then
		insert into bi_log_sistema values (sysdate, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - PROCEDURE LIST_USERS', ws_usuario, 'ERRO');
		commit;
		htp.p(sqlerrm);
end list_users;


procedure advancedUsers ( prm_user varchar2 ) as

	ws_usu_nome    varchar2(200); 
	ws_sel_opt1    varchar2(15); 
	ws_sel_opt2    varchar2(15); 
	ws_usuario_sys varchar2(200);

	cursor crs_usuario is
	select status, show_only, upload, excel_out, app, dt_validacao_email, dt_validacao_senha, id_expira_senha, 
		nvl(tp_ordem_coluna,'M') as tp_ordem_coluna, nvl(id_aviso_mostrar,'S') as id_aviso_mostrar 
	from usuarios
	where upper(trim(usu_nome)) = ws_usu_nome;

	ws_usuario    crs_usuario%rowtype;

begin

	ws_usu_nome := upper(trim(prm_user)); 
	open  crs_usuario;
	fetch crs_usuario into ws_usuario;
	close crs_usuario;

	htp.p('<div class="itens" style="width: 346px;" style="position: relative;">');

		htp.p('<h2>'||fun.lang('OP&Ccedil;&Otilde;ES AVAN&Ccedil;ADAS')||'</h2>');

		htp.p('<ul class="form">');
			
			htp.p('<li>');
				htp.p('<span class="before">'||fun.lang('USU&Aacute;RIO')||'</span>');
				htp.p('<span class="after">');
					htp.p('<input type="text" readonly class="readonly" value="'||ws_usu_nome||'"/>');
				htp.p('</span>');
			htp.p('</li>');

			ws_usuario_sys := gbl.getUsuario; 
	
			htp.p('<li>');
				htp.p('<span class="before">'||fun.lang('TIPO')||'</span>');
				htp.p('<span class="after">');

					if gbl.getNivelUpquery(ws_usu_nome) = 'A' or ws_usu_nome = 'DWU' then 
						htp.p('<select disabled>');
					elsif ws_usu_nome = ws_usuario_sys and (gbl.getNivel <> 'A' and fun.user_permissao(ws_usuario_sys, 'TELAS_USUARIOS') = 'S') then
						htp.p('<select disabled>');
					else 
						htp.p('<select onchange="call(''show_update'', ''prm_usuario='||ws_usu_nome||'&prm_screen=''+this.value+''&prm_time=&prm_ordem=&prm_tipo=show'').then(function(res){ if(res.indexOf(''fail'') == -1){ alerta(''feed-fixo'', TR_AL); } });">');
					end if; 						
						if ws_usuario.show_only = 'S' then
							htp.p('<option value="N">Normal</option>');
							htp.p('<option value="A">Admin</option>');
							htp.p('<option value="S" selected>Slide</option>');
						elsif ws_usuario.show_only = 'A' then
							htp.p('<option value="N">Normal</option>');
							htp.p('<option value="A" selected>Admin</option>');
							htp.p('<option value="S">Slide</option>');
						else
							htp.p('<option value="N" selected>Normal</option>');
							htp.p('<option value="A">Admin</option>');
							htp.p('<option value="S">Slide</option>');
						end if;
						htp.p('</select>');
					htp.p('</select>');
				htp.p('</span');
			htp.p('</li>');

			if gbl.getUsuario <> ws_usu_nome and gbl.getNivelUpquery(ws_usu_nome) <> 'A' and ws_usu_nome <> 'DWU' then
			
				htp.p('<li>');
					htp.p('<span class="before">'||fun.lang('ATIVO')||'</span>');
					htp.p('<span class="after">');
						htp.p('<a class="script" onclick="userEvent(this.nextElementSibling, '''||ws_usu_nome||''', ''status'');"></a>');
						if ws_usuario.status = 'A' then
							htp.p('<span class="checkbox checked" data-positive="A" data-negative="I" title="'||ws_usuario.status||'"></span>');
						else
							htp.p('<span class="checkbox" data-positive="A" data-negative="I" title="'||ws_usuario.status||'"></span>');
						end if;
					htp.p('</span>');
				htp.p('</li>');

			end if;
			
			htp.p('<li>');
				htp.p('<span class="before">UPLOAD</span>');
				htp.p('<span class="after">');
					htp.p('<a class="script" onclick="userEvent(this.nextElementSibling, '''||ws_usu_nome||''', ''upload'');"></a>');
					if ws_usuario.upload = 'S' then
						htp.p('<span class="checkbox checked" data-positive="S" data-negative="N" title="'||ws_usuario.upload||'"></span>');
					else
						htp.p('<span class="checkbox" data-positive="S" data-negative="N" title="'||ws_usuario.upload||'"></span>');
					end if;
			htp.p('</li>');
		
			htp.p('<li>');
				htp.p('<span class="before">EXCEL</span>');
				htp.p('<span class="after">');
					htp.p('<a class="script" onclick="userEvent(this.nextElementSibling, '''||ws_usu_nome||''', ''excel'');"></a>');
						if nvl(ws_usuario.excel_out, 'S') = 'S' then
							htp.p('<span class="checkbox checked" data-positive="S" data-negative="N" title="'||ws_usuario.excel_out||'"></span>');
						else
							htp.p('<span class="checkbox" data-positive="S" data-negative="N" title="'||ws_usuario.excel_out||'"></span>');
						end if;
				htp.p('</span>');
			htp.p('</li>');

			htp.p('<li>');
				htp.p('<span class="before">APP</span>');
				htp.p('<span class="after">');
					htp.p('<a class="script" onclick="userEvent(this.nextElementSibling, '''||ws_usu_nome||''', ''app'');"></a>');
						if nvl(ws_usuario.app, 'S') = 'S' then
							htp.p('<span class="checkbox checked" data-positive="S" data-negative="N" title="'||ws_usuario.app||'"></span>');
						else
							htp.p('<span class="checkbox" data-positive="S" data-negative="N" title="'||ws_usuario.app||'"></span>');
						end if;
				htp.p('</span>');
			htp.p('</li>');
			
			htp.p('<li>');
				htp.p('<span class="before">'||fun.lang('COPIAR REGRAS')||'</span>');
				htp.p('<span class="after">');
					htp.p('<a class="link" onclick="copyListBtn('''||ws_usu_nome||''');">'||fun.lang('LISTAR USU&Aacute;RIOS')||'</a>');
				htp.p('</span>');
			htp.p('</li>');
			
			htp.p('<li>');
				htp.p('<span class="before">'||fun.lang('PERMISS&Otilde;ES')||'</span>');
				htp.p('<span class="after">');
					htp.p('<select onchange="userEvent(this, '''||ws_usu_nome||''', ''permissao'');">');
						htp.p('<option value="n/a" disabled hidden selected></option>');
						htp.p('<option value="column">'||fun.lang('BLOQUEIO DE COLUNA')||'</option>');
						htp.p('<option value="object">'||fun.lang('BLOQUEIO DE OBJETO')||'</option>');
						htp.p('<option value="custom">'||fun.lang('CONSULTA CUSTOMIZADA')||'</option>');
						htp.p('<option value="td">NETWALL</option>');
						htp.p('<option value="screen">'||fun.lang('TELAS DISPON&Iacute;VEIS')||'</option>');
						htp.p('<option value="permissao">'||fun.lang('OUTRAS PERMISS&Otilde;ES')||'</option>');
					htp.p('</select>');
				htp.p('</span>');
			htp.p('</li>');

			-- Novos campos de validação de email e senha 
			---------------------------------------------------------------
			htp.p('<li>');
				htp.p('<span class="before">'||fun.lang('&Uacute;LTIMA VALIDA&Ccedil;&Atilde;O DE E-MAIL')||'</span>');
				htp.p('<span class="after">');
					htp.p('<input type="text" readonly class="readonly" value="'||trim(to_char(ws_usuario.dt_validacao_email,'dd/mm/yyyy hh24:mi:ss') )||'"/>');
				htp.p('</span>');
			htp.p('</li>');
			htp.p('<li>');
				htp.p('<span class="before">'||fun.lang('&Uacute;LTIMA VALIDA&Ccedil;&Atilde;O DE SENHA')||'</span>');
				htp.p('<span class="after">');
					htp.p('<input id="usuarios_dt_validacao_senha" type="text" readonly class="readonly" value="'||trim(to_char(ws_usuario.dt_validacao_senha,'dd/mm/yyyy hh24:mi:ss') )||'"/>');
				htp.p('</span>');
			htp.p('</li>');

			htp.p('<li>');
				htp.p('<span class="before">'||fun.lang('EXPIRA SENHA')||'</span>');
				htp.p('<span class="after">');
					
					htp.p('<a class="addpurple" onclick="userEvent(this.nextElementSibling, '''||ws_usu_nome||''', ''expirar_senha'');" style="margin-left: 20px;" >'||fun.lang('Expirar Agora')||'</a>');

					htp.p('<a class="script" onclick="userEvent(this.nextElementSibling, '''||ws_usu_nome||''', ''id_expira_senha'');"></a>');					
					if nvl(ws_usuario.id_expira_senha,'S') = 'S' then
						htp.p('<span class="checkbox checked" data-positive="S" data-negative="N" title="'||nvl(ws_usuario.id_expira_senha,'S')||'"></span>');						
					else
						htp.p('<span class="checkbox" data-positive="S" data-negative="N" title="'||nvl(ws_usuario.id_expira_senha,'S')||'"></span>');
					end if;
				htp.p('</span>');
			htp.p('</li>');
			
			htp.p('<li>');
				htp.p('<span class="before">'||fun.lang('ORDENA&Ccedil;&Atilde;O CONSULTAS')||'</span>');
				htp.p('<span class="after">');
					htp.p('<select onchange="userEvent(this, '''||ws_usu_nome||''', ''tp_ordem_coluna'');">');
						ws_sel_opt1 := ''; 
						ws_sel_opt2 := ''; 
						if ws_usuario.tp_ordem_coluna = 'M' then  ws_sel_opt1 := 'Selected'; end if; 
						if ws_usuario.tp_ordem_coluna = 'U' then  ws_sel_opt2 := 'Selected'; end if; 
						htp.p('<option value="M" '||ws_sel_opt1||'>'||fun.lang('M&uacute;ltiplas colunas')||'</option>');
						htp.p('<option value="U" '||ws_sel_opt2||'>'||fun.lang('&Uacute;nica coluna')||'</option>');
					htp.p('</select>');
				htp.p('</span');
			htp.p('</li>');

			htp.p('<li>');
				htp.p('<span class="before">'||fun.lang('EXIBIR TELA AVISOS')||'</span>');
				htp.p('<span class="after">');
					htp.p('<select onchange="userEvent(this, '''||ws_usu_nome||''', ''id_aviso_mostrar'');">');
						ws_sel_opt1 := ''; 
						ws_sel_opt2 := ''; 
						if ws_usuario.id_aviso_mostrar = 'S' then  ws_sel_opt1 := 'Selected'; end if; 
						if ws_usuario.id_aviso_mostrar = 'N' then  ws_sel_opt2 := 'Selected'; end if; 
						htp.p('<option value="S" '||ws_sel_opt1||'>'||fun.lang('Sim')||'</option>');
						htp.p('<option value="N" '||ws_sel_opt2||'>'||fun.lang('N&atilde;o')||'</option>');
					htp.p('</select>');
				htp.p('</span');
			htp.p('</li>');



		htp.p('</ul>');

	htp.p('</div>');

	fcl.closer_menu;

end;

--!!
procedure delete_user ( usu_nome_d varchar2 default null ) as
	
	ws_user      number;
	ws_login     varchar2(80);
	ws_test      varchar2(100);
	ws_usuario   varchar2(100);

	ws_noadmin   exception;
	ws_exception exception;

begin
		
	if gbl.getNivel <> 'A' and fun.user_permissao(ws_usuario, 'TELAS_USUARIOS') = 'S' then
		raise ws_noadmin;
	end if;
	
	ws_login := upper(trim(usu_nome_d));
		
	select count(*) into ws_user from USUARIOS where upper(trim(usu_nome)) = ws_login;

	if ws_user <> 0 then

		ws_test := fun.remove_user(ws_login);
				
		if ws_test = 'OK' then
			insert into bi_log_sistema values (sysdate, 'Usu&aacute;rio '||ws_login||' excluido do sistema', gbl.getUsuario, 'EVENTO');
			commit;	
		end if;

	else
		htp.p('#alert '||fun.lang('Imposs&iacute;vel excluir usu&aacute;rio, valor inexistente')||'!');
	end if;

exception
	when ws_noadmin then
		htp.p('Sem permiss&atilde;o!');
	when ws_exception then
		htp.p('#alert '||fun.lang('Imposs&iacute;vel excluir usu&aacute;rio ')||'!');
	when others then
		htp.p('#alert '||fun.lang('Imposs&iacute;vel excluir usu&aacute;rio')||'!');
end delete_user;

--!!
procedure save_user ( prm_nome      varchar2 default null,
					prm_completo  varchar2 default null,
					prm_status    varchar2 default null,
					prm_email     varchar2 default null,
					prm_senha     varchar2 default null,
					prm_permissao varchar2 default 'none',
					prm_grupo     varchar2 default null ) as
	
	ws_user	     number;
	ws_count     number;
	ws_test      varchar2(10);
	ws_completo  varchar2(800);
	ws_usuario	 varchar2(100);
	ws_msg_erro  varchar2(100); 

	ws_noadmin   	exception;
	ws_noaction  	exception;
	ws_create    	exception;
	ws_raise        exception;

begin

	ws_usuario:=gbl.getUsuario;

	if gbl.getNivel <> 'A' and fun.user_permissao(ws_usuario, 'TELAS_USUARIOS') = 'N' then
		raise ws_noadmin;
	end if;

	select count(*) into ws_user 
	  from USUARIOS 
	 where usu_nome = upper(trim(prm_nome)); 
	if ws_user > 0 then
		ws_msg_erro := 'Usu&aacute;rio j&aacute; existe no sistema';  
		raise ws_raise; 
	end if; 

	select count(*) into ws_user 
	  from gusers
	 where cd_group = upper(trim(prm_nome)); 
	if ws_user > 0 then
		ws_msg_erro := 'Existe um grupo de usu&aacute;rios com esse nome, informe outro nome para o usu&aacute;rio';  
		raise ws_raise; 
	end if; 

	ws_msg_erro := fun.check_endereco_email(prm_email); 

	if ws_msg_erro is not null then 
		raise ws_raise; 
	end if; 

	select count(*) into ws_user 
	  from usuarios 
	 where upper(trim(usu_nome)) <> upper(trim(prm_nome))
	   and upper(trim(usu_email)) = upper(trim(prm_email))
	   and status                 = 'A'; 
	if ws_user > 0 then    
		ws_msg_erro := 'Endere&ccedil;o de e-mail j&aacute; utilizado em outro usu&aacute;rio';  
		raise ws_raise; 
	end if;	

	ws_completo := fun.converte(prm_completo);
	ws_test := fun.create_user(upper(trim(prm_nome)), prm_senha, prm_permissao, prm_email, ws_completo);

	if ws_test = 'ERRO' then
		raise ws_create;
	end if;
		
	if nvl(prm_grupo, 'N/A') <> 'N/A' then
		insert into gusers_itens ( cd_group, cd_usuario ) values (prm_grupo, trim(upper(prm_nome)));
		commit;
	end if;

	insert into bi_log_sistema values (sysdate,'USUARIO '||prm_nome||' DO GRUPO '||prm_grupo||' CRIADO COM SUCESSO!',ws_usuario,'EVENTO');
	commit;

exception
	when ws_noadmin then
		htp.p('Sem permiss&atilde;o!');
	when ws_create then
		htp.p('FAIL '||fun.lang('Erro na cria&ccedil;&atilde;o do usu&aacute;rio! ===> ')||sqlerrm||'!');
	when ws_raise  then
		htp.p('FAIL '||fun.lang(ws_msg_erro));
	when others then
		htp.p(sqlerrm);
end save_user;

--!!
procedure alter_user ( prm_nome varchar2 default null,
					   prm_valor varchar2 default null,
					   prm_tipo varchar2 default null ) as

	ws_count        	number;
	ws_email        	varchar2(500); 
	ws_nm_objeto        objetos.nm_objeto%type;
	ws_erro             varchar2(500); 
	ws_usuario_aux      varchar2(500);
	ws_noadmin 			exception;
	ws_raise_erro  	exception;
	ws_status           varchar2(50); 
	ws_usuario     		varchar2(100);
	
begin

	if prm_tipo <> 'cd_tela_inicial' then 
		if gbl.getNivel <> 'A' and fun.user_permissao(ws_usuario, 'TELAS_USUARIOS') = 'S' then
			raise ws_noadmin;
		end if;
	end if; 	

	if prm_tipo = 'nome' then
		update usuarios
		set usu_completo = trim(fun.converte(replace(replace(trim(prm_valor), chr(34), ''), chr(39), '')))
		where upper(trim(usu_nome)) = upper(trim(prm_nome));
	elsif prm_tipo = 'email' then
		ws_email := replace(replace(trim(prm_valor), chr(34), ''), chr(39), ''); 
		
		ws_erro := fun.check_endereco_email(ws_email);
		if ws_erro is not null then
			raise ws_raise_erro;
		end if; 

		select nvl(max(status),'A') into ws_status 
		from usuarios 
		where upper(trim(usu_nome)) = upper(trim(prm_nome)) ; 
		
		if ws_status <> 'I' then -- Valida email existente somente se o usuário estiver ativo 
			select count(*) into ws_count
			from usuarios 
			where upper(trim(usu_nome)) <> upper(trim(prm_nome)) 
			and upper(trim(usu_email)) = upper(trim(ws_email))
			and upper(status)          = 'A'; 
			if ws_count <> 0 then
				ws_erro := 'Endere&ccedil;o de e-mail j&aacute; utilizado em outro usu&aacute;rio'; 
				raise ws_raise_erro;
			end if;
		end if; 

		update usuarios
		set usu_email          = ws_email,
			dt_validacao_email = null        -- Limpa a data a última validação para que o usuário tenha que validar seu novo email 
		where upper(trim(usu_nome)) = upper(trim(prm_nome));

	elsif prm_tipo = 'grupo' then
		delete from gusers_itens where cd_usuario = prm_nome;
		commit;
		for i in(select column_value from table(fun.vpipe(prm_valor))) loop
			INSERT into gusers_itens (cd_group, cd_usuario) VALUES (i.column_value, prm_nome);
			commit;
		end loop;
	elsif prm_tipo = 'upload' then
		update usuarios
		set upload = trim(prm_valor)
		where upper(trim(usu_nome)) = upper(trim(prm_nome));
	elsif prm_tipo = 'excel_out' then
		update usuarios
		set excel_out = trim(prm_valor)
		where upper(trim(usu_nome)) = upper(trim(prm_nome));
	elsif prm_tipo = 'app' then
		update usuarios
		set app = trim(prm_valor)
		where upper(trim(usu_nome)) = upper(trim(prm_nome));
	elsif prm_tipo = 'id_expira_senha' then
		update usuarios
		set id_expira_senha = trim(prm_valor)
		where upper(trim(usu_nome)) = upper(trim(prm_nome));
	elsif prm_tipo = 'expirar_senha' then
		update usuarios
		set dt_validacao_senha = trim(prm_valor)
		where upper(trim(usu_nome)) = upper(trim(prm_nome));
	elsif prm_tipo = 'cd_tela_inicial' then
		ws_nm_objeto := null;
		select max(nm_objeto) into ws_nm_objeto
		from objetos 
		where cd_objeto = prm_valor
		and tp_objeto = 'SCREEN';
		if ws_nm_objeto is null and prm_valor <> 'DEFAULT' then 
			htp.p('ERRO|Erro buscando cadastro de objeto referente a tela');
		else
			begin  
				update usuarios
				set cd_tela_inicial = trim(prm_valor)
				where upper(trim(usu_nome)) = upper(trim(prm_nome));
				htp.p('OK|Tela inicial definida com sucesso|'||prm_valor||'|'||ws_nm_objeto); 
			exception when others then 
				htp.p('ERRO|Erro atualizando o perfil/cadastro do usu&aacute;rio');
			end; 	 
		end if; 	 
	elsif prm_tipo = 'tp_ordem_coluna' then
		update usuarios
		set tp_ordem_coluna = trim(prm_valor)
		where upper(trim(usu_nome)) = upper(trim(prm_nome));
	elsif prm_tipo = 'id_aviso_mostrar' then
		update usuarios
		set id_aviso_mostrar = trim(prm_valor)
		where upper(trim(usu_nome)) = upper(trim(prm_nome));
	elsif prm_tipo = 'id_usuario_externo' then
		select count(*), max(usu_nome) into ws_count, ws_usuario_aux from usuarios 
		where usu_nome <> trim(prm_nome) 
		  and upper(id_usuario_externo) = upper(trim(prm_valor))
		  and id_usuario_externo is not null ; 
		if ws_count <> 0 then
			ws_erro := 'Identifica&ccedil;&atilde;o j&aacute; est&aacute; sendo utilizada no usu&aacute;rio ['||ws_usuario_aux||']'; 
			raise ws_raise_erro;
		end if;
		update usuarios
		   set id_usuario_externo = trim(prm_valor)
		 where usu_nome = upper(trim(prm_nome));
	else
		-- Se estiver ativando o usuário, verifica se tem algum outro usuário com o mesmo email dele 
		if upper(prm_valor) = 'A' then 
			select usu_email into ws_email
			from usuarios
			where upper(trim(usu_nome)) = upper(trim(prm_nome));
			--
			select count(*), max(usu_nome) into ws_count, ws_usuario_aux
			from usuarios 
			where upper(trim(usu_nome)) <> upper(trim(prm_nome)) 
			and upper(trim(usu_email)) = upper(trim(ws_email))
			and upper(status)          = 'A'; 
			--
			if ws_count <> 0 then
				ws_erro := 'Endere&ccedil;o de e-mail j&aacute; utilizado por '||ws_usuario_aux||', ativa&ccedil;&atilde;o cancelada'; 
				raise ws_raise_erro;
			end if;
		end if; 

		update usuarios
		set status = trim(prm_valor)
		where upper(trim(usu_nome)) = upper(trim(prm_nome));
	end if;

	insert into log_eventos values(sysdate, 'ALTERACAO USUARIO ['||prm_tipo||']', prm_nome, 'TELA', 'USUARIO', '01');

	commit;  
exception 
	when ws_noadmin then
		htp.p('!alertSem permiss&atilde;o!');
	when ws_raise_erro then
		htp.p('!alert'||ws_erro);		
	when others then
		insert into bi_log_sistema (dt_log, ds_log, nm_usuario, nm_procedure) values (sysdate, 'ALTER_USER(Others):'||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, prm_nome, 'ERRO');
		commit;
		htp.p('!alertErro atualizando usu&aacute;rio, favor verificar log de erros de sistema!');		

end alter_user;


procedure screen_access ( prm_usuario     varchar2 default null, 
						prm_conteudo    varchar2 default 'FULL',
						prm_grupo       varchar2 default null ) as

ws_admin varchar2(10); 

cursor crs_user is
	select nome, grupo, tela, tempo, ordem 
		from ( select 2 ordem_tipo, t1.nm_objeto nome, t1.cd_grupo grupo, t2.screen tela, time tempo, t3.ordem ordem
				from user_screens t2
			left join user_sequence t3 on (t3.usuario = t2.usuario and t3.screen = t2.screen) 
			left join objetos t1       on (t1.cd_objeto = t2.screen) 
			where t2.usuario = trim(prm_usuario) 
				and cd_grupo   = nvl(prm_grupo, cd_grupo)

			union all
			select 1 ordem_tipo, screen nome, ' ' grupo, screen tela, 0 tempo, 0 ordem
				from user_screens 
				where usuario = trim(prm_usuario) 
				and screen in (select cd_grupo from grupos_funcao)
			)
	order by ordem_tipo, decode(ws_admin, 'S', ordem, 1) asc, grupo asc, tela asc;

ws_linha crs_user%rowtype;
ws_count  integer; 
ws_tipo   varchar2(30); 
ws_padrao varchar2(80) := 'PORTUGUESE';

begin

ws_padrao := gbl.getlang ; 
ws_admin  := gbl.getnivel(prm_usuario); 

	if prm_conteudo = 'FULL' then

		htp.p('<div class="searchbar">');
			htp.p('<a class="script" onclick="userEvent(this.nextElementSibling, '''||prm_usuario||''', ''permissao-fake'');"></a>');
			fcl.fakeoption('lista-grupos', fun.lang('BUSCA POR CATEGORIA'), '', 'lista-grupos', 'N', 'N', '', '', 'todos');
		htp.p('</div>');

	htp.p('<table class="linha">');
		htp.p('<thead>');
			htp.p('<th style="width: 20%;">'||fun.lang('TIPO LIBERA&Ccedil;&Atilde;O')||'</th>');
			htp.p('<th style="width: 20%;">'||fun.lang('TELA / CATEGORIA')||'</th>');
			htp.p('<th style="width: 20%;">'||fun.lang('CATEGORIA')||'</th>');
			htp.p('<th style="width: 22%;">'||fun.lang('USU&Aacute;RIO')||'</th>');
			htp.p('<th style="width: 10%;">'||fun.lang('TEMPO')||'</th>');
			htp.p('<th style="width: 10%;">'||fun.lang('ORDEM')||'</th>');
			htp.p('<th style="width: 4%;"></th>');
	htp.p('</thead>');
	htp.p('<tbody id="ajax">');

	end if;

for ws_linha in crs_user loop

		select count(*) into ws_count from grupos_funcao where cd_grupo = ws_linha.tela; 
		if ws_count > 0 then 
			ws_tipo := 'CATEGORIA';
		else 
			ws_tipo := 'TELA';
		end if; 	

		htp.p('<tr id="screen_access_'||ws_linha.tela||'">');
			htp.p('<td>'||ws_tipo||'</td>');
			htp.p('<td>'||fun.utranslate('NM_OBJETO', ws_linha.tela, ws_linha.nome, ws_padrao)||'</td>');
			htp.p('<td class="up">'||ws_linha.grupo||'</td>');
			htp.p('<td>'||upper(trim(prm_usuario))||'</td>');


			htp.p('<td>');
				if ws_tipo = 'TELA' then 
					htp.p('<select title="'||fun.lang('tempo')||'" onchange="call(''screen_change'', ''prm_usuario='||prm_usuario||'&prm_tela='||ws_linha.tela||'&prm_tipo=time&prm_valor=''+this.value).then(function(resposta){ if(resposta.indexOf(''OK'') != -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } });">');
						htp.p('<option value="0"disabled hidden>TEMPO DE SLIDE</option>');
						htp.p('<option value="0">0</option>');
						
						if ws_linha.tempo = '10' then
							htp.p('<option value="10" selected>10s</option>');
						else
							htp.p('<option value="10">10s</option>');
						end if;

						if ws_linha.tempo = '20' then
							htp.p('<option value="20" selected>20s</option>');
						else
							htp.p('<option value="20">20s</option>');
						end if;
			
						if ws_linha.tempo = '30' then
							htp.p('<option value="30" selected>30s</option>');
						else
							htp.p('<option value="30">30s</option>');
						end if;
						if ws_linha.tempo = '20' then
							htp.p('<option value="20" selected>20s</option>');
						else
							htp.p('<option value="20">20s</option>');
						end if;
			
						if ws_linha.tempo = '30' then
							htp.p('<option value="30" selected>30s</option>');
						else
							htp.p('<option value="30">30s</option>');
						end if;

						if ws_linha.tempo = '45' then
							htp.p('<option value="45" selected>45s</option>');
						else
							htp.p('<option value="45">45s</option>');
						end if;
						if ws_linha.tempo = '45' then
							htp.p('<option value="45" selected>45s</option>');
						else
							htp.p('<option value="45">45s</option>');
						end if;

						if ws_linha.tempo = '60' then
							htp.p('<option value="60" selected>1min</option>');
						else
							htp.p('<option value="60">1min</option>');
						end if;
						if ws_linha.tempo = '60' then
							htp.p('<option value="60" selected>1min</option>');
						else
							htp.p('<option value="60">1min</option>');
						end if;

						if ws_linha.tempo = '120' then
							htp.p('<option value="120" selected>2min</option>');
						else
							htp.p('<option value="120">2min</option>');
						end if;
						if ws_linha.tempo = '120' then
							htp.p('<option value="120" selected>2min</option>');
						else
							htp.p('<option value="120">2min</option>');
						end if;

						if ws_linha.tempo = '300' then
							htp.p('<option value="300" selected>5min</option>');
						else
							htp.p('<option value="300">5min</option>');
						end if;
						if ws_linha.tempo = '300' then
							htp.p('<option value="300" selected>5min</option>');
						else
							htp.p('<option value="300">5min</option>');
						end if;

						if ws_linha.tempo = '600' then
							htp.p('<option value="600" selected>10min</option>');
						else
							htp.p('<option value="600">10min</option>');
						end if;
						if ws_linha.tempo = '600' then
							htp.p('<option value="600" selected>10min</option>');
						else
							htp.p('<option value="600">10min</option>');
						end if;

						if ws_linha.tempo = '900' then
							htp.p('<option value="900" selected>15min</option>');
						else
							htp.p('<option value="900">15min</option>');
						end if;
						if ws_linha.tempo = '900' then
							htp.p('<option value="900" selected>15min</option>');
						else
							htp.p('<option value="900">15min</option>');
						end if;

						
					htp.p('</select>');
				end if; 
			htp.p('</td>');

			htp.p('<td>');
				if ws_tipo = 'TELA' then 
					htp.p('<select title="'||fun.lang('Ordem da tela no Slide')||'" onchange="call(''screen_change'', ''prm_usuario='||prm_usuario||'&prm_tela='||ws_linha.tela||'&prm_tipo=ordem&prm_valor=''+this.value).then(function(resposta){ if(resposta.indexOf(''OK'') != -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } });">');
						htp.p('<option selected disabled hidden value="0">'||fun.lang('ORDEM DO SLIDE')||'</option>');
						for i in 0..20 loop
							if i = ws_linha.ordem then
								htp.p('<option value="'||i||'" selected>'||i||'</option>');
							else
								htp.p('<option value="'||i||'">'||i||'</option>');
							end if;
						end loop;
					htp.p('</select>');
				end if; 
			htp.p('</td>');

			htp.p('<td>');
				fcl.button_lixo('delete_screen_access','prm_usuario|prm_tela', upper(trim(prm_usuario))||'|'||ws_linha.tela);
			htp.p('</td>');
			--htp.p('<td><a class="remove" title="'||fun.lang('Excluir')||'" onclick="if(confirm(TR_CE)) var row = this.parentNode.parentNode; call(''delete_screen_access'', ''prm_usuario='||upper(trim(prm_usuario))||'&prm_tela='||ws_linha.SCREEN||''').then(function(resposta){ alerta(''feed-fixo'', resposta.replace(''[1]'', '''')); if(resposta.indexOf(''[1]'') != -1){ row.remove(); call(''menu_screen_access'', ''prm_usuario='||trim(prm_usuario)||''').then(function(resposta){ document.getElementById(''painel'').innerHTML = resposta; }); } });">X</a></td>');
		htp.p('</tr>');
end loop;

	if prm_conteudo = 'FULL' then	
				htp.p('</tbody>');
			htp.tableClose;
			htp.p('</div>');
		htp.p('<div class="listar"><a onclick="carregaPainel(''usuarios'');  carrega(''list_users''); call_save(''''); document.getElementById(''titulo'').innerHTML = '''||fun.lang('Usu&aacute;rios')||''';">'||fun.lang('Listar usu&aacute;rios')||'</a></div>');
	end if;
	
end screen_access;


procedure screen_change ( prm_usuario varchar2 default null,
						prm_tela    varchar2 default null,
						prm_tipo    varchar2 default 'time',
						prm_valor   number default null ) as

	ws_count  number;
	ws_rcount number;

begin
	if prm_tipo = 'time' then
		select count(*) into ws_rcount from user_sequence where usuario = prm_usuario and screen = prm_tela;
		if ws_rcount = 0 then
			insert into user_sequence (ordem, screen, time, usuario) values (0, prm_tela, prm_valor, prm_usuario);
		else
			update user_sequence set time = prm_valor 
			where usuario = prm_usuario and screen = prm_tela;
		end if;
	else
		select count(*) into ws_rcount from user_sequence where usuario = prm_usuario and screen = prm_tela;
		if ws_rcount = 0 then
			insert into user_sequence (ordem, screen, time, usuario) values (prm_valor, prm_tela, 0, prm_usuario);
		else
			update user_sequence set ordem = prm_valor 
			where usuario = prm_usuario and screen = prm_tela;
		end if;
	end if;

	ws_count := SQL%ROWCOUNT;

	if ws_count <> 0 then

		commit;
		htp.p('OK');

	end if;

exception when others then
	htp.p('FAIL');
end screen_change;


procedure list_screen ( prm_grupo varchar2 default 'all', 
						prm_usuario varchar2 default null ) as

	cursor scr_all is
	select screen, descricao, grupo from( select screen, descricao, (select cd_grupo from objetos where tp_objeto = 'SCREEN' and cd_objeto = t1.screen) as grupo
	from ALL_SCREENS t1)
	where nvl(grupo, 'N/A') = decode(prm_grupo, 'all', nvl(grupo, 'N/A'), prm_grupo) and 
	screen not in (select screen from user_screens where usuario = prm_usuario)
	order by descricao;

	ws_option scr_all%rowtype;

	ws_padrao varchar2(80) := 'PORTUGUESE';

begin

	begin
		select CONTEUDO into ws_padrao
		from   PARAMETRO_USUARIO
		where  cd_usuario = gbl.getUsuario and
			cd_padrao='CD_LINGUAGEM';
	exception
		when others then
			ws_padrao := 'PORTUGUESE';
	end;

	open scr_all;
		loop
			fetch scr_all into ws_option;
			exit when scr_all%notfound;
			htp.p('<option id="screens_'||ws_option.SCREEN||'" value="'||ws_option.SCREEN||'">'||fun.utranslate('NM_OBJETO', ws_option.SCREEN, ws_option.DESCRICAO, ws_padrao)||'</option>');
		end loop;
	close scr_all;

end list_screen;

--!!
procedure add_screen_access ( 	prm_usuario varchar2 default null,
								prm_tela    varchar2 default null,
								prm_tempo   number default 0,
								prm_ordem   number default 0 ) as

	ws_count    number := 0;
	ws_url      varchar2(200);
	ws_usuario  varchar2(80);

	ws_noadmin  exception;

begin
	ws_usuario := gbl.getUsuario;
	

	if gbl.getNivel <> 'A' and fun.user_permissao(ws_usuario, 'TELAS_USUARIOS') <> 'S' then
		raise ws_noadmin;
	end if;

	for i in(select column_value from table((fun.vpipe(prm_tela)))) loop
				
		select count(*) into ws_count
		from user_screens
		where trim(usuario) = trim(prm_usuario) AND
		trim(screen) = trim(i.column_value);

		if ws_count = 0 then
			insert into USER_SCREENS
			(USUARIO, SCREEN, STATUS)
			values
			(prm_usuario, i.column_value, 'A');
				
			ws_count := SQL%ROWCOUNT;
			
			if nvl(prm_tempo, 0) <> 0 then
				insert into user_sequence
				(ordem, screen, time, usuario)
				values
				(prm_ordem, i.column_value, prm_tempo, prm_usuario);
			end if;
				
			commit;

			begin
				select url_fundo into ws_url from all_screens where trim(screen) = trim(i.column_value);
				if instr(ws_url, 'EXT=') > 0 then
					EXECUTE IMMEDIATE 'grant execute on '||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.'||replace(replace(replace(upper(ws_url), 'EXT=', ''), '.MAIN', ''), ''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.', '')||' to "'||prm_usuario||'" ';
					commit;
					htp.p(fun.lang('Permiss&atilde;o ao externo '||replace(replace(replace(upper(ws_url), 'EXT=', ''), '.MAIN', ''), ''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.', '')||' adicionado')||'!');
				end if;
				
			exception when others then
				htp.p(fun.lang('Erro ao adicionar externo')||'!');
			end;
			
			
			/*select count(*) into ws_count
			from user_screens
			where trim(usuario) = trim(nome_a) AND
			trim(screen) = trim(screen_a);*/
			
			if ws_count <> 0 then
				htp.p('[1]'||fun.lang('Permiss&atilde;o de tela adicionada')||'!');
				
				insert into bi_log_sistema values (sysdate, 'Tela '||i.column_value||' adicionada para o usu&aacute;rio '||prm_usuario, ws_usuario, 'EVENTO');
				commit;
			else
				htp.p(fun.lang('Erro ao adicionar permiss&Atilde;£o de tela')||'!');
			end if;
			
		else
			htp.p(fun.lang('Erro ao adicionar permiss&atilde;o de tela, usu&aacute;rio j&aacute; possui acesso')||'!');
		end if;

	end loop;

exception 
	when ws_noadmin then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end add_screen_access;


procedure delete_screen_access ( prm_usuario  varchar2 default null,
								 prm_tela     varchar2 default null ) as

	ws_count 			number := 0;
	ws_count_tela 		number := 0;
	ws_usuario			varchar2(200);

	ws_noadmin 			exception;

begin
	ws_usuario := gbl.getUsuario;
	
	if gbl.getNivel <> 'A' and fun.user_permissao(ws_usuario, 'TELAS_USUARIOS') <> 'S' then
		raise ws_noadmin;
	end if;


	select count(*) into ws_count
	from USER_SCREENS
	where trim(USUARIO) = trim(prm_usuario) and
	trim(SCREEN) = trim(prm_tela);

	if  ws_count > 0 then
		delete from USER_SCREENS
		 where trim(SCREEN)		= trim(prm_tela) 
		   and trim(USUARIO) 	= trim(prm_usuario);
		
		ws_count := SQL%ROWCOUNT;
		
		delete from user_sequence
		 where trim(screen) 	= trim(prm_tela) 
		   and trim(usuario) 	= trim(prm_usuario);

		select count(*) into ws_count_tela 
		  from usuarios 
		 where trim(cd_tela_inicial)	= trim(prm_tela) 
		   and trim(usu_nome) 			= trim(prm_usuario);

		if ws_count_tela <> 0 then

			update usuarios 
			   set cd_tela_inicial 	= 'DEFAULT'
			 where trim(usu_nome) 	= trim(prm_usuario);

		end if;

		commit;

		if ws_count <> 0 then
			htp.p('[1]'||fun.lang('Tela excluida com sucesso'));
		else
			htp.p(fun.lang('Erro ao excluir'));
		end if;
		
	else
		htp.p(fun.lang('Erro ao excluir, permiss&atilde;o inexistente')||'!');
	end if;
exception 
	when ws_noadmin then
		htp.p('ERRO|Sem permiss&atilde;o!');
	when others then
		htp.p(fun.lang('Erro ao excluir'));
end delete_screen_access;


procedure grupo_screen  ( prm_grupo       varchar2 default null, 
                          prm_conteudo    varchar2 default 'FULL',
						  prm_categoria   varchar2 default null ) as

	cursor c_telas is
        select obje.cd_grupo cd_categoria, obje.cd_objeto cd_tela, obje.nm_objeto nm_tela
		  from objetos obje, user_screens ussc
		 where obje.cd_objeto = ussc.screen 
		   and obje.tp_objeto = 'SCREEN' 
           and ussc.usuario   = prm_grupo 
		   and obje.cd_grupo  = nvl(prm_categoria, obje.cd_grupo)
	     order by 1, 3 ;

	-- ws_linha crs_user%rowtype;

	ws_padrao varchar2(80);

begin

    if prm_conteudo = 'FULL' then -- Carrega todo a tela, com cabeçalho e etc.

        htp.p('<div class="searchbar">');
			-- htp.p('<a class="script" onclick="userEvent(this.nextElementSibling, '''||prm_usuario||''', ''permissao-fake'');"></a>');
			htp.p('<a class="script" onclick="console.log(this.nextElementSibling.title); document.getElementById(''ajax'').innerHTML = ''''; call(''grupo_screen'', ''prm_grupo='||prm_grupo||'&prm_conteudo=N&prm_categoria=''+this.nextElementSibling.title).then(function(resposta){ document.getElementById(''ajax'').innerHTML = resposta; });" ></a>');
			fcl.fakeoption('lista-categorias', fun.lang('Busca por categoria'), '', 'lista-grupos', 'N', 'N', '', '', 'todos');
		htp.p('</div>');

		htp.p('<table class="linha">');
			htp.p('<thead>');
				htp.p('<th style="width: 20%;">'||fun.lang('CATEGORIA')||'</th>');
				htp.p('<th style="width: 22%;">'||fun.lang('C&Oacute;DIGO TELA')||'</th>');
				htp.p('<th style="width: 34%;">'||fun.lang('NOME DA TELA')||'</th>');
				htp.p('<th style="width: 4%;"></th>');  -- Botão de exclusão 
			htp.p('</thead>');
			htp.p('<tbody id="ajax">');
	end if;

	ws_padrao := gbl.getLang; 

	for a in c_telas loop
			htp.p('<tr id="grupo_screen_'||a.cd_tela||'">');
				htp.p('<td class="up">'||a.cd_categoria||'</td>');
				htp.p('<td>'||a.cd_tela||'</td>');
				htp.p('<td>'||fun.utranslate('NM_OBJETO', a.cd_tela, a.nm_tela, ws_padrao)||'</td>');
				htp.p('<td>');
					fcl.button_lixo('delete_grupo_screen','prm_grupo|prm_tela', upper(trim(prm_grupo))||'|'||a.cd_tela);
				htp.p('</td>');
			htp.p('</tr>');
	end loop;
	
	if prm_conteudo = 'FULL' then	
			htp.p('</tbody>');
		htp.p('</table>');

		htp.p('<div class="listar">');
			htp.p('<a title="Voltar para a tela anterior" onclick="call(''gusuarios'', '''', '''').then(function(resposta){ document.getElementById(''content'').innerHTML = resposta; call(''menu'', ''prm_menu=gusuarios'').then(function(resp){ document.getElementById(''painel'').innerHTML = resp;}); });">'||fun.lang('VOLTAR')||'</a>');
		htp.p('</div>');


    end if;
	
end grupo_screen;


procedure add_grupo_screen ( prm_grupo varchar2 default null,
				             prm_tela  varchar2 default null ) as

	ws_count    number := 0;
	ws_usuario  varchar2(80);
	ws_raise_erro    exception;

begin
	ws_usuario := gbl.getUsuario; 
	if gbl.getNivel <> 'A' and fun.user_permissao(ws_usuario, 'TELAS_USUARIOS') <> 'S' then
		htp.p('ERRO|Sem permiss&atilde;o!');
		raise ws_raise_erro;
	end if;

	for a in(select column_value as cd_tela from table((fun.vpipe(prm_tela)))) loop
				
		select count(*) into ws_count from user_screens
		 where usuario = prm_grupo
		   and screen  = a.cd_tela;
		if ws_count = 0 then 
			begin 
				insert into user_screens (usuario, screen, status) values (prm_grupo, a.cd_tela, 'A');
				insert into bi_log_sistema values (sysdate, 'Tela '||a.cd_tela||' adicionada para o grupo '||prm_grupo||'.', ws_usuario, 'EVENTO');
				commit;
				htp.p('OK|'||fun.lang('Permiss&atilde;o de tela adicionada')||'!');
			exception when others then
				htp.p('ERRO|'||fun.lang('Erro ao adicionar permiss&Atilde;£o a tela '||a.cd_tela||', entre em contato com o administrador do sistema')||'!');
			end;
		end if;
	end loop;

exception 
    when ws_raise_erro then
		null;
	when others then
        htp.p('ERRO|'||fun.lang('Erro ao adicionar permiss&Atilde;£o de tela, entre em contato com o administrador do sistema')||'!');
		insert into bi_log_sistema values (sysdate, 'ADD_GRUPO_SCREEN: '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, ws_usuario, 'ERRO');
		commit; 
end add_grupo_screen;



procedure delete_grupo_screen ( prm_grupo varchar2 default null,
				                prm_tela  varchar2 default null ) as

	ws_count    number := 0;
	ws_usuario  varchar2(80);
	ws_raise_erro    exception;

begin
	ws_usuario := gbl.getUsuario; 
	if gbl.getNivel(ws_usuario) <> 'A' and fun.user_permissao(ws_usuario, 'TELAS_USUARIOS') <> 'S' then
		htp.p('ERRO|Sem permiss&atilde;o!');
		raise ws_raise_erro;
	end if;

	delete user_screens
	 where usuario = prm_grupo
	   and screen  = prm_tela;  
	if sql%notfound then 
        htp.p('ERRO|'||fun.lang('Grupo n&atilde;o possui acesso a tela, feche essa tela e abra novamente')||'!');	
		raise ws_raise_erro; 
	end if;

exception 
    when ws_raise_erro then
		null;
	when others then
        htp.p('ERRO|'||fun.lang('Erro excluindo permiss&Atilde;£o de acesso a tela, entre em contato com o administrador do sistema')||'!');
		insert into bi_log_sistema values (sysdate, 'DELETE_GRUPO_SCREEN: '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, ws_usuario, 'ERRO');
		commit; 
end delete_grupo_screen;



procedure td_access ( prm_usuario  varchar2 default null,
					prm_conteudo varchar2 default 'FULL' ) as

	cursor tr_list is
	select nome_regra, 
		decode(upper(tipo_regra),'B','Bloqueado','L','Liberado','') tipo_regra, 
		decode(upper(nvl(tp_net_address,'I')),'I','IP Interno','E','IP Externo','') as tp_net_address, 
		net_address, hr_inicio, hr_final, dia_semana, dt_regra
	from user_netwall
	where trim(usuario) = trim(prm_usuario);

	ws_linha tr_list%rowtype;

begin
	/*fcl.refresh_Session;*/

	if prm_conteudo = 'FULL' then

		htp.p('<table class="linha">');
			htp.p('<thead>');
				htp.p('<tr>');
					htp.p('<th>'||fun.lang('NOME DA REGRA')||'</td>');
					htp.p('<th>'||fun.lang('TIPO REGRA')||'</td>');
					htp.p('<th>'||fun.lang('TIPO ENDERE&Ccedil;O')||'</td>');
					htp.p('<th>'||fun.lang('ENDERE&Ccedil;O')||'</td>');
					htp.p('<th>'||fun.lang('COME&Ccedil;O')||'</td>');
					htp.p('<th>'||fun.lang('TERMINO')||'</td>');
					htp.p('<th>'||fun.lang('DIA')||'</td>');
					htp.p('<th></td>');
				htp.p('</tr>');
			htp.p('</thead>');
			htp.p('<tbody id="ajax">');
	end if;
	
	open tr_list;
		loop
			fetch tr_list into ws_linha;
			exit when tr_list%notfound;
				htp.p('<tr id="'||ws_linha.nome_regra||'tr">');
					htp.p('<td>'||ws_linha.nome_regra||'</td>');
					htp.p('<td>'||ws_linha.tipo_regra||'</td>');
					htp.p('<td>'||ws_linha.tp_net_address||'</td>');					
					htp.p('<td>'||ws_linha.net_address||'</td>');
					htp.p('<td>'||ws_linha.hr_inicio||':00</td>');
					htp.p('<td>'||ws_linha.hr_final||':00</td>');
					case ws_linha.dia_semana
					when '2' then
						htp.p('<td>'||fun.lang('SEGUNDA-FEIRA')||'</td>');
					when '3' then
						htp.p('<td>'||fun.lang('TER&Ccedil;A-FEIRA')||'</td>');
					when '4' then
						htp.p('<td>'||fun.lang('QUARTA-FEIRA')||'</td>');
					when '5' then
						htp.p('<td>'||fun.lang('QUINTA-FEIRA')||'</td>');
					when '6' then
						htp.p('<td>'||fun.lang('SEXTA-FEIRA')||'</td>');
					when '7' then
						htp.p('<td>'||fun.lang('SABADO')||'</td>');
					when '1' then
						htp.p('<td>'||fun.lang('DOMNGO')||'</td>');
					when '8' then
						htp.p('<td>'||fun.lang('DIA &Uacute;TIL')||'</td>');
					when '9' then
						htp.p('<td>'||fun.lang('FIM DE SEMANA')||'</td>');
					else
						htp.p('<td>'||fun.lang('TODOS OS DIAS')||'</td>');
					end case;
					htp.p('<td>');
						fcl.button_lixo('dl_td_access','prm_usuario|prm_nome', prm_usuario||'|'||ws_linha.nome_regra);
					htp.p('</td>');
					--htp.p('<td><a class="remove" title="'||fun.lang('Excluir regra')||'" onclick="if(confirm(TR_CE)){ var row = this.parentNode.parentNode; call(''dl_td_access'', ''prm_usuario='||prm_usuario||'&prm_nome='||ws_linha.nome_regra||''').then(function(resposta){ alerta(''feed-fixo'', resposta.replace(''[1]'', '''')); if(resposta.indexOf(''[1]'') != -1){ row.remove(); } });}">X</td>');
				htp.p('</tr>');
		end loop;
	close tr_list;
	
	if prm_conteudo = 'FULL' then
		htp.p('</tbody></table>');

		htp.p('<div class="listar"><a title="'||fun.lang('ir para a lista de usu&aacute;rios')||'" onclick="carregaPainel(''usuarios''); carrega(''list_users''); call_save(''''); document.getElementById(''titulo'').innerHTML = '''||fun.lang('USU&Aacute;RIOS')||''';">'||fun.lang('Listar usu&aacute;rios')||'</a></div>');
	end if;

end td_access;


procedure add_td_access ( prm_usuario    varchar2 default null,
						prm_regra      varchar2 default null,
						prm_tipo       varchar2 default null,
						prm_tp_address varchar2 default null,
						prm_address    varchar2 default null,
						prm_hi         number default 8,
						prm_hf         number default 18,
						prm_semana     varchar2 default 'dia util' ) as

	ws_count number;

begin

	
	insert into user_netwall (usuario, nome_regra, tipo_regra, tp_net_address, net_address, hr_inicio, hr_final, dia_semana, dt_regra)
					values (prm_usuario, upper(prm_regra), prm_tipo, prm_tp_address, prm_address, prm_hi, prm_hf, prm_semana, sysdate);

	ws_count := SQL%ROWCOUNT;	
		
	commit;
		
	if ws_count <> 0 then
		htp.p('[1]'||fun.lang('Netwall adicionado'));
	else
		htp.p(fun.lang('Erro ao adicionar netwall'));
	end if;
	
exception when others then
	htp.p(sqlerrm);
end add_td_access;


procedure dl_td_access ( prm_usuario varchar2 default null,
						prm_nome varchar2 default null	) as

	ws_count number;

begin
	/*fcl.refresh_Session;*/
	
	delete from user_netwall 
	where trim(usuario) = upper(trim(prm_usuario)) and nome_regra = upper(trim(prm_nome));

	ws_count := SQL%ROWCOUNT; 
	
	commit;

	if ws_count <> 0 then
		htp.p('[1]'||fun.lang('Netwall excluido com sucesso'));
	else
		htp.p(fun.lang('Erro ao excluir'));
	end if;

end dl_td_access;


procedure object_access ( prm_usuario  varchar2 default null, 
						prm_conteudo varchar2 default 'FULL' ) as

	cursor obj_user is
	select CD_OBJETO,DECODE(NVL(ST_RESTRICAO,'I'),'S','LIBERADO','BLOQUEADO') as st_restricao, (select nm_objeto from objetos t2 where t2.cd_objeto = t1.cd_objeto) as nome
	from OBJECT_RESTRICTION t1
	where trim(USUARIO) = trim(prm_usuario);



	ws_linha obj_user%rowtype;
	
	ws_count	number;
	ws_grupo    varchar2(40);

begin
	/*fcl.refresh_Session;*/
	
	ws_grupo := '999999999';

	if prm_conteudo = 'FULL' then
		htp.p('<table class="linha">');
			htp.p('<thead>');
				htp.p('<tr>');
					htp.p('<th style="width: 25%;">'||fun.lang('USU&Aacute;RIO')||'</th>');
					htp.p('<th style="width: 20%;">ID</th>');
					htp.p('<th style="width: 35%;">'||fun.lang('NOME')||'</th>');
					htp.p('<th style="width: 10%;">'||fun.lang('REGRA')||'</th>');
					htp.p('<th style="width: 5%;"></th>');
				htp.p('</tr>');
			htp.p('</thead>');
			htp.p('<tbody id="ajax">');
	end if;
		open obj_user;
			loop
				fetch obj_user into ws_linha;
				exit when obj_user%notfound;
				htp.p('<tr id="'||trim(ws_linha.CD_OBJETO)||'linha">');
					htp.p('<td style="width: 25%;">'||upper(trim(prm_usuario))||'</td>');
					htp.p('<td style="width: 20%;">'||ws_linha.CD_OBJETO||'</td>');
					htp.p('<td style="width: 35%;">'||ws_linha.nome||'</td>');
					htp.p('<td style="width: 10%;">'||ws_linha.st_restricao||'</td>');
					htp.p('<td>');
						fcl.button_lixo('delete_object_access','prm_usuario|prm_obj', upper(trim(prm_usuario))||'|'||ws_linha.CD_OBJETO);
					htp.p('</td>');
					--htp.p('<td style="width: 5%;"><a title="'||fun.lang('Excluir')||'" class="remove" onclick="if(confirm(TR_CE)){ var linha = this.parentNode.parentNode; call(''delete_object_access'', ''prm_usuario='||upper(trim(prm_usuario))||'&prm_obj='||ws_linha.CD_OBJETO||''').then(function(resposta){ alerta('''', resposta.replace(''[1]'', '''')); if(resposta.indexOf(''[1]'') != -1){ linha.remove(); } }); }">X</a></td>');
				htp.p('</tr>');
			end loop;
		close obj_user;
	if prm_conteudo = 'FULL' then
		htp.tableClose;
		htp.p('<div class="listar"><a onclick="carregaPainel(''usuarios''); carrega(''list_users''); call_save(''''); document.getElementById(''titulo'').innerHTML = '''||fun.lang('USU&Aacute;RIOS')||''';">'||fun.lang('Listar usu&aacute;rios')||'</a></div>');
	end if;

end object_access;


procedure object_access_list ( prm_visao   varchar2 default null,
							prm_usuario varchar2 default null ) as 

	cursor obj_all is
	select cd_objeto, tp_objeto, nm_objeto, visao from
	( select cd_objeto, tp_objeto, nm_objeto, (select cd_micro_visao from ponto_avaliacao where cd_ponto = cd_objeto) visao from OBJETOS)
	where (visao = prm_visao or nvl(prm_visao, 'N/A') = 'N/A') and
	trim(cd_objeto) not in (select trim(cd_objeto) from object_restriction where usuario = prm_usuario)
	order by tp_objeto, nm_objeto;
	
	ws_option obj_all%rowtype;
	
	ws_grupo    varchar2(40) := '999999999';
	ws_padrao	varchar2(80) := 'PORTUGUESE';
begin

	begin
		select CONTEUDO into ws_padrao
		from   PARAMETRO_USUARIO
		where  cd_usuario = gbl.getUsuario and
			cd_padrao='CD_LINGUAGEM';
	exception
		when others then
			ws_padrao := 'PORTUGUESE';
	end;

	open obj_all;
		loop
			fetch obj_all into ws_option;
			exit when obj_all%notfound;
			if ws_grupo <> ws_option.tp_objeto then
				htp.p('<optgroup label="'||ws_option.tp_objeto||'"></optgroup>');
				ws_grupo := ws_option.tp_objeto;
			end if;
			htp.p('<option value="'||ws_option.cd_objeto||'">'||fun.utranslate('NM_OBJETO', ws_option.cd_objeto, ws_option.NM_OBJETO, ws_padrao)||' - '||ws_option.cd_objeto||'</option>');
		end loop;
	close obj_all;

end object_access_list;


procedure add_object_access ( prm_usuario varchar2 default null,
							prm_obj     varchar2 default null,
							prm_regra	  varchar2 default null ) as

	ws_count	number;

begin
	/*fcl.refresh_Session;*/
	select count(*) into ws_count
	from OBJECT_RESTRICTION
	where trim(CD_OBJETO) = trim(prm_obj) AND
	trim(USUARIO) = trim(prm_usuario);

	if ws_count = 0 then
		insert into OBJECT_RESTRICTION
		(USUARIO, CD_OBJETO, ST_RESTRICAO, DT_LAST)
		values
		(prm_usuario, prm_obj, NVL(prm_regra,'I'), sysdate );
			
		ws_count := SQL%ROWCOUNT;	
		
		commit;
		
		
		if ws_count = 1 then
			htp.p('[1]'||fun.lang('Bloqueio de objeto adicionado'));
		else
			htp.p(fun.lang('Erro ao adicionar bloqueio de objeto'));
		end if;
		
	else
		htp.p(fun.lang('Erro ao adicionar bloqueio de objeto, usu&aacute;rio j&aacute; possui'));
	end if;
exception when others then
	htp.p(sqlerrm);
end add_object_access;



procedure delete_object_access ( prm_usuario varchar2 default null,
								prm_obj     varchar2 default null ) as

	
	ws_count number;

begin
	/*fcl.refresh_Session;*/
	
		delete from OBJECT_RESTRICTION
		where trim(CD_OBJETO) = trim(prm_obj) and
		trim(USUARIO) = trim(prm_usuario);
		
		ws_count := SQL%ROWCOUNT;
		
		commit;
		
		if ws_count <> 0 then
			htp.p('[1]'||fun.lang('Bloqueio excluido com sucesso'));
		else
			htp.p(fun.lang('Erro ao excluir, bloqueio inexistente')||'!');
		end if;
exception
when others then
	htp.p('Erro ao excluir');
	insert into bi_log_sistema 
	values(sysdate, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - DELETE_OBJECT_ACCESS', PRM_USUARIO, 'ERRO');
	COMMIT;

end delete_object_access;


procedure column_access ( prm_usuario  varchar2 default null, 
						prm_conteudo varchar2 default 'FULL' ) as

	cursor col_user is
	select CD_COLUNA, CD_MICRO_VISAO
	from COLUMN_RESTRICTION
	where trim(USUARIO) = trim(prm_usuario);

	/*cursor col_micro is
	select NM_MICRO_VISAO, DS_MICRO_VISAO
	from MICRO_VISAO
	order by NM_MICRO_VISAO;*/

	ws_linha col_user%rowtype;
	/* ws_visao col_micro%rowtype; */
	ws_padrao varchar2(80) := 'PORTUGUESE';

begin

	begin
		select CONTEUDO into ws_padrao
		from   PARAMETRO_USUARIO
		where  cd_usuario = gbl.getUsuario and
			cd_padrao='CD_LINGUAGEM';
	exception
		when others then
			ws_padrao := 'PORTUGUESE';
	end;
	
	if prm_conteudo = 'FULL' then
		htp.p('<table class="linha">');
			htp.p('<thead>');
				htp.p('<tr>');
					htp.p('<th style="width: 25%;">'||fun.lang('USU&Aacute;RIO')||'</th>');
					htp.p('<th style="width: 25%;">'||fun.lang('COLUNA')||'</th>');
					htp.p('<th style="width: 25%;">'||fun.lang('NOME')||'</th>');
					htp.p('<th style="width: 20%;">'||fun.lang('MICRO VIS&Atilde;O')||'</th>');
					htp.p('<th style="width: 5%;"></th>');
				htp.p('</tr>');
			htp.p('</thead>');
			htp.p('<tbody id="ajax">');
	end if;
	
	open col_user;
		loop
			fetch col_user into ws_linha;
			exit when col_user%notfound;
			htp.p('<tr id="'||trim(ws_linha.CD_COLUNA)||'linha">');
				htp.p('<td style="width: 25%;">'||upper(trim(prm_usuario))||'</td>');
				htp.p('<td style="width: 25%;">'||ws_linha.CD_COLUNA||'</td>');
				htp.p('<td style="width: 25%;">'||fun.utranslate('NM_ROTULO', ws_linha.CD_MICRO_VISAO, fun.cdesc(ws_linha.CD_COLUNA, 'MICRO_COLUNA'), ws_padrao)||'</td>');
				htp.p('<td style="width: 20%;">'||ws_linha.CD_MICRO_VISAO||'</td>');
				htp.p('<td>');
					fcl.button_lixo('delete_column_access', 'prm_nome|prm_coluna|prm_visao', upper(trim(prm_usuario))||'|'||ws_linha.CD_COLUNA||'|'||ws_linha.cd_micro_visao);
				htp.p('</td>');
				--htp.p('<td style="width: 5%;"><a class="remove" title="'||fun.lang('Excluir')||'" onclick="if(confirm(TR_CE)){ var row = this.parentNode.parentNode; call(''delete_column_access'', ''prm_nome='||upper(trim(prm_usuario))||'&prm_coluna='||ws_linha.CD_COLUNA||'&prm_visao='||ws_linha.cd_micro_visao||''').then(function(resposta){ alerta(''feed-fixo'', resposta.replace(''[1]'', '''')); if(resposta.indexOf(''[1]'') != -1){ row.remove(); call(''menu_column_access'', ''prm_usuario='||prm_usuario||''').then(function(resposta2){ document.getElementById(''painel'').innerHTML = resposta2; }); } }); }">X</a></td>');
			htp.p('</tr>');
		end loop;
	close col_user;
	
	if prm_conteudo = 'FULL' then
			htp.p('</tbody>');
		htp.tableClose;
		htp.p('<div class="listar"><a onclick="carregaPainel(''usuarios''); carrega(''list_users''); call_save(''''); document.getElementById(''titulo'').innerHTML = '''||fun.lang('USU&Aacute;RIOS')||''';">'||fun.lang('Listar usu&aacute;rios')||'</a></div>');
	end if;

end column_access;

procedure add_column_access ( prm_usuario varchar2 default null,
							prm_coluna  varchar2 default null,
							prm_visao   varchar2 default null ) as

	ws_count number := 0;

begin
	/*fcl.refresh_Session;*/
	
	select count(*) into ws_count
	from COLUMN_RESTRICTION
	where trim(CD_COLUNA) = trim(prm_coluna) and
	trim(USUARIO) = trim(prm_usuario) and trim(cd_micro_visao) = trim(prm_visao);

	if ws_count = 0 then
	
		insert into COLUMN_RESTRICTION
		(USUARIO, CD_MICRO_VISAO, CD_COLUNA, ST_RESTRICAO, DT_LAST)
		values
		(prm_usuario, prm_visao, prm_coluna, 'I', sysdate);
		
		ws_count := SQL%ROWCOUNT;
		
		commit;

		if ws_count <> 0 then
			htp.p('[1]'||fun.lang('Bloqueio adicionado com sucesso'));
		else
			htp.p('FAIL');
		end if;
		
	else
		htp.p('FAIL Coluna j&aacute; adicionada');
	end if;

exception when others then
	htp.p('FAIL');
end add_column_access;

procedure delete_column_access ( prm_nome   varchar2 default null,
								prm_coluna varchar2 default null,
								prm_visao  varchar2 default null ) as

	
	ws_count number := 0;

begin
	/*fcl.refresh_Session;*/
	
	select count(*) into ws_count from COLUMN_RESTRICTION  
	where trim(USUARIO) = trim(prm_nome) and 
	trim(CD_COLUNA) = trim(prm_coluna) and 
	cd_micro_visao = trim(prm_visao);

	if ws_count = 1 then
		delete from COLUMN_RESTRICTION
		where trim(CD_COLUNA) = trim(prm_coluna) and
		trim(USUARIO) = trim(prm_nome) and
		cd_micro_visao = trim(prm_visao);
		
		ws_count := SQL%ROWCOUNT;
		
		commit;
	
		if ws_count <> 0 then
			htp.p('[1]'||fun.lang('Bloqueio excluido com sucesso'));
		else
			htp.p(fun.lang('Erro ao excluir'));
		end if;
		
	end if;
exception when others then
	htp.p(fun.lang('Erro ao excluir'));
end delete_column_access;

procedure list_column_access ( prm_visao    varchar2 default null, 
							prm_usuario  varchar2 default null ) as

	cursor col_all is
	select cd_coluna, nm_rotulo
	from micro_coluna
	where cd_micro_visao = prm_visao and
	cd_coluna not in (select cd_coluna from column_restriction where usuario = prm_usuario and cd_micro_visao = prm_visao) and
	st_agrupador <> 'TPT' and
	nm_rotulo is not null

	order by cd_coluna;

	ws_option col_all%rowtype;

	ws_padrao varchar2(80) := 'PORTUGUESE';

begin

	begin
		select CONTEUDO into ws_padrao
		from   PARAMETRO_USUARIO
		where  cd_usuario = gbl.getUsuario and
			cd_padrao='CD_LINGUAGEM';
	exception
		when others then
			ws_padrao := 'PORTUGUESE';
	end;
	
	open col_all;
		loop
			fetch col_all into ws_option;
			exit when col_all%notfound;
			htp.p('<option value="'||ws_option.CD_COLUNA||'">'||ws_option.CD_COLUNA||' - '||fun.utranslate('NM_ROTULO', upper(trim(prm_visao)), ws_option.NM_ROTULO, ws_padrao)||'</option>');
		end loop;
	close col_all;

end list_column_access;


procedure xlogout ( prm_sessao varchar2 default null ) as

	job_id              number;
	ws_id_session_web   Varchar2(80);
	ws_id_session_bi    Varchar2(80);	
	ws_usuario          Varchar2(200);	
	ws_cookie           owa_cookie.cookie;
begin

	if nvl(prm_sessao, 'N/A') = 'N/A' then
		ws_cookie          := owa_cookie.get('SESSION');
		ws_id_session_web  := ws_cookie.vals(1);
	else
		ws_id_session_web := prm_sessao;
	end if;
	ws_usuario       := gbl.getUsuario();
	ws_id_session_bi := ws_usuario||replace(sys_context('userenv','ip_address'), '.');

	-- Encerra Sessão no Navegador 
	owa_util.mime_header('text/html', FALSE, NULL);
	Owa_Cookie.Send(Name=>'SESSION', Value=> ws_id_session_web, Expires => Sysdate - 9);   -- 1095  = 3 anos 
	owa_util.http_header_close;

	-- Encerra sessão nas tabelas do BI 
	update active_sessions
	set status = 'I'
	where id_session = ws_id_session_bi
	and status     = 'A' ;
	delete from bi_sessao where cod = ws_id_session_web;  
	insert into bi_log_sistema values(sysdate, 'Sess&atilde;o encerrada.', ws_usuario, 'SESSAO');
	commit;

exception when others then
	htp.p(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
end xlogout;

procedure kickUser (prm_sessao_bi varchar2 default null) as

	WS_USER_SESSION_WEB 		VARCHAR2 (200);
	WS_COD_BI_SESSAO			VARCHAR2 (200);
	WS_NO_DATA					exception;

begin

	begin
		SELECT VALOR INTO WS_USER_SESSION_WEB FROM BI_SESSAO WHERE COD = PRM_SESSAO_BI;
	exception
	when no_data_found then
		raise ws_no_data;
	end;


	UPDATE ACTIVE_SESSIONS
	SET STATUS = 'I'
	WHERE USUARIO = WS_USER_SESSION_WEB
	AND STATUS     = 'A' ;
	
	DELETE BI_SESSAO WHERE COD = PRM_SESSAO_BI;
	INSERT INTO BI_LOG_SISTEMA VALUES(SYSDATE, 'Sess&atilde;o encerrada.', WS_USER_SESSION_WEB, 'SESSAO');

	COMMIT;

exception
when WS_NO_DATA then
	INSERT INTO BI_LOG_SISTEMA VALUES(SYSDATE, 'Erro ao tentar derrubar a sess&atilde;o do usuario '||WS_USER_SESSION_WEB, gbl.getUsuario, 'SESSAO');
	COMMIT;
when others then
	htp.p('FAIL');
	insert into bi_log_sistema values(sysdate, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - KICKUSER', gbl.getUsuario, 'ERRO');
	COMMIT;

end;

procedure alterorder (  prm_objeto varchar2 default null,
						prm_screen  varchar2 default 'DEFAULT',
						prm_valor  varchar2 default null) as

	ws_count   	number;
	ws_ordem   	varchar(400);
	ws_usuario 	varchar(80);
	ws_screen  	varchar2(100);
	ws_objeto  	varchar2(200);
	ws_prop    	varchar2(100);
	ws_reorder 	exception;   

begin
	ws_ordem   	:= prm_valor;
	ws_usuario 	:= gbl.getUsuario;
	ws_screen  	:= prm_screen;
	ws_objeto  	:= trim(prm_objeto);  
	ws_prop		:= fun.getProp(ws_objeto,'REORDER');

	if NVL(WS_PROP,'N') = 'S' then
		raise ws_reorder;
	end if;

	--TRATAMENTO PARA ORDENAÇÃO COM ERRO DE CALLMED. 22/12/21.
	if instr(UPPER(ws_ordem),'CALLMED')>0 then
		ws_ordem:=replace(UPPER(ws_ordem),',CALLMED','');
		ws_ordem:=replace(UPPER(ws_ordem),'CALLMED','');
	end if;

	if instr(UPPER(ws_ordem),'PRINT')>0 then
		ws_ordem:= replace(UPPER(ws_ordem),',PRINT','');
		ws_ordem:= replace(UPPER(ws_ordem),'PRINT','');
	end if;

	ws_ordem:=trim(ws_ordem);
	if ws_ordem like ',%' then
		ws_ordem :=substr(ws_ordem,2,1000);
	end if;

	select count(*) into ws_count from OBJECT_ATTRIB where CD_OBJECT = ws_objeto and screen = ws_screen and CD_PROP = 'ORDEM' and owner = ws_usuario;


	if  ws_count < 2 then
		if  ws_count = 1 then
			if nvl(ws_ordem, 'N/A') = 'N/A' then
				delete from OBJECT_ATTRIB
				 where owner = ws_usuario 
				   and navegador = 'DEFAULT' 
				   and screen    = ws_screen 
				   and cd_object = ws_objeto 
				   and cd_prop   = 'ORDEM';
			else
				update OBJECT_ATTRIB set PROPRIEDADE = nvl(ws_ordem, '1')
				 where owner = ws_usuario 
				   and navegador = 'DEFAULT' 
				   and screen 	 = ws_screen 
				   and cd_object = ws_objeto 
				   and cd_prop   = 'ORDEM';
			end if;
		else
			insert into OBJECT_ATTRIB values (ws_usuario, 'DEFAULT', ws_screen , ws_objeto, 'ORDEM',nvl(ws_ordem, '1'));
		end if;
		commit; 
	end if;
exception 
	when ws_reorder then
		htp.p('#alert '||fun.lang('Reordena&ccedil;&atilde;o bloqueada para este objeto')||'!');
	when others then
		rollback;
		htp.p('#alert '||fun.lang('Erro ao ordenar')||'!');
		insert into bi_log_sistema values(sysdate, 'Erro ao ordenar'||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, ws_usuario, 'ERRO');
		commit;		
end alterorder;


/* Salvar consulta */

--!!
procedure saveview ( prm_view varchar2 default null,
					prm_nome varchar2 default null,
					prm_desc varchar2 default null,
					prm_grupo varchar2 default null,
					prm_tipo varchar2 default 'u' ) as

	ws_count 		 number;
	ws_count_attrib  number;
	ws_repeated 	 number;
	ws_noadmin       exception;
begin

	if gbl.getNivel <> 'A' then
		raise ws_noadmin;
	end if;

	select count(*) into ws_count from PONTO_AVALIACAO where UPPER(CD_PONTO) = UPPER(prm_nome);
	if ws_count = 1 then
		htp.p('...');
	elsif ws_count = 0 then
		insert into PONTO_AVALIACAO values(UPPER(prm_nome), prm_desc, '', 'N', 'N', 'N', 'T', 'O', 'DWU', null, sysdate, prm_view, '', 'A', '', '1|1', '', '', '', '');
		insert into OBJETOS (cd_objeto, cd_grupo, nm_objeto, subtitulo, tp_objeto, cd_usuario, atributos, dt_ultima, ds_objeto) values(upper(prm_nome), prm_grupo, prm_desc, '', 'CONSULTA', gbl.getUsuario, '', sysdate, '');
		insert into OBJECT_ATTRIB values('DWU', 'DEFAULT', 'DEFAULT', UPPER(prm_nome), 'TP_GRUPO', prm_grupo);
		insert into OBJECT_ATTRIB values('DWU', 'DEFAULT', 'DEFAULT', UPPER(prm_nome), 'ORDEM', '1');
		insert into OBJECT_ATTRIB values('DWU', 'DEFAULT', 'DEFAULT', UPPER(prm_nome), 'FILTRO', 'PASSIVO');
		insert into OBJECT_ATTRIB values('DWU', 'DEFAULT', 'DEFAULT', UPPER(prm_nome), 'TIMER', '0');
		commit;
	else
		htp.p('#alert '||fun.lang('Erro na consulta')||'!');
	end if;

exception 
	when ws_noadmin then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end saveview;

/* Salva Calculo */

procedure savecolumn ( p_cd_coluna  varchar2 default null,
					p_visao 		varchar2 default null,
					prm_template varchar2 default 'N') as

ws_count number;

begin

	select count(*) into ws_count from MICRO_COLUNA where CD_COLUNA = upper(p_cd_coluna) and cd_micro_visao = upper(p_visao);
	
	if  ws_count = 0 then
		if prm_template = 'S' then
			insert into MICRO_COLUNA
			( cd_micro_visao, cd_coluna, nm_rotulo, st_gera_rel, st_agrupador, nm_mascara, cd_ligacao, st_com_codigo, st_alinhamento, st_resumido, st_negrito, st_invisivel, nm_unidade, formula, tipo, rotulo_c, color, hint, flexcol, limite, url)
			values
		( upper(p_visao), upper(p_cd_coluna), upper(p_cd_coluna), 'S', 'TPT', 'SEM', 'SEM', 'N', 'LEFT', 'N', 'S', 'N', '', '', 'C', '', '', '', '', '', '');
		else
			insert into MICRO_COLUNA
			( cd_micro_visao, cd_coluna, nm_rotulo, st_gera_rel, st_agrupador, nm_mascara, cd_ligacao, st_com_codigo, st_alinhamento, st_resumido, st_negrito, st_invisivel, nm_unidade, formula, tipo, rotulo_c, color, hint, flexcol, limite, url)
			values
		( upper(p_visao), upper(p_cd_coluna), '', 'S', 'SEM', 'SEM', 'SEM', 'N', 'LEFT', 'N', 'S', 'N', '', '', 'C', '', '', '', '', '', '');
		end if;
	else
		htp.p(fun.lang('Coluna j&aacute; existe')||'!');
	end if;

exception when others then
	htp.p(fun.lang('Erro ao adicionar coluna'));
end savecolumn;

/* Lista de Vari&aacute;vel Padr&atilde;o */

procedure filtro_geral  as

	ws_usuario  varchar2(80);
	ws_admin    varchar2(20);
	ws_noaccess exception;

begin

	ws_admin   := gbl.getNivel;
	ws_usuario := gbl.getUsuario;

	if ws_admin <> 'A' and ws_usuario = 'NOUSER' and fun.user_permissao(ws_usuario, 'TELAS_USUARIOS') = 'S' then
		raise ws_noaccess;
	end if;

	htp.p('<div class="searchbar">');
		htp.p('<a class="script" onclick="var valor = this.nextElementSibling.title; call(''getfiltro'', ''prm_usuario=''+valor).then(function(resposta){ document.getElementById(''content'').innerHTML = resposta; document.getElementById(''prm_usuario'').title = valor; document.getElementById(''prm_usuario'').children[0].innerHTML = (valor==''DWU''?''TODOS'':valor); });"></a>');
		fcl.fakeoption('usuario-filtro-tela', fun.lang('Busca por usu&aacute;rios'), '', 'lista-usuario-grupo', 'N', 'N' );
	htp.p('</div>');
		
	htp.p('<table class="linha">');
		htp.p('<thead>');
			htp.p('<tr>');
				htp.p('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); if (document.getElementById(''usuario-filtro-tela'').value !== ''undefined'') {ajax(''list'', ''getfiltro'', ''prm_usuario=''+document.getElementById(''usuario-filtro-tela'').value+''&prm_order=1&prm_dir=''+dir, false, ''content'')};">'||fun.lang('USU&Aacute;RIO')||'</a></th>');
				htp.p('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); if (document.getElementById(''usuario-filtro-tela'').value !== ''undefined'') {ajax(''list'', ''getfiltro'', ''prm_usuario=''+document.getElementById(''usuario-filtro-tela'').value+''&prm_order=2&prm_dir=''+dir, false, ''content'')};">'||fun.lang('VIS&Atilde;O')||'</a></th>');
				htp.p('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); if (document.getElementById(''usuario-filtro-tela'').value !== ''undefined'') {ajax(''list'', ''getfiltro'', ''prm_usuario=''+document.getElementById(''usuario-filtro-tela'').value+''&prm_order=3&prm_dir=''+dir, false, ''content'')};">'||fun.lang('COLUNA')||'</a></th>');
				htp.p('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); if (document.getElementById(''usuario-filtro-tela'').value !== ''undefined'') {ajax(''list'', ''getfiltro'', ''prm_usuario=''+document.getElementById(''usuario-filtro-tela'').value+''&prm_order=4&prm_dir=''+dir, false, ''content'')};">'||fun.lang('CONDI&Ccedil;&Atilde;O')||'</a></th>');
				htp.p('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); if (document.getElementById(''usuario-filtro-tela'').value !== ''undefined'') {ajax(''list'', ''getfiltro'', ''prm_usuario=''+document.getElementById(''usuario-filtro-tela'').value+''&prm_order=5&prm_dir=''+dir, false, ''content'')};">'||fun.lang('VALOR')||'</a></th>');
				htp.p('<th>'||fun.lang('LIGA&Ccedil;&Atilde;O')||'</th>');
				htp.p('<th></th>');
			htp.p('</tr>');
		htp.p('</thead>');
		htp.p('<tbody id="ajax" data-dir="1">');
		htp.p('</tbody>');
	htp.p('</table>');

exception
	when ws_noaccess then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end filtro_geral;

procedure getcolumn( prm_visao varchar2 default null ) as

	cursor crs_colunas is
	select cd_coluna, nm_rotulo
	from micro_coluna
	where cd_micro_visao = prm_visao and nm_rotulo <> ''''
	order by cd_coluna asc;

	ws_coluna crs_colunas%rowtype;

	ws_padrao varchar2(80) := 'PORTUGUESE';

begin
	/*fcl.refresh_Session;*/

	begin
		select CONTEUDO into ws_padrao
		from   PARAMETRO_USUARIO
		where  cd_usuario = gbl.getUsuario and
			cd_padrao='CD_LINGUAGEM';
	exception
		when others then
			ws_padrao := 'PORTUGUESE';
	end;

	htp.formSelectOpen( cname => 'coluna', cattributes => ' id="coluna"');
		open crs_colunas;
			loop
				fetch crs_colunas into ws_coluna;
				exit when crs_colunas%notfound;
				fcl.formSelectOption( '['||ws_coluna.cd_coluna||'] '||fun.utranslate('NM_ROTULO', prm_visao, ws_coluna.nm_rotulo, ws_padrao),ws_coluna.cd_coluna, '','');
			end loop;
		close crs_colunas;
	htp.formSelectClose;

end getcolumn;

procedure getfiltro( prm_usuario varchar2 default null,
					prm_order varchar2 default '1',
					prm_dir varchar2 default '1' ) as

	cursor crs_filtros is
	select trim(cd_usuario), decode(trim(cd_usuario),'DWU','TODOS',trim(cd_usuario)) nm_usuario, micro_visao, cd_coluna, condicao, conteudo, ligacao, cd_filtro
	  from filtros
	 where ( trim(cd_usuario)  	= trim(prm_usuario) or 
			trim(cd_usuario) 	in 
			(select trim(cd_usuario) 
			   from gusers_itens 
			  where cd_group 	= trim(prm_usuario)
			) 
		or trim(prm_usuario) 	= 'DWU' --'TODOS'
		)
	   and tp_filtro 			= 'geral'
	 order by case when prm_dir = '1' then decode(prm_order, '1', cd_usuario, '2', micro_visao, '3', cd_coluna, '4', condicao, '5', conteudo, micro_visao) end asc,
			  case when prm_dir = '2' then decode(prm_order, '1', cd_usuario, '2', micro_visao, '3', cd_coluna, '4', condicao, '5', conteudo, micro_visao) end desc;

	ws_filtro crs_filtros%rowtype;

	ws_counter 		number := 0;
	ws_ligacao 		varchar2(80);
	ws_dir     		number := 1;
	ws_padrao  		varchar2(80) := 'PORTUGUESE';
	ws_usuario		varchar2(200);

begin
	/*fcl.refresh_Session;*/
	ws_usuario := trim(prm_usuario);

	begin
		select CONTEUDO into ws_padrao
		from   PARAMETRO_USUARIO
		where  cd_usuario = gbl.getUsuario and
			cd_padrao='CD_LINGUAGEM';
	exception
		when others then
			ws_padrao := 'PORTUGUESE';
	end;

	htp.p('<div class="searchbar">');
		htp.p('<a class="script" onclick="var valor = this.nextElementSibling.title; call(''getfiltro'', ''prm_usuario=''+valor).then(function(resposta){ document.getElementById(''content'').innerHTML = resposta; document.getElementById(''prm_usuario'').title = valor; document.getElementById(''prm_usuario'').children[0].innerHTML = (valor==''DWU''?''TODOS'':valor); });"></a>');
		fcl.fakeoption('usuario-filtro-tela', nvl(ws_usuario, 'Lista de usu&aacute;rios'), ws_usuario, 'lista-usuario-grupo', 'N', 'N', prm_desc => replace(ws_usuario,'DWU','TODOS') );
	htp.p('</div>');
	
	htp.p('<table class="linha">');
		htp.p('<thead>');
			htp.p('<tr>');
				htp.p('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); if (document.getElementById(''usuario-filtro-tela'').title !== ''undefined'') {ajax(''list'', ''getfiltro'', ''prm_usuario=''+document.getElementById(''usuario-filtro-tela'').title+''&prm_order=1&prm_dir=''+dir, false, ''content'')};">'||fun.lang('USU&Aacute;RIO')||'</a></th>');
				htp.p('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); if (document.getElementById(''usuario-filtro-tela'').title !== ''undefined'') {ajax(''list'', ''getfiltro'', ''prm_usuario=''+document.getElementById(''usuario-filtro-tela'').title+''&prm_order=2&prm_dir=''+dir, false, ''content'')};">'||fun.lang('VIS&Atilde;O')||'</a></th>');
				htp.p('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); if (document.getElementById(''usuario-filtro-tela'').title !== ''undefined'') {ajax(''list'', ''getfiltro'', ''prm_usuario=''+document.getElementById(''usuario-filtro-tela'').title+''&prm_order=3&prm_dir=''+dir, false, ''content'')};">'||fun.lang('COLUNA')||'</a></th>');
				htp.p('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); if (document.getElementById(''usuario-filtro-tela'').title !== ''undefined'') {ajax(''list'', ''getfiltro'', ''prm_usuario=''+document.getElementById(''usuario-filtro-tela'').title+''&prm_order=4&prm_dir=''+dir, false, ''content'')};">'||fun.lang('CONDI&Ccedil;&Atilde;O')||'</a></th>');
				htp.p('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); if (document.getElementById(''usuario-filtro-tela'').title !== ''undefined'') {ajax(''list'', ''getfiltro'', ''prm_usuario=''+document.getElementById(''usuario-filtro-tela'').title+''&prm_order=5&prm_dir=''+dir, false, ''content'')};">'||fun.lang('VALOR')||'</a></th>');
				htp.p('<th>'||fun.lang('LIGA&Ccedil;&Atilde;O')||'</th>');
				htp.p('<th></th>');
			htp.p('</tr>');
		htp.p('</thead>');
		
		if to_number(prm_dir) = 1 then ws_dir := 2; end if;
		
		htp.p('<tbody id="ajax" data-dir="'||ws_dir||'">');
	
			open crs_filtros;
				loop
					fetch crs_filtros into ws_filtro;
					exit when crs_filtros%notfound;

					ws_counter := ws_counter+1;

					htp.p('<tr>');
						htp.p('<td>'||ws_filtro.nm_usuario||'</td>');
						htp.p('<td id="'||ws_counter||'-visao" title="'||ws_filtro.micro_visao||'">'||fun.utranslate('NM_MICRO_VISAO', 'MICRO_VISAO', ws_filtro.micro_visao, ws_padrao)||'</td>');
						
						htp.p('<td>');
							htp.p('<a class="script" onclick="call(''edit_filtro'',''prm_key='||ws_filtro.cd_filtro||'&prm_valor=''+encodeURIComponent(document.getElementById(''filtro-coluna-'||ws_counter||''').title)+''&prm_tipo=COLUNA-USER'').then(function(resposta){ if(resposta.indexOf(''Erro'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
							fcl.fakeoption('filtro-coluna-'||ws_counter, '', ws_filtro.cd_coluna, 'lista-colunas', 'N', 'N', ws_counter||'-visao', '');
						htp.p('</td>');
						
							htp.p('<td>');
								htp.p('<a class="script" onclick="call(''edit_filtro'',''prm_key='||ws_filtro.cd_filtro||'&prm_valor=''+encodeURIComponent(document.getElementById(''filtro-condicao-'||ws_counter||''').title)+''&prm_tipo=CONDICAO-USER'').then(function(resposta){ if(resposta.indexOf(''Erro'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
								fcl.fakeoption('filtro-condicao-'||ws_counter||'', '', ws_filtro.condicao, 'lista-condicoes', 'N', 'N', '', '', '', fun.dcondicao(ws_filtro.condicao));
							htp.p('</td>');
							
							
							htp.p('<td>');
								
								htp.p('<a class="script" onclick="call(''edit_filtro'',''prm_key='||ws_filtro.cd_filtro||'&prm_valor=''+encodeURIComponent(document.getElementById(''filtro-conteudo-'||ws_counter||''').title)+''&prm_tipo=CONTEUDO-USER'').then(function(resposta){ if(resposta.indexOf(''Erro'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
								
								begin
								
									select cd_ligacao into ws_ligacao from micro_coluna where cd_coluna = ws_filtro.cd_coluna and cd_micro_visao = ws_filtro.micro_visao;
								
									if ws_ligacao <> 'SEM' then
										fcl.fakeoption('filtro-conteudo-'||ws_counter, '', ws_filtro.conteudo, 'lista-valores', 'S', 'N', ws_counter||'-visao', '', 'filtro-coluna-'||ws_counter, fun.cdesc(ws_filtro.conteudo, ws_ligacao));
									else
										fcl.fakeoption('filtro-conteudo-'||ws_counter, '', ws_filtro.conteudo, 'lista-valores', 'S', 'N', ws_counter||'-visao', '', 'filtrou-coluna');
									end if;
								
								exception when others then
									
									fcl.fakeoption('filtro-conteudo-'||ws_counter, '', ws_filtro.conteudo, 'lista-valores', 'S', 'N', ws_counter||'-visao', '', 'filtrou-coluna');
								
								end;
								
							htp.p('</td>');
							
							htp.p('<td>');
								htp.p('<select id="filtro-ligacao-'||ws_counter||'" data-default="'||ws_filtro.ligacao||'" onchange="call(''edit_filtro'',''prm_key='||ws_filtro.cd_filtro||'&prm_valor=''+this.value+''&prm_tipo=LIGACAO-USER'').then(function(resposta){ if(resposta.indexOf(''Erro'') == -1){ alerta(''feed-fixo'', TR_AL); } });">');
									if ws_filtro.ligacao = 'and' then
										htp.p('<option value="and" selected>and</option>');
										htp.p('<option value="or">or</option>');
									else
										htp.p('<option value="and">and</option>');
										htp.p('<option value="or" selected>or</option>');
									end if;
								htp.p('</select>');
							htp.p('</td>');
							htp.p('<td>');
								fcl.button_lixo('deletefiltro','prm_key', ws_filtro.cd_filtro);
							htp.p('</td>');
						--htp.p('<td><a title="'||fun.lang('Excluir')||'" class="remove" onclick="if(confirm(TR_CE)){ var row = this.parentNode.parentNode; row.classList.add(''removing''); call(''deletefiltro'', ''prm_key='||ws_filtro.cd_filtro||''').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', '''||fun.lang('Filtro excluido com sucesso')||'!''); row.remove(); } else { row.classList.remove(''removing''); alerta(''feed-fixo'', '''||fun.lang('Erro ao excluir o filtro')||'!''); } }); }">X</a></td>');
					htp.p('</tr>');
				end loop;
			close crs_filtros;
		htp.p('</tbody>');
	htp.p('</table>');

end getfiltro;


--!!
procedure setfiltro( prm_usuario  varchar2 default null,
					prm_visao    varchar2 default null,
					prm_coluna   varchar2 default null,
					prm_condicao varchar2 default null,
					prm_conteudo varchar2 default null,
					prm_ligacao  varchar2 default 'and' ) as


	ws_last     number;
	ws_contador number := 0;
	ws_count    number := 0;
	ws_key      number := 0;
	ws_inc      number := 0;
	ws_converte varchar2(800);
	ws_usuario  varchar2(80);

	ws_nouser	exception;

begin

	ws_usuario := gbl.getUsuario;

	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if;
	
	ws_converte := fun.converte(prm_conteudo);

    for a in(select column_value as visao from table(fun.vpipe(prm_visao))) loop
        for i in(select column_value as usuario from table((fun.vpipe(prm_usuario)))) loop

            for j in(select column_value as conteudo from table(fun.vpipe(ws_converte))) loop
                    
                select nvl(max(cd_filtro), 0) + 1 into ws_key from filtros;
                
                select count(*) into ws_contador from filtros 
                    where cd_usuario = i.usuario 
                    and  micro_visao = a.visao
                    and  cd_coluna   = prm_coluna
                    and  condicao    = prm_condicao
                    and  conteudo    = j.conteudo
                    and  ligacao     = prm_ligacao
                    and  tp_filtro   = 'geral';

                    if ws_contador = 0 then
                        insert into filtros (cd_usuario, cd_objeto, micro_visao, cd_coluna, condicao, conteudo, ligacao, st_agrupado, cd_filtro, tp_filtro, cd_criado)
                        values(i.usuario, '', a.visao, prm_coluna, prm_condicao, j.conteudo, prm_ligacao, 'N', ws_key, 'geral', ws_usuario);
                    end if;
            end loop;

            commit;

        end loop;
    end loop;

	htp.p('OK');

exception 
	when ws_nouser then
		rollback;
		htp.p('Sem permiss&atilde;o!');
	when others then
		rollback;
		htp.p(sqlerrm||' - '||ws_key);
		htp.p('FAIL');
end setfiltro;

procedure copfiltro (prm_usuario  	    varchar2 default null,
					 prm_usuario_origem varchar2 default null ) as


	ws_contador 	number := 0;
	ws_key      	number := 0;
	ws_usuario  	varchar2(800);
	ws_usu_filtro	varchar2(100);
	
	ws_nouser		  exception;
	ws_not_filter     exception;

begin

	ws_usuario := gbl.getUsuario;

	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if;
	
	select count(*) into ws_usu_filtro from filtros where cd_usuario = prm_usuario_origem and tp_filtro = 'geral';

	if ws_usu_filtro = 0 then
		raise ws_not_filter;
	end if;

	for i in(select column_value as usuario from table((fun.vpipe(prm_usuario)))) loop

		select nvl(max(cd_filtro), 0) + 1 into ws_key from filtros;

		for j in(select cd_usuario, micro_visao, cd_coluna, condicao, conteudo, ligacao from filtros where cd_usuario = prm_usuario_origem and tp_filtro = 'geral') loop

			select count(*) into ws_contador from filtros 
				where cd_usuario = i.usuario 
				and  micro_visao = j.micro_visao
				and  cd_coluna   = j.cd_coluna
				and  condicao    = j.condicao
				and  conteudo    = j.conteudo
				and  ligacao     = j.ligacao
				and  tp_filtro   = 'geral';

				if ws_contador = 0 then
					insert into filtros (cd_usuario, cd_objeto, micro_visao, cd_coluna, condicao, conteudo, ligacao, st_agrupado, cd_filtro, tp_filtro, cd_criado)
                    values(i.usuario, '', j.micro_visao, j.cd_coluna, j.condicao, j.conteudo, j.ligacao, 'N', ws_key, 'geral', ws_usuario);
				end if;

			ws_key := ws_key + 1;

		end loop;

		commit;

	end loop;

	htp.p('OK');

exception 
	when ws_nouser then
		rollback;
		htp.p('Sem permiss&atilde;o!');
	when ws_not_filter then
		htp.p('FAIL FILTRO '||fun.lang('O Usu&aacute;rio n&atilde;o possui Filtros a serem copiados')||'!');
	when others then
		rollback;
		htp.p(sqlerrm||' - '||ws_key);
		htp.p('FAIL');
end copfiltro;


procedure setdestaque ( prm_usuario    varchar2 default null,
						prm_objeto     varchar2 default null,
						prm_coluna     varchar2 default null,
						prm_condicao   varchar2 default null,
						prm_conteudo   varchar2 default null,
						prm_fundo      varchar2 default null, 
						prm_fonte      varchar2 default null, 
						prm_tipo       varchar2 default null,
						prm_prioridade varchar2 default null ) as


	ws_last     number;
	ws_count    number := 0;
	ws_key      number := 0;
	ws_inc      number := 0;
	ws_converte varchar2(800);
	ws_objeto	varchar2(80);

begin
	ws_objeto 	:= prm_objeto;
	ws_converte := fun.converte(prm_conteudo);

	select nvl2(max(cd_destaque), max(cd_destaque), 0)+1 into ws_key from destaque;

	loop

		ws_inc := ws_inc+1;

		select count(*) into ws_count from destaque where cd_destaque = ws_key;

		if ws_count > 0 then
			select ws_key+ws_inc into ws_key from destaque;
		else
			exit;
		end if;
	end loop;

	insert into destaque values(prm_usuario, prm_objeto, prm_coluna, prm_condicao, ws_converte, prm_fundo, prm_fonte, prm_tipo, prm_prioridade, ws_key);
	insert into bi_log_sistema (dt_log, ds_log, nm_usuario, nm_procedure) values (sysdate, 'Destaque #'||ws_key||', do objeto #'||ws_objeto||' coluna #'||prm_coluna||', valor #'||upper(ws_converte)||' adicionado com sucesso', gbl.getUsuario, 'EVENTO');
	commit;

exception when others then
	htp.p(sqlerrm);
	htp.p('#alert '||fun.lang('Erro ao adicionar')||'!');
end setdestaque;


-- Duplica um destaque 
procedure dupdestaque ( prm_cd_destaque  varchar2 default null ) as
	
	ws_msg      varchar2(200); 
	ws_key      number;  
	ws_raise    exception;  	

begin

	if prm_cd_destaque is null then 
		ws_msg := '#alert '||fun.lang('Erro ao duplicar destaque, c&oacute;digo do destaque n&atild;o informado')||'!';
		raise ws_raise; 
	end if; 

	select max(cd_destaque) + 1 into ws_key from destaque;

	insert into destaque (cd_usuario, cd_objeto, cd_coluna, condicao, conteudo, cor_fundo, cor_fonte, tipo_destaque, prioridade, cd_destaque) 
				( select a.cd_usuario, a.cd_objeto, a.cd_coluna, a.condicao, a.conteudo, a.cor_fundo, a.cor_fonte, a.tipo_destaque, a.prioridade, ws_key
					from destaque a
					where cd_destaque = prm_cd_destaque );
	commit;
	htp.p('Destaque duplicado com sucesso');	
exception 
	when ws_raise then 
		htp.p(ws_msg);	
	when others then
		insert into bi_log_sistema values(sysdate, 'Erro duplicando destaque (DUPDESTAQUE):'||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, 'DWU', 'ERRO');
		commit; 
		htp.p('#alert '||fun.lang('Erro ao duplicar, verique o log do sistema')||'!');
end dupdestaque;




--!!
procedure deletefiltro ( prm_key  number default null ) as

	ws_count   number;
	ws_usuario varchar2(80);

	ws_fail    exception;
	ws_nouser  exception;

begin

	ws_usuario := gbl.getUsuario;
	
	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if;
	
	delete from filtros where cd_filtro = prm_key/* and tp_filtro = 'geral'*/;
	
	ws_count := SQL%ROWCOUNT;
	
	if ws_count <> 0 then
		commit;
		
		insert into bi_log_sistema values (sysdate, 'Filtro #'||prm_key||' excluido', ws_usuario, 'EVENTO');
		commit;
		
	else
		raise ws_fail;
	end if;


exception 
	when ws_nouser then
		htp.p('Sem permiss&atilde;o!');
	when ws_fail then
		htp.p('FAIL');
	when others then
		htp.p('FAIL');
end deletefiltro;


procedure preferencias( prm_usuario varchar2 default null) as

	ws_inline  number;
	ws_usuario varchar2(80);
begin
	/*fcl.refresh_Session;*/
	select count(*) into ws_inline from preferencias where usu_nome = prm_usuario and propriedade = 'inline';

	ws_usuario := gbl.getUsuario;

	if ws_inline = 1 then
		htp.p(''||fun.lang('Posicionar menus na horizontal')||': <input type="checkbox" value="inline" checked="checked" onchange=" if(this.checked == false){ ajax(''fly'', ''a_preferencias'', ''prm_usuario='||ws_usuario||'&prm_propriedade=inline&prm_acao=d'', ''true''); li = parent.document.getElementById(''pro6'').getElementsByTagName(''li''); for(i=0;i<li.length;i++){ li[i].setAttribute(''class'',''''); } } else { ajax(''fly'', ''a_preferencias'', ''prm_usuario='||ws_usuario||'&prm_propriedade=inline&prm_acao=i'', ''true''); li = parent.document.getElementById(''pro6'').getElementsByTagName(''li''); for(i=0;i<li.length;i++){ li[i].setAttribute(''class'',''inline''); } }" />');
	else
		htp.p(''||fun.lang('Posicionar menus na horizontal')||': <input type="checkbox" value="inline" onchange=" if(this.checked == true){ ajax(''fly'', ''a_preferencias'', ''prm_usuario='||ws_usuario||'&prm_propriedade=inline&prm_acao=i'', ''true''); li = parent.document.getElementById(''pro6'').getElementsByTagName(''li''); for(i=0;i<li.length;i++){ li[i].setAttribute(''class'',''inline''); } } else { ajax(''fly'', ''a_preferencias'', ''prm_usuario='||ws_usuario||'&prm_propriedade=inline&prm_acao=d'', ''true''); li = parent.document.getElementById(''pro6'').getElementsByTagName(''li''); for(i=0;i<li.length;i++){ li[i].setAttribute(''class'',''''); } }" />');
	end if;

	exception when others then
		htp.p(sqlerrm);
end preferencias;

procedure a_preferencias( prm_usuario     varchar2 default null,
						prm_propriedade varchar2 default null,
						prm_acao        varchar2 default null ) as

begin
	/*fcl.refresh_Session;*/
	if prm_acao = 'd' then
		delete from preferencias where usu_nome = prm_usuario and propriedade = prm_propriedade;
	end if;

	if prm_acao = 'i' then
		insert into preferencias values(prm_usuario, prm_propriedade);
	end if;

	exception when others then
		htp.p(sqlerrm);
end a_preferencias;

--!!
procedure blink ( prm_objeto varchar2 default null,
				prm_visao  varchar2 default null,
				prm_order  varchar2 default '1',
				prm_dir    varchar2 default '1' ) as


	/*cursor crs_efeitos is
	select cd_usuario, cd_objeto, cd_coluna, condicao, conteudo, cor_fundo, cor_fonte, tipo_destaque, prioridade, cd_destaque
	from destaque
	where cd_objeto = trim(prm_objeto)
	order by
		case when prm_dir = '1' then decode(prm_order, '1', cd_usuario, '2', cd_coluna, '3', condicao, '4', conteudo, '5', tipo_destaque, cd_usuario) end asc,
		case when prm_dir = '2' then decode(prm_order, '1', cd_usuario, '2', cd_coluna, '3', condicao, '4', conteudo, '5', tipo_destaque, cd_usuario) end desc;

	ws_efeito crs_efeitos%rowtype;*/
	
	cursor crs_efeitosb(prm_usuario varchar2) is
	select cd_usuario, decode(cd_usuario,'DWU','TODOS',cd_usuario) nm_usuario, cd_objeto, cd_coluna, condicao, conteudo, cor_fundo, cor_fonte, tipo_destaque, prioridade, cd_destaque
	from destaque
	where cd_objeto = trim(prm_objeto) 
	and (cd_usuario = prm_usuario or cd_usuario = 'DWU' or gbl.getNivel = 'A')
	order by case when prm_dir = '1' 	then decode(prm_order, '1', cd_usuario, '2', cd_coluna, '3', condicao, '4', conteudo,'5' ,tipo_destaque, '6', prioridade, cd_usuario) end desc,
			case when prm_dir = '2' 	then decode(prm_order, '1', cd_usuario, '2', cd_coluna, '3', condicao, '4', conteudo,'5' ,tipo_destaque, '6', prioridade, cd_usuario) end asc;

	ws_efeitob crs_efeitosb%rowtype;


	ws_counter  number := 0;
	ws_dir      number := 1;
	ws_tipo     varchar2(80);
	ws_usuario  varchar2(80);
	ws_admin    varchar2(80);
	ws_tpvalor  varchar2(100);

	ws_nouser   exception;

begin

	ws_usuario := gbl.getUsuario;
	ws_admin   := gbl.getNivel;

	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if;

	select tp_objeto into ws_tipo from objetos where cd_objeto = prm_objeto;

	htp.p('<input type="hidden" id="destaque-visao" value="'||prm_visao||'" title="'||prm_visao||'"/>');

	htp.p('<div style="margin-top: 10px;">');
		htp.p('<table class="linha">');
			htp.p('<thead>');
				htp.p('<tr>');
					htp.p('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''blink'', ''prm_objeto='||prm_objeto||'&prm_visao='||prm_visao||'&prm_order=1&prm_dir=''+dir, false, ''content'');">'||fun.lang('USU&Aacute;RIO')||'</a></th>');
					htp.p('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''blink'', ''prm_objeto='||prm_objeto||'&prm_visao='||prm_visao||'&prm_order=2&prm_dir=''+dir, false, ''content'');">'||fun.lang('COLUNA')||'</a></th>');
					htp.p('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''blink'', ''prm_objeto='||prm_objeto||'&prm_visao='||prm_visao||'&prm_order=3&prm_dir=''+dir, false, ''content'');">'||fun.lang('CONDI&Ccedil;&Atilde;O')||'</a></th>');
					htp.p('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''blink'', ''prm_objeto='||prm_objeto||'&prm_visao='||prm_visao||'&prm_order=4&prm_dir=''+dir, false, ''content'');">'||fun.lang('VALOR')||'</a></th>');
					
					if ws_tipo = 'CONSULTA' or ws_tipo = 'BROWSER' then
						
						htp.p('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''blink'', ''prm_objeto='||prm_objeto||'&prm_visao='||prm_visao||'&prm_order=5&prm_dir=''+dir, false, ''content'');">'||fun.lang('TIPO')||'</a></th>');
					
					end if;

					htp.p('<th>'||fun.lang('COR DO FUNDO')||'</th>');

					if ws_tipo not in ('BARRAS', 'LINHAS', 'PIZZA', 'COLUNAS') then
						
						htp.p('<th>'||fun.lang('COR DA FONTE')||'</th>');
					
					end if;

					htp.p('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''blink'', ''prm_objeto='||prm_objeto||'&prm_visao='||prm_visao||'&prm_order=6&prm_dir=''+dir, false, ''content'');">'||fun.lang('PRIORIDADE')||'</a></th>');
					htp.p('<th></th>');
					htp.p('<th></th>');
				htp.p('<tr>');
			htp.p('</thead>');

			if to_number(prm_dir) = 1 then 
				ws_dir := 2; 
			end if;

			htp.p('<tbody id="ajax" data-dir="'||ws_dir||'">');

				open crs_efeitosb(ws_usuario);
					loop
						fetch crs_efeitosb into ws_efeitob;
						exit when crs_efeitosb%notfound;

							if ws_admin = 'A' or ws_efeitob.cd_usuario = ws_usuario then
								
								htp.p('<tr>');
								
									if ws_admin = 'A' then
										htp.p('<td>');
											htp.p('<a class="script" onclick="call(''edit_blink'',''prm_key='||ws_efeitob.cd_destaque||'&prm_valor=''+document.getElementById(''destaque-usuario-'||ws_counter||''').title+''&prm_alter=USUARIO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
											fcl.fakeoption('destaque-usuario-'||ws_counter, 'Lista de usuarios', ws_efeitob.cd_usuario, 'lista-usuario-grupo', 'N', 'N', '', '', prm_desc => ws_efeitob.nm_usuario);
										htp.p('</td>');
									else
										htp.p('<td class="readonly"><input readonly type="text" id="destaque-usuario-'||ws_counter||'" data-default="'||ws_efeitob.cd_usuario||'" value="'||ws_efeitob.cd_usuario||'" /></td>');
									end if;

									if ws_tipo = 'BROWSER' then
										htp.p('<td class="fake-list">');
											htp.p('<a class="script" onclick="call(''edit_blink'',''prm_key='||ws_efeitob.cd_destaque||'&prm_valor=''+document.getElementById(''destaque-coluna-'||ws_counter||''').title+''&prm_alter=COLUNA'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
											fcl.fakeoption('destaque-coluna-'||ws_counter, 'Lista de colunas', ws_efeitob.cd_coluna, 'lista-coluna-destaq-browser', 'N', 'N', 'destaque-visao', '', prm_adicional => prm_objeto);											    
										htp.p('</td>');
									elsif ws_tipo = 'VALOR' then
										htp.p('<td class="fake-list">');
											/*fcl.fakeoption('destaque-coluna-'||ws_counter, 'Lista de colunas', ws_efeitob.cd_coluna, 'lista-colunas', 'N', 'N', 'destaque-visao', '');*/
											htp.p('<input type="text" value="'||ws_efeitob.cd_coluna||'" class="readonly" readonly />');
										htp.p('</td>');
									else
										htp.p('<td class="fake-list">');
											htp.p('<a class="script" onclick="call(''edit_blink'',''prm_key='||ws_efeitob.cd_destaque||'&prm_valor=''+document.getElementById(''destaque-coluna-'||ws_counter||''').title+''&prm_alter=COLUNA'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
											fcl.fakeoption('destaque-coluna-'||ws_counter, 'Lista de colunas', ws_efeitob.cd_coluna, 'lista-colunas', 'N', 'N', 'destaque-visao', '');
										htp.p('</td>');
									end if;

									htp.p('<td>');
										htp.p('<a class="script" onclick="call(''edit_blink'',''prm_key='||ws_efeitob.cd_destaque||'&prm_valor=''+document.getElementById(''destaque-condicao-'||ws_counter||''').title+''&prm_alter=CONDICAO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
										if ws_tipo not in ('BARRAS', 'LINHAS', 'PIZZA', 'COLUNAS') then
											fcl.fakeoption('destaque-condicao-'||ws_counter, 'Lista de condi&ccedil;&otilde;es', ws_efeitob.condicao, 'lista-condicoes', 'N', 'N', '', '', 'normal');
										else
											fcl.fakeoption('destaque-condicao-'||ws_counter, 'Lista de condi&ccedil;&otilde;es', ws_efeitob.condicao, 'lista-condicoes', 'N', 'N', '', '', 'graph');
										end if;
									htp.p('</td>');

									if ws_tipo = 'BROWSER' then
										htp.p('<td>');
											htp.p('<a class="script" onclick="call(''edit_blink'',''prm_key='||ws_efeitob.cd_destaque||'&prm_valor=''+encodeURIComponent(document.getElementById(''destaque-conteudo-'||ws_counter||''').title)+''&prm_alter=CONTEUDO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
											fcl.fakeoption('destaque-conteudo-'||ws_counter, fun.lang('Lista de valores'), ws_efeitob.conteudo, 'lista-valores-browser', 'S', 'N', 'destaque-visao', '', 'destaque-coluna-'||ws_counter);
										htp.p('</td>');
									else
										htp.p('<td>');
											htp.p('<a class="script" onclick="call(''edit_blink'',''prm_key='||ws_efeitob.cd_destaque||'&prm_valor=''+encodeURIComponent(document.getElementById(''destaque-conteudo-'||ws_counter||''').title)+''&prm_alter=CONTEUDO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
											fcl.fakeoption('destaque-conteudo-'||ws_counter, fun.lang('Lista de valores'), ws_efeitob.conteudo, 'lista-valores', 'S', 'N', 'destaque-visao', '', 'destaque-coluna-'||ws_counter);
										htp.p('</td>');
									end if;
									
									if ws_tipo = 'CONSULTA' then
										htp.p('<td><select id="destaque-tipo-'||ws_counter||'" data-default="'||ws_efeitob.tipo_destaque||'" onchange="call(''edit_blink'',''prm_key='||ws_efeitob.cd_destaque||'&prm_valor=''+document.getElementById(''destaque-tipo-'||ws_counter||''').value+''&prm_alter=TIPO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });">');
											if ws_efeitob.tipo_destaque = 'total' then
												htp.p('<option value="total" selected>'||fun.lang('Total')||'</option>');
											else
												htp.p('<option value="total">'||fun.lang('Total')||'</option>');
											end if;
											if ws_efeitob.tipo_destaque = 'normal' then
												htp.p('<option value="normal" selected>'||fun.lang('C&eacute;lula')||'</option>');
											else
												htp.p('<option value="normal">'||fun.lang('C&eacute;lula')||'</option>');
											end if;
											if ws_efeitob.tipo_destaque = 'linha' then
												htp.p('<option value="linha" selected>'||fun.lang('Linha')||'</option>');
											else
												htp.p('<option value="linha">'||fun.lang('Linha')||'</option>');
											end if;
											if ws_efeitob.tipo_destaque = 'celula barra' then
												htp.p('<option value="celula barra" selected>'||fun.lang('C&eacute;lula Barra')||'</option>');
											else
												htp.p('<option value="celula barra">'||fun.lang('C&eacute;lula Barra')||'</option>');
											end if;
											if ws_efeitob.tipo_destaque = 'total barra' then
												htp.p('<option value="total barra" selected>'||fun.lang('Total Barra')||'</option>');
											else
												htp.p('<option value="total barra">'||fun.lang('Total Barra')||'</option>');
											end if;

										htp.p('</select></td>');
									elsif ws_tipo = 'BROWSER' then
											htp.p('<td><select id="destaque-tipo-'||ws_counter||'" data-default="'||ws_efeitob.tipo_destaque||'" onchange="call(''edit_blink'',''prm_key='||ws_efeitob.cd_destaque||'&prm_valor=''+document.getElementById(''destaque-tipo-'||ws_counter||''').value+''&prm_alter=TIPO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });">');
												if ws_efeitob.tipo_destaque = 'estrela' then
													htp.p('<option value="estrela" selected>'||fun.lang('Estrela')||'</option>');
												else
													htp.p('<option value="estrela">'||fun.lang('Estrela')||'</option>');
												end if;
												if ws_efeitob.tipo_destaque = 'linha' then
													htp.p('<option value="linha" selected>'||fun.lang('Linha')||'</option>');
												else
													htp.p('<option value="linha">'||fun.lang('Linha')||'</option>');
												end if;
												if ws_efeitob.tipo_destaque = 'normal' then
													htp.p('<option value="normal" selected>'||fun.lang('C&eacute;lula')||'</option>');
												else
													htp.p('<option value="normal">'||fun.lang('C&eacute;lula')||'</option>');
												end if;

											htp.p('</select></td>');
										
									else
										htp.p('<input type="hidden" title="'||ws_efeitob.tipo_destaque||'" value="'||ws_efeitob.tipo_destaque||'" class="readonly" readonly />');
									/*else
										htp.p('<td><select id="destaque-tipo-'||ws_counter||'" data-default="'||ws_efeitob.tipo_destaque||'" onchange="call(''edit_blink'',''prm_key='||ws_efeitob.cd_destaque||'&prm_valor=''+document.getElementById(''destaque-tipo-'||ws_counter||''').value+''&prm_alter=TIPO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });">');
											if ws_efeitob.tipo_destaque = 'estrela' then
												htp.p('<option value="estrela" selected>'||fun.lang('Estrela')||'</option>');
											else
												htp.p('<option value="estrela">'||fun.lang('Estrela')||'</option>');
											end if;
											if ws_efeitob.tipo_destaque = 'linha' then
												htp.p('<option value="linha" selected>'||fun.lang('Linha')||'</option>');
											else
												htp.p('<option value="linha">'||fun.lang('Linha')||'</option>');
											end if;
										htp.p('</select></td>');*/
									end if;

									htp.p('<td>');
										htp.p('<input style="width: 90px !important; min-width: 90px;" onchange="this.nextElementSibling.value = this.value; call(''edit_blink'',''prm_key='||ws_efeitob.cd_destaque||'&prm_valor=''+document.getElementById(''destaque-icorfundo-'||ws_counter||''').value+''&prm_alter=CORFUNDO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });" data-obj="'||prm_objeto||'" data-counter="'||ws_counter||'" data-tipo="CORFUNDO" title="cor de fundo" type="text" id="destaque-icorfundo-'||ws_counter||'" placeholder="'||fun.lang('fundo')||'" value="'||ws_efeitob.cor_fundo||'" data-default="'||ws_efeitob.cor_fundo||'">');
										htp.p('<input type="color" onchange="this.previousElementSibling.value = this.value; call(''edit_blink'',''prm_key='||ws_efeitob.cd_destaque||'&prm_valor=''+document.getElementById(''destaque-icorfundo-'||ws_counter||''').value+''&prm_alter=CORFUNDO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });"  value="'||ws_efeitob.cor_fundo||'" />');
									htp.p('</td>');
									
									if ws_tipo not in ('BARRAS', 'LINHAS', 'PIZZA', 'COLUNAS') then
										htp.p('<td>');
											htp.p('<input style="width: 90px !important; min-width: 90px;" onchange="this.nextElementSibling.value = this.value; call(''edit_blink'',''prm_key='||ws_efeitob.cd_destaque||'&prm_valor=''+document.getElementById(''destaque-icorfonte-'||ws_counter||''').value+''&prm_alter=CORFONTE'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });" data-obj="'||prm_objeto||'" data-counter="'||ws_counter||'" data-tipo="CORFONTE" title="cor da fonte"  type="text" id="destaque-icorfonte-'||ws_counter||'" placeholder="'||fun.lang('fonte')||'" value="'||ws_efeitob.cor_fonte||'" data-default="'||ws_efeitob.cor_fonte||'">');
											htp.p('<input type="color" onchange="this.previousElementSibling.value = this.value; call(''edit_blink'',''prm_key='||ws_efeitob.cd_destaque||'&prm_valor=''+document.getElementById(''destaque-icorfonte-'||ws_counter||''').value+''&prm_alter=CORFONTE'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });" value="'||ws_efeitob.cor_fonte||'" />');
										htp.p('</td>');
									else
										htp.p('<input type="hidden" id="destaque-icorfonte-'||ws_counter||'" value="'||ws_efeitob.cor_fonte||'" data-default="'||ws_efeitob.cor_fonte||'">');
									end if;
									

									htp.p('<td><input id="destaque-prioridade-'||ws_counter||'" type="number" value="'||nvl(ws_efeitob.prioridade, 0)||'" data-default="'||nvl(ws_efeitob.prioridade, 0)||'" onchange="if(this.value.length > 0){ if(this.value != this.getAttribute(''data-default'')){ call(''edit_blink'',''prm_key='||ws_efeitob.cd_destaque||'&prm_valor=''+document.getElementById(''destaque-prioridade-'||ws_counter||''').value+''&prm_alter=PRIORIDADE'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } }); }}" onblur="if(this.value.length > 0){ if(this.value != this.getAttribute(''data-default'')){ call(''edit_blink'',''prm_key='||ws_efeitob.cd_destaque||'&prm_valor=''+document.getElementById(''destaque-prioridade-'||ws_counter||''').value+''&prm_alter=PRIORIDADE'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } }); }}"/></td>');
									
									--htp.p('<td>');  -- Alteração pausada para priorizar outras 
									--	htp.p('<a class="duplicate_icon" data-req="dupdestaque" data-par="prm_cd_destaque" data-valor="'||ws_efeitob.cd_destaque||'" data-decode="1" data-objeto="'||prm_objeto||'" data-pkg="fcl" title="'||fun.lang('Duplicar destaque')||'">'||fun.ret_svg('duplicate_icon')||'</a>');					
									--htp.p('</td>');

									htp.p('<td>');
										fcl.button_lixo('delete_blink','prm_key', ws_efeitob.cd_destaque, 1);
									htp.p('</td>');
									htp.p('<td><input style="display: none;" type="text" id="destaque-objeto-'||ws_counter||'" data-default="'||prm_objeto||'" value="'||prm_objeto||'" /></td>');
								htp.p('<tr>');

							else

								htp.p('<tr>');

									htp.p('<td class="readonly"><input readonly type="text" id="destaque-usuario-'||ws_counter||'" data-default="'||ws_efeitob.cd_usuario||'" value="'||ws_efeitob.cd_usuario||'" /></td>');

									htp.p('<td class="readonly"><input readonly id="destaque-coluna-'||ws_counter||'" data-default="'||ws_efeitob.cd_coluna||'" type="text" readonly value="'||ws_efeitob.cd_coluna||'"/></td>');

									htp.p('<td class="readonly">');
										htp.p('<input readonly type="text" value="'||ws_efeitob.condicao||'" />');
									htp.p('</td>');

									htp.p('<td class="readonly">');
										htp.p('<input readonly type="text" value="'||ws_efeitob.conteudo||'" />');
									htp.p('</td>');

									htp.p('<td class="readonly">');
										htp.p('<input readonly type="text" value="'||ws_efeitob.tipo_destaque||'">');
									htp.p('</td>');

									htp.p('<td class="readonly">');
										htp.p('<input readonly style="width: 90px !important; min-width: 90px;" value="'||ws_efeitob.cor_fundo||'" />');
										htp.p('<input type="color" disabled readonly value="'||ws_efeitob.cor_fundo||'" />');
									htp.p('</td>');
									htp.p('<td class="readonly">');
										htp.p('<input readonly style="width: 90px !important; min-width: 90px;" value="'||ws_efeitob.cor_fonte||'" />');
										htp.p('<input type="color" disabled readonly value="'||ws_efeitob.cor_fonte||'" />');
									htp.p('</td>');

									htp.p('<td class="readonly"><input readonly value="'||nvl(ws_efeitob.prioridade, 0)||'" /></td>');

									htp.p('<td></td>');
									htp.p('<td></td>');
								htp.p('<tr>');

							end if;
						ws_counter := ws_counter+1;
					end loop;
				close crs_efeitosb;

			htp.p('</tbody>');
		htp.p('</table>');
	htp.p('</div>');

exception 
	when ws_nouser then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p('!alert Erro ao carregar!'||sqlerrm);
end blink;

procedure blink_coluna as

	ws_usuario  varchar2(80);
	ws_noaccess exception;

begin

	ws_usuario := gbl.getUsuario;

	if ws_usuario = 'NOUSER' then
		raise ws_noaccess;
	end if;

	htp.p('<div class="searchbar">');
		htp.p('<a class="script" onclick="var valor = document.getElementById(''destaque-usuario-search'').title; ajax(''list'', ''list_mblink'', ''prm_objeto=&prm_usuario=''+valor+''&prm_order=1&prm_dir='', true, ''content''); document.getElementById(''prm_usuario'').title = valor; document.getElementById(''prm_usuario'').children[0].innerHTML = (valor==''DWU''?''TODOS'':valor);"></a>');
		fcl.fakeoption('destaque-usuario-search', fun.lang('Busca por usu&aacute;rios'), '', 'lista-usuario-grupo', 'N', 'N', prm_min => 1);
	htp.p('</div>');

	htp.p('<div style="margin-top: 10px;">');
		htp.p('<table class="linha">');
			htp.p('<thead>');
				htp.p('<tr>');
					htp.p('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''list_mblink'', ''prm_objeto=&prm_usuario=''+document.getElementById(''destaque-usuario-search'').title+''&prm_order=1&prm_dir=''+dir, false, ''content'');">'||fun.lang('USU&Aacute;RIO')||'</a></th>');
					htp.p('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''list_mblink'', ''prm_objeto=&prm_usuario=''+document.getElementById(''destaque-usuario-search'').title+''&prm_order=2&prm_dir=''+dir, false, ''content'');">'||fun.lang('CONSULTA')||'</a></th>');
					htp.p('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''list_mblink'', ''prm_objeto=&prm_usuario=''+document.getElementById(''destaque-usuario-search'').title+''&prm_order=3&prm_dir=''+dir, false, ''content'');">'||fun.lang('COLUNA')||'</a></th>');
					htp.p('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''list_mblink'', ''prm_objeto=&prm_usuario=''+document.getElementById(''destaque-usuario-search'').title+''&prm_order=4&prm_dir=''+dir, false, ''content'');">'||fun.lang('CONDI&Ccedil;&Atilde;O')||'</a></th>');
					htp.p('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''list_mblink'', ''prm_objeto=&prm_usuario=''+document.getElementById(''destaque-usuario-search'').title+''&prm_order=5&prm_dir=''+dir, false, ''content'');">'||fun.lang('VALOR')||'</a></th>');
					htp.p('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''list_mblink'', ''prm_objeto=&prm_usuario=''+document.getElementById(''destaque-usuario-search'').title+''&prm_order=6&prm_dir=''+dir, false, ''content'');">'||fun.lang('TIPO')||'</a></th>');
					htp.p('<th>'||fun.lang('COR FUNDO')||'</th>');
					htp.p('<th>'||fun.lang('COR FONTE')||'</th>');
					htp.p('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''list_mblink'', ''prm_objeto=&prm_usuario=''+document.getElementById(''destaque-usuario-search'').title+''&prm_order=7&prm_dir=''+dir, false, ''content'');">'||fun.lang('PRIORIDADE')||'</a></th>');
					htp.p('<th></th>');
				htp.p('<tr>');
			htp.p('</thead>');
			htp.p('<tbody id="ajax" data-dir="1"></tbody>');
		htp.p('</table>');
	htp.p('</div>');

exception 
	when ws_noaccess then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end blink_coluna;

procedure edit_blink ( prm_key      number   default null,
					prm_valor    varchar2 default null,
					prm_alter    varchar2 default null ) as

	ws_desc_evento varchar2(100);
	ws_objeto	   varchar2(100);
	ws_counter 	   number;

	ws_forbidden exception;

	begin
	/*fcl.refresh_Session;*/

		begin
			if prm_alter = 'USUARIO' then
				update destaque
				set cd_usuario = prm_valor
				where cd_destaque = prm_key;
				htp.p(fun.lang('Alterado com sucesso')||'!');
			elsif prm_alter = 'COLUNA' then
				update destaque
				set cd_coluna = prm_valor
				where cd_destaque = prm_key;
				htp.p(fun.lang('Alterado com sucesso')||'!');
			elsif prm_alter = 'CONDICAO' then
				update destaque
				set condicao = prm_valor
				where cd_destaque = prm_key;
				htp.p(fun.lang('Alterado com sucesso')||'!');
			elsif prm_alter = 'CONTEUDO' then
				update destaque
				set conteudo = prm_valor
				where cd_destaque = prm_key;
				htp.p(fun.lang('Alterado com sucesso')||'!');
			elsif prm_alter = 'TIPO' then
				update destaque
				set tipo_destaque = prm_valor
				where cd_destaque = prm_key;
				htp.p(fun.lang('Alterado com sucesso')||'!');
			elsif prm_alter = 'CORFUNDO' then
				update destaque
				set cor_fundo = prm_valor
				where cd_destaque = prm_key;
				htp.p(fun.lang('Alterado com sucesso')||'!');
			elsif prm_alter = 'CORFONTE' then
				update destaque
				set cor_fonte = prm_valor
				where cd_destaque = prm_key;
				htp.p(fun.lang('Alterado com sucesso')||'!');
			elsif prm_alter = 'PRIORIDADE' then
				update destaque
				set prioridade = prm_valor
				where cd_destaque = prm_key;
				htp.p(fun.lang('Alterado com sucesso')||'!');
			elsif prm_alter = 'DELETE' then
				delete from destaque
				where cd_destaque = prm_key;
				htp.p(fun.lang('Destaque excluido com sucesso')||'!');
			else
				htp.p('msg');
			end if;

			select decode(prm_alter, 'USUARIO', 'USUARIO', 'COLUNA', 'COLUNA', 'CONDICAO', 'CONDICAO', 'TIPO', 'TIPO', 'CORFUNDO', 'COR DO FUNDO', 'CORFONTE', 'COR DA FONTE', 'PRIORIDADE', 'PRIORIDADE', 'DELETE', 'EXCLUIDO', prm_alter) into ws_desc_evento from dual;
			
			select cd_objeto into ws_objeto from destaque where cd_destaque = prm_key;
			insert into bi_log_sistema (dt_log, ds_log, nm_usuario, nm_procedure) values (sysdate, 'Destaque #'||ws_desc_evento||' do Objeto #'||ws_objeto||' foi alterada com sucesso para: '||prm_valor||'.', gbl.getUsuario, 'EVENTO');
			commit;

		exception when others then
			htp.p('FAIL '||sqlerrm);
		end;
exception
	when ws_forbidden then
		htp.p(fun.lang('Usu&aacute;rio sem permiss&atilde;o')||'!');
	when others then
		htp.p(sqlerrm);

end edit_blink;

procedure delete_blink( prm_key number default null ) as

	ws_count      number;
	ws_objeto     varchar2(40);
	ws_coluna     varchar2(80);
	ws_conteudo   varchar2(200);
	ws_nome       varchar2(100);
	ws_usuario    varchar(80);

	ws_nouser     exception;
	ws_fail       exception;

	begin
	/*fcl.refresh_Session;*/
	
	ws_usuario := gbl.getusuario;

	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if;

	select cd_objeto, cd_coluna, conteudo into ws_objeto, ws_coluna, ws_conteudo from destaque where cd_destaque = prm_key;
	select nm_objeto into ws_nome from objetos where cd_objeto = ws_objeto;

	delete destaque
	where cd_destaque = prm_key;
	
	ws_count := SQL%ROWCOUNT;
	
	if ws_count <> 0 then
		commit;

		insert into bi_log_sistema values (sysdate, 'Usuario Excluiu o destaque #'||prm_key||' do objeto '||upper(ws_nome)||'('||ws_objeto||') com a coluna '||ws_coluna||' com o valor '||upper(ws_conteudo)||'', ws_usuario, 'EVENTO');
		commit;
	else
		raise ws_fail;
	end if;
	
exception 
	when ws_fail then
		htp.p('FAIL');
	when others  then
		htp.p('FAIL');

end delete_blink;


procedure list_blink ( l_pa varchar2 default null ) as

cursor crs_microcolunas is

	select cd_micro_visao, cd_coluna, nm_rotulo, '#000000' as color
	from micro_coluna
	where cd_coluna not in (
		SELECT COLUMN_VALUE FROM TABLE(fun.vpipe((select cs_coluna||'|'||cs_agrupador from ponto_avaliacao where cd_ponto = l_pa)))
	) and cd_micro_visao = (select cd_micro_visao from ponto_avaliacao where cd_ponto = l_pa and rownum = 1)

	union all

	select cd_micro_visao, cd_coluna, nm_rotulo, '#CC0000' as color
	from micro_coluna
	where cd_coluna in (
		SELECT COLUMN_VALUE FROM TABLE(fun.vpipe((select cs_coluna||'|'||cs_agrupador from ponto_avaliacao where cd_ponto = l_pa)))
	) and cd_micro_visao = (select cd_micro_visao from ponto_avaliacao where cd_ponto = l_pa and rownum = 1)
	order by nm_rotulo asc;

	ws_micro crs_microcolunas%rowtype;

	begin
	/*fcl.refresh_Session;*/
	htp.formSelectOpen( cname=>'i_lista', cattributes => ' id="i_lista" ');
		open crs_microcolunas;
			loop
				fetch crs_microcolunas into ws_micro;
				exit when crs_microcolunas%notfound;
					htp.p('<option style="color: '||ws_micro.color||'" value="'||ws_micro.cd_coluna||'">['||ws_micro.cd_coluna||'] '||ws_micro.nm_rotulo||'</option>');
			end loop;
		close crs_microcolunas;
	htp.formSelectClose;

end list_blink;


procedure list_mblink ( prm_objeto  varchar2 default null,
						prm_usuario varchar2 default 'N/A',
						prm_order   varchar2 default '1',
						prm_dir     varchar2 default '1' ) as

	cursor crs_colunas is
	select cd_usuario, decode(cd_usuario,'DWU','TODOS',cd_usuario) nm_usuario, cd_objeto, cd_coluna, condicao, conteudo, cor_fundo, cor_fonte, tipo_destaque, prioridade, cd_destaque
	from destaque where cd_objeto = trim(nvl(prm_objeto, cd_objeto)) and (cd_usuario = prm_usuario or cd_usuario in (select cd_usuario from gusers_itens where cd_group = prm_usuario) or prm_usuario = 'TODOS')
	order by
		case when prm_dir = '1' then decode(prm_order, '1', cd_usuario, '2', cd_objeto, '3', cd_coluna, '4', condicao, '5', conteudo, '6', tipo_destaque, '7', prioridade, cd_usuario) end asc,
		case when prm_dir = '2' then decode(prm_order, '1', cd_usuario, '2', cd_objeto, '3', cd_coluna, '4', condicao, '5', conteudo, '6', tipo_destaque, '7', prioridade, cd_usuario) end desc;

	ws_coluna crs_colunas%rowtype;

	ws_visao    varchar2(80) := '';
	ws_ligacao  varchar2(200);
	ws_counter  number;
	ws_dir		number:=1;
	

	begin
	/*fcl.refresh_Session;*/

	ws_counter := 0;

	if length(prm_objeto) <> 0 then
		select cd_micro_visao into ws_visao from ponto_avaliacao where cd_ponto = trim(prm_objeto);
	end if;

	htp.p('<div class="searchbar">');
			htp.p('<a class="script" onclick="var valor = document.getElementById(''destaque-usuario-search'').title; ajax(''list'', ''list_mblink'', ''prm_objeto=&prm_usuario=''+valor+''&prm_order=1&prm_dir='', true, ''content''); document.getElementById(''prm_usuario'').title = valor; document.getElementById(''prm_usuario'').children[0].innerHTML = (valor==''DWU''?''TODOS'':valor);"></a>');
			fcl.fakeoption('destaque-usuario-search', nvl(prm_usuario, 'Lista de usu&aacute;rios'), prm_usuario, 'lista-usuario-grupo', 'N', 'N', prm_desc => replace(prm_usuario,'DWU','TODOS') );
		htp.p('</div>');
	
	--if nvl(prm_usuario, 'N/A') = 'N/A' then

		/*fcl.refresh_Session;*/
		htp.p('<div style="margin-top: 10px;">');
			htp.p('<table class="linha">');
				htp.p('<thead>');
					htp.p('<tr>');
						htp.p('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''list_mblink'', ''prm_objeto=&prm_usuario=''+document.getElementById(''destaque-usuario-search'').title+''&prm_order=1&prm_dir=''+dir, false, ''content'');">'||fun.lang('USU&Aacute;RIO')||'</a></th>');
						htp.p('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''list_mblink'', ''prm_objeto=&prm_usuario=''+document.getElementById(''destaque-usuario-search'').title+''&prm_order=2&prm_dir=''+dir, false, ''content'');">'||fun.lang('CONSULTA')||'</a></th>');
						htp.p('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''list_mblink'', ''prm_objeto=&prm_usuario=''+document.getElementById(''destaque-usuario-search'').title+''&prm_order=3&prm_dir=''+dir, false, ''content'');">'||fun.lang('COLUNA')||'</a></th>');
						htp.p('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''list_mblink'', ''prm_objeto=&prm_usuario=''+document.getElementById(''destaque-usuario-search'').title+''&prm_order=4&prm_dir=''+dir, false, ''content'');">'||fun.lang('CONDI&Ccedil;&Atilde;O')||'</a></th>');
						htp.p('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''list_mblink'', ''prm_objeto=&prm_usuario=''+document.getElementById(''destaque-usuario-search'').title+''&prm_order=5&prm_dir=''+dir, false, ''content'');">'||fun.lang('VALOR')||'</a></th>');
						htp.p('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''list_mblink'', ''prm_objeto=&prm_usuario=''+document.getElementById(''destaque-usuario-search'').title+''&prm_order=6&prm_dir=''+dir, false, ''content'');">'||fun.lang('TIPO')||'</a></th>');
						htp.p('<th>'||fun.lang('COR FUNDO')||'</th>');
						htp.p('<th>'||fun.lang('COR FONTE')||'</th>');
						htp.p('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''list_mblink'', ''prm_objeto=&prm_usuario=''+document.getElementById(''destaque-usuario-search'').title+''&prm_order=7&prm_dir=''+dir, false, ''content'');">'||fun.lang('PRIORIDADE')||'</a></th>');
						htp.p('<th></th>');
					htp.p('<tr>');
				htp.p('</thead>');

				
			if to_number(prm_dir) = 1 then 
				ws_dir := 2; 
			end if;

				htp.p('<tbody id="ajax" data-dir="'||ws_dir||'">');
				

	--end if;
	

	open crs_colunas;
		loop
			fetch crs_colunas into ws_coluna;
			exit when crs_colunas%notfound;
			
			ws_counter := ws_counter+1;
			
			htp.p('<tr>');
			
				begin
					select cd_micro_visao into ws_visao from ponto_avaliacao where cd_ponto = trim(ws_coluna.cd_objeto);
					htp.p('<td style="display: none;"><input type="hidden" id="destaque-visao-'||ws_counter||'" title="'||ws_visao||'" value="'||ws_visao||'" /></td>');
				exception when others then
					htp.p('<td style="display: none;"><input type="hidden" id="destaque-visao-'||ws_counter||'" title="" value="" /></td>');
				end;
			
				htp.p('<td>'||trim(ws_coluna.nm_usuario)||'</td>');
				htp.p('<td>'||trim(ws_coluna.cd_objeto)||'</td>');
				
			
				htp.p('<td>');
					htp.p('<a class="script" onclick="call(''edit_blink'',''prm_key='||ws_coluna.cd_destaque||'&prm_valor=''+document.getElementById(''destaque-coluna-'||ws_counter||''').title+''&prm_alter=COLUNA'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
					fcl.fakeoption('destaque-coluna-'||ws_counter, '', ws_coluna.cd_coluna, 'lista-colunas', 'N', 'N', 'destaque-visao-'||ws_counter, '');
				htp.p('</td>');
			
			
				/*htp.p('<td><select id="destaque-condicao-'||ws_counter||'" data-default="'||ws_coluna.condicao||'" onchange="destaque('''||ws_counter||''', ''CONDICAO'', this.id);">');
					fcl.condicoes('selected', ws_coluna.condicao);
				htp.p('</select>');
				htp.p('</td>');*/
				
				
				htp.p('<td>');
					htp.p('<a class="script" onclick="call(''edit_blink'',''prm_key='||ws_coluna.cd_destaque||'&prm_valor=''+document.getElementById(''destaque-condicao-'||ws_counter||''').title+''&prm_alter=CONDICAO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
					fcl.fakeoption('destaque-condicao-'||ws_counter||'', '', ws_coluna.condicao, 'lista-condicoes', 'N', 'N', '', '', '', fun.dcondicao(ws_coluna.condicao));
				htp.p('</td>');


				
				htp.p('<td>');
					htp.p('<a class="script" onclick="call(''edit_blink'',''prm_key='||ws_coluna.cd_destaque||'&prm_valor=''+document.getElementById(''destaque-conteudo-'||ws_counter||''').title+''&prm_alter=CONTEUDO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
					
					begin
								
						select cd_ligacao into ws_ligacao from micro_coluna where cd_coluna = ws_coluna.cd_coluna and cd_micro_visao = ws_visao;
						
						if ws_ligacao <> 'SEM' then
							fcl.fakeoption('destaque-conteudo-'||ws_counter, fun.lang('Lista de valores'), ws_coluna.conteudo, 'lista-valores', 'S', 'N', 'destaque-visao-'||ws_counter, '', 'destaque-coluna-'||ws_counter, fun.cdesc(ws_coluna.conteudo, ws_ligacao));
						else
							fcl.fakeoption('destaque-conteudo-'||ws_counter, fun.lang('Lista de valores'), ws_coluna.conteudo, 'lista-valores', 'S', 'N', 'destaque-visao-'||ws_counter, '', 'destaque-coluna-'||ws_counter);
						end if;
					
					exception when others then
						
						fcl.fakeoption('destaque-conteudo-'||ws_counter, fun.lang('Lista de valores'), ws_coluna.conteudo, 'lista-valores', 'S', 'N', 'destaque-visao-'||ws_counter, '', 'destaque-coluna-'||ws_counter);
					
					end;
					
				htp.p('</td>');
				
				/*htp.p('<td><input type="text" id="destaque-conteudo-'||ws_counter||'" data-default="'||ws_coluna.conteudo||'" value="'||ws_coluna.conteudo||'" onblur="if(this.value.length > 0){ if(this.value != this.getAttribute(''data-default'')){ destaque('''||ws_counter||''', ''CONTEUDO'', this.id); }}"/></td>');*/
				
				
				
				htp.p('<td><select id="destaque-tipo-'||ws_counter||'" data-default="'||ws_coluna.tipo_destaque||'" onchange="call(''edit_blink'',''prm_key='||ws_coluna.cd_destaque||'&prm_valor=''+document.getElementById(''destaque-tipo-'||ws_counter||''').value+''&prm_alter=TIPO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });">');
					if ws_coluna.tipo_destaque = 'total' then
						htp.p('<option value="total" selected>'||fun.lang('Total')||'</option>');
					else
						htp.p('<option value="total">'||fun.lang('Total')||'</option>');
					end if;
					if ws_coluna.tipo_destaque = 'normal' then
						htp.p('<option value="normal" selected>'||fun.lang('C&eacute;lula')||'</option>');
					else
						htp.p('<option value="normal">'||fun.lang('C&eacute;lula')||'</option>');
					end if;
					if ws_coluna.tipo_destaque = 'linha' then
						htp.p('<option value="linha" selected>'||fun.lang('Linha')||'</option>');
					else
						htp.p('<option value="linha">'||fun.lang('Linha')||'</option>');
					end if;
					if ws_coluna.tipo_destaque = 'celula barra' then
						htp.p('<option value="celula barra" selected>'||fun.lang('C&eacute;lula Barra')||'</option>');
					else
						htp.p('<option value="celula barra">'||fun.lang('C&eacute;lula Barra')||'</option>');
					end if;
					if ws_coluna.tipo_destaque = 'total barra' then
						htp.p('<option value="total barra" selected>'||fun.lang('Total Barra')||'</option>');
					else
						htp.p('<option value="total barra">'||fun.lang('Total Barra')||'</option>');
					end if;

				htp.p('</select></td>');

				/*htp.p('<td style="width: 20%; color: '||ws_coluna.cor_fonte||'; background-color: '||ws_coluna.cor_fundo||';">cor da fonte</td>');*/

				htp.p('<td>');
					htp.p('<input style="width: 90px !important; min-width: 90px;" onchange="call(''edit_blink'',''prm_key='||ws_coluna.cd_destaque||'&prm_valor=''+document.getElementById(''destaque-icorfundo-'||ws_counter||''').value+''&prm_alter=CORFUNDO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });" title="cor de fundo" type="text" id="destaque-icorfundo-'||ws_counter||'" placeholder="'||fun.lang('fundo')||'" value="'||ws_coluna.cor_fundo||'" data-default="'||ws_coluna.cor_fundo||'">');
					htp.p('<input type="color" id="destaque-ccorfundo-'||ws_counter||'" onchange="call(''edit_blink'',''prm_key='||ws_coluna.cd_destaque||'&prm_valor=''+document.getElementById(''destaque-ccorfundo-'||ws_counter||''').value+''&prm_alter=CORFUNDO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });" value="'||ws_coluna.cor_fundo||'"/>');
				htp.p('</td>');
				htp.p('<td>');
					htp.p('<input style="width: 90px !important; min-width: 90px;" onchange="call(''edit_blink'',''prm_key='||ws_coluna.cd_destaque||'&prm_valor=''+document.getElementById(''destaque-icorfonte-'||ws_counter||''').value+''&prm_alter=CORFONTE'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });" data-tipo="CORFONTE" title="cor da fonte" type="text" id="destaque-icorfonte-'||ws_counter||'" placeholder="'||fun.lang('fonte')||'" value="'||ws_coluna.cor_fonte||'" data-default="'||ws_coluna.cor_fonte||'">');
					htp.p('<input type="color" onchange="call(''edit_blink'',''prm_key='||ws_coluna.cd_destaque||'&prm_valor=''+document.getElementById(''destaque-ccorfonte-'||ws_counter||''').value+''&prm_alter=CORFONTE'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });" id="destaque-ccorfonte-'||ws_counter||'" value="'||ws_coluna.cor_fonte||'"/>');
				htp.p('</td>');
				
				htp.p('<td>');
					htp.p('<input type="number" style="width: 44px !important;" title="prioridade" type="text" id="destaque-prioridade-'||ws_counter||'" onchange="call(''edit_blink'',''prm_key='||ws_coluna.cd_destaque||'&prm_valor=''+document.getElementById(''destaque-prioridade-'||ws_counter||''').value+''&prm_alter=PRIORIDADE'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });" value="'||ws_coluna.prioridade||'"/>');
				htp.p('</td>');

				--htp.p('<td>');  -- Alteração pausada para priorizar outras 
				--	htp.p('<a class="duplicate_icon" data-require="dupdestaque" data-param="prm_cd_destaque" data-valor="'||ws_coluna.cd_destaque||'" data-decode="1" data-objeto="'||prm_objeto||'" data-pkg="fcl" title="'||fun.lang('Duplicar destaque')||'">'||fun.ret_svg('duplicate_icon')||'</a>');					
				--htp.p('</td>');

				htp.p('<td>');
					fcl.button_lixo('delete_blink','prm_key', ws_coluna.cd_destaque, 1);
				htp.p('</td>');
			htp.p('<tr>');


		end loop;
	close crs_colunas;

	--if nvl(prm_usuario, 'N/A') = 'N/A' then
				htp.p('</tbody>');
			htp.p('</table>');
		htp.p('</div>');
	--end if;
	
exception 
	when others then
		htp.p(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
end list_mblink;

procedure load_dado ( prm_nome varchar2 default null,
					prm_tipo varchar2 default null,
					prm_time number ) as

ws_conteudo long;

begin
	/*fcl.refresh_Session;*/
	select text into ws_conteudo from dba_views where owner = nvl(fun.ret_var('OWNER_TABLE_DATA'),'DWU') and view_name = upper(prm_nome) and rownum = 1;

	ws_conteudo := substr(ws_conteudo, (prm_time*30000), 30000);
	htp.p(ws_conteudo);

end load_dado;

procedure edit_view as

begin
	/*fcl.refresh_Session;*/
	htp.p('<html style="display: inline; float: left; font-family: arial; height: 415px; margin: 0; min-width: 720px;">');
		htp.p('<head>');
		htp.p('</head>');
		htp.p('<body style="display: inline; float: left; font-family: arial; height: 415px; margin: 0; min-width: 720px;">');
			htp.formSelectOpen( cname => '', cattributes => ' style="display: block; margin-right: 300px;" onchange=" valor = this.value; if(valor != ''''){ document.getElementById(''valor'').value = valor; classe = this.options[this.selectedIndex].getAttribute(''class''); document.getElementById(''valor'').setAttribute(''class'',classe); nome = this.options[this.selectedIndex].getAttribute(''name''); document.getElementById(''titulo'').value= nome; } else { document.getElementById(''valor'').value = ''''; document.getElementById(''titulo'').value = ''''; document.getElementById(''valor'').setAttribute(''class'',''''); document.getElementById(''titulo'').setAttribute(''class'','''');} " ' );
				htp.p('<option value="">'||fun.lang('Escolha uma op&ccedil;&atilde;o')||'</option>');
			htp.formSelectClose;
			htp.p('<input id="titulo" type="text" style="width: 700px; display: block; margin: 5px 0;" placeholder="'||fun.lang('T&iacute;tulo')||'" />');
			htp.p('<textarea id="valor" class="" style="min-width: 720px; min-height: 320px; display: block;" ></textarea>');
			htp.p('<input type="submit" onclick="" />');
		htp.p('</body>');
	htp.p('</head>');

end edit_view;

procedure new_query ( prm_obj varchar2 default null ) as

	ws_count   number;
	ws_sql     dbms_sql.varchar2a;
	ws_pointer pls_integer;
	ws_rows    pls_integer;
begin
	/*fcl.refresh_Session;*/
	select count(*) into ws_count from all_objects where object_name = upper(trim(prm_obj));
	if ws_count = 0 then
		htp.p('<option value="" id="'||upper(trim(prm_obj))||'" class="view">[view] '||upper(trim(prm_obj))||'</option>');
		ws_sql(1) := 'Create or replace view '||upper(trim(prm_obj))||' as select * from log_eventos';
		ws_pointer := dbms_sql.open_cursor;
		dbms_sql.parse( c => ws_pointer, statement => ws_sql, lb => 1, ub => 1, lfflg => false, language_flag => dbms_sql.native);
		ws_rows := dbms_sql.execute(ws_pointer);
		dbms_sql.close_cursor(ws_pointer);
	else
		htp.p('#alert '||fun.lang('Impossivel criar, valor j&aacute; existe')||'!');
	end if;
exception when others then
	htp.p(sqlerrm);
end new_query;

PROCEDURE REG_ONLINE ( prm_tipo     varchar2 default null,
						prm_evento   varchar2 default null,
						prm_status   varchar2 default null,
						prm_usuario  varchar2 default null,
						prm_qtde     varchar2 default null ) as

				cursor crs_pendings is
					select   DT_REGISTRO, COMMAND, ROWID ID_LINHA
					from     PENDING_REGS
					where    STATUS='P'
					order by dt_registro desc;

	ws_pendings        crs_pendings%rowtype;

	ws_count        number;
	ws_pending      number;
	ws_string       varchar2(4000);
	ws_command      varchar2(4000);
	ws_error_count  number := 0;
	ws_error        varchar2(200);
	ws_address      varchar2(200);
	ws_usuario      varchar2(80);

begin
	null; -- Excluir não é mais utilizado 
end REG_ONLINE;

procedure STATUS_PROCESS (  prm_cd_processo varchar2,
							prm_ds_processo varchar2,
						    prm_comando     varchar2) as

	ws_check_run      number := 0;
	ws_saida          varchar2(40);

begin
	null; -- Não é utilizada - Excluir 
end STATUS_PROCESS;

--!!
procedure mask ( prm_order varchar2 default '1',
				prm_dir   varchar2 default '1' ) as

	cursor crs_masks is
	select cd_mascara, ds_mascara from
	mascaras order by
		case when prm_dir = '1' then decode(prm_order, '1', cd_mascara, '2', ds_mascara, cd_mascara) end asc,
		case when prm_dir = '2' then decode(prm_order, '1', cd_mascara, '2', ds_mascara, cd_mascara) end desc;

	ws_mask crs_masks%rowtype;
	ws_dir     number := 1;
	ws_padrao  varchar2(80) := 'PORTUGUESE';
	ws_usuario varchar2(80);
	ws_admin   varchar2(20);

	ws_noaccess exception;

begin

	ws_admin   := gbl.getNivel;
	ws_usuario := gbl.getUsuario;

	if ws_usuario = 'NOUSER' or ws_admin <> 'A' then
		raise ws_noaccess;
	end if;

	begin
		select CONTEUDO into ws_padrao
		from   PARAMETRO_USUARIO
		where  cd_usuario = ws_usuario and
			cd_padrao='CD_LINGUAGEM';
	exception
		when others then
			ws_padrao := 'PORTUGUESE';
	end;

	/*fcl.refresh_Session;*/
	htp.p('<table class="linha">');
	
		htp.p('<thead>');

			htp.p('<tr>');

				htp.p('<th style="width: 20%">');
					htp.p('<a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''mask'', ''prm_order=1&prm_dir=''+dir, false, ''content'');">'||fun.lang('NOME')||'</a>');
				htp.p('</th>');

				htp.p('<th style="width: calc(80% - 22px);">');
					htp.p('<a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''mask'', ''prm_order=2&prm_dir=''+dir, false, ''content'');">'||fun.lang('VALOR')||'</a>');
				htp.p('</th>');

				htp.p('<th style="width: 22px;"></th>');

			htp.p('</tr>');

		htp.p('</thead>');

		if to_number(prm_dir) = 1 then
			ws_dir := 2;
		end if;

		htp.p('<tbody id="ajax" data-dir="'||ws_dir||'">');
			
			open crs_masks;
				loop
					fetch crs_masks into ws_mask;
					exit when crs_masks%notfound;
					htp.p('<tr id="'||ws_mask.cd_mascara||'-row">');

						htp.p('<td style="width: 20%">');
							htp.p('<span id="'||ws_mask.cd_mascara||'_id" title="'||fun.utranslate('CD_MASCARA', 'MASCARAS', ws_mask.cd_mascara, ws_padrao)||'">'||fun.utranslate('CD_MASCARA', 'MASCARAS', ws_mask.cd_mascara, ws_padrao)||'</span>');
							htp.p('<a class="fakelang" style="margin-left: 3px;" onclick="fakeLang('''||ws_mask.cd_mascara||'_id'', ''MASCARAS|CD_MASCARA|'||ws_mask.cd_mascara||''', ''cd'');">L</a>');
						htp.p('</td>');

						/*htp.p('<td><span title="'||ws_mask.cd_mascara||'" style="margin: 2px 0 -5px 0; background: url('||fun.ret_var('URL_GIFS')||'seta.png) no-repeat scroll 98% 6px #FFF;" class="fakeoption" id="fake_nome" onclick="fakeLang(this.id, ''MASCARAS|CD_MASCARA|'||ws_mask.cd_mascara||''', ''cd'');">'||fun.utranslate('CD_MASCARA', 'MASCARAS', ws_mask.cd_mascara)||'</span></td>');*/
						htp.p('<td style="width: calc(80% - 22px);">');
							htp.p('<input type="text" data-default="'||replace(ws_mask.ds_mascara,'"','&#34;')||'" value="'||replace(ws_mask.ds_mascara,'"','&#34;')||'" onblur="if(this.getAttribute(''data-default'') != this.value){ var celula = this;  call(''edit_mask'', ''prm_mask=''+encodeURIComponent('''||ws_mask.cd_mascara||''')+''&prm_valor=''+encodeURIComponent(celula.value)).then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ celula.setAttribute(''data-default'', celula.value); alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } }); }" />');
						htp.p('</td>');

						htp.p('<td>');
							fcl.button_lixo('dl_mask','prm_mask', ws_mask.cd_mascara);
						htp.p('</td>');

						--htp.p('<td style="width: 22px;"><a title="'||fun.lang('Excluir')||'" class="remove" onclick="if(confirm(TR_CE))var row = this.parentNode.parentNode; row.classList.add(''removing''); call(''dl_mask'', ''prm_mask=''+encodeURIComponent('''||ws_mask.cd_mascara||''')).then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ row.remove(); alerta(''feed-fixo'', TR_EX); } else { row.classList.remove(''removing''); alerta(''feed-fixo'', TR_ER); } });">X</a></td>');
					htp.p('</tr>');
				end loop;
			close crs_masks;

		htp.p('</tbody>');
	htp.p('</table>');
exception
	when ws_noaccess then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end mask;


procedure dl_mask ( prm_mask varchar2 default null ) as

	ws_count number;
	ws_fail  exception;  

begin
	/*fcl.refresh_Session;*/
	
	delete from mascaras where cd_mascara = trim(prm_mask);
	
	ws_count := SQL%ROWCOUNT;
	
	if ws_count <> 0 then
		commit;
		
		delete from traducao_colunas where cd_tabela = 'MASCARAS' and cd_coluna = 'CD_MASCARAS' and lang_default = prm_mask;
		delete from traducao_colunas where cd_tabela = 'MASCARAS' and lang_default = prm_mask;
		commit;
	else
		raise ws_fail;
	end if;
	
exception 
	when ws_fail then
		htp.p('FAIL');
	when others then	
		htp.p('FAIL');
end dl_mask;


procedure edit_mask ( prm_mask  varchar2 default null,
					prm_valor varchar2 default null ) as

	ws_count    number;
	ws_fail     exception;
	ws_converte varchar2(800);
begin

	/*fcl.refresh_Session;*/

	ws_converte := fun.converte(prm_valor);
	
	update mascaras
	set ds_mascara = trim(ws_converte)
	where cd_mascara = prm_mask;
	
	ws_count := SQL%ROWCOUNT;

	if ws_count <> 0 then
		commit;
	else
		raise ws_fail;
	end if;

exception
	when ws_fail then
		rollback;
		htp.p('FAIL');
	when others then
		htp.p('FAIL');
end edit_mask;

procedure load_mask ( prm_mask varchar2 default null,
					prm_desc varchar2 default null) as


	ws_count         number;
	ws_fail          exception;
	ws_double        exception;
	ws_converte      varchar2(800);
	ws_converte_desc varchar2(800);

begin

	/*fcl.refresh_Session;*/

	ws_converte      := fun.converte(prm_mask);
	ws_converte_desc := fun.converte(prm_desc);

	select count(*) into ws_count from mascaras where cd_mascara = upper(ws_converte);

	if ws_count = 0 then
		insert into mascaras values(upper(ws_converte), upper(ws_converte_desc));
		
		ws_count := SQL%ROWCOUNT;
		
		if ws_count <> 0 then
			commit;
			
			insert into traducao_colunas values('MASCARAS', 'CD_MASCARA', fun.ret_var('LANG_SYS'), upper(ws_converte), upper(ws_converte), 'T', 'N');
			commit;
		else
			raise ws_fail;
		end if;
		
	else
		raise ws_double;
	end if;
exception
	when ws_double then
		rollback;
		htp.p('FAIL DUPLICADO M&aacute;scara j&aacute; existe!');
	when ws_fail then
		htp.p('FAIL');
	when others then
		htp.p('FAIL');
end load_mask;


procedure load_goto ( prm_grafico varchar2 default null,
					prm_drill   varchar2 default null) as

	ws_count number;
	ws_desc  varchar2(400);
	ws_visao varchar2(400);
	ws_tipo  varchar2(400);
	ws_fail  exception;

begin
	/*fcl.refresh_Session;*/

	if fun.check_admin('DRILLS_ADD') then
		/*for i in(select column_value from table((fun.vpipe(prm_drill)))) loop
			insert into goto_objeto values('DWU', upper(prm_grafico), upper(i.column_value));
		end loop;*/

		insert into goto_objeto (cd_usuario, cd_objeto, cd_objeto_go)
		select 'DWU', upper(prm_grafico), upper(column_value) from table(fun.vpipe(prm_drill));	

		ws_count := SQL%ROWCOUNT;
		
		if ws_count <> 0 then
			commit;
		else
			raise ws_fail;
		end if;
			
	else
		htp.p('#alert Sem permiss&atilde;o!');
	end if;

exception 
	when ws_fail then
		htp.p('FAIL');
	when others then
		htp.p('FAIL');
end load_goto;

--!!
procedure load_drill ( prm_objeto     varchar2 default null,
					prm_parametros varchar2 default null,
					prm_track      varchar2 default null,
					prm_objeton    varchar2 default null ) as

	cursor crs_drills(prm_usuario varchar2) is
		select cd_objeto_go, (select tp_objeto from objetos where objetos.cd_objeto = goto_objeto.cd_objeto_go) as tipo, (select nm_objeto from objetos where goto_objeto.cd_objeto_go = objetos.cd_objeto) as nm_objeto
	 	  from GOTO_OBJETO
	     where cd_objeto = fun.get_cd_obj(prm_objeto) -- replace(prm_objeto, 'trl', '') 
	  	   and cd_objeto_go not in ( select cd_objeto from OBJECT_RESTRICTION where USUARIO = prm_usuario )
	order by tipo, nm_objeto;

	ws_drill crs_drills%rowtype;
	ws_tipo    varchar2(40) := 'N/A';
	ws_padrao  varchar2(80) := 'PORTUGUESE';
	ws_usuario varchar2(80);

	ws_nouser  exception;

begin
	
	ws_usuario := gbl.getUsuario;

	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if;

	begin
		select CONTEUDO into ws_padrao
		from   PARAMETRO_USUARIO
		where  cd_usuario = ws_usuario and
			cd_padrao='CD_LINGUAGEM';
	exception
		when others then
			ws_padrao := 'PORTUGUESE';
	end;

	htp.p('<ul><li>');
		htp.p('<select title="'||prm_parametros||'" onchange="callDrill(this, this.title);">');
			htp.p('<option value="" hidden disabled selected>'||fun.lang('ABRIR')||':</option>');

			begin
				open crs_drills(ws_usuario);
					loop
						fetch crs_drills into ws_drill;
						exit when crs_drills%notfound;
						
						if ws_drill.tipo <> ws_tipo then
							htp.p('<optgroup label="'||ws_drill.tipo||'">'||ws_drill.tipo||'</optgroup>');
							ws_tipo := ws_drill.tipo;
						end if;
						
						htp.p('<option value="'||ws_drill.cd_objeto_go||'">'||fun.utranslate('NM_OBJETO', ws_drill.cd_objeto_go, ws_drill.nm_objeto, ws_padrao)||'</option>');
					end loop;
				close crs_drills;
			exception when others then
				htp.p(sqlerrm);
			end;
		htp.p('</select>');
	htp.p('</li></ul>');
	htp.p('<a class="fechartab" style="text-align: center;" onclick="remover(''jumpdrill'');">'||fun.lang('FECHAR')||'</td>');
exception
	when ws_nouser then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end load_drill;


procedure ex_obj( prm_objeto varchar2 default null ) as

	ws_count number;
	ws_fail  exception;
	
begin

	/*fcl.refresh_Session;*/
	
	delete from objetos where cd_objeto = trim(prm_objeto);
	
	ws_count := SQL%ROWCOUNT;
		
	if ws_count <> 0 then
		
		commit;
		
		delete from object_attrib where cd_object = trim(prm_objeto);
		delete from ponto_avaliacao where cd_ponto = trim(prm_objeto);
		delete from filtros where cd_objeto = trim(prm_objeto) and tp_filtro = 'objeto';
		commit;
		
	else
		raise ws_fail;
	end if;
	
exception 
	when ws_fail then
		htp.p('FAIL');
	when others then
		htp.p('FAIL');	
end ex_obj;

--!!
procedure list_vconteudo ( prm_usuario varchar2 default null,
						prm_todo    varchar2 default 'S' ) as

	ws_usuario_filtro varchar2(80);	
	ws_usuario        varchar2(80);
	ws_admin          varchar2(80);
	ws_admin_up       varchar2(80);

	cursor crs_conteudo  is
		select variavel, conteudo, usuario, descricao, nome, permissao    
		from var_conteudo var 
		where var.usuario = ws_usuario_filtro
		order by ordem, variavel asc;

	/*****
	cursor crs_conteudo(prm_admin varchar2, prm_usu varchar2) is
	select variavel, conteudo, locked, usuario, descricao, nome   
	from var_conteudo 
	where ( (usuario = prm_usuario or ((prm_admin = 'A' and usuario = nvl(prm_usuario, 'DWU') or (prm_admin <> 'A' and usuario = prm_usu)) ) ) 
			or usuario in (select cd_usuario from gusers_itens where cd_group = prm_usuario and cd_usuario = prm_usuario)
		)	
		and nvl(var_conteudo.locked,'U') <> 'O'                                -- Ocutar 
		and ( ws_admin_up = 'A' or nvl(var_conteudo.locked,'.') <> 'V'  )   -- Mostrar somente para usuários UPquery
	order by ordem, variavel asc;
	ws_conteudo     crs_conteudo%rowtype;
	ws_usuario_nome varchar2(80);	
	********/ 

	ws_count        number := 0;
	ws_descricao    varchar2(4000); 
	ws_visualizacao varchar2(1); 
	ws_alteracao    varchar2(1); 
	ws_exclusao     varchar2(1); 
	ws_nouser       exception;
begin
	-- 
	-- Permissões de acesso a variável 
	--   = S - TTT 	  Visualizacao (TODOS)      Alteração (TODOS)      Exclusão (TODOS) 
	--   = N - TTN    Visualizacao (TODOS)      Alteração (TODOS)      Exclusão (NINGUEM) 
	--   = X - TNN    Visualizacao (TODOS)      Alteração (NINGUEM)    Exclusão (NINGUEM)  
	--   = O - NNN    Visualizacao (NINGUEM)    Alteração (NINGUEM)    Exclusão (NINGUEM)  
	--   = U - TUN    Visualizacao (TODOS)      Alteração (UPQUERY)    Exclusão (NINGUEM)  
	--   = V - UUN    Visualizacao (UPQUERY)    Alteração (UPQUERY)    Exclusão (NINGUEM)  

	-- locked/Removível 
	--   = S - Exclusão (TODOS), Visualizacao (TODOS),   Alteração (TODOS)  
	--   = N - Exclusão (NÃO),   Visualizacao (TODOS),   Alteração (TODOS)
	--   = X - Exclusão (NÃO),   Visualizacao (TODOS),   Alteração (NÃO) 
	--   = O - Exclusão (NÃO),   Visualizacao (NÃO),     Alteração (NÃO)  
	--   = U - Exclusão (NÃO),   Visualizacao (TODOS),   Alteração (UPQUERY) 
	--   = V - Exclusão (NÃO),   Visualizacao (UPQUERY), Alteração (UPQUERY) 

	ws_usuario  := gbl.getUsuario;
	ws_admin    := gbl.getNivel;
	ws_admin_up := gbl.getNivelUpquery(ws_usuario);

	-- Define o usuário dono das variáveis a serem listadas na tela 
	if ws_admin = 'A' then 
		if prm_usuario is null then 
			ws_usuario_filtro := 'DWU';
		else 	
			ws_usuario_filtro := prm_usuario;
		end if; 	
	else 
		ws_usuario_filtro := ws_usuario; 
	end if; 

	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if;
	

	-- Monta Cabeçalho da tela, se for ADM monta com possíbilidade de criar varáveis e consultar de outros usuários  
	if prm_todo = 'S' then
		htp.p('<div class="itens" data-save="false" style="width: 346px;">');
		htp.p('<h2 class="fixed">'||fun.lang('CONFIGURA&Ccedil;&Otilde;ES')||'</h2>');
		
		if ws_admin = 'A' then
			htp.p('<ul class="conf">');
				htp.p('<li>');
					htp.p('<a class="script" onclick="call(''list_vconteudo'', ''prm_usuario=''+this.nextElementSibling.title+''&prm_todo=N'').then(function(inside){ document.getElementById(''conf_ajax'').innerHTML = inside; });"></a>');
					fcl.fakeoption('filtro-usuario', fun.lang('Usu&aacute;rio'), '', 'lista-usuario-grupo', 'N', 'N');
				htp.p('</li>');
				htp.p('<li>');
					htp.p('<input id="valor" type="text" placeholder="'||fun.lang('Nome do valor')||'" value="" class="up" style="float: right;"/>');
				htp.p('</li>');
				
				htp.p('<li>');	
					htp.p('<select id="locked" style="float: right;">');
						htp.p('<option value="S" selected disabled>'||fun.lang('REMOV&Iacute;VEL')||'</option>');
						htp.p('<option value="N">'||fun.lang('N&Atilde;O')||'</option>');
						htp.p('<option value="X">'||fun.lang('N&Atilde;O e N&Atilde;O EDITAVEL')||'</option>');
						htp.p('<option value="S">'||fun.lang('SIM')||'</option>');
					htp.p('</select>');
				htp.p('</li>');
			htp.p('</ul>');

			htp.p('<a class="addpurple block" onclick="addVarconteudo();">'||fun.lang('ADICIONAR')||'</a>');

		end if;
		htp.p('<ul class="form" id="conf_ajax" style="max-height: calc(100% - 236px);">');
	end if;


	-- Monta variáveis do usuário do filtro 
	for a in crs_conteudo loop 
		ws_descricao    := a.descricao;
		ws_visualizacao := nvl(substr(a.permissao,1,1),'N'); 
		ws_alteracao    := nvl(substr(a.permissao,2,1),'N'); 
		ws_exclusao     := nvl(substr(a.permissao,3,1),'N'); 
		if ws_admin_up = 'A' then 
			ws_descricao := a.variavel||' - '||ws_descricao;
		end if; 

		if (ws_visualizacao = 'T') or (ws_visualizacao = 'U' and ws_admin_up = 'A') then -- Permissao de visualização 
			ws_count := ws_count+1;
			htp.p('<li title="'||a.variavel||'" data-usuario="'||a.usuario||'" data-default="'||a.conteudo||'">');
				htp.p('<span class="before" title="'||ws_descricao||'" style="text-transform: none;">'||nvl(a.nome,a.variavel)||'</span>');
				htp.p('<span class="after">');

				if (ws_alteracao = 'T') or (ws_alteracao = 'U' and ws_admin_up = 'A') then  -- Permissao de alteração 
					htp.p('<input class="vsis-input" type="text" value="'||a.conteudo||'" />');
				else
					htp.p('<input class="readonly" type="text" value="'||a.conteudo||'" readonly />');							
				end if;
				htp.p('</span>');

				if (ws_exclusao = 'T') or  (ws_exclusao = 'U' and ws_admin_up = 'A') then  -- Permissao de alteração 
					fcl.button_lixo('dl_vconteudo','prm_variavel|prm_usuario', a.variavel||'|'||a.usuario);
				else 
					htp.p('<a class="noremove" onclick="alerta(''msg'', '''||fun.lang('Vari&aacute;vel n&atilde;o pode ser excluida')||''');" title="'||fun.lang('Vari&aacute;vel n&atilde;o pode ser excluido')||'">X</a>');
				end if;
			htp.p('</li>');
		end if; 	
	end loop; 	

		/**** 
		open crs_conteudo(ws_admin, ws_usuario);
		loop
				fetch crs_conteudo into ws_conteudo;
				exit when crs_conteudo%notfound;
					ws_count := ws_count+1;
					if gbl.getNivelUpquery(ws_usuario) = 'A' then 
						ws_descricao := ws_conteudo.variavel||' - '||ws_conteudo.descricao;
					else 
						ws_descricao := ws_conteudo.descricao;
					end if; 

					htp.p('<li title="'||ws_conteudo.variavel||'" data-usuario="'||ws_conteudo.usuario||'" data-default="'||ws_conteudo.conteudo||'">');
						htp.p('<span class="before" title="'||ws_descricao||'" style="text-transform: none;">'||ws_conteudo.nome||'</span>');
						htp.p('<span class="after">');

							if (ws_conteudo.locked in ('N','S','V') )  or (ws_conteudo.locked = 'U' and ws_admin_up = 'A') then
								htp.p('<input class="vsis-input" type="text" value="'||ws_conteudo.conteudo||'" />');
							else
								htp.p('<input class="readonly" type="text" value="'||ws_conteudo.conteudo||'" readonly />');							
							end if;
						htp.p('</span>');

						if ws_admin = 'A' then
							if ws_conteudo.locked = 'S' then  -- Pode ser removivel da tela
								fcl.button_lixo('dl_vconteudo','prm_variavel|prm_usuario', ws_conteudo.variavel||'|'||ws_conteudo.usuario);
							else 
								htp.p('<a class="noremove" onclick="alerta(''msg'', '''||fun.lang('Valor n&atilde;o pode ser excluido')||''');" title="'||fun.lang('Valor n&atilde;o pode ser excluido')||'">X</a>');
							end if;
						end if;

					htp.p('</li>');
		end loop;
		close crs_conteudo;
		******/ 

	if ws_count = 0 then
		htp.p('<li><h2>'||fun.lang('NENHUMA VARI&Aacute;VEL')||'</h2></li>');
	end if;

	if prm_todo = 'S' then
			htp.p('</ul>');
		htp.p('</div>');
		fcl.closer_menu;
	end if;

exception 
	when ws_nouser then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end list_vconteudo;

procedure edit_vconteudo( prm_variavel varchar2 default null,
						prm_conteudo varchar2 default null,
						prm_usuario  varchar2 default null ) as

	ws_count    number;
	ws_converte varchar2(800);
	ws_variavel varchar2(800);

begin

	ws_converte := fun.converte(prm_conteudo);
	ws_variavel := fun.converte(prm_variavel);

	select count(*) into ws_count from var_conteudo where variavel = upper(trim(ws_variavel)) and usuario = prm_usuario;

	if ws_count = 1 then
		update var_conteudo
		set conteudo = ws_converte,
		data = sysdate
		where variavel = upper(trim(ws_variavel)) and usuario = prm_usuario;
	elsif ws_count = 0 then
		htp.p('#alert '||fun.lang('Valor inexistente no banco')||'!');
	else
		htp.p('#alert '||fun.lang('Impossivel alterar, valor duplicado')||'!');
	end if;

exception when others then
	htp.p('#alert '||fun.lang('Erro ao atualizar o valor')||'!');
end edit_vconteudo;

procedure add_vconteudo ( 	prm_variavel varchar2 default null,
							prm_usuario  varchar2 default 'DWU',
							prm_lock     varchar2 default 'N' ) as

	ws_count    number;
	ws_converte varchar2(800);
	ws_lock 	varchar2(10);
begin

	if prm_lock = 'N' then
		ws_lock:= 'TTN';
	elsif  prm_lock = 'X' then
		ws_lock:= 'TNN';
	else
		ws_lock:= 'TTT';
	end if;
	
	/*fcl.refresh_Session;*/

	ws_converte := fun.converte(prm_variavel);

	--se foi escolhido um grupo
	select count(*) into ws_count from gusers_itens where cd_group = prm_usuario;

	if ws_count <> 0 then

		for i in(select cd_usuario from gusers_itens where cd_group = prm_usuario and cd_usuario not in (select usuario from var_conteudo where variavel = upper(trim(ws_converte)) ) ) loop
			insert into var_conteudo (usuario, variavel, data, conteudo, locked, permissao) 
				values(i.cd_usuario, upper(trim(ws_converte)), sysdate, '', prm_lock, ws_lock);
		end loop;

		ws_count := SQL%ROWCOUNT;
		if ws_count <> 0 then
			htp.p('OK');
			commit;
		end if;

	else

		select count(*) into ws_count from var_conteudo where variavel = upper(trim(ws_converte)) and usuario = prm_usuario;
		if ws_count = 0 then
			insert into var_conteudo (usuario, variavel, data, conteudo, locked, permissao)
				values(prm_usuario, upper(trim(ws_converte)), sysdate, '', prm_lock, ws_lock);
			
			ws_count := SQL%ROWCOUNT;
			if ws_count = 1 then
				htp.p('OK');
				commit;
			end if;
		elsif ws_count = 1 then
			htp.p('#alert '||fun.lang('Imposs&iacute;vel inserir, valor j&aacute; existe')||'!');
		else
			htp.p('#alert '||fun.lang('Imposs&iacute;vel inserir, valor duplicado')||'!');
		end if;
	end if;

exception when others then
	htp.p('#alert '||fun.lang('Erro ao adicionar o novo valor')||'!');
end add_vconteudo;

procedure dl_vconteudo ( prm_variavel varchar2 default null,
						prm_usuario  varchar2 default null ) as

	ws_count     number;
	ws_converte  varchar2(800);
begin

	/*fcl.refresh_Session;*/

	ws_converte := fun.converte(prm_variavel);

	select count(*) into ws_count from var_conteudo where variavel = upper(trim(ws_converte)) and usuario = prm_usuario;
	if ws_count > 0 then
		
		delete from var_conteudo where variavel = upper(trim(ws_converte)) and usuario = prm_usuario;
		
		ws_count := SQL%ROWCOUNT;
		
		if ws_count <> 0 then
			htp.p('OK');
			commit;
		end if;
		
	else
		htp.p('#alert '||fun.lang('Imposs&iacute;vel excluir, valor inexistente')||'!');
	end if;

	exception when others then
		htp.p('#alert '||fun.lang('Erro ao excluir o valor')||'!');
end dl_vconteudo;

--!!
procedure alter_value( prm_object varchar2 default 'DEFAULT',
					prm_prop   varchar2 default null,
					prm_valor1 varchar2 default null,
					prm_valor2 varchar2 default null,
					prm_screen varchar2 default 'DEFAULT' ) as

	ws_count   number;
	ws_valor   varchar2(4000);
	ws_usuario varchar2(80);

	ws_nouser  exception;

begin
	ws_usuario := gbl.getUsuario;

	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if;

	/*fcl.refresh_Session;*/
	if prm_valor1 = prm_valor2 then
		select count(*) into ws_count from object_attrib where cd_object = prm_object and owner = ws_usuario and cd_prop = prm_prop and screen = prm_screen;
		if ws_count = 1 then
			update object_attrib
			set propriedade = prm_valor1
			where owner = ws_usuario and
			cd_prop = prm_prop and
			cd_object = prm_object;
		elsif ws_count = 0 then
			insert into object_attrib values(ws_usuario, 'DEFAULT', prm_screen, prm_object, prm_prop, prm_valor1);
		end if;
	else
		select count(*) into ws_count from object_attrib where cd_object = prm_object and owner = ws_usuario and cd_prop = prm_prop and screen = prm_screen;
		if ws_count = 1 then
			select propriedade into ws_valor from object_attrib where cd_object = prm_object and owner = ws_usuario and cd_prop = prm_prop and screen = prm_screen;
			if ws_valor = prm_valor1 then
				update object_attrib
				set propriedade = prm_valor2
				where owner = ws_usuario and
				cd_prop = prm_prop;
			else
				update object_attrib
				set propriedade = prm_valor1
				where owner = ws_usuario and
				cd_prop = prm_prop;
			end if;
		elsif ws_count = 0 then
			insert into object_attrib values(ws_usuario, 'DEFAULT', 'DEFAULT', 'DEFAULT', 'DRILL', prm_valor1);
		end if;
	end if;

exception 
	when ws_nouser then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(fun.lang('Erro ao realizar a altera&ccedil;&atilde;o')||'!'||USER);
end alter_value;

procedure list_calculada ( prm_objeto varchar2 default null,
						prm_visao  varchar2 default null ) as

	cursor crs_linhas is
	select cd_coluna, cd_coluna_show, ds_coluna_show, ds_formula from linha_calculada where cd_objeto = prm_objeto;

	ws_linha crs_linhas%rowtype;

	ws_rotulo varchar2(40);
	ws_agrupador varchar2(40);
	ws_selected varchar2(40);

	ws_count number;
	ws_counts number;
begin

	htp.p('<table class="linha">');
		htp.p('<thead>');
			htp.p('<tr>');
				htp.p('<th>'||fun.lang('COLUNA')||'</th>');
				htp.p('<th>ID</th>');
				htp.p('<th>'||fun.lang('DESCRI&Ccedil;&Atilde;O')||'</th>');
				htp.p('<th>'||fun.lang('F&Oacute;RMULA')||'</th>');
				htp.p('<th></th>');
			htp.p('</tr>');
		htp.p('</thead>');
		htp.p('<tbody id="ajax">');
			open crs_linhas;
				loop
					fetch crs_linhas into ws_linha;
					exit when crs_linhas%notfound;
					htp.p('<tr>');
						htp.p('<td>'||ws_linha.cd_coluna||'</td>');
						htp.p('<td>'||ws_linha.cd_coluna_show||'</td>');
						htp.p('<td>'||ws_linha.ds_coluna_show||'</td>');
						htp.p('<td style="line-height: 16px;"><textarea id="'||ws_linha.cd_coluna_show||'formula" placeholder="'||fun.lang('Digite a formula')||'" style="width: 600px; height: 20px; resize: vertical; padding: 2px; max-height: 100px;" onblur="if(this.value.trim().length > 0){ ajax(''fly'', ''create_linha'', ''prm_objeto='||prm_objeto||'&prm_visao='||prm_visao||'&prm_coluna='||ws_linha.cd_coluna||'&prm_show='||ws_linha.cd_coluna_show||'&prm_desc='||ws_linha.cd_coluna_show||'&prm_formula=''+encodeURIComponent(this.value), false); }">'||ws_linha.ds_formula||'</textarea></td>');
						htp.p('<td>');
							fcl.button_lixo('dl_linha','prm_objeto|prm_visao|prm_coluna|prm_show', prm_objeto||'|'||prm_visao||'|'||ws_linha.cd_coluna||'|'||ws_linha.cd_coluna_show);
						htp.p('</td>');
						--htp.p('<td><a class="remove" title="'||fun.lang('remover esta linha')||'" onclick="if(confirm(TR_CE)){ ajax(''fly'', ''dl_linha'', ''prm_objeto='||prm_objeto||'&prm_visao='||prm_visao||'&prm_coluna='||ws_linha.cd_coluna||'&prm_show='||ws_linha.cd_coluna_show||'''); linha = this.parentNode.parentNode; this.parentNode.parentNode.parentNode.removeChild(linha); }">X</a></td>');
					htp.p('</tr>');
				end loop;
			close crs_linhas;
		htp.p('</tbody>');
	htp.p('</table>');
end list_calculada;


procedure create_linha( prm_objeto  varchar2 default null,
						prm_visao   varchar2 default null,
						prm_coluna  varchar2 default null,
						prm_show    varchar2 default null,
						prm_desc    varchar2 default null,
						prm_formula varchar2 default null ) as

	ws_count   number;
	ws_convert varchar2(800);
	ws_id      varchar2(800);
	ws_formula varchar2(800);

begin

	ws_convert := fun.converte(prm_desc);
	ws_id      := fun.converte(prm_show);
	ws_formula := fun.converte(prm_formula);

	select count(*) into ws_count from linha_calculada where cd_objeto = trim(upper(prm_objeto)) and cd_micro_visao = trim(upper(prm_visao)) and cd_coluna = trim(upper(prm_coluna)) and cd_coluna_show = trim(upper(ws_id));
	if ws_count = 0 then
		insert into linha_calculada values(trim(upper(prm_objeto)), trim(upper(prm_visao)), trim(upper(prm_coluna)), trim(upper(ws_id)), trim(ws_convert), trim(ws_formula));
	else
		if (nvl(trim(ws_formula), 'N/A') <> 'N/A') then
			update linha_calculada set ds_formula = ws_formula where cd_objeto = trim(upper(prm_objeto)) and cd_micro_visao = trim(upper(prm_visao)) and cd_coluna_show = upper(trim(ws_id));
			htp.p('#alert '||fun.lang('Coluna alterada com sucesso')||'!');
		else
			htp.p('#alert '||fun.lang('Coluna j&aacute; existe')||'!');
		end if;
	end if;
exception when others then
	htp.p('#alert '||fun.lang('Erro ao alterar a coluna')||'!');
end create_linha;


procedure dl_linha ( prm_objeto varchar2 default null,
					prm_visao  varchar2 default null,
					prm_coluna varchar2 default null,
					prm_show   varchar2 default null ) as

	ws_count number;
	ws_id    varchar2(800);
begin

	ws_id := fun.converte(prm_show);

	select count(*) into ws_count from linha_calculada where cd_objeto = trim(upper(prm_objeto)) and cd_micro_visao = trim(upper(prm_visao)) and cd_coluna = trim(upper(prm_coluna)) and cd_coluna_show = trim(upper(ws_id));

	if ws_count = 1 then
		delete from linha_calculada where cd_objeto = trim(upper(prm_objeto)) and cd_micro_visao = trim(upper(prm_visao)) and cd_coluna = trim(upper(prm_coluna)) and cd_coluna_show = trim(upper(ws_id));
		htp.p('#alert '||fun.lang('Linha excluida com sucesso')||'');
	elsif ws_count > 1 then
		htp.p('#alert '||fun.lang('Erro ao excluir, valor duplicado')||'!');
	else
		htp.p('#alert '||fun.lang('Erro ao excluir, valor inexistente')||'!');
	end if;

end dl_linha;

procedure dre as

	cursor crs_maps is
		select cd_mapa, ds_mapa, cd_ligacao, ds_mascara, masc_point, masc_right, cd_masc_coluna, cd_coluna_deff
		from define_map;

	ws_map crs_maps%rowtype;

	cursor crs_cdesc is
		select nds_tabela, nds_owner, nds_tfisica, nds_cd_empresa, nds_cd_codigo, nds_cd_descricao
		from CODIGO_DESCRICAO order by nds_tabela;

	ws_cdesc	crs_cdesc%rowtype;

	cursor crs_masks is
		select cd_mascara, ds_mascara from
		mascaras order by cd_mascara asc;

	ws_mask crs_masks%rowtype;

begin
	htp.p('<div id="slidemenu" style="overflow: hidden; height: 50px; margin-bottom: 3px;">');
		htp.p('<div id="dre-menu" style="width: 100%; display: inline; float: left; transition: margin 0.5s linear; height: 50px;">');
			htp.p('<a style="margin-bottom: 25px;" title="'||fun.lang('Clique para criar dre')||'" class="add" onclick="mapa = document.getElementById(''cd_mapa'').value; if(mapa.length > 1){ fun.cdesc = document.getElementById(''cdesc'').getAttribute(''title''); if(cdesc.length > 1){ masc = document.getElementById(''masc'').getAttribute(''title''); if(masc != ''''){ point = document.getElementById(''point'').getAttribute(''title''); if(point != ''''){ right = document.getElementById(''right'').getAttribute(''title''); if(right != ''''){ ajax(''main'', ''new_dre'', ''prm_mapa=''+mapa+''&prm_dsmapa=''+document.getElementById(''ds_mapa'').value+''&prm_ligacao=&prm_dsmasc=''+cdesc+''&prm_point=''+point+''&prm_right=''+right+''&prm_masc_coluna=''+masc+''&prm_coluna_deff=''+document.getElementById(''coluna_deff'').value, false, ''ajax''); noerror('''', '''||fun.lang('DRE adicionado com sucesso')||'!'', ''msg''); } else { alerta(''msg'','''||fun.lang('Escolha uma valor de right')||'!''); } } else { alerta(''msg'','''||fun.lang('Escolha uma valor de point')||'!''); } } else { alerta(''msg'', '''||fun.lang('Escolha uma m&aacute;scara')||'!''); } } else { alerta(''msg'', '''||fun.lang('Escolha um valor')||'!''); } } else {  alerta(''msg'', '''||fun.lang('Campo cd_mapa precisa ser maior que 4')||'!''); }" >+</a>');

			htp.p('<input id="cd_mapa" type="text" placeholder="cd_mapa" value="" style="display: inline; float: left; margin-right: 5px;" />');
			htp.p('<span style="background: url('||fun.r_gif('seta', 'PNG')||') no-repeat scroll 98% 6px #FFF;" class="fakeoption" title="" id="cdesc" onclick="if(document.getElementById(''fakelist'').className == ''''){ ajax(''list'', ''fakelist'', ''prm_ident=cdesc&prm_titulo=LOV&prm_campo=cdesc'', false, ''fakelist''); } document.getElementById(''fakelist'').classList.toggle(''visible'');">'||fun.lang('Escolha um valor')||'</span>');
			htp.p('<span style="background: url('||fun.r_gif('seta', 'PNG')||') no-repeat scroll 98% 6px #FFF;" class="fakeoption" title="" id="masc" onclick="if(document.getElementById(''fakelist'').className == ''''){ ajax(''list'', ''fakelist'', ''prm_ident=masc&prm_titulo=Mascara&prm_campo=masc'', false, ''fakelist''); } document.getElementById(''fakelist'').classList.toggle(''visible'');">'||fun.lang('Mascaras')||'</span>');

			htp.p('<span style="background: url('||fun.r_gif('seta', 'PNG')||') no-repeat scroll 98% 6px #FFF;" class="fakeoption" title="" id="point" onclick="if(document.getElementById(''fakelist'').className == ''''){ ajax(''list'', ''fakelist'', ''prm_ident=point&prm_titulo=Mascara Point&prm_campo=point'', false, ''fakelist''); } document.getElementById(''fakelist'').classList.toggle(''visible'');">'||fun.lang('Mascara Point')||'</span>');

			htp.p('<span style="background: url('||fun.r_gif('seta', 'PNG')||') no-repeat scroll 98% 6px #FFF;" class="fakeoption" title="" id="right" onclick="if(document.getElementById(''fakelist'').className == ''''){ ajax(''list'', ''fakelist'', ''prm_ident=right&prm_titulo=Mascara Right&prm_campo=point'', false, ''fakelist''); } document.getElementById(''fakelist'').classList.toggle(''visible'');">'||fun.lang('Mascara Right')||'</span>');
			htp.p('<input id="ds_mapa" type="text" placeholder="ds_mapa" value="" />');
			htp.p('<input id="coluna_deff" type="text" placeholder="cd_coluna_deff" value="" />');
		htp.p('</div>');

		htp.p('<div id="padrao-menu" style="width: 100%; display: inline; float: left; transition: margin 0.5s linear; height: 50px;">');
			htp.p('<a style="margin-bottom: 25px;" title="'||fun.lang('criar padr&atilde;o')||'" class="add" onclick="padrao = document.getElementById(''cd_padrao'').value; if(padrao.length > 1){ mapa = document.getElementById(''cd_mapa'').value; dspadrao = document.getElementById(''ds_padrao'').value; visao = document.getElementById(''micro-visao'').getAttribute(''title''); if(visao.length > 1){ ajax(''main'', ''new_padrao'', ''prm_mapa=''+mapa+''&prm_cdpadrao=''+padrao+''&prm_dspadrao=''+dspadrao+''&prm_visao=''+visao, false, ''padrao''); noerror('''', '''||fun.lang('Padr&atilde;o adicionado com sucesso')||'!'', ''msg''); } else { alerta(''msg'','''||fun.lang('Escolha uma view')||'!''); } } else { alerta(''msg'','''||fun.lang('Escolha o c&oacute;digo do padr&atilde;o')||'!''); }" >+</a>');
			htp.p('<input id="cd_padrao" type="text" placeholder="cd_padrao" value="" style="display: inline; float: left; margin-right: 5px;" />');
			htp.p('<input id="ds_padrao" type="text" placeholder="ds_padrao" value="" style="display: inline; float: left; margin-right: 5px;" />');
			htp.p('<input id="cd_mapa" type="hidden" value="" />');
			htp.p('<span class="fakeoption" title="" id="micro-visao" onclick="if(document.getElementById(''fakelist'').className == ''''){ ajax(''list'', ''fakelist'', ''prm_ident=micro-visao&prm_titulo=MICRO VIS&Atilde;O&prm_campo=visao'', false, ''fakelist''); } document.getElementById(''fakelist'').classList.toggle(''visible'');">'||fun.lang('Escolha uma view')||'</span>');
		htp.p('</div>');

		htp.p('<div id="vazio-menu" style="display: inline; float: left; height: 50px; width: 100%; transition: margin 0.5s linear;"></div>');

		htp.p('<div id="line-menu" style="width: 100%; display: inline; float: left; transition: margin 0.5s linear; height: 50px;">');
			htp.p('<a style="margin-bottom: 25px;" title="criar linha" class="add" onclick="defline = document.getElementById(''cd_defline'').value; if(defline.length > 1){ item = document.getElementById(''nr_item'').value; if(item.length > 0){ coluna = document.getElementById(''cd_coluna'').getAttribute(''title''); if(coluna.length > 1){ ajax(''main'', ''new_defline'', ''prm_mapa=''+document.getElementById(''cd_mapa'').value+''&prm_item=''+item+''&prm_padrao=''+document.getElementById(''padrao3'').value+''&prm_coluna=''+coluna+''&prm_defline=''+defline, false, ''line''); noerror('''', '''||fun.lang('Padr&atilde;o adicionado com sucesso')||'!'', ''msg''); ajax(''list'', ''dre_lines'', ''prm_map=''+document.getElementById(''cd_mapa'').value+''&prm_padrao=''+document.getElementById(''padrao3'').value, false, ''deff_lines''); } else { alerta(''msg'','''||fun.lang('Escolha uma coluna')||'!''); } } else { alerta(''msg'','''||fun.lang('Digite um numero de item!''); } } else {  alerta(''msg'',''Defline precisa ser maior que 4')||'!''); }" >+</a>');
			htp.p('<input id="cd_defline" type="text" placeholder="cd_defline" value="" style="display: inline; float: left; margin-right: 5px;" />');
			htp.p('<input id="nr_item" type="hidden" value=""/>');
			htp.p('<span style="background: url('||fun.r_gif('seta', 'PNG')||') no-repeat scroll 98% 6px #FFF;" class="fakeoption" title="" id="cd_coluna" onclick="if(document.getElementById(''fakelist'').className == ''''){ visao = document.getElementById(''micro-visao'').getAttribute(''title''); ajax(''list'', ''fakelist'', ''prm_ident=cd_coluna&prm_titulo=COLUNA&prm_campo=coluna&prm_visao=''+visao, false, ''fakelist''); } document.getElementById(''fakelist'').classList.toggle(''visible'');">'||fun.lang('Escolha um valor')||'</span>');
			htp.p('<input id="padrao3" type="hidden" value="" />');
		htp.p('</div>');

		htp.p('<div id="filtro-menu" style="width: 100%; display: inline; float: left; transition: margin 0.5s linear; height: 50px;">');
			htp.p('<a style="margin-bottom: 25px;" title="'||fun.lang('criar filtro')||'" class="add" onclick="coluna = document.getElementById(''cd_coluna_filtro'').getAttribute(''title''); condicao = document.getElementById(''condicao'').getAttribute(''title''); if(coluna.length > 1){ ajax(''main'', ''new_filtro'', ''prm_mapa=''+document.getElementById(''cd_mapa'').value+''&prm_padrao=''+document.getElementById(''padrao2'').value+''&prm_item=''+document.getElementById(''item'').value+''&prm_coluna=''+coluna+''&prm_condicao=''+condicao+''&prm_conteudo=''+document.getElementById(''conteudo'').value, false, ''filtro''); noerror('''', '''||fun.lang('Filtro adicionado com sucesso')||'!'', ''msg''); } else { alerta(''msg'','''||fun.lang('Escolha uma coluna')||'!''); }" >+</a>');

			htp.p('<span style="background: url('||fun.r_gif('seta', 'PNG')||') no-repeat scroll 98% 6px #FFF;" class="fakeoption" title="" id="cd_coluna_filtro" onclick="if(document.getElementById(''fakelist'').className == ''''){ visao = document.getElementById(''micro-visao'').getAttribute(''title''); ajax(''list'', ''fakelist'', ''prm_ident=cd_coluna_filtro&prm_titulo=COLUNA&prm_campo=coluna&prm_visao=''+visao, false, ''fakelist''); } document.getElementById(''fakelist'').classList.toggle(''visible'');">'||fun.lang('Escolha um valor')||'</span>'')');
			htp.p('<span style="background: url('||fun.r_gif('seta', 'PNG')||') no-repeat scroll 98% 6px #FFF;" class="fakeoption" title="" id="'||fun.lang('condicao')||'" onclick="if(document.getElementById(''fakelist'').className == ''''){ ajax(''list'', ''fakelist'', ''prm_ident=condicao&prm_titulo=CONDI&Ccedil;&Atilde;O&prm_campo=condicao'', false, ''fakelist''); } document.getElementById(''fakelist'').classList.toggle(''visible'');">Escolha um valor</span>');
			htp.p('<input id="conteudo" title="" placeholder="'||fun.lang('conteúdo')||'" type="text" value="" />');
			htp.p('<input id="item" title="" placeholder="item" type="text" value="" />');
			htp.p('<input id="padrao2" type="hidden" value="" />');
		htp.p('</div>');
	htp.p('</div>');

	htp.p('<div class="slidebox">');
		htp.p('<div id="dre" class="dre">');
			htp.p('<h2>Lista de DRE</h2>');
			htp.p('<table class="linha">');
				htp.p('<tbody id="ajax">');
					htp.p('<tr>');
						htp.p('<th style="width: 30%;">'||fun.lang('C&oacute;digo')||'</th>');
						htp.p('<th style="width: 30%;">'||fun.lang('Descri&ccedil;&atilde;o')||'</th>');
						htp.p('<th style="width: 30%;">'||fun.lang('Deff_padr&atilde;o')||'</th>');
						htp.p('<th style="width: 7%;"></th>');
						htp.p('<th style="width: 3%;"></th>');
					htp.p('</tr>');
					open crs_maps;
						loop
							fetch crs_maps into ws_map;
							exit when crs_maps%notfound;
							htp.p('<tr class="dashed">');
								htp.p('<td style="width: 30%;">'||ws_map.cd_mapa||'</td>');
								htp.p('<td style="width: 30%;" id="dsmap-'||ws_map.cd_mapa||'">'||ws_map.ds_mapa||'</td>');
								htp.p('<td style="width: 30%;"><a class="red" onclick="ajax(''list'', ''dre_padrao'', ''prm_map='||ws_map.cd_mapa||''', ''false'', ''deff_padrao''); document.getElementById(''cd_mapa'').setAttribute(''value'', '''||ws_map.cd_mapa||'''); document.getElementById(''dre'').style.marginTop=''-390px''; document.getElementById(''dre-menu'').style.marginTop=''-50px''; document.getElementById(''titulo'').innerHTML=''DEFF_PADR&Atilde;O'';">DEFF_PADRAO</a></td>');
								htp.p('<td style="width: 7%;"><a class="red" onclick="if(this.className == ''red''){ this.style.color=''#009900''; this.innerHTML=''ALTERAR''; this.className='''';  ajax(''list'', ''dre_expand'', ''prm_mapa='||ws_map.cd_mapa||''', false, '''||ws_map.cd_mapa||'-expanded''); } else { this.style.color=''''; this.innerHTML='''||fun.lang('EDITAR')||'''; this.className=''red''; document.getElementById(''dsmap-'||ws_map.cd_mapa||''').innerHTML = document.getElementById(''dsmapa-'||ws_map.cd_mapa||''').value; ajax(''fly'', ''save_dre'', ''prm_mapa='||ws_map.cd_mapa||'&prm_dsmapa=''+document.getElementById(''dsmapa-'||ws_map.cd_mapa||''').value+''&prm_dsmasc=''+document.getElementById(''cdesc-'||ws_map.cd_mapa||''').getAttribute(''title'')+''&prm_point=''+document.getElementById(''point-'||ws_map.cd_mapa||''').getAttribute(''title'')+''&prm_right=''+document.getElementById(''right-'||ws_map.cd_mapa||''').getAttribute(''title'')+''&prm_masc_coluna=''+document.getElementById(''masc-'||ws_map.cd_mapa||''').getAttribute(''title''), false); document.getElementById('''||ws_map.cd_mapa||'-expanded'').innerHTML = ''''; }" title="'||fun.lang('Editar/salvar op&ccedil;&otilde;es')||'">'||fun.lang('EDITAR')||'</a></td>');
								fcl.button_lixo('dl_dre','prm_mapa', ws_map.cd_mapa);
								--htp.p('<td style="width: 3%;"><a class="remove" title="'||fun.lang('excluir DRE')||'" onclick="ajax(''fly'', ''dl_dre'', ''prm_mapa='||ws_map.cd_mapa||''', false); noerror(this, '''||fun.lang('DRE excluido com sucesso')||'!'', ''msg''); document.getElementById('''||ws_map.cd_mapa||''').setAttribute(''id'', '''');">X</a></td>');
							htp.p('</tr>');
							htp.p('<tr class="noborder"><td colspan="4" style="width: 100%; padding: 0 0 2px 0;" id="'||ws_map.cd_mapa||'-expanded"></td></tr>');
						end loop;
					close crs_maps;
				htp.p('</tbody>');
			htp.p('</table>');
		htp.p('</div>');
		htp.p('<div id="deff_padrao" class="dre"></div>');
		htp.p('<div id="deff_lines" class="dre"></div>');
		htp.p('<div id="deff_line" class="dre"></div>');
		htp.p('<div id="deff_filtro" class="dre"></div>');

	htp.p('</div>');
end dre;

procedure dre_expand ( prm_mapa varchar2 default null ) as

ws_dsmapa varchar2(30);
ws_mascara varchar2(30);
ws_point varchar2(30);
ws_right varchar2(30);
ws_coluna varchar2(30);
ws_coluna_masc varchar2(30);

begin

	select ds_mapa, ds_mascara, masc_point, masc_right, cd_masc_coluna, (select cd_mascara from mascaras where ds_mascara = cd_masc_coluna and rownum = 1) as mascara
	into ws_dsmapa, ws_mascara, ws_point, ws_right, ws_coluna, ws_coluna_masc
	from define_map
	where cd_mapa = prm_mapa;

	htp.p('<span style="background: url('||fun.r_gif('seta', 'PNG')||') no-repeat scroll 98% 6px #FFF;" class="fakeoption" title="'||ws_mascara||'" id="cdesc-'||prm_mapa||'" onclick="if(document.getElementById(''fakelist'').className == ''''){ ajax(''list'', ''fakelist'', ''prm_ident=cdesc-'||prm_mapa||'&prm_titulo=LOV&prm_campo=cdesc'', ''false'', ''fakelist''); } document.getElementById(''fakelist'').classList.toggle(''visible'');">'||ws_mascara||'</span>');
	htp.p('<span style="background: url('||fun.r_gif('seta', 'PNG')||') no-repeat scroll 98% 6px #FFF;" class="fakeoption" title="'||ws_coluna||'" id="masc-'||prm_mapa||'" onclick="if(document.getElementById(''fakelist'').className == ''''){ ajax(''list'', ''fakelist'', ''prm_ident=masc-'||prm_mapa||'&prm_titulo=Mascara&prm_campo=masc'', ''false'', ''fakelist''); } document.getElementById(''fakelist'').classList.toggle(''visible'');">'||ws_coluna_masc||'</span>');
	htp.p('<span style="background: url('||fun.r_gif('seta', 'PNG')||') no-repeat scroll 98% 6px #FFF;" class="fakeoption" title="'||ws_point||'" id="point-'||prm_mapa||'" onclick="if(document.getElementById(''fakelist'').className == ''''){ ajax(''list'', ''fakelist'', ''prm_ident=point-'||prm_mapa||'&prm_titulo=Mascara Point&prm_campo=point'', ''false'', ''fakelist''); } document.getElementById(''fakelist'').classList.toggle(''visible'');">'||fun.ext_masc(ws_point)||'</span>');
	htp.p('<span style="background: url('||fun.r_gif('seta', 'PNG')||') no-repeat scroll 98% 6px #FFF;" class="fakeoption" title="'||ws_right||'" id="right-'||prm_mapa||'" onclick="if(document.getElementById(''fakelist'').className == ''''){ ajax(''list'', ''fakelist'', ''prm_ident=right-'||prm_mapa||'&prm_titulo=Mascara Right&prm_campo=point'', ''false'', ''fakelist''); } document.getElementById(''fakelist'').classList.toggle(''visible'');">'||fun.ext_masc(ws_right)||'</span>');
	htp.p('<input type="text" placeholder="ds_mapa" value="'||ws_dsmapa||'" id="dsmapa-'||prm_mapa||'" style="display: inline; float: left; margin-right: 5px;" />');

end dre_expand;

procedure dre_padrao ( prm_map varchar2 default null ) as

		cursor crs_padroes is
		select cd_padrao, ds_padrao, cd_micro_visao
		from deff_padrao where cd_mapa = prm_map;

		ws_padrao crs_padroes%rowtype;

begin
	htp.p('<h2><a class="red" title="voltar" style="font-size: 16px; font-weight: bold;" onclick="document.getElementById(''dre'').style.marginTop=''0''; document.getElementById(''dre-menu'').style.marginTop=''0''; document.getElementById(''titulo'').innerHTML=''DRE'';">'||prm_map||'</a> > <span style="font-size: 16px; font-weight: bold;">DEFF_PADRAO</span></h2>');
	htp.p('<table class="linha">');
		htp.p('<tbody id="padrao">');
			htp.p('<tr>');
				htp.p('<th>'||fun.lang('Padr&atilde;o')||'</th>');
				htp.p('<th>'||fun.lang('Descri&ccedil;&atilde;o')||'</th>');
				htp.p('<th>'||fun.lang('Micro vis&atilde;o')||'</th>');
				htp.p('<th>'||fun.lang('Linhas')||'</th>');
				htp.p('<th>'||fun.lang('Filtros')||'</th>');
				htp.p('<th></th>');
			htp.p('</tr>');
			open crs_padroes;
				loop
					fetch crs_padroes into ws_padrao;
					exit when crs_padroes%notfound;
					htp.p('<tr class="dashed">');
						htp.p('<td>'||ws_padrao.cd_padrao||'</td>');
						htp.p('<td>'||ws_padrao.ds_padrao||'</td>');
						htp.p('<td>'||ws_padrao.cd_micro_visao||'</td>');
						htp.p('<td><a class="red" onclick="ajax(''list'', ''dre_lines'', ''prm_map='||prm_map||'&prm_padrao='||ws_padrao.cd_padrao||''', ''false'', ''deff_lines''); document.getElementById(''padrao3'').value='''||upper(trim(ws_padrao.cd_padrao))||'''; document.getElementById(''dre'').style.marginTop=''-780px''; document.getElementById(''deff_padrao'').style.marginTop=''-390px''; document.getElementById(''dre-menu'').style.marginTop=''-100px''; document.getElementById(''padrao-menu'').style.marginTop=''-50px''; document.getElementById(''micro-visao'').setAttribute(''title'', '''||ws_padrao.cd_micro_visao||'''); document.getElementById(''titulo'').innerHTML = ''LINHAS'';">'||fun.lang('LINHA')||'</a></td>');
						htp.p('<td><a class="red" onclick="ajax(''list'', ''dre_filtro'', ''prm_map='||prm_map||'&prm_padrao='||ws_padrao.cd_padrao||''', ''false'', ''deff_filtro''); document.getElementById(''padrao2'').value='''||upper(trim(ws_padrao.cd_padrao))||'''; document.getElementById(''dre'').style.marginTop=''-1560px''; document.getElementById(''deff_padrao'').style.marginTop=''-1170px''; document.getElementById(''deff_lines'').style.marginTop=''-780px''; document.getElementById(''deff_line'').style.marginTop=''-390px''; document.getElementById(''dre-menu'').style.marginTop=''-200px''; document.getElementById(''padrao-menu'').style.marginTop=''-150px''; document.getElementById(''vazio-menu'').style.marginTop=''-100px''; document.getElementById(''line-menu'').style.marginTop=''-50px''; document.getElementById(''micro-visao'').setAttribute(''title'', '''||ws_padrao.cd_micro_visao||'''); document.getElementById(''titulo'').innerHTML = ''DEFF_FILTRO'';">'||fun.lang('FILTROS')||'</a></td>');
						fcl.button_lixo('dl_padrao','prm_padrao', ws_padrao.cd_padrao);
						--htp.p('<td><a class="remove" title="'||fun.lang('remover')||'" onclick="ajax(''fly'', ''dl_padrao'', ''prm_padrao='||ws_padrao.cd_padrao||'''); noerror(this, '''||fun.lang('Padr&atilde;o excluido com sucesso')||'!'', ''msg'');">X</a></td>');
					htp.p('</tr>');
				end loop;
			close crs_padroes;
		htp.p('</tbody>');
	htp.p('</table>');
end dre_padrao;

procedure dre_lines ( prm_map   varchar2 default null,
					prm_padrao varchar2 default null ) as

		cursor crs_lines is
		select nr_item, count(nr_item) as counter
		from deff_line where cd_mapa = prm_map and cd_padrao = prm_padrao group by nr_item order by nr_item;

		ws_line crs_lines%rowtype;

		ws_new number;
		ws_referencia number;

begin

	htp.p('<h2><a class="red" title="voltar" style="font-size: 16px; font-weight: bold;" onclick="document.getElementById(''dre'').style.marginTop=''0''; document.getElementById(''deff_padrao'').style.marginTop=''0''; document.getElementById(''dre-menu'').style.marginTop=''0''; document.getElementById(''padrao-menu'').style.marginTop=''0''; document.getElementById(''titulo'').innerHTML=''DRE'';">'||prm_map||'</a> > <a class="red" title="voltar" style="font-size: 16px; font-weight: bold;" onclick="document.getElementById(''dre'').style.marginTop=''-390px''; document.getElementById(''deff_padrao'').style.marginTop=''0''; document.getElementById(''dre-menu'').style.marginTop=''-50px''; document.getElementById(''padrao-menu'').style.marginTop=''0''; document.getElementById(''titulo'').innerHTML=''DEFF_PADR&Atilde;O'';">'||prm_padrao||'</a> > <span style="font-size: 16px; font-weight: bold;">DEFF_LINE</span></h2>');
	htp.p('<table class="linha">');
		htp.p('<tbody id="lines">');
			htp.p('<tr>');
				htp.p('<th>'||fun.lang('Linha')||'</th>');
				htp.p('<th>'||fun.lang('Quantidade')||'</th>');
				htp.p('<th>'||fun.lang('Op&ccedil;&otilde;es')||'</th>');
			htp.p('</tr>');
			ws_referencia := 0;
			open crs_lines;
				loop
					fetch crs_lines into ws_line;
					exit when crs_lines%notfound;
					if ws_referencia = 0 then
						ws_referencia := ws_line.counter;
					end if;
					htp.p('<tr class="dashed">');
						htp.p('<td>'||ws_line.nr_item||'</td>');
						if ws_line.counter = ws_referencia then
							htp.p('<td style="color: #009900; font-weight: bold;">'||ws_line.counter||'</td>');
						else
							htp.p('<td style="color: #CC0000; font-weight: bold;" title="'||ws_referencia||'">'||ws_line.counter||'</td>');
						end if;
						htp.p('<td><a title="deff_line" class="red" onclick="ajax(''list'', ''dre_line'', ''prm_map='||prm_map||'&prm_padrao='||prm_padrao||'&prm_item='||ws_line.nr_item||''', ''false'', ''deff_line''); document.getElementById(''nr_item'').value='''||ws_line.nr_item||'''; document.getElementById(''dre'').style.marginTop=''-1170px''; document.getElementById(''deff_padrao'').style.marginTop=''-780px''; document.getElementById(''deff_lines'').style.marginTop=''-390px''; document.getElementById(''dre-menu'').style.marginTop=''-150px''; document.getElementById(''padrao-menu'').style.marginTop=''-100px''; document.getElementById(''vazio-menu'').style.marginTop=''-50px''; if(parseInt('||ws_referencia||') <= parseInt('||ws_line.counter||')){ document.getElementById(''line-menu'').style.visibility=''hidden''; } else { document.getElementById(''line-menu'').style.visibility=''visible''; } document.getElementById(''titulo'').innerHTML = ''LINHA'';">'||fun.lang('EDITAR')||'</td>');
					htp.p('</tr>');
				end loop;
			close crs_lines;
			select max(nr_item)+1 into ws_new from deff_line where cd_mapa = prm_map and cd_padrao = prm_padrao;
			htp.p('<tr class="dashed">');
				htp.p('<td>'||ws_new||'</td>');
				htp.p('<td style="color: #CC0000; font-weight: bold;">0</td>');
				htp.p('<td><a title="deff_line" class="red" onclick="ajax(''list'', ''dre_line'', ''prm_map='||prm_map||'&prm_padrao='||prm_padrao||'&prm_item='||ws_new||''', ''false'', ''deff_line''); if(('''||ws_new||''') != ''''){ document.getElementById(''nr_item'').value='''||ws_new||'''; } else { document.getElementById(''nr_item'').value=''1''; }document.getElementById(''dre'').style.marginTop=''-1170px''; document.getElementById(''deff_padrao'').style.marginTop=''-780px''; document.getElementById(''deff_lines'').style.marginTop=''-390px''; document.getElementById(''dre-menu'').style.marginTop=''-150px''; document.getElementById(''padrao-menu'').style.marginTop=''-100px''; document.getElementById(''vazio-menu'').style.marginTop=''-50px''; document.getElementById(''titulo'').innerHTML = ''LINHA'';">'||fun.lang('ADICIONAR')||'</td>');
			htp.p('</tr>');
		htp.p('</tbody>');
	htp.p('</table>');

end dre_lines;

procedure dre_line ( prm_map    varchar2 default null,
					prm_padrao varchar2 default null,
					prm_item   varchar2 default null ) as

		cursor crs_lines is
		select cd_defline, indice, cd_coluna
		from deff_line where cd_mapa = prm_map and cd_padrao = prm_padrao and nr_item = prm_item order by indice;

		ws_line crs_lines%rowtype;

begin

	htp.p('<h2><a class="red" title="'||fun.lang('voltar')||'" style="font-size: 16px; font-weight: bold;" onclick="document.getElementById(''dre'').style.marginTop=''0''; document.getElementById(''deff_padrao'').style.marginTop=''0''; document.getElementById(''deff_lines'').style.marginTop=''0''; document.getElementById(''dre-menu'').style.marginTop=''0''; document.getElementById(''padrao-menu'').style.marginTop=''0''; document.getElementById(''vazio-menu'').style.marginTop=''0''; document.getElementById(''titulo'').innerHTML=''DRE'';">'||prm_map||'</a> > <a class="red" title="'||fun.lang('voltar')||'" style="font-size: 16px; font-weight: bold;" onclick="document.getElementById(''dre'').style.marginTop=''-390px''; document.getElementById(''deff_padrao'').style.marginTop=''0''; document.getElementById(''deff_lines'').style.marginTop=''0''; document.getElementById(''dre-menu'').style.marginTop=''-50px''; document.getElementById(''padrao-menu'').style.marginTop=''0''; document.getElementById(''vazio-menu'').style.marginTop=''0''; document.getElementById(''titulo'').innerHTML=''DEFF_PADR&Atilde;O'';">'||prm_padrao||'</a> > <a class="red" title="'||fun.lang('voltar')||'" style="font-size: 16px; font-weight: bold;" onclick="document.getElementById(''dre'').style.marginTop=''-780px''; document.getElementById(''deff_padrao'').style.marginTop=''-390px''; document.getElementById(''deff_lines'').style.marginTop=''0''; document.getElementById(''dre-menu'').style.marginTop=''-100px''; document.getElementById(''padrao-menu'').style.marginTop=''-50px''; document.getElementById(''vazio-menu'').style.marginTop=''0''; document.getElementById(''titulo'').innerHTML='''||fun.lang('LINHA')||''';">'||fun.lang('LINHA')||' '||prm_item||'</a> > <small style="font-size: 16px; font-weight: bold;">'||fun.lang('LINHAS')||'</small></h2>');
	htp.p('<table class="linha">');
		htp.p('<tbody id="line">');
			htp.p('<tr>');
				htp.p('<th style="min-width: 15%;">'||fun.lang('&Iacute;ndice')||'</th>');
				htp.p('<th style="min-width: 30%;">DEFF_LINE</th>');
				htp.p('<th style="min-width: 30%;">'||fun.lang('Coluna')||'</th>');
				htp.p('<th style="min-width: 15%;"></th>');
				htp.p('<th style="min-width: 10%;"></th>');
			htp.p('</tr>');
			open crs_lines;
				loop
					fetch crs_lines into ws_line;
					exit when crs_lines%notfound;
					htp.p('<tr class="dashed">');
						htp.p('<td style="min-width: 15%;">'||ws_line.indice||'</td>');
						htp.p('<td style="min-width: 30%;">'||ws_line.cd_defline||'</td>');
						htp.p('<td style="min-width: 30%;">'||ws_line.cd_coluna||'</td>');
						htp.p('<td style="width: 15%;"><a class="red" onclick="if(this.className == ''red''){ this.style.color=''#009900''; this.innerHTML='''||fun.lang('ALTERAR')||'''; this.className='''';  ajax(''list'', ''defline_expand'', ''prm_item='||prm_item||'&prm_coluna='||ws_line.cd_coluna||'&prm_padrao='||prm_padrao||'&prm_mapa='||prm_map||''', false, '''||ws_line.indice||'-'||ws_line.cd_coluna||'-expanded''); } else { this.style.color=''''; this.innerHTML='''||fun.lang('EDITAR')||'''; this.className=''red''; st_coluna = document.getElementById(''st_coluna'').value; sub_coluna = document.getElementById(''sub_coluna'').value; ajax(''fly'', ''save_defline'', ''prm_mapa='||prm_map||'&prm_padrao='||prm_padrao||'&prm_item='||prm_item||'&prm_indice='||ws_line.indice||'&prm_coluna='||ws_line.cd_coluna||'&prm_st_coluna=''+st_coluna+''&prm_sub_coluna=''+sub_coluna, false); document.getElementById('''||ws_line.indice||'-'||ws_line.cd_coluna||'-expanded'').innerHTML = ''''; }" title="'||fun.lang('Editar/salvar op&ccedil;&otilde;es')||'">'||fun.lang('EDITAR')||'</a></td>');
						fcl.button_lixo('dl_defline','prm_item|prm_coluna|prm_mapa|prm_padrao', prm_item||'|'||ws_line.cd_coluna||'|'||prm_map||'|'||prm_padrao);
					htp.p('</tr>');
					htp.p('<tr class="noborder"><td colspan="4" style="width: 100%; padding: 0 0 2px 0;" id="'||ws_line.indice||'-'||ws_line.cd_coluna||'-expanded"></td></tr>');
				end loop;
			close crs_lines;
		htp.p('</tbody>');
	htp.p('</table>');

end dre_line;

procedure dre_filtro ( prm_map    varchar2 default null,
					prm_padrao varchar2 default null ) as

		cursor crs_filtros is
		select nr_item, cd_coluna, condicao, conteudo
		from deff_line_filtro where cd_mapa = prm_map and cd_padrao = prm_padrao order by nr_item;

		ws_filtro crs_filtros%rowtype;

begin
	/*fcl.refresh_Session;*/
	htp.p('<h2><a class="red" title="voltar" style="font-size: 16px; font-weight: bold;" onclick="document.getElementById(''dre'').style.marginTop=''0''; document.getElementById(''deff_padrao'').style.marginTop=''0''; document.getElementById(''deff_lines'').style.marginTop=''0''; document.getElementById(''deff_line'').style.marginTop=''0''; document.getElementById(''dre-menu'').style.marginTop=''0''; document.getElementById(''padrao-menu'').style.marginTop=''0''; document.getElementById(''vazio-menu'').style.marginTop=''0''; document.getElementById(''titulo'').innerHTML=''DRE'';">'||prm_map||'</a> > <a class="red" title="'||fun.lang('voltar')||'" style="font-size: 16px; font-weight: bold;" onclick="document.getElementById(''dre'').style.marginTop=''-390px''; document.getElementById(''deff_padrao'').style.marginTop=''0''; document.getElementById(''deff_lines'').style.marginTop=''0''; document.getElementById(''deff_line'').style.marginTop=''0''; document.getElementById(''dre-menu'').style.marginTop=''-50px''; document.getElementById(''padrao-menu'').style.marginTop=''0''; document.getElementById(''vazio-menu'').style.marginTop=''0''; document.getElementById(''titulo'').innerHTML='''||fun.lang('DEFF_PADR&Atilde;O')||''';">'||prm_padrao||'</a> > <small style="font-size: 16px; font-weight: bold;">'||fun.lang('DEFF_LINE_FILTRO')||'</small></h2>');
		htp.p('<table class="linha">');
			htp.p('<tbody id="filtro">');
				htp.p('<tr>');
					htp.p('<th>'||fun.lang('Número')||'</th>');
					htp.p('<th>'||fun.lang('Coluna')||'</th>');
					htp.p('<th>'||fun.lang('Condi&ccedil;&atilde;o')||'</th>');
					htp.p('<th>'||fun.lang('Conteudo')||'</th>');
					htp.p('<th></th>');
				htp.p('</tr>');
				open crs_filtros;
					loop
						fetch crs_filtros into ws_filtro;
						exit when crs_filtros%notfound;
						htp.p('<tr class="dashed">');
							htp.p('<td>'||ws_filtro.nr_item||'</td>');
							htp.p('<td>'||ws_filtro.cd_coluna||'</td>');
							htp.p('<td>'||ws_filtro.condicao||'</td>');
							htp.p('<td>'||replace(ws_filtro.conteudo, '$[CONCAT]', '||')||'</td>');
							fcl.button_lixo('dl_filtro','prm_mapa|prm_padrao|prm_item', prm_map||'|'||prm_padrao||'|'||ws_filtro.nr_item);
							--htp.p('<td><a class="remove" onclick="ajax(''fly'', ''dl_filtro'', ''prm_mapa='||prm_map||'&prm_padrao='||prm_padrao||'&prm_item='||ws_filtro.nr_item||'''); noerror(this, '''||fun.lang('Filtro excluido com sucesso')||'!'', ''msg'');">X</a></td>');
						htp.p('</tr>');
					end loop;
				close crs_filtros;
			htp.p('</tbody>');
		htp.p('</table>');

end dre_filtro;

procedure new_dre ( prm_mapa        varchar2 default null,
					prm_dsmapa      varchar2 default null,
					prm_ligacao     varchar2 default null,
					prm_dsmasc      varchar2 default null,
					prm_point       varchar2 default null,
					prm_right       varchar2 default null,
					prm_masc_coluna varchar2 default null,
					prm_coluna_deff varchar2 default null ) as

	ws_count number;

	begin
		select count(*) into ws_count from define_map where cd_mapa = upper(trim(prm_mapa));
		
		if ws_count = 0 then
			insert into define_map values(upper(trim(prm_mapa)), prm_dsmapa, prm_ligacao, prm_dsmasc, prm_point, prm_right, prm_masc_coluna, prm_coluna_deff);
			htp.p('<tr class="dashed">');
				htp.p('<td style="min-width: 30%;">'||upper(trim(prm_mapa))||'</td>');
				htp.p('<td style="min-width: 30%;">'||prm_dsmapa||'</td>');
				htp.p('<td style="min-width: 30%;"><a class="red" onclick="ajax(''list'', ''dre_padrao'', ''prm_map='||upper(trim(prm_mapa))||''', ''false'', ''deff_padrao''); document.getElementById(''cd_mapa'').setAttribute(''value'', '''||upper(trim(prm_mapa))||'''); document.getElementById(''dre'').style.marginTop=''-390px''; document.getElementById(''dre-menu'').style.marginTop=''-50px''; document.getElementById(''titulo'').innerHTML='''||fun.lang('DEFF_PADR&Atilde;O')||''';">'||fun.lang('DEFF_PADRAO')||'</a></td>');
				htp.p('<td style="width: 7%;"><a class="red" onclick="if(this.className == ''red''){ this.style.color=''#009900''; this.innerHTML='''||fun.lang('ALTERAR')||'''; this.className=''''; ajax(''list'', ''dre_expand'', ''prm_mapa='||upper(trim(prm_mapa))||''', false, '''||upper(trim(prm_mapa))||'-expanded''); } else { this.style.color=''''; this.innerHTML=''EDITAR''; this.className=''red''; ajax(''fly'', ''save_dre'', ''prm_mapa='||upper(prm_mapa)||'&prm_dsmapa=''+document.getElementById(''dsmapa-'||upper(prm_mapa)||''').value+''&prm_dsmasc=''+document.getElementById(''cdesc-'||upper(prm_mapa)||''').getAttribute(''title'')+''&prm_point=''+document.getElementById(''point-'||upper(prm_mapa)||''').getAttribute(''title'')+''&prm_right=''+document.getElementById(''right-'||upper(prm_mapa)||''').getAttribute(''title'')+''&prm_masc_coluna=''+document.getElementById(''masc-'||upper(prm_mapa)||''').getAttribute(''title''), false); document.getElementById('''||upper(prm_mapa)||'-expanded'').innerHTML = ''''; }">'||fun.lang('EDITAR')||'</a></td>');
				fcl.button_lixo('dl_dre','prm_mapa', upper(trim(prm_mapa)));
				--htp.p('<td style="width: 3%;"><a class="remove" title="excluir DRE" onclick="ajax(''fly'', ''dl_dre'', ''prm_mapa='||upper(trim(prm_mapa))||''', false); noerror(this, '''||fun.lang('DRE excluido com sucesso')||'!'', ''msg''); document.getElementById('''||upper(trim(prm_mapa))||'-expanded'').setAttribute(''id'','''');">X</a></td>');
			htp.p('</tr>');
			htp.p('<tr class="noborder"><td colspan="4" style="width: 100%; padding: 0 0 2px 0;" id="'||upper(trim(prm_mapa))||'-expanded"></td></tr>');
		elsif ws_count = 1 then
			htp.p('#alert '||fun.lang('Erro, DRE j&aacute; existe no sistema')||'!');
		else
			htp.p('#alert '||fun.lang('Erro, valor duplicado')||'!');
		end if;

end new_dre;

procedure save_dre ( prm_mapa       varchar2 default null,
					prm_dsmapa      varchar2 default null,
					prm_dsmasc      varchar2 default null,
					prm_point       varchar2 default null,
					prm_right       varchar2 default null,
					prm_masc_coluna varchar2 default null ) as

	ws_count number;

	begin

		select count(*) into ws_count from define_map where cd_mapa = upper(trim(prm_mapa));
		
		if ws_count = 1 then
			update define_map
			set ds_mascara = prm_dsmasc, ds_mapa = prm_dsmapa, masc_point = prm_point, masc_right = prm_right, cd_masc_coluna = prm_masc_coluna
			where cd_mapa = upper(trim(prm_mapa));
		elsif ws_count = 0 then
			htp.p('#alert '||fun.lang('Erro, DRE n&atilde;o existe')||'!');
		else
			htp.p('#alert '||fun.lang('Erro, valor duplicado')||'!');
		end if;

end save_dre;

procedure dl_dre ( prm_mapa varchar2 default null ) as

	ws_count number;

	begin
		
		select count(*) into ws_count from deff_padrao where cd_mapa = upper(trim(prm_mapa));

		if ws_count > 0 then
			htp.p('#alert '||fun.lang('DRE possui niveis, imposs&iacute;vel excluir')||'!');
		else
			ws_count := 0;
			select count(*) into ws_count from define_map where cd_mapa = upper(trim(prm_mapa));
			if ws_count = 1 then
				delete from define_map where cd_mapa = upper(trim(prm_mapa));
			elsif ws_count = 0 then
				htp.p('#alert '||fun.lang('Erro, DRE n&atilde;o existe')||'!');
			else
				htp.p('#alert '||fun.lang('Erro, valor duplicado')||'!');
			end if;
		end if;

end dl_dre;

procedure new_padrao ( prm_mapa     varchar2 default null,
					prm_cdpadrao varchar2 default null,
					prm_dspadrao varchar2 default null,
					prm_visao    varchar2 default null ) as

	ws_count number;

	begin

		select count(*) into ws_count from deff_padrao where cd_mapa = upper(trim(prm_mapa)) and cd_padrao = upper(trim(prm_cdpadrao));
		if ws_count = 0 then
			insert into deff_padrao values(upper(trim(prm_mapa)), upper(trim(prm_cdpadrao)), prm_dspadrao, prm_visao);
			htp.p('<tr class="dashed">');
				htp.p('<td>'||upper(trim(prm_cdpadrao))||'</td>');
				htp.p('<td>'||prm_dspadrao||'</td>');
				htp.p('<td>'||prm_visao||'</td>');
				htp.p('<td><a class="red" onclick="ajax(''list'', ''dre_line'', ''prm_map='||prm_mapa||'&prm_padrao='||upper(trim(prm_cdpadrao))||''', ''false'', ''deff_line''); document.getElementById(''padrao3'').value='''||upper(trim(prm_cdpadrao))||'''; document.getElementById(''dre'').style.marginTop=''-780px''; document.getElementById(''deff_padrao'').style.marginTop=''-390px''; document.getElementById(''dre-menu'').style.marginTop=''-100px''; document.getElementById(''padrao-menu'').style.marginTop=''-50px''; document.getElementById(''titulo'').innerHTML = ''DEFF_LINE''; ">DEFF_LINE</a></td>');
				htp.p('<td><a class="red" onclick="ajax(''list'', ''dre_filtro'', ''prm_map='||prm_mapa||'&prm_padrao='||upper(trim(prm_cdpadrao))||''', ''false'', ''deff_filtro''); document.getElementById(''dre'').style.marginTop=''-1170px''; document.getElementById(''deff_padrao'').style.marginTop=''-780px''; document.getElementById(''deff_line'').style.marginTop=''-390px''; ">'||fun.lang('FILTROS')||'</a></td>');
				fcl.button_lixo('dl_padrao','prm_padrao', prm_cdpadrao);
				--htp.p('<td><a class="remove" title="'||fun.lang('remover')||'" onclick="ajax(''fly'', ''dl_padrao'', ''prm_padrao='||prm_cdpadrao||'''); noerror(this, '''||fun.lang('Padr&atilde;o excluido com sucesso')||'!'', ''msg'');">X</a></td>');
			htp.p('</tr>');
		elsif ws_count = 1 then
			htp.p('#alert '||fun.lang('Erro, Padr&atilde;o j&aacute; existe no sistema')||'!');
		else
			htp.p('#alert '||fun.lang('Erro, valor duplicado')||'!');
		end if;

end new_padrao;

procedure dl_padrao ( prm_padrao varchar2 default null ) as

	ws_count number;

	begin

		select count(*) into ws_count from deff_line where cd_padrao = upper(trim(prm_padrao));

		if ws_count > 0 then
			htp.p('#alert '||fun.lang('Padr&atilde;o possui filtros/linhas, imposs&iacute;vel excluir')||'!');
		else
			ws_count := 0;
			select count(*) into ws_count from deff_padrao where cd_padrao = upper(trim(prm_padrao));
			if ws_count = 1 then
				delete from deff_padrao where cd_padrao = upper(trim(prm_padrao));
			elsif ws_count = 0 then
				htp.p('#alert '||fun.lang('Erro, Padr&atilde;o n&atilde;o existe')||'!');
			else
				htp.p('#alert '||fun.lang('Erro, valor duplicado')||'!');
			end if;
		end if;

end dl_padrao;

procedure new_defline ( prm_mapa    varchar2 default null,
						prm_item    varchar2 default null,
						prm_padrao  varchar2 default null,
						prm_coluna  varchar2 default null,
						prm_defline varchar2 default null ) as

	ws_count number;
	ws_indice number;

	begin

		select count(*) into ws_count from deff_line where cd_mapa = upper(trim(prm_mapa)) and cd_padrao = upper(trim(prm_padrao)) and nr_item = prm_item;
		select max(nvl(indice, 0))+1 into ws_indice from deff_line where cd_mapa = upper(trim(prm_mapa)) and cd_padrao = upper(trim(prm_padrao)) and nr_item = prm_item;
		if ws_count = 0 then
			insert into deff_line values(ws_indice, upper(trim(prm_mapa)), prm_item, upper(trim(prm_padrao)), '', upper(trim(prm_coluna)), upper(trim(prm_defline)), '');
			htp.p('<tr>');
				htp.p('<td style="min-width: 15%;">'||ws_indice||'</td>');
				htp.p('<td style="min-width: 30%;">'||upper(trim(prm_defline))||'</td>');
				htp.p('<td style="min-width: 30%;">'||prm_coluna||'</td>');
				htp.p('<td style="width: 15%;"><a class="red" onclick="if(this.className == ''red''){ this.style.color=''#009900''; this.innerHTML=''ALTERAR''; this.className='''';  ajax(''list'', ''defline_expand'', ''prm_item='||prm_item||'&prm_coluna='||prm_coluna||'&prm_padrao='||prm_padrao||'&prm_mapa='||prm_mapa||''', false, '''||ws_indice||'-'||prm_coluna||'-expanded''); } else { this.style.color=''''; this.innerHTML=''EDITAR''; this.className=''red''; st_coluna = document.getElementById(''st_coluna'').value; sub_coluna = document.getElementById(''sub_coluna'').value; ajax(''fly'', ''save_defline'', ''prm_mapa='||prm_mapa||'&prm_padrao='||prm_padrao||'&prm_item='||prm_item||'&prm_indice='||ws_indice||'&prm_coluna='||prm_coluna||'&prm_st_coluna=''+st_coluna+''&prm_sub_coluna=''+sub_coluna, false); document.getElementById('''||ws_indice||'-'||prm_coluna||'-expanded'').innerHTML = ''''; }" title="'||fun.lang('Editar/salvar op&ccedil;&otilde;es')||'">'||fun.lang('EDITAR')||'</a></td>');
				fcl.button_lixo('dl_defline','prm_item|prm_coluna|prm_mapa|prm_padrao', prm_item||'|'||prm_coluna||'|'||prm_mapa||'|'||prm_padrao);
				--htp.p('<td style="min-width: 10%;"><a title="'||fun.lang('remover linha')||'" class="remove" onclick="ajax(''fly'', ''dl_defline'', ''prm_item='||prm_item||'&prm_coluna='||prm_coluna||'&prm_mapa='||prm_mapa||'&prm_padrao='||prm_padrao||'''); noerror(this, '''||fun.lang('Linha excluida com sucesso')||'!'', ''msg'');">X</a></td>');
			htp.p('</tr>');
			htp.p('<tr><td colspan="4" style="width: 100%; padding: 0 0 2px 0;" id="'||ws_indice||'-'||prm_coluna||'-expanded"></td></tr>');
		elsif ws_count = 1 then
			htp.p('#alert '||fun.lang('Erro, DEFF_LINE j&aacute; existe no sistema')||'!');
		else
			htp.p('#alert '||fun.lang('Erro, valor duplicado')||'!');
		end if;

end new_defline;

procedure defline_expand ( prm_item   varchar2 default null,
						prm_coluna varchar2 default null,
						prm_padrao varchar2 default null,
						prm_mapa   varchar2 default null ) as

ws_coluna char(1);
ws_subcoluna varchar2(2000);

begin

	select st_coluna, cd_sub_coluna
	into ws_coluna, ws_subcoluna
	from deff_line
	where cd_mapa = prm_mapa and cd_padrao = prm_padrao and cd_coluna = prm_coluna and nr_item = prm_item;

	htp.p('<input title="st_coluna" id="st_coluna" type="text" value="'||ws_coluna||'" placeholder="st_coluna">');
	htp.p('<input title="cd_sub_coluna" id="sub_coluna" type="text" value="'||ws_subcoluna||'" placeholder="cd_sub_coluna" style="width: 300px;">');

end defline_expand;

procedure dl_defline ( prm_item   varchar2 default null,
					prm_coluna varchar2 default null,
					prm_mapa   varchar2 default null,
					prm_padrao varchar2 default null ) as

		ws_count number;

begin

	select count(*) into ws_count from deff_line where cd_mapa = upper(trim(prm_mapa)) and cd_padrao = upper(trim(prm_padrao)) and nr_item = upper(trim(prm_item)) and cd_coluna = upper(trim(prm_coluna));
	if ws_count = 1 then
		delete from deff_line where cd_mapa = upper(trim(prm_mapa)) and cd_padrao = upper(trim(prm_padrao)) and nr_item = upper(trim(prm_item)) and cd_coluna = upper(trim(prm_coluna));
	elsif ws_count = 0 then
		htp.p('#alert '||fun.lang('Erro, DEFF_LINE n&atilde;o existe')||'!');
	else
		htp.p('#alert '||fun.lang('Erro, valor duplicado')||'!');
	end if;

end dl_defline;

procedure save_defline ( prm_mapa       varchar2 default null,
						prm_padrao     varchar2 default null,
						prm_coluna     varchar2 default null,
						prm_item       varchar2 default null,
						prm_indice     varchar2 default null,
						prm_st_coluna  varchar2 default null,
						prm_sub_coluna varchar2 default null ) as

	ws_count number;

begin

	select count(*) into ws_count from deff_line where cd_mapa = upper(trim(prm_mapa)) and cd_padrao = upper(trim(prm_padrao)) and cd_coluna = upper(trim(prm_coluna)) and nr_item= upper(trim(prm_item));
	if ws_count = 1 then
		update deff_line
		set st_coluna = prm_st_coluna, cd_sub_coluna = prm_sub_coluna
		where cd_mapa = upper(trim(prm_mapa)) and cd_padrao = upper(trim(prm_padrao)) and cd_coluna = upper(trim(prm_coluna)) and nr_item= upper(trim(prm_item));
	elsif ws_count = 0 then
		htp.p('#alert '||fun.lang('Erro, DEFF_LINE n&atilde;o existe')||'!');
	else
		htp.p('#alert '||fun.lang('Erro, valor duplicado')||'!');
	end if;

end save_defline;

procedure new_filtro ( prm_mapa     varchar2 default null,
					prm_padrao   varchar2 default null,
					prm_item     varchar2 default null,
					prm_coluna   varchar2 default null,
					prm_condicao varchar2 default null,
					prm_conteudo varchar2 default null ) as

	ws_count number;

begin

	select count(*) into ws_count from deff_line_filtro 
	where cd_mapa = upper(trim(prm_mapa)) and 
	cd_padrao = upper(trim(prm_padrao)) and 
	nr_item = upper(trim(prm_item));
	
	if ws_count = 0 then
		insert into deff_line_filtro values(upper(trim(prm_mapa)), upper(trim(prm_item)), '1', upper(trim(prm_padrao)), upper(trim(prm_coluna)), prm_condicao,  replace(prm_conteudo, '||', '$[CONCAT]'), 'AND');
		htp.p('<tr class="dashed">');
			htp.p('<td>'||upper(trim(prm_item))||'</td>');
			htp.p('<td>'||upper(trim(prm_coluna))||'</td>');
			htp.p('<td>'||prm_condicao||'</td>');
			htp.p('<td>'||replace(prm_conteudo, '$[CONCAT]', '||')||'</td>');
			fcl.button_lixo('dl_filtro','prm_mapa|prm_padrao|prm_item', prm_mapa||'|'||prm_padrao||'|'||prm_item);
			--htp.p('<td><a class="remove" onclick="ajax(''fly'', ''dl_filtro'', ''prm_mapa='||prm_mapa||'&prm_padrao='||prm_padrao||'&prm_item='||prm_item||'''); noerror(this, '''||fun.lang('Filtro excluido com sucesso')||'!'', ''msg'');">X</a></td>');
		htp.p('</tr>');
	elsif ws_count = 1 then
		htp.p('#alert '||fun.lang('Erro, Padr&atilde;o j&aacute; existe no sistema')||'!');
	else
		htp.p('#alert '||fun.lang('Erro, valor duplicado')||'!');
	end if;

end new_filtro;

procedure dl_filtro ( prm_mapa   varchar2 default null,
					prm_padrao varchar2 default null,
					prm_item   varchar2 default null ) as

	ws_count number;

begin

	select count(*) into ws_count from deff_line_filtro where cd_mapa = upper(trim(prm_mapa)) and cd_padrao = upper(trim(prm_padrao)) and nr_item = upper(trim(prm_item));
	if ws_count = 1 then
		delete from deff_line_filtro where cd_mapa = upper(trim(prm_mapa)) and cd_padrao = upper(trim(prm_padrao)) and nr_item = upper(trim(prm_item));
	elsif ws_count = 0 then
		htp.p('#alert '||fun.lang('Erro, filtro n&atilde;o existe')||'!');
	else
		htp.p('#alert '||fun.lang('Erro, valor duplicado')||'!');
	end if;

end dl_filtro;

procedure dl_object ( prm_object varchar2 default null ) as

	ws_count number;

begin
	
	begin
		delete from traducao_colunas where cd_tabela = prm_object;
		delete from call_list where cd_objeto = prm_object or cd_list = prm_object;
		delete from filtros where cd_objeto = prm_object and tp_filtro = 'objeto';
		delete from destaque where cd_objeto = prm_object;
		delete from goto_objeto where cd_objeto = prm_object or cd_objeto_go = prm_object;
		delete from objetos where cd_objeto = prm_object;
		delete from object_location where object_id = prm_object or screen = prm_object;
		delete from object_restriction where cd_objeto = prm_object;
		delete from object_attrib where cd_object = prm_object;
		delete from all_screens where screen = prm_object;
		delete from ponto_avaliacao where cd_ponto = prm_object;
		delete from float_filter_item where trim(cd_coluna) = trim(prm_object);
		delete from user_screens where screen = prm_object;
		commit;
		insert into bi_log_sistema values(sysdate, 'Objeto '||prm_object||' excluido do sistema', gbl.getUsuario, 'EVENTO');
		commit;
	exception when others then
		htp.p('#alert '||fun.lang('Erro ao excluir o objeto')||'!');
		rollback;
	end;

end dl_object;

procedure grupos ( prm_order varchar2 default '1',
				prm_dir   varchar2 default '1' ) as

	cursor crs_grupos is
	select cd_grupo, cd_grupo_superior, nm_grupo, status, gif, ordem, cd_classe, (select count(*) from objetos where objetos.cd_grupo = grupos_funcao.cd_grupo) as cobjetos
	from grupos_funcao
	order by
		case when prm_dir = '1' then decode(prm_order, '1', cd_grupo, '2', nm_grupo, cd_grupo) end asc,
		case when prm_dir = '2' then decode(prm_order, '1', cd_grupo, '2', nm_grupo, cd_grupo) end desc;

	ws_grupo crs_grupos%rowtype;
	
	ws_dir     number := 1;
	ws_padrao  varchar2(80) := 'PORTUGUESE';
	ws_usuario varchar2(80);

	ws_nouser exception;

begin

	ws_usuario := gbl.getUsuario;

	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if;

	begin
		select CONTEUDO into ws_padrao
		from   PARAMETRO_USUARIO
		where  cd_usuario = ws_usuario and
			cd_padrao='CD_LINGUAGEM';
	exception
		when others then
			ws_padrao := 'PORTUGUESE';
	end;

	htp.p('<table class="linha">');
		htp.p('<thead>');
			htp.p('<tr>');
				htp.p('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''grupos'', ''prm_order=1&prm_dir=''+dir, false, ''content'');">'||fun.lang('CATEGORIA')||'</a></th>');
				htp.p('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''grupos'', ''prm_order=2&prm_dir=''+dir, false, ''content'');">'||fun.lang('CATEGORIA SUPERIOR')||'</a></th>');
				htp.p('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''grupos'', ''prm_order=3&prm_dir=''+dir, false, ''content'');">'||fun.lang('NOME')||'</a></th>');
				htp.p('<th>'||fun.lang('CLASSE')||'</th>');
				htp.p('<th>'||fun.lang('ORDEM')||'</th>');
				htp.p('<th></th>');
			htp.p('</tr>');
			if to_number(prm_dir) = 1 then ws_dir := 2; end if;

			htp.p('<tbody id="ajax" data-dir="'||ws_dir||'">');
				open crs_grupos;
					loop
						fetch crs_grupos into ws_grupo;
						exit when crs_grupos%notfound;
						htp.p('<tr>');
							htp.p('<td><span class="text lang" id="'||ws_grupo.cd_grupo||'_nome" title="'||ws_grupo.cd_grupo||'">'||fun.utranslate('CD_GRUPO', 'GRUPOS_FUNCAO', ws_grupo.cd_grupo, ws_padrao)||'</span><a class="fakelang" onclick="fakeLang('''||ws_grupo.cd_grupo||'_nome'', ''GRUPOS_FUNCAO|CD_GRUPO|''+this.previousElementSibling.title, ''cd'');">L</a></td>');
							htp.p('<td><span class="text lang" id="'||ws_grupo.cd_grupo_superior||'_nome" title="'||ws_grupo.cd_grupo_superior||'">'||fun.utranslate('CD_GRUPO', 'GRUPOS_FUNCAO', ws_grupo.cd_grupo_superior, ws_padrao)||'</span><a class="fakelang" onclick="fakeLang('''||ws_grupo.cd_grupo_superior||'_nome'', ''GRUPOS_FUNCAO|CD_GRUPO_SUPERIOR|''+this.previousElementSibling.title, ''cd'');">L</a></td>');
							htp.p('<td>');
								htp.p('<input maxlength="100" style="width: calc(100% - 16px) !important;" title="'||ws_grupo.nm_grupo||'" id="'||ws_grupo.cd_grupo||'_desc" value="'||ws_grupo.nm_grupo||'" onblur="var valor = this.value; if(valor.length > 0){ call(''edit_grupo'', ''prm_grupo='||ws_grupo.cd_grupo||'&prm_valor=''+this.value+''&prm_tipo=nome'', false).then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } }); } else { alerta(''feed-fixo'', TR_BL); }" />');
								htp.p('<a class="fakelang" onclick="fakeLang('''||ws_grupo.cd_grupo||'_desc'', ''GRUPOS_FUNCAO|NM_GRUPO|''+this.previousElementSibling.title);">L</a>');
							htp.p('</td>');


							htp.p('<td>');
								htp.p('<select onchange="call(''edit_grupo'', ''prm_grupo='||ws_grupo.cd_grupo||'&prm_valor=''+this.value+''&prm_tipo=cd_classe'', false).then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } });">');
									if ws_grupo.cd_classe is null then 
										htp.p('<option value="" selected hidden=""></option>');
									end if; 
									for a in (select cd_classe, ds_classe from classes_funcao order by ordem) loop 
										if a.cd_classe = nvl(ws_grupo.cd_classe,'N/A') then 
											htp.p('<option value="'||a.cd_classe||'" selected>'||fun.lang(a.ds_classe)||'</option>');
										else 
											htp.p('<option value="'||a.cd_classe||'">'||fun.lang(a.ds_classe)||'</option>');
										end if; 	
									end loop; 	
								htp.p('</select>');
							htp.p('</td>');


							htp.p('<td>');
								htp.p('<input type="number" title="'||ws_grupo.ordem||'" id="'||ws_grupo.ordem||'_ordem" value="'||ws_grupo.ordem||'" oninput="call(''edit_grupo'', ''prm_grupo='||ws_grupo.cd_grupo||'&prm_valor=''+this.value+''&prm_tipo=ordem'', false).then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } });" />');
							htp.p('</td>');
							if ws_grupo.cobjetos = 0 then
								htp.p('<td>');
									fcl.button_lixo('edit_grupo','prm_grupo|prm_valor|prm_tipo', ws_grupo.cd_grupo||'|'||''||'|'||'delete');
								htp.p('</td>');
							else
								htp.p('<td><a title="'||fun.lang('imposs&iacute;vel remover')||'" class="noremove">X</a></td>');
							end if;
						htp.p('</tr>');
					end loop;
				close crs_grupos;
			htp.p('</tbody>');
		htp.p('</thead>');
	htp.p('</table>');

exception
	when ws_nouser then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end grupos;

procedure create_grupo( prm_grupo          varchar2 default null,
						prm_grupo_superior varchar2 default null,
						prm_nome           varchar2 default null,
						prm_classe         varchar2 default null ) as

	ws_count		 number;
	ws_grupo 		varchar2(40);
	ws_nome  		varchar2(120);
	ws_raise_exist	exception;
begin

	ws_grupo := fun.converte(prm_grupo);
	ws_nome  := fun.converte(prm_nome);

	select count(*) into ws_count 
	from grupos_funcao
	where cd_grupo = upper(trim(prm_grupo));

	if ws_count = 0 then
		insert into grupos_funcao (cd_grupo, cd_grupo_superior, nm_grupo, status, gif, ordem, cd_classe) values(upper(trim(ws_grupo)), upper(trim(prm_grupo_superior)), trim(ws_nome), 'A', upper(trim(ws_grupo)), 0, prm_classe);
		insert into traducao_colunas values('GRUPOS_FUNCAO', 'CD_GRUPO', fun.ret_var('LANG_SYS'), upper(trim(ws_grupo)), upper(trim(ws_grupo)), 'T', 'N');
		insert into traducao_colunas values('GRUPOS_FUNCAO', 'NM_GRUPO', fun.ret_var('LANG_SYS'), trim(ws_nome),         trim(ws_nome),         'T', 'N');
		commit;
		htp.p('ok');
	else
		raise ws_raise_exist;
	end if;

exception 
	when ws_raise_exist then
		htp.p('FAIL DUPLICADO Categoria j&aacute; existe!');
	when others then
		htp.p('Erro ao cadastrar categoria');
end create_grupo;

procedure edit_grupo( prm_grupo varchar2 default null,
					prm_valor varchar2 default null,
					prm_tipo  varchar2 default null ) as
					
	ws_convert 			varchar2(200);
	ws_desc_eventos		varchar2(100);
	ws_count 			number;

	ws_fail  			exception;
	
begin
	
	ws_convert:= trim(fun.converte(prm_valor));
	
	if prm_tipo = 'nome' then
		update grupos_funcao
		set nm_grupo = ws_convert
		where cd_grupo = trim(prm_grupo);
	elsif prm_tipo = 'ordem' then
		update grupos_funcao
		set ordem = ws_convert
		where cd_grupo = trim(prm_grupo);
	elsif prm_tipo = 'status' then
		update grupos_funcao
		set status = ws_convert
		where cd_grupo = trim(prm_grupo);
	elsif prm_tipo = 'cd_classe' then
		update grupos_funcao
		set cd_classe = ws_convert
		where cd_grupo = trim(prm_grupo);
	elsif prm_tipo = 'delete' then
		delete from grupos_funcao
		where cd_grupo = trim(prm_grupo);
	else
		update grupos_funcao
		set gif = ws_convert
		where cd_grupo = trim(prm_grupo);
	end if;

	select decode(prm_grupo, 'nome', 'nome', 'ordem', 'ordem', 'status', 'status', 'cd_clase', 'cd_classe', prm_grupo) into ws_desc_eventos from dual;

	insert into bi_log_sistema (dt_log, ds_log, nm_usuario, nm_procedure) values (sysdate, ''||ws_desc_eventos||' Alterado com sucesso', gbl.getUsuario, 'EVENTO');
	commit;
	
	ws_count := SQL%ROWCOUNT;
	
	if ws_count <> 0 then
		commit;
	else
		raise ws_fail;
	end if;

exception 
	when ws_fail then
		rollback;
		htp.p('FAIL');
	when others then
		htp.p('FAIL');
end edit_grupo;

procedure consulta ( prm_objeto      varchar2 default null,
					prm_visao       varchar2 default null,
					prm_nome        varchar2 default null,
					prm_grupo       varchar2 default null,
					prm_agrupamento varchar2 default null ) as

	cursor crs_colunas is
	select nvl(COLUMN_VALUE, 'n/a') as item from table(fun.vpipe((select cs_coluna
	from ponto_avaliacao
	where cd_ponto = prm_objeto)))
	where COLUMN_VALUE <> 'n/a';

	ws_coluna crs_colunas%rowtype;

	cursor crs_agrupadores is
	select nvl(COLUMN_VALUE, 'n/a') as item from table(fun.vpipe((select cs_agrupador
	from ponto_avaliacao
	where cd_ponto = prm_objeto)))
	where COLUMN_VALUE <> 'n/a';

	ws_agrupador crs_agrupadores%rowtype;

	cursor crs_colups is
	select nvl(COLUMN_VALUE, 'n/a') as item from table(fun.vpipe((select cs_colup
	from ponto_avaliacao
	where cd_ponto = prm_objeto)))
	where COLUMN_VALUE <> 'n/a';

	ws_colup crs_colups%rowtype;

	ws_count   number;
	ws_ok      number;
	ws_nome    varchar2(800);
	ws_id      varchar2(800);
	ws_padrao  varchar2(80) := 'PORTUGUESE';
	ws_usuario varchar2(80);
	ws_class_tpt  varchar2(20); 
	
	ws_nouser  exception;
begin

	ws_usuario := gbl.getUsuario;

	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if;

	ws_nome := fun.converte(prm_nome);
	ws_id   := fun.converte(prm_objeto);

	/*if user <> fun.usuario then
		return;
	end if;*/
	/*fcl.refresh_Session;*/

	begin
		select CONTEUDO into ws_padrao
		from   PARAMETRO_USUARIO
		where  cd_usuario = ws_usuario and
			cd_padrao='CD_LINGUAGEM';
	exception
		when others then
			ws_padrao := 'PORTUGUESE';
	end;
	
	htp.p('<input type="hidden" value="'||prm_visao||'" id="prm_visao" />');
	htp.p('<input type="hidden" value="'||ws_id||'" id="prm_objeto" />');
	htp.p('<input type="hidden" value="'||ws_nome||'" id="nome_consulta" />');
	htp.p('<input type="hidden" value="'||prm_grupo||'" id="grupo_consulta" />');
	htp.p('<input type="hidden" value="'||prm_agrupamento||'" id="agrupamento_consulta" />');

	htp.p('<div style="display: flex;">');
		ws_ok := 0;

		htp.p('<div style="height: 90%; float: left; margin-right: 10px;">');
			htp.p('<h2 class="link" style="margin: 4px; cursor: pointer; font-size: 16px;" >'||fun.lang('AGRUPADORES'));
				/*htp.p('<a style="padding: 0 !important; font-size: 20px !important;" class="add" onclick="var valores = document.getElementById(''coluna'').getElementsByClassName(''linha''); var valor = ''''; for(i=0;i<valores.length;i++){ valor = valores[i].title+''|''+valor; } fakeOption(valor, ''coluna'', ''coluna-add'', '''||prm_visao||''');">+</a>');*/
			htp.p('</h2>');
			htp.p('<ul id="coluna" data-tipo="coluna" class="dimensao" data-type="lista">');
				
				open crs_colunas;
					loop
						fetch crs_colunas into ws_coluna;
						exit when crs_colunas%notfound;
						select count(*) into ws_ok from micro_coluna where trim(cd_coluna) = trim(ws_coluna.item) and trim(cd_micro_visao) = trim(prm_visao);
						if ws_ok = 0 then
							htp.p('<li onclick="swapColumn(this);" data-type="dimensao" class="linha" title="'||ws_coluna.item||'" >'||fun.utranslate('NM_ROTULO', upper(trim(prm_visao)), fun.NOME_COL(ws_coluna.item, prm_visao), ws_padrao)||'<span class="alert" title="'||fun.lang('coluna n&atilde;o existe na tabela micro_coluna')||'">!</span></li>');
						else
							htp.p('<li onclick="swapColumn(this);" data-type="dimensao" class="linha" title="'||ws_coluna.item||'" >'||fun.utranslate('NM_ROTULO', upper(trim(prm_visao)), fun.NOME_COL(ws_coluna.item, prm_visao), ws_padrao));
								htp.p('<span>X</span>'); 
								htp.p('<span class="edit-prop-col" title="Editar propriedades da coluna">'); 
									htp.p('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M1.439 16.873l-1.439 7.127 7.128-1.437 16.873-16.872-5.69-5.69-16.872 16.872zm4.702 3.848l-3.582.724.721-3.584 2.861 2.86zm15.031-15.032l-13.617 13.618-2.86-2.861 10.825-10.826 2.846 2.846 1.414-1.414-2.846-2.846 1.377-1.377 2.861 2.86z"/></svg>'); 									
								htp.p('</span>'); 
							htp.p('</li>');
						end if;
						htp.p('<li onclick="swapSquare(this);" class="square"></li>');
					end loop;
				close crs_colunas;

			htp.p('</ul>');
		htp.p('</div>');

		ws_ok := 0;

		htp.p('<div style="height: 90%; float: left; margin-right: 10px;">');
			htp.p('<h2 class="link" style="margin: 4px; cursor: pointer; font-size: 16px;">'||fun.lang('VALORES'));
				/* htp.p('<a style="padding: 0 !important; font-size: 20px !important;" class="add" onclick="var valores = document.getElementById(''colunac'').getElementsByClassName(''linha''); var valor = ''''; for(i=0;i<valores.length;i++){ valor = valores[i].title+''|''+valor; } fakeOption(valor, ''pivot'', ''coluna-add'', '''||prm_visao||''');">+</a>');*/
			htp.p('</h2>');
			htp.p('<ul id="colunac" data-tipo="pivot" class="medida" data-type="lista">');
				
				open crs_agrupadores;
					loop
						fetch crs_agrupadores into ws_agrupador;
						exit when crs_agrupadores%notfound;
						
						ws_class_tpt := ''; 
						select count(*) into ws_count from micro_coluna where cd_coluna = ws_agrupador.item and cd_micro_visao = prm_visao and st_agrupador   = 'TPT';
						if ws_count > 0 then
							ws_class_tpt := 'template'; 
						end if; 	
						
						select count(*) into ws_ok from micro_coluna where cd_coluna = ws_agrupador.item and cd_micro_visao = prm_visao;
						if ws_ok = 0 then
							htp.p('<li onclick="swapColumn(this);" data-type="medida" class="linha '||ws_class_tpt||'" title="'||ws_agrupador.item||'">'||fun.utranslate('NM_ROTULO', upper(trim(prm_visao)), fun.NOME_COL(ws_agrupador.item, prm_visao))||'<span class="alert" title="'||fun.lang('coluna n&atilde;o existe na tabela micro_coluna')||'">!</span></li>');
						else
							htp.p('<li                           onclick="swapColumn(this);" data-type="medida" class="linha '||ws_class_tpt||'" title="'||ws_agrupador.item||'">'||fun.utranslate('NM_ROTULO', upper(trim(prm_visao)), fun.NOME_COL(ws_agrupador.item, prm_visao))); 
								htp.p('<span>X</span>'); 
								htp.p('<span class="edit-prop-col" title="Editar propriedades da coluna">'); 
									htp.p('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M1.439 16.873l-1.439 7.127 7.128-1.437 16.873-16.872-5.69-5.69-16.872 16.872zm4.702 3.848l-3.582.724.721-3.584 2.861 2.86zm15.031-15.032l-13.617 13.618-2.86-2.861 10.825-10.826 2.846 2.846 1.414-1.414-2.846-2.846 1.377-1.377 2.861 2.86z"/></svg>'); 									
								htp.p('</span>'); 
							htp.p('</li>');
						end if;
						htp.p('<li onclick="swapSquare(this);" class="square"></li>');
					end loop;
				close crs_agrupadores;

			htp.p('</ul>');
		htp.p('</div>');

		ws_ok := 0;

		htp.p('<div style="height: 90%; float: left; margin-right: 10px;">');
			htp.p('<h2 class="link" style="margin: 4px; cursor: pointer; font-size: 16px;" >PIVOT');
				/*htp.p('<a style="padding: 0 !important; font-size: 20px !important;" class="add" onclick="var valores = document.getElementById(''colunas'').getElementsByClassName(''linha''); var valor = ''''; for(i=0;i<valores.length;i++){ valor = valores[i].title+''|''+valor; } fakeOption(valor, ''group'', ''coluna-add'', '''||prm_visao||''');">+</a>'); */
			htp.p('</h2>');
			htp.p('<ul id="colunas" data-tipo="group" class="dimensao" data-type="lista">');
				
				open crs_colups;
					loop
						fetch crs_colups into ws_colup;
						exit when crs_colups%notfound;
						select count(*) into ws_ok from micro_coluna where trim(cd_coluna) = trim(ws_colup.item) and trim(cd_micro_visao) = trim(prm_visao);
						if ws_ok = 0 then
							htp.p('<li onclick="swapColumn(this);" data-type="dimensao" class="linha" title="'||ws_colup.item||'">'||fun.utranslate('NM_ROTULO', upper(trim(prm_visao)), fun.NOME_COL(ws_colup.item, prm_visao), ws_padrao)||'<span class="alert" title="'||fun.lang('coluna n&atilde;o existe na tabela micro_coluna')||'">!</span></li>');
						else
							htp.p('<li onclick="swapColumn(this);" data-type="dimensao" class="linha" title="'||ws_colup.item||'">'||fun.utranslate('NM_ROTULO', upper(trim(prm_visao)), fun.NOME_COL(ws_colup.item, prm_visao), ws_padrao));
								htp.p('<span>X</span>'); 
								htp.p('<span class="edit-prop-col" title="Editar propriedades da coluna">'); 
									htp.p('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M1.439 16.873l-1.439 7.127 7.128-1.437 16.873-16.872-5.69-5.69-16.872 16.872zm4.702 3.848l-3.582.724.721-3.584 2.861 2.86zm15.031-15.032l-13.617 13.618-2.86-2.861 10.825-10.826 2.846 2.846 1.414-1.414-2.846-2.846 1.377-1.377 2.861 2.86z"/></svg>'); 									
								htp.p('</span>'); 
							htp.p('</li>');
						end if;
						/* htp.p('<li onclick="swapColumn(this);" data-type="dimensao" class="linha" title="'||ws_colup.item||'">'||fun.utranslate('NM_ROTULO', upper(trim(prm_visao)), fun.NOME_COL(ws_colup.item, prm_visao), ws_padrao)||'<span>X</span></li>'); */
						htp.p('<li onclick="swapSquare(this);" class="square"></li>');
					end loop;
				close crs_colups;

			htp.p('</ul>');
		htp.p('</div>');

	htp.p('</div>');

exception 
	when ws_nouser then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end consulta;

procedure alter_consulta ( prm_nome        varchar2 default null,
						prm_valor       varchar2 default null,
						prm_tipo        varchar2 default null
						) as
begin
	case prm_tipo
		when 'coluna' then

			update ponto_avaliacao
			set cs_coluna = nvl2(cs_coluna, cs_coluna||'|'||prm_valor, prm_valor)
			where cd_ponto = upper(trim(prm_nome));

		when 'agrupador' then

			update ponto_avaliacao
			set cs_agrupador = nvl2(cs_agrupador, cs_agrupador||'|'||prm_valor, prm_valor)
			where cd_ponto = upper(trim(prm_nome));

		when 'pivot' then

			update ponto_avaliacao
			set cs_colup = nvl2(cs_colup, cs_colup||'|'||prm_valor, prm_valor)
			where cd_ponto = upper(trim(prm_nome));

	end case;
	
	update object_attrib
	set propriedade = 1
	where cd_prop = 'ORDEM' and
	cd_object = upper(trim(prm_nome));

end alter_consulta;


procedure save_consulta ( prm_visao       varchar2 default null,
						prm_nome        varchar2 default null,
						prm_desc        varchar2 default null,
						prm_coluna      varchar2 default null,
						prm_colup       varchar2 default null,
						prm_agrupador   varchar2 default null,
						prm_grupo       varchar2 default null,
						prm_rp          varchar2 default null,
						prm_filtros     varchar2 default null ) as

	ws_count     number;
	ws_exception exception;
	ws_nome      varchar2(800);
	ws_desc      varchar2(800);
	ws_usuario   varchar2(80);
	ws_admin     varchar2(80);
	ws_key       number := 0;
	ws_inc		 number := 0;
	ws_filtros   varchar2(4000); 
begin
	begin

		ws_usuario := gbl.getUsuario;
		ws_admin   := gbl.getNivel;

		ws_nome   := fun.converte(prm_nome);
		ws_desc   := fun.converte(prm_desc);
		ws_filtros:= replace(prm_filtros,'||','|');

		select count(*) into ws_count from ponto_avaliacao where upper(trim(cd_ponto)) = upper(trim(ws_nome));
		if ws_count = 1 then
			begin
				update ponto_avaliacao
				set cs_coluna    = prm_coluna,
					cs_agrupador = prm_agrupador,
					cs_colup     = prm_colup
				where cd_ponto = upper(trim(ws_nome));

				update object_attrib
				set propriedade = 1
				where cd_prop   = 'ORDEM' 
				and cd_object = upper(trim(ws_nome));
			exception when others then
				raise ws_exception;
			end;
		elsif ws_count = 0 then
			ws_nome := replace(UPPER(ws_nome), ' ', '');
			
			select count(*) into ws_count from objetos where upper(trim(cd_objeto)) = ws_nome;

			if ws_count = 0 then
				begin
					insert into PONTO_AVALIACAO values(replace(UPPER(ws_nome), ' ', ''), ws_desc, '', 'N', 'N', 'N', 'T', 'O', 'DWU', null, sysdate, prm_visao, '', 'A', '', '1|1', prm_coluna, prm_agrupador, prm_rp, prm_colup);
					insert into OBJETOS (cd_objeto, cd_grupo, nm_objeto, subtitulo, tp_objeto, cd_usuario, atributos, dt_ultima, ds_objeto) values (ws_nome, prm_grupo, ws_desc, '', 'CONSULTA', ws_usuario, '', sysdate, '');
					insert into OBJECT_ATTRIB values('DWU', 'DEFAULT', 'DEFAULT', ws_nome, 'TP_GRUPO', prm_rp);
					insert into OBJECT_ATTRIB values('DWU', 'DEFAULT', 'DEFAULT', ws_nome, 'ALTURA', '0');
					insert into OBJECT_ATTRIB values('DWU', 'DEFAULT', 'DEFAULT', ws_nome, 'ORDEM', '1');
					insert into OBJECT_ATTRIB values('DWU', 'DEFAULT', 'DEFAULT', ws_nome, 'FILTRO', 'PASSIVO');
					insert into OBJECT_ATTRIB values('DWU', 'DEFAULT', 'DEFAULT', ws_nome, 'TIMER', '0');

					if nvl(ws_filtros, 'N/A') <> 'N/A' then

					select nvl2(max(cd_filtro), max(cd_filtro), 0)+1 into ws_key from filtros;
					loop
					
						ws_inc := ws_inc+1;
					
						select count(*) into ws_count from filtros where cd_filtro = ws_key;
					
						if ws_count > 0 then
							select ws_key+ws_inc into ws_key from filtros;
						else
							exit;
						end if;
					end loop;

						for i in(select cd_coluna, cd_conteudo, cd_condicao from table(fun.vpipe_par((ws_filtros)))) loop

							insert into filtros (cd_usuario, cd_objeto, micro_visao, cd_coluna, condicao, conteudo, ligacao, st_agrupado, cd_filtro, tp_filtro, cd_criado)
							values (ws_usuario, ws_nome, prm_visao, i.cd_coluna, i.cd_condicao, i.cd_conteudo, 'and', 'N', ws_key, 'objeto', ws_usuario);
							
							ws_key := ws_key+1;
						
						end loop;

					end if;
				
				exception when others then
					raise ws_exception;
				end;
			else
				htp.p('#alert ID j&aacute; existe!');
			end if;
		else
			htp.p('#alert Erro ao inserir valores no ponto de avalia&ccedil;&atilde;o!');
		end if;

	exception
	when ws_exception then
		rollback;
		htp.p('#alert '||fun.lang('Erro ao salvar a consulta')||'!');
	when others then
		rollback;
		htp.p('#alert '||fun.lang('Erro ao salvar a consulta')||'!');
	end;
end save_consulta;


procedure refresh_session as

ws_id_session_bi varchar2(100); 
ws_return 		 varchar2(2);
ws_sid			 varchar2(20);
ws_serial		 varchar2(20);

begin
	ws_return:='99';
	
	if nvl(fun.ret_var('XE'), 'N') = 'N' then
		
		SELECT sid, serial#
		INTO ws_sid,ws_serial
		FROM v$session
		WHERE audsid=USERENV('SESSIONID');


		ws_id_session_bi := nvl(gbl.getUsuario()||replace(sys_context('userenv','ip_address'), '.'),'N/A');

		update active_sessions 
			set dt_atividade = sysdate,
				cd_sid	     = ws_sid,
				cd_serial    = ws_serial 
		where id_session = ws_id_session_bi
			and status     = 'A' ;

		if sql%notfound then
			ws_return:='0';
		end if;

		commit;
	end if;

	htp.p(ws_return);

exception 
	when others then
		htp.p('0');
end refresh_session;



procedure valida_session as
	ws_session             owa_cookie.cookie;
	ws_id_session_web      varchar2(80); 
	ws_id_session_bi       varchar2(80);	
	ws_usuario   	       varchar2(80);
	ws_dt_ultima_atividade date; 
	ws_rowid               rowid; 
	ws_tempo_exp           number;
	ws_count_slide		   number;
	ws_msg_erro            varchar2(200); 
	ws_count_usu		   number; 
	ws_logout              exception;
	ws_sysout              exception;
	ws_cache_reload		   exception;
	

	cursor c1 is  -- Sessão com atividade mais recente 
	select rowid, dt_atividade 
		from active_sessions
	where id_session = ws_id_session_bi
		and status     = 'A'
	order by dt_atividade desc;	 

begin
	
	if nvl(fun.ret_var('XE'), 'N') = 'N' then

		ws_session        := owa_cookie.get('SESSION');
		begin 
			ws_id_session_web := ws_session.vals(1); 
		exception when no_data_found then 
			ws_msg_erro := 'Sess&atilde; sem usu&aacute;rio definido.';
			raise ws_logout;
		end; 	

		ws_usuario        := fun.getSessao(ws_id_session_web);
		ws_id_session_bi  := gbl.getUsuario()||replace(sys_context('userenv','ip_address'), '.'); 

		select count(*) into ws_count_usu 
		from usuarios 
		where usu_nome = ws_usuario;
		
		--verifica se o usuário é SLIDE para recarregar o BI em horas setadas
		select count(*) into ws_count_slide from usuarios where usu_nome = ws_usuario and show_only = 'S';
		
		if ws_count_slide > 0 and (to_Char(sysdate,'HH24:MI') in ('00:00','04:00','08:00','12:00','16:00','20:00')) then
			ws_msg_erro := 'Sess&atilde;o recarregada. Limpeza de cache.';
			raise ws_cache_reload;
		end if;

		if ws_count_usu = 0 then 
			ws_msg_erro := 'Sess&atilde;o encerrada, atualize a p&aacute;gina do navegador.' ; 		
			raise ws_sysout;
		elsif nvl(ws_usuario, 'N/A') = 'N/A' then
			ws_msg_erro := 'Sess&atilde;o inexistente.' ; 		
			raise ws_logout;
		elsif not fun.check_user(ws_usuario) then 
			ws_msg_erro := 'Usu&aacute;rio inativo ou inv&aacute;lido.';
			raise ws_logout;
		--elsif not fun.check_netwall(ws_usuario) then 
		--	ws_msg_erro := 'Usu&aacute;rio sem permiss&atilde;o de acesso no dia/hor&aacute;rio.';
		--	raise ws_logout;
		elsif fun.check_sys <> 'OPEN' then
			ws_msg_erro := 'Sistema em manutenç&ccedil;&atilde;o.';    -- Sistema bloqueado 
			raise ws_sysout;
		end if;

		-- Valida tempo de expiração de sessão sem atividade 
		begin
			ws_tempo_exp := fun.ret_var ('TEMPO_EXPIRA_SESSAO', ws_usuario); 
			
			if ws_tempo_exp is null then 
				ws_tempo_exp := fun.ret_var ('TEMPO_EXPIRA_SESSAO','DWU'); 
			end if;

		exception when others then 
			ws_tempo_exp := 0;
		end; 
		
		if nvl(ws_tempo_exp,0) <> 0 then 
			ws_dt_ultima_atividade := null;
			open  c1;
			fetch c1 into ws_rowid, ws_dt_ultima_atividade;
			close c1; 
			if ws_dt_ultima_atividade is null or ((sysdate - ws_dt_ultima_atividade) * 1440) >= ws_tempo_exp then -- Encerra sessão 
				ws_msg_erro := 'Sess&atilde;o expirada.'; 
				raise ws_logout;		
			end if;  
		end if;	

	end if;

	htp.p(99);

exception 
	when ws_sysout then
		htp.p('1');   		-- 1 recarrega o navegador
		insert into bi_log_sistema values(sysdate, ws_msg_erro||' - valida_session', ws_usuario, 'EVENTO');
		commit;
	when ws_logout then
		htp.p('0');   		-- 0 é logout
		insert into bi_log_sistema values(sysdate, ws_msg_erro||' - valida_session', ws_usuario, 'EVENTO');
		commit;
	when ws_cache_reload then
		htp.p('5');   		-- 5 recarrega o navegador
		insert into bi_log_sistema values(sysdate, ws_msg_erro||' - valida_session', ws_usuario, 'EVENTO');
		commit;
	when others then
		htp.p('0');   		-- 0 é logout
		insert into bi_log_sistema values(sysdate, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - valida_session', ws_usuario, 'ERRO');
		commit;		
end valida_session;



procedure gusuarios ( prm_order varchar2 default '1',
					prm_dir   varchar2 default '1' ) as

	cursor crs_grupos is
	select t1.cd_group, t1.nm_group, 
		listagg(t2.cd_usuario, '|')                        within group (order by t1.cd_group, decode(t2.cd_usuario,'DWU','1',t2.cd_usuario)) grupo, 
		listagg(replace(t2.cd_usuario,'DWU','TODOS'), ', ') within group (order by t1.cd_group, decode(t2.cd_usuario,'DWU','1',t2.cd_usuario)) nm_usuarios 
	from gusers t1		   
	left join gusers_itens t2 on t2.cd_group = t1.cd_group
	group by t1.cd_group, t1.nm_group
	order by
		case when prm_dir = '1' then decode(prm_order, '1', t1.cd_group, '2', t1.nm_group, t1.cd_group) end asc,
		case when prm_dir = '2' then decode(prm_order, '1', t1.cd_group, '2', t1.nm_group, t1.cd_group) end desc;

	ws_grupo crs_grupos%rowtype;
	ws_dir      number := 1;
	ws_padrao   varchar2(80) := 'PORTUGUESE';
	ws_usuario  varchar2(80);
	ws_admin    varchar2(20);
	ws_count    integer; 
	ws_noaccess exception;

begin

	ws_usuario := gbl.getUsuario;
	ws_admin   := gbl.getNivel;

	if ws_admin <> 'A' and ws_usuario = 'NOUSER' and fun.user_permissao(ws_usuario, 'TELAS_USUARIOS') = 'S' then
		raise ws_noaccess;
	end if;

	htp.p('<table class="linha">');
	htp.p('<thead>');
		htp.p('<tr>');
			htp.p('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''gusuarios'', ''prm_order=1&prm_dir=''+dir, false, ''content'');">ID</a></th>');
			htp.p('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''gusuarios'', ''prm_order=2&prm_dir=''+dir, false, ''content'');">'||fun.lang('NOME')||'</a></th>');
			htp.p('<th>USU&Aacute;RIOS</th>');
			htp.p('<th style="width: 150px;"></th>');
			htp.p('<th style="width: 12px;"></th>');
		htp.p('</tr>');
	htp.p('</thead>');

	begin
		select CONTEUDO into ws_padrao
		from   PARAMETRO_USUARIO
		where  cd_usuario = ws_usuario and
			cd_padrao='CD_LINGUAGEM';
	exception
		when others then
			ws_padrao := 'PORTUGUESE';
	end;

	if to_number(prm_dir) = 1 then ws_dir := 2; end if;

	htp.p('<tbody id="ajax" data-dir="'||ws_dir||'">');
		open crs_grupos;
			loop
				fetch crs_grupos into ws_grupo;
				exit when crs_grupos%notfound;
				htp.p('<tr id="'||ws_grupo.cd_group||'">');
				    htp.p('<td>'||fun.utranslate('CD_GROUP', 'GUSERS', ws_grupo.cd_group, ws_padrao)||'</td>');
					htp.p('<td>'||fun.utranslate('NM_GROUP', 'GUSERS', ws_grupo.nm_group, ws_padrao)||'</td>');

					htp.p('<td class="fake-list"style="padding-right: 8px; max-width:60px;">');
					    htp.p('<a class="script" onclick="call(''alter_gusuario'', ''prm_group='||ws_grupo.cd_group||'&prm_usuario=''+document.getElementById(''lista-usuarios-'||ws_grupo.cd_group||''').title).then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } });"></a>');
					   	fcl.fakeoption('lista-usuarios-'||ws_grupo.cd_group, fun.lang('Selecione os usu&aacute;rios'), ws_grupo.grupo, 'lista-usuarios-sem-dwu', 'N', 'S', '', prm_desc => replace(ws_grupo.grupo, '|', ', '));
					htp.p('</td>');

					select count(*) into ws_count from all_screens alsc, user_screens ussc
					 where alsc.screen    = ussc.screen 
					   and ussc.usuario   = ws_grupo.cd_group ; 

					htp.p('<td>');
						htp.p('<a class="addpurple grupo_screen" title="Telas liberadas para acesso dos usu&aacute;rios do grupo">'||fun.lang('TELAS LIBERADAS')||' ('||ws_count||')</a>');
					htp.p('</td>');

					htp.p('<td>');
						fcl.button_lixo('delete_gusuario','prm_group|prm_usuario', ws_grupo.cd_group||'|'||'');	
					htp.p('</td>');
				
				htp.p('</tr>');
			end loop;
		close crs_grupos;
	htp.p('</tbody>');

exception
	when ws_noaccess then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end gusuarios;

procedure create_gusuarios( prm_grupo varchar2 default null,
							prm_nome  varchar2 default null ) as

	ws_count 		number;
	ws_fail  		exception;
	ws_grupo 		varchar2(40);
	ws_nome  		varchar2(80);
	ws_msg_erro     varchar2(200); 

begin
	
	ws_grupo := fun.converte(prm_grupo);
	ws_nome  := fun.converte(prm_nome);
	
	select count(*) into ws_count 
	  from gusers
	 where cd_group = upper(trim(ws_grupo));
	if ws_count > 0 then
		ws_msg_erro := 'Grupo j&aacute; existe!'; 
		raise ws_fail;
	end if; 	

	select count(*) into ws_count 
	  from usuarios 
	 where usu_nome = upper(trim(ws_grupo));
	if ws_count > 0 then
		ws_msg_erro := 'Existe um nome de usu&aacute;rio com esse ID de grupo, informe outro ID para o grupo'; 
		raise ws_fail;
	end if; 	


	begin 
		insert into gusers values(upper(trim(ws_grupo)), trim(ws_nome), sysdate);
		commit;
	exception when others then 
		insert into bi_log_sistema (dt_log, ds_log, nm_usuario, nm_procedure ) values(sysdate, 'Erro create_gusuarios(inserindo): '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, gbl.getUsuario, 'ERRO');		
		commit; 
		ws_msg_erro := 'Erro inserindo grupo'; 
		raise ws_fail;
	end; 

	insert into traducao_colunas values('GUSERS', 'CD_GROUP', fun.ret_var('LANG_SYS'), upper(trim(ws_grupo)), upper(trim(ws_grupo)), 'T', 'N');
	insert into traducao_colunas values('GUSERS', 'NM_GROUP', fun.ret_var('LANG_SYS'), trim(ws_nome), trim(ws_nome), 'T', 'N');
	commit;
		
exception
	when ws_fail then
		rollback;
		htp.p('ERRO|'||ws_msg_erro);
	when others then
		rollback;
		ws_msg_erro := 'Erro inserindo grupo, verifique o log de erros do sistema'; 
		htp.p('ERRO|'||ws_msg_erro);
		insert into bi_log_sistema (dt_log, ds_log, nm_usuario, nm_procedure ) values(sysdate, 'Erro create_gusuarios(others): '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, gbl.getUsuario, 'ERRO');		
		commit; 
end create_gusuarios;

PROCEDURE DELETE_GUSUARIO (	PRM_GROUP		VARCHAR2 DEFAULT NULL,
							PRM_USUARIO 	VARCHAR2 DEFAULT NULL) AS
	WS_GRUPO VARCHAR2(40);

BEGIN

	WS_GRUPO := FUN.CONVERTE(PRM_GROUP);
	
	DELETE 
	FROM GUSERS_ITENS 
	WHERE
		TRIM(CD_GROUP) = TRIM(WS_GRUPO);

	DELETE 
	FROM GUSERS 
	WHERE
		TRIM(CD_GROUP) = TRIM(WS_GRUPO);

	COMMIT; 
	

END DELETE_GUSUARIO;

PROCEDURE ALTER_GUSUARIO ( PRM_GROUP   VARCHAR2 DEFAULT NULL,
						PRM_USUARIO VARCHAR2 DEFAULT NULL ) AS

	WS_COUNT NUMBER;
	WS_GRUPO VARCHAR2(40);

BEGIN

	WS_GRUPO := FUN.CONVERTE(PRM_GROUP);
	
	IF NVL(PRM_USUARIO, 'N/A') = 'N/A' THEN
		
		DELETE 
		FROM GUSERS_ITENS 
		WHERE
			TRIM(CD_GROUP) = TRIM(WS_GRUPO);
		
		
		--COMENTADO PARA NÃO REMOVER O GRUPO CASA "DESSELECIONE" OS USUARIOS DO GRUPO E CRIADO UMA PROCEDURE PARA DELETAR (DELETE_GUSUARIO) 14/09/2022
		--DELETE FROM GUSERS WHERE
		--TRIM(CD_GROUP) = TRIM(WS_GRUPO);
		--COMMIT; 
		
	ELSE
		
		DELETE 
		FROM GUSERS_ITENS 
		WHERE
			TRIM(CD_GROUP) = TRIM(WS_GRUPO);
		
		FOR I IN(SELECT COLUMN_VALUE FROM TABLE((FUN.VPIPE(PRM_USUARIO)))) 
		LOOP

			INSERT INTO GUSERS_ITENS VALUES (WS_GRUPO, I.COLUMN_VALUE);

		END LOOP;

		COMMIT;
		
	END IF;
	
EXCEPTION 
	WHEN OTHERS THEN

		HTP.P('FAIL');
		ROLLBACK;

END ALTER_GUSUARIO;

procedure alter_agrupadores (  	prm_objeto      	varchar2 default null,
								prm_agrupadores 	varchar2 default null,
								prm_tipo        	varchar2 default null,
								prm_screen      	varchar2 default 'DEFAULT' ) as

	ws_count        number;
	ws_usuario      varchar2(200);
	ws_tp_objeto    varchar2(200); 
	ws_raise_erro   exception; 

begin

	ws_usuario := gbl.getUsuario;

	if prm_tipo = 'AGRUPADORES' then
		select count(*) into ws_count from object_attrib where cd_prop = 'AGRUPADORES' and cd_object = prm_objeto;

		if ws_count = 1 then
			update object_attrib set propriedade = prm_agrupadores where cd_object = prm_objeto and cd_prop = 'AGRUPADORES';
		elsif ws_count = 0 then
			insert into object_attrib values ('DWU', 'DEFAULT', 'DEFAULT', prm_objeto, 'AGRUPADORES', prm_agrupadores);
		else
			htp.p('#alerta Valores duplicados!');
		end if;
	elsif prm_tipo = 'VISIVEL' then

		select max(tp_objeto) into ws_tp_objeto from objetos where cd_objeto = prm_objeto; 

			if ws_tp_objeto in ('COLUNAS','BARRAS','LINHAS','SANKEY', 'SCATTER', 'RADAR' ) then 

				if nvl(prm_agrupadores,'N/A') <> 'N/A' then
					begin 
						update object_attrib set propriedade = prm_agrupadores 
						where cd_object = prm_objeto 
						and cd_prop   = 'VISIVEL'
						and owner     = ws_usuario
						and screen    = prm_screen ;

						if sql%notfound then 
							insert into object_attrib (owner, navegador, screen, cd_object, cd_prop, propriedade) values (ws_usuario, 'DEFAULT', prm_screen, prm_objeto, 'VISIVEL', prm_agrupadores);
						end if; 
					exception when others then 
						htp.p('ERRO|N&atilde;o foi poss&iacute;vel alterar o atributo do objeto');
					end;

				else
					delete object_attrib 
					 where cd_object = prm_objeto 
					   and cd_prop   = 'VISIVEL'
					   and owner     = ws_usuario
					   and screen    = prm_screen ;
				end if;

				htp.p('OK|Atributo alterado com sucesso');

			else 
				select count(*) into ws_count from object_attrib where cd_prop = 'VISIVEL' and cd_object = prm_objeto;

				if ws_count = 1 then
					update object_attrib set propriedade = prm_agrupadores where cd_object = prm_objeto and cd_prop = 'VISIVEL';
				elsif ws_count = 0 then
					insert into object_attrib values ('DWU', 'DEFAULT', 'DEFAULT', prm_objeto, 'VISIVEL', prm_agrupadores);
				else
					htp.p('#alerta Valores duplicados!');
				end if;

			end if;	
 	
	else
		select count(*) into ws_count from object_attrib where cd_prop = 'LIMITADORES' and cd_object = prm_objeto;

		if ws_count = 1 then
			update object_attrib set propriedade = prm_agrupadores where cd_object = prm_objeto and cd_prop = 'LIMITADORES';
		elsif ws_count = 0 then
			insert into object_attrib values ('DWU', 'DEFAULT', 'DEFAULT', prm_objeto, 'LIMITADORES', prm_agrupadores);
		else
			htp.p('#alerta Valores duplicados!');
		end if;
	end if;
exception 
	when ws_raise_erro then 
		null;
end alter_agrupadores;

procedure text_post ( prm_objeto varchar2 default null,
					prm_line   varchar2 default null,
					prm_group  varchar2 default null ) as

	ws_count   number;
	ws_usuario varchar2(80);

	ws_nouser  exception;
begin

	ws_usuario := gbl.getUsuario;

	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if;

	update check_post set dt_check = sysdate where cd_usuario = ws_usuario and nm_remetente = prm_group;
	commit;

		for i in (Select To_Char(Ret_Data,'DD/MM/YY HH24:MI') As Dt_Mensagem, Ret_From As From_User, Ret_To As To_User, (RET_MENSAGEM) AS TEXTO, RET_IDENT AS IDENT from table(decode(prm_objeto, null, fun.list_all_post, fun.list_post(prm_objeto, prm_line, prm_group))) where Ret_From <> 'SYS'
		and 
			(Ret_To = prm_group and Ret_From = ws_usuario) or (Ret_From = prm_group and Ret_To = ws_usuario) or (trim(prm_group) in (select trim(cd_group) from gusers_itens where cd_usuario = ws_usuario) and Ret_To = trim(prm_group))
		) loop
			

				if trim(i.From_User) = ws_usuario then
					htp.p('<li class="user">');
					if instr(i.TEXTO, 'jpg') <> 0 or instr(i.TEXTO, 'png') <> 0 then
						htp.p('<img class="texto" src="'||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download?arquivo='||i.TEXTO||'" onclick="this.classList.toggle(''ex'');"/>');
					else
						htp.p('<span class="texto">'||i.TEXTO||'</span>');
					end if;
					htp.p('<span>'||ws_usuario||' '||i.Dt_Mensagem||'</span>');
					
				else
					htp.p('<li class="other-user">');
					if instr(i.TEXTO, 'jpg') <> 0 or instr(i.TEXTO, 'png') <> 0 then
						htp.p('<img class="texto" src="'||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download?arquivo='||i.TEXTO||'" onclick="this.classList.toggle(''ex'');"/>');
					else
						htp.p('<span class="texto">'||i.TEXTO||'</span>');
					end if;
					htp.p('<span>'||trim(i.From_User)||' '||i.Dt_Mensagem||'</span>');
					
				end if;

					fcl.button_lixo('remove_post','prm_id', i.IDENT);	
				htp.p('</li>');

		end loop;
exception 
	when ws_nouser then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p('');
end text_post;

procedure insert_post ( prm_objeto  varchar2 default null,
						prm_screen  varchar2 default null,
						prm_visao   varchar2 default null,
						prm_usuario varchar2 default null,
						prm_msg     varchar2 default null,
						prm_time    number default 30,
						prm_line    varchar2 default null,
						prm_email   char default 'N',
						prm_sms     char default 'N',
						prm_filtro  varchar2 default null,
						prm_show    varchar2 default 'Y',
						prm_origem  varchar2 default '$[NO_NAME]') as

	ws_filtro  varchar2(200);
	ws_count   number;
	ws_origem  varchar2(80);
	ws_email   varchar2(80);
	ws_erro_envio varchar2(200); 

begin

	for i in( select rtrim(cd_coluna)||'|'||decode(rtrim(condicao),'IGUAL','$[IGUAL]','DIFERENTE','$[DIFERENTE]','MAIOR','$[MAIOR]','MENOR','$[MENOR]','MAIOROUIGUAL','$[MAIOROUIGUAL]','MENOROUIGUAL','$[MENOROUIGUAL]','LIKE','$[LIKE]','NOTLIKE','$[NOTLIKE]','$[IGUAL]')||rtrim(conteudo) as filtro from filtros where ((cd_objeto = prm_objeto) or (cd_objeto = prm_screen and micro_visao = prm_visao)) and tp_filtro = 'objeto' ) loop
		ws_filtro := ws_filtro||'|'||i.filtro;
	end loop;

	ws_filtro := ws_filtro||'|'||trim(prm_filtro);

	if  prm_origem = '$[NO_NAME]' then
		ws_origem := gbl.getUsuario;
	else
		ws_origem := prm_origem;
	end if;

	SELECT COUNT_POST.nextval INTO ws_count FROM dual;
	insert into text_post (OBJECT_ID, CD_USUARIO, CD_GROUP, DT_POST, TYPE_TEXT, TIME_LIVE, SELECT_LINE, BY_MAIL, BY_SMS, POST_ID, FILTRO) 
	values (prm_objeto, ws_origem, prm_usuario, sysdate, (fun.converte(replace(prm_msg, '(percent)', '%'))), nvl(prm_time, 1), prm_line, prm_email, prm_sms, ws_count, ws_filtro);
	for i in(select column_value as usuario from table(fun.vpipe(prm_usuario))) loop
		insert into check_post (ID_POST, CD_USUARIO, NM_REMETENTE) values(ws_count, i.usuario, ws_origem);
	end loop;
	commit;

	/******* Desabilitado - opção de envio de email retirado da tela 
	if prm_email = 'S' then
		if prm_usuario = 'todos' then
			for i in (select usu_email from usuarios where usu_nome <> ws_origem) loop
				Xsend_Mail('', i.usu_email,'TEXT-POST', fun.converte(prm_msg),ws_erro_envio);
			end loop;
		else
			select count(*) into ws_count from usuarios where upper(trim(usu_nome)) = upper(trim(prm_usuario));
			if ws_count = 0 then
				for j in (select cd_usuario from gusers_itens where upper(trim(cd_group)) = upper(trim(prm_usuario))) loop
					select usu_email into ws_email from usuarios where upper(trim(usu_nome)) = upper(trim(j.cd_usuario));
					Xsend_Mail('', ws_email,'TEXT-POST', fun.converte(prm_msg),ws_erro_envio);
				end loop;
			else
				select usu_email into ws_email from usuarios where upper(trim(usu_nome)) = upper(trim(prm_usuario));
				Xsend_Mail('', ws_email,'TEXT-POST', fun.converte(prm_msg),ws_erro_envio);
			end if;
		end if;
	end if;
	************/ 

exception when others then
	htp.p('FAIL');
end insert_post;

procedure remove_post ( prm_id number default null ) as

ws_count number;

begin
	/*fcl.refresh_Session;*/
	select count(*) into ws_count from text_post where post_id = prm_id;
	if ws_count = 1 then
		delete from text_post where post_id = prm_id;
	else
		htp.p('!alert '||fun.lang('Imposs&iacute;vel excluir mensagem')||'!');
	end if;
end remove_post;

procedure js_log ( prm_msg varchar2 default null,
				prm_url varchar2 default null,
				prm_line varchar2 default null,
				prm_tipo varchar2 default 'ERRO' ) as

begin
	/*fcl.refresh_Session;*/
	if prm_tipo = 'ERRO' then
		if instr(prm_msg, 'chartobject') = 0 then
			if instr(prm_msg, 'TypeError:') = 0 then
				if instr(prm_msg, 'InvalidStateError') = 0 then
					if instr(prm_msg, 'INVALID_STATE_ERR: DOM Exception 11: An attempt was made to use an object that is not') = 0 then
						insert into log_eventos values(sysdate, 'ERRO: '||prm_msg||' BROWSER: '||owa_util.get_cgi_env('HTTP_USER_AGENT'), user, 'JS', prm_tipo, '01');
					end if;
				end if;
			end if;
		end if;
	else
		insert into log_eventos values(sysdate, prm_msg, user, 'JS', prm_tipo, '01');
	end if;
end js_log;

procedure lista_objetos as

begin

	htp.p('<div class="itens">');
			
		htp.p('<h2>'||fun.lang('LISTA DE OBJETOS')||'</h2>');

		htp.p('<select style="max-width: calc(100% - 4px); width: calc(100% - 4px); margin: 2px;" id="obj_serch_tp" onchange="list_obj();">');
					htp.p('<option value="N/A" selected disabled hidden>'||fun.lang('BUSCA POR TIPO')||'</option>');
					htp.p('<option value="N/A">'||fun.lang('TODOS')||'</option>');
					htp.p('<optgroup label="'||fun.lang('TIPOS')||'"/>');
					for i in (select tp_objeto as tipo, decode(tp_objeto, 'CALL_LIST', 'MENU', 'IMAGE', 'IMAGEM', 'SCREEN', 'TELA', 'HEATMAP', 'MAPA DE CALOR','TEXTO','TEXTO', 'MAPAGEOLOC', 'GEOLOCALIZA&Ccedil;&Atilde;O', tp_objeto) as descricao 
								from (select distinct(tp_objeto) from objetos) where tp_objeto <> 'SCRIPT' and tp_objeto <> 'SCREEN' and tp_objeto <> 'OBJETO' order by descricao asc) loop
						htp.p('<option value="'||i.tipo||'">'||fun.lang(i.descricao)||'</option>');
					end loop;
				htp.p('</select>');

				htp.p('<select style="max-width: calc(100% - 4px); width: calc(100% - 4px); margin: 2px;" id="obj_serch_vw" onchange="list_obj();">');
					htp.p('<option value="N/A" selected disabled hidden>'||fun.lang('BUSCAR PELA VIEW')||'</option>');
					htp.p('<option value="N/A">'||fun.lang('TODOS')||'</option>');
					htp.p('<optgroup label="VIEW"/>');
					for visao in (select nm_micro_visao from micro_visao order by nm_micro_visao asc) loop
						htp.p('<option value="'||visao.nm_micro_visao||'">'||visao.nm_micro_visao||'</option>');
					end loop;
				htp.p('</select>');

				htp.p('<select style="max-width: calc(100% - 4px); width: calc(100% - 4px); margin: 2px;" id="obj_serch_gp" onchange="list_obj();">');
					htp.p('<option value="N/A" selected disabled hidden>'||fun.lang('BUSCAR PELA CATEGORIA')||'</option>');
					htp.p('<option value="N/A">'||fun.lang('TODOS')||'</option>');
					htp.p('<optgroup label="'||fun.lang('GRUPOS')||'"/>');
					for grupo in (select cd_grupo from grupos_funcao order by cd_grupo asc) loop
						htp.p('<option value="'||grupo.cd_grupo||'">'||grupo.cd_grupo||'</option>');
					end loop;
				htp.p('</select>');

				htp.p('<input style="max-width: calc(100% - 10px); width: calc(100% - 10px); margin: 2px;" type="text" value="" id="obj_serch_in" placeholder="'||fun.lang('BUSCAR PELA DESCRI&Ccedil;&Atilde;O')||'" onkeyup="list_obj();" />');


		htp.p('<a class="addpurple" style="margin: 4px; width: calc(50% - 36px);" onclick="ajax(''quick'',''quick_create'',''prm_nome=TEXTO&prm_tipo=TEXTO&prm_parametros=&prm_visao=&prm_coluna=&prm_grupo=GERAL&prm_obj_ant=&prm_filtro='', false); noerror('''', TR_CR, ''feed-fixo'');" title="'||fun.lang('Novo texto')||'">'||fun.lang('TEXTO')||'</a>');
		htp.p('<a class="addpurple" style="margin: 4px; width: calc(50% - 36px);" onclick="dashboard(document.getElementById(''current_screen'').value, ''newsection'');" id="section" title="'||fun.lang('Novo dashboard')||'">'||fun.lang('DASHBOARD')||'</a>');


		htp.p('<ul id="ajax_obj"></ul>');

	htp.p('</div>');

	fcl.closer_menu;

exception when others then 
	insert into bi_log_sistema values(sysdate, 'Erro lista_objetos: '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, gbl.getUsuario, 'ERRO');
	commit; 
end lista_objetos;

procedure list_obj  ( prm_tipo 		varchar2 default 'N/A',
					prm_view 		varchar2 default 'N/A',
					prm_grupo 	varchar2 default 'N/A',
					prm_desc 		varchar2 default 'N/A' ) as

	ws_sql      varchar2(2000);
	ws_linhas    integer;
	ws_cursor   integer;
	ws_desc     varchar2(80);
	ws_visao    varchar2(80);
	ws_id       varchar2(80);
	ws_tipo     varchar2(80);
	ws_cod      varchar2(80);

begin

	--ws_sql := 'select cd_objeto, cod, nm_objeto, visao, tp_objeto, cd_grupo from (select cd_objeto, cod, nm_objeto, tp_objeto, cd_grupo, (select cd_micro_visao from ponto_avaliacao t2 where cd_ponto = t1.cd_objeto) as visao '||
	--          'from objetos t1 where cd_objeto not like (''%_temp'')) '||
	--		  'where tp_objeto <> ''TEXTO'' and tp_objeto <> ''SCREEN'' '||
	--		  '  and ( ( nvl(t1.id_customizada = ''N'') = ''N'') or ( nvl(t1.id_customizada = ''N'') = ''S'' and nvl(t1.id_liberado,''N'') = ''S'' ) )    ';

	WS_SQL := 'select cd_objeto, cod, nm_objeto, visao, tp_objeto, cd_grupo '||
			' from (select cd_objeto, cod, nm_objeto, tp_objeto, cd_grupo, (select cd_micro_visao from ponto_avaliacao t2 where cd_ponto = t1.cd_objeto) as visao '||
			'         from objetos t1 '||
			'        where cd_objeto not like (''%_temp'') '||
			'          and ( ( nvl(t1.id_customizado,''N'') = ''N'') or ( nvl(t1.id_customizado, ''N'') = ''S'' and nvl(t1.id_liberado,''N'') = ''S'' ) ) '||
			'      ) '||
			' where  tp_objeto <> ''SCREEN'' ';
			-- removido tp_objeto <>''TEXTO'' para poder listar o mesmo

	if prm_tipo <> 'N/A' then
		if prm_tipo <> 'OUTROS' then
			ws_sql := ws_sql||' and tp_objeto = '''||prm_tipo||''' ';
		end if;
	end if;

	if prm_view <> 'N/A' then
		ws_sql := ws_sql||' and visao = '''||prm_view||''' ';
	end if;

	if prm_grupo <> 'N/A' then
		ws_sql := ws_sql||' and cd_grupo = '''||prm_grupo||''' ';
	end if;

	if prm_desc <> 'N/A' then
		ws_sql := ws_sql||' and (upper(nm_objeto) like ''%'||upper(prm_desc)||'%'' or upper(cd_objeto) like ''%'||upper(prm_desc)||'%'') ';
	end if;

	ws_sql := ws_sql||' order by nm_objeto asc, visao asc ';

	if prm_tipo <> 'OUTROS' then

		ws_cursor := dbms_sql.open_cursor;

			dbms_sql.parse(ws_cursor, ws_sql, DBMS_SQL.NATIVE);
			dbms_sql.define_column(ws_cursor, 1, ws_id, 80);
			dbms_sql.define_column(ws_cursor, 2, ws_cod, 80);
			dbms_sql.define_column(ws_cursor, 3, ws_desc, 80);
			dbms_sql.define_column(ws_cursor, 4, ws_visao, 80);
			dbms_sql.define_column(ws_cursor, 5, ws_tipo, 80);

			ws_linhas := dbms_sql.execute(ws_cursor);

			loop
				ws_linhas := dbms_sql.fetch_rows(ws_cursor);
				if  ws_linhas <> 1 then
					exit;
				end if;

				dbms_sql.column_value(ws_cursor, 1, ws_id);
				dbms_sql.column_value(ws_cursor, 2, ws_cod);
				dbms_sql.column_value(ws_cursor, 3, ws_desc);
				dbms_sql.column_value(ws_cursor, 4, ws_visao);
				dbms_sql.column_value(ws_cursor, 5, ws_tipo);

				htp.p('<li onclick="fastInclude('''||ws_id||''', '''||ws_tipo||''')" title="'||fun.lang('Objeto do tipo: '||ws_tipo||'')||'">');
					htp.p('<span>'||ws_desc||'</span>');
					htp.p('<span>'||nvl(ws_cod, ws_id)||'</span>');
					if nvl(ws_visao, 'N/A') <> 'N/A' then
						htp.p('<span>'||ws_visao||'</span>');
					end if;
				htp.p('</li>');
			end loop;
		dbms_sql.close_cursor(ws_cursor);
	end if;
exception when others then 
	insert into bi_log_sistema (dt_log, ds_log, nm_usuario, nm_procedure) values(sysdate, 'Erro list_obj: '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, gbl.getUsuario, 'ERRO');
	commit; 
	htp.p('Erro listando objetos.');
end list_obj;


--!!
procedure fakelist ( prm_ident  varchar2 default null,
					prm_titulo varchar2 default null,
					prm_campo  varchar2 default null,
					prm_visao  varchar2 default null,
					prm_ref    varchar2 default null ) as

	ws_loop1      varchar2(200);
	ws_loop2      varchar2(200);
	ws_loop3      varchar2(200);
	ws_tipo       varchar2(200);
	ws_texto      varchar2(200);
	ws_count      number;
	ws_counter    number;
	ws_fixa       char(1);
	ws_cursor	  integer;
	ws_sql		  varchar2(2000);
	ws_codigo     varchar2(2000);
	ws_descricao  varchar2(2000);
	ws_linhas     integer;
	ws_cor        varchar2(400);
	prm_codigo    varchar2(200);
	prm_descricao varchar2(200);
	prm_tabela    varchar2(200);
	ws_tabela     varchar2(200);
	ws_titulo     varchar2(800);
	ws_visao      varchar2(800);
	ws_usuario    varchar2(80);
	ws_padrao	  varchar2(80) := 'PORTUGUESE';
	ws_nouser     exception;

	ws_cd_micro_visao varchar2(100);
	ws_tipo_obj   	  varchar2(40);
	ws_cd_tipo        varchar2(40);
	ws_sufixo         varchar2(40);
	ws_script         varchar2(40);
	ws_colunas        varchar2(500);	
	ws_prop           varchar2(2000);
	ws_lista          varchar2(2000);
	ws_lista_n        varchar2(2000);
	ws_colunas_obj    varchar2(2000);       
	ws_tp_obj         varchar2(100); 
	ws_screen         varchar2(100); 
	ws_class          varchar2(20); 
	ws_label          varchar2(200);
	ws_colunas_tpt    varchar2(10000);
	ws_ordem		  varchar2(5);

	begin

		ws_usuario := gbl.getUsuario;

		if ws_usuario = 'NOUSER' then
			raise ws_nouser;
		end if;
		
		ws_titulo  := fun.converte(prm_titulo);
		ws_visao   := fun.converte(prm_visao);

		/* mudar padding para 50px a direita para teste de fakeScroll */
		/* htp.p('<div id="teste">'); */

		if trim(prm_campo) = 'lang' then

			htp.p('<div class="itens" data-save="false" style="width: 346px;">');
			htp.p('<h2 class="fixed">'||fun.lang('LINGUAGEM')||'</h2>');
			htp.p('<ul class="'||trim(prm_campo)||' form">');

		else
	
			--htp.p('<ul class="'||trim(prm_campo)||'">');
			htp.p('<ul class="'||trim(prm_campo)||'" data-ref="'||trim(prm_ref)||'" >');		

		end if;

		if trim(prm_campo) = 'point' then

			htp.p('<li>'||ws_titulo||'</li>');
			htp.p('<li onclick="fakeValue('''||prm_ident||''', this);" title=".">'||fun.lang('ponto')||'</li>');
			htp.p('<li onclick="fakeValue('''||prm_ident||''', this);" title=",">'||fun.lang('virgula')||'</li>');
			htp.p('<li onclick="fakeValue('''||prm_ident||''', this);" title="-">'||fun.lang('h&iacute;fen')||'</li>');
			htp.p('<li onclick="fakeValue('''||prm_ident||''', this);" title=":">'||fun.lang('dois pontos')||'</li>');

		elsif trim(prm_campo) = 'consulta_dimensoes' then

			begin
				select CONTEUDO into ws_padrao
				from   PARAMETRO_USUARIO
				where  cd_usuario = ws_usuario and
					cd_padrao='CD_LINGUAGEM';
			exception
				when others then
					ws_padrao := 'PORTUGUESE';
			end;
			
			htp.p('<ul id="coluna" data-tipo="coluna" class="dimensao" data-type="lista" style="float: left; background: #BBB; border: 1px solid #000; border-radius: 5px; padding: 3px; min-height: 38px; min-width: 116px;">');
				for i in(select nvl(COLUMN_VALUE, 'n/a') as item from table(fun.vpipe((select cs_coluna from ponto_avaliacao where cd_ponto = prm_ident))) where COLUMN_VALUE <> 'n/a') loop
					htp.p('<li onclick="swapColumn(this);" data-type="dimensao" class="linha" title="'||i.item||'" >'||fun.utranslate('NM_ROTULO', upper(trim(ws_visao)), fun.NOME_COL(i.item, prm_visao), ws_padrao)||'<span>X</span></li>');
					htp.p('<li onclick="swapSquare(this);" class="square"></li>');
				end loop;
			htp.p('</ul>');
		elsif trim(prm_campo) = 'dashboards' then

			htp.p('<li style="font-size: 18px;">TELAS COM DASHBOARD</li>');
			for i in(select distinct screen from object_location t1 where screen like ('SECTION_%') and screen not in (select object_id from object_location where screen = prm_visao)) loop
				/* select (select nm_objeto from objetos t3 where t3.cd_objeto = t2.screen) from object_location t2 where t2.object_id = t1.screen;*/
				select screen into ws_codigo from object_location where object_id = i.screen and rownum = 1;
				select nm_objeto into ws_descricao from objetos where cd_objeto = ws_codigo and rownum = 1;
				htp.p('<li onclick="ajax(''fly'', ''dashboardcopy'', ''prm_dashboard=''+this.getAttribute(''data-screen'')+''&prm_actual='||prm_ident||''', false); shscr(tela);" data-screen="'||i.screen||'" title="'||fun.lang('Copiar dashboard desta tela')||'">'||ws_descricao||'</li>');
			end loop;

		elsif trim(prm_campo) = 'valoresbrowser' then

			htp.p('<li>'||fun.lang('LISTA')||'</li>');
			select nds_cd_codigo, nds_tfisica, nds_cd_descricao, nr_ordem_select into ws_loop1, ws_loop2, ws_loop3, ws_ordem 
			from CODIGO_DESCRICAO where nds_tabela = upper(ws_visao) and rownum = 1;
			-- htp.p('<li style="white-space: nowrap;"><input id="filter-value" placeholder="'||fun.lang('no m&iacute;nimo 3 caracteres para buscar')||'" type="text" style="width: 236px; max-width: 236px;" onkeyup="if(this.value.trim().length > 2 || this.value.trim().length == 0){ ajax(''list'', ''fakedatalist'', ''prm_codigo='||ws_loop1||'&prm_descricao='||ws_loop3||'&prm_tabela='||ws_loop2||'&prm_rownum=50&prm_text=''+this.value.trim()+''&prm_browser='||prm_ident||''', true, ''fake_ajax'');}" /></li>');
			   htp.p('<li style="white-space: nowrap;"><input id="filter-value" type="text" style="width: 236px; max-width: 236px;" onkeyup="if(this.value.trim().length >= 1 || this.value.trim().length == 0){ ajax(''list'', ''fakedatalist'', ''prm_codigo='||ws_loop1||'&prm_descricao='||ws_loop3||'&prm_tabela='||ws_loop2||'&prm_rownum=50&prm_text=''+this.value.trim()+''&prm_browser='||prm_ident||'&prm_ref='||prm_ref||'&prm_ordem='||ws_ordem||''', true, ''fake_ajax'');}" /></li>');
			if substr(prm_ref, 1, 4) <> 'bECO' then -- coluna editável e obrigatória no browser
				htp.p('<li title="" onclick="document.getElementById('''||prm_ident||''').parentNode.setAttribute(''data-v'', ''''); '||
											'document.getElementById('''||prm_ident||''').innerHTML = ''''; '||
											'document.getElementById(''fakelist'').classList.toggle(''visible'');'||
											'if (this.parentNode.getAttribute(''data-ref'').indexOf(''bEC'') != -1) {document.getElementById('''||prm_ident||''').onblur(); }'||
											'" >LIMPAR CAMPO</li>');																			
			end if;
			htp.p('<ul id="fake_ajax">');
				fcl.fakedatalist(ws_loop1, ws_loop3, ws_loop2, 50, '', prm_ident, prm_ref, ws_ordem);
			htp.p('</ul>');

		elsif trim(prm_campo) = 'favoritos' then

			htp.p('<li>'||ws_titulo||'</li>');
			htp.p('<li class="nohover" style="height: 18px; margin-top: -22px;"><a class="fav closed" style="opacity: 1; right: 40px;" onclick="document.getElementById(''fakelist'').classList.remove(''visible''); call_save(''''); curtain(''enabled''); document.getElementById(''titulo'').innerHTML = '''||prm_titulo||'''; call(''favoritar'', ''prm_objeto=&prm_nome=&prm_parametros=&prm_screen=''+tela+''&prm_acao=list'').then(function(resposta){document.getElementById(''content'').innerHTML = resposta; });"></a></li>');
			for i in (select cd_favorito, ds_nome, parametros, screen, cd_objeto from favoritos where usuario = ws_usuario and screen = prm_ident) loop
				htp.p('<li class="fav" title="'||i.parametros||'" onclick="document.getElementById(''fakelist'').classList.remove(''visible''); remover('''||i.cd_objeto||'trl''); appendar('''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.obj.show_objeto?prm_drill=Y&prm_objeto='||i.cd_objeto||'&prm_zindex=&prm_posx=''+cursorx+''px&prm_posy=''+cursory+''px&prm_screen='||i.screen||'&prm_parametros='||i.parametros||''', '''', false); setTimeout(function(){ centerDrill('''||i.cd_objeto||'''); }, 200);">');
					htp.p('<a class="button">'||i.ds_nome||'</a>');
				htp.p('</li>');
			end loop;
			
		elsif trim(prm_campo) = 'condicao' then

			htp.p('<li>'||ws_titulo||'</li>');
			htp.p('<li onclick="fakeValue('''||prm_ident||''', this);" title="IGUAL">'||fun.lang('igual')||'</li>');
			htp.p('<li onclick="fakeValue('''||prm_ident||''', this);" title="DIFERENTE">'||fun.lang('diferente')||'</li>');
			htp.p('<li onclick="fakeValue('''||prm_ident||''', this);" title="MAIOR">'||fun.lang('maior')||'</li>');
			htp.p('<li onclick="fakeValue('''||prm_ident||''', this);" title="MENOR">'||fun.lang('menor')||'</li>');
			htp.p('<li onclick="fakeValue('''||prm_ident||''', this);" title="MAIOROUIGUAL">'||fun.lang('maior ou igual')||'</li>');
			htp.p('<li onclick="fakeValue('''||prm_ident||''', this);" title="MENOROUIGUAL">'||fun.lang('menor ou igual')||'</li>');

		elsif trim(prm_campo) = 'cdesc' then

			htp.p('<li>'||ws_titulo||'</li>');
			htp.p('<li onclick="if('''||prm_ident||''' != ''fake_cdesc''){ var ident = '''||replace(prm_ident, 'fake_cdesc_', '')||'''; document.getElementById(''fake_tipo_''+ident).setAttribute(''title'', ''LIGACAO''); document.getElementById(''fake_tipo_''+ident).innerHTML=''LIGACAO''; call(''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=ligacao&prm_valor=SEM''); ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=tipo&prm_valor=LIGACAO''); noerror('''', ''Campo alterado com sucesso!'', ''msg''); } fakeValue('''||prm_ident||''', this); document.getElementById(''fake_tipo'').setAttribute(''title'', ''LIGACAO''); document.getElementById(''fake_tipo'').innerHTML=''LIGACAO''; if(document.getElementById(''ident'') && '''||prm_ident||''' == ''fake_tipo''){ document.getElementById(''ident'').value = ''SEM''; } if(document.getElementById(ident+''_floatfilter'')){ document.getElementById(ident+''_floatfilter'').className = ''invisible''; }" title="SEM">SEM</li>');
			for i in (select nds_tabela, nds_cd_codigo, nds_cd_descricao from codigo_descricao order by nds_tabela asc ) loop
				htp.p('<li onclick="if('''||prm_ident||''' != ''fake_cdesc''){ var ident = '''||replace(prm_ident, 'fake_cdesc_', '')||'''; document.getElementById(''fake_tipo_''+ident).setAttribute(''title'', ''LIGACAO''); document.getElementById(''fake_tipo_''+ident).innerHTML=''LIGACAO''; call(''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=ligacao&prm_valor='||i.nds_tabela||'''); ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=tipo&prm_valor=LIGACAO''); noerror('''', ''Campo alterado com sucesso!'', ''msg''); } fakeValue('''||prm_ident||''', this); document.getElementById(''fake_tipo'').setAttribute(''title'', ''LIGACAO''); document.getElementById(''fake_tipo'').innerHTML=''LIGACAO''; if(document.getElementById(''ident'') && '''||prm_ident||''' != ''fake_tipo''){ document.getElementById(''ident'').value = '''||i.nds_cd_codigo||'''; } if(document.getElementById(ident+''_floatfilter'')){ if('''||i.nds_cd_codigo||''' == ''SEM''){ document.getElementById(ident+''_floatfilter'').className = ''invisible''; } else { document.getElementById(ident+''_floatfilter'').className = ''link''; } }" title="'||i.nds_tabela||'">'||i.nds_tabela||'</li>');
			end loop;

		elsif trim(prm_campo) = 'cdesc2' then

			htp.p('<li>Liga&ccedil;&atilde;o</li>');
			htp.p('<li onclick="var ident = '''||replace(prm_ident, 'fake2_cdesc_value_', '')||'''; ajax(''fly'', ''save_column'', ''prm_visao='||prm_titulo||'&prm_name=''+ident+''&prm_campo=CD_LIGACAO&prm_valor=SEM''); fakeValue('''||prm_ident||''', this); document.getElementById(ident).parentNode.parentNode.lastElementChild.children[0].click();" title="SEM">SEM</li>');
			for i in (select nds_tabela from codigo_descricao order by nds_tabela asc ) loop
				htp.p('<li onclick="var ident = '''||replace(prm_ident, 'fake2_cdesc_value_', '')||'''; ajax(''fly'', ''save_column'', ''prm_visao='||prm_titulo||'&prm_name=''+ident+''&prm_campo=CD_LIGACAO&prm_valor='||i.nds_tabela||'''); fakeValue('''||prm_ident||''', this); document.getElementById(ident).parentNode.parentNode.lastElementChild.children[0].click();" title="'||i.nds_tabela||'">'||i.nds_tabela||'</li>');
			end loop;

		elsif trim(prm_campo) = 'section' then

			htp.p('<h2 class="fixed">'||ws_titulo||'</h2>');
			htp.p('<ul class="form">');
			htp.p('<li data-hint="Formato"><select onchange="dashboard(document.getElementById(''current_screen'').value, ''rowcolumn'', '''||prm_ident||''',  this.value);">');
				htp.p('<option value="row" selected="">'||fun.lang('Horizontal')||'</option>');
				htp.p('<option value="column">'||fun.lang('Vertical')||'</option>');
			htp.p('</select></li>');
			htp.p('<a class="add" title="adicionar bloco" onclick="dashboard('''', ''insert'', '''||prm_ident||''');">+</a>');
			/* htp.p('<a class="fechardash" id="'||prm_ident||'fechar" title="'||fun.lang('EXCLUIR')||'" onclick="if(confirm(''Excluir objeto e todos os elementos dentro?'')){ remover('''||prm_ident||''', ''excluir''); }">'||fun.lang('EXCLUIR')||'</a>'); */
			htp.p(fun.excluir_dash(prm_ident));

		elsif trim(prm_campo) = 'article' then

			htp.p('<li>'||ws_titulo||'</li>');
			
		elsif trim(prm_campo) = 'visao' then
			
			begin
				select CONTEUDO into ws_padrao
				from   PARAMETRO_USUARIO
				where  cd_usuario = ws_usuario and
					cd_padrao='CD_LINGUAGEM';
			exception
				when others then
					ws_padrao := 'PORTUGUESE';
			end;
			
			htp.p('<li>'||ws_titulo||'</li>');
			for i in (select nm_micro_visao from micro_visao order by nm_micro_visao asc ) loop
				htp.p('<li onclick="fakeValue('''||prm_ident||''', this);" title="'||i.nm_micro_visao||'">'||fun.utranslate('NM_MICRO_VISAO', 'MICRO_VISAO', i.nm_micro_visao, ws_padrao)||'</li>');
			end loop;
		elsif trim(prm_campo) = 'coluna' then
			htp.p('<li>'||ws_titulo||'</li>');
			for i in (select cd_coluna,nm_rotulo from micro_coluna where cd_micro_visao = prm_visao order by nm_rotulo asc ) loop
				htp.p('<li onclick="fakeValue('''||prm_ident||''', this);" title="'||i.cd_coluna||'">'||i.nm_rotulo||'</li>');
			end loop;
		elsif trim(prm_campo) = 'template' then
			htp.p('<li>'||fun.lang('Op&ccedil;&otilde;es do template')||'</li>');

			select count(*) into ws_count from object_attrib where cd_prop = 'TPT' and owner = ws_usuario and cd_object = prm_ident;

			if ws_count = 0 then
				for i in (select column_value as valor, fun.NOME_COL(column_value, ws_visao, prm_visao) as nome from table(fun.vpipe((select formula from micro_coluna where cd_micro_visao = ws_visao and cd_coluna = prm_ident)))) loop
					htp.p('<li class="green" onclick="templateMarcado(this, '''||prm_ident||''', '''||ws_visao||''');" title="'||i.valor||'">'||i.valor||' - '||i.nome||'</li>');
				end loop;
			else
				for i in (select column_value as valor, fun.NOME_COL(column_value, ws_visao, prm_visao) as nome, decode((select column_value from table(fun.vpipe((select propriedade from object_attrib where cd_prop = 'TPT' and owner = ws_usuario and cd_object = prm_ident and screen = prm_visao))) where column_value = t1.column_value), '', '', 'green') as color from table(fun.vpipe((select formula from micro_coluna where cd_micro_visao = ws_visao and cd_coluna = prm_ident))) t1) loop
					htp.p('<li class="'||i.color||'" onclick="templateMarcado(this, '''||prm_ident||''', '''||ws_visao||''');" title="'||i.valor||'">'||i.valor||' - '||i.nome||'</li>');
				end loop;
				/* for a in (select column_value as valor from table(fun.vpipe((select formula from micro_coluna where cd_micro_visao = prm_visao and cd_coluna = prm_ident))) where column_value not in (select nvl(column_value, 'N/A') from table(fun.vpipe((select propriedade from object_attrib where cd_prop = 'TPT' and owner = ws_usuario and cd_object = prm_ident))))) loop
					htp.p('<li onclick="if(this.className == ''green''){ this.className = ''''; } else { this.className = ''green''; } var lista = this.parentNode.querySelectorAll(''.green''); var tpt = ''''; for(i=0;i<lista.length;i++){ tpt = tpt+''|''+lista[i].innerHTML; } ajax(''fly'', ''template'', ''prm_objeto='||prm_ident||'&prm_valor=''+tpt, false);">'||a.valor||'</li>');
				end loop; */
			end if;

		elsif trim(prm_campo) = 'objetos' then
			htp.p('<div class="itens">');
			htp.p('<li>'||ws_titulo||'</li>');

			htp.p('<li style="text-align: center; position: sticky; position: -webkit-sticky; top: 0; background-color: #CCC; width: auto; margin: 0; padding: 5px 0; cursor: default; border-radius: 0;">');
				htp.p('<select style="max-width: 100%; width: 100%; margin: 2px;" id="obj_serch_tp" onchange="list_obj();">');
					htp.p('<option value="N/A" selected disabled hidden>'||fun.lang('TIPOS')||'</option>');
					htp.p('<option value="N/A">'||fun.lang('TODOS')||'</option>');
					htp.p('<optgroup label="'||fun.lang('TIPOS')||'"/>');
					for i in (select tp_objeto as tipo, decode(tp_objeto, 'CALL_LIST', 'MENU', 'IMAGE', 'IMAGEM', 'SCREEN', 'TELA', 'HEATMAP', 'MAPA DE CALOR', tp_objeto) as descricao from (select distinct(tp_objeto) from objetos) where tp_objeto <> 'SCRIPT' and tp_objeto <> 'SCREEN' and tp_objeto <> 'TEXTO' and tp_objeto <> 'OBJETO' order by descricao asc) loop
						/*select decode(tipo.tp_objeto, 'CALL_LIST', 'MENU', 'IMAGE', 'IMAGEM', tipo.tp_objeto) into ws_texto from dual; */
						htp.p('<option value="'||i.tipo||'">'||fun.lang(i.descricao)||'</option>');
					end loop;
				htp.p('</select>');

				htp.p('<select style="max-width: 100%; width: 100%; margin: 2px;" id="obj_serch_vw" onchange="list_obj();">');
					htp.p('<option value="N/A" selected disabled hidden>'||fun.lang('VIEW')||'</option>');
					htp.p('<option value="N/A">'||fun.lang('TODOS')||'</option>');
					htp.p('<optgroup label="VIEW"/>');
					for visao in (select nm_micro_visao from micro_visao order by nm_micro_visao asc) loop
						htp.p('<option value="'||visao.nm_micro_visao||'">'||visao.nm_micro_visao||'</option>');
					end loop;
				htp.p('</select>');

				htp.p('<select style="max-width: 100%; width: 100%; margin: 2px;" id="obj_serch_gp" onchange="list_obj();">');
					htp.p('<option value="N/A" selected disabled hidden>'||fun.lang('GRUPOS')||'</option>');
					htp.p('<option value="N/A">'||fun.lang('TODOS')||'</option>');
					htp.p('<optgroup label="'||fun.lang('GRUPOS')||'"/>');
					for grupo in (select cd_grupo from grupos_funcao order by cd_grupo asc) loop
						htp.p('<option value="'||grupo.cd_grupo||'">'||grupo.cd_grupo||'</option>');
					end loop;
				htp.p('</select>');

				/*					
					htp.p('<select style="max-width: 220px; width: 100%;" id="obj_serch_sc" onchange="var tipo = document.getElementById(''obj_serch_tp'').value; var view = document.getElementById(''obj_serch_vw'').value; var grupo = document.getElementById(''obj_serch_gp'').value; var desc = document.getElementById(''obj_serch_in'').value; if(desc.length < 3){ desc = ''N/A''; } ajax(''list'', ''list_obj'', ''prm_tipo=''+tipo+''&prm_view=''+view+''&prm_grupo=''+grupo+''&prm_desc=''+desc, true, ''ajax_obj'');">');
						htp.p('<option value="N/A" selected disabled hidden>'||fun.lang('TELAS')||'</option>');
						htp.p('<option value="N/A">'||fun.lang('TODOS')||'</option>');
						for screen in (select screen from obj_location order by screen asc) loop
							htp.p('<option value="'||screen.cd_grupo||'">'||screen.cd_grupo||'</option>');
						end loop;
					htp.p('</select>');
				*/

				htp.p('<input style="max-width: 100%; width: 100%; margin: 2px; " type="text" value="" id="obj_serch_in" placeholder="'||fun.lang('Descri&ccedil;&atilde;o')||'" onkeyup="list_obj();" />');
			htp.p('</li>');

			htp.p('<li class="nohover" style="margin: 0; padding: 0; width: auto;">');

			htp.p('<li class="addobj" onclick="ajax(''quick'',''quick_create'',''prm_nome=TEXTO&prm_tipo=TEXTO&prm_parametros=&prm_visao=&prm_coluna=&prm_grupo=GERAL&prm_obj_ant=&prm_filtro='', false); noerror('''', TR_CR, ''feed-fixo'');" title="Novo texto"><span class="newobj">'||fun.lang('TEXTO')||'</span></li>');
			htp.p('<li class="addobj" onclick="dashboard(document.getElementById(''current_screen'').value, ''newsection'');" id="section" title="Novo dashboard"><span class="newobj">'||fun.lang('DASHBOARD')||'</span></li>');


			htp.p('<ul id="ajax_obj"></ul>');
			htp.p('</li>');

		elsif trim(prm_campo) = 'tabelas' then

			htp.p('<li>'||ws_titulo||'</li>');

			htp.p('<li><input type="text" placeholder="'||fun.lang('NOME DA TABELA')||'" style="width: 180px; max-width: 180px;" /><a class="add" onclick="document.getElementById(''visao_tabela'').innerHTML = this.previousElementSibling.value; document.getElementById(''visao_tabela'').title = this.previousElementSibling.value;">+</a></li>');            

			ws_loop1 := 'never';
			for i in (select OBJECT_TYPE as TIPO, object_name as nome from all_objects where owner=nvl(fun.ret_var('OWNER_TABLE_DATA'),'DWU') and ((/*object_type in('TABLE','VIEW') AND*/ upper(SUBSTR(OBJECT_NAME,1,3)) IN ('VM_','DW_', 'OPR', 'BI_')) OR (object_type='VIEW' AND upper(SUBSTR(OBJECT_NAME,1,1))='V') OR (object_type in('TABLE','VIEW') AND upper(SUBSTR(OBJECT_NAME,1,5))='TAUX_'))  union all select 'MICRO' as TIPO, nm_micro_visao as nome from micro_visao order by tipo, nome ) loop
				if ws_loop1 <> i.tipo then
					ws_loop1 := i.tipo;
					htp.p('<li style="text-align: center; font-weight: bold; cursor: default; background: none !important;">'||ws_loop1||'</li>');
				end if;
				htp.p('<li onclick="if('''||prm_ident||''' != ''visao_tabela''){ ajax(''fly'', ''save_view'', ''prm_view='||prm_ident||'&prm_valor='||i.nome||'&prm_tipo=tabela''); noerror('''', ''Tabela alterada com sucesso!'', ''msg''); } fakeValue('''||prm_ident||''', this);" title="'||i.nome||'">'||i.nome||'</li>');
			end loop;
		elsif trim(prm_campo) = 'colunas-import' then

			htp.p('<li>'||ws_titulo||'</li>');

			htp.p('<li><input type="text" placeholder="'||fun.lang('NOME DA COLUNA')||'" style="width: 180px; max-width: 180px;" /><a class="add" onclick="document.getElementById('''||ws_visao||'-coluna'').innerHTML = this.previousElementSibling.value; document.getElementById('''||ws_visao||'-coluna'').title = this.previousElementSibling.value;">+</a></li>');            

			for i in ( select column_name, data_type from all_tab_columns where table_name = ws_visao ) loop
				htp.p('<li onclick="document.getElementById('''||ws_visao||'-'||prm_ref||'-'||prm_titulo||''').innerHTML = this.innerHTML; document.getElementById('''||ws_visao||'-'||prm_ref||'-'||prm_titulo||''').title = this.innerHTML; call(''import_change'', ''prm_tabela='||ws_visao||'&prm_numero='||prm_ref||'&prm_nome=''+document.getElementById('''||prm_visao||'-'||prm_ref||'-nome'').title+''&prm_destino=''+document.getElementById('''||ws_visao||'-'||prm_ref||'-destino'').title+''&prm_tipo=''+document.getElementById('''||ws_visao||'-'||prm_ref||'-tipo'').value+''&prm_trfs=''+document.getElementById('''||ws_visao||'-'||prm_ref||'-trfs'').value+''&prm_op=UPDATE'', ''imp'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });">'||i.column_name||'</li>');
			end loop;	
		elsif trim(prm_campo) = 'grupo' then 
			
			begin
				select CONTEUDO into ws_padrao
				from   PARAMETRO_USUARIO
				where  cd_usuario = ws_usuario and
					cd_padrao='CD_LINGUAGEM';
			exception
				when others then
					ws_padrao := 'PORTUGUESE';
			end;
			
			htp.p('<li>'||fun.lang('GRUPOS')||'</li>');
			for i in (select cd_grupo from grupos_funcao order by cd_grupo asc) loop
				htp.p('<li onclick="if(('''||prm_ident||''' != ''fake_grupo'') && ('''||prm_ident||''' != ''consulta_fake_grupo'')){ ajax(''fly'', ''save_view'', ''prm_view='||replace(prm_ident, '_grupo', '')||'&prm_valor='||i.cd_grupo||'&prm_tipo=grupo''); noerror('''', ''Grupo alterado com sucesso!'', ''msg''); } fakeValue('''||prm_ident||''', this);" title="'||i.cd_grupo||'">'||fun.utranslate('CD_GRUPO', 'GRUPOS_FUNCAO', i.cd_grupo, ws_padrao)||'</li>');
			end loop;
			
		elsif trim(prm_campo) = 'tabs' then
			htp.p('<li>'||ws_titulo||'</li>');
			if prm_titulo = 'EMPRESA' then
				htp.p('<li onclick="fakeValue('''||prm_ident||''', this);" title="*">*</li>');
			end if;
			for i in (select column_name from ALL_TAB_COLUMNS where	owner=nvl(fun.ret_var('OWNER_TABLE_DATA'),'DWU') and table_name=prm_visao order by column_name ) loop
				htp.p('<li onclick="fakeValue('''||prm_ident||''', this);" title="'||i.column_name||'">'||i.column_name||'</li>');
			end loop;
		elsif trim(prm_campo) = 'tipo' then
			htp.p('<li>'||ws_titulo||'</li>');
			htp.p('<li onclick="if('''||prm_ident||''' != ''fake_tipo''){ ident = '''||replace(prm_ident, 'fake_tipo_', '')||'''; document.getElementById(''fake_cdesc_''+ident).setAttribute(''title'', ''SEM''); document.getElementById(''fake_cdesc_''+ident).innerHTML=''SEM''; ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=tipo&prm_valor=SEM''); ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=ligacao&prm_valor=SEM''); noerror('''', '''||fun.lang('Campo alterado com sucesso')||'!'', ''msg''); } fakeValue('''||prm_ident||''', this); document.getElementById(''fake_cdesc'').setAttribute(''title'', ''SEM''); document.getElementById(''fake_cdesc'').innerHTML=''SEM''; " title="SEM">'||fun.lang('Sem')||'</li>');
			htp.p('<li onclick="if('''||prm_ident||''' != ''fake_tipo''){ ident = '''||replace(prm_ident, 'fake_tipo_', '')||'''; document.getElementById(''fake_cdesc_''+ident).setAttribute(''title'', ''SEM''); document.getElementById(''fake_cdesc_''+ident).innerHTML=''SEM''; ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=tipo&prm_valor=ANO''); ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=ligacao&prm_valor=SEM''); noerror('''', '''||fun.lang('Campo alterado com sucesso')||'!'', ''msg''); } fakeValue('''||prm_ident||''', this); document.getElementById(''fake_cdesc'').setAttribute(''title'', ''SEM''); document.getElementById(''fake_cdesc'').innerHTML=''SEM''; " title="ANO">'||fun.lang('Ano')||'</li>');
			htp.p('<li onclick="if('''||prm_ident||''' != ''fake_tipo''){ ident = '''||replace(prm_ident, 'fake_tipo_', '')||'''; document.getElementById(''fake_cdesc_''+ident).setAttribute(''title'', ''SEM''); document.getElementById(''fake_cdesc_''+ident).innerHTML=''SEM''; ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=tipo&prm_valor=DATA''); ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=ligacao&prm_valor=SEM''); noerror('''', '''||fun.lang('Campo alterado com sucesso')||'!'', ''msg''); } fakeValue('''||prm_ident||''', this); document.getElementById(''fake_cdesc'').setAttribute(''title'', ''SEM''); document.getElementById(''fake_cdesc'').innerHTML=''SEM''; " title="DATA">'||fun.lang('Data')||'</li>');
			htp.p('<li onclick="if('''||prm_ident||''' != ''fake_tipo''){ ident = '''||replace(prm_ident, 'fake_tipo_', '')||'''; document.getElementById(''fake_cdesc_''+ident).setAttribute(''title'', ''SEM''); document.getElementById(''fake_cdesc_''+ident).innerHTML=''SEM''; ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=tipo&prm_valor=DATA2''); ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=ligacao&prm_valor=SEM''); noerror('''', '''||fun.lang('Campo alterado com sucesso')||'!'', ''msg''); } fakeValue('''||prm_ident||''', this); document.getElementById(''fake_cdesc'').setAttribute(''title'', ''SEM''); document.getElementById(''fake_cdesc'').innerHTML=''SEM''; " title="DATA2">'||fun.lang('Data sem calend&aacute;rio')||'</li>');
			htp.p('<li onclick="if('''||prm_ident||''' != ''fake_tipo''){ ident = '''||replace(prm_ident, 'fake_tipo_', '')||'''; document.getElementById(''fake_cdesc_''+ident).setAttribute(''title'', ''SEM''); document.getElementById(''fake_cdesc_''+ident).innerHTML=''SEM''; ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=tipo&prm_valor=INTEIRO''); ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=ligacao&prm_valor=SEM''); noerror('''', '''||fun.lang('Campo alterado com sucesso')||'!'', ''msg''); } fakeValue('''||prm_ident||''', this); document.getElementById(''fake_cdesc'').setAttribute(''title'', ''SEM''); document.getElementById(''fake_cdesc'').innerHTML=''SEM''; " title="INTEIRO">'||fun.lang('Inteiro')||'</li>');
			htp.p('<li onclick="if('''||prm_ident||''' != ''fake_tipo''){ ident = '''||replace(prm_ident, 'fake_tipo_', '')||'''; document.getElementById(''fake_cdesc_''+ident).setAttribute(''title'', ''SEM''); document.getElementById(''fake_cdesc_''+ident).innerHTML=''SEM''; ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=tipo&prm_valor=MES''); ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=ligacao&prm_valor=SEM''); noerror('''', '''||fun.lang('Campo alterado com sucesso')||'!'', ''msg''); } fakeValue('''||prm_ident||''', this); document.getElementById(''fake_cdesc'').setAttribute(''title'', ''SEM''); document.getElementById(''fake_cdesc'').innerHTML=''SEM''; " title="MES">'||fun.lang('M&ecirc;s')||'</li>');
			htp.p('<li onclick="if('''||prm_ident||''' != ''fake_tipo''){ ident = '''||replace(prm_ident, 'fake_tipo_', '')||'''; document.getElementById(''fake_cdesc_''+ident).setAttribute(''title'', ''SEM''); document.getElementById(''fake_cdesc_''+ident).innerHTML=''SEM''; ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=tipo&prm_valor=NUMERICO''); ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=ligacao&prm_valor=SEM''); noerror('''', '''||fun.lang('Campo alterado com sucesso')||'!'', ''msg''); } fakeValue('''||prm_ident||''', this); document.getElementById(''fake_cdesc'').setAttribute(''title'', ''SEM''); document.getElementById(''fake_cdesc'').innerHTML=''SEM''; " title="NUMERICO">'||fun.lang('Numero')||'</li>');
			htp.p('<li onclick="if('''||prm_ident||''' != ''fake_tipo''){ ident = '''||replace(prm_ident, 'fake_tipo_', '')||'''; document.getElementById(''fake_cdesc_''+ident).setAttribute(''title'', ''SEM''); document.getElementById(''fake_cdesc_''+ident).innerHTML=''SEM''; ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=tipo&prm_valor=TEXTO''); ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=ligacao&prm_valor=SEM''); noerror('''', '''||fun.lang('Campo alterado com sucesso')||'!'', ''msg''); } fakeValue('''||prm_ident||''', this); document.getElementById(''fake_cdesc'').setAttribute(''title'', ''SEM''); document.getElementById(''fake_cdesc'').innerHTML=''SEM''; " title="TEXTO">'||fun.lang('Texto')||'</li>');
		elsif trim(prm_campo) = 'usuario' then
			htp.p('<li>'||fun.lang('USU&Aacute;RIOS')||'</li>');
			
			ws_tipo := 'N/A';
			
			for i in (select usu_nome, usu_completo, status, (select count(*) from gusers_itens where cd_usuario = trim(usu_nome) and cd_group = prm_ident ) as valid from usuarios order by status, usu_nome ) loop
				
				if ws_tipo <> i.status then
					ws_tipo := i.status;
					htp.p('<li>'||i.status||'</li>');
				end if;
				
				if i.valid = 1 then
					htp.p('<li id="'||i.usu_nome||'_linha" class="green" onclick=" if(this.className == ''green''){ ajax(''fly'', ''alter_gusuario'', ''prm_group='||prm_ident||'&prm_usuario='||trim(i.usu_nome)||'&prm_tipo=d'', false); noerror('''', ''Usu&aacute;rio removido com sucesso!'', ''msg''); } else { ajax(''fly'', ''alter_gusuario'', ''prm_group='||prm_ident||'&prm_usuario='||trim(i.usu_nome)||'&prm_tipo=u'', false); noerror('''', ''Usu&aacute;rio adicionado com sucesso!'', ''msg''); } document.getElementById('''||i.usu_nome||'_linha'').classList.toggle(''green'');" title="'||i.usu_completo||'">'||i.usu_nome||'</li>');
				else
					htp.p('<li id="'||i.usu_nome||'_linha" class="" onclick=" if(this.className != ''green''){ ajax(''fly'', ''alter_gusuario'', ''prm_group='||prm_ident||'&prm_usuario='||trim(i.usu_nome)||'&prm_tipo=u'', false); noerror('''', ''Usu&aacute;rio adicionado com sucesso!'', ''msg''); } else { ajax(''fly'', ''alter_gusuario'', ''prm_group='||prm_ident||'&prm_usuario='||trim(i.usu_nome)||'&prm_tipo=d'', false); noerror('''', ''Usu&aacute;rio removido com sucesso!'', ''msg''); } document.getElementById('''||i.usu_nome||'_linha'').classList.toggle(''green'');" title="'||i.usu_completo||'">'||i.usu_nome||'</li>');
				end if;
			end loop;
		elsif trim(prm_campo) = 'img' then
			htp.p('<li>'||fun.lang('ARQUIVOS')||'</li>');
			for i in (select name, doc_size from tab_documentos where usuario <> 'SYS' and (name like ('%.jp%') or name like ('%png')) order by name asc, mime_type) loop
				htp.p('<li id="'||i.name||'_linha" onclick="document.getElementById('''||prm_ident||''').value = this.title; if('''||prm_ident||'''.indexOf(''f-'') != -1){ objeto = '''||prm_ident||'''.replace(''f-'', ''''); ajax(''fly'', ''update_file'', ''prm_objeto=''+objeto+''&prm_valor=''+this.title, false); noerror('''', ''Altera&ccedil;&atilde;o realizada com sucesso!'', ''msg''); } document.getElementById(''fakelist'').classList.toggle(''visible'');" title="'||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download?arquivo='||i.name||'">'||i.name||'</li>');
			end loop;
		elsif trim(prm_campo) = 'hint' then
			htp.p('<li>HINT</li>');
			for i in (select TP_OBJETO, CD_PROP, HINT from OBJECT_PADRAO ORDER BY TP_OBJETO, CD_PROP) loop
				htp.p('<li id="'||i.tp_objeto||'-'||i.cd_prop||'_linha" onclick="document.getElementById('''||prm_ident||''').value = this.title; if('''||prm_ident||'''.indexOf(''f-'') != -1){ objeto = '''||prm_ident||'''.replace(''f-'', ''''); ajax(''fly'', ''update_file'', ''prm_objeto=''+objeto+''&prm_valor=''+this.title, false); noerror('''', ''Altera&ccedil;&atilde;o realizada com sucesso!'', ''msg''); } document.getElementById(''fakelist'').classList.toggle(''visible'');" title=""></li>');
			end loop;
		elsif trim(prm_campo) = 'scolunas' then
			htp.p('<li>'||fun.lang('COLUNAS')||'</li>');
			
			select tp_objeto into ws_tipo from objetos where cd_objeto = prm_visao;
			
			for i in (select distinct(nvl(column_value, 'N/A')) as column_value from table(fun.vpipe((select cs_agrupador from ponto_avaliacao where cd_ponto = prm_visao))) where column_value <> 'N/A' order by column_value asc) loop
				select nm_rotulo into ws_texto from micro_coluna where cd_micro_visao = (select cd_micro_visao from ponto_avaliacao where cd_ponto = prm_visao and rownum = 1) and cd_coluna = i.column_value and rownum = 1;
				htp.p('<li id="'||i.column_value||'_linha" class="green" onclick="document.getElementById(''fechar_sup'').setAttribute(''data-reloado'', '''||prm_visao||'''); if(this.className == ''green''){ if(document.getElementById(''fakelist'').querySelectorAll(''.green'').length > 1){ document.getElementById('''||i.column_value||'_linha'').classList.toggle(''green''); agrupador = ''''; agrupadores = document.getElementById(''fakelist'').querySelectorAll(''.green''); for(i=0;i<agrupadores.length;i++){ agrupador = agrupador+agrupadores[i].title+''|''; } ajax(''fly'', ''change_bar'', ''prm_obj='||prm_visao||'&prm_agrupador=''+agrupador+''&prm_tipo=objeto'', false); noerror('''', '''||fun.lang('Coluna removida com sucesso')||'!'', ''msg'');} else { alerta(''msg'', '''||fun.lang('Gr&aacute;fico deve ter ao menos uma coluna')||'!''); } } else { document.getElementById('''||i.column_value||'_linha'').classList.toggle(''green''); agrupador = ''''; agrupadores = document.getElementById(''fakelist'').querySelectorAll(''.green''); for(i=0;i<agrupadores.length;i++){ agrupador = agrupador+agrupadores[i].title+''|''; } ajax(''fly'', ''change_bar'', ''prm_obj='||prm_visao||'&prm_agrupador=''+agrupador+''&prm_tipo=objeto'', false); noerror('''', ''Coluna adicionada com sucesso!'', ''msg''); }" title="'||i.column_value||'">'||ws_texto||' / '||i.column_value||'');
					/*if ws_tipo = 'BARRAS' or ws_tipo = 'LINHA' then
						htp.p('<select>');
							htp.p('<option value="BARRAS">'||fun.lang('BARRAS')||'</option>');
							htp.p('<option value="LINHA">'||fun.lang('LINHAS')||'</option>');
						htp.p('</select>');
					end if;*/
				htp.p('</li>');
			end loop;
			for a in (select cd_coluna, nm_rotulo from micro_coluna where cd_micro_visao = (select cd_micro_visao from ponto_avaliacao where cd_ponto = prm_visao) and cd_coluna not in (select nvl(column_value, 'N/A') from table(fun.vpipe((select cs_agrupador  from ponto_avaliacao where cd_ponto = prm_visao)))) and st_agrupador <> 'SEM' and st_agrupador <> 'TPT' order by cd_coluna asc) loop
				htp.p('<li id="'||a.cd_coluna||'_linha" class="" onclick="document.getElementById(''fechar_sup'').setAttribute(''data-reloado'', '''||prm_visao||'''); if(this.className == ''green''){ if(document.getElementById(''fakelist'').querySelectorAll(''.green'').length > 1){ document.getElementById('''||a.cd_coluna||'_linha'').classList.toggle(''green''); agrupador = ''''; agrupadores = document.getElementById(''fakelist'').querySelectorAll(''.green''); for(i=0;i<agrupadores.length;i++){ agrupador = agrupador+agrupadores[i].title+''|''; } ajax(''fly'', ''change_bar'', ''prm_obj='||prm_visao||'&prm_agrupador=''+agrupador+''&prm_tipo=objeto'', false); noerror('''', '''||fun.lang('Coluna removida com sucesso')||'!'', ''msg''); } else { alerta(''msg'', '''||fun.lang('Gr&aacute;fico deve ter ao menos uma coluna')||'!''); }} else { document.getElementById('''||a.cd_coluna||'_linha'').classList.toggle(''green''); agrupador = ''''; agrupadores = document.getElementById(''fakelist'').querySelectorAll(''.green''); for(i=0;i<agrupadores.length;i++){ agrupador = agrupador+agrupadores[i].title+''|''; } ajax(''fly'', ''change_bar'', ''prm_obj='||prm_visao||'&prm_agrupador=''+agrupador+''&prm_tipo=objeto'', false); noerror('''', ''Coluna adicionada com sucesso!'', ''msg''); }" title="'||a.cd_coluna||'">'||a.nm_rotulo||' / '||a.cd_coluna||'</li>');
			end loop;
		elsif trim(prm_campo) = 'scoluna' then
			htp.p('<li>'||fun.lang('COLUNAS')||'</li>');
			for i in (select nvl(column_value, 'N/A') as column_value from table(fun.vpipe((select cs_agrupador from ponto_avaliacao where cd_ponto = prm_visao))) where column_value <> 'N/A' order by column_value asc) loop
				select nm_rotulo into ws_texto from micro_coluna where cd_micro_visao = (select cd_micro_visao from ponto_avaliacao where cd_ponto = prm_visao and rownum = 1) and cd_coluna = i.column_value and rownum = 1;
				htp.p('<li id="'||i.column_value||'_linha" class="green" onclick="document.getElementById(''fechar_sup'').setAttribute(''data-reloado'', '''||prm_visao||'''); if(this.className != ''green''){ document.getElementById(''fakelist'').querySelector(''.green'').className = ''''; this.className = ''green''; ajax(''fly'', ''change_bar'', ''prm_obj='||prm_visao||'&prm_agrupador=''+this.title+''|&prm_tipo=objeto'', false); }" title="'||i.column_value||'">'||ws_texto||' / '||i.column_value||'</li>');
			end loop;
			for a in (select cd_coluna, nm_rotulo from micro_coluna where cd_micro_visao = (select cd_micro_visao from ponto_avaliacao where cd_ponto = prm_visao) and cd_coluna not in (select nvl(column_value, 'N/A') from table(fun.vpipe((select cs_agrupador from ponto_avaliacao where cd_ponto = prm_visao)))) and st_agrupador <> 'SEM' and st_agrupador <> 'TPT' order by cd_coluna asc) loop
				htp.p('<li id="'||a.cd_coluna||'_linha" class="" onclick="document.getElementById(''fechar_sup'').setAttribute(''data-reloado'', '''||prm_visao||'''); if(this.className != ''green''){ document.getElementById(''fakelist'').querySelector(''.green'').className = ''''; this.className = ''green''; ajax(''fly'', ''change_bar'', ''prm_obj='||prm_visao||'&prm_agrupador=''+this.title+''|&prm_tipo=objeto'', false); }" title="'||a.cd_coluna||'">'||a.nm_rotulo||' / '||a.cd_coluna||'</li>');
			end loop;
		elsif trim(prm_campo) = 'pcoluna' then
			htp.p('<li>'||fun.lang('COLUNAS')||'</li>');
			for i in (select nvl(column_value, 'N/A') as column_value from table(fun.vpipe((select parametros from ponto_avaliacao where cd_ponto = prm_visao))) where column_value <> 'N/A' order by column_value asc) loop
				select nm_rotulo into ws_texto from micro_coluna where cd_micro_visao = (select cd_micro_visao from ponto_avaliacao where cd_ponto = prm_visao and rownum = 1) and cd_coluna = i.column_value and rownum = 1;
				htp.p('<li id="'||i.column_value||'_linha" class="green" onclick="document.getElementById(''fechar_sup'').setAttribute(''data-reloado'', '''||prm_visao||'''); if(this.className != ''green''){ document.getElementById(''fakelist'').querySelector(''.green'').className = ''''; this.className = ''green''; ajax(''fly'', ''change_bar'', ''prm_obj='||prm_visao||'&prm_agrupador=''+this.title+''|&prm_tipo='', false); }" title="'||i.column_value||'">'||ws_texto||' / '||i.column_value||'</li>');
			end loop;
			for a in (select cd_coluna, nm_rotulo from micro_coluna where cd_micro_visao = (select cd_micro_visao from ponto_avaliacao where cd_ponto = prm_visao) and cd_coluna not in (select nvl(column_value, 'N/A') from table(fun.vpipe((select parametros from ponto_avaliacao where cd_ponto = prm_visao)))) and st_agrupador <> 'SEM' and st_agrupador <> 'TPT' order by cd_coluna asc) loop
				htp.p('<li id="'||a.cd_coluna||'_linha" class="" onclick="document.getElementById(''fechar_sup'').setAttribute(''data-reloado'', '''||prm_visao||'''); if(this.className != ''green''){ document.getElementById(''fakelist'').querySelector(''.green'').className = ''''; this.className = ''green''; ajax(''fly'', ''change_bar'', ''prm_obj='||prm_visao||'&prm_agrupador=''+this.title+''|&prm_tipo='', false); }" title="'||a.cd_coluna||'">'||a.nm_rotulo||' / '||a.cd_coluna||'</li>');
			end loop;
		elsif trim(prm_campo) = 'colunav' then
			htp.p('<li>'||fun.lang('COLUNAS')||'</li>');
			select parametros into ws_loop1 from ponto_avaliacao where cd_ponto = prm_visao and rownum = 1;
			ws_loop1 := replace(ws_loop1, '|', '');
			htp.p('<li id="'||ws_loop1||'_linha" class="green" onclick="document.getElementById(''fechar_sup'').setAttribute(''data-reloado'', '''||prm_visao||'''); if(this.className != ''green''){ document.getElementById(''fakelist'').querySelector(''.green'').className = ''''; this.className = ''green''; ajax(''fly'', ''change_bar'', ''prm_obj='||prm_visao||'&prm_agrupador=''+this.innerHTML+''|&prm_tipo=valor'', false); }" title="'||ws_loop1||'">'||ws_loop1||'</li>');

			for a in (select cd_coluna from micro_coluna where cd_micro_visao = (select cd_micro_visao from ponto_avaliacao where cd_ponto = prm_visao) and st_agrupador <> 'SEM' and st_agrupador <> 'TPT' and cd_coluna <> ws_loop1) loop
				htp.p('<li id="'||a.cd_coluna||'_linha" class="" onclick="document.getElementById(''fechar_sup'').setAttribute(''data-reloado'', '''||prm_visao||'''); if(this.className != ''green''){ document.getElementById(''fakelist'').querySelector(''.green'').className = ''''; this.className = ''green''; ajax(''fly'', ''change_bar'', ''prm_obj='||prm_visao||'&prm_agrupador=''+this.innerHTML+''|&prm_tipo=valor'', false); }" title="'||a.cd_coluna||'">'||a.cd_coluna||'</li>');
			end loop;
		elsif trim(prm_campo) = 'calculada' then

			htp.p('<li class="fixed nohover">'||fun.lang('COLUNAS CALCULADAS')||'</li>');

			htp.p('<li style="text-align: center;" class="nohover"><a class="link" onclick="var linha = document.getElementById(''linha-dummy'').children[0].cloneNode(true); this.parentNode.parentNode.appendChild(linha); linha.children[0].className = ''calculos_n''; linha.children[1].className = ''calculos''; linha.children[2].className = ''remove''; linha.children[3].className = ''calculos_m''; ">'||fun.lang('ADICIONAR COLUNA')||'</a></li>');

			for i in (select column_value as valor, rownum as linha from table(fun.vpipe((fun.getprop(prm_visao,'CALCULADA'))))) loop 
				select mascara into ws_loop2 from(select column_value as mascara, rownum as linha from table(fun.vpipe((fun.getprop(prm_visao,'CALCULADA_M'))))) where linha = i.linha;
				select nome into ws_loop3 from(select column_value as nome, rownum as linha from table(fun.vpipe((fun.getprop(prm_visao,'CALCULADA_N'))))) where linha = i.linha;
				htp.p('<li style="width: 94%; margin-bottom: 8px;">');
					htp.p('<input class="calculos_n" type="text" style="margin: 2px;" onblur="colunasCalculo('''||prm_visao||''', '''||ws_usuario||''');" value="'||ws_loop3||'" placeholder="'||fun.lang('Nome')||'" />');
					htp.p('<input class="calculos" type="text" style="margin: 2px;" onblur="colunasCalculo('''||prm_visao||''', '''||ws_usuario||''');" value="'||i.valor||'" placeholder="'||fun.lang('F&oacute;rmula')||'" />');
					htp.p('<a class="remove" onclick="if(confirm(TR_EX)){ this.parentNode.remove(); colunasCalculo('''||prm_visao||''', '''||ws_usuario||'''); }">X</a>');
					htp.p('<input class="calculos_m" type="text" style="margin: 2px;" onblur="colunasCalculo('''||prm_visao||''', '''||ws_usuario||''');" value="'||ws_loop2||'" placeholder="'||fun.lang('M&aacute;scara')||'" />');
				htp.p('</li>');
			end loop;

			htp.p('<span class="invisible" id="linha-dummy"><li style="width: 94%; margin-bottom: 8px;">');
				htp.p('<input style="margin: 2px;" onblur="colunasCalculo('''||prm_visao||''', '''||ws_usuario||''');" type="text" value="" placeholder="'||fun.lang('Nome')||'" />');
				htp.p('<input style="margin: 2px;" onblur="colunasCalculo('''||prm_visao||''', '''||ws_usuario||''');" type="text" value="" placeholder="'||fun.lang('F&oacute;rmula')||'" />');
				htp.p('<a class="remove" onclick="if(confirm(TR_EX)){ this.parentNode.remove(); colunasCalculo('''||prm_visao||''', '''||ws_usuario||'''); }">X</a>');
				htp.p('<input style="margin: 2px;" onblur="colunasCalculo('''||prm_visao||''', '''||ws_usuario||''');" type="text" value="" placeholder="'||fun.lang('M&aacute;scara')||'" />');
			htp.p('</li></span>');

		elsif trim(prm_campo) = 'subquery' then

			htp.p('<li class="fixed nohover">'||fun.lang('COLUNAS')||'</li>');

			htp.p('<li style="text-align: center;" class="nohover"><a class="link" onclick="var linha = document.getElementById(''subquery-dummy'').cloneNode(true); linha.setAttribute(''title'', document.getElementById(''fakelist'').children.length); linha.setAttribute(''data-counter'', document.getElementById(''fakelist'').children.length); this.parentNode.parentNode.insertBefore(linha, document.getElementById(''coress''));">'||fun.lang('ADICIONAR COLUNA')||'</a></li>');

			for i in (select column_value as coluna from table(fun.vpipe((fun.put_par(prm_visao,'SUBQUERY', 'CONSULTA'))))) loop
				ws_count := ws_count+1;
				
				if length(i.coluna) > 0 then
					htp.p('<li class="nohover" data-counter="'||ws_counter||'" title="'||ws_count||'" id="'||i.coluna||'field" data-visao="'||prm_visao||'" style="width: 94%; margin-bottom: 8px;">');
						
						htp.p('<select style="max-width: calc(100% - 34px); width: calc(100% - 34px);" onchange="var total = ''''; var valores = document.getElementById(''fakelist'').getElementsByTagName(''select''); for(i=0;i<valores.length-1;i++){ total = total+valores[i].options[valores[i].selectedIndex].value+''|''; } ajax(''fly'', ''alter_attrib'', ''prm_objeto='||prm_visao||'&prm_prop=SUBQUERY&prm_value=''+total+''&prm_usuario='||ws_usuario||''', false);">');
							htp.p('<option value="">-----</option>');
							for a in (select nm_rotulo, cd_coluna from micro_coluna where cd_micro_visao = (select cd_micro_visao from ponto_avaliacao where cd_ponto = prm_visao) and cd_coluna not in (select column_value from table(fun.vpipe((select cs_coluna||'|'||cs_agrupador from ponto_avaliacao where cd_ponto = prm_visao)))) and st_agrupador = 'SEM' order by cd_coluna) loop
								if a.cd_coluna = i.coluna then
									htp.p('<option selected onmouseover="document.getElementById(''fakelist'').className = ''visible'';" value="'||a.cd_coluna||'" title="'||a.cd_coluna||'">'||a.cd_coluna||' - '||a.nm_rotulo||'</option>');
								else
									htp.p('<option onmouseover="document.getElementById(''fakelist'').className = ''visible'';" value="'||a.cd_coluna||'" title="'||a.cd_coluna||'">'||a.cd_coluna||' - '||a.nm_rotulo||'</option>');
								end if;
							end loop;
						htp.p('</select>');
						fcl.button_lixo('alter_attrib','prm_objeto|prm_prop|prm_value|prm_usuario', prm_visao||'|'||'SUBQUERY'||'||'||user);
					htp.p('</li>');
				end if;
			end loop;

			htp.p('<li class="fixed nohover" id="coress" style="cursor: default; margin: 40px 6px 10px 6px; font-weight: bold; font-size: 18px; text-align: center; white-space: nowrap; color: var(--main-background); font-family: var(--fonte-primaria);">'||fun.lang('SEQU&Ecirc;NCIA DE CORES')||'</li>');
			
			htp.p('<li style="text-align: center;" class="nohover"><a class="link" onclick="var linha = document.getElementById(''subquery-cor-dummy'').cloneNode(true); linha.setAttribute(''title'', document.getElementById(''fakelist'').children.length); linha.setAttribute(''data-counter'', document.getElementById(''fakelist'').children.length); linha.value = ''#FFFFFF''; this.parentNode.parentNode.insertBefore(linha, document.getElementById(''subquery-dummy-ul''));">'||fun.lang('ADICIONAR COR')||'</a></li>');

			ws_count := 0;
			for a in(select column_value as coluna from table(fun.vpipe((fun.put_par(prm_visao,'SUBQUERY-COR', 'CONSULTA'))))) loop
				ws_count := ws_count+1;
				ws_texto := substr(a.coluna, 2, length(a.coluna)-1);
				if length(a.coluna) > 0 then
					htp.p('<li class="nohover" data-counter="'||ws_counter||'" title="'||ws_count||'" id="'||a.coluna||'field" data-visao="'||prm_visao||'" style="width: 94%; margin-bottom: 8px;">');
						htp.p('<input style="max-width: calc(100% - 34px); width: calc(100% - 34px);" type="color" id="'||a.coluna||'_b" value="'||ws_texto||'" onchange="var total = ''''; var valores = document.getElementById(''fakelist'').getElementsByTagName(''input''); for(i=0;i<valores.length-1;i++){ total = total+valores[i].parentNode.title+valores[i].value+''|''; } ajax(''fly'', ''alter_attrib'', ''prm_objeto='||prm_visao||'&prm_prop=SUBQUERY-COR&prm_value=''+total+''&prm_usuario='||gbl.getUsuario||''', false); ">');
						fcl.button_lixo('alter_attrib','prm_objeto|prm_prop|prm_value|prm_usuario', prm_visao||'|'||'SUBQUERY-COR'||'||'||user);
					htp.p('</li>');
				end if;
			end loop;

			htp.p('<ul style="display: none;" id="subquery-dummy-ul">');
			
				htp.p('<li id="subquery-cor-dummy" data-visao="'||prm_visao||'" style="width: 94%; margin-bottom: 8px;">');
					htp.p('<input style="max-width: calc(100% - 34px); width: calc(100% - 34px);" type="color"  onchange="var total = ''''; var valores = document.getElementById(''fakelist'').getElementsByTagName(''input''); for(i=0;i<valores.length-1;i++){ total = total+valores[i].parentNode.title+valores[i].value+''|''; } ajax(''fly'', ''alter_attrib'', ''prm_objeto='||prm_visao||'&prm_prop=SUBQUERY-COR&prm_value=''+total+''&prm_usuario='||ws_usuario||''', false); ">');
					fcl.button_lixo('alter_attrib','prm_objeto|prm_prop|prm_value|prm_usuario', prm_visao||'|'||'SUBQUERY-COR'||'||'||user);
				htp.p('</li>');

				htp.p('<li id="subquery-dummy" data-visao="'||prm_visao||'" style="width: 94%; margin-bottom: 8px;">');
				htp.p('<select style="max-width: calc(100% - 34px); width: calc(100% - 34px);" onchange="var total = ''''; var valores = document.getElementById(''fakelist'').getElementsByTagName(''select''); for(i=0;i<valores.length-1;i++){ total = total+valores[i].options[valores[i].selectedIndex].value+''|''; } ajax(''fly'', ''alter_attrib'', ''prm_objeto='||prm_visao||'&prm_prop=SUBQUERY&prm_value=''+total+''&prm_usuario='||ws_usuario||''', false);">');
						htp.p('<option value="">-----</option>');
						for a in (select nm_rotulo, cd_coluna from micro_coluna where cd_micro_visao = (select cd_micro_visao from ponto_avaliacao where cd_ponto = prm_visao) and cd_coluna not in (select column_value from table(fun.vpipe((select cs_coluna||'|'||cs_agrupador from ponto_avaliacao where cd_ponto = prm_visao)))) and st_agrupador = 'SEM' order by cd_coluna) loop
							htp.p('<option onmouseover="document.getElementById(''fakelist'').className = ''visible'';" value="'||a.cd_coluna||'" title="'||a.cd_coluna||'">'||a.cd_coluna||' - '||a.nm_rotulo||'</option>');
						end loop;
					htp.p('</select>');
					fcl.button_lixo('alter_attrib','prm_objeto|prm_prop|prm_value|prm_usuario', prm_visao||'|'||'SUBQUERY'||'||'||user);
				htp.p('</li>');

			htp.p('</ul>');

		elsif trim(prm_campo) = 'cor-coluna' then

			htp.p('<li class="fixed nohover">'||fun.lang('COR DAS COLUNAS')||'</li>');

			htp.p('<li style="text-align: center;" class="nohover"><a class="link" onclick="var linha = document.getElementById(''subquery-dummy'').cloneNode(true); linha.setAttribute(''title'', document.getElementById(''fakelist'').children.length); linha.setAttribute(''data-counter'', document.getElementById(''fakelist'').children.length); linha.id = ''''; this.parentNode.parentNode.insertBefore(linha, document.getElementById(''coress''));">'||fun.lang('ADICIONAR LINHA')||'</a></li>');

			for i in (select column_value as coluna from table(fun.vpipe((fun.getprop(prm_visao,'COR-COLUNA'))))) loop
				ws_count := ws_count+1;
				
				if length(i.coluna) > 0 then
					htp.p('<li class="nohover" data-counter="'||ws_counter||'" title="'||ws_count||'" id="'||i.coluna||'field" data-visao="'||prm_visao||'" style="width: 94%; margin-bottom: 8px;">');
						htp.p('<input class="cor-coluna-valor" type="text" onblur="var total = []; var linhas = document.getElementsByClassName(''cor-coluna-valor''); for(i=0;i<linhas.length;i++){ total.push(linhas[i].value); } ajax(''fly'', ''alter_attrib'', ''prm_objeto='||prm_visao||'&prm_prop=COR-COLUNA&prm_value=''+total.join(''|'')+''&prm_usuario=DWU'', false);" value="'||i.coluna||'"/>');
						htp.p('<a class="remove" style="padding: 0; margin-top: -2px;" onclick="this.parentNode.remove(); var total = []; var linhas = document.getElementsByClassName(''cor-coluna-valor''); for(i=0;i<linhas.length;i++){ total.push(linhas[i].value); } ajax(''fly'', ''alter_attrib'', ''prm_objeto='||prm_visao||'&prm_prop=COR-COLUNA&prm_value=''+total.join(''|'')+''&prm_usuario=DWU'', false);">X</a>');
					htp.p('</li>');
				end if;
			end loop;

			htp.p('<li class="fixed nohover" id="coress" style="cursor: default; margin: 40px 6px 10px 6px; font-weight: bold; font-size: 20px; text-align: center; white-space: nowrap;">'||fun.lang('SEQU&Ecirc;NCIA DE CORES')||'</li>');
			
			htp.p('<li style="text-align: center;" class="nohover"><a class="link" onclick="var linha = document.getElementById(''subquery-cor-dummy'').cloneNode(true); linha.setAttribute(''title'', document.getElementById(''fakelist'').children.length); linha.setAttribute(''data-counter'', document.getElementById(''fakelist'').children.length); linha.value = ''#FFFFFF''; this.parentNode.parentNode.insertBefore(linha, document.getElementById(''subquery-dummy-ul''));">'||fun.lang('ADICIONAR COR')||'</a></li>');

			for i in (select column_value as coluna from table(fun.vpipe((fun.getprop(prm_visao,'COR-COLUNA-HEX'))))) loop
				ws_count := ws_count+1;
				
				if length(i.coluna) > 0 then
					htp.p('<li class="nohover" data-counter="'||ws_counter||'" title="'||ws_count||'" id="'||i.coluna||'field" data-visao="'||prm_visao||'" style="width: 94%; margin-bottom: 8px;">');
						htp.p('<input class="cor-coluna-cor" type="color" onblur="var total = []; var linhas = document.getElementsByClassName(''cor-coluna-cor''); for(i=0;i<linhas.length-1;i++){ total.push(linhas[i].value); } ajax(''fly'', ''alter_attrib'', ''prm_objeto='||prm_visao||'&prm_prop=COR-COLUNA-HEX&prm_value=''+total.join(''|'')+''&prm_usuario=DWU'', false);" value="'||i.coluna||'"/>');
						fcl.button_lixo('alter_attrib','prm_objeto|prm_prop|prm_value|prm_usuario', prm_visao||'|'||'COR-COLUNA-HEX'||'|'||'+total.join(''|'')+'||'|'||user);
					htp.p('</li>');
				end if;
			end loop;

			htp.p('<ul style="display: none;" id="subquery-dummy-ul">');
			
				htp.p('<li id="subquery-cor-dummy" data-visao="'||prm_visao||'" style="width: 94%; margin-bottom: 8px;">');
					htp.p('<input class="cor-coluna-cor" style="max-width: calc(100% - 34px); width: calc(100% - 34px);" type="color" onchange="var total = []; var linhas = document.getElementsByClassName(''cor-coluna-cor''); for(i=0;i<linhas.length-1;i++){ total.push(linhas[i].value); } ajax(''fly'', ''alter_attrib'', ''prm_objeto='||prm_visao||'&prm_prop=COR-COLUNA-HEX&prm_value=''+total.join(''|'')+''&prm_usuario=DWU'', false); " value="" />');
					fcl.button_lixo('alter_attrib','prm_objeto|prm_prop|prm_value|prm_usuario', prm_visao||'|'||'COR-COLUNA-HEX'||'|'||'total'||'|'||user);
				htp.p('</li>');

				htp.p('<li id="subquery-dummy" data-visao="'||prm_visao||'" style="width: 94%; margin-bottom: 8px;">');
					htp.p('<input class="cor-coluna-valor" type="text" onblur="var total = []; var linhas = document.getElementsByClassName(''cor-coluna-valor''); for(i=0;i<linhas.length-1;i++){ total.push(linhas[i].value); } ajax(''fly'', ''alter_attrib'', ''prm_objeto='||prm_visao||'&prm_prop=COR-COLUNA&prm_value=''+total.join(''|'')+''&prm_usuario=DWU'', false);" value="" />');
					fcl.button_lixo('alter_attrib','prm_objeto|prm_prop|prm_value|prm_usuario', prm_visao||'|'||'COR-COLUNA'||'|'||'+total+'||'|'||user);
				htp.p('</li>');

			htp.p('</ul>');

		elsif trim(prm_campo) = 'lang' then
			ws_count := 0;
			for a in (select column_value from table(fun.vpipe(prm_visao))) loop
			if ws_count = 0 then
				ws_loop1 := a.column_value;
			elsif ws_count = 1 then
				ws_loop2 := a.column_value;
			else
				ws_loop3 := a.column_value;
			end if;
			ws_count := ws_count+1;
			end loop;

			select count(*) into ws_count from micro_coluna where cd_micro_visao = ws_loop1 and nm_rotulo = ws_loop3;
			if ws_count = 1 then
				ws_tipo := 'C';
			else
				ws_tipo := 'T';
			end if;
			ws_count := 0;
			select count(*) into ws_count from objetos where cd_objeto = ws_loop1;
			if ws_count = 1 then
			ws_tipo := 'O';
			end if;
			ws_count := 0;

			htp.p('<li id="default-local" data-value="'||ws_loop3||'" ></li>');
			begin
			for i in (select cd_lang, nm_lang from language where ativo = 'S') loop
				select count(*) into ws_count from traducao_colunas where trim(cd_tabela) = trim(ws_loop1) and trim(cd_coluna) = trim(ws_loop2) and trim(lang_default) = ws_loop3 and trim(cd_linguagem) = trim(i.nm_lang);
				
				if ws_count = 1 then
					select texto into ws_texto from traducao_colunas where trim(cd_tabela) = trim(ws_loop1) and trim(cd_coluna) = trim(ws_loop2) and trim(lang_default) = ws_loop3 and trim(cd_linguagem) = trim(i.nm_lang);
					select fixa into ws_fixa from traducao_colunas where trim(cd_tabela) = trim(ws_loop1) and trim(cd_coluna) = trim(ws_loop2) and trim(lang_default) = ws_loop3 and trim(cd_linguagem) = trim(i.nm_lang);
				else
					ws_fixa := 'E';
					ws_texto := '';
				end if;

				htp.p('<li data-result="'||ws_count||'" style="font-weight: bold;" class="nohover" data-attr="'||ws_loop1||'|'||ws_loop2||'|'||ws_loop3||'" id="'||i.cd_lang||'">'||i.nm_lang||'</li>');
				if prm_titulo = 'cd' and i.nm_lang = fun.ret_var('LANG_SYS') then
					htp.p('<li class="nohover readonly"><input type="text" style="width: 155px; padding-right: 5px;" value="'||ws_texto||'" readonly/>');
				else
					htp.p('<li class="nohover"><input type="text" style="width: 155px; padding-right: 5px;" onblur="" value="'||ws_texto||'" /><a class="fakelang mini" onclick="var valor = this.previousElementSibling.value.trim(); valor = valor.replace(/\&#039;/g, ''''); valor = valor.replace(/&#034;/g, ''''); if(valor.length > 1){ ajax(''fly'', ''update_language'', ''prm_valor=''+valor+''&prm_tabela='||ws_loop1||'&prm_coluna='||ws_loop2||'&prm_linguagem='||i.nm_lang||'&prm_default=''+document.getElementById(''default-local'').getAttribute(''data-value'')+''&prm_tipo='||ws_tipo||''', false); noerror('''', ''Tradu&ccedil;&atilde;o alterada com sucesso!'', ''msg''); if(document.getElementById(''user-language'').value == '''||i.nm_lang||'''){ if(document.getElementById('''||prm_ident||''').tagName == ''INPUT''){ document.getElementById('''||prm_ident||''').value = valor; } else { document.getElementById('''||prm_ident||''').innerHTML = valor; }} if('''||i.nm_lang||''' == '''||fun.ret_var('LANG_SYS')||'''){ document.getElementById('''||prm_ident||''').title = valor; document.getElementById(''default-local'').setAttribute(''data-value'', valor);} }">v</a>');
				end if;
				if ws_fixa = 'S' then
					htp.p('<input title="'||fun.lang('Fixar')||'" style="margin-left: 4px;" onchange="checkFix(''check'', this, '''||ws_loop1||''', '''||ws_loop2||''', '''||i.nm_lang||''', document.getElementById(''default-local'').getAttribute(''data-value''), '''||ws_tipo||''');" type="checkbox" checked/>');
				end if;
				if ws_fixa = 'N' then
					htp.p('<input title="'||fun.lang('Fixar')||'" style="margin-left: 4px;" onchange="checkFix(''check'', this, '''||ws_loop1||''', '''||ws_loop2||''', '''||i.nm_lang||''', document.getElementById(''default-local'').getAttribute(''data-value''), '''||ws_tipo||''');" type="checkbox" />');
				end if;
				htp.p('</li>');
			end loop;
			exception when others then
			htp.p('Language '||sqlerrm);
			end;
		elsif trim(prm_campo) = 'agrupadores' then
			htp.p('<li class="fixed">'||fun.lang('Agrupadores permitidos')||'</li>');
			for i in(select cd_coluna,nm_rotulo from micro_coluna mc where cd_micro_visao = prm_visao and st_agrupador <> 'SEM' and cd_coluna not in(select cd_coluna from column_restriction cr where cr.cd_coluna = mc.cd_coluna and usuario = ws_usuario and cr.cd_micro_visao = prm_visao)) loop
				ws_count := 0;
				for b in(select column_value from table(fun.vpipe((select propriedade from object_attrib where cd_object = prm_ident and cd_prop = 'AGRUPADORES')))) loop
					if b.column_value = i.cd_coluna then
						ws_count := ws_count+1;
					end if;
				end loop;
				if ws_count > 0 then
					htp.p('<li id="'||i.cd_coluna||'_linha" data-valor="'||i.cd_coluna||'" class="green" onclick="document.getElementById('''||i.cd_coluna||'_linha'').classList.toggle(''green''); var agrupadores = ''''; var selecionados = this.parentNode.querySelectorAll(''.green''); for(a=0;a<selecionados.length;a++){ agrupadores = agrupadores+''|''+selecionados[a].getAttribute(''data-valor''); } if(this.className != ''green''){ ajax(''fly'', ''alter_agrupadores'', ''prm_objeto='||prm_ident||'&prm_agrupadores=''+agrupadores+''&prm_tipo=AGRUPADORES'', false); noerror('''', ''Coluna bloqueada!'', ''msg''); } else { ajax(''fly'', ''alter_agrupadores'', ''prm_objeto='||prm_ident||'&prm_agrupadores=''+agrupadores+''&prm_tipo=AGRUPADORES'', false); noerror('''', ''Coluna desbloqueada!'', ''msg''); }" title="'||i.cd_coluna||'">'||i.nm_rotulo||'</li>');
				else
					htp.p('<li id="'||i.cd_coluna||'_linha" data-valor="'||i.cd_coluna||'" class="" onclick="document.getElementById('''||i.cd_coluna||'_linha'').classList.toggle(''green''); var agrupadores = ''''; var selecionados = this.parentNode.querySelectorAll(''.green''); for(a=0;a<selecionados.length;a++){ agrupadores = agrupadores+''|''+selecionados[a].getAttribute(''data-valor''); } if(this.className != ''green''){ ajax(''fly'', ''alter_agrupadores'', ''prm_objeto='||prm_ident||'&prm_agrupadores=''+agrupadores+''&prm_tipo=AGRUPADORES'', false); noerror('''', ''Coluna bloqueada!'', ''msg''); } else { ajax(''fly'', ''alter_agrupadores'', ''prm_objeto='||prm_ident||'&prm_agrupadores=''+agrupadores+''&prm_tipo=AGRUPADORES'', false); noerror('''', ''Coluna desbloqueada!'', ''msg''); }" title="'||i.cd_coluna||'">'||i.nm_rotulo||'</li>');
				end if;
			end loop;
		elsif trim(prm_campo) = 'visivel' then
			htp.p('<li>'||fun.lang('Colunas invis&iacute;veis')||'</li>');
			select tp_objeto into ws_tp_obj from objetos where cd_objeto = prm_ident; 

			if ws_tp_obj in ('COLUNAS', 'BARRAS', 'LINHAS', 'SANKEY','SCATTER', 'RADAR', 'CALENDARIO') then 
				select cs_agrupador into ws_colunas_obj from ponto_avaliacao where cd_ponto  = prm_ident; 
				ws_screen      := prm_ref;  			
				ws_prop := fun.getprop(prm_ident, 'VISIVEL', ws_screen, ws_usuario);
			else
				select cs_coluna||'|'||cs_agrupador into ws_colunas_obj from ponto_avaliacao where cd_ponto  = prm_ident; 	
				ws_screen := ''; 
				ws_prop   := fun.getprop(prm_ident, 'VISIVEL');
			end if;	

			select listagg(formula,'|') within group (order by formula) into ws_colunas_tpt  
			  from micro_coluna 
             where cd_micro_visao = prm_visao
               and st_agrupador   = 'TPT'
			   and cd_coluna in (select column_value from table(fun.vpipe((ws_colunas_obj))))
               and formula is not null ;

			for i in(select 0 ordem, UPPER(nm_rotulo) ordem2, cd_coluna, nm_rotulo from micro_coluna mc   --  Colunas não template 
			          where cd_micro_visao = prm_visao  
					    and cd_coluna not in(select cd_coluna from column_restriction cr where cr.cd_coluna = mc.cd_coluna and usuario = ws_usuario and cr.cd_micro_visao = prm_visao) 
						and cd_coluna in (select column_value from table(fun.vpipe((ws_colunas_obj))))
						and st_agrupador  <> 'TPT'
					union 
					 select 1 ordem, UPPER(nm_rotulo) ordem2, cd_coluna, nm_rotulo from micro_coluna mc -- colunas de templates 
			          where cd_micro_visao = prm_visao  
					    and cd_coluna not in(select cd_coluna from column_restriction cr where cr.cd_coluna = mc.cd_coluna and usuario = ws_usuario and cr.cd_micro_visao = prm_visao) 
						and cd_coluna in (select column_value from table(fun.vpipe((ws_colunas_tpt)))) 
					 order by 1, 2
					) loop
				ws_count := 0;
				for b in(select column_value from table(fun.vpipe((ws_prop)))) loop
					if b.column_value = i.cd_coluna then
						ws_count := ws_count+1;
					end if;
				end loop;
				if ws_count <> 0 then
					ws_class := 'green'; 
				else 
					ws_class := ''; 
				end if;				
				htp.p('<li id="'||i.cd_coluna||'_linha" data-valor="'||i.cd_coluna||'" class="'||ws_class||'" onclick="document.getElementById('''||i.cd_coluna||'_linha'').classList.toggle(''green''); var agrupadores = ''''; var selecionados = this.parentNode.querySelectorAll(''.green''); for(a=0;a<selecionados.length;a++){ agrupadores = agrupadores+''|''+selecionados[a].getAttribute(''data-valor''); } if(this.className != ''green''){ ajax(''fly'', ''alter_agrupadores'', ''prm_objeto='||prm_ident||'&prm_agrupadores=''+agrupadores+''&prm_tipo=VISIVEL&prm_screen='||ws_screen||''', false); noerror('''', ''Coluna desbloqueada!'', ''msg''); } else { ajax(''fly'', ''alter_agrupadores'', ''prm_objeto='||prm_ident||'&prm_agrupadores=''+agrupadores+''&prm_tipo=VISIVEL&prm_screen='||ws_screen||''', false); noerror('''', ''Coluna bloqueada!'', ''msg''); }" title="'||i.nm_rotulo||'">'||i.nm_rotulo||'</li>');

			end loop;
			
		elsif trim(prm_campo) = 'limitadores' then
			htp.p('<li>'||fun.lang('Valores bloqueados')||'</li>');
			begin
				select nds_cd_codigo, nds_tfisica, nds_cd_descricao into ws_loop1, ws_loop2, ws_loop3 from CODIGO_DESCRICAO where (upper(nds_tabela) = upper(prm_visao) or upper(nds_tfisica) = upper(prm_visao)) and rownum = 1;
				ws_sql := 'select '||trim(ws_loop1)||', '||trim(ws_loop3)||' from '||nvl(fun.ret_var('OWNER_TABLE_DATA'),'DWU')||'.'||trim(ws_loop2)||'';
				ws_cursor := dbms_sql.open_cursor;
				dbms_sql.parse(ws_cursor, ws_sql, DBMS_SQL.NATIVE);
				dbms_sql.define_column(ws_cursor, 1, ws_codigo, 200);
				dbms_sql.define_column(ws_cursor, 2, ws_descricao, 200);

				ws_linhas := dbms_sql.execute(ws_cursor);

				loop

					ws_linhas := dbms_sql.fetch_rows(ws_cursor);
					if ws_linhas <> 1 then
						exit;
					end if;

					dbms_sql.column_value(ws_cursor, 1, ws_codigo);
					dbms_sql.column_value(ws_cursor, 2, ws_descricao);
					ws_count := 0;
					select count(*) into ws_count from table(fun.vpipe((select propriedade from object_attrib where cd_prop = 'LIMITADORES' and cd_object = prm_ident))) where column_value = ws_codigo;

					if ws_count > 0 then
						htp.p('<li id="'||ws_codigo||'_linha" data-valor="'||ws_codigo||'" class="green" onclick="document.getElementById('''||ws_codigo||'_linha'').classList.toggle(''green''); var agrupadores = ''''; var selecionados = this.parentNode.querySelectorAll(''.green''); for(a=0;a<selecionados.length;a++){ agrupadores = agrupadores+''|''+selecionados[a].getAttribute(''data-valor''); } if(this.className != ''green''){ ajax(''fly'', ''alter_agrupadores'', ''prm_objeto='||prm_ident||'&prm_agrupadores=''+agrupadores+''&prm_tipo=LIMITADORES'', false); noerror('''', ''Coluna bloqueada!'', ''msg''); } else { ajax(''fly'', ''alter_agrupadores'', ''prm_objeto='||prm_ident||'&prm_agrupadores=''+agrupadores+''&prm_tipo=LIMITADORES'', false); noerror('''', ''Coluna desbloqueada!'', ''msg''); }" title="'||ws_descricao||'">'||ws_descricao||'</li>');
					else
						htp.p('<li id="'||ws_codigo||'_linha" data-valor="'||ws_codigo||'" class="" onclick="document.getElementById('''||ws_codigo||'_linha'').classList.toggle(''green''); var agrupadores = ''''; var selecionados = this.parentNode.querySelectorAll(''.green''); for(a=0;a<selecionados.length;a++){ agrupadores = agrupadores+''|''+selecionados[a].getAttribute(''data-valor''); } if(this.className != ''green''){ ajax(''fly'', ''alter_agrupadores'', ''prm_objeto='||prm_ident||'&prm_agrupadores=''+agrupadores+''&prm_tipo=LIMITADORES'', false); noerror('''', ''Coluna bloqueada!'', ''msg''); } else { ajax(''fly'', ''alter_agrupadores'', ''prm_objeto='||prm_ident||'&prm_agrupadores=''+agrupadores+''&prm_tipo=LIMITADORES'', false); noerror('''', ''Coluna desbloqueada!'', ''msg''); }" title="'||ws_descricao||'">'||ws_descricao||'</li>');
					end if;

				end loop;
				dbms_sql.close_cursor(ws_cursor);
			exception when others then
				htp.p(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - '||ws_sql);
			end;
		
		/* desabilitado, essa condição já existe acima, deve ter sido feito uma cópia e não utilizado 	
		elsif trim(prm_campo) = 'visivel' then
			htp.p('<li class="fixed">'||fun.lang('Colunas invis&iacute;veis')||'</li>');
			for i in(select cd_coluna,nm_rotulo from micro_coluna mc where cd_micro_visao = prm_visao  and cd_coluna not in(select cd_coluna from column_restriction cr where cr.cd_coluna = mc.cd_coluna and usuario = ws_usuario and cr.cd_micro_visao = prm_visao) and cd_coluna in(select column_value from table(fun.vpipe((select cs_coluna||'|'||cs_agrupador from ponto_avaliacao where cd_ponto = prm_ident))))) loop
				ws_count := 0;
				for b in(select column_value from table(fun.vpipe((select propriedade from object_attrib where cd_object = prm_ident and cd_prop = 'VISIVEL')))) loop
					if b.column_value = i.cd_coluna then
						ws_count := ws_count+1;
					end if;
				end loop;
				if ws_count <> 0 then
					htp.p('<li id="'||i.cd_coluna||'_linha" data-valor="'||i.cd_coluna||'" class="green" onclick="document.getElementById('''||i.cd_coluna||'_linha'').classList.toggle(''green''); var agrupadores = ''''; var selecionados = this.parentNode.querySelectorAll(''.green''); for(a=0;a<selecionados.length;a++){ agrupadores = agrupadores+''|''+selecionados[a].getAttribute(''data-valor''); } if(this.className != ''green''){ ajax(''fly'', ''alter_agrupadores'', ''prm_objeto='||prm_ident||'&prm_agrupadores=''+agrupadores+''&prm_tipo=VISIVEL'', false); noerror('''', ''Coluna bloqueada!'', ''msg''); } else { ajax(''fly'', ''alter_agrupadores'', ''prm_objeto='||prm_ident||'&prm_agrupadores=''+agrupadores+''&prm_tipo=VISIVEL'', false); noerror('''', ''Coluna desbloqueada!'', ''msg''); }" title="'||i.nm_rotulo||'">'||i.nm_rotulo||'</li>');
				else
					htp.p('<li id="'||i.cd_coluna||'_linha" data-valor="'||i.cd_coluna||'" class="" onclick="document.getElementById('''||i.cd_coluna||'_linha'').classList.toggle(''green''); var agrupadores = ''''; var selecionados = this.parentNode.querySelectorAll(''.green''); for(a=0;a<selecionados.length;a++){ agrupadores = agrupadores+''|''+selecionados[a].getAttribute(''data-valor''); } if(this.className != ''green''){ ajax(''fly'', ''alter_agrupadores'', ''prm_objeto='||prm_ident||'&prm_agrupadores=''+agrupadores+''&prm_tipo=VISIVEL'', false); noerror('''', ''Coluna bloqueada!'', ''msg''); } else { ajax(''fly'', ''alter_agrupadores'', ''prm_objeto='||prm_ident||'&prm_agrupadores=''+agrupadores+''&prm_tipo=VISIVEL'', false); noerror('''', ''Coluna desbloqueada!'', ''msg''); }" title="'||i.nm_rotulo||'">'||i.nm_rotulo||'</li>');
				end if;
			end loop;
		*************/ 

		elsif trim(prm_campo) = 'coluna-add' then

			case prm_titulo 
			when 'coluna' then
				htp.p('<li>COLUNA</li>');
				for a in (select distinct(cd_coluna), nm_rotulo from micro_coluna where (st_agrupador = 'SEM' or st_agrupador = 'EXT') and nvl(nm_rotulo, 'n/a') <> 'n/a' and cd_micro_visao = prm_visao and cd_coluna not in (select nvl(COLUMN_VALUE, 'n/a') as cd_coluna from table(fun.vpipe((prm_ident)))) order by nm_rotulo) loop
					htp.p('<li title="'||a.cd_coluna||'" onclick="blocoConsulta(this, ''coluna'');">'||a.nm_rotulo||'</li>');
				end loop;
			when 'colunaa' then
				htp.p('<li>OUTROS OBJETOS</li>');
				for a in (select distinct(cd_coluna), nm_rotulo from micro_coluna where st_agrupador = 'SEM' and nvl(nm_rotulo, 'n/a') <> 'n/a' and cd_micro_visao = prm_visao and cd_coluna not in (select nvl(COLUMN_VALUE, 'n/a') as cd_coluna from table(fun.vpipe((prm_ident)))) order by nm_rotulo) loop
					htp.p('<li title="'||a.cd_coluna||'" onclick="blocoConsulta(this);">'||a.nm_rotulo||'</li>');
				end loop;
			when 'group' then
				htp.p('<li>COLUNAS</li>');
				for b in (select distinct(cd_coluna), nm_rotulo from micro_coluna where (st_agrupador = 'SEM' or st_agrupador = 'EXT')  and nvl(nm_rotulo, 'n/a') <> 'n/a' and cd_micro_visao = prm_visao and cd_coluna not in (select nvl(COLUMN_VALUE, 'n/a') as cd_coluna from table(fun.vpipe((prm_ident)))) order by nm_rotulo) loop
					htp.p('<li title="'||b.cd_coluna||'" onclick="blocoConsulta(this, ''colunas'');">'||b.nm_rotulo||'</li>');
				end loop;
			when 'group-template' then
				htp.p('<li>COLUNAS</li>');
				for b in (select distinct(cd_coluna), nm_rotulo from micro_coluna where (st_agrupador <> 'SEM' AND st_agrupador <> 'TPT') and nvl(nm_rotulo, 'n/a') <> 'n/a' and cd_micro_visao = prm_visao and cd_coluna not in (select nvl(COLUMN_VALUE, 'n/a') as cd_coluna from table(fun.vpipe((prm_ident)))) order by nm_rotulo) loop
					htp.p('<li title="'||b.cd_coluna||'" onclick="this.style.setProperty(''display'', ''none''); var bloco = document.querySelector(''.medida''); var li = document.createElement(''li''); var span = document.createElement(''span''); span.innerHTML = ''X''; li.className = ''linha''; li.title=this.title; li.innerHTML = this.innerHTML; li.appendChild(span); li.setAttribute(''onclick'', ''swapColumn(this)''); li.style.setProperty(''margin'', ''3px auto''); bloco.appendChild(li); var square = document.createElement(''li''); square.className = ''square''; square.setAttribute(''onclick'', ''swapSquare(this)''); bloco.appendChild(square); var valores = document.querySelector(''.medida'').querySelectorAll(''.linha''); saveTpt(document.querySelector(''.medida''), '''||prm_visao||''', '''||prm_ref||''');">'||B.CD_COLUNA||' - '||B.NM_ROTULO||'</li>');
				end loop;
			else
				htp.p('<li>AGRUPADOR</li>');
				for i in (select distinct(cd_coluna), nm_rotulo from micro_coluna where (st_agrupador <> 'SEM' OR st_agrupador = 'TPT') and nvl(nm_rotulo, 'n/a') <> 'n/a' and cd_micro_visao = prm_visao and cd_coluna not in (select nvl(COLUMN_VALUE, 'n/a') as cd_coluna from table(fun.vpipe((prm_ident)))) order by nm_rotulo) loop
					htp.p('<li title="'||i.cd_coluna||'" onclick="blocoConsulta(this, ''colunac'');">'||i.nm_rotulo||'</li>');
				end loop;
			end case;
		elsif trim(prm_campo) = 'browser-permissao' then
			htp.p('<li>'||fun.lang('PERMISS&Atilde;O DE ESCRITA')||'</li>');
			begin
				select permissao into ws_sql from data_coluna where cd_micro_data = prm_ident and cd_coluna = prm_titulo order by permissao;
				for i in ( select usu_completo, usu_nome from usuarios order by usu_nome ) loop
					begin
						select column_value into ws_texto from table(fun.vpipe((ws_sql))) where column_value = i.usu_nome;
					exception when others then
						ws_texto := 'R'; 
					end;
					if ws_texto = 'R' then
						htp.p('<li id="'||i.usu_nome||'_linha" class="" onclick="this.classList.toggle(''green''); var lista = this.parentNode.querySelectorAll(''.green''); var arrl = []; for(i=0;i<lista.length;i++){ arrl.push(lista[i].innerHTML); } call(''browser_permissao'', ''prm_micro_data='||prm_ident||'&prm_coluna='||prm_titulo||'&prm_valor=''+arrl.join(''|''), ''BRO'').then(function(resposta){ console.log(''ok''); });" title="'||i.usu_completo||'">'||i.usu_nome||'</li>');
					else
						htp.p('<li id="'||i.usu_nome||'_linha" class="green" onclick="this.classList.toggle(''green''); var lista = this.parentNode.querySelectorAll(''.green''); var arrl = []; for(i=0;i<lista.length;i++){ arrl.push(lista[i].innerHTML); } call(''browser_permissao'', ''prm_micro_data='||prm_ident||'&prm_coluna='||prm_titulo||'&prm_valor=''+arrl.join(''|''), ''BRO'').then(function(resposta){ console.log(''ok''); });" title="'||i.usu_completo||'">'||i.usu_nome||'</li>');
					end if;
				end loop;
			end;
		elsif trim(prm_campo) = 'browser-permissao-geral' then
			htp.p('<li>'||fun.lang('BLOQUEIO DE A&Ccedil;&Otilde;ES')||'</li>');
			begin
				
				begin
					select propriedade into ws_sql from object_attrib where cd_object = prm_ident and cd_prop = 'PERMISSAO';
				exception when others then
					ws_sql := '';
				end;
				for i in ( select usu_completo, usu_nome from usuarios order by usu_nome ) loop
					begin
						select column_value into ws_texto from table(fun.vpipe((ws_sql))) where column_value = i.usu_nome;
					exception when others then
						ws_texto := 'R'; 
					end;
					if ws_texto = 'R' then
						htp.p('<li id="'||i.usu_nome||'_linha" class="" onclick="this.classList.toggle(''green''); var lista = this.parentNode.querySelectorAll(''.green''); var arrl = []; for(i=0;i<lista.length;i++){ arrl.push(lista[i].innerHTML); } call(''alter_attrib'', ''prm_objeto='||prm_ident||'&prm_prop=PERMISSAO&prm_value=''+arrl.join(''|'')+''&prm_usuario=DWU'', ''FCL'').then(function(resposta){ console.log(''ok''); });" title="'||i.usu_completo||'">'||i.usu_nome||'</li>');
					else
						htp.p('<li id="'||i.usu_nome||'_linha" class="green" onclick="this.classList.toggle(''green''); var lista = this.parentNode.querySelectorAll(''.green''); var arrl = []; for(i=0;i<lista.length;i++){ arrl.push(lista[i].innerHTML); } call(''alter_attrib'', ''prm_objeto='||prm_ident||'&prm_prop=PERMISSAO&prm_value=''+arrl.join(''|'')+''&prm_usuario=DWU'', ''FCL'').then(function(resposta){ console.log(''ok''); });" title="'||i.usu_completo||'">'||i.usu_nome||'</li>');
					end if;
				end loop;
			exception when others then
				htp.p(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
			end;
		elsif trim(prm_campo) = 'colunabrowser' then
			htp.p('<li class="fixed">'||fun.lang('COLUNAS DISPONIVEIS')||'</li>');

			htp.p('<li style="white-space: nowrap;"><input id="filter-value" placeholder="'||fun.lang('Digite para buscar ou inserir')||'" type="text" style="width: 180px; max-width: 180px;" onkeyup="if(this.value.trim().length < 1){ var valor = ''all'' } else { var valor = this.value.trim(); } ajax(''list'', ''fakedatalist'', ''prm_codigo=column_name&prm_descricao=column_name&prm_tabela='||prm_visao||'&prm_rownum=&prm_text=''+valor, true, ''fake_ajax'');" />');
			htp.p('<a title="'||fun.lang('Adicionar')||'" class="add" onclick="var span = document.getElementById(''fake_datalist''); var valor = this.previousElementSibling.value.trim(); span.title = valor; span.innerHTML = valor; document.getElementById(''fakelist'').className = '''';">+</a></li>');

		htp.p('<ul id="fake_ajax">');

		begin
			ws_sql := 'select column_name from all_tab_columns where table_name = '''||prm_visao||''' and column_name not in (select cd_coluna from data_coluna where cd_micro_data = '''||prm_ident||''')';

			ws_cursor := dbms_sql.open_cursor;

			dbms_sql.parse(ws_cursor, ws_sql, DBMS_SQL.NATIVE);

			dbms_sql.define_column(ws_cursor, 1, ws_codigo, 200);

			ws_linhas := dbms_sql.execute(ws_cursor);

			loop
				if dbms_sql.fetch_rows(ws_cursor) = 0 then
					exit;
				end if;

				dbms_sql.column_value(ws_cursor, 1, ws_codigo);

				htp.p('<li onclick="fakeValue(''fake_datalist'', this);" title="'||trim(ws_codigo)||'">'||trim(ws_codigo)||'</li>');

			end loop;

			dbms_sql.close_cursor(ws_cursor);
			exception when others then
			htp.p(ws_sql||' # '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
			end;

		htp.p('</ul>');

		elsif trim(prm_campo) = 'browserdatalist' then
			htp.p('<li class="fixed">'||ws_titulo||'</li>');

				htp.p('<li style="white-space: nowrap;"><input id="filter-value" type="text" style="width: 180px; max-width: 180px;" />');
				htp.p('<a title="'||fun.lang('Adicionar')||'" class="add" onclick="var span = document.getElementById(''fake_datalist''); var valor = this.previousElementSibling.value.trim(); span.title = valor; span.innerHTML = valor; document.getElementById(''fakelist'').className = '''';">+</a></li>');
				select nm_tabela into ws_loop3 from micro_data where nm_micro_data = prm_visao;
				begin
					select trim(nds_tfisica) into ws_loop2 from CODIGO_DESCRICAO where nds_tabela = ws_loop3;
					if length(ws_loop2) = 0 then
						ws_loop2 := ws_loop3;
					end if;
				exception when others then
					ws_loop2 := ws_loop3;
				end;

				ws_sql := 'select distinct '||prm_ident||'  from '||nvl(fun.ret_var('OWNER_TABLE_DATA'),'DWU')||'.'||ws_loop2||' order by '||prm_ident||'';

				begin

				htp.p('<ul id="fake_ajax">');

					ws_cursor := dbms_sql.open_cursor;

					dbms_sql.parse(ws_cursor, ws_sql, DBMS_SQL.NATIVE);

					dbms_sql.define_column(ws_cursor, 1, ws_codigo, 200);
					ws_linhas := dbms_sql.execute(ws_cursor);

					loop
						if dbms_sql.fetch_rows(ws_cursor) = 0 then
							exit;
						end if;
						ws_count := dbms_sql.last_row_count;
						select cd_ligacao into ws_loop1 from data_coluna where cd_coluna = prm_ident and cd_micro_data = prm_visao;
						dbms_sql.column_value(ws_cursor, 1, ws_codigo);
						if trim(ws_codigo) = fun.cdesc(trim(ws_codigo), ws_loop1) then
							htp.p('<li onclick="fakeValue(''fake_datalist'', this);" title="'||trim(ws_codigo)||'">'||trim(ws_codigo)||'</li>');
						else
							htp.p('<li onclick="fakeValue(''fake_datalist'', this);" title="'||trim(ws_codigo)||'">'||trim(ws_codigo)||' - '||fun.cdesc(trim(ws_codigo), ws_loop1)||'</li>');
						end if;
					end loop;

					dbms_sql.close_cursor(ws_cursor);

				htp.p('</ul>');

				exception when others then
					htp.p(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||'  -  '||ws_sql);
				end;

		elsif trim(prm_campo) = 'datalist' then
			htp.p('<li class="fixed">'||ws_titulo||'</li>');

			select cd_ligacao into ws_loop1 from micro_coluna where cd_coluna = prm_ident and cd_micro_visao = prm_visao;

			if ws_loop1 <> 'SEM' then

			select nds_tfisica, nds_cd_codigo, nds_cd_descricao into prm_tabela, prm_codigo, prm_descricao from codigo_descricao where nds_tabela = ws_loop1;

			htp.p('<li style="white-space: nowrap;"><input id="filter-value" placeholder="'||fun.lang('no m&iacute;nimo 3 caracteres para buscar')||'" type="text" style="width: 180px; max-width: 180px;" onkeyup="if(this.value.trim().length > 2 || this.value.trim().length == 0){ ajax(''list'', ''fakedatalist'', ''prm_codigo='||prm_codigo||'&prm_descricao='||prm_descricao||'&prm_tabela='||prm_tabela||'&prm_rownum=&prm_text=''+this.value.trim(), true, ''fake_ajax'');} checkPar(this.id, '''||prm_visao||''');" />');
			htp.p('<a title="'||fun.lang('Adicionar')||'" class="add" onclick="var span = document.getElementById(''fake_datalist''); var valor = this.previousElementSibling.value.trim(); span.title = valor; span.innerHTML = valor; document.getElementById(''fakelist'').className = '''';">+</a></li>');

				ws_loop3 := '51';

				ws_sql := 'select '||prm_codigo||', '||prm_descricao||', linha from (select '||prm_codigo||', '||prm_descricao||', rownum as linha from (select /*+ FIRST_ROWS(50) */ '||prm_codigo||', '||prm_descricao||' from '||nvl(fun.ret_var('OWNER_TABLE_DATA'),'DWU')||'.'||prm_tabela||' order by '||prm_descricao||' asc)) where linha < '||ws_loop3||'';

				begin

				htp.p('<ul id="fake_ajax">');

					ws_cursor := dbms_sql.open_cursor;

					dbms_sql.parse(ws_cursor, ws_sql, DBMS_SQL.NATIVE);

					dbms_sql.define_column(ws_cursor, 1, ws_codigo, 200);
					dbms_sql.define_column(ws_cursor, 2, ws_descricao, 200);
					ws_linhas := dbms_sql.execute(ws_cursor);

					loop
						if dbms_sql.fetch_rows(ws_cursor) = 0 THEN
							exit;
						end if;
						ws_count := dbms_sql.last_row_count;
						dbms_sql.column_value(ws_cursor, 1, ws_codigo);
						dbms_sql.column_value(ws_cursor, 2, ws_descricao);
						htp.p('<li onclick="fakeValue(''fake_datalist'', this);" title="'||trim(ws_codigo)||'">'||trim(ws_descricao)||'</li>');
					end loop;

					dbms_sql.close_cursor(ws_cursor);

					if ws_count = 50 then
						htp.p('<li style="font-weight: bold !important; text-align: center !important;" id="load-more" class="link" title="'||fun.lang('Carregar mais 50')||'" onclick="remover(''load-more'', ''r''); var numero = parseInt(document.getElementById(''fake_ajax'').children.length)+50; ajax(''main'', ''fakedatalist'', ''prm_codigo='||prm_codigo||'&prm_descricao='||prm_descricao||'&prm_tabela='||prm_tabela||'&prm_rownum=''+numero+''&prm_text=N/A&prm_ref='||prm_ref||''', true, ''fake_ajax'');">'||fun.lang('carregar')||' mais 50</li>');
					end if;
				htp.p('</ul>');

				exception when others then
					htp.p(DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||'  -  '||ws_sql);
				end;

			else
				htp.p('<li style="white-space: nowrap;"><input type="text" style="width: 180px; max-width: 180px;" />');
				htp.p('<a title="'||fun.lang('Adicionar')||'" class="add" onclick="var span = document.getElementById(''fake_datalist''); var valor = this.previousElementSibling.value.trim(); span.title = valor; span.innerHTML = valor; document.getElementById(''fakelist'').className = '''';">+</a></li>');
			end if;

		elsif trim(prm_campo) = 'consultas' then
			htp.p('<li>CONSULTAS</li>');
				for b in (select cd_objeto, nm_objeto, (select cd_micro_visao from ponto_avaliacao where cd_ponto = cd_objeto and rownum = 1) as visao from objetos where tp_objeto = 'CONSULTA' order by nm_objeto asc) loop
					htp.p('<li title="'||b.cd_objeto||'" onclick=" if(document.getElementById(''id_CHAMADA1'')){ document.getElementById(''id_CHAMADA1'').value = this.title; } if(document.getElementById(''id_CHAMADA2'')){ document.getElementById(''id_CHAMADA2'').value = this.title; } document.getElementById('''||prm_ident||''').title = this.title; document.getElementById('''||prm_ident||''').innerHTML = this.innerHTML;">'||b.nm_objeto||' / '||b.visao||'</li>');
				end loop;

		elsif trim(prm_campo) = 'sinais' then
			htp.p('<li class="fixed">'||ws_titulo||'</li>');

			htp.p('<li>');
				htp.p(''||fun.lang('Imagem')||': <select class="p_tp_sinal" onchange=" document.getElementById(''sin1'').src='''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download?arquivo=ind''+this.options[this.selectedIndex].value+''_1.png''; document.getElementById(''sin2'').src='''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download?arquivo=ind''+this.options[this.selectedIndex].value+''_2.png''; document.getElementById(''sin3'').src='''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download?arquivo=ind''+this.options[this.selectedIndex].value+''_3.png''; document.getElementById(''sin4'').src='''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download?arquivo=ind''+this.options[this.selectedIndex].value+''_4.png''; document.getElementById(''sin5'').src='''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download?arquivo=ind''+this.options[this.selectedIndex].value+''_5.png'';" >');
					fcl.numericOptions(9);
				htp.p('</select>');
			htp.p('</li>');

			htp.p('<li>');
				htp.p('<img src="'||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download?arquivo=ind1_1.png" />');
				htp.p('<input type="text" value="" size="30" maxlength="80" >');
			htp.p('</li>');

			htp.p('<li>');
				htp.p('<img src="'||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download?arquivo=ind1_2.png" />');
				htp.p('<input type="text" value="" size="30" maxlength="80" >');
			htp.p('</li>');

			htp.p('<li>');
				htp.p('<img src="'||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download?arquivo=ind1_3.png" />');
				htp.p('<input type="text" value="" size="30" maxlength="80" >');
			htp.p('</li>');

			htp.p('<li>');
				htp.p('<img src="'||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download?arquivo=ind1_4.png" />');
				htp.p('<input type="text" value="" size="30" maxlength="80" >');
			htp.p('</li>');

			htp.p('<li>');
				htp.p('<img src="'||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download?arquivo=ind1_5.png" />');
				htp.p('<input type="text" value="" size="30" maxlength="80" >');
			htp.p('</li>');

		elsif trim(prm_campo) = 'screengroup' then
			
			for i in(select distinct cd_grupo from objetos where tp_objeto='SCREEN' and cd_grupo in (select cd_grupo from objetos where cd_objeto in (select screen from user_screens where usuario = user)) order by cd_grupo) loop
				htp.p('<li class="screeen group" onclick="fakeOption(''screenlist'', ''TABELAS'', ''screenlist'', '''||i.cd_grupo||''');">');
					htp.p('<span>'||lower(i.cd_grupo)||'</span>');
					htp.p('<svg class="down" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" 	 width="292.362px" height="292.362px" viewBox="0 0 292.362 292.362" style="enable-background:new 0 0 292.362 292.362;" 	 xml:space="preserve"> <g> 	<path d="M286.935,69.377c-3.614-3.617-7.898-5.424-12.848-5.424H18.274c-4.952,0-9.233,1.807-12.85,5.424 		C1.807,72.998,0,77.279,0,82.228c0,4.948,1.807,9.229,5.424,12.847l127.907,127.907c3.621,3.617,7.902,5.428,12.85,5.428 		s9.233-1.811,12.847-5.428L286.935,95.074c3.613-3.617,5.427-7.898,5.427-12.847C292.362,77.279,290.548,72.998,286.935,69.377z"/> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>'); 
				htp.p('</li>');
			end loop;

		elsif trim(prm_campo) = 'screenlist' then

			for i in(select cd_objeto, nm_objeto from objetos where cd_grupo = prm_ref and cd_objeto like ('SRC_%') and cd_objeto in (select screen from user_screens where usuario = ws_usuario)) loop
				htp.p('<li class="screeen">');
					htp.p('<span title="'||i.cd_objeto||'">'||lower(i.nm_objeto)||'</span>');
				htp.p('</li>');
			end loop;

		elsif trim(prm_campo) = 'filelist' then
			htp.p('<li>'||ws_titulo||'</li>');
			htp.p('<li style="white-space: nowrap;"><input placeholder="'||fun.lang('no m&iacute;nimo 3 caracteres para buscar')||'" type="text" style="width: 180px; max-width: 180px;" onkeyup="if(this.value.trim().length > 2 || this.value.trim().length == 0){ ajax(''list'', ''fakedatalist'', ''prm_codigo='||prm_codigo||'&prm_descricao='||prm_descricao||'&prm_tabela='||prm_tabela||'&prm_rownum=&prm_text=''+this.value, true, ''fake_ajax''); } " /><a title="'||fun.lang('Adicionar')||'" class="add" onclick="var span = document.getElementById(''fake_datalist''); var valor = this.previousElementSibling.value.trim(); span.title = valor; span.innerHTML = valor;">+</a></li>');

				htp.p('<ul id="fake_ajax">');
					htp.p('<li onclick="fakeValue(''fake_datalist'', this);" title="'||trim(ws_codigo)||'">'||trim(ws_descricao)||'</li>');
				htp.p('</ul>');
		elsif trim(prm_campo) = 'usuarios-tela' then
			
			htp.p('<li>'||fun.lang('USU&Aacute;RIOS')||'</li>');
			for i in (select usu_nome, usu_completo, (select count(*) from user_screens where usuario = trim(usu_nome) and screen = prm_ident ) as valid from usuarios order by usu_nome ) loop
				if i.valid = 1 then
					htp.p('<li id="'||i.usu_nome||'_linha" class="green" onclick=" if(this.className == ''green''){ ajax(''fly'', ''delete_screen_access'', ''prm_usuario='||trim(i.usu_nome)||'&prm_tela='||prm_ident||'''); noerror('''', ''Usu&aacute;rio removido com sucesso!'', ''msg''); } else { ajax(''fly'', ''add_screen_access'', ''prm_usuario='||trim(i.usu_nome)||'&prm_tela='||prm_ident||''', true); noerror('''', ''Usu&aacute;rio adicionado com sucesso!'', ''msg''); } document.getElementById('''||i.usu_nome||'_linha'').classList.toggle(''green'');" title="'||i.usu_completo||'">'||i.usu_nome||'</li>');
				else
					htp.p('<li id="'||i.usu_nome||'_linha" class="" onclick=" if(this.className != ''green''){ ajax(''fly'', ''add_screen_access'', ''prm_usuario='||trim(i.usu_nome)||'&prm_tela='||prm_ident||''', true); noerror('''', ''Usu&aacute;rio adicionado com sucesso!'', ''msg''); } else { ajax(''fly'', ''delete_screen_access'', ''prm_usuario='||trim(i.usu_nome)||'&prm_tela='||prm_ident||''', true); noerror('''', ''Usu&aacute;rio removido com sucesso!'', ''msg''); } document.getElementById('''||i.usu_nome||'_linha'').classList.toggle(''green'');" title="'||i.usu_completo||'">'||i.usu_nome||'</li>');
				end if;
			end loop;
			htp.p('<li onclick=""></li>');
		else

			select tp_objeto into ws_tipo_obj from objetos where cd_objeto = prm_ident;
			select label, cd_tipo, sufixo, script, validacao into ws_label, ws_cd_tipo, ws_sufixo, ws_script, ws_lista from bi_object_padrao where tp_objeto = ws_tipo_obj and cd_prop = prm_campo and rownum = 1; 
			if sql%notfound then 
			ws_cd_tipo := ' ';
			end if;   

			-- Fakelist com propriedades das colunas de valores 
			--
			if ws_cd_tipo like '%\_FO' escape '\' then 
				-- Monta a lista de colunas do objeto
				select cs_agrupador into ws_colunas from ponto_avaliacao where cd_ponto = prm_ident; 
				ws_prop := fun.getprop(prm_ident,prm_campo||'_N','DWU');
				if nvl(ws_prop,' ') <> ' ' then 
					ws_colunas := ws_colunas||'|'||ws_prop; 
				end if;    

				ws_lista_n := '$opc|.|Selecione coluna' ; 
				for c in (select column_value as cd_coluna from table(fun.vpipe(ws_colunas))) loop  
					if instr(ws_lista_n, '|'||c.cd_coluna) = 0 then 
						ws_lista_n := ws_lista_n||'|'||c.cd_coluna||'|'||c.cd_coluna;
					end if;  
				end loop;             

				--htp.p('<li class="fixed nohover">'||fun.lang('PROPRIEDADE POR COLUNAS')||'</li>');
				htp.p('<li class="fixed nohover">'||fun.lang(UPPER(ws_label))||'</li>');
				htp.p('<li style="text-align: center;" class="nohover"><a class="link" onclick="var linha = document.getElementById(''linha-dummy'').children[0].cloneNode(true); this.parentNode.parentNode.appendChild(linha); linha.children[0].className = ''prop_col_n''; linha.children[1].className = ''prop_col''; linha.children[2].className = ''remove''; ">'||fun.lang('ADICIONAR COLUNA')||'</a></li>');

				for i in (select column_value as valor, rownum as linha from table(fun.vpipe((fun.getprop(prm_ident,prm_campo,'DWU'))))) loop 
					select nvl(max(nome),'.') into ws_loop2 from(select column_value as nome, rownum as linha from table(fun.vpipe((fun.getprop(prm_ident, prm_campo||'_N','DWU'))))) where linha = i.linha;
					htp.p('<li style="width: 94%; margin-bottom: 8px;">');
						fcl.listbox(trim(prm_ident)||'_'||ws_sufixo, '', ws_script, nvl(ws_loop2,'.'), ws_lista_n, prm_campo, prm_ident, 'class="prop_col_n" style="max-width: 160px;" onblur="colunasPropriedades('''||prm_ident||''', '''||prm_campo||''', '''||'DWU'||''');" ');
						if ws_cd_tipo = 'LOCAL_FO' then 
							fcl.listbox(trim(prm_ident)||'_'||ws_sufixo, '', ws_script, i.valor, ws_lista,   prm_campo, prm_ident, 'class="prop_col" style="max-width: 85px;"  onblur="colunasPropriedades('''||prm_ident||''', '''||prm_campo||''', '''||'DWU'||''');" ');
						else 
						htp.p('<input class="prop_col" type="text" style="margin: 2px; max-width: 70px;" onblur="colunasPropriedades('''||prm_ident||''', '''||prm_campo||''', '''||'DWU'||''');" placeholder="'||fun.lang('Tamanho')||'" value="'||i.valor||'" >');
						end if;   
						htp.p('<a class="remove" onclick="if(confirm(TR_EX)){ this.parentNode.remove(); colunasPropriedades('''||prm_ident||''', '''||prm_campo||''', '''||'DWU'||'''); }">X</a>');
					htp.p('</li>');
				end loop;

				htp.p('<span class="invisible" id="linha-dummy"><li style="width: 94%; margin-bottom: 8px;">');
					--htp.p('<input class="prop_col_n" type="text" style="margin: 2px;" onblur="colunasPropriedades('''||prm_ident||''', '''||prm_campo||''', '''||'DWU'||''');" value="" placeholder="'||fun.lang('Nome coluna')||'" />');									
					fcl.listbox(trim(prm_ident)||'_'||ws_sufixo, '', ws_script, '.', ws_lista_n, prm_campo, prm_ident, 'class="prop_col_n" style="max-width: 160px;" onblur="colunasPropriedades('''||prm_ident||''', '''||prm_campo||''', '''||'DWU'||''');" ');
					if ws_cd_tipo = 'LOCAL_FO' then 
						fcl.listbox(trim(prm_ident)||'_'||ws_sufixo, '', ws_script, '', ws_lista,   prm_campo, prm_ident, 'class="prop_col" style="max-width: 85px;" onblur="colunasPropriedades('''||prm_ident||''', '''||prm_campo||''', '''||'DWU'||''');" ');
					else
						htp.p('<input class="prop_col" type="text" style="margin: 2px; max-width: 70px;" onblur="colunasPropriedades('''||prm_ident||''', '''||prm_campo||''', '''||'DWU'||''');" placeholder="'||fun.lang('Tamanho')||'" value="" >');
					end if;   
					htp.p('<a class="remove" onclick="if(confirm(TR_EX)){ this.parentNode.remove(); colunasPropriedades('''||prm_ident||''', '''||prm_campo||''', '''||'DWU'||'''); }">X</a>');
				htp.p('</li></span>');
			else 
				htp.p('<li>'||ws_titulo||'</li>');
				for i in (select cd_mascara, ds_mascara from mascaras order by cd_mascara desc ) loop
					htp.p('<li onclick="fakeValue('''||prm_ident||''', this);" title="'||i.ds_mascara||'">'||i.cd_mascara||'</li>');
				end loop;
			end if;	
		end if;
		htp.p('</ul>');


		if trim(prm_campo) = 'lang' then
			htp.p('</div>');
			fcl.closer_menu;
		end if;

exception
	when ws_nouser then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end fakelist;


procedure fakelistoptions ( prm_ident     varchar2 default null,
							prm_campo     varchar2 default null,
							prm_visao     varchar2 default null,
							prm_ref       varchar2 default null,
							prm_adicional varchar2 default null,
							prm_search    varchar2 default null,
							prm_obj		  varchar2 default null ) as

	ws_count         number;
	ws_selected      number;
	ws_reverse       number;
	ws_cursor        integer;
	ws_linhas        integer;
	ws_check         varchar2(80);	
	ws_check2        varchar2(80);
	ws_order         varchar2(80);
	ws_grupo         varchar2(40);
	ws_tabela        varchar2(80);
	ws_codigo        varchar2(80);
	ws_limitador     varchar2(2000);
	ws_descricao     varchar2(2000);
	ws_ligacao       varchar2(2000);
	ws_sql           varchar2(32000);
	ws_search        varchar2(2000);
	ws_acumulado     varchar2(32000);
	ws_erro          varchar2(4000);
	ws_class         varchar2(400);
	ws_value         varchar2(400);
	ws_rotulo        varchar2(2000);
	ws_encadeado         varchar2(2000);
	ws_encadeado_col     varchar2(2000);
	ws_encadeado_ger     varchar2(2000);
	ws_encadeado_col_ger varchar2(2000);
	ws_conteudo      varchar2(32000);
	ws_usuario       varchar2(80);
	ws_admin         varchar2(80);
	ws_padrao        varchar2(80) := 'PORTUGUESE';
	ws_cd_obj_custom varchar2(50);
	ws_selected_txt  varchar2(20); 
	ws_col           varchar2(100);
	ws_tp_filtro_enca  varchar2(100);
	ws_col_cod         varchar2(200); 
	ws_screen          varchar2(200); 
	ws_sel_primeiros   varchar2(10); 
	ws_col_selecionado varchar2(4000);
	ws_selecionado     varchar2(10); 
	ws_cd_obj          varchar2(100); 
	ws_tp_obj          varchar2(100); 
	ws_limite          number; 
	ws_nr_linha        number; 
	ws_tipo_input      varchar2(100); 
	ws_formula         varchar2(32000); 
	ws_owner_td        varchar2(100); 
	ws_obj_princ       varchar2(300); 
	ws_cd_goto         varchar2(20); 
	ws_objeto          varchar2(200);
	ws_ordem           number; 
	ws_coluna 		   varchar2(100);
	ws_conteudo_f	   varchar2(200);
	ws_condicao		   varchar2(50);
	ws_lista           varchar2(4000);
	ws_cd_coluna	   varchar2(300);
	ws_cd_descricao    varchar2(300);
	ws_tipo    	   	   varchar2(200);
	ws_lista_where_limitador varchar2(4000);
	ws_nouser		 exception;

	procedure nested_test_list ( prm_ref     varchar2 default null,
								prm_id      varchar2 default null,
								prm_nome    varchar2 default null,
								prm_fixo    varchar2 default null,
								prm_cod     varchar2 default null,
								prm_com_cod varchar2 default 'S',
								prm_class   varchar2 default '') as

	ws_count  number;
	ws_rotulo varchar2(200);
	ws_class  varchar2(100); 



	
	begin
		select count(*) into ws_count from table((fun.vpipe(prm_ref))) where '|'||trim(column_value)||'|' = '|'||trim(prm_id)||'|';

		ws_rotulo := prm_nome;
		ws_erro   := null;

		if nvl(prm_fixo, 'N/A') <> 'N/A' then
			ws_rotulo := prm_fixo;
		else
			if prm_id <> prm_nome and nvl(prm_com_cod,'S') = 'S' and prm_id not in ('TODOS','NENHUM') then
				ws_rotulo := nvl(prm_cod, prm_id)||' - '||prm_nome;
			end if;
		end if;

		ws_class := prm_class;
		if ws_count > 0 then
			ws_class := ws_class||' selected';
		end if; 

		htp.p('<li title="'||prm_id||'" class="opt '||ws_class||'">'||ws_rotulo||'</li>');
	end nested_test_list;

	procedure nested_list_not ( prm_adicional varchar2 default null,
								prm_ref       varchar2 default null,
								prm_coluna    varchar2 default null,
								prm_desc      varchar2 default null ) as

		ws_rotulo   varchar2(200);
		ws_count    number;
		ws_selected number;
		ws_count_tpt	number;

	begin
			
		select count(*) into ws_count from table(fun.vpipe(prm_adicional)) where column_value = prm_coluna;
		select count(*) into ws_count_tpt from table (fun.vpipe(prm_adicional)) where (column_value in (select cd_coluna from micro_coluna where cd_micro_visao = prm_visao and st_agrupador = 'TPT' and formula like '%'||prm_coluna||'%'));
		select count(*) into ws_selected from table(fun.vpipe(prm_ref)) where '|'||column_value||'|' = '|'||prm_coluna||'|';
				
		ws_rotulo := prm_desc;

		if prm_coluna <> prm_desc then
			ws_rotulo := prm_coluna||' - '||prm_desc;
		end if;
				
		if ws_selected <> 0 then
			htp.p('<li class="opt selected" title="'||prm_coluna||'">'||ws_rotulo||'</li>');
		elsif trim(prm_coluna) = '$[NOT]'||trim(prm_ref) then
			htp.p('<li class="opt reverse" title="'||prm_coluna||'">'||ws_rotulo||'</li>');
		elsif ws_count > 0 then
			htp.p('<li class="opt used" title="'||prm_coluna||'">'||ws_rotulo||'</li>');
		elsif ws_count_tpt > 0 then
		  	htp.p('<li class="opt used tpt" title="'||prm_coluna||'">'||ws_rotulo||'</li>');
		else
			htp.p('<li class="opt" title="'||prm_coluna||'">'||ws_rotulo||'</li>');
		end if;

	end nested_list_not;

	procedure nested_list_order ( prm_ref    	varchar2 default null,
								prm_coluna 		varchar2 default null,
								prm_desc   		varchar2 default null,
								prm_padrao 		varchar2 default null ) as

		ws_rotulo varchar2(80);
		ws_order  varchar2(20);

	begin

		begin
		select ordem into ws_order from (select column_value, rownum as ordem from table((fun.vpipe(prm_ref)))) where trim(column_value) = trim(prm_coluna);
					
			case ws_order
				when '10' then
					ws_order := 'A';
				when '11' then 
					ws_order := 'B';
				when '12' then
					ws_order := 'C';
				when '13' then
					ws_order := 'D';
				when '14' then
					ws_order := 'E';
				when '15' then
					ws_order := 'F';
				else
					ws_order := ws_order;
			end case;
		
		exception when others then
			ws_order := '0';
		end;

		ws_rotulo := prm_desc;

		if prm_coluna <> prm_desc then
			ws_rotulo := prm_coluna||' - '||prm_desc;
		end if;
		
		if nvl(ws_order, '0') <> '0' then
			
			htp.p('<li class="opt selected" data-ordem="'||ws_order||'" title="'||prm_coluna||'">'||fun.utranslate('NM_OBJETO', prm_coluna, ws_rotulo, prm_padrao)||'</li>');
		else
			htp.p('<li class="opt" data-ordem="0" title="'||prm_coluna||'">'||fun.utranslate('NM_OBJETO', prm_coluna, ws_rotulo, prm_padrao)||'</li>');
		end if;

	end nested_list_order;

begin

	ws_usuario := gbl.getUsuario;
	ws_admin   := nvl(gbl.getNivel,'N');

	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if;

	ws_owner_td := nvl(fun.ret_var('OWNER_TABLE_DATA'),'DWU'); 
	ws_search   := replace(prm_search, '$[NOT]', '');

		case prm_campo

		when 'lista-drill' then
		
			ws_cd_goto  := substr(prm_visao,instr(prm_visao,'|')+1,100); 
			ws_cd_goto  := nvl(ws_cd_goto,0);
			ws_value    := replace(substr(prm_visao,1,instr(prm_visao,'|')-1),'##',''); 
			ws_objeto   := fun.get_cd_obj(ws_value);

			select tp_objeto into ws_class from objetos where cd_objeto = ws_objeto;

			if ws_class = 'CONSULTA' then
				htp.p('<li class="opt" title="'||ws_objeto||'">'||fun.lang('REABRIR')||'</li>');
			end if;

			ws_padrao := gbl.getLang;
			ws_check := 'N/A';  

			-- Pega o objeto principal da tela que abriu a Drill, para possibilitar que ele possa ser aberto pela Drill 
			ws_obj_princ := ' '; 
			for a in (select column_value from table(fun.vpipe(prm_adicional)) where column_value is not null) loop 
				if a.column_value <> ws_objeto then 
					ws_obj_princ := a.column_value; 
				end if; 	
				exit; 
			end loop;

			-- Pega a ordem atual da drill atual (se for drill) para drills do mesmo objeto principal 
			ws_ordem := 0;
			if ws_cd_goto <> 0 then
				select nvl(max(ordem),0) into ws_ordem from goto_objeto where cd_goto_objeto = ws_cd_goto ; 
			end if; 

			for i in ( select t1.cd_objeto_go, t1.cd_goto_objeto, decode(t2.tp_objeto,'MAPAGEOLOC','GEOLOCALIZA&Ccedil;&Atilde;O',t2.tp_objeto) as tipo, t2.nm_objeto as nome, ds_complemento
				         from GOTO_OBJETO t1 
				       left join objetos t2 on (t2.cd_objeto = t1.cd_objeto_go) 
				      where t1.cd_objeto = ws_objeto
					    and fun.CHECK_PERMISSAO(t1.cd_objeto_go) = 'S' 
						and ( (t1.cd_objeto <> t1.cd_objeto_go) or (t1.cd_goto_objeto <> ws_cd_goto and nvl(t1.ordem,ws_ordem) >= ws_ordem) )
						and ( (ws_cd_goto = 0) or ( cd_goto_objeto <> ws_cd_goto) )  
						--and  t1.cd_objeto_go not in (select column_value from table(fun.vpipe(prm_adicional)) where column_value is not null and nvl(column_value,'N/A') <> ws_obj_princ) 
						and  t1.cd_objeto_go||t1.cd_goto_objeto not in (select replace(column_value,'trl','') from table(fun.vpipe(prm_adicional)) where column_value is not null and nvl(column_value,'N/A') <> ws_obj_princ) 
						and t1.cd_objeto_go not in ( select cd_objeto from OBJECT_RESTRICTION where USUARIO = ws_usuario )
				      order by tipo, nvl(ordem, 99), nvl(ds_complemento, nome) 
			         ) loop

				if ws_check <> i.tipo then
					ws_check := i.tipo;
					htp.p('<li class="group" title="'||i.tipo||'">'||fun.lang(i.tipo)||'</li>');
				end if;

				htp.p('<li class="opt" title="'||i.cd_objeto_go||'-'||i.cd_goto_objeto||'">'||nvl(i.ds_complemento,fun.subpar(fun.utranslate('NM_OBJETO', i.cd_objeto_go, i.nome, ws_padrao)))||'</li>');
				--htp.p('<li class="opt" title="'||i.cd_objeto_go||'-'||i.cd_goto_objeto||'">'||fun.subpar(fun.utranslate('NM_OBJETO', i.cd_objeto_go, i.nome, ws_padrao))||i.ds_complemento||'</li>');

			end loop;

		when 'lista-ligacao-browser' then

			fcl.fakeCustom('add');
			fcl.fakeCustom('search', prm_search);

			begin
				select trim(nds_tfisica) into ws_grupo from CODIGO_DESCRICAO where nds_tabela = prm_visao;
				if length(ws_grupo) = 0 then
					ws_grupo := prm_visao;
				end if;
			exception when others then
				ws_grupo := prm_visao;
			end;

			select max(nm_tabela) into ws_tabela from micro_data
			where nm_micro_data = prm_adicional;  

			select cd_ligacao, tipo_input, formula into ws_ligacao, ws_tipo_input, ws_formula
			from data_coluna
			where cd_coluna     = prm_ident
			and cd_micro_data = prm_adicional;

			if ws_tipo_input in ('ligacao','ligacaoc') then
				if nvl(prm_search, 'N/A') <> 'N/A' then
					ws_sql := 'select distinct '||prm_ident||'  from '||ws_owner_td||'.'||ws_grupo||' where ('||prm_ident||' like (''%'||prm_search||'%'') or upper(trim(fun.cdesc('||prm_ident||', '''||ws_ligacao||'''))) like (''%'||upper(trim(prm_search))||'%'')) order by '||prm_ident||'';
				else
					ws_sql := 'select distinct '||prm_ident||'  from '||ws_owner_td||'.'||ws_grupo||' order by '||prm_ident||'';
				end if;
			elsif ws_tipo_input = 'listboxp' then
				ws_sql     := 'select cd_coluna, cd_conteudo from table(fun.vpipe_par('''||ws_formula||'''))'; 
			elsif ws_tipo_input in ('listboxt', 'listboxtcd', 'listboxtd') then 
				ws_sql := 'select distinct '||prm_ident||' from '||ws_owner_td||'.'||ws_tabela||' order by 1';
			end if; 


			begin

				ws_cursor := dbms_sql.open_cursor;
				dbms_sql.parse(ws_cursor, ws_sql, DBMS_SQL.NATIVE);
				dbms_sql.define_column(ws_cursor, 1, ws_codigo, 200);
				if ws_tipo_input = 'listboxp' then 
					dbms_sql.define_column(ws_cursor, 2, ws_descricao, 200);
				end if; 

				ws_linhas := dbms_sql.execute(ws_cursor);

				loop
					if dbms_sql.fetch_rows(ws_cursor) = 0 then
						exit;
					end if;
					ws_count := dbms_sql.last_row_count;
					
					dbms_sql.column_value(ws_cursor, 1, ws_codigo);
					if ws_tipo_input = 'listboxp' then 
						dbms_sql.column_value(ws_cursor, 2, ws_descricao);
					else 
						ws_descricao := fun.cdesc(trim(ws_codigo), ws_ligacao);
					end if; 		
					if trim(ws_codigo) = ws_descricao then
						htp.p('<li class="opt" title="'||trim(ws_codigo)||'">'||trim(ws_codigo)||'</li>');
					else
						htp.p('<li class="opt" title="'||trim(ws_codigo)||'">'||trim(ws_codigo)||' - '||ws_descricao||'</li>');
					end if;
				end loop;

				dbms_sql.close_cursor(ws_cursor);

			exception when others then
				htp.p(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||'  -  '||ws_sql);
			end;
	
		when 'lista-coluna-browser' then

			begin
				fcl.fakeCustom('add');
				ws_sql := 'select column_name from all_tab_columns where table_name = '''||upper(trim(prm_visao))||''' and column_name not in (select cd_coluna from data_coluna where cd_micro_data = '''||replace(prm_ident, '_fake')||''')';

				ws_cursor := dbms_sql.open_cursor;
				dbms_sql.parse(ws_cursor, ws_sql, DBMS_SQL.NATIVE);
				dbms_sql.define_column(ws_cursor, 1, ws_codigo, 200);
				ws_linhas := dbms_sql.execute(ws_cursor);

				loop
					exit when ( dbms_sql.fetch_rows(ws_cursor) = 0);
					dbms_sql.column_value(ws_cursor, 1, ws_codigo);
					htp.p('<li class="opt" title="'||trim(ws_codigo)||'">'||trim(ws_codigo)||'</li>');
				end loop;
				dbms_sql.close_cursor(ws_cursor);
			exception when others then
				htp.p(ws_sql||' # '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
			end;
		
		when 'lista-sinais-opcoes' then

			for i in 1..9 loop
				if i = trim(prm_ref) then
					htp.p('<li class="opt selected" title="'||i||'">'||htf.img(fun.r_gif('ind'||i||'_1', 'PNG' ))||htf.img(fun.r_gif('ind'||i||'_2', 'PNG' ))||htf.img(fun.r_gif('ind'||i||'_3', 'PNG' ))||htf.img(fun.r_gif('ind'||i||'_4', 'PNG' ))||htf.img(fun.r_gif('ind'||i||'_5', 'PNG' ))||'</li>');
				else
					htp.p('<li class="opt" title="'||i||'">'||htf.img(fun.r_gif('ind'||i||'_1', 'PNG' ))||htf.img(fun.r_gif('ind'||i||'_2', 'PNG' ))||htf.img(fun.r_gif('ind'||i||'_3', 'PNG' ))||htf.img(fun.r_gif('ind'||i||'_4', 'PNG' ))||htf.img(fun.r_gif('ind'||i||'_5', 'PNG' ))||'</li>');
				end if;
			end loop;
		
		when 'lista-sinais' then

			for i in (select cd_sinal, ds_sinal, tp_sinal, fx_01, fx_02, fx_03, fx_04, fx_05 from SINAIS order by cd_sinal asc) loop
				htp.p('<li class="opt" title="'||i.cd_sinal||'">'||i.cd_sinal||' - '||i.ds_sinal||'</li>');
			end loop;
		
		when 'lista-horas' then
			begin
				for i in( select cd_item as cod, ds_abrev as nome, nvl2(column_value, 'selected', '') as classe from bi_lista_padrao 
						left join table(fun.vpipe(prm_ref)) on column_value = cd_item 
						where cd_lista = 'HORA' order by nr_ordem, cd_item
					--select to_number(t1.column_value) as cod, nvl2(t2.column_value, 'selected', '') as classe from table(fun.vpipe('01|02|03|04|05|06|07|08|09|10|11|12|13|14|15|16|17|18|19|20|21|22|23|24')) t1
					--left join table(fun.vpipe(prm_ref)) t2 on t2.column_value = t1.column_value order by cod
					) loop
					
					htp.p('<li title="'||i.cod||'" class="opt '||i.classe||'">'||to_char(i.cod, '00')||':00h</li>');
				
				end loop;
			exception when others then
				htp.p(sqlerrm);
			end;
		
		when 'lista-meses' then
			
			for i in( select cd_item as cod, ds_abrev as nome, nvl2(column_value, 'selected', '') as classe from bi_lista_padrao 
					left join table(fun.vpipe(prm_ref)) on column_value = cd_item 
					where cd_lista = 'MES' order by nr_ordem, cd_item
				) loop
				
				htp.p('<li title="'||i.cod||'" class="opt '||i.classe||'">'||fun.lang(i.nome)||'</li>');
			end loop;

		when 'lista-dia-mes' then
			
			for i in( select cd_item as cod, ds_abrev as nome, nvl2(column_value, 'selected', '') as classe from bi_lista_padrao 
					left join table(fun.vpipe(prm_ref)) on column_value = cd_item 
					where cd_lista = 'DIA_MES' order by nr_ordem, cd_item
				) loop
				htp.p('<li title="'||i.cod||'" class="opt '||i.classe||'">'||fun.lang(i.nome)||'</li>');
			end loop;

			
		when 'lista-semanas' then
			
			for i in( select cd_item as cod, ds_abrev as nome, nvl2(column_value, 'selected', '') as classe from bi_lista_padrao 
					left join table(fun.vpipe(prm_ref)) on column_value = cd_item 
					where cd_lista = 'DIA_SEMANA' order by nr_ordem, cd_item
				--select cd_coluna as cod, cd_conteudo as nome, nvl2(column_value, 'selected', '') as classe from table(fun.vpipe_par('1|DOMINGO|2|SEGUNDA-FEIRA|3|TER&Ccedil;A-FEIRA|4|QUARTA-FEIRA|5|QUINTA-FEIRA|6|SEXTA-FEIRA|7|SABADO'))
				--left join table(fun.vpipe(prm_ref)) on column_value = cd_coluna order by cd_coluna
				) loop
				
				htp.p('<li title="'||i.cod||'" class="opt '||i.classe||'">'||fun.lang(i.nome)||'</li>');
			end loop;

		when 'lista-minutos' then
			
			for i in( select cd_item as cod, ds_abrev as nome, nvl2(column_value, 'selected', '') as classe from bi_lista_padrao 
					left join table(fun.vpipe(prm_ref)) on column_value = cd_item 
					where cd_lista = 'MINUTO' and cd_item in ('0', '5','10','15','20','25','30','35','40','45','50','55') order by nr_ordem, cd_item
				) loop
				htp.p('<li title="'||i.cod||'" class="opt '||i.classe||'">'||fun.lang(i.nome)||'</li>');
			end loop;
	
		when 'lista-mascara' then
			
			htp.p('<li title="SEM" class="opt">SEM</li>');
			for i in (select cd_mascara from mascaras order by cd_mascara asc ) loop
				nested_test_list(prm_ref, i.cd_mascara, i.cd_mascara);
			end loop;

		when 'lista-procedures' then
					
			fcl.fakeCustom('add');
			fcl.fakeCustom('search', prm_search);
			

			htp.p('<li class="opt group">PROCEDURES</li>');				
			
			for i in (select OBJECT_NAME from all_objects where object_type = 'PROCEDURE' AND OWNER = ws_owner_td AND upper(trim(OBJECT_NAME)) LIKE '%'||upper(trim(prm_search))||'%' order by object_name asc) loop

				nested_test_list(prm_ref,i.object_name,i.object_name);

			end loop;	
				

		when 'lista-mascara-browser' then
			
			fcl.fakeCustom('add', prm_ref);
			
			htp.p('<li title="SEM" class="opt">SEM</li>');
			for i in (select cd_mascara from mascaras order by cd_mascara asc ) loop
				nested_test_list(prm_ref, i.cd_mascara, i.cd_mascara);
			end loop;
	
		when 'lista-taux' then

			fcl.fakeCustom('add');
			fcl.fakeCustom('search', prm_search);
			
			htp.p('<li title="SEM" class="opt">SEM</li>');
			for i in (select nds_tabela from codigo_descricao where nds_tabela like ('%'||nvl(upper(ws_search), nds_tabela)||'%') order by nds_tabela asc ) loop
				nested_test_list(prm_ref, i.nds_tabela, i.nds_tabela);
			end loop;
	
		when 'lista-taux-fixa' then
			
 			--htp.p('<li title="SEM" class="opt">SEM</li>');
			for i in (select nds_tabela from codigo_descricao order by nds_tabela asc ) loop
				nested_test_list(prm_ref, i.nds_tabela, i.nds_tabela);
			end loop;

		when 'lista-jumpmed' then

			for i in(select cd_coluna, nm_rotulo from micro_coluna mc where cd_micro_visao = prm_visao and cd_coluna <> replace(prm_ident, 'ID_') and st_agrupador <> 'SEM' and cd_coluna not in(select cd_coluna from column_restriction cr where cr.cd_coluna = mc.cd_coluna and usuario = ws_usuario and cr.cd_micro_visao = prm_visao) and cd_coluna in(select column_value from table(fun.vpipe((select propriedade from object_attrib where cd_object = prm_adicional and cd_prop = 'AGRUPADORES'))))) loop
				nested_test_list(prm_ref, i.cd_coluna, i.nm_rotulo, i.nm_rotulo);
			end loop;
		
		when 'lista-tabelas' then

			fcl.fakeCustom('add');

			/*select do for substituido pelo abaixo 23/12/2022

				select OBJECT_TYPE as TIPO, object_name as nome 
							from all_objects 
						where owner=nvl(fun.ret_var('OWNER_TABLE_DATA'),'DWU') 
							and ((upper(SUBSTR(OBJECT_NAME,1,3)) IN ('VM_','DW_', 'OPR', 'BI_')) 
							OR (object_type='VIEW' AND upper(SUBSTR(OBJECT_NAME,1,1))='V') 
							OR (object_type in('TABLE','VIEW') AND upper(SUBSTR(OBJECT_NAME,1,5))='TAUX_')) 
							and object_name like ('%'||nvl(upper(ws_search), object_name)||'%') 
						order by object_name asc
			*/

			FOR I IN (SELECT OBJECT_TYPE AS TIPO, OBJECT_NAME AS NOME 
						FROM ALL_OBJECTS 
					WHERE OWNER=ws_owner_td 
						AND ((UPPER(OBJECT_NAME) NOT IN (SELECT NM_TABELA FROM BI_TABELA_SISTEMA))	AND OBJECT_TYPE = 'TABLE') 
						AND OBJECT_NAME 		    LIKE ('%'||NVL(UPPER(WS_SEARCH), OBJECT_NAME)||'%') 
					ORDER BY OBJECT_NAME ASC)
					
			LOOP
				NESTED_TEST_LIST(PRM_REF, I.NOME, I.NOME);
			END LOOP;
		when 'lista-tabelas-view' then

			fcl.fakeCustom('add');

			FOR I IN (SELECT OBJECT_TYPE AS TIPO, OBJECT_NAME AS NOME 
						FROM ALL_OBJECTS 
					WHERE OWNER=ws_owner_td
						AND ((UPPER(OBJECT_NAME) NOT IN (SELECT NM_TABELA FROM BI_TABELA_SISTEMA))	AND OBJECT_TYPE IN ('TABLE','VIEW')) 
						AND OBJECT_NAME 		    LIKE ('%'||NVL(UPPER(WS_SEARCH), OBJECT_NAME)||'%') 
					ORDER BY OBJECT_NAME ASC)
					
			LOOP
				NESTED_TEST_LIST(PRM_REF, I.NOME, I.NOME);
			END LOOP;
		
		when 'lista-tabelas-import' then
			
			fcl.fakeCustom('add');

			FOR I IN (SELECT OBJECT_TYPE AS TIPO, OBJECT_NAME AS NOME 
						FROM ALL_OBJECTS 
					WHERE OWNER=ws_owner_td 
						AND ((UPPER(OBJECT_NAME) NOT IN (SELECT NM_TABELA FROM BI_TABELA_SISTEMA))	AND OBJECT_TYPE	= 'TABLE') 
						AND OBJECT_NAME LIKE ('%'||NVL(UPPER(WS_SEARCH), OBJECT_NAME)||'%') 
					ORDER BY OBJECT_NAME ASC)
			LOOP
				NESTED_TEST_LIST(PRM_REF, I.NOME, I.NOME);
			END LOOP;

        when 'lista-step-plsql' then

            fcl.fakeCustom('search', prm_search);

            for i in (select step_id from etl_step where tipo_execucao = 'PL/SQL') loop
                htp.p('<li class="opt" title="'||i.step_id||'">'||i.step_id||'</li>');
            end loop;

		when 'lista-gusers' then
			
			--htp.p('<li title="" class="opt">-----</li>');
			for i in (select cd_group,nm_group from gusers order by nm_group) loop
				nested_test_list(prm_ref, i.cd_group, i.nm_group,prm_com_cod=>'N');
			end loop;

		when 'lista-grupos' then 
			
			if prm_adicional = 'todos' then
				htp.p('<li title="" class="opt">'||fun.lang('TODAS AS CATEGORIAS')||'</li>');
			end if;

			begin
				select CONTEUDO into ws_padrao
				from   PARAMETRO_USUARIO
				where  cd_usuario = ws_usuario and
					cd_padrao='CD_LINGUAGEM';
			exception
				when others then
					ws_padrao := 'PORTUGUESE';
			end;

			for i in (select cd_grupo, nm_grupo from grupos_funcao order by ordem, cd_grupo asc) loop
				nested_test_list(prm_ref, i.cd_grupo, fun.utranslate('CD_GRUPO', 'GRUPOS_FUNCAO' , i.nm_grupo, ws_padrao));
			end loop;

		when 'lista-telas' then
			
			ws_check := 'N/A';

			fcl.fakeCustom('search', prm_search);
			
			ws_class := 'opt selectablegroup '; 
			select count(*) into ws_count from gusers where cd_group = prm_adicional; 
			if ws_count > 0 then   -- Se for grupo de usuários, não permite selecionar categoria de telas 
				ws_class := 'group'; 
			end if; 

			for i in (/* select cd_objeto, nm_objeto, t2.nm_grupo as nm_grupo, t2.cd_grupo as grupo 
			            from objetos t1
	                    left join grupos_funcao t2 on (t2.cd_grupo = t1.cd_grupo)  
					   where cd_objeto not in (select screen from user_screens where usuario = prm_adicional)
				         and (cd_objeto like 'SRC_%' or tp_objeto = 'SCREEN') 
						 and ( upper(trim(cd_objeto)) like ('%'||upper(trim(prm_search))||'%') or 
						 	   upper(trim(nm_objeto)) like ('%'||upper(trim(prm_search))||'%') or 
							   upper(trim(cod)) like ('%'||upper(trim(prm_search))||'%')
							 ) 
	            	  order by t2.nm_grupo, nm_objeto
					 */ 
					  select cd_objeto, nm_objeto, t2.nm_grupo as nm_grupo, t2.cd_grupo as grupo 
			            from grupos_funcao t2, objetos t1
					   where t2.cd_grupo = t1.cd_grupo 
                         and (t1.cd_objeto like 'SRC_%' or t1.tp_objeto = 'SCREEN') 
                         and t1.cd_objeto not in (select t5.screen from user_screens t5 where t5.usuario = prm_adicional) -- Não mostra telas que já tem acesso 
                         and t1.cd_objeto not in (select t7.cd_objeto 
                                                    from objetos t7, grupos_funcao t6, user_screens t5 
                                                   where t7.cd_grupo = t6.cd_grupo 
                                                     and t6.cd_grupo = t5.screen
                                                     and (t7.cd_objeto like 'SRC_%' or t7.tp_objeto = 'SCREEN')
                                                     and t5.usuario  = prm_adicional)
                         
						 and ( t1.cd_objeto              like ('%'||upper(trim(prm_search))||'%') or 
						 	   upper(trim(t1.nm_objeto)) like ('%'||upper(trim(prm_search))||'%') 
							 ) 
	            	  order by t2.nm_grupo, t1.nm_objeto ) loop
                
				if ws_check <> i.grupo then
                    ws_check := i.grupo;
                   	htp.p('<li class="'||ws_class||'" title="'||i.grupo||'">'||i.nm_grupo||'</li>');
                end if;

				htp.p('<li title="'||i.cd_objeto||'" class="opt">'||upper(i.nm_objeto)||'</li>');

			end loop;

		when 'lista-objetos-report' then
			
			-- prm_visao deve trazer o usuário 
			ws_check  := 'N/A';
			ws_check2 := 'N/A';
			htp.p('<li title="" class="opt">---</li>');
			
			for i in(select t1.tp_objeto, t1.cd_objeto, nm_objeto, t2.nm_grupo, t2.cd_grupo, 
							decode(t1.tp_objeto,'SCREEN','TELAS','RELATORIO','RELAT&Oacute;RIOS','CONSULTA','CONSULTAS', t1.tp_objeto) ds_tp_objeto
					from grupos_funcao t2, objetos t1
					where t2.cd_grupo                = t1.cd_grupo
						and ( cd_objeto like ('SRC_%') or tp_objeto in ('SCREEN', 'RELATORIO','CONSULTA') )
						and	( upper(trim(cd_objeto)) like ('%'||upper(trim(prm_search))||'%') or 
							upper(trim(nm_objeto)) like ('%'||upper(trim(prm_search))||'%') or 
							upper(trim(cod)) like ('%'||upper(trim(prm_search))||'%')
							) 
						and (	(tp_objeto = 'SCREEN' and fun.check_screen_access(t1.cd_objeto, prm_visao, nvl(gbl.getnivel(prm_visao),'N')) > 0 ) 
								or 
								(tp_objeto = 'RELATORIO' and exists (select 1 from object_location ol1
																	where ol1.object_id = t1.cd_objeto
																		and ol1.screen like 'SRC_%'
																		and fun.check_screen_access(ol1.screen, prm_visao, nvl(gbl.getnivel(prm_visao),'N') ) > 0 
																	)  
								) or 
								(tp_objeto = 'CONSULTA' and ( exists (select 1 from object_location ol1
																	where ol1.object_id = t1.cd_objeto
																		and ol1.screen like 'SRC_%'
																		and fun.check_screen_access(ol1.screen, prm_visao, nvl(gbl.getnivel(prm_visao),'N') ) > 0 
																	)  or 
															exists (select 1 from object_location ol3, object_location ol2, object_location ol1
																	where ol1.object_id = t1.cd_objeto
																		and ol3.object_id = ol2.screen 
																		and ol2.object_id = ol1.screen 
																		and ol3.screen like 'SRC_%'
																		and fun.check_screen_access(ol3.screen, prm_visao, nvl(gbl.getnivel(prm_visao),'N') ) > 0 
																	)  
															) 		
														and exists (select 1 from object_attrib oa
																	where oa.cd_object   = t1.cd_objeto
																	and oa.cd_prop     = 'EMAIL'
																	and oa.propriedade = 'S'
																	)			
								)
							)  
					order by t1.tp_objeto, t2.nm_grupo, nm_objeto
					) loop

					if ws_check <> i.tp_objeto then
						ws_check := i.tp_objeto;
						htp.p('<li class="group" title="'||i.ds_tp_objeto||'">'||i.ds_tp_objeto||'</li>');
					end if;

					if ws_check2 <> i.cd_grupo then
						ws_check2 := i.cd_grupo;
						htp.p('<li class="subgroup" title="'||i.cd_grupo||'">'||i.nm_grupo||'</li>');
					end if;

					nested_test_list(prm_ref, i.cd_objeto, upper(i.nm_objeto), upper(i.nm_objeto) );
			end loop;
		when 'lista-objetos-report-tela' then
			
			-- prm_visao deve trazer o usuário 
			ws_check2 := 'N/A';
			htp.p('<li title="" class="opt">---</li>');
			
			for i in(select t1.tp_objeto, t1.cd_objeto, nm_objeto, t2.nm_grupo, t2.cd_grupo, 
							decode(t1.tp_objeto,'SCREEN','TELAS','RELATORIO','RELAT&Oacute;RIOS','CONSULTA','CONSULTAS', t1.tp_objeto) ds_tp_objeto
					from grupos_funcao t2, objetos t1
					where t2.cd_grupo                = t1.cd_grupo
						and ( cd_objeto like ('SRC_%') or tp_objeto in ('SCREEN') )
						and	( upper(trim(cd_objeto)) like ('%'||upper(trim(prm_search))||'%') or 
							upper(trim(nm_objeto)) like ('%'||upper(trim(prm_search))||'%') or 
							upper(trim(cod)) like ('%'||upper(trim(prm_search))||'%')
							) 
						and fun.check_screen_access(t1.cd_objeto, prm_visao, nvl(gbl.getnivel(prm_visao),'N')) > 0  
					order by t1.tp_objeto, t2.nm_grupo, nm_objeto
					) loop

					if ws_check2 <> i.cd_grupo then
						ws_check2 := i.cd_grupo;
						htp.p('<li class="group" title="'||i.cd_grupo||'">'||i.nm_grupo||'</li>');
					end if;

					nested_test_list(prm_ref, i.cd_objeto, upper(i.nm_objeto), upper(i.nm_objeto) );
			end loop;

		when 'lista-telas-todas' then

			ws_check := 'N/A';
			if instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'iPhone') = 0 and instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'Android') = 0 then
				ws_order := 'desktop';
			else
				ws_order := 'mobile';
			end if;

			select count(distinct cd_grupo) into ws_count from objetos where cd_objeto in (select screen from user_screens where usuario = prm_adicional  and status='A');
			
			if ws_count > 2 then
				ws_search := 'closed';
			end if;

			ws_count := 0;
			
			htp.p('<li class="opt" onclick="setTimeout(function(){ document.getElementById(''main'').style.setProperty(''background-image'', ''url('||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download_tab?prm_arquivo=bg.png)''); document.getElementById(''main'').style.setProperty(''background-color'', ''transparent''); }, 700); shscr(''DEFAULT''); document.getElementById(''floatops'').innerHTML = '''||fun.lang('Tela principal')||''';">'||fun.lang('Tela principal')||'</li>');
			
			for i in(select cd_objeto, objetos.cd_grupo as cd_grupo, nm_grupo, nm_objeto, nvl(cor_fundo,'#FFFFFF') cor_fundo, url_fundo, NVL(TRIM(OR_ITEM),99) AS OR_OBJETO, dispositivo, ds_screen 
					from OBJETOS, all_screens, GRUPOS_FUNCAO 
					where tp_objeto='SCREEN' 
						and all_screens.publico='S' 
						and cd_objeto=screen(+) 
						and objetos.cd_grupo = grupos_funcao.cd_grupo 
						and screen in (select screen from user_screens where usuario = prm_adicional and status='A') order by GRUPOS_FUNCAO.ordem, objetos.cd_grupo, OR_objeto, objetos.nm_objeto ) loop

				if ws_check <> i.cd_grupo then
					ws_check := i.cd_grupo;
					htp.p('<li class="opt group">'||i.nm_grupo||'</li>');
				end if;

				if (ws_order = 'mobile' and nvl(i.dispositivo, '0') <> 'desktop' and nvl(i.dispositivo, '0') <> 'nenhum') or (ws_order = 'desktop' and nvl(i.dispositivo, '0') <> 'mobile' and nvl(i.dispositivo, '0') <> 'nenhum') or ws_admin = 'A' then
					nested_test_list(prm_ref, i.cd_objeto, upper(trim(i.nm_objeto)), upper(trim(i.nm_objeto)));
				end if; 

			end loop;

		when 'lista-telas-usuario' then
			
			ws_check := 'N/A';
			
			htp.p('<li title="" class="opt">TELA PRINCIPAL</li>');
			
			for i in(select cd_objeto, nm_objeto, t2.nm_grupo as nm_grupo, t2.cd_grupo as grupo 
					from grupos_funcao t2, objetos t1
					where t2.cd_grupo                = t1.cd_grupo
						and fun.check_screen_access(t1.cd_objeto, ws_usuario, ws_admin) > 0 -- fun.check_permissao_tela(t1.cd_objeto, t1.cd_grupo, ws_usuario) = 'S'  
						and ( cd_objeto like ('SRC_%') or tp_objeto = 'SCREEN') 
						and	( upper(trim(cd_objeto)) like ('%'||upper(trim(prm_search))||'%') or 
							upper(trim(nm_objeto)) like ('%'||upper(trim(prm_search))||'%') or 
							upper(trim(cod)) like ('%'||upper(trim(prm_search))||'%')
							) 
					order by t2.nm_grupo, nm_objeto
					) loop

					if ws_check <> i.grupo then
						ws_check := i.grupo;
						htp.p('<li class="group" title="'||i.grupo||'">'||i.nm_grupo||'</li>');
					end if;

					nested_test_list(prm_ref, i.cd_objeto, upper(trim(i.nm_objeto)), upper(trim(i.nm_objeto)));
				end loop;

		when 'lista-tipos-obj' then
				
			/*if trim(prm_ref) = 'CONSULTA' then
				htp.p('<li title="CONSULTA" class="opt selected">CONSULTA</li>');
			else
				htp.p('<li title="CONSULTA" class="opt">CONSULTA</li>');
			end if;*/
			
			if trim(prm_ref) = 'SCREEN' then
				htp.p('<li title="SCREEN" class="opt selected">TELA</li>');
			else
				htp.p('<li title="SCREEN" class="opt">TELA</li>');
			end if;
			
			/*if trim(prm_ref) = 'FILE' then
				htp.p('<li title="FILE" class="opt selected">FILEVIEW</li>');
			else
				htp.p('<li title="FILE" class="opt">FILEVIEW</li>');
			end if;*/
			
			if trim(prm_ref) = 'RELATORIO' then
				htp.p('<li title="RELATORIO" class="opt selected">'||fun.lang('RELAT&Oacute;RIO')||'</li>');
			else
				htp.p('<li title="RELATORIO" class="opt">'||fun.lang('RELAT&Oacute;RIO')||'</li>');
			end if;
			
			/*if trim(prm_ref) = 'ICONE' then
				htp.p('<li title="ICONE" class="opt selected">'||fun.lang('ICONE')||'</li>');
			else
				htp.p('<li title="ICONE" class="opt">'||fun.lang('ICONE')||'</li>');
			end if;*/
			
			if trim(prm_ref) = 'IMAGE' then
				htp.p('<li title="IMAGE" class="opt selected">'||fun.lang('IMAGEM')||'</li>');
			else
				htp.p('<li title="IMAGE" class="opt">'||fun.lang('IMAGEM')||'</li>');
			end if;
			
			if trim(prm_ref) = 'CALL_LIST' then
				htp.p('<li title="CALL_LIST" class="opt selected">MENU</li>');
			else
				htp.p('<li title="CALL_LIST" class="opt">MENU</li>');
			end if;
			
			/*if trim(prm_ref) = 'SCRIPT' then
				htp.p('<li title="SCRIPT" class="opt selected">SCRIPT</li>');
			else
				htp.p('<li title="SCRIPT" class="opt">SCRIPT</li>');
			end if;*/
			
			if trim(prm_ref) = 'BROWSER' then
				htp.p('<li title="BROWSER" class="opt selected">BROWSER</li>');
			else
				htp.p('<li title="BROWSER" class="opt">BROWSER</li>');
			end if;
			
			/*if trim(prm_ref) = 'HEATMAP' then
				htp.p('<li title="HEATMAP" class="opt selected">MAPA DE CALOR</li>');
			else
				htp.p('<li title="HEATMAP" class="opt">MAPA DE CALOR</li>');
			end if;*/

		when 'lista-tipos-lov' then

			htp.p('<li title="TABELA" class="opt">'||fun.lang('TABELA')||'</li>');
			htp.p('<li title="LISTA" class="opt">'||fun.lang('LISTA')||'</li>');

		when 'lista-arquivo-imagem' then		

			fcl.fakecustom('add');

			FOR I IN (SELECT NAME, DOC_SIZE,USUARIO FROM TAB_DOCUMENTOS 
					WHERE (UPPER(TRIM(NAME)) LIKE NVL(('%'||UPPER(TRIM(WS_SEARCH))||'%.PNG'), UPPER(TRIM(NAME)))
						OR UPPER(TRIM(NAME)) LIKE NVL(('%'||UPPER(TRIM(WS_SEARCH))||'%.JPG'), UPPER(TRIM(NAME)))
						OR UPPER(TRIM(NAME)) LIKE NVL(('%'||UPPER(TRIM(WS_SEARCH))||'%.BMP'), UPPER(TRIM(NAME)))
						OR UPPER(TRIM(NAME)) LIKE NVL(('%'||UPPER(TRIM(WS_SEARCH))||'%.JPEG'), UPPER(TRIM(NAME)))
						OR UPPER(TRIM(NAME)) LIKE NVL(('%'||UPPER(TRIM(WS_SEARCH))||'%.SVG'), UPPER(TRIM(NAME)))
						OR UPPER(TRIM(NAME)) LIKE NVL(('%'||UPPER(TRIM(WS_SEARCH))||'%.WEBP'), UPPER(TRIM(NAME))))
						AND (USUARIO = WS_USUARIO OR (USUARIO = 'DWU' ))
					ORDER BY NAME ASC)
						
			LOOP
			
				nested_test_list(prm_ref, trim(i.name), trim(i.name));

			END LOOP;


		when 'lista-arquivo' then

			fcl.fakeCustom('add');
			
			for i in (select name, doc_size from tab_documentos where upper(trim(name)) like nvl(('%'||upper(trim(ws_search))||'%'), upper(trim(name))) order by name asc, mime_type) loop
				nested_test_list(prm_ref, trim(i.name), trim(i.name));
			end loop;
		
		when 'lista-arquivo-user' then
			
			for i in (select name, doc_size from tab_documentos where usuario = gbl.getUsuario or gbl.getnivel='A' order by name asc, mime_type) loop
				nested_test_list(prm_ref, trim(i.name), trim(i.name));
			end loop;
			
		when 'lista-xls' then
			
			for i in (select name, doc_size,usuario from tab_documentos where upper(trim(name)) like '%.XLSX' order by name asc, mime_type) loop
				
				IF WS_ADMIN = 'A' or ((i.usuario = ws_usuario) or (i.usuario = 'DWU')) THEN
					nested_test_list(replace(upper(prm_ref),'.XLSX','')||'.XLSX', upper(i.name), upper(trim(i.name)));
				END IF;
				
			end loop;

		when 'lista-cores-custom' then

			fcl.fakeCustom('add');

			select cor_fundo into ws_value from all_screens where screen = prm_visao;
			
			for i in (select column_value from table(fun.vpipe(prm_ref||'|'||ws_value))) loop
				nested_test_list(prm_ref, i.column_value, i.column_value);
				htp.p('<li title="'||i.column_value||'" class="opt">'||i.column_value||'');
					--htp.p('<input type="text" value="'||i.column_value||'">');
					--htp.p('<input type="color" value="'||i.column_value||'">');
				htp.p('</li>');
			end loop;

		when 'lista-codigo-custom' then

			fcl.fakeCustom('add');
			
			for i in (select column_name from ALL_TAB_COLUMNS where	owner = ws_owner_td and table_name = prm_visao order by column_name ) loop
				nested_test_list(prm_ref, i.column_name, i.column_name);
			end loop;

		when 'lista-realviews' then

			fcl.fakeCustom('add');
			
			for i in (select object_name as objeto, status from all_objects where object_type = 'VIEW' and owner = ws_owner_td order by object_name asc) loop
				nested_test_list(prm_ref, i.objeto, i.objeto);
			end loop;
			
		when 'lista-views'  then

			fcl.fakeCustom('search', prm_search);

			ws_grupo := 'N/A';

			begin
				select CONTEUDO into ws_padrao
				from   PARAMETRO_USUARIO
				where  cd_usuario = ws_usuario and
					cd_padrao='CD_LINGUAGEM';
			exception
				when others then
					ws_padrao := 'PORTUGUESE';
			end;

			for i in (select nm_micro_visao, ds_micro_visao, cd_grupo_funcao 
					from micro_visao where  ( upper(trim(nm_micro_visao)) like ('%'||upper(trim(prm_search))||'%') or 
												upper(trim(ds_micro_visao)) like ('%'||upper(trim(prm_search))||'%')
											) order by cd_grupo_funcao, nm_micro_visao
					) loop

				if(ws_grupo <> i.cd_grupo_funcao) then
					htp.p('<li class="group">'||fun.utranslate('CD_GRUPO', 'GRUPOS_FUNCAO', i.cd_grupo_funcao, ws_padrao)||'</li>');
					ws_grupo := i.cd_grupo_funcao;
				end if;

				ws_rotulo := fun.utranslate('DS_MICRO_VISAO', 'MICRO_VISAO', i.ds_micro_visao, ws_padrao);

				if ws_rotulo <> i.nm_micro_visao then
					ws_rotulo := i.nm_micro_visao||' - '||ws_rotulo;
				end if;


				if '|'||trim(i.nm_micro_visao)||'|' = '|'||trim(prm_ref)||'|' 
                  or instr('|'||trim(prm_ref)||'|', '|'||trim(i.nm_micro_visao)||'|') > 0 then
					htp.p('<li class="opt selected" title="'||i.nm_micro_visao||'">'||ws_rotulo||'</li>');
				else
					htp.p('<li class="opt" onclick="setMicroAgrupador()" title="'||i.nm_micro_visao||'">'||ws_rotulo||'</li>');
				end if;
			end loop;
		
		when 'lista-views-custom' then

			fcl.fakeCustom('search', prm_search);

			ws_grupo := 'N/A';
			begin
				select CONTEUDO into ws_padrao 
				from   PARAMETRO_USUARIO
				where  cd_usuario = ws_usuario and
					cd_padrao='CD_LINGUAGEM';
			exception
				when others then
					ws_padrao := 'PORTUGUESE';
			end;

			for i in (select nm_micro_visao, ds_micro_visao, cd_grupo_funcao 
					from micro_visao where (nm_micro_visao in (select distinct nm_visao from bi_custom_permissao where nm_usuario = ws_usuario) or ws_admin = 'A' )
										and ( upper(trim(nm_micro_visao)) like ('%'||upper(trim(prm_search))||'%') or 
												upper(trim(ds_micro_visao)) like ('%'||upper(trim(prm_search))||'%')
											) order by cd_grupo_funcao, nm_micro_visao
					) loop

				if(ws_grupo <> i.cd_grupo_funcao) then
					htp.p('<li class="group">'||fun.utranslate('CD_GRUPO', 'GRUPOS_FUNCAO', i.cd_grupo_funcao, ws_padrao)||'</li>');
					ws_grupo := i.cd_grupo_funcao;
				end if;
				ws_rotulo := fun.utranslate('DS_MICRO_VISAO', 'MICRO_VISAO', i.ds_micro_visao, ws_padrao);
				if ws_rotulo <> i.nm_micro_visao then
					ws_rotulo := i.nm_micro_visao||' - '||ws_rotulo;
				end if;
				if '|'||trim(i.nm_micro_visao)||'|' = '|'||trim(prm_ref)||'|' then
					htp.p('<li class="opt selected" title="'||i.nm_micro_visao||'">'||ws_rotulo||'</li>');
				else
					htp.p('<li class="opt" onclick="setMicroAgrupador()" title="'||i.nm_micro_visao||'">'||ws_rotulo||'</li>');
				end if;
			end loop;

		when 'lista-medidas' then 
			
			for i in (select nvl(fun.nome_col(cd_coluna, prm_visao), cd_coluna) as coluna, cd_coluna from micro_coluna where cd_coluna not in (select column_value from table(fun.vpipe((select nvl(cs_agrupador, 'N/A') from ponto_avaliacao where cd_ponto = prm_adicional)))) and cd_micro_visao = prm_visao and (st_agrupador <> 'SEM' OR st_agrupador = 'TPT') and nvl(nm_rotulo, 'n/a') <> 'n/a' order by cd_coluna) loop
				nested_list_not( prm_adicional, prm_ref, i.cd_coluna, i.coluna);
			end loop;
		
		when 'lista-colunas' then 

			fcl.fakeCustom('search', prm_search);
            for a in (select column_value as visao from table(fun.vpipe(prm_visao)))
            loop    
                for i in (select nvl(fun.nome_col(cd_coluna, a.visao), cd_coluna) as coluna, cd_coluna,st_agrupador,formula,cd_micro_visao 
                            from micro_coluna where st_agrupador <> 'TPT' and cd_micro_visao = a.visao and nvl(nm_rotulo, 'n/a') <> 'n/a' and
                (
                    upper(trim(cd_coluna)) like ('%'||upper(trim(prm_search))||'%') or 
                    upper(trim(nvl(fun.nome_col(cd_coluna, a.visao), cd_coluna))) like ('%'||upper(trim(prm_search))||'%')
                )
                order by cd_coluna) 
                loop

                    if i.st_agrupador =  'TPT' and i.cd_micro_visao = a.visao then
                        for a in (select column_value as columnTPT from table (fun.vpipe(i.formula)) where (column_value in (select cd_coluna from micro_coluna where cd_micro_visao = prm_visao)))
                        loop
                        nested_list_not(prm_adicional,prm_ref,a.columnTPT,a.columnTPT);
                        end loop;
                    else	
                        nested_list_not( prm_adicional, prm_ref, i.cd_coluna, i.coluna);
                    end if;

                end loop;
            end loop;

		when 'lista-colunas-custom' then 
			
			fcl.fakeCustom('search', prm_search);
			for i in (select nvl(fun.nome_col(cd_coluna, prm_visao), cd_coluna) as coluna, cd_coluna 
						from micro_coluna t1
					where st_agrupador <> 'TPT'   --  Não lista TEMPLATES
						and cd_micro_visao = prm_visao 
						and nvl(nm_rotulo, 'n/a') <> 'n/a' 
						and ( upper(trim(cd_coluna)) like ('%'||upper(trim(prm_search))||'%') or 
							upper(trim(nvl(fun.nome_col(cd_coluna, prm_visao), cd_coluna))) like ('%'||upper(trim(prm_search))||'%')
							)
						and not exists (select 1 from bi_custom_permissao t2 where t2.nm_usuario = prm_adicional and t2.nm_visao = t1.cd_micro_visao and t2.nm_coluna = t1.cd_coluna)
					order by cd_coluna
					) loop
				nested_list_not( prm_adicional, prm_ref, i.cd_coluna, i.coluna);
			end loop;

		when 'lista-dimensoes' then 
			
			for i in (select nm_rotulo as coluna, cd_coluna from micro_coluna 
					where (st_agrupador = 'SEM' or st_agrupador = 'EXT') 
						and cd_micro_visao = prm_visao 
						and nvl(nm_rotulo, 'N/A') <> 'N/A' 
						and st_agrupador <> 'TPT'
						and cd_coluna not in (select nvl(column_value, 'N/A') from table (fun.vpipe((select cs_coluna||cs_colup from ponto_avaliacao where cd_ponto = prm_adicional))))
					order by cd_coluna) loop
				nested_list_order(prm_ref, i.cd_coluna, i.coluna, ws_padrao);
			end loop;

		when 'lista-agrupador' then 
			
			for i in (select nm_rotulo as coluna, cd_coluna from micro_coluna 
					where (st_agrupador = 'SEM' or st_agrupador = 'EXT') 
						and cd_micro_visao = prm_visao 
						and nvl(nm_rotulo, 'N/A') <> 'N/A' 
						and ( (nvl(prm_adicional,'N/A') <> 'CUSTOMIZADO') or 
							(nvl(prm_adicional,'N/A') = 'CUSTOMIZADO' and (ws_admin = 'A' or exists (select 1 from bi_custom_permissao t2 where t2.nm_usuario = ws_usuario and t2.nm_visao = prm_visao and t2.nm_coluna = cd_coluna)) )
							)
					order by cd_coluna) loop
				nested_list_order(prm_ref, i.cd_coluna, i.coluna, ws_padrao);
			end loop;
		when 'lista-valor' then 


			ws_grupo := 'NORMAL';
			for i in (select nm_rotulo as coluna, cd_coluna, decode(st_agrupador, 'TPT', 'TEMPLATE', 'NORMAL') as grupo from micro_coluna 
					where st_agrupador   <> 'SEM' 
						and cd_micro_visao = prm_visao 
						and nvl(nm_rotulo, 'N/A') <> 'N/A' 
						and ( (nvl(prm_adicional,'N/A') <> 'CUSTOMIZADO') or 
							(nvl(prm_adicional,'N/A') = 'CUSTOMIZADO' and ( ws_admin = 'A' or exists (select 1 from bi_custom_permissao t2 where t2.nm_usuario = ws_usuario and t2.nm_visao = prm_visao and t2.nm_coluna = cd_coluna)) )
							)
					order by decode(st_agrupador, 'TPT', 'TEMPLATE', 'NORMAL'), cd_coluna) loop
				if upper(trim(ws_grupo)) <> upper(trim(i.grupo)) then
					htp.p('<li class="group">'||i.grupo||'</li>');
					ws_grupo := i.grupo;
				end if;
				nested_list_order(prm_ref, i.cd_coluna, i.coluna, ws_padrao);
			end loop;

		when 'lista-valor-usado' then

			ws_codigo := fun.getprop(prm_adicional, 'SEC');

			nested_list_order(prm_ref, 'TODOS', 'TODOS', 'TODOS');
			
			select cs_agrupador, cd_micro_visao into ws_value, ws_tabela from ponto_avaliacao where cd_ponto = prm_adicional;
			for i in (
				select column_value, nvl(fun.check_rotuloc(column_value, ws_tabela), nm_rotulo) as nm_rotulo from table(fun.vpipe(ws_value||'|'||ws_codigo)) t1
				left join micro_coluna t2 on t2.cd_micro_visao = ws_tabela and t2.cd_coluna = t1.column_value
			) loop
				if nvl(i.nm_rotulo, 'N/A') <> 'N/A' then
					nested_list_order(prm_ref, replace(replace(i.nm_rotulo, chr(13), ' '), chr(10), ' '), replace(replace(i.nm_rotulo, chr(13), ' '), chr(10), ' '), replace(replace(i.nm_rotulo, chr(13), ' '), chr(10), ' '));
				end if;
			end loop;
		when 'lista-valor-simples' then 
			
			for i in (select nm_rotulo as coluna, cd_coluna from micro_coluna where st_agrupador <> 'SEM' and cd_micro_visao = prm_visao and nvl(nm_rotulo, 'N/A') <> 'N/A' order by cd_coluna) loop
				nested_test_list(prm_ref, i.cd_coluna, i.coluna);
			end loop;
		
		when 'lista-pivot' then 
			
			for i in (select nm_rotulo as coluna, cd_coluna from micro_coluna 
					where (st_agrupador = 'SEM' or st_agrupador = 'EXT') 
						and cd_micro_visao = prm_visao 
						and nvl(nm_rotulo, 'N/A') <> 'N/A' 
						and ( (nvl(prm_adicional,'N/A') <> 'CUSTOMIZADO') or 
							(nvl(prm_adicional,'N/A') = 'CUSTOMIZADO' and (ws_admin = 'A' or exists (select 1 from bi_custom_permissao t2 where t2.nm_usuario = ws_usuario and t2.nm_visao = prm_visao and t2.nm_coluna = cd_coluna)) )
							)
					order by cd_coluna) loop
				nested_list_order(prm_ref, i.cd_coluna, i.coluna, ws_padrao);
			end loop;
		when 'lista-custom-fav' then 

			ws_grupo := 'N/A';
			for i in (select cd_objeto, decode(cd_objeto,prm_adicional,'CONSULTA ATUAL',nm_objeto) as nm_objeto, cd_grupo  from objetos 
					where nvl(id_customizado,'N') = 'S'
						and cd_usuario              = ws_usuario 
					order by decode(cd_objeto,prm_adicional,'-',nm_objeto) ) loop 
				htp.p('<li title="'||i.cd_objeto||'" class="opt">'||i.nm_objeto||'');
				htp.p('</li>');
			end loop;
		
		when 'lista-objetos-go' then

			fcl.fakeCustom('search', prm_search);

			ws_grupo := 'N/A';
			for i in (select cd_objeto, nm_objeto, decode(tp_objeto,'MAPAGEOLOC','GEOLOCALIZA&Ccedil;&Atilde;O',tp_objeto) as tp_objeto, cod 
					from objetos 
					where (cd_objeto in (select cd_ponto from ponto_avaliacao 
											where cd_micro_visao = nvl(prm_visao, cd_micro_visao) 
											-- and (cd_ponto not in (select trim(cd_objeto_go) from goto_objeto t2 where upper(trim(t2.cd_objeto)) = upper(trim(prm_adicional))) ) 
										) 
							or tp_objeto in ('SCREEN','RELATORIO')
							) 
						--and upper(trim(cd_objeto)) <> upper(trim(nvl(prm_adicional, 'N/A'))) 
						and ( upper(trim(cd_objeto)) like ('%'||upper(trim(prm_search))||'%') or 
							  upper(trim(nm_objeto)) like ('%'||upper(trim(prm_search))||'%') or 
							  upper(trim(cod)) like ('%'||upper(trim(prm_search))||'%')
							)
					order by tp_objeto, nm_objeto) loop
				
				if (i.tp_objeto <> 'PONTEIRO' AND i.tp_objeto <> 'VALOR' AND i.tp_objeto <> 'GRAFICO' AND i.tp_objeto <> 'OBJETO') OR prm_ident = 'destaque-objeto' then
				
					if ws_grupo <> i.tp_objeto then
						htp.p('<li class="group">'||i.tp_objeto||'</li>');
						ws_grupo := i.tp_objeto;
					end if;

					nested_test_list(prm_ref, i.cd_objeto, nvl(i.nm_objeto, i.cd_objeto)); 
					
				end if;
			end loop;

		when 'lista-objetos-bloqueio' then

			fcl.fakeCustom('search', prm_search);

				ws_grupo := 'N/A';
				for i in (select cd_objeto, nm_objeto, tp_objeto, cod 
							from objetos 
						   where (cd_objeto 
							  in (select cd_ponto 
								    from ponto_avaliacao 
								   where cd_micro_visao = nvl(prm_visao, cd_micro_visao) 
							 and (cd_ponto 
							 not in (select trim(cd_objeto_go) 
									   from goto_objeto t2 
									  where upper(trim(t2.cd_objeto)) = upper(trim(prm_adicional))
									)) 
								 ) 
							  or tp_objeto 				in   ('SCREEN','IMAGE', 'TEXTO','RELATORIO')) 
							 and upper(trim(cd_objeto)) <>   upper(trim(nvl(prm_adicional, 'N/A'))) 
							 and(upper(trim(cd_objeto)) like ('%'||upper(trim(prm_search))||'%') 
							  		or upper(trim(nm_objeto))   like ('%'||upper(trim(prm_search))||'%') 
							  		or upper(trim(cod)) 	    like ('%'||upper(trim(prm_search))||'%')
								)
							order by tp_objeto, nm_objeto
							)
				loop
					
					if  i.tp_objeto <> 'OBJETO' OR prm_ident = 'destaque-objeto' then
					
						if ws_grupo <> i.tp_objeto then
							htp.p('<li class="group">'||i.tp_objeto||'</li>');
							ws_grupo := i.tp_objeto;
						end if;

						nested_test_list(prm_ref, i.cd_objeto, nvl(i.nm_objeto, i.cd_objeto)); 
						
					end if;
				end loop;
			
		when 'lista-objetos-fixo' then 
			ws_grupo := 'N/A';
			for i in (select cd_objeto, nm_objeto, tp_objeto 
			            from objetos 
				       where cd_objeto 
				          in (select cd_ponto 
						   	    from ponto_avaliacao 
						  	   where cd_micro_visao = prm_visao 
						         and (cd_ponto 
							     not in (select trim(cd_objeto_go) 
									  	   from goto_objeto t2 
								 		  where upper(trim(t2.cd_objeto)) = upper(trim(prm_adicional))
								   		)	 
									 )	 
							 ) 
				    	 and tp_objeto in ('CONSULTA', 'VALOR') 
				  	   order by tp_objeto, nm_objeto
					 ) 
			loop

				
				if (i.tp_objeto <> 'PONTEIRO' AND i.tp_objeto <> 'VALOR' AND i.tp_objeto <> 'GRAFICO' AND i.tp_objeto <> 'OBJETO') OR prm_ident = 'destaque-objeto' then
				
					if ws_grupo <> i.tp_objeto then
						htp.p('<li class="group">'||i.tp_objeto||'</li>');
						ws_grupo := i.tp_objeto;
					end if;

					nested_test_list(prm_ref, i.cd_objeto, nvl(i.nm_objeto, i.cd_objeto));

				end if;
			end loop;
			
		when 'lista-objetos-call' then 

			fcl.fakeCustom('search', prm_search);

			ws_grupo := 'N/A';
			for i in (select cd_objeto, nm_objeto, tp_objeto from objetos where cd_objeto in 
			(select cd_ponto from ponto_avaliacao where cd_micro_visao = prm_visao and (
				cd_ponto not in (select nvl(trim(cd_objeto), 'N/A') from call_list t3 where upper(trim(t3.cd_list)) = upper(trim(prm_adicional)))) ) and 
				upper(trim(cd_objeto)) <> upper(trim(nvl(prm_adicional, 'N/A'))) and 
				(upper(cd_objeto) like ('%'||upper(nvl(ws_search, cd_objeto))||'%') or 
				upper(nm_objeto) like ('%'||upper(nvl(ws_search, nm_objeto))||'%') or
				upper(cod) like ('%'||upper(nvl(ws_search, cod))||'%'))				
				order by tp_objeto, nm_objeto) loop
				
				if ws_grupo <> i.tp_objeto then
					htp.p('<li class="group">'||i.tp_objeto||'</li>');
					ws_grupo := i.tp_objeto;
				end if;
				
				nested_test_list(prm_ref, i.cd_objeto, nvl(i.nm_objeto, i.cd_objeto));
			end loop;

			for i in (select cd_objeto, nm_objeto, tp_objeto from objetos where cd_objeto not in 
			(select cd_ponto from ponto_avaliacao where cd_micro_visao = prm_visao and (
				cd_ponto not in (select nvl(trim(cd_objeto), 'N/A') from call_list t3 where upper(trim(t3.cd_list)) = upper(trim(prm_adicional)))) ) and
				tp_objeto = 'RELATORIO' and 
				upper(trim(cd_objeto)) <> upper(trim(nvl(prm_adicional, 'N/A'))) and 
				(upper(cd_objeto) like ('%'||upper(nvl(ws_search, cd_objeto))||'%') or 
				upper(nm_objeto) like ('%'||upper(nvl(ws_search, nm_objeto))||'%') or
				upper(cod) like ('%'||upper(nvl(ws_search, cod))||'%'))				
				order by tp_objeto, nm_objeto) loop
				
				if ws_grupo <> i.tp_objeto then
					htp.p('<li class="group">'||i.tp_objeto||'</li>');
					ws_grupo := i.tp_objeto;
				end if;
				
				nested_test_list(prm_ref, i.cd_objeto, nvl(i.nm_objeto, i.cd_objeto));
			end loop;
			
		when 'lista-estados' then 
			begin
				select propriedade into ws_sql from object_attrib where cd_object = prm_visao and cd_prop = 'ESTADOS';
			exception when others then
				ws_sql := '';
			end;

			ws_grupo := 'N/A';
			if nvl(fun.ret_var('NOVA_TABELA_CIDADES'),'N') = 'S' then 
				for i in (select distinct cd_estado from bi_estados order by cd_estado ) loop
					nested_test_list(ws_sql, i.cd_estado, i.cd_estado);
				end loop;
			else
				for i in (select distinct cd_estado from bi_estados_brasil order by cd_estado ) loop
					nested_test_list(ws_sql, i.cd_estado, i.cd_estado);
				end loop;
			end if; 
		
		when 'lista-regioes' then 
			begin
				select propriedade into ws_sql from object_attrib where cd_object = prm_visao and cd_prop = 'REGIOES';
			exception when others then
				ws_sql := '';
			end;

			ws_grupo := 'N/A';

			for i in (select distinct cd_regiao from bi_regioes order by cd_regiao) loop
				nested_test_list(ws_sql, i.cd_regiao, i.cd_regiao);
			end loop;
		
		when 'lista-limitador' then

			begin
				select nds_cd_codigo, nds_tfisica, nds_cd_descricao, tipo into ws_codigo, ws_tabela, ws_descricao, ws_tipo from CODIGO_DESCRICAO where (upper(nds_tabela) = upper(prm_visao) or upper(nds_tfisica) = upper(prm_visao)) and rownum = 1;

				if ws_tipo = 'LISTA' then
					ws_sql := 'select CD_COLUNA, CD_CONTEUDO from TABLE(FUN.VPIPE_PAR('''||ws_tabela||'''))';
				else 
					ws_sql := 'select '||trim(ws_codigo)||', '||trim(ws_descricao)||' from '||ws_owner_td||'.'||trim(ws_tabela)||'';
				end if;

				ws_cursor := dbms_sql.open_cursor;
				dbms_sql.parse(ws_cursor, ws_sql, DBMS_SQL.NATIVE);
				dbms_sql.define_column(ws_cursor, 1, ws_codigo, 200);
				dbms_sql.define_column(ws_cursor, 2, ws_descricao, 200);

				ws_linhas := dbms_sql.execute(ws_cursor);

				loop

					ws_linhas := dbms_sql.fetch_rows(ws_cursor);
					if ws_linhas <> 1 then
						exit;
					end if;

					dbms_sql.column_value(ws_cursor, 1, ws_codigo);
					dbms_sql.column_value(ws_cursor, 2, ws_descricao);
					ws_count := 0;
					select count(*) into ws_count from table(fun.vpipe((select propriedade from object_attrib where cd_prop = 'LIMITADORES' and cd_object = prm_ident))) where column_value = ws_codigo;

					if ws_count > 0 then
						htp.p('<li class="opt selected" title="'||ws_codigo||'">'||ws_descricao||'</li>');
					else
						htp.p('<li class="opt" title="'||ws_codigo||'">'||ws_descricao||'</li>');
					end if;

				end loop;
				dbms_sql.close_cursor(ws_cursor);
			exception when others then
				htp.p(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - '||ws_sql);
			end;

		when 'lista-msg-tempo' then

			htp.p('<li title="0" class="opt">'||fun.lang('Permanente')||'</li>');
			htp.p('<li title="'||(last_day(trunc(sysdate))-trunc(sysdate))||'" class="opt">'||fun.lang('M&ecirc;s corrente')||'</li>');
			htp.p('<li title="'||((to_date(to_char(sysdate,'YYYY')||'1231','YYYYMMDD'))-trunc(sysdate))||'" class="opt">'||fun.lang('Ano corrente')||'</li>');
			htp.p('<li title="15" class="opt">15 '||fun.lang('dias')||'</li>');
			htp.p('<li title="30" class="opt">30 '||fun.lang('dias')||'</li>');
			htp.p('<li title="60" class="opt">60 '||fun.lang('dias')||'</li>');
			htp.p('<li title="90" class="opt">90 '||fun.lang('dias')||'</li>');

		when 'lista-usuarios-grupos' then

			fcl.fakeCustom('search', prm_search, 'noscript');
		
			select count(*) into ws_count from gusers where upper(cd_group) in (select upper(cd_group) from gusers_itens where upper(cd_usuario) like ('%'||upper(prm_search)||'%'));

			if ws_count > 0 then
				htp.p('<li class="group">'||fun.lang('GRUPOS')||'</li>');
				for i in (select cd_group, nm_group, t2.usuario
				from gusers t1
				left join user_screens t2 on t2.usuario = t1.cd_group and screen = prm_adicional
				where upper(cd_group) in (select upper(cd_group) from gusers_itens where upper(cd_usuario) like ('%'||upper(prm_search)||'%')) order by nm_group ) loop
					if length(i.usuario) > 0 then
						htp.p('<li title="'||i.cd_group||'" class="opt selected" onmouseover="updatePermissao(this, ''over'');" onmousedown="updatePermissao(this);">'||i.nm_group||'</li>');
					else
						htp.p('<li title="'||i.cd_group||'" class="opt" onmouseover="updatePermissao(this, ''over'');" onmousedown="updatePermissao(this);">'||i.nm_group||'</li>');
					end if; 
					
				end loop;
			end if;
			
			ws_descricao := 'USU&Aacute;RIOS ATIVOS';
			
			htp.p('<li class="group">'||fun.lang('USU&Aacute;RIOS')||'</li>');
			
			if nvl(prm_adicional, 'N/A') <> 'N/A' then

				for i in (
					select T1.usu_nome, T1.usu_completo, decode(T1.status, 'A', 'USU&Aacute;RIOS ATIVOS', 'USU&Aacute;RIOS INATIVOS') as status, t2.usuario
					from usuarios T1 
					LEFT JOIN user_screens T2 ON T2.USUARIO = T1.USU_NOME and screen = prm_adicional
					where upper(usu_nome) like ('%'||upper(prm_search)||'%') or upper(usu_completo) like ('%'||upper(prm_search)||'%') 
					order by status, usu_nome asc) loop
				
					if ws_descricao <> i.status then
						ws_descricao := i.status;
						htp.p('<li class="group">'||ws_descricao||'</li>');
					end if;

						if length(i.usuario) > 0 then
							htp.p('<li title="'||i.usu_nome||'" class="opt selected" onmouseover="updatePermissao(this, ''over'');" onmousedown="updatePermissao(this);">'||i.usu_nome||'</li>');
						else
							htp.p('<li title="'||i.usu_nome||'" class="opt" onmouseover="updatePermissao(this, ''over'');" onmousedown="updatePermissao(this);">'||i.usu_nome||'</li>');
						end if; 
				end loop;

			else

				for i in (
					select T1.usu_nome, T1.usu_completo, decode(T1.status, 'A', 'USU&Aacute;RIOS ATIVOS', 'USU&Aacute;RIOS INATIVOS') as status
					from usuarios T1 
					where upper(usu_nome) like ('%'||upper(prm_search)||'%') or upper(usu_completo) like ('%'||upper(prm_search)||'%') 
					order by status, usu_nome asc) loop
				
					if ws_descricao <> i.status then
						ws_descricao := i.status;
						htp.p('<li class="group">'||ws_descricao||'</li>');
					end if;
				
					nested_test_list(prm_ref, i.usu_nome, i.usu_nome);

				end loop;

			end if;
		when 'lista-usuario-grupo' then

			fcl.fakeCustom('search', prm_search, 'noscript');

			-- Lista Grupo de usuários 
			select count(*) into ws_count from gusers 
			where cd_group in (select cd_group from gusers_itens where cd_usuario like ('%'||upper(prm_search)||'%'));

			if ws_count > 0 then
				htp.p('<li class="group">'||fun.lang('GRUPOS')||'</li>');
				for i in (select cd_group, nm_group, t2.usuario
							from gusers t1
							left join user_screens t2 on t2.usuario = t1.cd_group and t2.screen = prm_adicional
						where cd_group in (select cd_group from gusers_itens where cd_usuario like ('%'||upper(prm_search)||'%')) order by nm_group ) loop
					if length(i.usuario) > 0 or i.cd_group = prm_ref then
						htp.p('<li title="'||i.cd_group||'" class="opt selected">'||i.nm_group||'</li>');
					else
						htp.p('<li title="'||i.cd_group||'" class="opt">'||i.nm_group||'</li>');
					end if; 
					
				end loop;
			end if;
			
			-- Lista usuários 
			ws_descricao := 'USU&Aacute;RIOS ATIVOS';
			htp.p('<li class="group">'||fun.lang('USU&Aacute;RIOS')||'</li>');
			
			if nvl(prm_adicional, 'N/A') <> 'N/A' then

				for i in ( select T1.usu_nome, decode(T1.usu_nome,'DWU','TODOS',T1.usu_nome) as nm_usuario, decode(T1.status, 'A', 'USU&Aacute;RIOS ATIVOS', 'USU&Aacute;RIOS INATIVOS') as status, t2.usuario
							from usuarios T1 
							LEFT JOIN user_screens T2 ON (T2.USUARIO = T1.USU_NOME and T2.screen = prm_adicional) 
							where (usu_nome like '%'||upper(prm_search)||'%' or upper(usu_completo) like '%'||upper(prm_search)||'%' ) 
							order by decode(usu_nome,'DWU',1,2), T1.status, usu_nome asc
						) loop
					if ws_descricao <> i.status then
						ws_descricao := i.status;
						htp.p('<li class="group">'||ws_descricao||'</li>');
					end if;
					ws_class := ''; 	
					if i.usu_nome = 'DWU' then ws_class := ' opt-bold '; end if; 
					if length(i.usuario) > 0 then
						htp.p('<li title="'||i.usu_nome||'" class="opt selected '||ws_class||'" onmouseover="updatePermissao(this, ''over'');" onmousedown="updatePermissao(this);">'||i.nm_usuario||'</li>');
					else
						htp.p('<li title="'||i.usu_nome||'" class="opt '||ws_class||'" onmouseover="updatePermissao(this, ''over'');" onmousedown="updatePermissao(this);">'||i.nm_usuario||'</li>');
					end if; 
				end loop;

			else

				for i in ( select T1.usu_nome, decode(T1.usu_nome,'DWU','TODOS',T1.usu_nome) as nm_usuario, decode(T1.status, 'A', 'USU&Aacute;RIOS ATIVOS', 'USU&Aacute;RIOS INATIVOS') as status
							from usuarios T1 
							where usu_nome            like ('%'||upper(prm_search)||'%') 
							or upper(usu_completo) like ('%'||upper(prm_search)||'%') 
							order by decode(usu_nome,'DWU',1,2), status, usu_nome asc
						) loop
				
					if ws_descricao <> i.status then
						ws_descricao := i.status;
						htp.p('<li class="group">'||ws_descricao||'</li>');
					end if;
					ws_class := ''; 
					if i.usu_nome = 'DWU' then ws_class := ' opt-bold '; end if; 
					nested_test_list(prm_ref, i.usu_nome, i.nm_usuario, prm_com_cod => 'N', prm_class => ws_class);

				end loop;

			end if;

		when 'lista-usuarios-grupos-prop' then

			fcl.fakeCustom('search', prm_search, 'noscript');

			nested_test_list(prm_ref, 'NENHUM', 'NENHUM', prm_com_cod => 'N', prm_class => ' opt-bold ');
			nested_test_list(prm_ref, 'DWU',    'TODOS',  prm_com_cod => 'N', prm_class => ' opt-bold ');

			select count(*) into ws_count 
			from gusers t1
			where exists (select 1 from gusers_itens t2 where t2.cd_group = t1.cd_group )
			and (cd_group like '%'||upper(prm_search)||'%' or upper(nm_group) like '%'||upper(prm_search)||'%') ; 

			if ws_count > 0 then 				-- Grupos que possuem usuário
				htp.p('<li class="group">'||fun.lang('GRUPOS')||'</li>');
				for i in (select cd_group, nm_group   
							from gusers t1
						where exists (select 1 from gusers_itens t2 where t2.cd_group = t1.cd_group )
							and (cd_group like '%'||upper(prm_search)||'%' or upper(nm_group) like '%'||upper(prm_search)||'%') 
						order by nm_group 
						) loop
					nested_test_list(prm_ref, i.cd_group, i.nm_group, prm_com_cod => 'N');							
				end loop;
			end if;
			
			ws_descricao := 'USU&Aacute;RIOS ATIVOS';
			
			htp.p('<li class="group">'||fun.lang('USU&Aacute;RIOS')||'</li>');
			
			for i in ( select T1.usu_nome, T1.usu_completo, decode(T1.status, 'A', 'USU&Aacute;RIOS ATIVOS', 'USU&Aacute;RIOS INATIVOS') as status
						from usuarios T1 
						where ( upper(usu_nome)     like ('%'||upper(prm_search)||'%') or 
								upper(usu_completo) like ('%'||upper(prm_search)||'%') )
						and usu_nome <> 'DWU'		
						order by status, usu_nome asc
					) loop
				if ws_descricao <> i.status then
					ws_descricao := i.status;
					htp.p('<li class="group">'||fun.lang(ws_descricao)||'</li>');
				end if;
				nested_test_list(prm_ref, i.usu_nome, i.usu_nome, prm_com_cod => 'N');
			end loop;


		when 'lista-usuarios-msgs' then
		
			htp.p('<li class="group">'||fun.lang('CATEGORIAS')||'</li>');
			for i in (select cd_group, nm_group from gusers order by nm_group ) loop

				select count(*) into ws_count from text_post where cd_group in (select cd_group from gusers_itens where cd_usuario = ws_usuario);

				if ws_count = 1 then
					nested_test_list(prm_ref, i.cd_group, trim(i.nm_group)||' - 1 mensagem');
				elsif ws_count <> 0 then
					nested_test_list(prm_ref, i.cd_group, trim(i.nm_group)||' - '||ws_count||' mensagens');
				else
					nested_test_list(prm_ref, i.cd_group, trim(i.nm_group));
				end if;

			end loop;
			
			ws_descricao := 'USU&Aacute;RIOS ATIVOS';
			
			htp.p('<li class="group">'||fun.lang('USU&Aacute;RIOS')||'</li>');
			for i in (select usu_nome, usu_completo, decode(status, 'A', 'USU&Aacute;RIOS ATIVOS', 'USU&Aacute;RIOS INATIVOS') as status from usuarios where usu_nome <> gbl.getUsuario order by status, usu_nome asc) loop
			
				if ws_descricao <> i.status then
					ws_descricao := i.status;
					htp.p('<li class="group">'||ws_descricao||'</li>');
				end if;

				ws_count := 0;
				
				select count(*) into ws_count from text_post where cd_usuario = i.usu_nome and cd_group = ws_usuario/* or cd_group in (select cd_group from gusers_itens where cd_usuario = ws_usuario)*/;
				
				if ws_count = 1 then
					nested_test_list(prm_ref, i.usu_nome, i.usu_nome||' - 1 mensagem');
				elsif ws_count <> 0 then
					nested_test_list(prm_ref, i.usu_nome, i.usu_nome||' - '||ws_count||' mensagens');
				else
					nested_test_list(prm_ref, i.usu_nome, i.usu_nome);
				end if;
			end loop;

		when 'lista-usuarios' then

			ws_descricao := 'USU&Aacute;RIOS ATIVOS';

			fcl.fakeCustom('search', prm_search);

			if prm_ident = 'fake-permissao' then
				htp.p('<li title="" class="opt">NENHUMA PERMISS&Atilde;O</li>');
			end if;

			for i in (select decode(usu_nome,'DWU',1,2) as ordem, usu_nome, decode(usu_nome,'DWU','TODOS',usu_nome) nm_usuario, usu_completo, decode(status, 'A', 'USU&Aacute;RIOS ATIVOS', 'USU&Aacute;RIOS INATIVOS') as status 
						from usuarios 
					where ( upper(usu_nome) like ('%'||upper(prm_search)||'%') or 
							upper(usu_completo) like ('%'||upper(prm_search)||'%') 
							)   
					order by status, ordem, usu_nome asc) loop

				if ws_descricao <> i.status then
					ws_descricao := i.status;
					htp.p('<li class="group">'||ws_descricao||'</li>');
				end if;
				ws_class := ''; 
				if i.usu_nome = 'DWU' then 
					ws_class := ' opt-bold opt-unico '; 
				end if; 
				nested_test_list(prm_ref, i.usu_nome, i.nm_usuario, prm_com_cod => 'N', prm_class => ws_class );
			end loop;

		when 'lista-usuarios-filtros' then

			ws_descricao := 'USU&Aacute;RIOS ATIVOS';

			fcl.fakeCustom('search', prm_search);

			if prm_ident = 'fake-permissao' then
				htp.p('<li title="" class="opt">NENHUMA PERMISS&Atilde;O</li>');
			end if;

			for i in (select decode(usu_nome,'DWU',1,2) as ordem, usu_nome, decode(usu_nome,'DWU','TODOS',usu_nome) nm_usuario, usu_completo, decode(status, 'A', 'USU&Aacute;RIOS ATIVOS', 'USU&Aacute;RIOS INATIVOS') as status 
						from usuarios 
					where ( upper(usu_nome) like ('%'||upper(prm_search)||'%') or 
							upper(usu_completo) like ('%'||upper(prm_search)||'%') 
							)   
					order by status, ordem, usu_nome asc) loop

				if ws_descricao <> i.status then
					ws_descricao := i.status;
					htp.p('<li class="group">'||ws_descricao||'</li>');
				end if;
				ws_class := ''; 
				if i.usu_nome = 'DWU' then 
					ws_class := ' opt-bold opt-unico '; 
				end if; 

				nested_test_list(prm_ref, i.usu_nome, i.nm_usuario, prm_com_cod => 'N', prm_class => ws_class );
			end loop;
		
		when 'lista-cadastrar-filtro' then

			if prm_ref is null then
				htp.p('<li onclick="copfilter(''NovoFiltro'');" title="NovoFiltro" class="opt selected">Novo Filtro</li>');
			elsif trim(prm_ref) = 'NovoFiltro' then
				htp.p('<li onclick="copfilter(''NovoFiltro'');" title="NovoFiltro" class="opt selected">Novo Filtro</li>');
			else
				htp.p('<li onclick="copfilter(''NovoFiltro'');" title="NovoFiltro" class="opt">'||fun.lang('Novo Filtro')||'</li>');
			end if;
			
		 	if trim(prm_ref) = 'CopiarUsuario' then
				htp.p('<li onclick="copfilter(''CopiarUsuario'');" title="CopiarUsuario" class="opt selected">Copiar usuario</li>');
			else
				htp.p('<li onclick="copfilter(''CopiarUsuario'');" title="CopiarUsuario" class="opt">'||fun.lang('Copiar usu&aacute;rio')||'</li>');
			end if;


		when 'lista-usuarios-sem-dwu' then

			ws_descricao := 'USU&Aacute;RIOS ATIVOS';
			fcl.fakeCustom('search', prm_search);

			for i in (select usu_nome, usu_nome nm_usuario, usu_completo, decode(status, 'A', 'USU&Aacute;RIOS ATIVOS', 'USU&Aacute;RIOS INATIVOS') as status 
						from usuarios 
					   where ( upper(usu_nome) like ('%'||upper(prm_search)||'%') or upper(usu_completo) like ('%'||upper(prm_search)||'%') )   
					     and usu_nome <> 'DWU'		
					   order by status, usu_nome) loop
				if ws_descricao <> i.status then
					ws_descricao := i.status;
					htp.p('<li class="group">'||ws_descricao||'</li>');
				end if;
				ws_class := ''; 
				nested_test_list(prm_ref, i.usu_nome, i.nm_usuario, prm_com_cod => 'N', prm_class => ws_class );
			end loop;

		when 'lista-usuarios-admin' then

			ws_descricao := 'USU&Aacute;RIOS ATIVOS';
			fcl.fakeCustom('search', prm_search);

			for i in (select decode(usu_nome,'DWU',1,2) as ordem, usu_nome, decode(usu_nome,'DWU','ADMIN',usu_nome) nm_usuario, usu_completo, decode(status, 'A', 'USU&Aacute;RIOS ATIVOS', 'USU&Aacute;RIOS INATIVOS') as status 
						from usuarios 
					where ( upper(usu_nome) like ('%'||upper(prm_search)||'%') or 
							upper(usu_completo) like ('%'||upper(prm_search)||'%') 
							)   
					order by status, ordem, usu_nome asc) loop

				if ws_descricao <> i.status then
					ws_descricao := i.status;
					htp.p('<li class="group">'||ws_descricao||'</li>');
				end if;
				ws_class := ''; 
				if i.usu_nome = 'DWU' then ws_class := ' opt-bold opt-unico '; end if; 
				nested_test_list(prm_ref, i.usu_nome, i.nm_usuario, prm_com_cod => 'N', prm_class => ws_class );
			end loop;

		when 'lista-email' then

			ws_descricao := 'USU&Aacute;RIOS ATIVOS';

			--fcl.fakeCustom('search', prm_search);
			fcl.fakeCustom('add', prm_search);

			if prm_ident = 'fake-permissao' then
				htp.p('<li title="" class="opt">NENHUMA PERMISS&Atilde;O</li>');
			end if;

			for i in (select upper(usu_email)    as email from usuarios where usu_email is not null and status = 'A' order by 1	 ) loop
				nested_test_list(prm_ref, i.email, i.email);
			end loop;

		when 'lista-tipos' then
			if trim(prm_ref) = 'SEM' then
				htp.p('<li title="SEM" class="opt selected">'||fun.lang('SEM')||'</li>');
			else
				htp.p('<li title="SEM" class="opt">'||fun.lang('SEM')||'</li>');
			end if;

			if trim(prm_ref) = 'DATA' then
				htp.p('<li title="DATA" class="opt selected">'||fun.lang('DATA')||'</li>');
			else
				htp.p('<li title="DATA" class="opt">'||fun.lang('DATA')||'</li>');
			end if;

			if trim(prm_ref) = 'DATA2' then
				htp.p('<li title="DATA2" class="opt selected">'||fun.lang('DATA SEM CALEND&Aacute;RIO')||'</li>');
			else
				htp.p('<li title="DATA2" class="opt">'||fun.lang('DATA SEM CALEND&Aacute;RIO')||'</li>');
			end if;
			
			if trim(prm_ref) = 'TEXTO' then
				htp.p('<li title="TEXTO" class="opt selected">'||fun.lang('TEXTO')||'</li>');
			else
				htp.p('<li title="TEXTO" class="opt">'||fun.lang('TEXTO')||'</li>');
			end if;
			
			if trim(prm_ref) = 'LIGACAO' then
				htp.p('<li title="LIGACAO" class="opt selected">'||fun.lang('LIGA&Ccedil;&Atilde;O')||'</li>');
			else
				htp.p('<li title="LIGACAO" class="opt">'||fun.lang('LIGA&Ccedil;&Atilde;O')||'</li>');
			end if;

		when 'lista-condicoes' then
			if trim(prm_ref) = 'IGUAL' then
				htp.p('<li title="IGUAL" class="opt selected">'||fun.lang('IGUAL A')||'</li>');
			else
				htp.p('<li title="IGUAL" class="opt">'||fun.lang('IGUAL A')||'</li>');
			end if;
			
			if trim(prm_ref) = 'DIFERENTE' then
				htp.p('<li title="DIFERENTE" class="opt selected">'||fun.lang('DIFERENTE DE')||'</li>');
			else
				htp.p('<li title="DIFERENTE" class="opt">'||fun.lang('DIFERENTE DE')||'</li>');
			end if;
			
			if trim(prm_ref) = 'MAIOR' then
				htp.p('<li title="MAIOR" class="opt selected">'||fun.lang('MAIOR QUE')||'</li>');
			else
				htp.p('<li title="MAIOR" class="opt">'||fun.lang('MAIOR QUE')||'</li>');
			end if;
			
			if trim(prm_ref) = 'MENOR' then
				htp.p('<li title="MENOR" class="opt selected">'||fun.lang('MENOR QUE')||'</li>');
			else
				htp.p('<li title="MENOR" class="opt">'||fun.lang('MENOR QUE')||'</li>');
			end if;
			
			if trim(prm_ref) = 'MAIOROUIGUAL' then
				htp.p('<li title="MAIOROUIGUAL" class="opt selected">'||fun.lang('MAIOR OU IGUAL A')||'</li>');
			else
				htp.p('<li title="MAIOROUIGUAL" class="opt">'||fun.lang('MAIOR OU IGUAL A')||'</li>');
			end if;
			
			if trim(prm_ref) = 'MENOROUIGUAL' then
				htp.p('<li title="MENOROUIGUAL" class="opt selected">'||fun.lang('MENOR OU IGUAL A')||'</li>');
			else
				htp.p('<li title="MENOROUIGUAL" class="opt">'||fun.lang('MENOR OU IGUAL A')||'</li>');
			end if;
			
			if prm_adicional = 'graph' then
				
				if trim(prm_ref) = 'LIKE' then
					htp.p('<li title="LIKE" class="opt selected">'||fun.lang('SEMELHANTE A(LIKE)')||'</li>');
				else
					htp.p('<li title="LIKE" class="opt">'||fun.lang('SEMELHANTE A(LIKE)')||'</li>');
				end if;
				
				if trim(prm_ref) = 'NOTLIKE' then
					htp.p('<li title="NOTLIKE" class="opt selected">'||fun.lang('DIFERENTE(NOT LIKE) DE')||'</li>');
				else
					htp.p('<li title="NOTLIKE" class="opt">'||fun.lang('DIFERENTE(NOT LIKE) DE')||'</li>');
				end if;

				if trim(prm_ref) = 'COLUNA' then
					htp.p('<li title="COLUNA" class="opt selected">'||fun.lang('COLUNA')||'</li>');
				else
					htp.p('<li title="COLUNA" class="opt">'||fun.lang('COLUNA')||'</li>');
				end if;
				
			else
				if trim(prm_ref) = 'LIKE' then
					htp.p('<li title="LIKE" class="opt selected">'||fun.lang('SEMELHANTE A(LIKE)')||'</li>');
				else
					htp.p('<li title="LIKE" class="opt">'||fun.lang('SEMELHANTE A(LIKE)')||'</li>');
				end if;
				
				if trim(prm_ref) = 'NOTLIKE' then
					htp.p('<li title="NOTLIKE" class="opt selected">'||fun.lang('DIFERENTE(NOT LIKE) DE')||'</li>');
				else
					htp.p('<li title="NOTLIKE" class="opt">'||fun.lang('DIFERENTE(NOT LIKE) DE')||'</li>');
				end if;
				
				if trim(prm_ref) = 'NOFLOAT' then
					htp.p('<li title="NOFLOAT" class="opt selected">'||fun.lang('IGNORAR FLOAT')||'</li>');
				else
					htp.p('<li title="NOFLOAT" class="opt">'||fun.lang('IGNORAR FLOAT')||'</li>');
				end if;

				if trim(prm_ref) = 'NOFILTER' then
					htp.p('<li title="NOFILTER" class="opt selected">'||fun.lang('IGNORAR FILTRO')||'</li>');
				else
					htp.p('<li title="NOFILTER" class="opt">'||fun.lang('IGNORAR FILTRO')||'</li>');
				end if;
			end if;
		
		when 'lista-coluna' then

			for i in (select column_name from ALL_TAB_COLUMNS where	owner=ws_owner_td and table_name = prm_visao order by column_name ) loop
				nested_test_list(prm_ref, i.column_name, i.column_name); 
			end loop;

		when 'lista-coluna-destaq-browser' then
		
			for i in (select cd_coluna, nm_rotulo from data_coluna 
					where cd_micro_data = prm_adicional 
						and ( (nvl(tipo,'NA') <> 'VIRTUAL') or (nvl(tipo,'NA') = 'VIRTUAL' and formula is not null) ) 
					order by cd_coluna ) loop
				nested_test_list(prm_ref, i.cd_coluna, i.nm_rotulo); 
			end loop;
		
		--a
		when 'lista-consultas' then
			
			ws_descricao := 'N/A';

			fcl.fakeCustom('search', prm_search);
			
			for i in (select cod, cd_objeto, nm_objeto, cd_grupo from objetos where tp_objeto = 'CONSULTA' 
				and (upper(trim(cd_objeto)) like ('%'||upper(trim(prm_search))||'%') or upper(nm_objeto) like ('%'||upper(nvl(prm_search, nm_objeto))||'%') )
				order by cd_grupo ) loop
				
				if ws_descricao <> i.cd_grupo then
					ws_descricao := i.cd_grupo;
					htp.p('<li class="group">'||ws_descricao||'</li>');
				end if;

				nested_test_list(prm_ref, i.cd_objeto, i.nm_objeto, i.cod);
			end loop;

			when 'lista-consultas-visao' then
			
			ws_descricao := 'N/A';

			fcl.fakeCustom('search', prm_search);
			
			for i in (select cod, cd_objeto, nm_objeto, cd_grupo from objetos 
			           where tp_objeto = 'CONSULTA' 
					     and (UPPER(cod) like ('%'||upper(nvl(prm_search, cod))||'%') or upper(nm_objeto) like ('%'||upper(nvl(prm_search, nm_objeto))||'%') ) 
						 and cd_objeto in (select cd_ponto from ponto_avaliacao where cd_micro_visao = prm_visao)
					  order by cd_grupo ) loop
				
				if ws_descricao <> i.cd_grupo then
					ws_descricao := i.cd_grupo;
					htp.p('<li class="group">'||ws_descricao||'</li>');
				end if;

				nested_test_list(prm_ref, i.cd_objeto, i.nm_objeto, i.cod);
			end loop;
		
		when 'lista-valores' then

			fcl.fakeCustom('add', prm_ref);

			begin
				
				begin			  
					select cd_ligacao into ws_ligacao from micro_coluna where cd_coluna = prm_adicional and cd_micro_visao = prm_visao;
				exception
				  when no_data_found then
				  	ws_ligacao:='SEM';
				end;

				if ws_ligacao <> 'SEM' then

					select nds_tfisica, nds_cd_codigo, nds_cd_descricao into ws_tabela, ws_codigo, ws_descricao 
					from codigo_descricao 
					where nds_tabela = ws_ligacao or nds_tfisica = ws_ligacao;
					--if nvl(ws_search, 'N/A') <> 'N/A' and ws_search <> prm_ref then
					--    ws_sql := 'select '||trim(ws_codigo)||', '||trim(ws_descricao)||', linha from (select '||trim(ws_codigo)||', '||trim(ws_descricao)||', rownum as linha from (select /*+ FIRST_ROWS(50) */ '||trim(ws_codigo)||', '||trim(ws_descricao)||' from '||nvl(fun.ret_var('OWNER_TABLE_DATA'),'DWU')||'.'||ws_tabela||' where '||trim(ws_codigo)||' like (''%'||upper(ws_search)||'%'') or '||trim(ws_descricao)||' like (''%'||upper(ws_search)||'%'') order by '||trim(ws_descricao)||' asc)) where linha < 51';
					--else
					--    ws_sql := 'select '||trim(ws_codigo)||', '||trim(ws_descricao)||', linha from (select '||trim(ws_codigo)||', '||trim(ws_descricao)||', rownum as linha from (select '||trim(ws_codigo)||', '||trim(ws_descricao)||' from '||nvl(fun.ret_var('OWNER_TABLE_DATA'),'DWU')||'.'||ws_tabela||' order by '||trim(ws_descricao)||' asc))';
					--end if;
					ws_sql := 'select '||trim(ws_codigo)||', '||trim(ws_descricao)||', linha from (select '||trim(ws_codigo)||', '||trim(ws_descricao)||', rownum as linha from (select '||trim(ws_codigo)||', '||trim(ws_descricao)||' from '||ws_owner_td||'.'||ws_tabela||' order by '||trim(ws_descricao)||' asc))';
					
					begin


						ws_cursor := dbms_sql.open_cursor;

						dbms_sql.parse(ws_cursor, ws_sql, DBMS_SQL.NATIVE);

						dbms_sql.define_column(ws_cursor, 1, ws_codigo, 200);
						dbms_sql.define_column(ws_cursor, 2, ws_descricao, 200);
						ws_linhas := dbms_sql.execute(ws_cursor);


						loop
							if dbms_sql.fetch_rows(ws_cursor) = 0 THEN
								exit;
							end if;
							ws_count := dbms_sql.last_row_count;
							dbms_sql.column_value(ws_cursor, 1, ws_codigo);
							dbms_sql.column_value(ws_cursor, 2, ws_descricao);
							if upper(trim(prm_ref)) = upper(trim(ws_codigo)) or upper(trim(prm_ref)) = upper(trim(ws_descricao)) then
								htp.p('<li title="'||trim(ws_codigo)||'" class="opt selected">'||trim(ws_descricao)||'</li>');
							else
								htp.p('<li title="'||trim(ws_codigo)||'" class="opt">'||trim(ws_descricao)||'</li>');
							end if;
						end loop;

						dbms_sql.close_cursor(ws_cursor);

					exception
						when no_data_found then  
							null;
						when others then
							htp.p(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||'  -  '||ws_sql);
					end;

				end if;
				
			end;
		when 'lista-input-browser' then

			for a in (	select 'data'       cd_tipo, 'DATA'        							   ds_tipo from dual where prm_adicional = 'DATE'     union all 
					  	select 'datatime'   cd_tipo, 'DATA E HORA' 							   ds_tipo from dual where prm_adicional = 'DATE'     union all
                        select 'calendario' cd_tipo, 'CALEND&Aacute;RIO'					 ds_tipo from dual where prm_adicional = 'DATE'     union all 
						select 'sequence'   cd_tipo, 'SEQU&Ecirc;NCIA'                         ds_tipo from dual where prm_adicional = 'NUMBER'   union all 						
						select 'sequence_max' cd_tipo, 'SEQU&Ecirc;NCIA &Uacute;LTIMO'         ds_tipo from dual where prm_adicional = 'NUMBER'   union all 						
					  	select 'text'       cd_tipo, 'TEXTO'       					  		   ds_tipo from dual where prm_adicional = 'VARCHAR2' union all 
					  	select 'textarea'   cd_tipo, 'TEXTO GRANDE'                            ds_tipo from dual where prm_adicional = 'VARCHAR2' union all 
						select 'textclob'   cd_tipo, 'TEXTO CLOB'                              ds_tipo from dual where prm_adicional in ('CLOB', 'VARCHAR2') and upper(nvl(fun.ret_var('BROWSER_INPUT_HTML'),'N')) = 'S' union all
						select 'htmlclob'   cd_tipo, 'TEXTO HTML'                              ds_tipo from dual where prm_adicional in ('CLOB', 'VARCHAR2') and upper(nvl(fun.ret_var('BROWSER_INPUT_HTML'),'N')) = 'S' union all
						select 'number'     cd_tipo, 'N&Uacute;MERO'                           ds_tipo from dual where prm_adicional not in ('CLOB') union all 
						select 'ligacao'    cd_tipo, 'LIGA&Ccedil;&Atilde;O'                   ds_tipo from dual where prm_adicional not in ('CLOB') union all 
						select 'ligacaoc'   cd_tipo, 'LIGA&Ccedil;&Atilde;O COM C&Oacute;DIGO' ds_tipo from dual where prm_adicional not in ('CLOB') union all 
						select 'listboxp'   cd_tipo, 'LISTA PR&Eacute;-DEFINIDA'               ds_tipo from dual where prm_adicional not in ('CLOB') union all 
						select 'listboxt'   cd_tipo, 'LISTA TABELA (COD)'                      ds_tipo from dual where prm_adicional not in ('CLOB') union all 
						select 'listboxtd'  cd_tipo, 'LISTA TABELA (DESC)'                     ds_tipo from dual where prm_adicional not in ('CLOB') union all 
						select 'listboxtcd' cd_tipo, 'LISTA TABELA (COD+DESC)'                 ds_tipo from dual where prm_adicional not in ('CLOB') union all 
						select 'checkbox' cd_tipo, 'CHECKBOX'                                  ds_tipo from dual where prm_adicional not in ('CLOB') union all 
						select 'link'     cd_tipo, 'LINK'                                      ds_tipo from dual where prm_adicional not in ('CLOB') 
					  order by 2) loop  
				if prm_ref = a.cd_tipo then
					htp.p('<li title="'||a.cd_tipo||'"   class="opt selected">'||a.ds_tipo||'</li>');
				else
					htp.p('<li title="'||a.cd_tipo||'"   class="opt">'||a.ds_tipo||'</li>');
				end if;
			end loop; 		  

		when 'lista-input-browser-calc' then

			ws_selected_txt := ''; 
			if prm_ref = 'botao'     then  	ws_selected_txt := 'selected';   end if; 	
			htp.p('<li title="botao" class="opt '||ws_selected_txt||'">BOT&Atilde;O</li>');
			
			ws_selected_txt := ''; 
			if prm_ref = 'calculada' then  	ws_selected_txt := 'selected';   end if; 	
			htp.p('<li title="calculada" class="opt '||ws_selected_txt||'">CALCULADA</li>');


		when 'lista-permissao-browser' then

			--begin  2222
			--	select trim(permissao) into ws_sql from data_coluna where trim(cd_micro_data) = trim(prm_visao) and trim(cd_coluna) = trim(prm_adicional);
			--exception when others then
			--	ws_sql := '';
			--end;

			nested_test_list(prm_ref, 'W' ,  'TODOS', prm_com_cod => 'N', prm_class => ' opt-bold opt-unico');
			nested_test_list(prm_ref, 'R' , 'NENHUM', prm_com_cod => 'N', prm_class => ' opt-bold opt-unico');
			nested_test_list(prm_ref, 'DWU', 'ADMIN', prm_com_cod => 'N', prm_class => ' opt-bold opt-unico');

			for i in ( select usu_completo, usu_nome from usuarios where usu_nome <> 'DWU' and usu_nome in (select usuario from user_screens where screen in (select screen from object_location where object_id = prm_visao)) order by usu_nome ) loop
				nested_test_list(prm_ref, i.usu_nome, i.usu_nome);
			end loop;

		when 'lista-padroes-unicos' then

			htp.p('<li title="" class="opt">---</li>');
			for i in ( select cd_padrao, nm_padrao from parametro_padrao order by cd_padrao ) loop
				--nested_test_list(trim(upper(prm_ref)), upper(trim(i.cd_padrao)), upper(trim(i.nm_padrao)));
				nested_list_order(trim(upper(prm_ref)), upper(trim(i.cd_padrao)), upper(trim(i.nm_padrao)), ws_padrao);
			end loop;

		when 'lista-filtros-usuarios' then

			htp.p('<li title="" class="opt">---</li>');
			for i in ( select distinct cd_coluna from filtros where tp_filtro = 'geral' order by cd_coluna ) loop
				nested_list_order(prm_ref, i.cd_coluna, i.cd_coluna, ws_padrao);
			end loop;

		when 'lista-permissao-browser-op' then 

			begin
				select trim(propriedade) into ws_sql from object_attrib where trim(cd_prop) = prm_adicional and trim(cd_object) = trim(prm_visao);
			exception when others then
				ws_sql := '';
			end;
				
			for i in ( select decode(usu_nome,'DWU',1,2) ordem_select, usu_completo, usu_nome, decode(usu_nome,'DWU','TODOS',usu_nome) nm_usuario 
							from usuarios where usu_nome in (select usuario from user_screens where screen in (select screen from object_location where object_id = prm_visao)) 
						order by ordem_select, usu_nome ) loop
				ws_class := ''; 
				if i.usu_nome = 'DWU' then ws_class := ' opt-bold opt-unico '; end if; 
				nested_test_list(ws_sql, i.usu_nome, i.nm_usuario, prm_com_cod => 'N', prm_class => ws_class);
			end loop;

		when 'browser-colunas-filtro' then 

			begin
				select trim(propriedade) into ws_sql from object_attrib where cd_object = trim(prm_visao) and cd_prop = prm_adicional ;
			exception when others then
				ws_sql := '';
			end;

			if ws_sql is null then 
				ws_sql := 'TODOS';
			end if; 
				
			nested_test_list(ws_sql, 'TODOS',  'TODAS',   prm_class => ' opt-bold opt-unico ');	
			nested_test_list(ws_sql, 'NENHUM', 'NENHUMA', prm_class => ' opt-bold opt-unico ');	

			for i in ( select cd_coluna, nm_rotulo from data_coluna where cd_micro_data = prm_visao order by st_chave desc, ordem asc, cd_coluna asc) loop
				nested_test_list(ws_sql, i.cd_coluna, i.nm_rotulo);
			end loop;


		when 'lista-valores-browser' then 

			fcl.fakeCustom('add', prm_ref);
			
			begin

				begin			  
					select cd_ligacao into ws_ligacao 
					  from data_coluna 
					 where cd_coluna 	 = prm_adicional 
					   and cd_micro_data = prm_obj;
				exception
				  when no_data_found then
				  	ws_ligacao:='SEM';
				  when others then
				  	ws_ligacao := 'SEM';
					insert into bi_log_sistema values(sysdate, 'Obj: '||prm_obj||' fakelistoptions ('||prm_campo||') :'||DBMS_UTILITY.FORMAT_ERROR_STACK||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, gbl.getusuario, 'ERRO');
    				commit;
					
				end;

				if nvl(ws_ligacao,'SEM') <> 'SEM' then

					select nds_tfisica, nds_cd_codigo, nds_cd_descricao into ws_tabela, ws_codigo, ws_descricao 
					from codigo_descricao 
					where nds_tabela = ws_ligacao or nds_tfisica = ws_ligacao;
					--if nvl(ws_search, 'N/A') <> 'N/A' and ws_search <> prm_ref then
					--    ws_sql := 'select '||trim(ws_codigo)||', '||trim(ws_descricao)||', linha from (select '||trim(ws_codigo)||', '||trim(ws_descricao)||', rownum as linha from (select /*+ FIRST_ROWS(50) */ '||trim(ws_codigo)||', '||trim(ws_descricao)||' from '||nvl(fun.ret_var('OWNER_TABLE_DATA'),'DWU')||'.'||ws_tabela||' where '||trim(ws_codigo)||' like (''%'||upper(ws_search)||'%'') or '||trim(ws_descricao)||' like (''%'||upper(ws_search)||'%'') order by '||trim(ws_descricao)||' asc)) where linha < 51';
					--else
					--    ws_sql := 'select '||trim(ws_codigo)||', '||trim(ws_descricao)||', linha from (select '||trim(ws_codigo)||', '||trim(ws_descricao)||', rownum as linha from (select '||trim(ws_codigo)||', '||trim(ws_descricao)||' from '||nvl(fun.ret_var('OWNER_TABLE_DATA'),'DWU')||'.'||ws_tabela||' order by '||trim(ws_descricao)||' asc))';
					--end if;
					ws_sql := 'select '||trim(ws_codigo)||', '||trim(ws_descricao)||', linha from (select '||trim(ws_codigo)||', '||trim(ws_descricao)||', rownum as linha from (select '||trim(ws_codigo)||', '||trim(ws_descricao)||' from '||ws_owner_td||'.'||ws_tabela||' order by '||trim(ws_descricao)||' asc))';
					
					begin


						ws_cursor := dbms_sql.open_cursor;

						dbms_sql.parse(ws_cursor, ws_sql, DBMS_SQL.NATIVE);

						dbms_sql.define_column(ws_cursor, 1, ws_codigo, 200);
						dbms_sql.define_column(ws_cursor, 2, ws_descricao, 200);
						ws_linhas := dbms_sql.execute(ws_cursor);


						loop
							if dbms_sql.fetch_rows(ws_cursor) = 0 THEN
								exit;
							end if;
							ws_count := dbms_sql.last_row_count;
							dbms_sql.column_value(ws_cursor, 1, ws_codigo);
							dbms_sql.column_value(ws_cursor, 2, ws_descricao);
							if upper(trim(prm_ref)) = upper(trim(ws_codigo)) or upper(trim(prm_ref)) = upper(trim(ws_descricao)) then
								htp.p('<li title="'||trim(ws_codigo)||'" class="opt selected">'||trim(ws_descricao)||'</li>');
							else
								htp.p('<li title="'||trim(ws_codigo)||'" class="opt">'||trim(ws_descricao)||'</li>');
							end if;
						end loop;

						dbms_sql.close_cursor(ws_cursor);
					exception
						when no_data_found then  
							htp.p(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||'  -  NO_DATA_FOUND exception fakelistoptions: '||ws_sql);
						when others then
							htp.p(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||'  -  '||ws_sql);
					end;

				end if;
				
			end;
		when 'lista-lovs' then

			htp.p('<li title="" class="opt">---</li>');

			for i in(select nds_cd_codigo, nds_cd_descricao, nds_tfisica, nds_tabela from codigo_descricao order by nds_tabela asc) loop
				if upper(trim(prm_ref)) = upper(trim(i.nds_tabela)) then
					htp.p('<li title="'||trim(i.nds_tabela)||'" class="opt selected">'||trim(i.nds_tabela)||'</li>');
				else
					htp.p('<li title="'||trim(i.nds_tabela)||'" class="opt">'||trim(i.nds_tabela)||'</li>');
				end if;
			end loop;
		
		when 'lista-padroes' then

			fcl.fakeCustom('search', prm_search);
		
			select count(*) into ws_count from object_attrib where cd_object = trim(replace(prm_ident, 'padrao_', '')) and cd_prop = 'LIMITADORES';
			
			ws_check := fun.getprop(trim(replace(prm_ident, 'padrao_', '')), 'FORMATO');
			
			if ws_count <> 0 then
			
				begin
					select nvl(propriedade, 'N/A') into ws_limitador from object_attrib where cd_object = trim(replace(prm_ident, 'padrao_', '')) and cd_prop = 'LIMITADORES';
				exception when others then
					ws_limitador := 'N/A';
				end;
				
			else 
				ws_limitador := 'N/A';
			end if;
			
			ws_ligacao := prm_visao;
			
			case fun.getprop(trim(replace(prm_ident, 'padrao_', '')), 'ORDEM')
				when 1 then
					ws_order := 'ORDER BY 1 ASC';
				when 2 then
					ws_order := 'ORDER BY 1 DESC';
				when 3 then
					ws_order := 'ORDER BY 2 ASC';
				when 4 then
					ws_order := 'ORDER BY 2 DESC';
				else
					ws_order := 'ORDER BY 1 ASC';
			end case;
			
			if ws_limitador <> 'N/A' then
				select length(propriedade) into ws_count from object_attrib where cd_object = trim(replace(prm_ident, 'padrao_', '')) and cd_prop = 'LIMITADORES';
			end if;

			for i in(select nds_cd_codigo, nds_cd_descricao, nds_tfisica from codigo_descricao where upper(trim(nds_tabela)) = upper(trim(ws_ligacao))) loop

				if ws_limitador = 'N/A' then
					if length(trim(prm_search)) > 0 then
						ws_sql := ' where upper('||trim(i.nds_cd_codigo)||') like (''%'||upper(prm_search)||'%'') or upper('||trim(i.nds_cd_descricao)||') like (''%'||upper(prm_search)||'%'') ';
					end if;
				else
					if length(trim(prm_search)) > 0 then
						if ws_count <> 0 then
							ws_sql := ' where (upper('||trim(i.nds_cd_codigo)||') like (''%'||upper(prm_search)||'%'') or upper('||trim(i.nds_cd_descricao)||') like (''%'||upper(prm_search)||'%'')) and '||trim(i.nds_cd_codigo)||' in (select trim(column_value) from table(fun.vpipe((select trim(propriedade) from object_attrib where trim(cd_object) = '''||replace(trim(prm_ident), 'padrao_', '')||''' and cd_prop = ''LIMITADORES'' and rownum = 1))))';
						else
							ws_sql := ' where (upper('||trim(i.nds_cd_codigo)||') like (''%'||upper(prm_search)||'%'') or upper('||trim(i.nds_cd_descricao)||') like (''%'||upper(prm_search)||'%''))';
						end if;
					else
						if ws_count <> 0 then
							ws_sql := ' where '||trim(i.nds_cd_codigo)||' in (select column_value from table(fun.vpipe((select propriedade from object_attrib where cd_object = '''||replace(trim(prm_ident), 'padrao_', '')||''' and cd_prop = ''LIMITADORES'' and rownum = 1))))';
						end if;
					end if;
				end if;

				ws_encadeado := fun.getprop(trim(replace(prm_ident, 'padrao_', '')), 'ENCADEADO');

				if nvl(ws_encadeado, 'N/A') <> 'N/A' then

					/*if ws_admin = 'A' then
						ws_usuario := 'DWU';
					end if;*/
					
					--valor selecionado no encadeado
					select conteudo into ws_conteudo from parametro_usuario where 
					trim(upper(cd_padrao)) = trim(upper(ws_encadeado)) and cd_usuario = ws_usuario;

					--coluna para usar na query, se não pega o proprio nome
					ws_encadeado_col := fun.getprop(trim(replace(prm_ident, 'padrao_', '')), 'ENCADEADO_COL');

					if instr(ws_sql, 'where') > 0 then
						ws_sql := ws_sql||' and '||nvl(ws_encadeado_col, ws_encadeado)||' = '||chr(39)||ws_conteudo||chr(39);
					else
						ws_sql := ' where '||nvl(ws_encadeado_col, ws_encadeado)||' = '||chr(39)||ws_conteudo||chr(39);
					end if;
					
				end if;
				
				

				ws_sql := 'select DISTINCT '||trim(i.nds_cd_codigo)||', '||trim(i.nds_cd_descricao)||' from '||ws_owner_td||'.'||trim(i.nds_tfisica)||ws_sql||' '||ws_order;

				ws_cursor := dbms_sql.open_cursor;

				dbms_sql.parse(ws_cursor, ws_sql, DBMS_SQL.NATIVE);
				dbms_sql.define_column(ws_cursor, 1, ws_codigo, 60);
				dbms_sql.define_column(ws_cursor, 2, ws_descricao, 60);

				ws_linhas := dbms_sql.execute(ws_cursor);

				/* campo vazio de acordo com a propriedade do objeto default N trocado por data-min */
				/*if trim(fun.getprop(trim(replace(prm_ident, 'padrao_', '')), 'VAZIO')) = 'S' then
					htp.p('<li title="" class="opt">-----</li>');
				end if;*/

				loop
						
					ws_linhas := dbms_sql.fetch_rows(ws_cursor);
					if  ws_linhas <> 1 then
						exit;
					end if;


					dbms_sql.column_value(ws_cursor, 1, ws_codigo);
					dbms_sql.column_value(ws_cursor, 2, ws_descricao);

					ws_selected := 0;

					select count(*) into ws_selected from PARAMETRO_USUARIO where cd_usuario = ws_usuario and trim(cd_padrao) = replace(trim(prm_ident), 'padrao_', '') and trim(conteudo) = trim(ws_codigo);
					
					
					if ws_codigo = ws_descricao or nvl(ws_check, '0') = '1' then
						ws_value := ws_codigo;
					elsif nvl(ws_check, '0') = '0' then
						ws_value := ws_codigo||' - '||ws_descricao;
					else
						ws_value := ws_descricao;
					end if;
					
					if ws_selected = 1 then
						htp.p('<li title="'||ws_codigo||'" class="opt selected">'||ws_value||'</li>');
					else
						htp.p('<li title="'||ws_codigo||'" class="opt">'||ws_value||'</li>');
					end if;

				end loop;
					dbms_sql.close_cursor(ws_cursor);

				select count(*) into ws_count from table(fun.vpipe(prm_ref)) t1 where t1.column_value not in (select nvl(t2.column_value, 'N/A') from table(fun.vpipe(substr(ws_acumulado, 2, 12000))) t2 ) and t1.column_value not like ('%[NOT]%');

				
				if length(trim(prm_search)) = 0 then
					if ws_count > 0 then
						htp.p('<li class="group">N&Atilde;O ENCONTRADOS</li>');

						for n in (select t1.column_value as conteudo from table(fun.vpipe(prm_ref)) t1 where t1.column_value not in (select nvl(t2.column_value, 'N/A') from table(fun.vpipe(substr(ws_acumulado, 2, 12000))) t2 ) and t1.column_value not like ('%[NOT]%')) loop
							htp.p('<li title="'||n.conteudo||'" class="opt selected">'||n.conteudo||'</li>');
						end loop;
					end if;
				end if;

			end loop;
			
		when 'lista-padroes-filtros' then

			fcl.fakeCustom('search', prm_search);
			
			begin

				ws_cd_obj        := trim(replace(prm_ident, 'padrao_', '')); 
				select nvl(max(tp_objeto),'NA') into ws_tp_obj from objetos where cd_objeto = ws_cd_obj ;

				ws_check             := fun.getprop(ws_cd_obj, 'FORMATO');
				ws_encadeado         := fun.getprop(ws_cd_obj, 'ENCADEADO');                  -- Float par ou filter encadeado com o filtro 
				ws_encadeado_col     := fun.getprop(ws_cd_obj, 'ENCADEADO_COL');      
				ws_encadeado_ger     := fun.getprop(ws_cd_obj, 'ENCADEADO_GERAL');            -- Filtro de usuário encadeado com o filtro 
				ws_encadeado_col_ger := fun.getprop(ws_cd_obj, 'ENCADEADO_COL_GER');          
				ws_sel_primeiros := nvl(fun.getprop(ws_cd_obj, 'SELECIONADOS_PRIMEIRO'),'N');

				ws_limite        := null;
				begin 
					ws_limite := fun.getprop(ws_cd_obj, 'LIMITE_ITENS');
				exception when others then null; 
				end; 


				select count(*) into ws_count from object_attrib where cd_object = ws_cd_obj and cd_prop = 'LIMITADORES' and propriedade is not null;
				
				if ws_count <> 0 then
					begin
						select nvl(propriedade, 'N/A') into ws_limitador from object_attrib where cd_object = ws_cd_obj and cd_prop = 'LIMITADORES' and propriedade is not null;
					exception when others then
						ws_limitador := 'N/A';
					end;
					
				else 
					ws_limitador := 'N/A';
				end if;

				
				ws_ligacao := prm_visao;

				
				case fun.getprop(ws_cd_obj, 'ORDEM')
					when '1' then
						ws_order := 'ORDER BY 1 ASC';
					when '2' then
						ws_order := 'ORDER BY 1 DESC';
					when '3' then
						ws_order := 'ORDER BY 2 ASC';
					when '4' then
						ws_order := 'ORDER BY 2 DESC';
					else
						ws_order := 'ORDER BY 1 ASC';
				end case;

				
				if ws_limitador <> 'N/A' then
					select length(propriedade) into ws_count from object_attrib where cd_object = ws_cd_obj and cd_prop = 'LIMITADORES'  and propriedade is not null;
				end if;


				for i in(select nds_cd_codigo, nds_cd_descricao, nds_tfisica, tipo from codigo_descricao where nds_tabela = (select cd_ligacao from parametro_padrao where upper(trim(cd_padrao)) = upper(trim(replace(prm_ident, 'padrao_', ''))) /*or nds_tfisica = upper(ws_ligacao)*/)) loop
	
					ws_sql := '';

					if length(trim(prm_search)) > 0 then
						if ws_count = 0 then
							ws_sql := ' where (upper('||trim(i.nds_cd_codigo)||') like (''%'||upper(prm_search)||'%'') or upper('||trim(i.nds_cd_descricao)||') like (''%'||upper(prm_search)||'%''))';
						else
							ws_sql := ' where ((upper('||trim(i.nds_cd_codigo)||') like (''%'||upper(prm_search)||'%'') or upper('||trim(i.nds_cd_descricao)||') like (''%'||upper(prm_search)||'%'')) and '||trim(i.nds_cd_codigo)||' in (select column_value from table(fun.vpipe(('''||ws_limitador||''')))))';
						end if;
					else
						if ws_count <> 0 then
							ws_sql := ' where (trim('||trim(i.nds_cd_codigo)||') in (select trim(column_value) from table(fun.vpipe(('''||ws_limitador||''')))))';
						end if;
					end if;

					-- Monta filtro encadeado com float filter e float par
					ws_count := 0;
					for a in (select trim(upper(column_value)) cd_col_enca from table (fun.vpipe(ws_encadeado)) where column_value is not null order by 1) loop  

						ws_count    := ws_count + 1; 
						ws_col      := fun.vpipe_n(ws_encadeado_col||'|',ws_count); 
						ws_col      := nvl(ws_col, a.cd_col_enca); 
						ws_conteudo := null;

						select nvl(max(tp_objeto),'NA') into ws_tp_filtro_enca 
						from objetos 
						where cd_objeto = a.cd_col_enca;

						-- valor selecionado no encadeado
						if ws_tp_filtro_enca = 'FLOAT_FILTER' then 
							select chr(39)||listagg(conteudo, chr(39)||' , '||chr(39)) within group (order by conteudo)||chr(39) 
							into ws_conteudo 
							from float_filter_item 
							where cd_coluna  = a.cd_col_enca   -- trim(upper(ws_encadeado)) 
							and cd_usuario = ws_usuario 
							and screen in (select cd_conteudo from table(fun.vpipe_par(prm_adicional)));
						elsif  ws_tp_filtro_enca = 'FLOAT_PAR' then 
							select chr(39)||max(conteudo)||chr(39) 
							into ws_conteudo
							from parametro_usuario
							where cd_padrao  = a.cd_col_enca
							and cd_usuario = ws_usuario;
						end if; 

						if ws_conteudo is not null then 
							if instr(ws_sql, 'where') > 0 then  
								ws_sql := ws_sql||' and ';
							else						        
								ws_sql := ' where ' ;
							end if;

							if ws_conteudo like '%$[NOT]%' then 
								ws_sql := ws_sql||' '||ws_col||' not in ('||replace(ws_conteudo,'$[NOT]','')||')';
							else 
								ws_sql := ws_sql||' '||ws_col||' in ('||ws_conteudo||')';
							end if; 	
						end if; 	
					end loop; 

					--core.MONTA_FILTRO ( 'SQL_BIND', ws_cd_obj, NULL, null, null, ws_usuario, ws_filtros) ;  -- Busca os filtros do objeto aplicados ao objeto 

					

					-- Monta a parametrização do WHERE nos filtros
					 ws_count := 0;
					for a in (select cd_coluna, condicao, conteudo into ws_coluna, ws_condicao, ws_conteudo_f from filtros where cd_objeto = ws_cd_obj) loop
						ws_count    	:= ws_count + 1;
						ws_coluna		:= a.cd_coluna;
						ws_condicao 	:= a.condicao;
						ws_conteudo_f	:= a.conteudo;
						if instr(ws_sql, 'where') > 0 then  
								ws_sql := ws_sql||' and ';
							else						        
								ws_sql := ' where ' ;
						end if;

						case ws_condicao
							when 'IGUAL' then
								ws_condicao := '=';
							when 'DIFERENTE' then
								ws_condicao := '<>';
							when 'MAIOR' then
								ws_condicao := '>';
							when 'MENOR' then
								ws_condicao := '<';
							when 'MAIOROUIGUAL' then
								ws_condicao := '>=';
							when 'MENOROUIGUAL' then
								ws_condicao := '<=';
							when 'LIKE' then 
								ws_condicao := 'LIKE';
							when 'NOTLIKE' then
								ws_condicao := 'NOT LIKE';
							else
								ws_condicao := '***';
						end case;

						if instr(ws_conteudo_f, 'EXEC=') > 0 then
							ws_conteudo_f := replace(ws_conteudo_f, 'EXEC=', '');
							ws_sql := ws_sql || ws_coluna || ' ' || ws_condicao || ' ' || ws_conteudo_f;
						else 
							ws_sql := ws_sql || ws_coluna || ' ' || ws_condicao || ' ''' || ws_conteudo_f || ''''; --WS_CONTEUDO_F dentro de aspas
						end if;

					end loop;

					-- Monta filtro encadeado com filtro geral (filtro de usuário) 
					ws_count := 0;
					for a in (select trim(upper(column_value)) cd_col_enca from table (fun.vpipe(ws_encadeado_ger)) where column_value is not null order by 1) loop  
						ws_count    := ws_count + 1; 
						ws_col      := fun.vpipe_n(ws_encadeado_col_ger||'|',ws_count); 
						ws_col      := nvl(ws_col, a.cd_col_enca); 
						ws_conteudo := null;
					    CORE.MONTA_FILTRO_USUARIO ( null, null, a.cd_col_enca, ws_col, ws_usuario, ws_conteudo); 
						if ws_conteudo is not null then 
							if instr(ws_sql, 'where') > 0 then  
								ws_sql := ws_sql||' and ';
							else						        
								ws_sql := ' where ' ;
							end if;
						end if; 	
						ws_sql := ws_sql||ws_conteudo;
					end loop; 

					select max(cd_coluna), max(cd_conteudo) into ws_col_cod, ws_screen from table(fun.vpipe_par(prm_adicional)) ; 

					if ws_tp_obj = 'FLOAT_FILTER' then 
						ws_col_selecionado :=   ' ( select nvl(sum(decode(substr(trim(conteudo),1,6),''$[NOT]'',2,1)),0) '|| 
												'     from float_filter_item '|| 
												'    where cd_usuario     = '''||ws_usuario||''' '|| 
												'      and screen         = '''||ws_screen||''' '||
												'      and cd_coluna      = '''||ws_col_cod||''' '||
												'      and trim(conteudo) in (trim(t1.coluna), trim(''$[NOT]''||t1.coluna) ) ) as selecionado '; 
					else 
						ws_col_selecionado :=   ' ( select nvl(sum(decode(substr(trim(conteudo),1,6),''$[NOT]'',2,1)),0) '||
												'     from PARAMETRO_USUARIO'||
												'     where cd_usuario     = '''||ws_usuario||''' '||
												'       and cd_padrao      = '''||ws_cd_obj||''' '||
												'       and trim(conteudo) in (trim(t1.coluna), trim(''$[NOT]''||t1.coluna) ) ) as selecionado '; 
					end if; 

					if ws_sel_primeiros = 'S' then 
						ws_order := replace(ws_order, 'ORDER BY ', 'ORDER BY selecionado DESC, ');
					end if; 

					if i.tipo = 'TABELA' then
						ws_lista := ws_owner_td||'.'||trim(i.nds_tfisica);
						ws_cd_coluna := trim(i.nds_cd_codigo);
						ws_cd_descricao:= trim(i.nds_cd_descricao);
					else 	
						ws_lista := '(select cd_coluna, cd_conteudo from table(fun.vpipe_par(replace('''||i.nds_tfisica||''', ''$opc|'', ''''))))'; 
						ws_cd_coluna := 'cd_coluna';
						ws_cd_descricao:= 'cd_conteudo';
						if ws_limitador <> 'N/A' then
							ws_limitador := replace(ws_limitador, '|', ',');
							ws_lista_where_limitador := 'where coluna in ('||ws_limitador||')';
						end if;
						ws_sql := '';
					end if;

					ws_sql := 'select coluna, descricao, '||ws_col_selecionado||' from( select DISTINCT '||ws_cd_coluna||' as coluna, '||ws_cd_descricao||' as descricao '||
					' from '||ws_lista||ws_sql||') t1 '||ws_lista_where_limitador||' '||ws_order;

					ws_cursor := dbms_sql.open_cursor;

					dbms_sql.parse(ws_cursor, ws_sql, DBMS_SQL.NATIVE);
					dbms_sql.define_column(ws_cursor, 1, ws_codigo, 60);
					dbms_sql.define_column(ws_cursor, 2, ws_descricao, 60);
					dbms_sql.define_column(ws_cursor, 3, ws_selecionado, 60);					

					ws_linhas   := dbms_sql.execute(ws_cursor);
					ws_nr_linha := 0;
					loop
							
						ws_linhas := dbms_sql.fetch_rows(ws_cursor);
						if  ws_linhas <> 1 then
							exit;
						end if;

						ws_nr_linha := ws_nr_linha + 1; 
						-- Se atingiu o limite parametrizado, cai fora do loop 
						if ws_limite is not null and ws_nr_linha > ws_limite  then 
							exit; 
						end if; 

						dbms_sql.column_value(ws_cursor, 1, ws_codigo);
						dbms_sql.column_value(ws_cursor, 2, ws_descricao);
						dbms_sql.column_value(ws_cursor, 3, ws_selecionado);

						ws_class := 'opt'; 

						if ws_selecionado = 1 then 
							ws_class := ws_class||' selected';
						elsif ws_selecionado = 2 then 	
							ws_class := ws_class||' reverse';
						end if; 	

						if ws_codigo = ws_descricao or nvl(ws_check, '0') = '1' then
							ws_value := ws_codigo;
						elsif nvl(ws_check, '0') = '0' then
							ws_value := ws_codigo||' - '||ws_descricao;
						else
							ws_value := ws_descricao;
						end if;

						htp.p('<li title="'||ws_codigo||'" class="'||ws_class||'">'||ws_value||'</li>');

						begin
							ws_acumulado := ws_acumulado||'|'||ws_codigo;
						exception when others then
							ws_erro := substr(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||'-'||ws_sql,1,3999);
						end;

					end loop;
					dbms_sql.close_cursor(ws_cursor);

				end loop;

				if ws_limite is not null and ws_nr_linha > ws_limite then 
					htp.p('<li title=""> . . . </li>');				
				end if; 

				if ws_erro is not null then 
					insert into bi_log_sistema values(sysdate, substr('ACUMULADO DO FLOAT - '||ws_erro,1,3999), gbl.getUsuario, 'ERRO');
					commit;
				end if; 	


				select count(*) into ws_count from table(fun.vpipe(fun.converte(prm_ref))) t1 where t1.column_value not in (select nvl(t2.column_value, 'N/A') from table(fun.vpipe(substr(ws_acumulado, 2, 12000))) t2 ) and t1.column_value not like ('%[NOT]%');

				
				if length(trim(prm_search)) = 0 then
					if ws_count > 0 then
						htp.p('<li class="group">N&Atilde;O ENCONTRADOS</li>');

						for n in (select t1.column_value as conteudo from table(fun.vpipe(prm_ref)) t1 where t1.column_value not in (select nvl(t2.column_value, 'N/A') from table(fun.vpipe(substr(ws_acumulado, 2, 12000))) t2 ) and t1.column_value not like ('%[NOT]%')) loop
							htp.p('<li title="'||n.conteudo||'" class="opt selected">'||n.conteudo||'</li>');
						end loop;
					end if;
				end if;

			exception when others then
				if ws_admin = 'A' then
					insert into bi_log_sistema values(sysdate, substr('ERRO NO FLOAT - '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||ws_sql,1,3999), gbl.getUsuario, 'ERRO');
					commit;
				end if;
			end;

		when 'lista-mapa-marcador' then
				
			for i in ( select * from bi_mapa_marcador order by decode(cd_marcador,'DEFAULT','000',cd_marcador) ) loop
				nested_test_list(prm_ref, i.cd_marcador, upper(i.ds_marcador), prm_com_cod => 'N');
			end loop;

		when 'oculta-mapa-marcador' then

			nested_test_list(prm_ref, 'NOME',      'Nome/T&iacute;tulo');
			nested_test_list(prm_ref, 'DESCRICAO', 'Descri&ccedil;&atilde;o');

		when 'lista-etl-db' then

			begin
				for i in (select distinct tp_conexao, nvl2(column_value, 'selected', '') as classe from etl_tipo_conexao
						    left join table(fun.vpipe(prm_ref)) on column_value = tp_conexao 
						   order by 1
					     ) loop
					htp.p('<li title="'||i.tp_conexao||'" class="opt '||i.classe||'">'||i.tp_conexao||'</li>');
				end loop;
			exception when others then
		    	insert into bi_log_sistema values(sysdate, 'fakelistoptions ('||prm_campo||') :'||DBMS_UTILITY.FORMAT_ERROR_STACK||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, gbl.getusuario, 'ERRO');
    			commit;
				htp.p('Erro montando lista');
			end;
		when 'lista-etl-conexao' then

			begin
				for i in (select distinct id_conexao, nvl2(column_value, 'selected', '') as classe from etl_conexoes
						    left join table(fun.vpipe(prm_ref)) on column_value = id_conexao 
						   order by 1
					     ) loop
					htp.p('<li title="'||i.id_conexao||'" class="opt '||i.classe||'">'||i.id_conexao||'</li>');
				end loop;
			exception when others then
		    	insert into bi_log_sistema values(sysdate, 'fakelistoptions ('||prm_campo||') :'||DBMS_UTILITY.FORMAT_ERROR_STACK||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, gbl.getusuario, 'ERRO');
    			commit;
				htp.p('Erro montando lista');
			end;

		when 'lista-etl-step' then

			begin
				for i in (select id_conexao, step_id, tipo_execucao, nvl2(column_value, 'selected', '') as classe from etl_step 
						    left join table(fun.vpipe(prm_ref)) on column_value = step_id 
						   where etl_step.tipo_comando not in ('INTEGRADOR_FTP')
						   order by id_conexao, nvl(ds_step, step_id)
					     ) loop
					htp.p('<li title="'||i.step_id||'" class="opt '||i.classe||'">'||i.step_id||'</li>');
				end loop;
			exception when others then
		    	insert into bi_log_sistema values(sysdate, 'fakelistoptions ('||prm_campo||') :'||DBMS_UTILITY.FORMAT_ERROR_STACK||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, gbl.getusuario, 'ERRO');
    			commit;
				htp.p('Erro montando lista');
			end;

		when 'lista-etl-step-dependence' then

			begin
				for i in ( select t1.ordem, t1.run_step_id, t1.step_id
				             from (select -2 ordem, 'NENHUMA'  as run_step_id, 'NENHUMA'  as step_id from dual  union all 
								   select -1 ordem, 'ANTERIOR' as run_step_id, 'ANTERIOR' as step_id from dual  union all 
								   select ordem, rs.run_step_id, rs.ordem||'-'||st.step_id
							         from etl_step st, etl_run_step rs
							        where st.step_id      = rs.step_id 
									  and rs.run_id       = substr(prm_adicional,1, instr(prm_adicional,'|',1,1)-1) 
									  and rs.run_step_id <> substr(prm_adicional,instr(prm_adicional,'|',1,1)+1, 99999) 
				                  ) t1
						   order by ordem, step_id
					     ) loop
					select count(*) into ws_count from table(fun.vpipe(prm_ref)) where column_value = i.run_step_id; 
					ws_class := 'opt';
					if ws_count > 0 then 
						ws_class := ws_class||' selected';
					end if; 
					if i.run_step_id in ('NENHUMA','ANTERIOR') then 
						ws_class := ws_class||' opt-unico'; 
					end if;

					htp.p('<li title="'||i.run_step_id||'" class="'||ws_class||'">'||i.step_id||'</li>');
				end loop;
			exception when others then
		    	insert into bi_log_sistema values(sysdate, 'fakelistoptions ('||prm_campo||') :'||DBMS_UTILITY.FORMAT_ERROR_STACK||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, gbl.getusuario, 'ERRO');
    			commit;
				htp.p('Erro montando lista');
			end;

		when 'lista-etl-tipo-execucao' then

			for i in ( select cd_item as cod, nvl(ds_abrev, ds_item) as nome, nvl2(column_value, 'selected', '') as classe from bi_lista_padrao 
						left join table(fun.vpipe(prm_ref)) on column_value = cd_item 
						where cd_lista = 'ETL_TIPO_EXECUCAO' 
						order by nr_ordem, cd_item
						) loop
				htp.p('<li title="'||i.cod||'" class="opt '||i.classe||'">'||i.nome||'</li>');
			end loop;

		when 'lista-etl-tipo-comando' then

			for i in ( select cd_item as cod, nvl(ds_abrev, ds_item) as nome, nvl2(column_value, 'selected', '') as classe from bi_lista_padrao 
						left join table(fun.vpipe(prm_ref)) on column_value = cd_item 
						where cd_lista = 'ETL_TIPO_COMANDO' 
						order by nr_ordem, cd_item
						) loop
				htp.p('<li title="'||i.cod||'" class="opt '||i.classe||'">'||i.nome||'</li>');
			end loop;

		when 'user-permissao' then

			for i in (select cd_item as cd, nvl(ds_abrev, ds_item) as ds from bi_lista_padrao  
					   where cd_lista = 'USER_PERMISSAO'
					     and cd_item not in (select cd_permissao from user_permissao where cd_usuario = prm_adicional )				   
					  order by 1 
					) loop 
				nested_test_list(prm_ref, i.cd, i.ds, prm_com_cod => 'N' );
			end loop;

		when 'lista-ocultar_subtotal' then

			nested_test_list(prm_ref, 'NENHUM', 'NENHUM', prm_com_cod => 'N', prm_class => ' opt-bold opt-unico ');
			nested_test_list(prm_ref, 'TODOS',  'TODOS',  prm_com_cod => 'N', prm_class => ' opt-bold opt-unico ');

			select cs_coluna, cd_micro_visao into ws_value, ws_tabela from ponto_avaliacao where cd_ponto = prm_adicional;
			for i in ( select column_value, nvl(fun.check_rotuloc(column_value, ws_tabela), nm_rotulo) as nm_rotulo from table(fun.vpipe(ws_value||'|'||ws_codigo)) t1
				       left join micro_coluna t2 on (t2.cd_micro_visao = ws_tabela and t2.cd_coluna = t1.column_value) 
			         ) loop
				ws_rotulo := replace(replace(i.nm_rotulo, chr(13), ' '), chr(10), ' '); 		
				if nvl(ws_rotulo, 'N/A') <> 'N/A' then
					nested_test_list(prm_ref, i.column_value, ws_rotulo, prm_com_cod => 'N');
				end if;
			end loop;
		
		when 'lista-grupo-superior' then 

			fcl.fakeCustom('search', prm_search, 'noscript');

			for a in (select cd_grupo from grupos_funcao where cd_grupo like ('%'||upper(prm_search)||'%')) loop
				htp.p('<li title="'||a.cd_grupo||'" class="opt">'||a.cd_grupo||'</li>');
			end loop;

        when 'lista-tipo-conteudo-aviso' then
            ws_class := '';
            if prm_ref = 'IMAGEM EXTERNA' then 
                ws_class := 'selected'; 
            end if;
            htp.p('<li title="IMAGEM EXTERNA" class="opt '||ws_class||'">Imagem URL</li>');
            ws_class := '';
            if prm_ref = 'IMAGEM INTERNA' then 
                ws_class := 'selected'; 
            end if;
            htp.p('<li title="IMAGEM INTERNA" class="opt '||ws_class||'">Imagem BI</li>');


	end case;
exception
	when no_data_found then
		null;
	when ws_nouser then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end fakelistoptions;

--!!
procedure menu ( prm_menu    varchar2 default null,
				prm_default varchar2 default null ) as

	ws_primeiro			varchar2(60);
	ws_grupo    		varchar2(40)  := '999999999';
	ws_codigo   		varchar2(400);
	ws_visao    		varchar2(120);
	ws_desc     		varchar2(120);
	ws_colunas  		varchar2(800);
	ws_count    		number := 0;
	ws_usuario  		varchar2(80);
	ws_admin    		varchar2(80);
	ws_padrao   		varchar2(80)  := 'PORTUGUESE';
	ws_tipoGrafico 		varchar2(80);
	ws_jobs     		varchar2(32000); 
	ws_pkgs     		varchar2(32000); 
	ws_nm_objeto		varchar2(400);	
	ws_onkeypress     	varchar2(200);  
	ws_onkeypress_int 	varchar2(200);
	ws_onkeypress_num 	varchar2(200);
	ws_onkeypress_cod 	varchar2(200);
	ws_micro_visao		varchar2(200);

	ws_nouser			exception;

begin

	ws_usuario := gbl.getUsuario;
	ws_admin   := gbl.getNivel;
	

	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if; 

	case 

	when prm_menu = 'report_schedule' then

		htp.p('<h4>'||fun.lang('HOR&Aacute;RIO DO REPORT')||'</h4>');
		fcl.fakeoption('prm_semana', fun.lang('Dias da semana'), '', 'lista-semanas', 'N', 'S');
		fcl.fakeoption('prm_dia_mes', fun.lang('Dias do m&ecirc;s'), '', 'lista-dia-mes', 'N', 'S'); 
		fcl.fakeoption('prm_mes', fun.lang('Meses'), '', 'lista-meses', 'N', 'S', prm_min => 1);
		fcl.fakeoption('prm_hora', fun.lang('Hora'), '', 'lista-horas', 'N', 'S', prm_min => 1);
		fcl.fakeoption('prm_quarter', fun.lang('Minuto'), '', 'lista-minutos', 'N', 'S', prm_min => 1);		
		htp.p('<a title="'||fun.lang('Adicionar')||'" id="adicionar-report-schedule" class="addpurple" data-req="addReportSchedule" data-par="prm_id|prm_semana|prm_dia_mes|prm_mes|prm_hora|prm_quarter" data-children="" data-res="reportSchedule" data-res-par="prm_id" data-sup="" data-save="" data-msg="'||fun.lang('HOR&Aacute;RIO ADICIONADO')||'" data-pkg="com">'||fun.lang('ADICIONAR')||'</a></td>');
	
	when prm_menu = 'report' then

		if prm_default is not null then

			for a in (select * from bi_report_list where id = prm_default and rownum = 1) loop

				htp.p('<h4>'||fun.lang('REPORT')||'</h4>');

				fcl.fakeoption('prm_email', fun.lang('Email'), a.email, 'lista-email', 'N', 'S', prm_min => 1);
				fcl.fakeoption('prm_usuario', fun.lang('Usu&aacute;rio'), a.usuario, 'lista-usuarios-admin', 'N', 'N', prm_min => 1);
				htp.p('<input type="text" value="'||a.assunto||'" id="prm_assunto" data-min="1" placeholder="'||fun.lang('ASSUNTO')||'" />');
				htp.p('<textarea id="prm_msg" data-min="1" placeholder="'||fun.lang('MENSAGEM')||'">'||a.msg||'</textarea>');
				if upper(nvl(fun.ret_var('COM_TIPO_ENVIO'),'R')) = 'R' then -- remoto (envio somente de tela)
					fcl.fakeoption('prm_objeto', fun.lang('Escolha uma tela ou relat&oacute;rio'), a.cd_objeto, 'lista-objetos-report-tela', 'N', 'N', prm_min => 1, prm_visao => 'prm_usuario');
				else 
					fcl.fakeoption('prm_objeto', fun.lang('Escolha uma tela ou relat&oacute;rio'), a.cd_objeto, 'lista-objetos-report', 'N', 'N', prm_min => 1, prm_visao => 'prm_usuario');		
				end if;

				htp.p('<input type="text" style="opacity: 0; display: none;" value="'||a.id||'" id="prm_id_anterior"/>');

				htp.p('<a title="'||fun.lang('Adicionar')||'" id="adicionar-report" class="addpurple" data-req="addReport" data-par="prm_usuario|prm_assunto|prm_msg|prm_objeto|prm_email|prm_id_anterior" data-children="" data-res="report" data-res-par="" data-sup="" data-save="" data-msg="'||fun.lang('Adicionado com sucesso')||'" data-pkg="com">'||fun.lang('ADICIONAR')||'</a></td>');

			end loop;

		else
		
			htp.p('<h4>'||fun.lang('REPORT')||'</h4>');

			fcl.fakeoption('prm_email', fun.lang('Email'), '', 'lista-email', 'N', 'S', prm_min => 1);
			fcl.fakeoption('prm_usuario', fun.lang('Usu&aacute;rio'), '', 'lista-usuarios-admin', 'N', 'N', prm_min => 1);
			htp.p('<input type="text" value="'||''||'" id="prm_assunto" data-min="1" placeholder="'||fun.lang('ASSUNTO')||'" />');
			htp.p('<textarea id="prm_msg" data-min="1" placeholder="'||fun.lang('MENSAGEM')||'">'||''||'</textarea>');
			if upper(nvl(fun.ret_var('COM_TIPO_ENVIO'),'R')) = 'R' then -- remoto (envio somente de tela)
				fcl.fakeoption('prm_objeto', fun.lang('Escolha uma tela ou relat&oacute;rio'), '', 'lista-objetos-report-tela', 'N', 'N', prm_min => 1, prm_visao => 'prm_usuario');
			else 
				fcl.fakeoption('prm_objeto', fun.lang('Escolha uma tela ou relat&oacute;rio'), '', 'lista-objetos-report', 'N', 'N', prm_min => 1, prm_visao => 'prm_usuario');		
			end if; 	

			htp.p('<a title="'||fun.lang('Adicionar')||'" id="adicionar-report" class="addpurple" data-req="addReport" data-par="prm_usuario|prm_assunto|prm_msg|prm_objeto|prm_email" data-children="" data-res="report" data-res-par="" data-sup="" data-save="" data-msg="'||fun.lang('Adicionado com sucesso')||'" data-pkg="com">'||fun.lang('ADICIONAR')||'</a></td>');
		
		end if;


	when prm_menu = 'add_custom' then

		htp.p('<h4>'||fun.lang('PERMISS&Atilde;O DE CUSTOMIZA&Ccedil;&Atilde;O')||'</h4>');

		htp.p('<input type="hidden" id="prm_usuario" value="'||prm_default||'">');

		fcl.fakeoption('prm_visao', fun.lang('Lista de views'), '', 'lista-views', 'N', 'N', prm_children => 'prm_colunas', prm_min => 1);

		fcl.fakeoption('prm_colunas', fun.lang('Lista de colunas'), '', 'lista-colunas-custom', 'N', 'S', 'prm_visao', prm_min => 1, prm_adicional => prm_default);  -- prm_default= usuario que recebe a permissão

		htp.p('<a title="'||fun.lang('Adicionar')||'" id="adicionar-custom" class="addpurple" data-req="addCustomizado" data-par="prm_usuario|prm_visao|prm_colunas" data-children="" data-res="listaCustomizado" data-res-par="prm_usuario" data-sup="add_custom&prm_default='||prm_default||'" data-save="" data-msg="'||fun.lang('Permiss&atilde;o adicionada')||'">'||fun.lang('ADICIONAR')||'</a></td>');
	
	when prm_menu = 'data_table' then

		htp.p('<h4>'||fun.lang('COLUNAS DISPON&Iacute;VEIS')||'</h4>');

		select cd_coluna, cd_conteudo into ws_visao, ws_codigo from table(fun.vpipe_par((prm_default)));

		fcl.fakeoption('prm_coluna', fun.lang('Lista de colunas'), '', 'lista-dimensoes', 'N', 'S', ws_visao, prm_adicional => ws_codigo);

		htp.p('<a class="addpurple followed" onclick="var objeto = document.getElementById(''prm_objeto'').value; call(''alter_consulta'', ''prm_nome=''+objeto+''&prm_valor=''+this.previousElementSibling.title+''&prm_tipo=coluna'').then(function(resposta){ if(resposta.indexOf(''#alert'') == -1){ alerta(''feed-fixo'', TR_AD); carrega(''consulta?prm_objeto=''+objeto+''&prm_visao='||ws_visao||'''); carregaPainel(''data_table'', '''||prm_default||''');  } else { alerta(''feed-fixo'', TR_ES); } });">'||fun.lang('ADICIONAR AGRUPADOR')||'</a>');

		fcl.fakeoption('prm_medida', fun.lang('Lista de valores'), '', 'lista-medidas', 'N', 'S', ws_visao, prm_adicional => ws_codigo);

		htp.p('<a class="addpurple followed" onclick="var objeto = document.getElementById(''prm_objeto'').value; call(''alter_consulta'', ''prm_nome=''+objeto+''&prm_valor=''+this.previousElementSibling.title+''&prm_tipo=agrupador'').then(function(resposta){ if(resposta.indexOf(''#alert'') == -1){ alerta(''feed-fixo'', TR_AD); carrega(''consulta?prm_objeto=''+objeto+''&prm_visao='||ws_visao||'''); carregaPainel(''data_table'', '''||prm_default||'''); } else { alerta(''feed-fixo'', TR_ES); } });">'||fun.lang('ADICIONAR VALOR')||'</a>');

		fcl.fakeoption('prm_pivot', fun.lang('Lista de pivots'), '', 'lista-dimensoes', 'N', 'S', ws_visao, prm_adicional => ws_codigo);

		htp.p('<a class="addpurple" onclick="var objeto = document.getElementById(''prm_objeto'').value; call(''alter_consulta'', ''prm_nome=''+objeto+''&prm_valor=''+this.previousElementSibling.title+''&prm_tipo=pivot'').then(function(resposta){ if(resposta.indexOf(''#alert'') == -1){ alerta(''feed-fixo'', TR_AD); carrega(''consulta?prm_objeto=''+objeto+''&prm_visao='||ws_visao||'''); carregaPainel(''data_table'', '''||prm_default||'''); } else { alerta(''feed-fixo'', TR_ES); } });">'||fun.lang('ADICIONAR PIVOT')||'</a>');

	when prm_menu = 'calculada' then

		htp.p('<h4>'||fun.lang('LINHA CALCULADA')||'</h4>');

		select cd_micro_visao into ws_visao from ponto_avaliacao where cd_ponto = prm_default;

		htp.p('<input id="prm_visao" type="hidden" value="'||ws_visao||'" />');

		htp.p('<input id="prm_objeto" type="hidden" value="'||prm_default||'" />');
		
		htp.p('<select title="'||fun.lang('COLUNA')||'" id="prm_coluna">');
			htp.p('<option selected disabled hidden value="N/A">'||fun.lang('COLUNA')||'</option>');
			for i in(select column_value from table(fun.vpipe((select cs_coluna from ponto_avaliacao where cd_ponto = prm_default)))) loop
				htp.p('<option value="'||i.column_value||'">'||i.column_value||'</option>');
			end loop;
		htp.p('</select>');

		htp.p('<input type="text" id="prm_show" placeholder="ID" value="" data-min="2">');
		htp.p('<input type="text" id="prm_desc" placeholder="'||fun.lang('Descri&ccedil;&atilde;o')||'" value="" data-min="2" data-encode="S">');
		
		htp.p('<a class="addpurple" data-req="create_linha" data-par="prm_objeto|prm_visao|prm_coluna|prm_show|prm_desc" data-res="list_calculada" data-res-par="prm_objeto|prm_visao"  data-sup="calculada&prm_default='||prm_default||'">'||fun.lang('ADICIONAR CALCULADA')||'</a>');

	when prm_menu = 'editview' then

		htp.p('<h4>'||fun.lang('EDI&Ccedil;&Atilde;O DE VIEWS')||'</h4>');

		htp.p('<a class="script" onclick="edit_view();"></a>');
		fcl.fakeoption('view_list', fun.lang('Escolha uma op&ccedil;&atilde;o'), '', 'lista-realviews', 'N', 'N', '');
		
		htp.p('<a class="addpurple" onclick="mostrak(''N'');">'||fun.lang('COMPILAR')||'</a>');

	when prm_menu = 'import' then

		htp.p('<h4>'||fun.lang('IMPORTA&Ccedil;&Atilde;O DE EXCEL')||'</h4>');
		
		htp.p('<input type="text" placeholder="'||fun.lang('NOME DA IMPORTA&Ccedil;&Atilde;O')||'" id="import-modelo" style="text-transform: uppercase"/>');
		
		fcl.fakeoption('import-arquivo', fun.lang('ARQUIVO'), '', 'lista-xls', 'S', 'N');
		
		fcl.fakeoption('visao_tabela', fun.lang('Escolha a tabela'), '', 'lista-tabelas-import', 'S', 'N', '');
			
		htp.p('<select id="import-acao">');
			htp.p('<option value="ADD" selected disabled hidden>'||fun.lang('A&Ccedil;&Atilde;O')||'</option>');
			htp.p('<option value="ADD">'||fun.lang('ADICIONAR A TABELA')||'</option>');
			htp.p('<option value="DELETE">'||fun.lang('LIMPAR TABELA E ADICIONAR')||'</option>');
		htp.p('</select>');

		fcl.fakeoption('import-pos-rotina', fun.lang('P&oacute;s-Rotina PL/SQL'), '', 'lista-step-plsql', 'N', 'N');

		htp.p('<a class="addpurple" title="'||fun.lang('adicionar')||'" onclick="importAddModel()">'||fun.lang('ADICIONAR MODELO')||'</a>');

	when prm_menu = 'list_ofiltro' or prm_menu = 'list_ofiltro_float' then

		select cd_conteudo, cd_coluna into ws_visao, ws_codigo from table(fun.vpipe_par(prm_default));

		select count(*) into ws_count from objetos where cd_objeto = ws_codigo and nvl(id_customizado,'N') = 'S';

		if fun.check_admin('FILTERS_ADD') or ws_count > 0 then  -- Monta se o usuário tem permissão de adicionar filtro ou se é um objeto Customizado 

			htp.p('<h4>'||fun.lang('ADICIONAR FILTRO')||'</h4>');
			htp.p('<input type="hidden" value="'||ws_codigo||'"  id="ws_par_sumary"/>');
			htp.p('<input type="hidden" value="'||ws_codigo||'"  id="new_cd_objeto"/>');
			htp.p('<input type="hidden" value="and"  id="prm_ligacao"/>');
			htp.p('<input id="prm_visao" type="hidden" value="'||ws_visao||'"/>');

			if prm_menu = 'list_ofiltro_float' then
				fcl.fakeoption('new_cd_coluna', fun.lang('Lista de coluna'), '', 'lista-coluna', 'N', 'N', 'filtro-visao', '', ''||ws_codigo||'',prm_min=>1);
			else
				fcl.fakeoption('new_cd_coluna', fun.lang('Lista de colunas'), '', 'lista-colunas', 'N', 'N', 'filtro-visao', '', ''||ws_codigo||'',prm_min=>1);
			end if;
			fcl.fakeoption('new_condicao', fun.lang('Lista de condi&ccedil;&otilde;es'),'', 'lista-condicoes', 'N', 'N', '', '',prm_min=>1);
			fcl.fakeoption('new_conteudo', fun.lang('Lista de valores'), '', 'lista-valores', 'S', 'N', 'filtro-visao', '', 'new_cd_coluna', '', '', '',prm_min=>1,prm_encode=>'S');
			-- fcl.fakeoption('new_conteudo', fun.lang('Lista de valores'), '', 'lista-valores', 'S', 'N', 'filtro-visao', '', 'filtro-coluna', '', '', '',prm_min=>1,prm_encode=>'S');
			
			--fcl.fakeoption('prm_agrupado', fun.lang('Agrupado'), '', '$agrupado', 'N', 'N',prm_min=>1);			

			htp.p('<a title="'||fun.lang('Adicionar')||'" class="addpurple" data-req="edit_ofiltro" data-par="new_cd_objeto|new_cd_coluna|new_condicao|new_conteudo|prm_ligacao|prm_visao" data-res="list_ofiltro" data-res-par="ws_par_sumary|prm_visao">'||fun.lang('ADICIONAR FILTRO')||'</a></td>');

		end if;

	when prm_menu = 'prefixo' then
		
		htp.p('<input type="text" placeholder="'||fun.lang('PREFIXO')||'">');
		htp.p('<input type="text" placeholder="'||fun.lang('TIPO LOV')||'">');
		htp.p('<input type="text" placeholder="'||fun.lang('PREFIXO LOV')||'">');
		htp.p('<input type="text" placeholder="'||fun.lang('AGRUPADOR')||'">');
		htp.p('<input type="text" placeholder="'||fun.lang('M&Aacute;SCARA')||'">');
		htp.p('<select>');
			htp.p('<option value="LEFT">'||fun.lang('esquerda')||'</option>');
			htp.p('<option value="CENTER">'||fun.lang('centro')||'</option>');
			htp.p('<option value="RIGHT">'||fun.lang('direita')||'</option>');
		htp.p('</select>');
		htp.p('<a class="add" onclick="savePrefixo(this, ''add'');" title="'||fun.lang('ADICIONAR')||'">+</a>');

	when prm_menu = 'browserfiltro' then

		htp.p('<h4>'||fun.lang('FILTROS DO BROWSER')||'</h4>');
			
			if ws_admin = 'A' then
				fcl.fakeoption('filtro-usuario', fun.lang('Usu&aacute;rio'), '', 'lista-usuarios', 'N', 'N');
			else
				htp.p('<input type="hidden" id="filtro-usuario" title="'||ws_usuario||'" />');
			end if;
			
			fcl.fakeoption('filtro-coluna', '', fun.lang('COLUNA'), 'lista-coluna', 'N', 'N', 'filtro-visao', '');
			fcl.fakeoption('filtro-condicao', '', fun.lang('CONDI&Ccedil;&Atilde;O'), 'lista-condicoes', 'N', 'N', '', '', '', '');
			fcl.fakeoption('filtro-conteudo', fun.lang('VALOR'), '', 'lista-valores-browser', 'S', 'N', 'filtro-visao', '', 'filtro-coluna',prm_encode =>'S');
			
			
			htp.p('<input type="hidden" id="p_ligacao" value="and" />');
			htp.p('<input type="hidden" id="p_agrupado" value="N" />');

			htp.p('<a title="'||fun.lang('Adicionar')||'" class="addpurple" onclick="var datalist = encodeURIComponent(document.getElementById(''filtro-conteudo'').title); if(datalist.length > 0){ call(''edit_ofiltro'', ''new_cd_objeto='||prm_default||'&new_cd_coluna=''+document.getElementById(''filtro-coluna'').title+''&new_condicao=''+document.getElementById(''filtro-condicao'').title+''&new_conteudo=''+datalist+''&prm_ligacao=''+document.getElementById(''p_ligacao'').value+''&prm_visao='||ws_codigo||'&prm_agrupado=''+document.getElementById(''p_agrupado'').value+''&prm_usuario=''+document.getElementById(''filtro-usuario'').title).then(function(resposta){ if(resposta.indexOf(''#alert'') == -1){ alerta(''feed-fixo'', '''||fun.lang('Filtro adicionado com sucesso')||'!''); ajax(''list'', ''list_ofiltro'', ''ws_par_sumary='||prm_default||'&prm_visao=''+document.getElementById(''filtro-visao'').title, false, ''content''); } else { alerta(''msg'', TR_ES); } }); }">'||fun.lang('ADICIONAR FILTRO')||'</a>');
	
			--htp.p('<a title="'||fun.lang('Adicionar')||'" class="addpurple" data-req="edit_ofiltro" data-res="" call(''edit_ofiltro'', ''new_cd_objeto='||prm_default||'&new_cd_coluna=''+document.getElementById(''filtro-coluna'').title+''&new_condicao=''+document.getElementById(''filtro-condicao'').title+''&new_conteudo=''+datalist+''&prm_ligacao=''+document.getElementById(''p_ligacao'').value+''&prm_visao='||ws_codigo||'&prm_agrupado=''+document.getElementById(''p_agrupado'').value+''&prm_usuario=''+document.getElementById(''filtro-usuario'').title).then(function(resposta){ if(resposta.indexOf(''#alert'') == -1){ alerta(''feed-fixo'', '''||fun.lang('Filtro adicionado com sucesso')||'!''); ajax(''list'', ''list_ofiltro'', ''ws_par_sumary='||prm_default||'&prm_visao=''+document.getElementById(''filtro-visao'').title, false, ''content''); } else { alerta(''msg'', TR_ES); } }); }">+</a>');

		/*else
			htp.p('<input id="filtro-usuario" style="display: none;" value="'||ws_usuario||'" title="'||ws_usuario||'">');
		end if;*/
		
	when prm_menu = 'browser' then

		select cd_coluna, cd_conteudo into ws_codigo, ws_visao from table(fun.vpipe_par(prm_default));
		
		htp.p('<h4>'||fun.lang('COLUNAS DO BROWSER')||'</h4>');

		select cd_coluna, cd_conteudo into ws_codigo, ws_visao from table(fun.vpipe_par(prm_default));

		htp.p('<input type="hidden" value="'||ws_codigo||'"/>');

		fcl.fakeoption(ws_codigo||'_fake', fun.lang('Escolha a coluna'), '', 'lista-coluna-browser', 'N', 'N', ws_visao);


		htp.p('<input type="text" placeholder="'||fun.lang('R&Oacute;TULO')||'">');

		--htp.p('<a class="addpurple" onclick=" var dados = this.parentNode; if(dados.children[2].title.length > 0){ ajax(''return'', ''browserConfig_alter'', ''prm_microdata=''+dados.children[1].value+''&prm_coluna=''+dados.children[2].title+''&prm_rotulo=''+dados.children[3].value+''&prm_mascara=&prm_ligacao=SEM&prm_chave=&prm_branco=&prm_default=&prm_alinhamento=left&prm_invisivel=N&prm_formula=&prm_tipo=&prm_alignds=left&prm_tipoinput=text&prm_tamanho=&prm_validacao=&prm_ordem=''+document.getElementById(''browserconfig'').children.length+''&prm_permissao=W&prm_acao=insert'', false, '''', '''', '''', ''BRO''); if(respostaAjax == ''OK''){ reload(); alerta(''msg'', TR_AD); carregaPainel(''browser'', '''||prm_default||'''); ajax(''list'', ''browserConfig'', ''prm_microdata='||ws_codigo||''', false, ''content'', '''', '''', ''BRO''); } else { alerta(''msg'', TR_ER); } }">'||fun.lang('ADICIONAR COLUNA')||'</a>');
		htp.p('<a class="addpurple" onclick=" var dados = this.parentNode; if(dados.children[2].title.length > 0){ ajax(''return'', ''browserConfig_alter'', ''prm_microdata=''+dados.children[1].value+''&prm_coluna=''+dados.children[2].title+''&prm_rotulo=''+dados.children[3].value+''&prm_mascara=&prm_ligacao=SEM&prm_chave=&prm_branco=&prm_default=&prm_alinhamento=left&prm_invisivel=N&prm_formula=&prm_tipo=&prm_alignds=left&prm_tipoinput=text&prm_tamanho=&prm_validacao=&prm_ordem=''+document.getElementById(''browserconfig'').children.length+''&prm_permissao=W&prm_acao=insert'', false, '''', '''', '''', ''BRO''); if(respostaAjax.split(''|'')[0] == ''OK''){ reload(); alerta(''msg'', TR_AD); carregaPainel(''browser'', '''||prm_default||'''); ajax(''list'', ''browserConfig'', ''prm_microdata='||ws_codigo||''', false, ''content'', '''', '''', ''BRO''); } else { alerta(''msg'', respostaAjax.split(''|'')[1] ); } }">'||fun.lang('ADICIONAR COLUNA')||'</a>');		

	when prm_menu = 'list_call' then
		
		if ws_admin = 'A' then

			htp.p('<h4>'||fun.lang('ADICIONAR OBJETO')||'</h4>');

			fcl.fakeoption('micro-visao', fun.lang('Escolha uma view'), '', 'lista-views', 'N', 'N', '');
			
			fcl.fakeoption('objeto-drill', fun.lang('Escolha os objetos'), '', 'lista-objetos-call', 'N', 'S', 'micro-visao', '', prm_default);

			htp.p('<a class="addpurple" onclick="var objeto = document.getElementById(''objeto-drill'').title; if(objeto.trim().length > 0){ call(''savecall'', ''prm_objeto='||prm_default||'&prm_objeto_go=''+objeto+''&prm_screen=''+tela).then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AD); ajax(''list'', ''list_call'', ''prm_objeto='||prm_default||'&prm_screen=''+tela, true, ''content''); carregaPainel(''list_call'', '''||prm_default||'''); } else { alerta(''feed-fixo'', TR_ER); } }); } else { alerta(''feed-fixo'', TR_TC) }">ADICIONAR OBJETO</a>');
		
		
			htp.p('<h4>'||fun.lang('ADICIONAR ARQUIVO')||'</h4>');
			
			htp.p('<input type="text" value="" placeholder="'||fun.lang('NOME')||'" id="nome_call" />');

			fcl.fakeoption('call-arquivo', '', '', 'lista-arquivo-user', 'N', 'N');
			
			htp.p('<a class="addpurple" onclick="var nome = document.getElementById(''nome_call'').value; if(nome.length < 3){ alerta(''msg'', '''||fun.lang('Nome precisa ter mais de 2 caracteres')||'!''); } else { call(''save_obj'', ''prm_nome=''+encodeURIComponent(nome)+''&prm_atributo=''+encodeURIComponent(document.getElementById(''call-arquivo'').title)+''&prm_grupo=GERAL&prm_tipo=FILE&prm_visao='||prm_default||''').then(function(resposta){ if(resposta.indexOf(''FAIL'') != -1){ alerta(''feed-fixo'', TR_ER); } else { if(resposta.indexOf(''ERROCOLUNA'') != -1){ alerta(''feed-fixo'', '''||fun.lang('Erro nas colunas autom&aacute;ticas')||'!''); } else { alerta(''feed-fixo'', TR_AL); ajax(''list'', ''list_call'', ''prm_objeto='||prm_default||'&prm_screen=''+tela, true, ''content''); carregaPainel(''list_call'', '''||prm_default||'''); } } }); }" title="'||fun.lang('Criar novo arquivo')||'" class="add">ADICIONAR OBJETO</a>');

		else

			htp.p('<h4>'||fun.lang('ADICIONAR ARQUIVO')||'</h4>');

			htp.p('<input type="text" value="" placeholder="'||fun.lang('NOME')||'" id="nome_call" />');
			
			fcl.fakeoption('call-arquivo', '', '', 'lista-arquivo-user', 'N', 'N');

			htp.p('<a class="addpurple" onclick="var nome = document.getElementById(''nome_call'').value; if(nome.length < 3){ alerta(''msg'', '''||fun.lang('Nome precisa ter mais de 2 caracteres')||'!''); } else { call(''save_obj'', ''prm_nome=''+encodeURIComponent(nome)+''&prm_atributo=''+encodeURIComponent(document.getElementById(''call-arquivo'').title)+''&prm_grupo=GERAL&prm_tipo=FILE&prm_visao='||prm_default||''').then(function(resposta){ if(resposta.indexOf(''FAIL'') != -1){ alerta(''feed-fixo'', TR_ER); } else { if(resposta.indexOf(''ERROCOLUNA'') != -1){ alerta(''feed-fixo'', '''||fun.lang('Erro nas colunas autom&aacute;ticas')||'!''); } else { alerta(''feed-fixo'', TR_AL); carrega(''list_call_end?prm_objeto='||prm_default||'&prm_screen=''+tela); } } }); }" title="'||fun.lang('Criar novo arquivo')||'" class="add">ADICIONAR OBJETO</a>');
			
		end if;
	
	when prm_menu = 'list_go' then
		

		htp.p('<h4>'||fun.lang('ADICIONAR DRILL')||'</h4>');

		BEGIN
			SELECT NM_OBJETO INTO WS_NM_OBJETO FROM OBJETOS WHERE CD_OBJETO = PRM_DEFAULT;
			
			BEGIN
				SELECT CD_MICRO_VISAO INTO WS_MICRO_VISAO FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_DEFAULT;

			EXCEPTION
		  		WHEN NO_DATA_FOUND THEN
				
				WS_MICRO_VISAO:='';
			END;

		EXCEPTION
			WHEN NO_DATA_FOUND THEN
				WS_NM_OBJETO:='';
		END;

		htp.p('<h5>'||upper(WS_NM_OBJETO)||'</h5>');


		if fun.check_admin('DRILLS_ADD') then
			
			fcl.fakeoption('micro-visao', fun.lang('Escolha uma view'), WS_MICRO_VISAO, 'lista-views', 'N', 'N', '');
			htp.p('<input type="hidden" value="'||prm_default||'" style="display: none;" id="prm_objeto">');
			fcl.fakeoption('prm_go', fun.lang('Escolha os objetos'), '', 'lista-objetos-go', 'N', 'S', 'micro-visao', '', prm_default);
			htp.p('<input type="text" palceholder="ORDEM" value="" id="prm_ordem">');

			htp.p('<a class="addpurple" title="'||fun.lang('Adicionar')||'" data-req="goto_insert" data-par="prm_objeto|prm_go" data-res="list_go" data-res-par="prm_objeto" data-sup="list_go&prm_default='||prm_default||'" data-reload="'||prm_default||'">'||fun.lang('ADICIONAR DRILL')||'</a>');
		end if;

	when prm_menu = 'upload' then

		htp.p('<h4>'||fun.lang('UPLOAD DE ARQUIVOS')||'</h4>');

		htp.p('<a class="addpurple" id="escolherArquivoButton" onclick="document.getElementById(''arquivos'').click();">ESCOLHER ARQUIVO...</a>');

		htp.p('<input style="opacity: 0; position: fixed; top: -9999px;
        left: -9999px;" type="file" multiple id="arquivos" name="arquivos" onchange="mostrarArquivosSelecionados()"></input>');

		htp.p('<a class="addpurple" id="btnUploadArquivos" onclick="uploadArquivos('''')">ENVIAR</a>');
		
		if instr(prm_default, 'VOLTAR') > 0 then 
			htp.p('<a class="addpurple" id="btnVoltar" data-valor="'|| replace(prm_default,'VOLTAR','') ||'" onclick="uploadevoltarbotoes(''voltar'','''|| replace(prm_default,'VOLTAR','') ||''')">VOLTAR</a>');
		end if;

	when prm_menu = 'usuarios' then
		
		htp.p('<h4>'||fun.lang('USU&Aacute;RIOS')||'</h4>');
		
		htp.p('<input type="text" maxlength="40" value="" placeholder="login" id="login" onkeypress="return input(event, ''login'');" class="up"/>');
		
		htp.p('<input type="text" maxlength="60" value="" placeholder="'||fun.lang('NOME')||'" id="nome" />');
		
		htp.p('<input type="email" maxlength="60" value="" placeholder="E-MAIL" id="email_usuario" onkeypress="return input(event, ''email'');" />');

		fcl.fakeoption('usuario-grupo', fun.lang('ESCOLHA O GRUPO'), '', 'lista-gusers', 'N', 'S', '');
		
		htp.p('<input type="password" value="" placeholder="PASSWORD" id="senha" />');
		
		fcl.fakeoption('fake-permissao', fun.lang('Copiar a permiss&atilde;o'), '', 'lista-usuarios', 'N', 'N');
		
		ws_count := 0;

		htp.p('<a title="'||fun.lang('Novo usu&aacute;rio')||'" onclick="createUser();" class="addpurple">'||fun.lang('ADICIONAR USU&Aacute;RIO')||'</a>');

	when prm_menu = 'sqlparse' then
	
			htp.p('<h4>SQL</h4>');
	
			htp.p('<select onchange="ace_editor.setValue(''select * from ''+this.value); /*document.getElementById(''sqlquery'').value = ''select * from ''+this.value;*/" style="width: calc(17% - 16px);">');
				htp.p('<option selected hidden disabled>select * from</option>');
				for i in (select table_name as tabela from all_tables where owner = UPPER(ws_usuario) order by table_name) loop
					htp.p('<option value="'||i.tabela||'">'||i.tabela||'</option>');
				end loop;
			htp.p('</select>');

			htp.p('<a class="addpurple" onclick="execute_sql(''N'', ''11'');" title="10 primeiras linhas">EXECUTAR</a>');
			htp.p('<a class="addpurple" onclick="execute_sql(''N'', ''999999999'');" title="tudo">'||fun.lang('EXECUTAR COMPLETO')||'</a>');
			htp.p('<input type="text" style="display: none;" id="selecionado" value="">');

	when prm_menu = 'objetos' then

		htp.p('<h4>'||fun.lang('OBJETOS')||'</h4>');

			htp.p('<input type="text" value="" maxlength="80" placeholder="'||fun.lang('NOME DO OBJETO')||'" id="nome" />');
			htp.p('<span style="background: url('||fun.r_gif('seta', 'PNG')||') no-repeat scroll 98% 6px #FFF;" data-hint="'||fun.lang('TABELA')||'" onclick="fakeOption(''visao_tabela'', '''||fun.lang('TABELA')||''', ''tabelas'', '''');" id="visao_tabela" title="" class="fakeoption invisible">'||fun.lang('Escolha um valor')||'</span>');
			
			htp.p('<a class="script" onclick="if(this.nextElementSibling.title == ''CALL_LIST'' || this.nextElementSibling.title == ''SCRIPT'' || this.nextElementSibling.title == ''TEXTO'' || this.nextElementSibling.title == ''BROWSER'' || this.nextElementSibling.title == ''RELATORIO''){ document.getElementById(''fake_img_new'').parentNode.classList.add(''invisible'');  } else { document.getElementById(''fake_img_new'').parentNode.classList.remove(''invisible''); } if(this.nextElementSibling.title == ''BROWSER'' || this.nextElementSibling.title == ''CONSULTA''){ document.getElementById(''lista-tabelas'').parentNode.classList.remove(''invisible''); } else { document.getElementById(''lista-tabelas'').parentNode.classList.add(''invisible''); }"></a>');
			fcl.fakeoption('tipo', fun.lang('Escolha o tipo'), '', 'lista-tipos-obj', 'N', 'N', '', prm_children => 'fake_img_new');
			
			htp.p('<span class="invisible propagate">');
				fcl.fakeoption('lista-tabelas', fun.lang('Escolha a tabela'), '', 'lista-tabelas', 'S', 'N', '');
			htp.p('</span>');
			
			
			htp.p('<span class="invisible propagate">');
				fcl.fakeoption('fake_img_new', fun.lang('Imagem ou arquivo'), '', 'lista-arquivo-imagem', 'S', 'N');
			htp.p('</span>');
			
			fcl.fakeoption('fake_grupo', fun.lang('Escolha a categoria'), '', 'lista-grupos', 'N', 'N');
			htp.p('<a onclick="addObjeto()" title="'||fun.lang('Adicionar')||'" class="addpurple">'||fun.lang('ADICIONAR OBJETO')||'</a>');

	when prm_menu = 'lov' then

		htp.p('<h4>'||fun.lang('LISTA DE VALORES')||'</h4>');
		
		htp.p('<input type="text" maxlength="40" class="up" value="" placeholder="'||fun.lang('nome')||'" id="nome_lov" />');

		htp.p('<a class="script" onclick="
		if(this.nextElementSibling.title == ''TABELA''){ 
			document.getElementById(''lista-codigo'').parentNode.classList.remove(''invisible''); 
			document.getElementById(''lista-tabelas'').parentNode.classList.remove(''invisible''); 
			document.getElementById(''lista-descricao'').parentNode.classList.remove(''invisible'');  } 
		else { 
			document.getElementById(''lista-codigo'').parentNode.classList.add(''invisible'');
			document.getElementById(''lista-tabelas'').parentNode.classList.add(''invisible'');
			document.getElementById(''lista-descricao'').parentNode.classList.add(''invisible''); } 
		if(this.nextElementSibling.title == ''LISTA''){ 
			document.getElementById(''lista_lov'').classList.remove(''invisible''); } 
		else { document.getElementById(''lista_lov'').classList.add(''invisible''); }"></a>');
		
		fcl.fakeoption('tipos', fun.lang('Escolha o tipo'), '', 'lista-tipos-lov', 'N', 'N', '', prm_children => 'lista-codigo');
			
		htp.p('<span class="invisible propagate">');
		fcl.fakeoption('lista-tabelas', fun.lang('Escolha a tabela'), '', 'lista-tabelas', 'S', 'N', prm_children => 'lista-codigo|lista-descricao');
		htp.p('</span>');

		htp.p('<span class="invisible propagate">');	
		fcl.fakeoption('lista-codigo', fun.lang('Escolha o c&oacute;digo'), '', 'lista-codigo-custom', 'S', 'N', 'lista-tabelas');
		htp.p('</span>');
		
		htp.p('<span class="invisible propagate">');	
		fcl.fakeoption('lista-descricao', fun.lang('Escolha a descri&ccedil;&atilde;o'), '', 'lista-codigo-custom', 'S', 'N', 'lista-tabelas');
		htp.p('</span>');

		htp.p('<input class="invisible propagate" type="text" placeholder="'||fun.lang('LISTA')||'" id="lista_lov" />');
		
		htp.p('<a onclick="addLov()" title="'||fun.lang('Adicionar')||'" class="addpurple">'||fun.lang('ADICIONAR LOV')||'</a>');
	
	when prm_menu = 'sinal' then

		htp.p('<h4>'||fun.lang('SINALIZADORES')||'</h4>');

		htp.p('<input type="text" maxlength="40" id="par_name" data-min="2" placeholder="'||fun.lang('Nome do sinal')||'" class="up" />');

		htp.p('<input type="text" maxlength="40" id="par_nameds" data-min="2" placeholder="'||fun.lang('DESCRI&Ccedil;&Atilde;O DO SINAL')||'">');

		--fcl.fakeoption('filtro-coluna', 'Lista de colunas', '', 'lista-colunas', 'N', 'N', 'filtro-visao');

		fcl.fakeoption('par_sinais', fun.lang('Escolha os icones'), '', 'lista-sinais-opcoes', 'N', 'N', prm_min => 1);

		htp.p('<a title="Adicionar" data-par="par_name|par_nameds|par_sinais" data-req="save_sinal" data-res="list_sinal" data-sup="sinal" class="addpurple followed">'||fun.lang('CRIAR SINALIZADOR')||'</a>');
		--onclick="var name = document.getElementById(''nome-sinal'').value; if(!document.getElementById(name.toUpperCase()+''_sinal'')){ var nameds = document.getElementById(''nomeds-sinal'').value; var sinais = document.getElementById(''sinais'').title; if(name != ''''){ if(nameds != ''''){ call(''save_sinal'', ''par_name=''+name+''&par_nameds=''+nameds+''&par_sinais=''+sinais).then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ ajax(''list'', ''list_sinal'', '''', false, ''content''); } }); } else { alerta(''msg'', ''Favor preencher o campo de descrição!''); }} else { alerta(''msg'', ''Favor preencher o nome!''); } } else { alerta(''msg'', ''Sinal já existe!''); }"

		fcl.fakeoption('i_usuario', fun.lang('Lista de usuarios'), '', 'lista-usuario-grupo', 'N', 'N', '', '', prm_min => 1);
				
		fcl.fakeoption('micro-visao', fun.lang('Escolha uma view'), '', 'lista-views', 'N', 'N', prm_children => 'i_pa|i_coluna', prm_min => 1);
			
		fcl.fakeoption('i_pa', fun.lang('Escolha os objetos'), '', 'lista-consultas-visao', 'N', 'N', 'micro-visao', prm_children => 'i_coluna', prm_min => 1);

		fcl.fakeoption('i_coluna', fun.lang('Lista de colunas'), '', 'lista-colunas', 'N', 'N', 'micro-visao', prm_min => 1);
		
		fcl.fakeoption('i_sinal', fun.lang('Escolha um sinal'), '', 'lista-sinais', 'N', 'N', prm_min => 1);
				
		htp.p('<a title="'||fun.lang('Adicionar')||'" data-par="i_usuario|i_pa|i_coluna|i_sinal" data-req="insert_csinal" data-res="list_sinal" data-sup="sinal" class="addpurple">'||fun.lang('APLICAR SINALIZADOR')||'</a>');

	when prm_menu = 'param' then

		htp.p('<h4>'||fun.lang('PADR&Otilde;ES')||'</h4>');

		htp.p('<input type="text" maxlength="40" value="" class="up" id="prm_padrao" data-encode="S" data-min="2" placeholder="'||fun.lang('c&oacute;digo')||'" onkeydown="var regex = new RegExp(''^[a-zA-Z0-9_]+$''); if(!regex.test(event.key)){ return false; }" title="Somente letras n&uacute;meros e _">');

		htp.p('<input type="text" maxlength="40" value="" id="prm_nome" data-encode="S" data-min="2" placeholder="'||fun.lang('NOME')||'">');

		/* fcl.fakeoption('lista-tipos', 'ESCOLHA O TIPO', '', 'lista-tipos', 'S', 'N', ''); */
		fcl.fakeoption('prm_tipo', fun.lang('Escolha o tipo'), '', 'lista-tipos', 'N', 'N', '');
		fcl.fakeoption('prm_ligacao', fun.lang('Escolha o lov'), '', 'lista-lovs', 'N', 'N', '');

		htp.p('<input type="hidden" value="A" id="prm_status" />');

		htp.p('<select id="prm_float">');
			htp.p('<option selected="" disabled="" hidden="">'||fun.lang('GERAR FLOAT')||'</option>');
			htp.p('<option value="FLOAT_FILTER">FILTER</option>');
			htp.p('<option value="FLOAT_PAR">PAR</option>');
		htp.p('</select>');

		htp.p('<a data-req="add_padrao" data-par="prm_padrao|prm_nome|prm_tipo|prm_ligacao|prm_status|prm_float" data-res="list_vpadrao" data-sup="param" title="'||fun.lang('Adicionar')||'" class="addpurple">'||fun.lang('ADICIONAR PADR&Atilde;O')||'</a>');
		
	when prm_menu = 'blink' then

		htp.p('<h4>'||fun.lang('DESTAQUES')||'</h4>');

		if ws_admin = 'A' then
			fcl.fakeoption('prm_usuario', fun.lang('Lista de usu&aacute;rios'), '', 'lista-usuario-grupo', 'N', 'N', prm_min => '1');
		else
			htp.p('<input id="prm_usuario" title="'||ws_usuario||'" style="display: none;" value="'||ws_usuario||'">');
		end if;

		select cd_coluna, cd_conteudo into ws_codigo, ws_visao from table(fun.vpipe_par(prm_default));

		select cs_coluna||'|'||cs_agrupador into ws_colunas from ponto_avaliacao where cd_ponto = ws_codigo;

		htp.p('<input id="prm_objeto" style="display: none;" title="'||ws_codigo||'" value="'||ws_codigo||'">');
		htp.p('<input id="prm_visao" style="display: none;" title="'||ws_visao||'" value="'||ws_visao||'">');

		select tp_objeto into ws_primeiro from objetos where cd_objeto = ws_codigo;

		if ws_primeiro <> 'VALOR' then
			fcl.fakeoption('prm_coluna', fun.lang('Lista de colunas'), '', 'lista-colunas', 'N', 'N', 'prm_visao', '', ws_colunas, prm_min => '1');
		else
			select parametros into ws_primeiro from ponto_avaliacao where cd_ponto = ws_codigo;
			htp.p('<input id="prm_coluna" readonly class="readonly" type="text" title="'||replace(ws_primeiro, '|', '')||'" value="'||replace(ws_primeiro, '|', '')||'" />');
		end if;

		fcl.fakeoption('prm_condicao', fun.lang('Lista de condi&ccedil;&otilde;es'), '', 'lista-condicoes', 'N', 'N', prm_min => '1', prm_adicional => 'graph');
		fcl.fakeoption('prm_conteudo', fun.lang('Lista de valores'), '', 'lista-valores', 'S', 'N', 'prm_visao', '', 'prm_coluna', prm_min => '1',prm_encode => 'S');

		if ws_primeiro not in ('BARRAS', 'PIZZA', 'LINHAS', 'COLUNAS') then
			htp.p('<span class="inputcolor">');
				htp.p('<input autocomplete="on" type="text" data-min="1" placeholder="'||fun.lang('COR DA FONTE')||'" title="ex: transparent, rgb(0, 0, 0), #FFFFFF" id="prm_fonte" value="" oninput="this.nextElementSibling.value = this.value;">');
				htp.p('<input type="color" value="#111111" oninput="this.previousElementSibling.value = this.value; ">');
			htp.p('</span>');
		else
			htp.p('<input type="hidden" id="prm_fonte" value="">');
		end if;

		htp.p('<span class="inputcolor">');
			htp.p('<input autocomplete="on" type="text" data-min="1" placeholder="'||fun.lang('COR DO FUNDO')||'" title="ex: transparent, rgb(0, 0, 0), #FFFFFF" id="prm_fundo" value="" oninput="this.nextElementSibling.value = this.value;">');
			htp.p('<input type="color" value="#111111" oninput="this.previousElementSibling.value = this.value; ">');
		htp.p('</span>');

		if ws_primeiro = 'CONSULTA' then
			htp.p('<select id="prm_tipo">');
				htp.p('<option value="normal" selected disabled hidden>'||fun.lang('Tipo')||':</option>');
				htp.p('<option value="total">'||fun.lang('Total')||'</option>');
				htp.p('<option value="normal">'||fun.lang('C&eacute;lula')||'</option>');
				htp.p('<option value="linha">'||fun.lang('Linha')||'</option>');
				htp.p('<option value="celula barra">'||fun.lang('C&eacute;lula Barra')||'</option>');
				htp.p('<option value="total barra">'||fun.lang('Total Barra')||'</option>');				
			htp.p('</select>');
		else
			htp.p('<input type="hidden" id="prm_tipo" title="normal" value="normal" />');
		end if;
		
		htp.p('<input type="number" id="destaque-prioridade" value="0" style="display: none;"/>');

		--htp.p('<a title="'||fun.lang('Adicionar')||'" onclick="addDestaque()" class="addpurple">+</a>');

		htp.p('<a title="Adicionar" data-req="setdestaque" data-par="prm_usuario|prm_coluna|prm_objeto|prm_condicao|prm_conteudo|prm_fundo|prm_fonte|prm_tipo" data-res="blink" data-res-par="prm_objeto|prm_visao" class="addpurple">'||fun.lang('ADICIONAR DESTAQUE')||'</a>');

	when prm_menu = 'efeito' then 

		htp.p('<h4>'||fun.lang('DESTAQUES')||'</h4>');

		fcl.fakeoption('prm_usuario', fun.lang('Lista de usu&aacute;rios'), '', 'lista-usuario-grupo', 'N', 'N', prm_children =>  'prm_visao|prm_coluna|prm_objeto|prm_condicao|prm_conteudo', prm_min => 1);
		fcl.fakeoption('prm_visao',   fun.lang('Lista de views'), '', 'lista-views', 'N', 'N', '', '', prm_children => 'prm_coluna|prm_objeto|prm_condicao|prm_conteudo', prm_min => 1);
		fcl.fakeoption('prm_coluna',  fun.lang('Lista de colunas'), '', 'lista-colunas', 'N', 'N', 'prm_visao', prm_children => 'prm_objeto|prm_condicao|prm_conteudo', prm_min => 1);
		fcl.fakeoption('prm_objeto', fun.lang('Lista de objetos'), '', 'lista-objetos-fixo', 'N', 'N', 'prm_visao', prm_children => 'prm_condicao|prm_conteudo', prm_min => 1);
		fcl.fakeoption('prm_condicao', fun.lang('Lista de condi&ccedil;&otilde;es'), '', 'lista-condicoes', 'N', 'N', prm_min => 1);
		fcl.fakeoption('prm_conteudo', fun.lang('Lista de valores'), '', 'lista-valores', 'S', 'N', 'prm_visao', '', 'prm_coluna', prm_encode => 'S', prm_min => 1);

		htp.p('<span class="inputcolor">');
			htp.p('<input autocomplete="on" type="text" data-min="1" placeholder="'||fun.lang('COR DA FONTE')||'" title="ex: transparent, rgb(0, 0, 0), #FFFFFF" id="prm_fonte" value="" oninput="this.nextElementSibling.value = this.value;">');
			htp.p('<input type="color" value="#111111" oninput="this.previousElementSibling.value = this.value; ">');
		htp.p('</span>');

		htp.p('<span class="inputcolor">');
			htp.p('<input autocomplete="on" type="text" data-min="1" placeholder="'||fun.lang('COR DO FUNDO')||'" title="ex: transparent, rgb(0, 0, 0), #FFFFFF" id="prm_fundo" value="" oninput="this.nextElementSibling.value = this.value;">');
			htp.p('<input type="color" value="#111111" oninput="this.previousElementSibling.value = this.value; ">');
		htp.p('</span>');

		htp.p('<select id="destaque-tipo" style="display: none;">');
			htp.p('<option value="linha" selected disabled hidden>'||fun.lang('Tipo')||':</option>');
			htp.p('<option value="total">'||fun.lang('Total')||'</option>');
			htp.p('<option value="normal">'||fun.lang('C&eacute;lula')||'</option>');
			htp.p('<option value="linha">'||fun.lang('Linha')||'</option>');
			htp.p('<option value="celula barra">'||fun.lang('C&eacute;lula Barra')||'</option>');
			htp.p('<option value="total barra">'||fun.lang('Total Barra')||'</option>');
		htp.p('</select>');
		
		htp.p('<input type="number" value="0" id="destaque-prioridade" style="display: none;" />');

		htp.p('<a title="'||fun.lang('Adicionar')||'" data-req="setdestaque" data-par="prm_usuario|prm_coluna|prm_objeto|prm_condicao|prm_conteudo|prm_fundo|prm_fonte" data-res="list_mblink" data-res-par="prm_usuario" data-res-tar="content" class="addpurple">'||fun.lang('ADICIONAR DESTAQUE')||'</a>');

	when prm_menu = 'blinkbrowser' then

		htp.p('<h4>'||fun.lang('ADICIONAR DESTAQUE')||'</h4>');

		if ws_admin = 'A' then
			fcl.fakeoption('destaque-usuario', 'Usu&aacute;rio', '', 'lista-usuarios', 'N', 'N');
		else
			htp.p('<input id="destaque-usuario" style="display: none;" value="'||ws_usuario||'" title="'||ws_usuario||'">');
		end if;

		htp.p('<input id="i_pa" style="display: none;" value="'||prm_default||'">');

		/*htp.p('<select id="i_lista">');
			for i in (select cd_coluna, nm_rotulo from data_coluna where cd_micro_data = prm_default order by nm_rotulo) loop
				htp.p('<option value="'||i.cd_coluna||'">['||i.cd_coluna||'] '||i.nm_rotulo||'</option>');
			end loop;
		htp.p('</select>');*/
		
		fcl.fakeoption('destaque-coluna', '', 'COLUNA', 'lista-coluna-destaq-browser', 'N', 'N', 'destaque-visao', '', prm_adicional => prm_default);
	

		/*htp.p('<select id="i_condicao" style="width: 80px;">');
			fcl.condicoes('simple');
		htp.p('</select>');*/
		
		fcl.fakeoption('destaque-condicao', fun.lang('Lista de condi&ccedil;&otilde;es'), '', 'lista-condicoes', 'N', 'N', '', '');


		fcl.fakeoption('destaque-conteudo', 'VALOR', '', 'lista-valores-browser', 'S', 'N', 'destaque-visao', '', 'destaque-coluna');
		
		htp.p('<span class="inputcolor">');
			htp.p('<input autocomplete="on" type="text" data-min="1" placeholder="COR DA FONTE" title="ex: transparent, rgb(0, 0, 0), #FFFFFF" id="prm_fonte" value="" oninput="this.nextElementSibling.value = this.value;">');
			htp.p('<input type="color" value="#111111" oninput="this.previousElementSibling.value = this.value; ">');
		htp.p('</span>');

		htp.p('<span class="inputcolor">');
			htp.p('<input autocomplete="on" type="text" data-min="1" placeholder="COR DO FUNDO" title="ex: transparent, rgb(0, 0, 0), #FFFFFF" id="prm_fundo" value="" oninput="this.nextElementSibling.value = this.value;">');
			htp.p('<input type="color" value="#111111" oninput="this.previousElementSibling.value = this.value; ">');
		htp.p('</span>');

		htp.p('<select id="tipo">');
			htp.p('<option value="estrela" selected disabled hidden>'||fun.lang('Tipo')||':</option>');
			htp.p('<option value="estrela">'||fun.lang('Estrela')||'</option>');
			htp.p('<option value="linha">'||fun.lang('Linha')||'</option>');
			htp.p('<option value="normal">'||fun.lang('C&eacute;lula')||'</option>');
		htp.p('</select>');
			
		htp.p('<input id="prioridade" value="0" type="number" />');
	
		htp.p('<a title="'||fun.lang('Adicionar')||'" onclick="var visao = document.getElementById(''destaque-visao'').title; var usuario = document.getElementById(''destaque-usuario'').title; var objeto = document.getElementById(''i_pa'').value; if(document.getElementById(''destaque-coluna'')){ var coluna = document.getElementById(''destaque-coluna'').title; var condicao = document.getElementById(''destaque-condicao'').title; var conteudo = document.getElementById(''destaque-conteudo'').title; conteudo = encodeURIComponent(conteudo); var fundo = document.getElementById(''prm_fundo'').value; var fonte = document.getElementById(''prm_fonte'').value; var tipo = document.getElementById(''tipo'').value; var prioridade = document.getElementById(''prioridade'').value; if(usuario != '''' && conteudo != '''' && fundo != '''' && fonte != '''' && prioridade != ''''){  call(''setdestaque'', ''prm_usuario=''+usuario+''&prm_objeto=''+objeto+''&prm_coluna=''+coluna+''&prm_condicao=''+condicao+''&prm_conteudo=''+conteudo+''&prm_fundo=''+fundo+''&prm_fonte=''+fonte+''&prm_tipo=''+tipo+''&prm_prioridade=''+prioridade).then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AD); call(''blink'', ''prm_objeto=''+objeto+''&prm_visao=''+visao).then(function(resposta){ document.getElementById(''content'').innerHTML = resposta; }); } else { alerta(''feed-fixo'', TR_ER); }  }); } else { alerta(''feed-fixo'','''||fun.lang('preencha todos os campos')||'!''); }} " class="addpurple">'||fun.lang('ADICIONAR EFEITO')||'</a>');

	when prm_menu = 'filtro' then

		htp.p('<h4>'||fun.lang('FILTROS')||'</h4>');
		
		htp.p('<a class="script" onclick="var clear = document.getElementById(''filtrou-coluna''); clear.title=''''; clear.setAttribute(''data-default'', ''''); clear.children[0].innerHTML = ''Lista de colunas''; clear = document.getElementById(''filtrou-condicao''); clear.title=''IGUAL''; clear.setAttribute(''data-default'', ''IGUAL''); clear.children[0].innerHTML = ''IGUAL''; clear = document.getElementById(''filtrou-valores''); clear.title=''''; clear.setAttribute(''data-default'', ''''); clear.children[0].innerHTML = ''Lista de valores'';"></a>');
		fcl.fakeoption('filtrou-visao', fun.lang('Lista de views'), '', 'lista-views', 'N', 'N', '', '');
		
		fcl.fakeoption('filtrou-coluna', fun.lang('Lista de colunas'), '', 'lista-colunas', 'N', 'N', 'filtrou-visao', '');
		
		fcl.fakeoption('filtrou-condicao', fun.lang('Lista de condi&ccedil;&otilde;es'), '', 'lista-condicoes', 'N', 'N', '', '');
		
		fcl.fakeoption('filtrou-valores', fun.lang('Lista de valores'), '', 'lista-valores', 'S', 'N', 'filtrou-visao', '', 'filtrou-coluna');
		
		htp.p('<a title="'||fun.lang('Adicionar')||'" class="addpurple" onclick=" if(document.getElementById(''filtrou-coluna'').title.length > 0){ var coluna = document.getElementById(''filtrou-coluna'').title; var visao = document.getElementById(''filtrou-visao'').title; var condicao = document.getElementById(''filtrou-condicao'').title; var valor = document.getElementById(''filtrou-valores'').title; valor = encodeURIComponent(valor); call(''edit_sfiltro'', ''new_cd_objeto=''+tela+''&new_micro_visao=''+visao+''&new_cd_coluna=''+coluna+''&new_condicao=''+condicao+''&new_conteudo=''+valor+''&new_ligacao=and'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', '''||fun.lang('Filtro de tela adicionado com sucesso')||'!''); reload(); ajax(''list'', ''list_sfiltro'', ''ws_par_sumary=''+tela, true, ''content''); } }); } else { alerta(''msg'', '''||fun.lang('Favor escolher uma op&ccedil;&atilde;o de view')||'!''); }">'||fun.lang('ADICIONAR FILTRO')||'</a>');

	when prm_menu = 'filtrou' then

		htp.p('<h4>'||fun.lang('FILTROS')||'</h4>');
		
		fcl.fakeoption('prm_tipo', fun.lang('Novo Filtro'), '', 'lista-cadastrar-filtro', 'N', 'N', prm_children => 'prm_visao|prm_coluna|prm_condicao|prm_conteudo', prm_min => 1);

		fcl.fakeoption('prm_usuario', fun.lang('Lista de usu&aacute;rios'), '', 'lista-usuario-grupo', 'N', 'S', prm_children => 'prm_visao|prm_coluna|prm_condicao|prm_conteudo', prm_min => 1);

		fcl.fakeoption('prm_usuario_origem', fun.lang('Usu&aacute;rios Origem'), '', 'lista-usuarios-filtros', 'N', 'N', prm_children => 'prm_visao|prm_coluna|prm_condicao|prm_conteudo', prm_min => 1);

		fcl.fakeoption('prm_visao', fun.lang('Lista de views'), '', 'lista-views', 'N', 'S', prm_children => 'prm_coluna|prm_condicao|prm_conteudo', prm_min => 1);
		
		fcl.fakeoption('prm_coluna', fun.lang('Lista de colunas'), '', 'lista-colunas', 'N', 'N', 'prm_visao', prm_children => 'prm_condicao|prm_conteudo', prm_min => 1);
		
		fcl.fakeoption('prm_condicao', fun.lang('Lista de condi&ccedil;&otilde;es'), '', 'lista-condicoes', 'N', 'N', prm_min => 1);
		
		fcl.fakeoption('prm_conteudo', fun.lang('Lista de valores'), '', 'lista-valores', 'S', 'S', 'prm_visao', '', 'prm_coluna', prm_min => 1, prm_encode => 'S');

		htp.p('<a title="'||fun.lang('Adicionar')||'" id="filtrou" class="addpurple" data-req="setfiltro" data-par="prm_usuario|prm_visao|prm_coluna|prm_condicao|prm_conteudo" data-res="getfiltro" data-res-par="prm_usuario" data-sup="filtrou">'||fun.lang('ADICIONAR FILTRO')||'</a></td>');

	when prm_menu = 'filtror' then

		htp.p('<h4>'||fun.lang('FILTROS')||'</h4>');
		
		select cd_conteudo into ws_codigo from table(fun.vpipe_par(prm_default));
		
		htp.p('<input type="hidden" id="prm_report" value="'||ws_codigo||'">');

		htp.p('<input type="hidden" id="prm_usuario" value="">');
				
		fcl.fakeoption('prm_visao', fun.lang('Lista de views'), '', 'lista-views', 'N', 'N', prm_children => 'prm_coluna|prm_condicao|prm_conteudo', prm_min => 1);
		
		fcl.fakeoption('prm_coluna', fun.lang('Lista de colunas'), '', 'lista-colunas', 'N', 'N', 'prm_visao', prm_children => 'prm_condicao|prm_conteudo', prm_min => 1);
		
		fcl.fakeoption('prm_condicao', fun.lang('Lista de condi&ccedil;&otilde;es'), '', 'lista-condicoes', 'N', 'N', prm_min => 1);
		
		fcl.fakeoption('prm_conteudo', fun.lang('Lista de valores'), '', 'lista-valores', 'S', 'N', 'prm_visao', '', 'prm_coluna', prm_min => 1, prm_encode => 'S');

		htp.p('<a title="'||fun.lang('Adicionar')||'" class="addpurple" data-req="addReportFilter" data-par="prm_report|prm_usuario|prm_visao|prm_coluna|prm_condicao|prm_conteudo" data-res="reportFilter" data-res-par="prm_report" data-sup="filtror" data-pkg="COM">'||fun.lang('ADICIONAR FILTRO')||'</a></td>');

	when prm_menu = 'mask' then

		htp.p('<h4>'||fun.lang('M&Aacute;SCARAS')||'</h4>');
		
		htp.p('<input id="prm_mask" maxlength="80" class="up" type="text" placeholder="'||fun.lang('NOME DA M&Aacute;SCARA')||'" data-min="1" data-encode="S" />');
		
		htp.p('<input id="prm_desc" maxlength="300" class="up" type="text" placeholder="'||fun.lang('VALOR DA M&Aacute;SCARA')||'" data-min="1" data-encode="S" />');
			
		htp.p('<a title="'||fun.lang('ADICIONAR M&Aacute;SCARA')||'" class="addpurple" data-req="load_mask" data-par="prm_mask|prm_desc" data-res="mask" data-sup="mask">'||fun.lang('ADICIONAR M&Aacute;SCARA')||'</a></td>');

	when prm_menu = 'consulta' then

		htp.p('<input type="text" id="consulta_nome" value="" onkeypress="return input(event, ''ID'');" onkeyup="ajax(''input'', ''check_data'', ''prm_valor=''+this.value+''&prm_tabela=objetos'', true, ''consulta_nome'');" class="up" placeholder="ID"/>');
		htp.p('<input type="text" id="consulta_desc" value="" placeholder="'||fun.lang('Descri&ccedil;&atilde;o')||'"/>');

		fcl.fakeoption('consulta_grupo', 'Lista de grupos', '', 'lista-grupos', 'N', 'N', '');

		/*htp.p('<span style="background: url('||fun.r_gif('seta', 'PNG')||') no-repeat scroll 98% center #FFF;"  class="fakeoption" title="" id="consulta_fake_grupo" onclick="fakeOption(''consulta_fake_grupo'', '''||fun.lang('GRUPOS')||''', ''grupo'', '''');">'||fun.lang('Escolha o grupo')||'</span>'); */
		htp.p('<select id="consulta_prm">');
			htp.p('<option value="ROLL">ROLL</option>');
			htp.p('<option value="GROUP">GROUP</option>');
			htp.p('<option value="CUBE">CUBE</option>');
		htp.p('</select>');

		/*htp.p('<select id="consulta_select" onchange="">');
			htp.p(fun.list_view);
		htp.p('</select>');*/

		fcl.fakeoption('consulta_visao', fun.lang('Lista de views'), '', 'lista-views', 'N', 'N', '', '');

		htp.p('<a class="add" title="'||fun.lang('alterar a tabela de consulta')||'" onclick="getlist(); ">+</a>');

	when prm_menu = 'visoes' then
		htp.p('<h4>VIEW</h4>');
		
		htp.p('<input type="text" maxlength="80" placeholder="'||fun.lang('nome')||'" value="" id="visao_nome" class="up" onkeyup="ajax(''input'', ''check_data'', ''prm_valor=''+this.value+''&prm_tabela=visao'', true, ''visao_nome'');">');
		
		fcl.fakeoption('visao_tabela', fun.lang('Escolha uma tabela'), '', 'lista-tabelas-view', 'S', 'N');
		
		htp.p('<input type="text" maxlength="60" placeholder="'||fun.lang('DESCRI&Ccedil;&Atilde;O')||'" value="" id="visao_desc">');
		
		fcl.fakeoption('fake_grupo', fun.lang('Escolha a categoria'), '', 'lista-grupos', 'N', 'N');
		
		--data-par="par_name|par_nameds|par_sinais" data-req="save_sinal" data-res="list_sinal" data-sup="sinal"
		htp.p('<a title="'||fun.lang('Adicionar view')||'" class="addpurple" onclick="createView();">'||fun.lang('ADICIONAR VIEW')||'</a>');

	/*when 'conteudo' then
		htp.p('<input style="margin-left: 154px;" id="valor" type="text" placeholder="'||fun.lang('Nome do valor')||'" value=""/>');
		htp.p('<a class="add" onclick="valor = document.getElementById(''valor'').value; if((valor).trim().length < 3){ alerta(''msg'',''Valor deve ter 3 ou mais caracteres!''); } else { ajax(''main'', ''add_vconteudo'', ''prm_variavel=''+valor, '''', ''ajax''); noerror('''', ''Valor incluido com sucesso!'', ''msg''); }">+</a>'); */

	when prm_menu = 'grupos' then


		htp.p('<h4>'||fun.lang('CATEGORIAS')||'</h4>');
		
		htp.p('<input type="text" maxlength="40" value="" placeholder="'||fun.lang('CATEGORIA')||'" id="prm_grupo" class="up" data-encode="S" data-min="2" />');
		fcl.fakeoption('prm_grupo_superior', fun.lang('Categoria Superior'), '', 'lista-grupo-superior', 'N', 'N', '', '');
		htp.p('<input type="text" maxlength="100" value="" placeholder="'||fun.lang('NOME')||'"     id="prm_nome" data-encode="S" data-min="2" />');
		
		htp.p('<select id="prm_classe" title="Classe da categoria" data-encode="N" data-min="2">');
			htp.p('<option value="" selected="" disabled="" hidden="">'||fun.lang('CLASSE')||'</option>');
			for a in (select cd_classe, ds_classe from classes_funcao order by ordem) loop 
				htp.p('<option value="'||a.cd_classe||'">'||a.ds_classe ||'</option>');
			end loop; 
		htp.p('</select>');
	
		htp.p('<a title="'||fun.lang('ADICIONAR CATEGORIA')||'" data-req="create_grupo" data-par="prm_grupo|prm_grupo_superior|prm_nome|prm_classe" data-res="grupos" data-sup="grupos" class="addpurple">'||fun.lang('ADICIONAR CATEGORIA')||'</a>');

	when prm_menu = 'gusuarios' then

		htp.p('<h4>'||fun.lang('GRUPOS')||'</h4>');
		
		htp.p('<input type="text" maxlength="40" value="" placeholder="ID" id="prm_grupo" class="up" data-encode="S" data-min="2" />');
		
		htp.p('<input type="text" maxlength="40" value="" placeholder="'||fun.lang('NOME')||'" id="prm_nome" data-encode="S" data-min="2" />');
		
		--htp.p('<a class="addpurple" onclick="var grupo = document.getElementById(''grupo'').value.trim(); var nome = document.getElementById(''nome'').value.trim(); if(grupo.length > 3){ if(nome.length > 3){ if(grupo != ''todos''){ call(''create_gusuarios'', ''prm_grupo=''+encodeURIComponent(grupo)+''&prm_nome=''+encodeURIComponent(nome)).then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AD); ajax(''list'', ''gusuarios'', '''', false, ''content''); carregaPainel(''gusuarios''); document.getElementById(''grupo'').value = ''''; document.getElementById(''nome'').value = ''''; } else { alerta(''feed-fixo'', TR_ER); } }); } else { alerta(''msg'','''||fun.lang('ID inv&aacute;lido de grupo')||'!''); } } else { alerta(''msg'','''||fun.lang('Nome deve ter mais de 3 caracteres')||'!'');} } else { alerta(''msg'','''||fun.lang('Grupo deve ter mais de 3 caracteres')||'!''); }">ADICIONAR GRUPO</a>');
	
		htp.p('<a title="'||fun.lang('ADICIONAR GRUPO')||'" data-req="create_gusuarios" data-par="prm_grupo|prm_nome" data-res="gusuarios" data-sup="gusuarios" class="addpurple">'||fun.lang('ADICIONAR GRUPO')||'</a>');

	when prm_menu = 'notify' then

		htp.p('<input id="valor-coluna" readonly="true" type="text" value="" style="cursor: default; background: #999; padding: 0 2px;" />');
		htp.formSelectOpen( cname => 'condicao', cattributes => 'id="condicao"');
			fcl.condicoes('simple');
		htp.formSelectClose;
		htp.p('<input type="text" value="" placeholder="'||fun.lang('conte&uacute;do')||'" id="conteudo">');

		htp.p('<a class="add" title="'||fun.lang('Adicionar filtro')||'" onclick="ajax(''main'', ''alter_filtro_notify'', ''prm_item=&prm_notify=''+document.getElementById(''cd_notify'').value+''&prm_visao=''+document.getElementById(''micro_visao'').value+''&prm_coluna=''+document.getElementById(''coluna'').value+''&prm_condicao=''+document.getElementById(''condicao'').value+''&prm_conteudo=''+document.getElementById(''conteudo'').value+''&prm_ligacao=AND&prm_action=add'', false, ''ajax''); noerror('''', '''||fun.lang('Filtro adicionado com sucesso')||'!'', ''msg'');">+</a>');
	
	when prm_menu = 'log' then

		htp.p('<h4>LOGS</h4>');

		htp.p('<select id="log-tipo">');
			htp.p('<option value="">'||fun.lang('TIPO')||'</option>');
			htp.p('<option value="EVENTO">'||fun.lang('EVENTO')||'</option>');
			htp.p('<option value="ERRO">'||fun.lang('ERRO')||'</option>');
			htp.p('<option value="OUTROS">'||fun.lang('OUTROS')||'</option>');
			htp.p('<option value="SESSAO">'||fun.lang('SESS&Atilde;O')||'</option>');
		htp.p('</select>');

		htp.p('<select id="log-usuario">');
			htp.p('<option value="">'||fun.lang('USU&Aacute;RIO')||'</option>');
			for i in(select distinct(nm_usuario) from bi_log_sistema order by nm_usuario asc) loop
				htp.p('<option value="'||i.nm_usuario||'">'||i.nm_usuario||'</option>');
			end loop;
		htp.p('</select>');

		htp.p('<input type="number" id="log-linha" style="width: 60px;" placeholder="'||fun.lang('LINHAS')||'"/>');

		htp.p('<a class="addpurple" style="line-height: 32px;" onclick="ajax(''list'', ''logs_lista'', ''prm_tipo=''+document.getElementById(''log-tipo'').value+''&prm_usuario=''+document.getElementById(''log-usuario'').value+''&prm_linha=''+document.getElementById(''log-linha'').value, false, ''ajax'');">'||fun.lang('FILTRAR')||'</a>');

	when prm_menu = 'list_crocks' then

		htp.p('<h4>'||fun.lang('MAPEAR COLUNAS')||'</h4>');

		ws_colunas := '';

		if nvl(prm_default, 'N/A') <> 'N/A' then

			select count(*) into ws_count from ponto_avaliacao where cd_ponto = prm_default;

			if ws_count <> 0 then
				
				select tp_objeto into ws_tipoGrafico from objetos where cd_objeto=prm_default;
				
				if ws_tipoGrafico <> 'PONTEIRO' then

					select cd_micro_visao, cs_coluna||'|'||nvl(parametros,cs_agrupador)||'|'||cs_colup into ws_visao, ws_colunas from ponto_avaliacao where cd_ponto = prm_default;
				else
					select cd_micro_visao, nvl(parametros,cs_agrupador)||'|'||cs_colup into ws_visao, ws_colunas from ponto_avaliacao where cd_ponto = prm_default;
				end if;

			else
				ws_visao := prm_default;
			end if;
		end if;

		htp.p('<a class="script" onclick="document.getElementById(''content'').innerHTML = ''''; loader(''painel-colunas''); call(''load_crocks'', ''prm_visao=''+this.nextElementSibling.title).then(function(resposta){ document.getElementById(''painel-colunas'').innerHTML = resposta; }); telaSup(''visao'', this.nextElementSibling.title);"></a>');
		fcl.fakeoption('micro-visao', nvl(ws_visao, fun.lang('Escolha uma view')), ws_visao, 'lista-views', 'N', 'N', '');
		
		htp.p('<div id="painel-colunas" data-colunas="'||ws_colunas||'">');
			fcl.load_crocks(ws_visao, ws_colunas, '', 'S');
		htp.p('</div>');

		htp.p('<input id="add_coluna" type="text" class="up" placeholder="'||fun.lang('NOVA COLUNA OU TEMPLATE')||'" />');
		htp.p('<div style="padding: 0 20px; display: flex;">');
			htp.p('<a class="addpurple f_addcoluna" data-template="N" style="flex-grow: 1;" title="'||fun.lang('Nova coluna')||'">'||fun.lang('ADICIONAR COLUNA')||'</a>');
			htp.p('<a class="addpurple f_addcoluna" data-template="S" style="flex-grow: 1; margin-left: 15px;" title="'||fun.lang('Novo template')||'">'||fun.lang('ADICIONAR TEMPLATE')||'</a>');
		htp.p('</div>');
		--htp.p('<a class="template" style="float: none;" title="'||fun.lang('Novo template')||'" onclick="coluna = document.getElementById(''add_coluna'').value; var regex = new RegExp(''^[a-zA-Z0-9_]+$''); if(regex.test(coluna)){ if(coluna.trim().length > 4){ var visao = document.getElementById(''micro-visao'').title; if(visao.trim().length != 0){ ajax(''fly'', ''savecolumn'', ''p_cd_coluna=''+coluna+''&p_visao=''+visao+''&prm_template=S'', false); noerror('''', '''||fun.lang('Coluna adicionada com sucesso')||'!'', ''msg''); ajax(''list'', ''load_crocks'', ''prm_visao=''+document.getElementById(''telasup'').getAttribute(''data-visao''), ''true'', ''content''); } else { alerta(''msg'','''||fun.lang('Escolha uma vis&atilde;o')||'!''); }} else { alerta(''msg'','''||fun.lang('Nome da coluna precisa ter mais de 4 caracteres')||'!''); }} else { alerta(''msg'','''||fun.lang('Valor inv&aacute;lido, somente letras, n&uacute;meros e underscore s&atilde;o permitidos')||'!''); } ">T</a>');

	when prm_menu = 'add_show' then

		htp.p('<select title="'||fun.lang('ordem')||'" id="show_only_ordem">');
			htp.p('<option selected disabled hidden value="1">'||fun.lang('ordem')||'</option>');
			for i in 1..20 loop
				htp.p('<option value="'||i||'">'||i||'</option>');
			end loop;
		htp.p('</select>');

		htp.p('<select title="'||fun.lang('tempo')||'" id="show_only_tempo">');

			htp.p('<option value="10">10s</option>');
			htp.p('<option value="20">20s</option>');
			htp.p('<option value="30" selected>30s</option>');
			htp.p('<option value="45">45s</option>');
			htp.p('<option value="60">1min</option>');
			htp.p('<option value="120">2min</option>');
			htp.p('<option value="300">5min</option>');
			htp.p('<option value="600">10min</option>');
			htp.p('<option value="900">15min</option>');
		htp.p('</select>');
		htp.p('<select id="show_only_screen">');
			for i in (select screen, descricao from all_screens where screen not in (select screen from user_sequence where usuario = prm_default)) loop
				htp.p('<option value="'||i.screen||'">['||i.screen||'] '||i.descricao||'</option>');
			end loop;
		htp.p('</select>');
		htp.p('<a class="add" onclick="ajax(''main'', ''show_update'', ''prm_usuario='||prm_default||'&prm_screen=''+document.getElementById(''show_only_screen'').value+''&prm_time=''+document.getElementById(''show_only_tempo'').value+''&prm_ordem=''+document.getElementById(''show_only_ordem'').value+''&prm_tipo='', false, ''ajax'');">+</a>');

	when prm_menu = 'object_padrao' then

		htp.p('<select id="op_obj">');
			for i in(select distinct(tp_objeto) from bi_object_padrao order by tp_objeto asc) loop
				htp.p('<option value="'||i.tp_objeto||'">'||i.tp_objeto||'</option>');
			end loop;
		htp.p('</select>');
		htp.p('<input type="text" id="op_prop" placeholder="'||fun.lang('PROPRIEDADE')||'" class="up" />');

		/* htp.p('<input type="text" id="op_label" placeholder="'||fun.lang('LABEL')||'"/>'); */
		htp.p('<input type="text" id="op_default" placeholder="'||fun.lang('DEFAULT')||'"/>');
		/*htp.p('<input type="text" style="max-width: 44px;" id="op_sufixo" placeholder="'||fun.lang('SUFIXO')||'" value="gr"/>');
		htp.p('<input type="text" style="max-width: 44px;" id="op_script" placeholder="'||fun.lang('SCRIPT')||'" value="rtl"/>');
		htp.p('<input type="text" id="op_validacao" placeholder="'||fun.lang('VALIDA&Ccedil;&Atilde;O')||'"/>');*/

		htp.p('<a class="add" onclick="var prop = encodeURIComponent(document.getElementById(''op_prop'').value); var label = ''''; if(prop.length > 0){ call(''add_object_padrao'', ''prm_obj=''+document.getElementById(''op_obj'').value+''&prm_propriedade=''+prop+''&prm_tipo=&prm_label=&prm_default=&prm_sufixo=&prm_script=&prm_validacao=&prm_grupo='').then(function(resposta){ if(resposta == ''OK''){ alerta(''msg'', TR_AD); ajax(''list'', ''object_padrao'', '''', true, ''content''); } else { alerta(''msg'', TR_ER); } }); }">+</a>');
	
	when prm_menu = 'tela_adicional' then

		begin
			select CONTEUDO into ws_padrao
			from   PARAMETRO_USUARIO
			where  cd_usuario = ws_usuario and
				cd_padrao='CD_LINGUAGEM';
		exception
			when others then
				ws_padrao := 'PORTUGUESE';
		end;

		htp.p('<select onchange="ajax(''list'', ''list_screen'', ''prm_grupo=''+this.value+''&prm_usuario='', false, ''tela_adicional'');">');
			htp.p('<option value="all" selected>'||fun.lang('TODAS AS CATEGORIAS')||'</option>');
			for i in (select cd_grupo, nm_grupo from grupos_funcao order by ordem, cd_grupo) loop
					htp.p('<option value="'||i.cd_grupo||'">'||i.cd_grupo||' - '||i.nm_grupo||'</option>');
			end loop;
		htp.p('</select>');

		htp.p('<select id="tela_adicional">');
			for a in (select screen, descricao from all_screens where screen not in (select screen from user_screens where trim(usuario) = trim(prm_default)) order by descricao) loop
				htp.p('<option id="screens_'||a.SCREEN||'" value="'||a.SCREEN||'">'||fun.utranslate('NM_OBJETO', a.SCREEN, a.DESCRICAO, ws_padrao)||'</option>');
			end loop;
		htp.p('</select>');

		htp.p('<a class="add" title="'||fun.lang('Adicionar')||'" onclick="var tela_adicional = document.getElementById(''tela_adicional'').value; var sa = document.getElementById(''screen_access_''+tela_adicional); if(tela_adicional.length > 0){ call(''add_screen_access'', ''prm_usuario='||trim(prm_default)||'&prm_tela=''+tela_adicional).then(function(resposta){ alerta(''feed-fixo'', resposta.replace(''[1]'', '''')); if(resposta.indexOf(''[1]'') != -1){ call(''screen_access'', ''prm_usuario='||trim(prm_default)||'&prm_conteudo=LISTA'').then(function(resposta){ document.getElementById(''ajax'').innerHTML = resposta; }); call(''menu_screen_access'', ''prm_usuario='||trim(prm_default)||''').then(function(resposta){ document.getElementById(''painel'').innerHTML = resposta; }); } }); } else { alerta(''msg'','''||fun.lang('Escolher um valor')||'!''); }">+</a>');
	when prm_menu = 'autoupdate_tela' then

		htp.p('<h4>'||fun.lang('ATUALIZA SISTEMA')||'</h4>');

		htp.p('<span style="color: white; text-align: right; margin: 0 0px 5px 0px">'||fun.lang('Vers&atilde;o')||' : '||gbl.getversion||'</span>');

		ws_pkgs := null; -- fun.lang('PACKAGES EM USO')||' :';
		if nvl(upper(fun.ret_var('USAR_DBA_DDL_LOCKS')),'S') = 'S' then
			for a in ( select l.name||'-'||substr(s.osuser,1,20)||'-'||substr(s.program,1,20) ds 
						from v$session s, sys.dba_ddl_locks l
						where s.sid    = l.session_id  
						and l.owner  = 'DWU' 
						and l.name  <> 'DWU'
						and l.type  <> 'Table/Procedure/Type'
						and upper(s.program) not like 'HTTPD%'  -- Não verifica sessões abertas pelo BI (HTTP)
						order by s.sql_exec_start ) loop  
				ws_pkgs := ws_pkgs||chr(10)||a.ds;
			end loop; 				
		end if; 

		ws_jobs := null; -- fun.lang('JOBS EXECUTANDO')||' :';
		for a in ( select what nm, what||' ('||substr((sysdate-this_date)*24*60,1,5)||'min)' ds  
					from all_jobs 
					order by what ) loop 
			ws_jobs := ws_jobs||chr(10)||a.ds; 				
		end loop; 				

		if nvl(upper(fun.ret_var('USAR_DBA_DDL_LOCKS')),'S') = 'S' then
			htp.p('<span style="color: white; font-weight: bold; text-align: left;">'||fun.lang('PACKAGES EM USO')||'</span>');		
			htp.p('<textarea id="prm_pkgs" disabled style="width: 280px; height: 120px;">'||ws_pkgs||'</textarea>'); 
		end if; 	
		htp.p('<span style="color: white; font-weight: bold; text-align: left;">'||fun.lang('JOBS EXECUTANDO')||'</span>');		
		htp.p('<textarea id="prm_jobs" disabled style="width: 280px; height: 120px;">'||ws_jobs||'</textarea>'); 
		
		htp.p('<a class="addpurple" title="'||fun.lang('Baixa todos objetos pendentes.')||'"    onclick="autoUpdateTodos(''BAIXA'');"   >'||fun.lang('BAIXA TODOS')||'</a>'); 
		htp.p('<a class="addpurple" title="'||fun.lang('Atualiza todos objetos pendentes.')||'" onclick="autoUpdateTodos(''ATUALIZA'');">'||fun.lang('ATUALIZA TODOS')||'</a>'); 
		htp.p('<a class="addpurple" id="id_reatualiza_painel" title="'||fun.lang('Reatualiza dados do painel, Jobs e Packages em execu&ccedil;&atilde;o.')||'" onclick="document.getElementById(''id_reatualiza_painel'').innerHTML = ''Reatualizado dados do painel...''; document.getElementById(''id_reatualiza_painel'').onclick=''''; document.getElementById(''id_reatualiza_painel'').style =''pointer-events: none;'';  call(''menu'', ''prm_menu=autoupdate_tela&prm_default='', '''', ''GET'').then(function(resposta){ document.getElementById(''painel'').innerHTML = resposta; }); ">'||fun.lang('REATUALIZA PAINEL')||'</a>'); 

	when prm_menu = 'mapa_marcador' then
		ws_onkeypress     := ' onkeypress="proxCampo(event,this);"'; 
		ws_onkeypress_cod := ' onkeypress="if(!input(event, ''ID'')) {event.preventDefault();} else {proxCampo(event,this);}"'; 		
		ws_onkeypress_int := ' onkeypress="if(!input(event, ''integer'')) {event.preventDefault();} else {proxCampo(event,this);}"'; 
		ws_onkeypress_num := ' onkeypress="if(!input(event, ''number'')) {event.preventDefault();} else {proxCampo(event,this);}"'; 			


		htp.p('<h4>'||fun.lang('MARCADORES')||'</h4>');

		htp.p('<input type="text"   maxlength="10" id="prm_cd_marcador" data-min="2" data-encode="N" placeholder="'||fun.lang('C&Oacute;DIGO MARCADOR')||'" class="up" '||ws_onkeypress_cod||'/>');
		htp.p('<input type="text"   maxlength="40" id="prm_ds_marcador" data-min="2" data-encode="S" placeholder="'||fun.lang('NOME DO MARCADOR') ||'" '||ws_onkeypress||'>');
		htp.p('<input type="text"   maxlength="5"  id="prm_nr_ordem"    data-min="1" placeholder="'||fun.lang('ORDEM')||'" '||ws_onkeypress_int||'>');

		htp.p('<span class="inputcolor">');
			htp.p('<input id="prm_label_color" autocomplete="on" type="text" data-encode="S" placeholder="'||fun.lang('COR DO TEXTO')||'" title="ex: transparent, rgb(0, 0, 0), #FFFFFF" value="" oninput="this.nextElementSibling.value = this.value;">');
			htp.p('<input type="color" value="#000000" oninput="this.previousElementSibling.value = this.value; ">');
		htp.p('</span>');

		htp.p('<input type="text" maxlength="40" id="prm_label_fontsize" placeholder="'||fun.lang('TAMANHO DA FONTE DO TEXTO')||'" '||ws_onkeypress_int||'>');

		htp.p('<select  id="prm_label_fontweight">');
			htp.p('<option value="" selected="selected" hidden="true">'||fun.lang('ESTILO DO TEXTO') ||'</option>');
			htp.p('<option value=""    >'||fun.lang('Normal')||'</option>');
			htp.p('<option value="bold">'||fun.lang('Negrito')||'</option>');
		htp.p('</select>');

		htp.p('<select  id="prm_tipo_imagem" data-encode="S" '||
			'onchange="if (this.value == ''SVG'') {
							document.getElementById(''prm_svg_path'').style.setProperty(''display'', ''block'');
							document.getElementById(''span_prm_svg_fillcolor'').style.setProperty(''display'', ''block'');
							document.getElementById(''prm_svg_fillopacity'').style.setProperty(''display'', ''block'');
							document.getElementById(''prm_svg_scale'').style.setProperty(''display'', ''block'');
							document.getElementById(''prm_svg_rotation'').style.setProperty(''display'', ''block''); 
							document.getElementById(''span_prm_img_url'').style.setProperty(''display'', ''none'');
							document.getElementById(''prm_img_height'').style.setProperty(''display'', ''none'');
							document.getElementById(''prm_img_width'').style.setProperty(''display'', ''none'');
						} else { 
							document.getElementById(''prm_svg_path'').style.setProperty(''display'', ''none'');
							document.getElementById(''span_prm_svg_fillcolor'').style.setProperty(''display'', ''none'');
							document.getElementById(''prm_svg_fillopacity'').style.setProperty(''display'', ''none'');
							document.getElementById(''prm_svg_scale'').style.setProperty(''display'', ''none'');
							document.getElementById(''prm_svg_rotation'').style.setProperty(''display'', ''none''); 
							document.getElementById(''span_prm_img_url'').style.setProperty(''display'', ''block'');
							document.getElementById(''prm_img_height'').style.setProperty(''display'', ''block'');
							document.getElementById(''prm_img_width'').style.setProperty(''display'', ''block'');
						}; 	" 
			>');
			htp.p('<option value="" selected="selected" hidden="true">'||fun.lang('TIPO DE IMAGEM') ||'</option>');
			htp.p('<option value="SVG">'||fun.lang('Imagem SVG')    ||'</option>');
			htp.p('<option value="IMG">'||fun.lang('Arquivo Imagem')||'</option>');
		htp.p('</select>');

		htp.p('<input type="text" style="display:none;" data-encode="S" id="prm_svg_path"  placeholder="'||fun.lang('PATH/VETOR SVG')||'" '||ws_onkeypress||'>');

		htp.p('<span id="span_prm_svg_fillcolor" class="inputcolor" style="display:none;">');
			htp.p('<input id="prm_svg_fillcolor" autocomplete="on" type="text"  data-encode="S" placeholder="'||fun.lang('COR DA IMAGEM SVG')||'" title="ex: transparent, rgb(0, 0, 0), #FFFFFF" value="" oninput="this.nextElementSibling.value = this.value;">');
			htp.p('<input type="color" value="#000000" oninput="this.previousElementSibling.value = this.value; ">');
		htp.p('</span>');

		htp.p('<input type="text" maxlength="40" style="display:none;" id="prm_svg_fillopacity" data-encode="S" placeholder="'||fun.lang('OPACIDADE DA IMAGEM')||'" '||ws_onkeypress_num||'>');
		htp.p('<input type="text" maxlength="40" style="display:none;" id="prm_svg_scale"       data-encode="S" placeholder="'||fun.lang('ESCALA/TAMANHO DA IMAGEM')||'" '||ws_onkeypress_num||'>');
		htp.p('<input type="text" maxlength="40" style="display:none;" id="prm_svg_rotation"                    placeholder="'||fun.lang('ROTACAO DA IMAGEM')||'" '||ws_onkeypress_int||'>');

		htp.p('<span id="span_prm_img_url" style="display:none; margin-bottom: calc(4vh - 14px);">');
			fcl.fakeoption('prm_img_url', 'ARQUIVO IMAGEM', '', 'lista-arquivo-imagem', 'N', 'N', prm_encode => 'S');
		htp.p('</span>');			

		htp.p('<input type="text" maxlength="40" style="display:none;" id="prm_img_height"    placeholder="'||fun.lang('ALTURA DA IMAGEM')||'" '||ws_onkeypress_int||'>');
		htp.p('<input type="text" maxlength="40" style="display:none;" id="prm_img_width"     placeholder="'||fun.lang('LARGURA DA IMAGEM')||'" '||ws_onkeypress_int||'>');

		-- Parametros nulos, não preenchidos na tela 
		htp.p('<input type="text" style="display:none;" id="prm_label_fontfamily">');		
		htp.p('<input type="text" style="display:none;" id="prm_svg_strokeopacity">');		


		htp.p('<a title="Adicionar" data-req="insert_mapa_marcador" data-par="prm_cd_marcador|prm_ds_marcador|prm_nr_ordem|prm_label_fontfamily|prm_label_color|prm_label_fontsize|prm_label_fontweight|prm_svg_path|prm_svg_fillcolor|prm_svg_fillopacity|prm_svg_strokeopacity|prm_svg_scale|prm_svg_rotation|prm_img_url|prm_img_height|prm_img_width" '||
                                   'data-res="list_mapa_marcador" data-sup="mapa_marcador" class="addpurple followed">'||fun.lang('CRIAR MARCADOR')||'</a>');
        
	when prm_menu = 'menu_grupo_screen' then

		htp.p('<h4>'||fun.lang('TELAS DISPON&Iacute;VEIS')||'</h4>');
		htp.p('<input type="hidden" id="prm_grupo" title="'||prm_default||'" value="'||prm_default||'">');
		htp.p('<input type="hidden" id="prm_conteudo" title="" value="FULL">');

		fcl.fakeoption('prm_tela', fun.lang('Escolha uma tela'), '', 'lista-telas', 'N', 'S', '', '', prm_default, prm_min => 1); 
		htp.p('<a class="addpurple" title="'||fun.lang('Adicionar')||'" data-children="prm_tela" data-req="add_grupo_screen" data-par="prm_grupo|prm_tela" data-res="grupo_screen" data-res-par="prm_grupo|prm_conteudo">'||fun.lang('ADICIONAR TELA')||'</a>');

	when prm_menu = 'user_permissao_list' then

		htp.p('<h4>'||fun.lang('PERMISS&Otilde;ES ESPECIAIS')||'</h4>');
		
		htp.p('<input type="hidden" id="prm_usuario" title="'||prm_default||'" value="'||prm_default||'">');
		fcl.fakeoption('prm_permissao', fun.lang('Escolha a permiss&atilde;o'), '', 'user-permissao', 'N', 'S', '', '', prm_default, prm_min => 1); 
		htp.p('<a class="addpurple" title="'||fun.lang('Adicionar')||'" data-children="prm_tela" data-req="user_permissao_insert" data-par="prm_usuario|prm_permissao" data-res="user_permissao_list" data-res-par="prm_usuario">'||fun.lang('ADICIONAR PERMISS&Atilde;O')||'</a>');

	when prm_menu = 'avisos' then
		execute immediate 'begin cfg.menu_cfg(:prm_menu); end;' using prm_menu; -- Separado para reduzir o fonte da FCL 		
    
    when prm_menu in ('etl_conexoes','etl_step', 'etl_step_param', 'etl_fila', 'etl_run', 'etl_schedule', 'etl_run_step') then
		fcl.menu_etl (prm_menu);  -- Separado por ser menu da ETL e para reduzir o fonte da FCL 
	else
		htp.p('');
	end case;
exception 
	when ws_nouser then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end menu;

procedure menu_screen_access ( prm_usuario varchar2 default null ) as

	cursor crs_grupos is
	select cd_grupo, nm_grupo, ordem
	from grupos_funcao
	order by cd_grupo;

	ws_grupo crs_grupos%rowtype;

begin

	htp.p('<h4>'||fun.lang('TELAS DISPON&Iacute;VEIS')||'</h4>');

	htp.p('<input type="hidden" id="prm_usuario" title="'||prm_usuario||'" value="'||prm_usuario||'">');
	htp.p('<input type="hidden" id="prm_conteudo" title="" value="FULL">');
	
	fcl.fakeoption('prm_tela', fun.lang('Escolha uma tela'), '', 'lista-telas', 'N', 'S', '', '', prm_usuario, prm_min => 1);
	
	htp.p('<select title="'||fun.lang('tempo')||'" id="prm_tempo">');
		htp.p('<option value="0" selected disabled hidden>'||fun.lang('TEMPO DE SLIDE')||'</option>');
		htp.p('<option value="0">0</option>');
		htp.p('<option value="10">10s</option>');
		htp.p('<option value="20">20s</option>');
		htp.p('<option value="30">30s</option>');
		htp.p('<option value="45">45s</option>');
		htp.p('<option value="60">1min</option>');
		htp.p('<option value="120">2min</option>');
		htp.p('<option value="300">5min</option>');
		htp.p('<option value="600">10min</option>');
		htp.p('<option value="900">15min</option>');
	htp.p('</select>');

	htp.p('<select title="'||fun.lang('ordem')||'" id="prm_ordem">');
		htp.p('<option selected disabled hidden value="0">'||fun.lang('ORDEM DO SLIDE')||'</option>');
		for i in 0..20 loop
			htp.p('<option value="'||i||'">'||i||'</option>');
		end loop;
	htp.p('</select>');
	
	htp.p('<a class="addpurple" title="'||fun.lang('Adicionar')||'" data-children="prm_tela" data-req="add_screen_access" data-par="prm_usuario|prm_tela|prm_tempo|prm_ordem" data-res="screen_access" data-res-par="prm_usuario|prm_conteudo">'||fun.lang('ADICIONAR TELA')||'</a>');

exception when others then
	htp.p(sqlerrm);
end menu_screen_access;


procedure menu_column_access ( prm_usuario varchar2 default null ) as

begin

	htp.p('<h4>'||fun.lang('BLOQUEIO DE COLUNA')||'</h4>');

	htp.p('<input type="hidden" id="prm_usuario" title="'||prm_usuario||'" value="'||prm_usuario||'">');
	htp.p('<input type="hidden" id="prm_conteudo" title="FULL" value="FULL">');

	fcl.fakeoption('prm_visao', fun.lang('Escolha uma view'), '', 'lista-views', 'N', 'N', prm_children => 'prm_coluna', prm_min => 1);
	fcl.fakeoption('prm_coluna', fun.lang('Lista de colunas'), '', 'lista-colunas', 'N', 'N', 'prm_visao', prm_min => 1);
	
	htp.p('<a class="addpurple" title="'||fun.lang('Adicionar')||'" data-req="add_column_access" data-par="prm_usuario|prm_coluna|prm_visao" data-res="column_access" data-res-par="prm_usuario|prm_conteudo">'||fun.lang('ADICIONAR BLOQUEIO')||'</a>');
			
end menu_column_access;


procedure menu_object_access ( prm_usuario varchar2 default null ) as

begin

	htp.p('<h4>'||fun.lang('BLOQUEIO DE OBJETO')||'</h4>');

	htp.p('<input type="hidden" id="prm_usuario" title="'||prm_usuario||'" value="'||prm_usuario||'">');
	htp.p('<input type="hidden" id="prm_conteudo" title="FULL" value="FULL">');

	fcl.fakeoption('prm_visao', fun.lang('Escolha uma view'), '', 'lista-views', 'N', 'N', prm_children => 'prm_obj', prm_min => 1);
	fcl.fakeoption('prm_obj', fun.lang('Lista de objetos'), '', 'lista-objetos-bloqueio', 'N', 'N', 'prm_visao', prm_min => 1);
	fcl.fakeoption('prm_regra', fun.lang('Regra'), '', '$tpRegra', 'N', 'N', '');

	
	htp.p('<a class="addpurple" title="'||fun.lang('Adicionar')||'" data-req="add_object_access" data-par="prm_usuario|prm_obj|prm_regra" data-res="object_access" data-res-par="prm_usuario|prm_conteudo">'||fun.lang('ADICIONAR BLOQUEIO')||'</a>');

end menu_object_access;

procedure menu_td_access ( prm_usuario varchar2 default null ) as

begin

	htp.p('<h4>NETWALL</h4>');
	
	htp.p('<input id="tr_regra" placeholder="'||fun.lang('Nome da regra')||'" title="'||fun.lang('Nome da regra')||'" class="up" />');
		htp.p('<select id="tr_tipo" title="Tipo">');
			htp.p('<option value="B">'||fun.lang('Bloqueado')||'</option>');
			htp.p('<option value="L">'||fun.lang('Liberado')||'</option>');
		htp.p('</select>');

		htp.p('<select id="tr_tp_address" title="'||fun.lang('Tipo Endere&ccedil;o')||'">');
			htp.p('<option value="I">'||fun.lang('IP Interno')||'</option>');
			htp.p('<option value="E">'||fun.lang('IP Externo')||'</option>');
		htp.p('</select>');

		htp.p('<input id="TR_ADdress" placeholder="'||fun.lang('endere&ccedil;o')||'" title="'||fun.lang('endere&ccedil;o')||'"/>');
		
		htp.p('<select title="'||fun.lang('escolha o hor&aacute;rio de inicio')||'" id="tr_hi" onchange="if(this.value == 99){ document.getElementById(''tr_hf'').selectedIndex = 0; document.getElementById(''tr_hf'').disabled = true; } else { if(document.getElementById(''tr_hf'').value == 99){ document.getElementById(''tr_hf'').disabled = false; document.getElementById(''tr_hf'').selectedIndex = 1; } }">');
			htp.p('<option value="99">'||fun.lang('SEM HOR&Aacute;RIO')||'</option>');
			htp.p('<option value="0" selected>00:00h</option>');
			htp.p('<option value="1">01:00h</option>');
			htp.p('<option value="2">02:00h</option>');
			htp.p('<option value="3">03:00h</option>');
			htp.p('<option value="4">04:00h</option>');
			htp.p('<option value="5">05:00h</option>');
			htp.p('<option value="6">06:00h</option>');
			htp.p('<option value="7">07:00h</option>');
			htp.p('<option value="8">08:00h</option>');
			htp.p('<option value="9">09:00h</option>');
			htp.p('<option value="10">10:00h</option>');
			htp.p('<option value="11">11:00h</option>');
			htp.p('<option value="12">12:00h</option>');
			htp.p('<option value="13">13:00h</option>');
			htp.p('<option value="14">14:00h</option>');
			htp.p('<option value="15">15:00h</option>');
			htp.p('<option value="16">16:00h</option>');
			htp.p('<option value="17">17:00h</option>');
			htp.p('<option value="18">18:00h</option>');
			htp.p('<option value="19">19:00h</option>');
			htp.p('<option value="20">20:00h</option>');
			htp.p('<option value="21">21:00h</option>');
			htp.p('<option value="22">22:00h</option>');
			htp.p('<option value="23">23:00h</option>');
			htp.p('<option value="24">24:00h</option>');
		htp.p('</select>');
		
		htp.p('<select title="'||fun.lang('escolha o hor&aacute;rio de termino')||'" id="tr_hf" onchange="if(this.value == 99){ document.getElementById(''tr_hi'').selectedIndex = 0; document.getElementById(''tr_hi'').disabled = true; } else { if(document.getElementById(''tr_hi'').value == 99){ document.getElementById(''tr_hi'').disabled = false; document.getElementById(''tr_hi'').selectedIndex = 1; } }">');
			htp.p('<option value="99">'||fun.lang('SEM HOR&Aacute;RIO')||'</option>');
			htp.p('<option value="0">00:00h</option>');
			htp.p('<option value="1">01:00h</option>');
			htp.p('<option value="2">02:00h</option>');
			htp.p('<option value="3">03:00h</option>');
			htp.p('<option value="4">04:00h</option>');
			htp.p('<option value="5">05:00h</option>');
			htp.p('<option value="6">06:00h</option>');
			htp.p('<option value="7">07:00h</option>');
			htp.p('<option value="8">08:00h</option>');
			htp.p('<option value="9">09:00h</option>');
			htp.p('<option value="10">10:00h</option>');
			htp.p('<option value="11">11:00h</option>');
			htp.p('<option value="12">12:00h</option>');
			htp.p('<option value="13">13:00h</option>');
			htp.p('<option value="14">14:00h</option>');
			htp.p('<option value="15">15:00h</option>');
			htp.p('<option value="16">16:00h</option>');
			htp.p('<option value="17">17:00h</option>');
			htp.p('<option value="18">18:00h</option>');
			htp.p('<option value="19">19:00h</option>');
			htp.p('<option value="20">20:00h</option>');
			htp.p('<option value="21">21:00h</option>');
			htp.p('<option value="22">22:00h</option>');
			htp.p('<option value="23">23:00h</option>');
			htp.p('<option value="24" selected>24:00h</option>');
		htp.p('</select>');

		htp.p('<select title="'||fun.lang('dia da semana')||'" id="tr_semana">');
			htp.p('<option value="2">'||fun.lang('segunda-feira')||'</option>');
			htp.p('<option value="3">'||fun.lang('ter&ccedil;a-feira')||'</option>');
			htp.p('<option value="4">'||fun.lang('quarta-feira')||'</option>');
			htp.p('<option value="5">'||fun.lang('quinta-feira')||'</option>');
			htp.p('<option value="6">'||fun.lang('sexta-feira')||'</option>');
			htp.p('<option value="7">'||fun.lang('sabado')||'</option>');
			htp.p('<option value="1">'||fun.lang('domingo')||'</option>');
			htp.p('<option value="8">'||fun.lang('dia &ugrave;til')||'</option>');
			htp.p('<option value="9">'||fun.lang('fim de semana')||'</option>');
			htp.p('<option value="0">'||fun.lang('todos os dias')||'</option>');
		htp.p('</select>');

		htp.p('<a class="addpurple" title="'||fun.lang('adicionar nova regra')||'" onclick="var regra = document.getElementById(''tr_regra'').value; var tipo = document.getElementById(''tr_tipo'').value; var tp_address = document.getElementById(''tr_tp_address'').value; var address = document.getElementById(''TR_ADdress'').value;  if(regra == '''' || tipo == '''' ){ alerta(''msg'','''||fun.lang('Favor preencher todos os campos')||'!''); } else { if(document.getElementById(regra+''tr'')){ alerta(''msg'', '''||fun.lang('regra j&aacute; existe')||'!''); } else { var hi = document.getElementById(''tr_hi'').value; var hf = document.getElementById(''tr_hf'').value; var semana = document.getElementById(''tr_semana'').value; call(''add_td_access'', ''prm_usuario='||prm_usuario||'&prm_regra=''+regra+''&prm_tipo=''+tipo+''&prm_tp_address=''+tp_address+''&prm_address=''+address+''&prm_hi=''+hi+''&prm_hf=''+hf+''&prm_semana=''+semana).then(function(resposta){ alerta(''feed-fixo'', resposta.replace(''[1]'', '''')); if(resposta.indexOf(''[1]'') != -1){ call(''td_access'', ''prm_usuario='||prm_usuario||'&prm_conteudo=LISTA'').then(function(resposta){ document.getElementById(''ajax'').innerHTML = resposta; });  } }); alerta(''msg'','''||fun.lang('regra adicionada com sucesso')||'!''); }} ">'||fun.lang('ADICIONAR NETWALL')||'</a>');

end menu_td_access;


procedure remove_location ( prm_obj    varchar2 default null,
							prm_screen varchar2 default null ) as

begin

	delete from object_location where
	object_id = prm_obj and
	screen = prm_screen;
	
	insert into bi_log_sistema values(sysdate, 'Objeto '||prm_obj||' excluido da tela '||prm_screen||'', gbl.getUsuario, 'EVENTO');
	commit;
	
end remove_location;

procedure alter_ordem_geral ( prm_valor varchar2 default null,
							prm_objeto varchar2 default null ) as
ws_count   integer; 
begin
	-- Cria a propriedade ORDEM para o usuário DWU (se não ouver e se não for drill)
	if instr(prm_objeto,'trl') = 0 then 
		select count(*) into ws_count 
		  from object_attrib 
		 where screen    = 'DEFAULT'
		   and cd_prop   = 'ORDEM' 
		   and cd_object = prm_objeto
		   and owner     = 'DWU';    
		if ws_count = 0 then 
			insert into object_attrib  ( owner, navegador, screen, cd_object, cd_prop, propriedade) values ('DWU', 'DEFAULT', 'DEFAULT', prm_objeto, 'ORDEM', prm_valor); 	
		end if; 
	end if; 

	-- Atualiza a propriedade ORDEM de todos os usuários e todas as telas 
	update object_attrib set propriedade = prm_valor where cd_prop = 'ORDEM' and cd_object = prm_objeto;
	commit;
	
end alter_ordem_geral;

procedure alter_ordem_padrao ( prm_ordem varchar2 default null,
							prm_tipo varchar2 default null,
							prm_prop varchar2 default null ) as

begin
	/*fcl.refresh_Session;*/
	update object_padrao set ordem = prm_ordem where tp_objeto = prm_tipo and cd_prop = prm_prop;
end alter_ordem_padrao;

Procedure exec_script ( Prm_Objeto     Varchar2 Default Null,
						prm_parametros varchar2 default null) as

cursor crs_parametros is
	
		select TRIM(column_value) as valor from table(fun.vpipe(prm_parametros)) where column_value is not null;

ws_parametro     crs_parametros%rowtype;

	Ws_Erro             Varchar2(4000);
	Ws_Parametros       Varchar2(4000):='';
	ws_comando          Varchar2(4000);
	Ws_Virgula          Char(1)         := ' ';
	Ws_Job_Id           Number;
	Ws_Noexec           Exception;
	Ws_Executando       Exception;
	Ws_Noact            Exception;
	Ws_Nowait           Exception;
	ws_timeout          exception;
	ws_try              number;
	Ws_Check            Number          := 0;
	ws_usuario			varchar2(80);

	V_Intcur            Pls_Integer;
	WS_RET              NUMBER;

begin
	ws_try   := 60;
	ws_check := 1;
	ws_usuario := gbl.getUsuario;
	Loop
	Exit When ws_check=0;

		Select Count(*) into ws_check
		From   Running_Process
		Where Last_Status='RUNNING' And
			DS_PROCESSO IN ((SELECT COLUMN_VALUE FROM TABLE(fun.vpipe(fun.getprop(Prm_Objeto, 'EM_ESPERA')))));
		ws_try := ws_try - 1;
		If  ws_try=0 And Ws_Check<>0 Then
			Raise Ws_Timeout;
		end if;

		If  Ws_Check<>0 Then
			dbms_lock.Sleep(15);
		End If;
	End Loop;

	if  fun.getprop(Prm_Objeto, 'EXECUCAO')='EXCLUSIVA' Then
		Select count(*) into ws_Check
		From   Running_Scripts
		Where  Status = 'RUNNING' And
			Script_Name = Prm_Objeto;
		if  ws_Check > 0 Then
			raise ws_executando;
		end if;
	end if;

	Select count(*) Into ws_check
	From   running_scripts
	Where  status = 'WAITING' And
		script_Name = prm_objeto;

	If  ws_check <> 1 Then
		raise ws_executando;
	end if;

	Select JOB_ID Into Ws_JOB_ID
	From   Running_Scripts
	Where  Status = 'WAITING' And
		Script_Name = Prm_Objeto;

	Update Running_Scripts
	Set    STATUS = 'RUNNING'
	Where Script_Name = Prm_Objeto And
		Status = 'WAITING' And
		JOB_ID = WS_JOB_ID;
	Commit;

	Begin
		open crs_parametros;
			loop
				fetch crs_parametros into ws_parametro;
				exit when crs_parametros%notfound;
				ws_parametros := ws_parametros||WS_VIRGULA||chr(39)||trim(ws_parametro.valor)||chr(39);
				WS_VIRGULA    := ',';
			end loop;
		close crs_parametros;

		ws_comando := fun.getprop(Prm_Objeto, 'COMANDO');
		If  Nvl(Trim(Ws_Parametros),'SEM_PARAMETROS') <> 'SEM_PARAMETROS' Then
			ws_comando := ws_comando||'('||Ws_Parametros||')';
		End If;

		V_Intcur := Dbms_Sql.Open_Cursor;

		Dbms_Sql.Parse(V_Intcur, 'begin '||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.'||ws_comando||'; end;', Dbms_Sql.Native);
		Ws_Ret := Dbms_Sql.Execute(V_Intcur);
		Dbms_Sql.Close_Cursor(V_Intcur);

	Exception

		When Others Then
			raise ws_noexec;
	End;

	Update Running_Scripts
	Set    Status = 'END', Dt_Final = Sysdate, Mensagem_Final = ws_comando||';'
	Where  Script_Name = Prm_Objeto And
		Status = 'RUNNING' And
		JOB_ID = WS_JOB_ID;
	Commit;

	insert into bi_log_sistema values (sysdate,ws_comando||' - SCRIPT EXECUTADO COM SUCESSO. - EXEC_SCRIPT ',ws_usuario,'EVENTO');

Exception

	When ws_nowait Then
		insert into bi_log_sistema values (sysdate,DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||'- NO_WAIT - EXEC_SCRIPT',ws_usuario,'ERRO');
		--insert into log_eventos values(sysdate, 'Script ['||prm_objeto||'] Sem WAIT!',gbl.getUsuario, 'OBJ', 'SCRIPT', '01');

	When ws_timeout Then
		Update running_scripts
		Set    status = 'ERRO', dt_final = sysdate, mensagem_final = 'Time OUT por espera!'
		Where  Script_Name = Prm_Objeto And
				Status in ('RUNNING', 'WAITING') And
				Job_Id = Ws_Job_Id;

		insert into bi_log_sistema values (sysdate,DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||'- WS_TIMEOUT - EXEC_SCRIPT',ws_usuario,'ERRO');
		--insert into log_eventos values(sysdate, 'Script ['||prm_objeto||'] Time Out!',gbl.getUsuario, 'OBJ', 'SCRIPT', '01');

	When Ws_Executando Then
		insert into bi_log_sistema values (sysdate,DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||'- WS_EXECUTANDO - EXEC_SCRIPT',ws_usuario,'ERRO');
		--INSERT INTO LOG_EVENTOS VALUES (SYSDATE, 'Script ['||prm_objeto||'] '||fun.lang('J&aacute; Executando'),gbl.getUsuario, 'OBJ', 'SCRIPT', '03');

	When Ws_Noexec Then
		ws_erro := sqlerrm;
		Update Running_Scripts
		Set    Status='ERRO', Dt_Final = Sysdate, mensagem_final = ws_erro
		Where  Script_Name = Prm_Objeto And
				Status in ('RUNNING', 'WAITING') And
				Job_Id = Ws_Job_Id;

		insert into bi_log_sistema values (sysdate,DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||'- WS_NOEXEC - EXEC_SCRIPT',ws_usuario,'ERRO');
		--Insert Into Log_Eventos Values (Sysdate, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' Script ['||Prm_Objeto||'] '||ws_comando||'  '||fun.lang('Erro Execu&ccedil;&atilde;o'),gbl.getUsuario, 'OBJ', 'SCRIPT', '04');

	When Others Then
		ws_erro := sqlerrm;
		Update Running_Scripts
		Set    Status = 'ERRO', Dt_Final=Sysdate, mensagem_final = ws_erro
		Where  Script_Name = Prm_Objeto And
				Status in ('RUNNING', 'WAITING') And
				Job_Id = Ws_Job_Id;

		insert into bi_log_sistema values (sysdate,DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||'- OUTHERS - EXEC_SCRIPT',ws_usuario,'ERRO');
		--Insert Into Log_Eventos Values (Sysdate, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE,gbl.getUsuario, 'OBJ', 'SCRIPT', '05');

end EXEC_SCRIPT;

procedure Programa_Execucao ( prm_objeto     varchar2 default null,
							prm_parametros varchar2 default null,
							prm_screen     varchar2 default null ) as

	Ws_Erro             Varchar2(4000)  := 'Execu&ccedil;&atilde;o do SCRIPT Solicitada';
	Ws_Parametros       Varchar2(4000)  := '';
	Ws_Comando          Varchar2(4000);
	Ws_Virgula          Char(1)         := ' ';
	Ws_Job_Id           Number;
	Ws_Noexec           Exception;
	ws_executando       exception;
	Ws_Check            Number          := 0;
	ws_pipe             varchar2(1) := '';


begin

	begin
		If  fun.getprop(Prm_Objeto, 'EXECUCAO')='EXCLUSIVA' Then
			Select Count(*) Into Ws_Check
			From   Running_Scripts
			Where  Status IN ('RUNNING','WAITING') And
				Script_Name=Prm_Objeto;

			If  Ws_Check > 0 Then
				raise ws_executando;
			end if;
			
		End If;

		for i in(select column_value from table(fun.vpipe(trim(Prm_Parametros)))) loop
			ws_parametros := ws_parametros||ws_pipe||nvl(fun.gparametro(i.column_value, '', prm_screen),i.column_value);
			ws_pipe := '|';
		end loop;

		Begin

			Dbms_Job.Submit(Job => Ws_Job_Id,What => 'FCL.EXEC_SCRIPT('||Chr(39)||Prm_Objeto||Chr(39)||','||Chr(39)||ws_parametros||Chr(39)||');',Next_Date => Sysdate+((1/4)/(24*60)),Interval => Null);
			Insert Into Running_Scripts Values (Prm_Objeto,Sysdate,'',User,(fun.getprop(Prm_Objeto, 'PARAMETROS')),'WAITING','', Ws_Job_Id);
			Commit;

		Exception
			When Others Then
				raise ws_noexec;
		end;

		Exception
		When Ws_Executando Then

				HTP.P(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||'- WS_EXECUTANDO - PROGRAMA_EXECUCAO - '||ws_erro);
				
		When Ws_Noexec Then

				HTP.P(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||'- WS_NOEXEC - PROGRAMA_EXECUCAO - '||ws_erro);
				insert into bi_log_sistema values(sysdate, 'Erro ao criar o job: '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - PROGRAMA_EXECUCAO', gbl.getUsuario, 'erro');
				commit;

		When Others Then

				HTP.P(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||'- OTHERS - PROGRAMA_EXECUCAO - '||ws_erro);
				insert into bi_log_sistema values(sysdate, 'Erro ao chamar a procedure: '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - PROGRAMA_EXECUCAO', gbl.getUsuario, 'erro');
				commit;

	end;

	htp.p(WS_ERRO);

end PROGRAMA_EXECUCAO;

procedure check_text_post as

	ws_count         number;
	ws_nosession     exception;
	ws_usuario       varchar2(80); 

begin

	ws_usuario := gbl.getUsuario;

	if  fun.check_session = 'NO_S' then
		raise ws_nosession;
	else

		Select count(*) into ws_count
		from   text_post
		Where (cd_group = ws_usuario or cd_group = 'todos' or
				cd_group in (select cd_group from gusers_itens t1 where t1.cd_usuario = ws_usuario)) And
				cd_usuario <> user and
				cd_usuario <> 'SYS' and
				Post_Id Not In (Select Id_Post From Check_Post Where Cd_usuario = ws_usuario) and
				Trunc(to_date(Sysdate, 'DD-MM-YY'))-Trunc(to_date(Dt_Post, 'DD-MM-YY')) <= Time_Live and
				NVL(trim(select_line), '999999999') = '999999999';

		htp.p(ws_count);
	end if;

exception
	WHEN ws_nosession then
		htp.p('LOGOFF');
	when others then
		htp.p('LOGOFF');
end check_text_post;

procedure countCheckPost as

	ws_count    number;
	ws_usuario  varchar2(400); 
begin
	ws_usuario := gbl.getUsuario;
	select count(*) into ws_count from check_post where cd_usuario = ws_usuario and dt_check is null;
	htp.p(ws_count);
exception when others then
	htp.p('0');
end countCheckPost;

procedure notify_me ( prm_notify varchar2 default null,
					prm_ponto varchar2 default null,
					prm_visao varchar2 default null ) as

	cursor crs_usuarios is select usu_nome, usu_completo
	from usuarios
	order by usu_nome;

	ws_usuario crs_usuarios%rowtype;

	cursor crs_grupos is select cd_group, nm_group
	from gusers
	order by nm_group;

	ws_grupo crs_grupos%rowtype;

	cursor crs_notify is
	select cd_notify, ds_notify, cd_grupo, cd_ponto, micro_visao from notify_me
	where cd_usuario = gbl.getUsuario
	order by cd_notify;

	ws_notify crs_notify%rowtype;

	ws_valor    varchar2(40);
	ws_count    number;
	ws_desc     varchar2(2000) := '';
	ws_texto    varchar2(2000) := '';
	ws_receiver varchar2(2000) := '';
	ws_padrao   varchar2(80) := 'PORTUGUESE';
begin
	/*fcl.refresh_Session;*/
	
	begin
		select CONTEUDO into ws_padrao
		from   PARAMETRO_USUARIO
		where  cd_usuario = gbl.getUsuario and
			cd_padrao='CD_LINGUAGEM';
	exception
		when others then
			ws_padrao := 'PORTUGUESE';
	end;
	
	htp.p('<div style="display: inline-flex; height: 25px; line-height: 25px;">');
		htp.p('<input type="hidden" id="cd_ponto" value="'||prm_ponto||'" />');
		htp.p('<input type="hidden" id="micro_visao" value="'||prm_visao||'" />');
		if nvl(trim(prm_notify), '999999999') <> '999999999' then
			select ds_notify into ws_desc from notify_me where cd_notify = prm_notify;
			select type_text into ws_texto from notify_me where cd_notify = prm_notify;
			select cd_grupo into ws_receiver from notify_me where cd_notify = prm_notify;
			htp.p('<input style="background: #BBB;" class="up" readonly="true" type="text" placeholder="'||fun.lang('c&oacute;digo')||'" id="cd_notify" value="'||prm_notify||'">');
		else
			htp.p('<input type="text" placeholder="'||fun.lang('c&oacute;digo')||'" id="cd_notify" class="up" style="float: left;">');
		end if;
		if length(ws_desc) > 3 then
			htp.p('<input style="background: #BBB;" readonly="true" type="text" title="'||ws_desc||'" id="ds_notify" value="'||fun.utranslate('DS_NOTIFY', 'NOTIFY_ME', ws_desc, ws_padrao)||'" />');
			htp.p('<a style="height: 18px; margin: 3px 0;" class="fakelang" onclick="fakeLang(''ds_notify'', ''NOTIFY_ME|DS_NOTIFY|''+this.previousElementSibling.title);">L</a>');
		else
			htp.p('<input type="text" style="float: left;" placeholder="'||fun.lang('descri&ccedil;&atilde;o')||'" id="ds_notify" value="'||ws_desc||'">');
		end if;

		if nvl(trim(prm_notify), '999999999') = '999999999' then
			htp.p('<select id="receiver" style="float: left;" >');
		else
			htp.p('<select id="receiver" onchange="ajax(''fly'', ''save_notify'', ''prm_notify='||prm_notify||'&prm_dsnotify=''+document.getElementById(''ds_notify'').value+''&prm_ponto='||prm_ponto||'&prm_receiver=''+this.value+''&prm_texto=''+document.getElementById(''type_text'').value+''&prm_visao='||prm_visao||'&prm_update=S'', false); noerror('''', TR_CR, ''msg'');">');
		end if;

		htp.p('<option value="todos">'||fun.lang('Todos')||'</option>');
		htp.p('<optgroup label="'||fun.lang('GRUPOS')||'" style="font-weight: bold; font-size: 14px;">'||fun.lang('GRUPOS')||'</optgroup>');
		open crs_grupos;
			loop
				fetch crs_grupos into ws_grupo;
				exit when crs_grupos%notfound;
				if ws_receiver = ws_grupo.cd_group then
					htp.p('<option selected="selected" value="'||ws_grupo.cd_group||'" title="'||ws_grupo.nm_group||'">'||ws_grupo.nm_group||'</option>');
				else
					htp.p('<option value="'||ws_grupo.cd_group||'" title="'||ws_grupo.nm_group||'">'||ws_grupo.nm_group||'</option>');
				end if;
			end loop;
		close crs_grupos;
		htp.p('<optgroup label="'||fun.lang('USU&Aacute;RIOS')||'" style="font-weight: bold; font-size: 14px;">'||fun.lang('USU&Aacute;RIOS')||'</optgroup>');
		open crs_usuarios;
			loop
				fetch crs_usuarios into ws_usuario;
				exit when crs_usuarios%notfound;
					if ws_receiver = ws_usuario.usu_nome then
						htp.p('<option selected="selected" value="'||trim(ws_usuario.usu_nome)||'" title="'||trim(ws_usuario.usu_completo)||'">'||trim(ws_usuario.usu_nome)||'</option>');
					else
						htp.p('<option value="'||trim(ws_usuario.usu_nome)||'" title="'||trim(ws_usuario.usu_completo)||'">'||trim(ws_usuario.usu_nome)||'</option>');
					end if;
			end loop;
		close crs_usuarios;
		htp.p('</select>');
		if nvl(trim(prm_notify), '999999999') = '999999999' then
			htp.p('<textarea class="retracted" type="text" onblur="this.className = ''retracted'';" id="type_text" onfocus="this.className = ''retracted expand'';" placeholder="'||fun.lang('Observa&ccedil;&atilde;o')||'">'||ws_texto||'</textarea>');
			htp.p('<a class="add" onclick="if(document.getElementById(''cd_notify'').value.trim().length > 1){ if(document.getElementById(''type_text'').value.trim().length > 0){ ajax(''main'', ''save_notify'', ''prm_notify=''+document.getElementById(''cd_notify'').value+''&prm_dsnotify=''+document.getElementById(''ds_notify'').value+''&prm_ponto=''+document.getElementById(''cd_ponto'').value+''&prm_receiver=''+document.getElementById(''usuario-msg'').title+''&prm_texto=''+document.getElementById(''type_text'').value+''&prm_visao=''+document.getElementById(''micro_visao'').value, false, ''ajax''); noerror('''', TR_AD, ''msg''); } else { alerta(''msg'', TR_BL); } } else { alerta(''msg'', TR_CD_LE); }">+</a>');
		else
			htp.p('<textarea class="retracted" type="text" onblur="this.className = ''retracted''; ajax(''fly'', ''save_notify'', ''prm_notify='||prm_notify||'&prm_dsnotify=''+document.getElementById(''ds_notify'').value+''&prm_ponto='||prm_ponto||'&prm_receiver=''+document.getElementById(''usuario-msg'').title+''&prm_texto=''+this.value+''&prm_visao='||prm_visao||'&prm_update=S'', false); noerror('''', TR_CR, ''msg'');" id="type_text" onfocus="this.className = ''retracted expand'';" placeholder="'||fun.lang('Observa&ccedil;&atilde;o')||'">'||ws_texto||'</textarea>');
		end if;
	htp.p('</div>');

	htp.p('<h2>'||fun.lang('Lista de notifica&ccedil;&otilde;es')||'</h2>');

	htp.p('<table class="linha">');
	htp.p('<thead>');
		htp.p('<tr>');
			htp.p('<th>'||fun.lang('C&oacute;digo')||'</th>');
			htp.p('<th>'||fun.lang('Descri&ccedil;&atilde;o')||'</th>');
			htp.p('<th>'||fun.lang('Categoria')||'</th>');
			htp.p('<th></th>');
			htp.p('<th></th>');
			htp.p('<th></th>');
		htp.p('</tr>');
	htp.p('</thead>');
	htp.p('<tbody id="ajax">');
		open crs_notify;
			loop
				fetch crs_notify into ws_notify;
				exit when crs_notify%notfound;
				htp.p('<tr>');
					htp.p('<td>'||ws_notify.cd_notify||'</td>');
					htp.p('<td><span title="'||ws_notify.ds_notify||'" id="'||ws_notify.cd_notify||'_desc">'||fun.utranslate('DS_NOTIFY', 'NOTIFY_ME', ws_notify.ds_notify, ws_padrao)||'</span><a class="fakelang" style="margin-left: 3px;" onclick="fakeLang('''||ws_notify.cd_notify||'_desc'', ''NOTIFY_ME|DS_NOTIFY|''+this.previousElementSibling.title);">L</a></td>');
					htp.p('<td>'||ws_notify.cd_grupo||'</td>');
					htp.p('<td><a class="link" onclick=" carrega(''notify_me?prm_notify='||ws_notify.cd_notify||'&prm_ponto='||ws_notify.cd_ponto||'''); call_save('''');">'||fun.lang('ALTERAR')||'</a></td>');

					select * into ws_valor from table(fun.vpipe(ws_notify.cd_ponto)) where rownum = 1;

					htp.p('<td><a class="link" onclick="carregaPainel(''notify''); looping = setInterval(function(){ if(document.getElementById(''valor-coluna'')){ document.getElementById(''valor-coluna'').value='''||ws_valor||'''; clearInterval(looping); } }, 100); call_save(''''); carrega(''list_filtro_notify?prm_notify='||ws_notify.cd_notify||'&prm_limitado=S'');  document.getElementById(''titulo'').innerHTML=''Filtro da notifica&ccedil;&atilde;o '||ws_notify.cd_notify||''' ;">'||fun.lang('FILTROS')||'</a></td>');
					fcl.button_lixo('dl_notify','prm_notify', ws_notify.cd_notify);
					--htp.p('<td><a class="remove" onclick="ajax(''fly'', ''dl_notify'', ''prm_notify='||ws_notify.cd_notify||''', false); noerror(this, '''||fun.lang('Notifica&ccedil;&atilde;o excluida com sucesso')||'!'', ''msg'');">X</a></td>');
				htp.p('</tr>');
			end loop;
		close crs_notify;
	htp.p('</tbody>');
	htp.p('</table>');

end notify_me;

procedure save_notify ( prm_notify varchar2 default null,
						prm_dsnotify varchar2 default null,
						prm_ponto varchar2 default null,
						prm_receiver varchar2 default null,
						prm_texto varchar2 default null,
						prm_visao varchar2 default null,
						prm_update char default 'N' ) as

	ws_count   number;
	ws_padrao  varchar2(80) := 'PORTUGUESE';

begin
	/*fcl.refresh_Session;*/
	select count(*) into ws_count from notify_me where upper(trim(cd_notify)) = upper(trim(prm_notify));

	begin
		select CONTEUDO into ws_padrao
		from   PARAMETRO_USUARIO
		where  cd_usuario = gbl.getUsuario and
			cd_padrao='CD_LINGUAGEM';
	exception
		when others then
			ws_padrao := 'PORTUGUESE';
	end;

	if ws_count = 0 then
		insert into notify_me values (upper(trim(prm_notify)), prm_dsnotify, prm_ponto,gbl.getUsuario, prm_receiver, prm_texto, sysdate, '', prm_visao);
		insert into traducao_colunas values('NOTIFY_ME', 'DS_NOTIFY', fun.ret_var('LANG_SYS'), prm_dsnotify, prm_dsnotify, 'T', 'N');
		htp.p('<tr>');
			htp.p('<td>'||upper(trim(prm_notify))||'</td>');
			htp.p('<td><span title="'||prm_dsnotify||'" id="'||upper(trim(prm_notify))||'_desc">'||fun.utranslate('DS_NOTIFY', 'NOTIFY_ME', prm_dsnotify, ws_padrao)||'</span><a class="fakelang" style="margin-left: 3px;" onclick="fakeLang('''||upper(trim(prm_notify))||'_desc'', ''NOTIFY_ME|DS_NOTIFY|''+this.previousElementSibling.title);">L</a></td>');
			htp.p('<td>'||prm_receiver||'</td>');
			htp.p('<td><a class="link" onclick="carrega(''notify_me?prm_notify='||upper(trim(prm_notify))||'&prm_ponto='||prm_ponto||'''); call_save('''');">'||fun.lang('ALTERAR')||'</a></td>');
			htp.p('<td><a class="link" onclick="carregaPainel(''notify''); looping = setInterval(function(){ if(document.getElementById(''valor-coluna'')){ document.getElementById(''valor-coluna'').value='''||prm_texto||'''; clearInterval(looping); } }, 100); carrega(''list_filtro_notify?prm_notify='||upper(trim(prm_notify))||'&prm_limitado=S'');  document.getElementById(''titulo'').innerHTML=''Filtro da notifica&ccedil;&atilde;o '||upper(trim(prm_notify))||''' ;">'||fun.lang('FILTROS')||'</a></td>');
			fcl.button_lixo('dl_notify','prm_notify', upper(trim(prm_notify)));
			--htp.p('<td><a class="remove" onclick="ajax(''fly'', ''dl_notify'', ''prm_notify='||upper(trim(prm_notify))||''', false); noerror(this, '''||fun.lang('notifica&ccedil;&atilde;o excluida com sucesso')||'!'', ''msg'');">X</a></td>');
		htp.p('</tr>');
	elsif ws_count > 1 then
		htp.p('#alert '||fun.lang('notifica&ccedil;&atilde;o duplicada no sistema')||'!');
	else
		if prm_update = 'S' then
		update notify_me
		set ds_notify = prm_dsnotify,
		cd_grupo = prm_receiver,
		type_text = prm_texto,
		dt_ultima = sysdate
		where cd_notify = prm_notify;
		else
			htp.p('#alert '||fun.lang('notifica&ccedil;&atilde;o j&aacute; existe no sistema')||'!');
		end if;
	end if;

end save_notify;

procedure notify_list as

	cursor crs_notify is
	select cd_notify, ds_notify, cd_usuario, cd_grupo, cd_ponto, micro_visao, type_text from notify_me
	order by cd_usuario, cd_notify;

	ws_notify crs_notify%rowtype;

	ws_valor  varchar2(40);
	ws_padrao varchar2(80) := 'PORTUGUESE';

begin
	/*fcl.refresh_Session;*/

	begin
		select CONTEUDO into ws_padrao
		from   PARAMETRO_USUARIO
		where  cd_usuario = gbl.getUsuario and
			cd_padrao='CD_LINGUAGEM';
	exception
		when others then
			ws_padrao := 'PORTUGUESE';
	end;

	htp.p('<table class="linha">');
	htp.p('<thead>');
		htp.p('<tr>');
			htp.p('<th>'||fun.lang('Usu&aacute;rio')||'</th>');
			htp.p('<th>'||fun.lang('C&oacute;digo')||'</th>');
			htp.p('<th>'||fun.lang('Descri&ccedil;&atilde;o')||'</th>');
			htp.p('<th>'||fun.lang('Categoria')||'</th>');
			htp.p('<th></th>');
			htp.p('<th></th>');
			htp.p('<th></th>');
		htp.p('</tr>');
	htp.p('</thead>');
	htp.p('<tbody>');
		open crs_notify;
			loop
				fetch crs_notify into ws_notify;
				exit when crs_notify%notfound;
				htp.p('<tr>');
					htp.p('<td>'||ws_notify.cd_usuario||'</td>');
					htp.p('<td>'||ws_notify.cd_notify||'</td>');
					htp.p('<td><span title="'||ws_notify.ds_notify||'" id="'||ws_notify.cd_notify||'_desc">'||fun.utranslate('DS_NOTIFY', 'NOTIFY_ME', ws_notify.ds_notify, ws_padrao)||'</span><a class="fakelang" style="margin-left: 3px;" onclick="fakeLang('''||ws_notify.cd_notify||'_desc'', ''NOTIFY_ME|DS_NOTIFY|''+this.previousElementSibling.title);">L</a></td>');
					htp.p('<td>'||ws_notify.cd_grupo||'</td>');
					htp.p('<td><a class="link" onclick="carrega(''notify_me?prm_notify='||ws_notify.cd_notify||'&prm_ponto='||ws_notify.cd_ponto||'''); call_save('''');">'||fun.lang('ALTERAR')||'</a></td>');
					select * into ws_valor from table(fun.vpipe(ws_notify.cd_ponto)) where rownum = 1;

					htp.p('<td><a class="link" onclick="carregaPainel(''notify''); looping = setInterval(function(){ if(document.getElementById(''valor-coluna'')){ document.getElementById(''valor-coluna'').value='''||ws_valor||'''; clearInterval(looping); } }, 100); carrega(''list_filtro_notify?prm_notify='||ws_notify.cd_notify||'&prm_limitado=N'');  document.getElementById(''titulo'').innerHTML=''Filtro da notifica&ccedil;&atilde;o '||ws_notify.cd_notify||''' ;">'||fun.lang('FILTROS')||'</a></td>');
					fcl.button_lixo('dl_notify','prm_notify', ws_notify.cd_notify);
					--htp.p('<td><a class="remove" onclick="ajax(''fly'', ''dl_notify'', ''prm_notify='||ws_notify.cd_notify||''', false); noerror(this, '''||fun.lang('notifica&ccedil;&atilde;o excluida com sucesso')||'!'', ''msg'');">X</a></td>');
				htp.p('</tr>');
			end loop;
		close crs_notify;
	htp.p('</tbody>');
	htp.p('</table>');
end notify_list;

procedure dl_notify ( prm_notify varchar2 default null ) as

ws_count number;

begin
	/*fcl.refresh_Session;*/
	select count(*) into ws_count from notify_me where cd_notify = prm_notify;
	if ws_count = 1 then
		delete from notify_me where cd_notify = prm_notify;
		delete from filtros_notify where cd_notify = prm_notify;
	elsif ws_count = 0 then
		htp.p('#alert '||fun.lang('Erro ao excluir, notifica&ccedil;&atilde;os n&atilde;o existe no sistema')||'!');
	else
		htp.p('#alert '||fun.lang('Erro ao excluir, valor duplicado no sistema')||'!');
	end if;

end dl_notify;

procedure list_filtro_notify ( prm_notify varchar2 default null,
							prm_limitado varchar2 default 'N' ) as

	cursor crs_filtros is
	select micro_visao, cd_coluna, condicao, conteudo, ligacao, rownum as item
	from filtros_notify
	where cd_notify = prm_notify;

	ws_filtro crs_filtros%rowtype;

	ws_count number;
	ws_visao varchar2(40);
	ws_coluna varchar2(40);
begin
	/*fcl.refresh_Session;*/
	select micro_visao into ws_visao from notify_me where cd_notify = prm_notify;
	select cd_ponto into ws_coluna from notify_me where cd_notify = prm_notify;
	htp.p('<input type="hidden" value="'||prm_notify||'" id="cd_notify">');
	htp.p('<input type="hidden" value="'||ws_visao||'" id="micro_visao">');
	htp.p('<input type="hidden" value="'||ws_coluna||'" id="coluna">');
	htp.p('<table class="linha">');
		htp.p('<thead>');
			htp.p('<tr>');
				htp.p('<th>'||fun.lang('Condi&ccedil;&atilde;o')||'</th>');
				htp.p('<th>'||fun.lang('Conteudo')||'</th>');
				htp.p('<th>'||fun.lang('Liga&ccedil;&atilde;o')||'</th>');
				htp.p('<th></th>');
			htp.p('</tr>');
		htp.p('</thead>');
		htp.p('<tbody id="ajax">');
			open crs_filtros;
				loop
					fetch crs_filtros into ws_filtro;
					exit when crs_filtros%notfound;
					htp.p('<tr>');
						htp.p('<td>');
							htp.p('<select id="'||ws_filtro.item||'-condicao" onchange="ajax(''fly'', ''alter_filtro_notify'', ''prm_item='||ws_filtro.item||'&prm_notify='||prm_notify||'&prm_visao='||ws_filtro.micro_visao||'&prm_condicao=''+this.value+''&prm_conteudo=''+document.getElementById('''||ws_filtro.item||'-conteudo'').value+''&prm_ligacao=AND&prm_action=alter'', false); noerror('''', ''Filtro alterado com sucesso!'', ''msg'');">');
								
								fcl.condicoes('selected', ws_filtro.condicao);
							htp.p('</select>');
						htp.p('</td>');
						htp.p('<td><input onblur="ajax(''fly'', ''alter_filtro_notify'', ''prm_item='||ws_filtro.item||'&prm_notify='||prm_notify||'&prm_visao='||ws_filtro.micro_visao||'&prm_condicao=''+document.getElementById('''||ws_filtro.item||'-condicao'').value+''&prm_conteudo=''+this.value+''&prm_ligacao=AND&prm_action=alter'', false); noerror('''', ''Filtro alterado com sucesso!'', ''msg'');" id="'||ws_filtro.item||'-conteudo" type="text" value="'||ws_filtro.conteudo||'" /></td>');
						htp.p('<td>'||ws_filtro.ligacao||'</td>');
						htp.p('<td>');
							fcl.button_lixo('alter_filtro_notify', 'prm_item', ws_filtro.item, prm_tag => 'a');
						htp.p('</td>');
						--htp.p('<td><a class="remove" onclick="ajax(''fly'', ''alter_filtro_notify'', ''prm_item='||ws_filtro.item||''', false); noerror(this, '''||fun.lang('notifica&ccedil;&atilde;o excluida com sucesso')||'!'', ''msg'')">X</a></td>');
					htp.p('</tr>');
				end loop;
			close crs_filtros;
		htp.p('</tbody>');
	htp.p('</table>');
	if prm_limitado = 'S' then
		htp.p('<div class="listar"><a onclick="if(document.getElementById(''drill_go'')){ var go = document.getElementById(''drill_go'').value; } else { go = ''''; } if(document.getElementById(''jumpdrill'').getAttribute(''class'')){ var jump = document.getElementById(''jumpdrill'').getAttribute(''class''); } else { var jump = ''''; } document.getElementById(''painel'').innerHTML = ''''; call_save(''''); document.getElementById(''titulo'').innerHTML=''notifica&ccedil;&atilde;o de Filtro''; curtain(''enabled'') ; carrega(''notify_me?prm_visao='||ws_visao||'&prm_ponto=''+jump+''|''+go+''&''); ">'||fun.lang('Voltar as notifica&ccedil;&otilde;es')||'</a></div>');
	else

		htp.p('<div class="listar"><a onclick="call_save(''''); carrega(''notify_list''); document.getElementById(''painel'').innerHTML = ''''; document.getElementById(''titulo'').innerHTML='''||fun.lang('notifica&ccedil;&atilde;o de Filtro')||''';">'||fun.lang('Listar notifica&ccedil;&otilde;es')||'</a></div>');
	end if;
end list_filtro_notify;

procedure alter_filtro_notify ( prm_item varchar2 default null,
							prm_notify varchar2 default null,
							prm_visao varchar2 default null,
							prm_coluna varchar2 default null,
							prm_condicao varchar2 default null,
							prm_conteudo varchar2 default null,
							prm_ligacao varchar2 default null,
							prm_action varchar2 default 'del' ) as

	ws_count number;
	ws_item  number;
begin
	/*fcl.refresh_Session;*/
	if prm_action = 'add' then
		SELECT COUNT_NOTIFY.nextval INTO ws_item FROM dual;
		insert into filtros_notify values(ws_item,gbl.getUsuario, prm_notify, prm_visao, prm_coluna, prm_condicao, prm_conteudo, prm_ligacao);
		htp.p('<tr>');
			htp.p('<td>');
				htp.p('<select id="'||ws_item||'-condicao" onchange="ajax(''fly'', ''alter_filtro_notify'', ''prm_item='||ws_item||'&prm_notify='||prm_notify||'&prm_visao='||prm_visao||'&prm_condicao=''+this.value+''&prm_conteudo=''+document.getElementById('''||ws_item||'-conteudo'').value+''&prm_ligacao=AND&prm_action=alter'', false); noerror('''', ''Filtro alterado com sucesso!'', ''msg'');">');
					fcl.condicoes('selected', prm_condicao);
				htp.p('</select>');
			htp.p('</td>');
			htp.p('<td><input id="'||ws_item||'-conteudo" onblur="ajax(''fly'', ''alter_filtro_notify'', ''prm_item='||ws_item||'&prm_notify='||prm_notify||'&prm_visao='||prm_visao||'&prm_condicao=''+document.getElementById('''||ws_item||'-condicao'').value+''&prm_conteudo=''+this.value+''&prm_ligacao=AND&prm_action=alter'', false); noerror('''', ''Filtro alterado com sucesso!'', ''msg'');" type="text" value="'||prm_conteudo||'" /></td>');
			htp.p('<td>'||prm_ligacao||'</td>');
			htp.p('<td>');
				fcl.button_lixo('alter_filtro_notify','prm_item', ws_item, prm_tag => 'a');
			htp.p('</td>');
			--htp.p('<td><a class="remove" onclick="ajax(''fly'', ''alter_filtro_notify'', ''prm_item='||ws_item||''', false); noerror(this, '''||fun.lang('notifica&ccedil;&atilde;o excluida com sucesso')||'!'', ''msg'')">X</a></td>');
		htp.p('</tr>');
	elsif prm_action = 'alter' then
		update filtros_notify
		set condicao = prm_condicao,
		conteudo = prm_conteudo
		where item = prm_item;
	else
		select count(*) into ws_count from filtros_notify where item = prm_item;
		if ws_count = 1 then
			delete from filtros_notify where item = prm_item;
		elsif ws_count = 0 then
			htp.p('#alert '||fun.lang('Erro ao excluir, valor inexistente')||'!');
		else
			htp.p('#alert '||fun.lang('Erro ao excluir, notifica&ccedil;&atilde;o duplicada')||'!');
		end if;
	end if;
end alter_filtro_notify;

procedure exec_query ( p_query  in varchar2 DEFAULT NULL,
					p_parse  in varchar2 default null,
					p_linhas in varchar2 default '11') IS

v_sql       varchar2(32767) := p_query;
v_cursor    number;
col_cnt     integer;
v_n_val     number;
v_v_val     varchar2(4000);
v_l_val     long;
v_d_val     date;
rec_tab     dbms_sql.desc_tab;
dummy       number;
v_ret       number;
v_finaltxt  varchar2(100);
Col_Num     Number;
Ws_cab      Varchar2(32767);
Ws_Conteudo long;
ws_loc      number;
ws_count    number;
ws_tipolog  varchar2(25);
ws_log	  varchar2(4000);
ws_parse    exception;
ws_tipo     varchar2(40) := '';
ws_errorquery varchar2(40);

BEGIN
	/*fcl.refresh_Session;*/
if  p_linhas <> 0 then
	v_sql := 'select * from ('||v_sql||') where rownum<'||p_linhas;
end if;

begin
	v_cursor := dbms_sql.open_cursor;
	dbms_sql.parse(v_cursor, v_sql, dbms_sql.NATIVE);
	if  p_parse = 'S' then
		dbms_sql.close_cursor(v_cursor);
		raise ws_parse;
	end if;
end;

dbms_sql.describe_columns(v_cursor, col_cnt, rec_tab);
for j in 1..col_cnt
loop

	begin
	case rec_tab(j).col_type
		when 1 then
			ws_tipo := 'Varchar2';
			begin
				Dbms_Sql.Define_Column(V_Cursor,J,V_V_Val,rec_tab(j).col_max_len);
			exception when others then
				htp.p('');
			end;
		when 96 then
			begin
				Dbms_Sql.Define_Column(V_Cursor,J,V_V_Val,rec_tab(j).col_max_len);
			exception when others then
				htp.p('');
			end;
		when 2 then
			ws_tipo := 'Number';
			begin
				Dbms_Sql.Define_Column(V_Cursor,J,V_N_Val);
			exception when others then
				htp.p('');
			end;
		when 12 then
			begin
				Dbms_Sql.Define_Column(V_Cursor,J,V_D_Val);
			exception when others then
				htp.p('');
			end;
		/* when DBMS_SQL.Clob_Type then */
		when 999 then
			ws_conteudo := ws_conteudo||' '||('<td onclick="this.parentNode.classList.toggle(''selected'');" style="text-align: right;">')||'CLOB'||('</td>');
		/* when DBMS_SQL.Blob_Type then */
		when 999 then
			ws_conteudo := ws_conteudo||' '||('<td onclick="this.parentNode.classList.toggle(''selected'');" style="text-align: right;">')||'BLOB'||('</td>');
		/* when DBMS_SQL.Bfile_Type then */
		when 999 then
			ws_conteudo := ws_conteudo||' '||('<td onclick="this.parentNode.classList.toggle(''selected'');" style="text-align: right;">')||''||('</td>');
		when 8 then
			ws_tipo := 'Long';
			begin
				Dbms_Sql.Define_Column(V_Cursor,J,V_L_Val,rec_tab(j).col_max_len);
			exception when others then
				htp.p('');
			end;
	else
		ws_loc := 0;
	End Case;
	exception when others then
	ws_conteudo := ws_conteudo||' '||('<td onclick="this.parentNode.classList.toggle(''selected'');" style="text-align: right;">')||'ERRO'||('</td>');
	end;

	if instr(ws_tipo, 'char') > 0 then
		ws_tipo := ws_tipo||'('||rec_tab(j).col_max_len||')';
	end if;

	ws_cab := ws_cab||('<th title="'||ws_tipo||'" style="cursor: pointer;" onclick="document.getElementById(''sqlquery'').value = document.getElementById(''sqlquery'').value+'' ''+'''||lower(rec_tab(j).col_name)||''';">')||upper(rec_tab(j).col_name)||('</th>');

end loop;
htp.p('<thead>');
htp.p('<tr class="">');
	htp.p(ws_cab);
htp.p('</tr>');
htp.p('</thead>');

dummy := dbms_sql.execute(v_cursor);

/*
>>> DBMS_SQL.Varchar2_Type
>>> DBMS_SQL.Char_Type
>>> DBMS_SQL.Number_Type
>>> DBMS_SQL.Date_Type
>>> DBMS_SQL.Binary_Float_Type
>>> DBMS_SQL.Binary_Bouble_Type
>>> DBMS_SQL.Timestamp_Type
>>> DBMS_SQL.Timestamp_With_TZ_Type
>>> DBMS_SQL.Interval_Year_to_Month_Type
>>> DBMS_SQL.Interval_Day_To_Second_Type

>>> DBMS_SQL.Timestamp_With_Local_TZ_type
>>> DBMS_SQL.Raw_Type
>>> DBMS_SQL.Rowid_Type
>>> DBMS_SQL.Long_Type
>>> DBMS_SQL.Long_Raw_Type
>>> DBMS_SQL.User_Defined_Type
>>> DBMS_SQL.MLSLabel_Type
>>> DBMS_SQL.Ref_Type
>>> DBMS_SQL.Clob_Type, DBMS_SQL.Blob_Type, DBMS_SQL.Urowid_Type
>>> DBMS_SQL.Blob_Type
>>> DBMS_SQL.Rowid_Type
>>> DBMS_SQL.Bfile_Type
>>> DBMS_SQL.Urowid_Type
*/

ws_loc := 0;
ws_count := 0;
htp.p('<tbody>');
loop
	ws_count := ws_count+1;
	V_Ret := Dbms_Sql.Fetch_Rows(V_Cursor);
		exit when v_ret = 0;

	ws_conteudo := null;

	for j in 1..col_cnt
	loop
	case rec_tab(j).col_type
		when 1 then
			begin
				Dbms_Sql.Column_Value(V_Cursor,J,V_V_Val);
				Ws_Conteudo := Ws_Conteudo||' '||('<td onclick="this.parentNode.classList.toggle(''selected'');" style="text-align: left;">')||trim(V_V_Val)||('</td>');
			exception when others then
				Ws_Conteudo := Ws_Conteudo||' '||('<td></td>');
			end;
		when 96 then
			begin
				Dbms_Sql.Column_Value(V_Cursor,J,V_V_Val);
				Ws_Conteudo := Ws_Conteudo||' '||('<td onclick="this.parentNode.classList.toggle(''selected'');" style="text-align: left;">')||trim(V_V_Val)||('</td>');
			exception when others then
				Ws_Conteudo := Ws_Conteudo||' '||('<td></td>');
			end;
		When 2 Then
			begin
				Dbms_Sql.Column_Value(V_Cursor,J,V_N_Val);
				if  Rec_Tab(J).Col_Scale=-127 Then
					Ws_Conteudo := Ws_Conteudo||('<td onclick="this.parentNode.classList.toggle(''selected'');" style="text-align: right;">')||To_Char(V_N_Val)||' '||('</td>');
				else
					Ws_Conteudo := Ws_Conteudo||('<td onclick="this.parentNode.classList.toggle(''selected'');" style="text-align: right;">')||to_char(V_N_Val)||' '||('</td>');
				end If;
			exception when others then
				Ws_Conteudo := Ws_Conteudo||('<td></td>');
			end;
		when 12 then
			begin
				Dbms_Sql.Column_Value(V_Cursor,J,V_D_Val);
				ws_conteudo := ws_conteudo||' '||('<td onclick="this.parentNode.classList.toggle(''selected'');" style="text-align: right;">')||ltrim(to_char(v_d_val,'DD/MM/YYYY HH24:MI:SS'))||('</td>');
			exception when others then
				ws_conteudo := ws_conteudo||' '||('<td></td>');
			end;
		/* when DBMS_SQL.Clob_Type then */
		when 999 then
			begin
				ws_conteudo := ws_conteudo||' '||('<td onclick="this.parentNode.classList.toggle(''selected'');" style="text-align: right;">')||'C_OBJETO(CLOB)'||('</td>');
			exception when others then
				ws_conteudo := ws_conteudo||' '||('<td></td>');
			end;
		/* when DBMS_SQL.Blob_Type then */
		when 999 then
			begin
				ws_conteudo := ws_conteudo||' '||('<td onclick="this.parentNode.classList.toggle(''selected'');" style="text-align: right;">')||'B_OBJETO(BLOB)'||('</td>');
			exception when others then
				ws_conteudo := ws_conteudo||' '||('<td></td>');
			end;
		/* when DBMS_SQL.Bfile_Type then */
		when 999 then
			begin
				ws_conteudo := ws_conteudo||' '||('<td onclick="this.parentNode.classList.toggle(''selected'');" style="text-align: right;">')||'B_FILE(BFILE)'||('</td>');
			exception when others then
				ws_conteudo := ws_conteudo||' '||('<td></td>');
			end;
		when 8 then
			begin
				Dbms_Sql.Column_Value(V_Cursor,J,V_L_Val);
				Ws_Conteudo := Ws_Conteudo||' '||('<td onclick="this.parentNode.classList.toggle(''selected'');" style="text-align: left;">')||trim(V_L_Val)||('</td>');
			exception when others then
				ws_conteudo := ws_conteudo||' '||('<td></td>');
			end;
		else
			begin
				Dbms_Sql.Column_Value(V_Cursor,J,V_V_Val);
			exception
				when others then
					v_v_val := null;
			end;
			begin
				ws_conteudo := ws_conteudo||('<td onclick="this.parentNode.classList.toggle(''selected'');" style="text-align: left;">')||'##'||rec_tab(j).col_type||'##'||('</td>');
			exception when others then
				ws_conteudo := ws_conteudo||' '||('<td></td>');
			end;
	end case;
	end loop;
	htp.p('<tr class="">');
		htp.p(ws_conteudo);
	htp.p('</tr>');
end loop;
	ws_count := ws_count-1;
	htp.p('<tr style="display: none;" id="count-result"><td style="border: none;">'||fun.lang('N&uacute;mero de linhas')||': '||ws_count||'</td></tr>');
htp.p('</tbody>');


dbms_sql.close_cursor(v_cursor);
	if INSTR(UPPER(p_query),'BI_LOG_QUERY') = 0 THEN
		insert into BI_LOG_QUERY values( SYSDATE, UPPER(p_query), 'EXECUTADO');
	END IF;
exception
	when ws_parse then
		htp.p(fun.lang('Verifica&ccedil;&atilde;o OK!'));
	when others then
		htp.p(fun.lang('Erro na query')||'!  '||sqlerrm);
		ws_errorquery := sqlerrm;
			if INSTR(UPPER(p_query),'BI_LOG_QUERY') = 0 THEN
				insert into BI_LOG_QUERY values( SYSDATE, UPPER(p_query), UPPER('ERRO - '||ws_errorquery) );
			END IF;
end exec_query;

procedure upload ( prm_alternativo varchar2 default null ) as
l_nome_real  VARCHAR2(1000);
BEGIN
	/*fcl.refresh_Session;*/
	htp.p('<iframe src="'||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.upload.main?prm_alternativo='||prm_alternativo||'" style="width: 100%; height: 50px; display: block;"></iframe>');
END upload;

PROCEDURE download is
l_nome  VARCHAR2(255);
BEGIN
	/*fcl.refresh_Session;*/
l_nome := SUBSTR(OWA_UTIL.get_cgi_env('PATH_INFO'), 2);
WPG_DOCLOAD.download_file(l_nome);
EXCEPTION
WHEN OTHERS THEN
	HTP.htmlopen;
	HTP.headopen;
	HTP.title(fun.lang('Arquivo Carregado.'));
	HTP.headclose;
	HTP.bodyopen;
	HTP.header(1, 'STATUS');
	HTP.print('Carregado ' || l_nome || ' ERRO.');
	HTP.print(SQLERRM);
	HTP.bodyclose;
	HTP.htmlclose;
END download;

Procedure Download ( arquivo  In  Varchar2 ) As
L_Blob_Content  Tab_Documentos.Blob_Content%Type;
l_mime_type     TAB_DOCUMENTOS.mime_type%TYPE;

n_name          varchar2(4000);
ws_usuario      varchar2(80);
ws_num          number;

BEGIN

	-- colocado condição where para o ws_usuario para que ele consiga baixar o documento que foi enviado por outro usuario. 25/01/22
	ws_usuario := gbl.getUsuario;

	SELECT /*+ cardinality(1) */ blob_content, mime_type, name
	INTO   l_blob_content, L_Mime_Type, n_name
	from Tab_Documentos
	where name = arquivo 
	and usuario IN ('DWU', 'SYS', ws_usuario);

	OWA_UTIL.mime_header(l_mime_type, FALSE);
	HTP.p('Content-Length: ' || DBMS_LOB.getlength(l_blob_content));
	HTP.p('Content-Disposition: attachment; filename="'||n_name||'"');
	OWA_UTIL.http_header_close;

	WPG_DOCLOAD.download_file(l_blob_content);
EXCEPTION
	WHEN OTHERS THEN
		HTP.htmlopen;
		HTP.headopen;
		HTP.title('ARQUIVO');
		HTP.headclose;
		HTP.bodyopen;
		HTP.header(1, 'ERRO');
		HTP.print(SQLERRM);
		HTP.bodyclose;
		HTP.htmlclose;
End Download;

procedure download_tab (  prm_arquivo     varchar2 default null,
						prm_alternativo varchar2 default null ) as

	L_Blob_Content  Tab_Documentos.Blob_Content%Type;
	l_mime_type     TAB_DOCUMENTOS.mime_type%TYPE;

	n_name          varchar2(4000);
	ws_usuario 	  	varchar2(500);
	ws_admin	  	varchar2(80);

BEGIN

	ws_usuario := gbl.getusuario;
	ws_admin := gbl.getnivel;

	SELECT blob_content, mime_type,	name
	INTO   l_blob_content, L_Mime_Type, n_name
	From   Tab_Documentos
	WHERE  name = prm_arquivo 
		and (usuario = nvl(prm_alternativo, ws_usuario) OR USUARIO = 'DWU' OR GBL.GETNIVEL = 'A') and rownum = 1; 
	
	-- adicionado um getnivel no select para que os usuarios admins consigam baixar os documentos de usuarios normal. O mesmo não vale para usuarios normais, só baixam seus proprios arquivos. 22/02/2022

	OWA_UTIL.mime_header(l_mime_type, FALSE);
	HTP.p('Content-Length: ' || DBMS_LOB.getlength(l_blob_content));
	HTP.p('Content-Disposition: attachment; filename="'||n_name||'"');
	OWA_UTIL.http_header_close;

	WPG_DOCLOAD.download_file(l_blob_content);

EXCEPTION
WHEN OTHERS THEN
	HTP.htmlopen;
	HTP.headopen;
	HTP.title('ARQUIVO');
	HTP.headclose;
	HTP.bodyopen;
	HTP.header(1, 'ERRO');
	HTP.print(SQLERRM);
	HTP.bodyclose;
	HTP.htmlclose;

	insert into bi_log_sistema values (sysdate , DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - DOWNLOAD_TAB ', ws_usuario, 'ERRO');
	commit;

End download_tab;





Procedure DownloadOpen ( arquivo  in  varchar2 ) As

	L_Blob_Content  Tab_Documentos.Blob_Content%Type;
	l_mime_type     TAB_DOCUMENTOS.mime_type%TYPE;

	n_name          varchar2(4000);
	ws_usuario      varchar2(80);
	ws_logocount	number;
	ws_imglogin		varchar2(100);

BEGIN

	/* whitelist de arquivos abertos */

	case arquivo
		
		when 'css' then
			SELECT blob_content, mime_type, name INTO   l_blob_content, L_Mime_Type, n_name from Tab_Documentos
			where name = 'default-min.css' 
			and usuario in ('DWU','SYS');
		
		when 'js' then
			SELECT blob_content, mime_type, name INTO   l_blob_content,	L_Mime_Type, n_name from Tab_Documentos
			where name = 'default-min.js' 
			and usuario in ('DWU','SYS');
		
		when 'tema' then
			SELECT blob_content, mime_type, name INTO   l_blob_content, L_Mime_Type, n_name from Tab_Documentos
			where name = 'ideativo.css' 
			and usuario in ('DWU','SYS');
		
		when 'logo' then

			ws_imglogin :='loginup_alter.svg';
			select count(*) into ws_logocount from TAB_DOCUMENTOS where NAME = ws_imglogin AND USUARIO = 'DWU';
			if ws_logocount = 0  then 
				ws_imglogin :='loginup.png';
				select count(*) into ws_logocount from TAB_DOCUMENTOS where NAME = ws_imglogin AND USUARIO in ('DWU', 'SYS');
				if ws_logocount = 0  then 
					ws_imglogin:= 'bg.png';
				end if; 
			end if; 

			select blob_content, mime_type,	name into   l_blob_content, l_mime_type,n_name from tab_documentos
			where name = ws_imglogin 
			and usuario in ('DWU','SYS');	

		when 'unlock' then
			SELECT blob_content, mime_type, name INTO   l_blob_content, L_Mime_Type, n_name from Tab_Documentos
			where name = 'unlock.svg' 
			and usuario in ('DWU','SYS');

		when 'sinchronize' then
			SELECT blob_content, mime_type,	name INTO   l_blob_content, L_Mime_Type, n_name from Tab_Documentos
			where name = 'sinchronize.png' 
			and usuario in ('DWU','SYS');

		when 'background' then
			SELECT blob_content, mime_type, name INTO   l_blob_content, L_Mime_Type, n_name from Tab_Documentos
			where name = 'fundo_login.webp' 
			and usuario in ('DWU','SYS');

		when 'manifest' then
			SELECT blob_content, mime_type, name INTO   l_blob_content, L_Mime_Type, n_name from Tab_Documentos
			where name = 'manifest.json' 
			and usuario in ('DWU','SYS');

	end case;

	OWA_UTIL.mime_header(l_mime_type, FALSE);
	HTP.p('Content-Length: ' || DBMS_LOB.getlength(l_blob_content));
	HTP.p('Content-Disposition: attachment; filename="'||n_name||'"');
	OWA_UTIL.http_header_close;

	WPG_DOCLOAD.download_file(l_blob_content);
EXCEPTION
	WHEN OTHERS THEN
		htp.p(sqlerrm);
End DownloadOpen;



procedure uploaded ( prm_chave varchar2 default null ) as

ws_usuario varchar2(80);
ws_admin   varchar2(80);
ws_size    varchar2(200);

begin

	ws_usuario := gbl.getUsuario;
	ws_admin   := gbl.getNivel;

	/*if ws_usuario <> ws_admin then
		ws_usuario := ws_usuario;
	else
		ws_usuario := '%';
	end if;*/

	htp.p('<table class="linha">');

		if ws_admin = 'A' then
			htp.p('<thead>');
				htp.p('<tr>');
					htp.p('<th>USU&Aacute;RIO</th>');
					htp.p('<th>NOME</th>');
					htp.p('<th>TAMANHO</th>');
					htp.p('<th></th>');
				htp.p('</tr>');
			htp.p('</thead>');
			htp.p('<tbody id="ajax">');
			for i in (select name, doc_size, usuario from tab_documentos where usuario not like ('CHAMADO%') order by usuario ASC, name desc) loop

				if (i.name = 'default.js' or i.name = 'default.css' or i.name = 'default-min.js' or i.name = 'default-min.css') then
					htp.p('<tr style="display: none;">');
				else
					htp.p('<tr>'); 
				end if;

				htp.p('<td><a >'||i.usuario||'</a></td>');

				htp.p('<td><a class="link" href="'||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download_tab?prm_arquivo='||i.name||'&prm_alternativo='||prm_chave||'">'||i.name||'</a></td>');

				ws_size := to_char(i.doc_size/1024, '9999')||'KB';
				htp.p('<td>'||ws_size||'</td>');
				htp.p('<td>');
					fcl.button_lixo('remove_image','prm_img|prm_user', i.name||'*|*'||i.usuario, prm_tag => 'a');
				htp.p('</td>');
				--htp.p('<td><a class="remove" title="'||fun.lang('remover imagem')||'" onclick="ajax(''fly'', ''remove_image'', ''prm_img='||i.name||'&prm_user='||i.usuario||''', false); noerror(this, '''||fun.lang('Arquivo removido com sucesso')||'!'', ''msg'');">X</a></td>');

			htp.p('</tr>');

			end loop;
		else
			htp.p('<thead>');
				htp.p('<tr>');
					htp.p('<th>NOME</th>');
					htp.p('<th>TAMANHO</th>');
					htp.p('<th></th>');
				htp.p('</tr>');
			htp.p('</thead>');
			htp.p('<tbody id="ajax">');
			for i in (select name, doc_size, usuario from tab_documentos where usuario <> 'DWU' and usuario <> 'SYS' and usuario = nvl(prm_chave, ws_usuario) order by name desc) loop
				htp.p('<tr>');
					htp.p('<td><a class="link" href="'||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download_tab?prm_arquivo='||i.name||'&prm_alternativo='||prm_chave||'">'||i.name||'</a></td>');
					ws_size := to_char(i.doc_size/1024, '9999')||'KB';
					htp.p('<td>'||ws_size||'</td>');
					htp.p('<td>');
						fcl.button_lixo('remove_image','prm_img|prm_user', i.name||'|'||i.usuario, prm_tag => 'a');
					htp.p('</td>');
					--htp.p('<td><a class="remove" title="'||fun.lang('remover imagem')||'" onclick="ajax(''fly'', ''remove_image'', ''prm_img='||i.name||'&prm_user='||i.usuario||''', false); noerror(this, '''||fun.lang('Arquivo removido com sucesso')||'!'', ''msg'');">X</a></td>');
				htp.p('</tr>');
			end loop;
		end if;


		htp.p('</tbody>');
	htp.p('</ul>');

end uploaded;

procedure remove_image ( prm_img varchar2 default null, prm_user varchar2 default null ) as

begin
	/*fcl.refresh_Session;*/
	delete from tab_documentos where name = prm_img and usuario = prm_user and rownum = 1;
	insert into bi_log_sistema values(sysdate, 'Arquivo '''||prm_img||''' excluido', gbl.getUsuario, 'EVENTO');
	commit;
	/* end if; */

exception when others then

	htp.p('#error '||fun.lang('Imposs&iacute;vel excluir, valor inexistente')||'!');

end remove_image;

/**** Descontinuado a partir da versao 1.5.7 
procedure save_pos_org ( prm_obj varchar2 default null,
						prm_posx varchar2 default 50,
						prm_posy varchar2 default 50 ) as

ws_count number;

begin
--fcl.refresh_Session;
select count(*) into ws_count from grid_coor where trim(cd_depto) = trim(prm_obj);

if ws_count = 0 then
	insert into grid_coor values(prm_obj, prm_posx, prm_posy, '065182');
elsif ws_count = 1 then
	update grid_coor set
	pos_x = prm_posx,
	pos_y = prm_posy
	where trim(cd_depto) = trim(prm_obj);
else
	htp.p('#alert '||fun.lang('Erro, valor duplicado no banco')||'!');
end if;

end save_pos_org;
**********************************************/ 

procedure favoritos ( prm_screen varchar2 default null ) as

ws_usuario  varchar2(100);
ws_admin    varchar2(10);

cursor c_obj (p_tipo varchar2) is 
	select fav.cd_favorito, fav.ds_nome, fav.parametros, fav.screen, fav.cd_objeto 
	from objetos obj, favoritos fav 
	where obj.cd_objeto = fav.cd_objeto 
	and fav.usuario   = ws_usuario
	and ( (p_tipo = 'TELAS' and obj.tp_objeto = 'SCREEN' and fun.check_screen_access(fav.cd_objeto, ws_usuario, ws_admin) > 0 ) or -- fun.check_permissao_tela(fav.cd_objeto,null,ws_usuario)='S' ) or 
			(p_tipo = 'OBJETOS' and obj.tp_objeto <> 'SCREEN' and fav.screen = prm_screen ) 
		) 
	order by fav.ordem, fav.ds_nome;   

ws_html_obj      varchar2(32000); 
ws_html_tela     varchar2(32000); 
ws_class_a_obj   varchar2(20); 
ws_class_a_tela  varchar2(20); 
ws_class_ul_tela varchar2(20); 
ws_class_ul_obj  varchar2(20); 

ws_qt_obj    number; 

begin

	ws_usuario   := gbl.getUsuario; 
	ws_admin     := gbl.getNivel; 
	ws_html_obj  := ''; 
	ws_html_tela := ''; 
	htp.p('<div class="itens">');
		htp.p('<div class="fav-box">');
			htp.p('<a class="alteracao button" title="Alterar favoritos" onclick="let ws_acao = ''list_tela''; if (document.getElementById(''id_favoritos_objetos'')) { if (document.getElementById(''id_favoritos_objetos'').classList.contains(''green'')) { ws_acao = ''list''; } } document.getElementById(''fakelist'').classList.remove(''visible''); document.getElementById(''attriblist'').querySelector(''.closer'').click(); call_save(''''); curtain(''enabled''); document.getElementById(''titulo'').innerHTML = ''FAVORITOS''; call(''favoritar'', ''prm_objeto=&prm_nome=&prm_parametros=&prm_screen=''+tela+''&prm_acao=''+ws_acao).then(function(resposta){document.getElementById(''content'').innerHTML = resposta; });"></a>');

			ws_qt_obj := 0;
			for i in c_obj ('OBJETOS') loop 
				ws_qt_obj := ws_qt_obj + 1;  
				ws_html_obj := ws_html_obj|| '<li title="'||i.parametros||'" onclick="document.getElementById(''fakelist'').classList.remove(''visible''); remover('''||i.cd_objeto||'trl''); appendar(''prm_drill=Y&prm_objeto='||i.cd_objeto||'&prm_zindex=&prm_posx=''+cursorx+''px&prm_posy=''+cursory+''px&prm_screen='||i.screen||'&prm_parametros='||i.parametros||''', '''', false); setTimeout(function(){ centerDrill('''||i.cd_objeto||'''); }, 200);">';
				ws_html_obj := ws_html_obj|| '   <a class="button" style="display: block; margin-left: auto; margin-right: auto; text-transform: none; border-top: 0px;">'||i.ds_nome||'</a>';					
				ws_html_obj := ws_html_obj|| '</li>';
			end loop;

			for i in c_obj ('TELAS') loop 
				ws_html_tela := ws_html_tela|| '<li title="'||i.ds_nome||'" onclick="shscr('''||i.cd_objeto||''');">';
				ws_html_tela := ws_html_tela|| '    <a class="button" style="display: block; margin-left: auto; margin-right: auto; text-transform: none; border-top: 0px;">'||i.ds_nome||'</a>';
				ws_html_tela := ws_html_tela|| '</li>';
			end loop;

			if ws_qt_obj > 0 then 
				ws_class_a_obj   := 'green';
				ws_class_a_tela  := '';
				ws_class_ul_obj  := '';
				ws_class_ul_tela := 'closed';
			else 
				ws_class_a_obj   := '';
				ws_class_a_tela  := 'green';
				ws_class_ul_obj  := 'closed';
				ws_class_ul_tela := '';
			end if; 

			htp.p('<h2>'||fun.lang('FAVORITOS')||'</h2>');
			htp.p('<div class="abas">');
			htp.p('<a id="id_favoritos_objetos" title="Drills favoritas da tela atual" style="width: 50%; height: 90%;" class="'||ws_class_a_obj|| '" data-for="form-OBJETOS" onclick="toggleAba(this);">DRILLS</a>');
			htp.p('<a id="id_favoritos_telas"   title="Telas favoritas" style="width: 50%; height: 90%;" class="'||ws_class_a_tela||'" data-for="form-TELAS"   onclick="toggleAba(this);">TELAS</a>');
			htp.p('</div>');

			htp.p('<ul class="fav form '||ws_class_ul_obj|| '" id="form-OBJETOS">'||ws_html_obj||  '</ul>');
			htp.p('<ul class="fav form '||ws_class_ul_tela||'" id="form-TELAS">'  ||ws_html_tela|| '</ul>');

		htp.p('</div>');
	htp.p('</div>');

	fcl.closer_menu;

end favoritos;

procedure datalist ( prm_coluna varchar2 default null,
					prm_visao varchar2 default null ) as

	ws_sql           varchar2(32767);
	ws_cursor        number;
	ws_descricao     varchar2(200);
	ws_codigo        varchar2(200);
	ws_tabela        varchar2(200);
	ws_linhas        number;
	ws_sem 			 varchar2(290);

begin
	/*fcl.refresh_Session;*/
	select cd_ligacao into ws_sem from micro_coluna where cd_coluna = prm_coluna and cd_micro_visao = prm_visao;

	if ws_sem <> 'SEM' then

		select nds_tfisica, nds_cd_codigo, nds_cd_descricao into ws_tabela, ws_codigo, ws_descricao from codigo_descricao where nds_tabela = ws_sem;

		ws_sql := 'select '||ws_codigo||', '||ws_descricao||' from '||nvl(fun.ret_var('OWNER_TABLE_DATA'),'DWU')||'.'||ws_tabela||'';

		ws_cursor := dbms_sql.open_cursor;

		begin
			dbms_sql.parse(ws_cursor, ws_sql, DBMS_SQL.NATIVE);

			dbms_sql.define_column(ws_cursor, 1, ws_codigo, 200);
			dbms_sql.define_column(ws_cursor, 2, ws_descricao, 200);

			ws_linhas := dbms_sql.execute(ws_cursor);

			loop
				if dbms_sql.fetch_rows(ws_cursor) = 0 THEN
					exit;
				end if;
				dbms_sql.column_value(ws_cursor, 1, ws_codigo);
				dbms_sql.column_value(ws_cursor, 2, ws_descricao);
				htp.p('<option value="'||trim(ws_codigo)||'">'||trim(ws_descricao)||'</option>');
			end loop;

			dbms_sql.close_cursor(ws_cursor);
			
			exception when others then
				dbms_sql.close_cursor(ws_cursor);
		end;

	end if;
	
end datalist;


procedure update_file ( prm_objeto varchar2 default null,
						prm_valor varchar2 default null ) as

begin
	/*fcl.refresh_Session;*/
	update objetos
	set atributos = prm_valor
	where cd_objeto = prm_objeto;

end update_file;

procedure clone_screen (prm_screen varchar2) as

	ws_usuario 		varchar2(80);
	ws_data			date;
	ws_new_screen   varchar2(100);
	ws_cd_filtro    number; 

	procedure object_location_insert (prm_screen varchar2, prm_screen_new varchar2 ) as
		ws_new_obj varchar2(100);
	begin 
		for a in (select * from object_location where screen = prm_screen ) loop 
			if    a.object_id like 'SECTION_%' then  	ws_new_obj := fun.objCode2 ('SECTION_'); 
			elsif a.object_id like 'ARTICLE_%' then  	ws_new_obj := fun.objCode2 ('ARTICLE_'); 
			else                 						ws_new_obj := a.object_id; 
			end if; 
			--
			insert into object_location (owner,   navegador,   screen,         object_id,  posx,   posy,   zindex,   porcentagem) 
			                     values (a.owner, a.navegador, prm_screen_new, ws_new_obj, a.posx, a.posy, a.zindex, a.porcentagem); 
		    --
			if a.object_id like 'SECTION_%' or a.object_id like 'ARTICLE_%' then
				object_location_insert (a.object_id, ws_new_obj); 
			end if; 
		end loop; 						 
	end object_location_insert;  
	--
begin
	--
	ws_usuario    := gbl.getUsuario;
	ws_data       := sysdate;
	ws_new_screen := fun.objCode ('SRC_'); 
	--
	insert into OBJETOS (cd_objeto,     cd_grupo, nm_objeto,                            tp_objeto, cd_usuario, atributos, dt_ultima, ds_objeto, subtitulo) 
	            (select  ws_new_screen, cd_grupo, '(C'||CHR(50067)||'PIA) '||nm_objeto, tp_objeto, cd_usuario, atributos, ws_data,   ds_objeto, subtitulo
				   from OBJETOS t1
	               left join all_screens t2 on t2.screen = t1.cd_objeto
	              where cd_objeto = prm_screen ); 
	-- 
	insert into all_screens (owner, screen,        descricao,                            ds_screen, dt_criacao, publico, cor_fundo, url_fundo, or_grupo, or_item, timer, flex_flow, dispositivo)
	                ( select owner, ws_new_screen, '(C'||CHR(50067)||'PIA) '||descricao, ds_screen, ws_data,    publico, cor_fundo, url_fundo, or_grupo, or_item, timer, flex_flow, dispositivo
					    from all_screens 
					   where screen = prm_screen );
	--
	object_location_insert(prm_screen, ws_new_screen );
	--
	for a in (select * from filtros where cd_objeto = prm_screen and tp_filtro = 'objeto' ) loop 
		select nvl(max(cd_filtro),0)+1 into ws_cd_filtro from filtros;
		insert into filtros (cd_usuario,   cd_objeto,     micro_visao,   cd_coluna,   condicao,   conteudo,   ligacao,   st_agrupado,   cd_filtro,    tp_filtro,   cd_criado )
	    	         values (a.cd_usuario, ws_new_screen, a.micro_visao, a.cd_coluna, a.condicao, a.conteudo, a.ligacao, a.st_agrupado, ws_cd_filtro, a.tp_filtro, a.cd_criado ); 
	end loop; 					
	--
	insert into float_filter_item (cd_usuario, screen,        cd_coluna, conteudo) 
				   		   (select cd_usuario, ws_new_screen, cd_coluna, conteudo 
				      		  from float_filter_item 
				    	     where screen = prm_screen) ; 
	-- 				
	commit; 
	--
	htp.p('OK|Nova tela criado com sucesso|'||ws_new_screen);
	--
exception	when others then
	rollback;
	htp.p('ERRO|Erro criando nova tela, verifique o log de erros do sistema|');
	insert into bi_log_sistema values(sysdate, 'clone_screen: '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, ws_usuario, 'ERRO');
	commit;
end clone_screen;



procedure clone_object_navegador (prm_objeto varchar2) as
	ws_codigo    varchar2(100) := null; 
	ws_msg       varchar2(500) := null;	
	ws_tipo      varchar2(100) := null;
begin
	fcl.clone_object (prm_objeto, ws_codigo, ws_msg); 
	if ws_codigo is not null then 
		select max(tp_objeto) into ws_tipo from objetos where cd_objeto = prm_objeto; 
		htp.p('OK|Objeto duplicado com sucesso|'||ws_codigo||'|'||ws_tipo);
	else 
		htp.p('ERRO|Erro duplicando objeto, verifique o log de erros do sistema||');
	end if; 	
end clone_object_navegador; 



procedure clone_object (prm_objeto 	       varchar2, 
                        prm_codigo  in out varchar2,
						prm_msg     in out varchar2 ) as
	ws_usuario 		varchar2(80);
	ws_codigo 		varchar2(80);
	ws_grupo 		varchar2(14);
	ws_tipo         varchar2(200);
	ws_data			date;
	ws_key			number:=0;
begin

	ws_usuario := gbl.getUsuario;
	ws_data    := sysdate;
	ws_codigo  := fun.objCode ('OBJ_'); 
	
	------ CLONE FILTROS ------			
	insert into OBJETOS (cd_objeto, cd_grupo, nm_objeto,            tp_objeto, cd_usuario, atributos, dt_ultima, ds_objeto, subtitulo, id_customizado, id_liberado)  
	             (select ws_codigo, cd_grupo, '(C'||CHR(50067)||'PIA) '||nm_objeto, tp_objeto, ws_usuario, atributos, ws_data,   ds_objeto, subtitulo, id_customizado, id_liberado from objetos where cd_objeto = prm_objeto) ;
		
	------ CLONE ATRIBUTO ------
	insert into object_attrib (owner,navegador,screen,cd_object,cd_prop,propriedade)   
	                   (select owner,navegador,screen,ws_codigo,cd_prop,propriedade from object_attrib o where cd_object = prm_objeto );

	------ CLONE DRILL (goto_objeto) ------
	insert into goto_objeto (cd_usuario,cd_objeto,cd_objeto_go,ordem) 
	                 (select cd_usuario,ws_codigo,cd_objeto_go,ordem from goto_objeto where cd_objeto = prm_objeto);

	------ CLONE PONTO_AVALIACAO ------
	insert into ponto_avaliacao (cd_ponto, nm_ponto,ds_ponto,ar_diario,ar_mensal,ar_anual,cd_visao,tp_renovacao,cd_usuario,dt_ultima,dt_criacao,cd_micro_visao,parametros,st_filtros,cs_parametros,cs_coluna,cs_agrupador,cs_rp,cs_colup)
	                     (select ws_codigo,nm_ponto,ds_ponto,ar_diario,ar_mensal,ar_anual,cd_visao,tp_renovacao,cd_usuario,ws_data,  ws_data,   cd_micro_visao,parametros,st_filtros,cs_parametros,cs_coluna,cs_agrupador,cs_rp,cs_colup from ponto_avaliacao where cd_ponto = prm_objeto);		

	------ CLONE OBJECT_RESTRICTION ------
	insert into object_restriction (usuario, cd_objeto, st_restricao, dt_last) 
	                        (select usuario,ws_codigo,st_restricao,ws_data from object_restriction where cd_objeto = prm_objeto);

	------ CLONE CALL_LIST ------ MENU
	insert into call_list (cd_list,cd_objeto,posx,posy,ordem)	
				   (select cd_list,ws_codigo,posx,posy,ordem from call_list where cd_list = prm_objeto);

	------ CLONE TRADUCAO_COLUNAS ------ Traduções de textosd do objeto 
	insert into traducao_colunas (cd_tabela, cd_coluna, cd_linguagem, texto, lang_default, tipo, fixa)
						  (select ws_codigo, cd_coluna, cd_linguagem, texto, lang_default, tipo, fixa from traducao_colunas where cd_tabela = prm_objeto);

	------ CLONE FILTROS ------		
	for i in (select * from filtros where cd_objeto = prm_objeto) loop
		select nvl(max(cd_filtro),0)+1 into ws_key from filtros;
		insert into filtros (cd_usuario,  cd_objeto, micro_visao,  cd_coluna,  condicao,  conteudo,  ligacao,  st_agrupado,  cd_filtro, tp_filtro,   cd_criado) 
		             values (i.cd_usuario,ws_codigo, i.micro_visao,i.cd_coluna,i.condicao,i.conteudo,i.ligacao,i.st_agrupado,ws_key,    i.tp_filtro, i.cd_criado);
	end loop;
	commit; 	

	------ CLONE DESTAQUE ------	
	for i in (select * from destaque where cd_objeto = prm_objeto) loop
		select nvl(max(cd_destaque),0)+1 into ws_key from destaque;
		insert into destaque (cd_usuario,  cd_objeto,cd_coluna,  condicao,  conteudo,  cor_fundo,  cor_fonte,  tipo_destaque,  prioridade,  cd_destaque) 
		              values (i.cd_usuario,ws_codigo,i.cd_coluna,i.condicao,i.conteudo,i.cor_fundo,i.cor_fonte,i.tipo_destaque,i.prioridade,ws_key);
	end loop;
	commit;

	insert into bi_log_sistema (dt_log, ds_log, nm_usuario, nm_procedure) values(sysdate,'CLONE_OBJECT - Objeto clonado '||prm_objeto||'=>'||ws_codigo, ws_usuario, 'EVENTO');
	commit;

	prm_codigo := ws_codigo;

exception when others then
	rollback;
	prm_codigo := null;
	insert into bi_log_sistema (dt_log, ds_log, nm_usuario, nm_procedure) values(sysdate, 'CLONE_OBJECT: '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, ws_usuario, 'ERRO');
	commit;

end clone_object;


procedure quick_create ( prm_nome       varchar2 default null,
						prm_tipo       varchar2 default null,
						prm_parametros varchar2 default null,
						prm_visao      varchar2 default null,
						prm_coluna     varchar2 default null,
						prm_grupo      varchar2 default null,
						prm_obj_ant    varchar2 default null,
						prm_filtro     varchar2 default null,
						prm_screen     varchar2 default null,
						prm_ordem_vlr  varchar2 default null  ) as

	ws_codigo          varchar2(40);
	ws_parametro       varchar2(2000);
	ws_valor           varchar2(2000);
	ws_filtro_coluna   varchar2(80);
	ws_filtro_conteudo varchar2(80);
	ws_usuario         varchar2(80);
	ws_grupo		   varchar2(80);
	ws_nome			   varchar2(200);
	ws_count           number;
	ws_exception       exception;
	ws_key             number := 0;
	ws_inc             number := 0;
	ws_amostra_custo   varchar2(10); 
	ws_subtitulo       varchar2(200); 
	ws_id_customizado  varchar2(1); 
	ws_id_liberado     varchar2(1); 
	ws_cd_micro_visao  varchar2(200);

	ws_exist 		   exception;
	

begin
	/*fcl.refresh_Session;*/

	ws_usuario       := gbl.getUsuario;
	ws_grupo 		 :='';
	ws_nome  		 := prm_nome; 
	ws_subtitulo     := ''; 
	ws_amostra_custo := '30'; 

	Select trim((Select Sid From V$session Where Audsid = Sys_Context('userenv','sessionid'))||
	(Select Serial# From V$session Where Audsid = Sys_Context('userenv','sessionid'))||to_char(sysdate,'yymmddhhmiss')) into ws_codigo From Dual;

	if prm_screen = 'SCR_CUSTOMIZACAO' then 
		ws_codigo := 'COBJ_'||ws_codigo; 	
		--ws_codigo := prm_nome;
		ws_nome   := 'NOVA CONSULTA'; 
		if ws_amostra_custo is not null then  
			ws_nome := ws_nome ||' (Amostragem de '||ws_amostra_custo||' registros)'; 
		end if; 	
		ws_id_customizado  := 'S'; 
		ws_id_liberado     := 'N'; 
	else    
		ws_codigo := 'OBJ_'||ws_codigo; 		
		ws_id_customizado  := 'N'; 
		ws_id_liberado     := null; 
	end if;

	select count(*) into ws_count from objetos where cd_objeto = ws_codigo;
	if nvl(prm_screen,'DEFAULT') not in ('DEFAULT', 'SCR_CUSTOMIZACAO') then
		select cd_grupo into ws_grupo from objetos where cd_objeto = prm_screen;
	end if;	

	if ws_count = 0 then
		
		if prm_tipo = 'OBJETO' then

			insert into OBJETOS (cd_objeto, cd_grupo, nm_objeto, subtitulo, tp_objeto, cd_usuario, atributos, dt_ultima, ds_objeto, id_customizado, id_liberado) 
				values (ws_codigo, ws_grupo, ws_nome, ws_subtitulo, 'OBJETO', ws_usuario, '', sysdate, '', ws_id_customizado, ws_id_liberado); 
			--
			-- Cria o ponto de avalização do objeto com a mesma micro visão de tela, se foi parametrizado micro visão para a tela 
			ws_cd_micro_visao := null;
			select max(cd_micro_visao) into ws_cd_micro_visao 
			from ponto_avaliacao
			where cd_ponto = prm_screen;
			--
			if ws_cd_micro_visao is not null then 
				insert into PONTO_AVALIACAO (cd_ponto,nm_ponto,ar_diario,ar_mensal,ar_anual,cd_visao,tp_renovacao,cd_usuario,dt_ultima,dt_criacao,cd_micro_visao,st_filtros)
									values	(ws_codigo, trim(ws_nome), 'N', 'N', 'N', 'T', 'O', 'DWU', sysdate, sysdate, ws_cd_micro_visao, 'A');
			end if; 
			--
			htp.p(ws_codigo);

		else
		
			ws_parametro := substr(prm_parametros, 1, instr(prm_parametros, '@')-1);
			ws_valor := replace(prm_parametros, ws_parametro||'@', '');

			ws_valor := replace(ws_valor, '1|1', '');

			ws_nome := fun.converte(prm_nome);

			if nvl(gbl.getNivel, 'N') <> 'A' then
				ws_codigo := replace(ws_usuario, '.', '_')||'_temp';
				ws_nome := fun.check_rotuloc(ws_parametro, prm_visao)||'/'||fun.check_rotuloc(prm_coluna, prm_visao);
			end if;

			if prm_tipo = 'PONTEIRO' or prm_tipo = 'VALOR' then
				insert into PONTO_AVALIACAO values
				(ws_codigo, trim(ws_nome), '', 'N', 'N', 'N', 'T', 'O', 'DWU', sysdate, sysdate, prm_visao, ws_parametro||'|', 'A', '', '', '', '', '', '' );
			else 
				insert into PONTO_AVALIACAO values
				(ws_codigo, trim(ws_nome), '', 'N', 'N', 'N', 'T', 'O', 'DWU', sysdate, sysdate, prm_visao, '', 'A', '', '1|1', prm_coluna, ws_parametro, '', '' );
			end if;

			-- Insere no FILTRO os parametros
			for arrow in(select cd_coluna, cd_conteudo, cd_condicao from table(fun.vpipe_par(ws_valor))) loop
			
					select nvl2(max(cd_filtro), max(cd_filtro), 0)+1 into ws_key from filtros;

					loop
						ws_inc := ws_inc+1;
						select count(*) into ws_count from filtros where cd_filtro = ws_key;
						if ws_count > 0 then
							select ws_key+ws_inc into ws_key from filtros;
						else
							exit;
						end if;
					end loop;
			
					insert into filtros (cd_usuario, cd_objeto, micro_visao, cd_coluna, condicao, conteudo, ligacao, st_agrupado, cd_filtro, tp_filtro, cd_criado)
								values ('DWU', ws_codigo, prm_visao, arrow.cd_coluna, arrow.cd_condicao, REPLACE(REPLACE(arrow.cd_conteudo, '#@PIPE@#', '|'), '@PIPE@', '|') , 'and', 'N', ws_key, 'objeto', ws_usuario);
					commit;
			end loop;
			
			-- Insere no FILTRO o filtro passado por parametro
			for i in(select cd_coluna, cd_conteudo, cd_condicao from table(fun.vpipe_par(prm_filtro))) loop
			
					select nvl2(max(cd_filtro), max(cd_filtro), 0)+1 into ws_key from filtros;

					loop
					
						ws_inc := ws_inc+1;
					
						select count(*) into ws_count from filtros where cd_filtro = ws_key;
					
						if ws_count > 0 then
							select ws_key+ws_inc into ws_key from filtros;
						else
							exit;
						end if;
					end loop;
			
					insert into filtros (cd_usuario, cd_objeto, micro_visao, cd_coluna, condicao, conteudo, ligacao, st_agrupado, cd_filtro, tp_filtro, cd_criado)
                    values('DWU', ws_codigo, prm_visao, i.cd_coluna, i.cd_condicao, i.cd_conteudo, 'and', 'N', ws_key, 'objeto', ws_usuario);
					commit;
			end loop;

			begin
				insert into OBJETOS (cd_objeto, cd_grupo, nm_objeto, subtitulo, tp_objeto, cd_usuario, atributos, dt_ultima, ds_objeto) 
							values (ws_codigo, prm_grupo, ws_nome, '', prm_tipo, ws_usuario, '', sysdate, '');
			exception when others then
				raise ws_exist;
			end;

			insert into OBJECT_ATTRIB select 'DWU','DEFAULT','DEFAULT', ws_codigo, cd_prop, vl_default from OBJECT_PADRAO where tp_objeto = prm_tipo;

			if prm_tipo = 'TEXTO' then
				update OBJETOS set atributos = 'TEXTO' where cd_objeto = ws_codigo and nm_objeto = 'TEXTO' and tp_objeto = 'TEXTO';
			end if;

			-- Insere ordem do gráfico se a coluna de valor selecionada na consulta estiver ordenada 
			if prm_tipo in ('LINHAS','COLUNAS','BARRAS','SANKEY','SCATTER','RADAR', 'CALENDARIO') and prm_ordem_vlr is not null then 
				insert into OBJECT_ATTRIB (owner,      navegador, screen,     cd_object, cd_prop, propriedade) 
								values (ws_usuario, 'DEFAULT', prm_screen, ws_codigo, 'ORDEM', 'r_'||ws_parametro||' '||prm_ordem_vlr);
			end if; 

			insert into traducao_colunas values(ws_codigo, 'NM_OBJETO', fun.ret_var('LANG_SYS'), ws_nome, ws_nome, 'O', 'N');
			
			ws_key := 0;
			ws_inc := 0;
			
			-- Insere FILTRO com os filtros do objeto anterior
			for i in (select cd_usuario, cd_objeto, micro_visao, cd_coluna, condicao, conteudo, ligacao, st_agrupado from filtros where cd_objeto = fun.get_cd_obj(prm_obj_ant) and tp_filtro = 'objeto') loop
				
				select nvl2(max(cd_filtro), max(cd_filtro), 0)+1 into ws_key from filtros;

				loop
				
					ws_inc := ws_inc+1;
				
					select count(*) into ws_count from filtros where cd_filtro = ws_key;
				
					if ws_count > 0 then
						select ws_key+ws_inc into ws_key from filtros;
					else
						exit;
					end if;
				end loop;
				
				insert into filtros (cd_usuario, cd_objeto, micro_visao, cd_coluna, condicao, conteudo, ligacao, st_agrupado, cd_filtro, tp_filtro, cd_criado)
                values(i.cd_usuario, ws_codigo, i.micro_visao, i.cd_coluna, i.condicao, i.conteudo, i.ligacao, i.st_agrupado, ws_key, 'objeto', ws_usuario);
				commit;
			end loop;
			
			ws_key := 0;
			ws_inc := 0;
			
			for z in (select cd_coluna, cd_conteudo, cd_condicao from table(fun.vpipe_par((prm_filtro))) where nvl(trim(cd_condicao), 'N/A') <> 'N/A') loop
				
				select nvl2(max(cd_filtro), max(cd_filtro), 0)+1 into ws_key from filtros;

				loop
				
					ws_inc := ws_inc+1;
				
					select count(*) into ws_count from filtros where cd_filtro = ws_key;
				
					if ws_count > 0 then
						select ws_key+ws_inc into ws_key from filtros;
					else
						exit;
					end if;
				end loop;
				
				insert into filtros (cd_usuario, cd_objeto, micro_visao, cd_coluna, condicao, conteudo, ligacao, st_agrupado, cd_filtro, tp_filtro, cd_criado)
                values('DWU', ws_codigo, prm_visao, z.cd_coluna, z.cd_condicao, z.cd_conteudo, 'and', 'N', ws_key, 'objeto', ws_usuario);
				commit;
			end loop;
			htp.p(ws_codigo);
			commit;
		end if;

		if prm_screen = 'SCR_CUSTOMIZACAO' and ws_amostra_custo is not null then 
			insert into OBJECT_ATTRIB (OWNER, navegador, screen, cd_object, cd_prop, propriedade) 
							values ( 'DWU','DEFAULT','DEFAULT', ws_codigo, 'AMOSTRA', ws_amostra_custo); 
		end if; 

	else
		if prm_screen = 'SCR_CUSTOMIZACAO' then 
			htp.p(ws_codigo);
		else 
			htp.p('NONE');
		end if;	
	end if;

exception 
	when ws_exist then
		htp.p('duplicado');
	when others then
		htp.p(sqlerrm);
end quick_create;

procedure change_bar ( prm_obj       varchar2 default null,
					prm_agrupador varchar2 default null,
					prm_tipo      varchar2 default 'objeto' ) as

	ws_agrupador varchar2(2000);

begin
	/*fcl.refresh_Session;*/
	ws_agrupador := substr(prm_agrupador, 0, length(prm_agrupador)-1);
	if length(ws_agrupador) > 1 then
		if prm_tipo = 'objeto' then
			update ponto_avaliacao
			set cs_agrupador = ws_agrupador
			where cd_ponto = prm_obj;
		else
			update ponto_avaliacao
			set parametros = prm_agrupador
			where cd_ponto = prm_obj;
		end if;
	else
		htp.p('#alert '||fun.lang('Ao menos uma coluna deve ser escolhida')||'!');
	end if;

exception when others then
	htp.p('#alert '||fun.lang('Erro ao alterar os dados')||'!');
end change_bar;

procedure countdown ( prm_screen varchar2 default null ) as

ws_screen number;

begin
	select timer into ws_screen from all_screens where screen = prm_screen;
	htp.p(trim(ws_screen));

end countdown;

/*
procedure background_attrib ( prm_screen varchar2 default null ) as

	ws_valores varchar2(800);
	ws_fundo   varchar2(200);
	ws_background varchar2(800);
begin

	select fun.subpar(url_fundo, prm_screen) into ws_fundo from all_screens where screen = prm_screen;

	select cor_fundo into ws_background from all_screens where screen = prm_screen;

	if instr(nvl(ws_background, 'transparent'), '|') > 0 then
		ws_background := 'background: linear-gradient('||replace(nvl(ws_background, 'transparent'), '|', ',')||')';
	else
		ws_background := 'background-color: '||nvl(ws_background, 'transparent');
	end if;
	
	if instr(ws_fundo, 'EXT') > 0 then
		ws_valores := ws_fundo;
	else
		select ws_background||'; | background-repeat: '||nvl(fun.getprop(prm_screen,'REPEAT'), 'no-repeat')||'; background-position: '||nvl(fun.getprop(prm_screen,'IMG_POS'), 'center')||'; background-size: '||nvl(fun.getprop(prm_screen,'IMG_SIZE'), 'auto')||'; background-image: url('||fun.subpar(url_fundo, prm_screen)||'); opacity: '||nvl(fun.getprop(prm_screen,'OPACIDADE')/100, '1')||'; '
		into ws_valores from all_screens where screen = prm_screen;
	end if;
	
	htp.p(trim(ws_valores));

end background_attrib;
*/ 


procedure background_attrib_monta ( prm_screen  in     varchar2 default null,
									prm_valores in out varchar2  ) as  
	ws_valores varchar2(1000);
	ws_fundo   varchar2(1000);
	ws_background varchar2(1000);
begin

	select fun.subpar(url_fundo, prm_screen) into ws_fundo from all_screens where screen = prm_screen;

	select cor_fundo into ws_background from all_screens where screen = prm_screen;

	if instr(nvl(ws_background, 'transparent'), '|') > 0 then
		ws_background := 'background: linear-gradient('||replace(nvl(ws_background, 'transparent'), '|', ',')||')';
	else
		ws_background := 'background-color: '||nvl(ws_background, 'transparent');
	end if;
	
	if instr(ws_fundo, 'EXT') > 0 then
		ws_valores := ws_fundo;
	else
		select ws_background||'; | background-repeat: '||nvl(fun.getprop(prm_screen,'REPEAT'), 'no-repeat')||' !important; background-position: '||nvl(fun.getprop(prm_screen,'IMG_POS'), 'center')||'; background-size: '||nvl(fun.getprop(prm_screen,'IMG_SIZE'), 'auto')||' !important; background-image: url('||fun.subpar(url_fundo, prm_screen)||'); opacity: '||nvl(fun.getprop(prm_screen,'OPACIDADE')/100, '1')||'; '
		into ws_valores from all_screens where screen = prm_screen;
	end if;
	
prm_valores := nvl(ws_valores,'');

end background_attrib_monta;



procedure background_attrib ( prm_screen varchar2 default null ) as
	ws_valores varchar2(2000);
begin

	background_attrib_monta ( prm_screen, ws_valores ) ;
	htp.p(trim(nvl(ws_valores,' ')) );

end background_attrib;



procedure update_language ( prm_valor       varchar2 default null,
							prm_tabela      varchar2 default null,
							prm_coluna      varchar2 default null,
							prm_linguagem   varchar2 default null,
							prm_default     varchar2 default null,
							prm_tipo        varchar2 default null ) as

	ws_count         number;
	ws_default       varchar2(4000);
	ws_erro          exception;

begin

	/*fcl.refresh_Session;*/
	ws_default := prm_default;

	begin
		select count(*) into ws_count
		from   TRADUCAO_COLUNAS
		where  cd_tabela    = prm_tabela and
				cd_coluna    = prm_coluna and
				cd_linguagem = prm_linguagem and
				tipo         = prm_tipo and
				lang_default = ws_default;

		if  ws_count = 1 then
			update TRADUCAO_COLUNAS set texto = prm_valor
			where  cd_tabela    = upper(prm_tabela) and
					cd_coluna    = upper(prm_coluna) and
					cd_linguagem = prm_linguagem  and
					tipo         = prm_tipo and
					lang_default = ws_default;
		else
			if  ws_count = 0 then
				insert into TRADUCAO_COLUNAS values (upper(prm_tabela), upper(prm_coluna), prm_linguagem, prm_valor, ws_default, prm_tipo, 'N');
			else
				raise ws_erro;
			end if;
		end if;

		if  prm_linguagem = fun.ret_var('LANG_SYS') then
			ws_default := prm_valor;
			update TRADUCAO_COLUNAS set lang_default = prm_valor
			where  cd_tabela    = prm_tabela and
				cd_coluna    = prm_coluna and
				tipo         = prm_tipo and
				lang_default = prm_default;
			if prm_tipo = 'T' then
				update micro_visao set ds_micro_visao = prm_valor
				where  ds_micro_visao = ws_default;
			end if;
			if prm_tipo = 'O' then
				if prm_coluna = 'ATRIBUTOS' then
					update objetos set atributos = prm_valor
					where  cd_objeto = prm_tabela;
				elsif prm_coluna = 'SUBTITULO' then
					update objetos set subtitulo = prm_valor
					where  cd_objeto = prm_tabela;
				else
					update objetos set nm_objeto = prm_valor
					where  cd_objeto = prm_tabela;
					update ponto_avaliacao set nm_ponto = prm_valor
					where  cd_ponto = prm_tabela;
				end if;
			end if;
			if prm_tabela = 'PARAMETRO_PADRAO' then
				update PARAMETRO_PADRAO set nm_padrao = prm_valor
				where nm_padrao = prm_default;
			end if;
			if prm_tabela = 'GRUPOS_FUNCAO' then
				update GRUPOS_FUNCAO set nm_grupo = prm_valor
				where nm_grupo = prm_default;
			end if;
			if prm_tabela = 'GUSERS' and prm_coluna = 'NM_GROUP' then
				update GUSERS set nm_group = prm_valor
				where nm_group = prm_default;
			end if;
			if prm_tabela = 'NOTIFY_ME' and prm_coluna = 'DS_NOTIFY' then
				update NOTIFY_ME set ds_notify = prm_valor
				where ds_notify = prm_default;
			end if;
			if prm_tabela = 'ALL_SCREENS' and prm_coluna = 'DESCRICAO' then
				update ALL_SCREENS set descricao = prm_valor
				where descricao = prm_default;
			end if;
		end if;

		commit;
	exception
		when others then
			rollback;
			htp.p('!alert '||fun.lang('Erro ao alterar/incluir tradu&ccedil;&atilde;o')||'!');
	end;

end update_language;

procedure screen_list ( prm_objeto varchar2 default 'N/A' ) as

	ws_count	  number		:= 0;
	ws_count1	  number		:= 0;
	ws_count2	  number		:= 0;
	ws_cgrupo	  number		:= 0;
	ws_citem	  number		:= 1;
	ws_grupo_ant  varchar2(40)	:= 'FIRST_TIME';

	cursor crs_itens(prm_usuario varchar2) is
		select	cd_objeto, objetos.cd_grupo, nm_grupo, nm_objeto, nvl(cor_fundo,'#FFFFFF') cor_fundo, url_fundo, dispositivo
		from	OBJETOS, all_screens, GRUPOS_FUNCAO
		where	tp_objeto='SCREEN'  and
			all_screens.publico='S' and
				cd_objeto=screen(+) and 
				objetos.cd_grupo=grupos_funcao.cd_grupo and
				screen in (select screen from user_screens where usuario = prm_usuario and status='A')
		order by GRUPOS_FUNCAO.ordem, or_grupo, cd_grupo, to_number(or_item), nm_objeto;

	ws_itens	crs_itens%rowtype;
	ws_usuario  varchar2(80);
	ws_admin    varchar2(80);
	ws_padrao   varchar2(80) := 'PORTUGUESE';
begin

	ws_usuario := gbl.getUsuario;
	ws_admin   := gbl.getNivel;

	begin
		select CONTEUDO into ws_padrao
		from   PARAMETRO_USUARIO
		where  cd_usuario = ws_usuario and
			cd_padrao='CD_LINGUAGEM';
	exception
		when others then
			ws_padrao := 'PORTUGUESE';
	end;

	/*fcl.refresh_Session;*/
	htp.p('<option value="X" style="font-weight: bold; color: #000;" selected>MENU</option>');
	open crs_itens(ws_usuario);
		loop
			fetch crs_itens into ws_itens;
			exit when crs_itens%notfound;

			if ((instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'iPhone') > 0 or instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'Android') > 0) and nvl(ws_itens.dispositivo, '0') <> 'desktop' and nvl(ws_itens.dispositivo, '0') <> 'nenhum') or ((instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'iPhone') = 0 and instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'Android') = 0) and nvl(ws_itens.dispositivo, '0') <> 'mobile' and nvl(ws_itens.dispositivo, '0') <> 'nenhum') or ws_admin = 'A' then

				if (ws_grupo_ant <> ws_itens.cd_grupo or ws_grupo_ant='FIRST_TIME') then
					ws_cgrupo := ws_cgrupo + 1;
				ws_citem  := 1;
				htp.p('<optgroup label="'||ws_cgrupo||'-'||fun.utranslate('nm_grupo', ws_itens.cd_grupo, ws_itens.nm_grupo, ws_padrao)||'"></optgroup>');
				end if;

				select (select count(*) from object_location where screen = ws_itens.cd_objeto and object_id = upper(prm_objeto)) as ws_count1, (select count(*) from call_list where cd_objeto = upper(prm_objeto) and cd_list in (select object_id from object_location where screen = ws_itens.cd_objeto)) as ws_count2 into ws_count1, ws_count2 from dual;
				ws_count := ws_count1+ws_count2;
				if ws_count > 0 then
					htp.p('<option class="green" data-bg="'||ws_itens.cor_fundo||'" data-url="'||ws_itens.url_fundo||'" data-size="'||fun.getprop(ws_itens.cd_objeto,'IMG_SIZE')||'" data-pos="'||fun.getprop(ws_itens.cd_objeto,'IMG_POS')||'" data-repeat="'||fun.getprop(ws_itens.cd_objeto,'REPEAT')||'" onclick="this.className=''''; " value="'||ws_itens.cd_objeto||'">    '||ws_cgrupo||'.'||to_char(ws_citem,'00')||'-'||fun.utranslate('NM_OBJETO', ws_itens.cd_objeto, ws_itens.nm_objeto, ws_padrao)||'</option>');
				else
					htp.p('<option data-bg="'||ws_itens.cor_fundo||'" data-url="'||ws_itens.url_fundo||'" data-size="'||fun.getprop(ws_itens.cd_objeto,'IMG_SIZE')||'" data-pos="'||fun.getprop(ws_itens.cd_objeto,'IMG_POS')||'" data-repeat="'||fun.getprop(ws_itens.cd_objeto,'REPEAT')||'" value="'||ws_itens.cd_objeto||'">    '||ws_cgrupo||'.'||to_char(ws_citem,'00')||'-'||fun.utranslate('NM_OBJETO', ws_itens.cd_objeto, ws_itens.nm_objeto, ws_padrao)||'</option>');
				end if;

			end if;

			ws_grupo_ant := ws_itens.cd_grupo;
			ws_citem := ws_citem + 1;
		end loop;
	close crs_itens;

	if ws_admin = 'A' and owa_util.get_cgi_env('HTTP_USER_AGENT') not like '%Trident%' then
		htp.p('<option value="SANDBOX" style="font-weight: bold; color: #065182; display: none;" data-bg="#efefdf">SANDBOX</option>');
	end if;

end screen_list;


procedure linguagem_padrao ( prm_update char default 'N',
							prm_tabela varchar2 default null,
							prm_coluna varchar2 default null,
							prm_linguagem varchar2 default null,
							prm_default varchar2 default null,
							prm_fixa char default null ) as

	cursor crs_padroes is
	select cd_tabela, cd_coluna, cd_linguagem, texto, lang_default, tipo, fixa
	from traducao_colunas
	where cd_linguagem = fun.ret_var('LANG_SYS')
	order by tipo, cd_tabela, cd_coluna, texto;

	ws_lang    varchar2(60);
	ws_padrao  crs_padroes%rowtype;
	ws_tipo    varchar2(30) := '999999999';
	ws_count   number;
	ws_usuario varchar2(80);

begin
	ws_usuario := gbl.getUsuario;
	/*fcl.refresh_Session;*/
	select count(*) into ws_count from PARAMETRO_USUARIO where cd_usuario = ws_usuario and cd_padrao='CD_LINGUAGEM';

	if ws_count = 1 then
		select CONTEUDO into ws_lang
		from   PARAMETRO_USUARIO
		where  cd_usuario = ws_usuario and
		cd_padrao='CD_LINGUAGEM';
	else
		ws_lang := 'PORTUGUESE';
	end if;

	if prm_update = 'N' then
		htp.p('<table class="linha" style="min-width: 600px; margin: 0 auto;">');
		htp.p('<thead>');
		htp.p('<tr>');
			htp.p('<th style="width: 55%;">DEFAULT</th>');
			htp.p('<th style="width: 10%;">'||fun.lang('TIPO')||'</th>');
			htp.p('<th style="width: 35%;"></th>');
		htp.p('</tr>');
		htp.p('</thead>');
		htp.p('<tbody>');
		open crs_padroes;
			loop
				fetch crs_padroes into ws_padrao;
				exit when crs_padroes%notfound;
				if ws_padrao.tipo = 'C' then
					ws_tipo := fun.lang('Coluna');
				elsif ws_padrao.tipo = 'O' then
					ws_tipo := fun.lang('Objeto');
				elsif ws_padrao.tipo = 'T' then
					ws_tipo := fun.lang('Tabela');
				else
					ws_tipo := '';
				end if;

				htp.p('<tr style="margin: 5px 0; line-height: 30px;">');
					htp.p('<td style="width: 55%; white-space: nowrap;">'||ws_padrao.lang_default||'</td>');
					htp.p('<td style="width: 10%">'||ws_tipo||'</td>');
					htp.p('<td style="width: 35%;">');
						htp.p('<input type="text" value="'||fun.utranslate(ws_padrao.cd_coluna, ws_padrao.cd_tabela, ws_padrao.lang_default, ws_lang)||'"/>');
						htp.p('<a title="'||fun.lang('Alterar')||'" style="line-height: 14px; height: 18px; width: 14px; position: relative; display: inline-block; float: none;" class="save" onclick="checkFix(''input'', this, '''||ws_padrao.cd_tabela||''', '''||ws_padrao.cd_coluna||''', '''||ws_lang||''', '''||ws_padrao.lang_default||''', '''||ws_padrao.tipo||''');">v</a>');
						if ws_padrao.fixa = 'S' then
							htp.p('<input title="'||fun.lang('Fixar')||'" onchange="checkFix(''check'', this, '''||ws_padrao.cd_tabela||''', '''||ws_padrao.cd_coluna||''', '''||ws_lang||''', '''||ws_padrao.lang_default||''', '''||ws_padrao.tipo||''');" type="checkbox" checked/>');
						else
							htp.p('<input title="'||fun.lang('Fixar')||'" onchange="checkFix(''check'', this, '''||ws_padrao.cd_tabela||''', '''||ws_padrao.cd_coluna||''', '''||ws_lang||''', '''||ws_padrao.lang_default||''', '''||ws_padrao.tipo||''');" type="checkbox" />');
						end if;
					htp.p('</td>');
				htp.p('</tr>');
			end loop;
		close crs_padroes;
		htp.p('</tbody>');
		htp.p('</table>');
	else
		update TRADUCAO_COLUNAS set fixa = prm_fixa
		where  cd_tabela    = upper(prm_tabela) and
		cd_coluna    = upper(prm_coluna) and
		cd_linguagem = prm_linguagem  and
		lang_default = prm_default;
		htp.p('#alert '||fun.lang('Tradu&ccedil;&atilde;o fixada')||'!');
	end if;

end linguagem_padrao;

Procedure PASS_LANG As

		v_sql         varchar2(32767);
		v_cursor      number;
		ws_codigo     varchar2(4000);
		ws_texto      varchar2(4000);
		ws_stexto     varchar2(4000);
		ws_objeto     varchar2(4000);
		dummy         number;
		v_ret         number;
		ws_conversao     varchar2(4000);
		ws_traduzido     varchar2(4000);

Begin
	
	for ws_seq in (select CD_TABELA, CD_COLUNA, TIPO from TRADUCOES_PASSIVAS	order by TIPO ) loop 

		if  ws_seq.tipo in ('O') then
			v_sql := 'select cd_objeto, '||ws_seq.cd_coluna||' from OBJETOS where nvl(trim('||ws_seq.cd_coluna||'),'||CHR(39)||'%NOREG%'||CHR(39)||')<>'||chr(39)||'%NOREG%'||chr(39);
		end if;

		if  ws_seq.tipo in ('T','F') then
			v_sql := 'select 0 as dado, '||ws_seq.cd_coluna||' from '||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.'||ws_seq.cd_tabela||' where nvl(trim('||ws_seq.cd_coluna||'),'||CHR(39)||'%NOREG%'||CHR(39)||')<>'||chr(39)||'%NOREG%'||chr(39);
		end if;

		if  ws_seq.tipo in ('C') then
			v_sql := 'select cd_micro_visao as dado, '||ws_seq.cd_coluna||' from MICRO_COLUNA where nvl(trim('||ws_seq.cd_coluna||'),'||CHR(39)||'%NOREG%'||CHR(39)||')<>'||chr(39)||'%NOREG%'||chr(39);
		end if;

		v_cursor := dbms_sql.open_cursor;
		dbms_sql.parse(v_cursor, v_sql, dbms_sql.NATIVE);
		Dbms_Sql.Define_Column(V_Cursor,1,ws_codigo, 4000);
		Dbms_Sql.Define_Column(V_Cursor,2,ws_texto,  4000);

		dummy := dbms_sql.execute(v_cursor);
		loop
			V_Ret := Dbms_Sql.Fetch_Rows(V_Cursor);
			exit when v_ret = 0;
			Dbms_Sql.Column_Value(V_Cursor,1,ws_codigo);
			Dbms_Sql.Column_Value(V_Cursor,2,ws_texto);

             ws_conversao := replace(replace(replace(replace(ws_texto,CHR(50051),'A'),chr(50083),'a'),chr(50101),'o'),CHR(50069),'O');
             ws_conversao := replace(ws_conversao,'&aacute;'  ,'a');
             ws_conversao := replace(ws_conversao,'&atilde;'  ,'a');
             ws_conversao := replace(ws_conversao,'&acirc;'   ,'a');
             ws_conversao := replace(ws_conversao,'&agrave;'  ,'a');
             ws_conversao := replace(ws_conversao,'&eacute;'  ,'e');
             ws_conversao := replace(ws_conversao,'&ecirc;'   ,'e');
             ws_conversao := replace(ws_conversao,'&iacute;'  ,'i');
             ws_conversao := replace(ws_conversao,'&oacute;'  ,'o');
             ws_conversao := replace(ws_conversao,'&otilde;'  ,'o');
             ws_conversao := replace(ws_conversao,'&ocirc;'   ,'o');
             ws_conversao := replace(ws_conversao,'&uacute;'  ,'u');
             ws_conversao := replace(ws_conversao,'&ccedil;'  ,'c');
             ws_conversao := replace(ws_conversao,'&Aacute;'  ,'A');
             ws_conversao := replace(ws_conversao,'&Atilde;'  ,'A');
             ws_conversao := replace(ws_conversao,'&Acirc;'   ,'A');
             ws_conversao := replace(ws_conversao,'&Agrave;'  ,'A');
             ws_conversao := replace(ws_conversao,'&Eacute;'  ,'E');
             ws_conversao := replace(ws_conversao,'&Ecirc;'   ,'E');
             ws_conversao := replace(ws_conversao,'&Iacute;'  ,'I');
             ws_conversao := replace(ws_conversao,'&Oacute;'  ,'O');
             ws_conversao := replace(ws_conversao,'&Otilde;'  ,'O');
             ws_conversao := replace(ws_conversao,'&Ocirc;'   ,'O');
             ws_conversao := replace(ws_conversao,'&Uacute;'  ,'U');
             ws_conversao := replace(ws_conversao,'&Ccedil;'  ,'C');      
             ws_conversao := replace(ws_conversao,'\u00e1', 'a'); 
             ws_conversao := replace(ws_conversao,'\u00e0', 'a'); 
             ws_conversao := replace(ws_conversao,'\u00e2', 'a'); 
             ws_conversao := replace(ws_conversao,'\u00e3', 'a'); 
             ws_conversao := replace(ws_conversao,'\u00e4', 'a'); 
             ws_conversao := replace(ws_conversao,'\u00c1', 'A'); 
             ws_conversao := replace(ws_conversao,'\u00c0', 'A'); 
             ws_conversao := replace(ws_conversao,'\u00c2', 'A'); 
             ws_conversao := replace(ws_conversao,'\u00c3', 'A'); 
             ws_conversao := replace(ws_conversao,'\u00c4', 'A'); 
             ws_conversao := replace(ws_conversao,'\u00e9', 'e'); 
             ws_conversao := replace(ws_conversao,'\u00e8', 'e'); 
             ws_conversao := replace(ws_conversao,'\u00ea', 'e'); 
             ws_conversao := replace(ws_conversao,'\u00ea', 'e'); 
             ws_conversao := replace(ws_conversao,'\u00c9', 'E'); 
             ws_conversao := replace(ws_conversao,'\u00c8', 'E'); 
             ws_conversao := replace(ws_conversao,'\u00ca', 'E'); 
             ws_conversao := replace(ws_conversao,'\u00cb', 'E'); 
             ws_conversao := replace(ws_conversao,'\u00ed', 'i'); 
             ws_conversao := replace(ws_conversao,'\u00ec', 'i'); 
             ws_conversao := replace(ws_conversao,'\u00ee', 'i'); 
             ws_conversao := replace(ws_conversao,'\u00ef', 'i'); 
             ws_conversao := replace(ws_conversao,'\u00cd', 'I'); 
             ws_conversao := replace(ws_conversao,'\u00cc', 'I'); 
             ws_conversao := replace(ws_conversao,'\u00ce', 'I'); 
             ws_conversao := replace(ws_conversao,'\u00cf', 'I'); 
             ws_conversao := replace(ws_conversao,'\u00f3', 'o'); 
             ws_conversao := replace(ws_conversao,'\u00f2', 'o'); 
             ws_conversao := replace(ws_conversao,'\u00f4', 'o'); 
             ws_conversao := replace(ws_conversao,'\u00f5', 'o'); 
             ws_conversao := replace(ws_conversao,'\u00f6', 'o'); 
             ws_conversao := replace(ws_conversao,'\u00d3', 'O'); 
             ws_conversao := replace(ws_conversao,'\u00d2', 'O'); 
             ws_conversao := replace(ws_conversao,'\u00d4', 'O'); 
             ws_conversao := replace(ws_conversao,'\u00d5', 'O'); 
             ws_conversao := replace(ws_conversao,'\u00d6', 'O'); 
             ws_conversao := replace(ws_conversao,'\u00fa', 'u'); 
             ws_conversao := replace(ws_conversao,'\u00f9', 'u'); 
             ws_conversao := replace(ws_conversao,'\u00fb', 'u'); 
             ws_conversao := replace(ws_conversao,'\u00fc', 'u'); 
             ws_conversao := replace(ws_conversao,'\u00da', 'U'); 
             ws_conversao := replace(ws_conversao,'\u00d9', 'U'); 
             ws_conversao := replace(ws_conversao,'\u00db', 'U'); 
             ws_conversao := replace(ws_conversao,'\u00e7', 'c'); 
             ws_conversao := replace(ws_conversao,'\u00c7', 'C'); 
             ws_conversao := replace(ws_conversao,'\u00f1', 'nao'); 
             ws_conversao := replace(ws_conversao,'\u00d1', 'NAO'); 
             ws_conversao := replace(ws_conversao,'\u0026', '&'); 
			 --ws_conversao := replace(ws_conversao,chr(13) , '+'); 
             --ws_conversao := TRIM(CONVERT(ws_conversao, 'US7ASCII', 'WE8ISO8859P1'));

			--ws_stexto := trim(replace(TRIM(CONVERT(replace(replace(replace(replace(ws_texto,'&Atilde;','A'),'&aacute;','a'),'&oacute;','o'),'&Oacute;','O'), 'US7ASCII', 'WE8ISO8859P1')),' ','+'));

			if  ws_seq.TIPO in ('O','C') then
				ws_objeto := ws_codigo;
			else
				ws_objeto := ws_seq.CD_TABELA;
			end if;

			for a in (	select 'ENGLISH'  cd_linguagem, 'en' id_idioma from dual union all 
						select 'SPANISH'  cd_linguagem, 'es' id_idioma from dual union all 
						select 'ITALIAN'  cd_linguagem, 'it' id_idioma from dual union all 
						select 'GERMAN'   cd_linguagem, 'de' id_idioma from dual ) loop 
				
				-- Comentado para fazer a tradução depois, evitando muitas chamadas a fun.GET_TRANSLATOR
				--ws_traduzido := fun.GET_TRANSLATOR(ws_stexto,'pt', a.id_idioma);				
				ws_traduzido := null;

				update TRADUCAO_COLUNAS
				   set texto = nvl(ws_traduzido, texto) 
				 where cd_tabela    = ws_objeto 
			  	   and cd_coluna    = ws_seq.CD_COLUNA 
			  	   and lang_default = ws_texto         
			  	   and tipo         = ws_seq.TIPO
			  	   and cd_linguagem = a.cd_linguagem;

				if sql%notfound then 
					insert into TRADUCAO_COLUNAS values (ws_objeto,ws_seq.CD_COLUNA, a.cd_linguagem, ws_traduzido, ws_texto,ws_seq.TIPO, 'N');
				end if;    
			end loop; 				

			commit;

		end loop;
		dbms_sql.close_cursor(v_cursor);

	end loop;

END PASS_LANG;

procedure clearlog ( prm_programa varchar2 default 'JS' ) as

begin
	/*fcl.refresh_Session;*/
	if upper(prm_programa) = 'JS' then
	delete from log_eventos where tipo = 'ERRO' and programa = 'JS';
	end if;
	if upper(prm_programa) = 'EL' then
	delete from log_eventos where tipo = 'ERRORLINE';
	end if;
	if upper(prm_programa) = 'PAR' then
	delete from log_eventos where tipo = 'PARAMETRO';
	end if;
end clearlog;

procedure processos ( prm_completo varchar2 default 'N' ) as

	cursor crs_processos is
	SELECT
		sid,
		serial#,
		username          AS usuario,
		seconds_in_wait   AS espera,
		program           AS aplicacao,
		event             AS descricao_evento,
		to_char(logon_time, 'DD/MM/YY HH:MI') AS horario_conexao,
		nvl((
			SELECT MAX(sql_text)
			FROM v$sql
			WHERE v$session.sql_address = v$sql.address
			), 'SEM SQL') AS comando_sql,
		v$session.status,
		v$session.machine   AS maquina,
		t2.cd_sid			AS sid_usuario,
		t2.cd_serial		AS serial_usuario,
		t2.usuario			AS nome	
	FROM v$session, active_sessions t2
	WHERE ( v$session.username = 'DWU'
		OR ( v$session.username = 'UPMASTER' AND v$session.status = 'ACTIVE' )
		OR program = fun.ret_var('PROGRAM')
		OR ( v$session.username = 'ANONYMOUS' 
			AND v$session.event <> 'virtual circuit wait'
			AND v$session.event <> 'virtual circuit next request' 
		) )
	AND v$session.audsid <> userenv('SESSIONID')
	AND v$session.sid = t2.cd_sid
	AND v$session.serial# = t2.cd_serial;

	ws_processo crs_processos%rowtype;

	cursor crs_jobs is
	SELECT
		job        AS id,
		log_user   AS usuario,
		total_time,
		broken,
		what,
		to_char(last_date, 'DD/MM/YYYY HH24:MI') last_date,
		to_char(next_date, 'DD/MM/YYYY HH24:MI') next_date
	FROM all_jobs
	WHERE log_user IN (
		'DWU',
		'UPMASTER',
		'ANONYMOUS');

	ws_job crs_jobs%rowtype;

	ws_usuario  varchar2(80);
	ws_noaccess exception;

begin

	ws_usuario := gbl.getUsuario;

	if ws_usuario = 'NOUSER' then
		raise ws_noaccess;
	end if;

	htp.p('<h2>PROCESSOS</h2>');

	--if prm_completo = 'S' then
		htp.p('<table class="linha">');
			htp.p('<thead>');
			htp.p('<tr>');
				htp.p('<th><img class="recarregar-tela" title="Refresh" src="'||fun.r_gif('sinchronize','png')||'" onclick="ajax(''list'', ''processos'', ''prm_completo=N'', true, ''content'');"/></th>');
				htp.p('<th>SID</th>');
				htp.p('<th>SERIAL</th>');
				htp.p('<th>USER</th>');
				htp.p('<th>'||fun.lang('TEMPO')||'</th>');
				htp.p('<th>'||fun.lang('EVENTO')||'</th>');
				htp.p('<th>'||fun.lang('M&Aacute;QUINA')||'</th>');
				htp.p('<th>'||fun.lang('APLICA&Ccedil;&Atilde;O')||'</th>');
				htp.p('<th>'||fun.lang('USU&Aacute;RIO')||'</th>');
			htp.p('</tr>');
			htp.p('</thead>');
			htp.p('<tbody id="processos">');
	--end if;

	open crs_processos;
		loop
			fetch crs_processos into ws_processo;
			exit when crs_processos%notfound;
				htp.p('<tr title="'||ws_processo.COMANDO_SQL||'">');
					if ws_processo.status = 'INACTIVE' then
						htp.p('<td><a onclick="if(confirm(''Derrubar o processo?'')){ ajax(''fly'', ''kill'', ''prm_sid='||ws_processo.sid||'&prm_serial='||ws_processo.serial#||''', false); noerror(this, '''||fun.lang('Processo adicionado ao job para ser derrubado')||'!'', ''msg''); }" class="dot"></a></td>');
					else
						htp.p('<td><a onclick="if(confirm(''Derrubar o processo?'')){ ajax(''fly'', ''kill'', ''prm_sid='||ws_processo.sid||'&prm_serial='||ws_processo.serial#||''', false); noerror(this, '''||fun.lang('Processo adicionado ao job para ser derrubado')||'!'', ''msg''); }" class="dot active"></a></td>');
					end if;
					htp.p('<td>'||ws_processo.sid||'</td>');
					htp.p('<td>'||ws_processo.serial#||'</td>');
					htp.p('<td>'||ws_processo.usuario||'</td>');
					htp.p('<td>'||ws_processo.espera||'</td>');
					htp.p('<td>'||htf.escape_sc(ws_processo.descricao_evento)||'</td>');
					htp.p('<td>'||ws_processo.maquina||'</td>');
					htp.p('<td>'||ws_processo.aplicacao||'</td>');
					htp.p('<td>'||ws_processo.nome||'</td>');
				htp.p('</tr>');
		end loop;
	close crs_processos;

	--if prm_completo = 'S' then
		htp.p('</tbody>');
		htp.p('</table>');
	--end if;

	htp.p('<h2>JOBS</h2>');

	--if prm_completo = 'S' then
		htp.p('<table class="linha">');
			htp.p('<thead>');
			htp.p('<tr>');
				--htp.p('<th></th>');
				htp.p('<th>ID</th>');
				htp.p('<th>USU&Aacute;RIO</th>');
				htp.p('<th>'||fun.lang('EXECU&Ccedil;&Atilde;O ANTERIOR')||'</th>');
				htp.p('<th>'||fun.lang('PR&Oacute;XIMO EXECU&Ccedil;&Atilde;O')||'</th>');
				htp.p('<th>'||fun.lang('A&Ccedil;&Atilde;O')||'</th>');
				htp.p('<th>'||fun.lang('TEMPO TOTAL')||'</th>');
				htp.p('<th>BROKEN</th>');
			htp.p('</tr>');
			htp.p('</thead>');
			htp.p('<tbody id="jobs">');
	--end if;

		open crs_jobs;
			loop
				fetch crs_jobs into ws_job;
				exit when crs_jobs%notfound;
					htp.p('<tr>');
						--htp.p('<td></td>');
						htp.p('<td>'||ws_job.id||'</td>');
						htp.p('<td>'||ws_job.usuario||'</td>');
						htp.p('<td>'||ws_job.last_date||'</td>');
						htp.p('<td>'||ws_job.next_date||'</td>');
						htp.p('<td>'||ws_job.what||'</td>');
						htp.p('<td>'||ws_job.total_time||'</td>');
						htp.p('<td>'||ws_job.broken||'</td>');
					htp.p('</tr>');
			end loop;
		close crs_jobs;

	--if prm_completo = 'S' then
		htp.p('</tbody>');
		htp.p('</table>');
	--end if;

exception 
	when ws_noaccess then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end processos;


procedure kill ( prm_sid varchar2 default null,
				prm_serial varchar2 default null ) as

	ws_comando      varchar2(2000);
	job_id          number;
	ws_owner        varchar2(90);
	ws_name         varchar2(90);
	ws_line         number;
	ws_caller       varchar2(90);

begin
	/*fcl.refresh_Session;*/

	if gbl.getNivel = 'A' then

		owa_util.who_called_me(ws_owner, ws_name, ws_line, ws_caller);

		begin
			ws_comando := 'alter system kill session '||chr(39)||prm_sid||','||prm_serial||chr(39)||'';
			execute immediate ws_comando;
		exception when others then
			htp.p(sqlerrm);
		end;

	end if;

end kill;

procedure acessos ( prm_completo varchar2 default 'N' ) as

	cursor crs_acessos is
	--logout de 12 horas aprox.
	select cod as id, valor as usuario, decode(show_only, 'S', to_char(dt_acesso-7, 'DD/MM/YY HH24:MI'), to_char(dt_acesso-0.5, 'DD/MM/YY HH24:MI')) as entrou, 
	to_char(dt_acesso, 'DD/MM/YY HH24:MI') as data, decode(decode(sign(instr(cod, 'ANONYMOUS')), 1, 'E', SHOW_ONLY), 'A', 'Admin', 'S', 'Slideshow', 'E', 'Email', 'Normal') as permissao
	from bi_sessao
	left join usuarios on usu_nome = valor
	where
	dt_acesso > sysdate
	order by valor desc;

	ws_acesso crs_acessos%rowtype;

	ws_usuario varchar2(80);

	ws_noacess exception;

begin
	/*fcl.refresh_Session;*/

	ws_usuario := gbl.getUsuario;

	if ws_usuario = 'NOUSER' then
		raise ws_noacess;
	end if;

	--if prm_completo = 'S' then
		htp.p('<table class="linha">');
			htp.p('<thead>');
				htp.p('<tr>');
					--htp.p('<th>'||fun.lang('ID')||'</th>');
					htp.p('<th>'||fun.lang('USU&Aacute;RIO')||'</th>');
					htp.p('<th>'||fun.lang('TIPO')||'</th>');
					htp.p('<th>'||fun.lang('ENTROU')||'</th>');
					htp.p('<th>'||fun.lang('SESS&Atilde;O EXPIRA')||'</th>');
					htp.p('<th></th>');
				htp.p('</tr>');
			htp.p('</thead>');
			htp.p('<tbody id="acessos">');
	--end if;

	open crs_acessos;
		loop
			fetch crs_acessos into ws_acesso;
			exit when crs_acessos%notfound;
				htp.p('<tr title="'||ws_acesso.id||'">');
					--htp.p('<td>'||ws_acesso.id||'</td>');
					htp.p('<td>'||ws_acesso.usuario||'</td>');
					htp.p('<td>'||ws_acesso.permissao||'</td>');
					htp.p('<td>'||ws_acesso.entrou||'</td>');
					htp.p('<td>'||ws_acesso.data||'</td>');
					htp.p('<td>');
						--fcl.button_lixo('xlogout','prm_sessao', ws_acesso.id, prm_tag => 'a');
						fcl.button_lixo('kickUser','prm_sessao_bi',ws_acesso.id,prm_tag => 'a');
					htp.p('<td>');
				htp.p('</tr>');
		end loop;
	close crs_acessos;

	--if prm_completo = 'S' then
		htp.p('</tbody>');
		htp.p('</table>');
	--end if;

exception 
	when ws_noacess then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end acessos;

procedure Tokens ( prm_completo 		varchar2 default 'N' ) as

	cursor crs_tokens is
	--logout de 12 horas aprox.
	select code as token, t1.usuario, dt_envio as data_envio, t1.status,decode(t1.status,'D','ATIVO','INATIVO') as ds_status,tela,descricao
		from bi_token t1
		left join usuarios 	 
		on usu_nome 	 = t1.usuario
		left join all_screens 
		on screen 	 = t1.tela
		where t1.tela is not null 
		and t1.status  = 'D'
		order by tela asc,
				dt_envio desc;
	ws_token crs_tokens%rowtype;



	ws_usuario 				varchar2(80);
	ws_url_token				varchar2(500);
	ws_noacess 				exception;

begin
	/*fcl.refresh_Session;*/

	ws_usuario := gbl.getUsuario;

	if ws_usuario = 'NOUSER' then
		raise ws_noacess;
	end if;
	
		ws_url_token:= fun.ret_var('URL_CLIENTE');

		htp.p('<table class="linha">');

			htp.p('<thead>');

				htp.p('<tr>');

					htp.p('<th>'||fun.lang('TELA')||'</th>');
					htp.p('<th>'||fun.lang('NOME DA TELA')||'</th>');
					htp.p('<th>'||fun.lang('USU&Aacute;RIO')||'</th>');
					htp.p('<th>'||fun.lang('DATA DE CRIA&Ccedil;&Atilde;O')||'</th>');
					htp.p('<th>'||fun.lang('TOKEN')||'</th>');
					--htp.p('<th >'||fun.lang('STATUS')||'</th>');		Removido 22/08/22 suporte pediu para manter somente os status ativos.			
					htp.p('<th style="padding-left: 10px;"></th>');
					htp.p('<th></th>');

				htp.p('</tr>');

			htp.p('</thead>');

			htp.p('<tbody id="acessos">');

	open crs_tokens;
		loop
			fetch crs_tokens into ws_token;
			exit when crs_tokens%notfound;
				htp.p('<tr>');
				
					htp.p('<td>'||ws_token.tela||'</td>');

					htp.p('<td>'||ws_token.descricao||'</td>');

					htp.p('<td>'||ws_token.usuario||'</td>');

					htp.p('<td>'||ws_token.data_envio||'</td>');

					htp.p('<td style="heigth:70px;white-space: nowrap;text-overflow: ellipsis !important; overflow:hidden;" title='||ws_url_token||'/'||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.show_screen?prm_screen='||ws_token.tela||'&prm_clear=INFO&prm_token='||ws_token.token||'>');
						htp.p('<textarea rows="5" style="max-width:500px !important;" id="copy_token" readonly>'||ws_url_token||'/'||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.show_screen?prm_screen='||ws_token.tela||'&prm_clear=INFO&prm_token='||ws_token.token||'</textarea>');
					htp.p('</td>');
				
					--htp.p('<td style="padding-left: 10px;">'||ws_token.ds_status||'</td>');	Removido 22/08/22 suporte pediu para manter somente os status ativos.	
									
					htp.p('<td style="padding-left: 10px;" id="btn_token" onclick="copyToClipBoard(this)" title="Copiar Token"><svg	xmlns="http://www.w3.org/2000/svg" width="18" height="22" viewBox="0 0 64 64" fill="none"><path d="M56.34 17.27C56.2654 17.1214 56.1712 16.9835 56.06 16.86L42.13 2.94C41.8438 2.66648 41.4658 2.50958 41.07 2.5H20.92C19.6159 2.50264 18.3661 3.02185 17.444 3.94395C16.5218 4.86606 16.0026 6.11595 16 7.42V10.62H12.42C11.1159 10.6226 9.86606 11.1418 8.94395 12.064C8.02185 12.9861 7.50264 14.2359 7.5 15.54V56.54C7.50264 57.8441 8.02185 59.0939 8.94395 60.016C9.86606 60.9382 11.1159 61.4574 12.42 61.46H43.08C44.3772 61.4574 45.6211 60.9437 46.542 60.0302C47.463 59.1168 47.9868 57.8771 48 56.58V53.38H51.58C52.8841 53.3774 54.1339 52.8582 55.056 51.936C55.9782 51.0139 56.4974 49.7641 56.5 48.46V17.93C56.4993 17.7005 56.4445 17.4744 56.34 17.27V17.27ZM42.57 7.62L51.38 16.42H42.57V7.62ZM45 56.62C45 57.1292 44.7977 57.6176 44.4376 57.9776C44.0776 58.3377 43.5892 58.54 43.08 58.54H12.42C11.9108 58.54 11.4224 58.3377 11.0624 57.9776C10.7023 57.6176 10.5 57.1292 10.5 56.62V15.62C10.5 15.1108 10.7023 14.6224 11.0624 14.2624C11.4224 13.9023 11.9108 13.7 12.42 13.7H16V48.46C16.0026 49.7641 16.5218 51.0139 17.444 51.936C18.3661 52.8582 19.6159 53.3774 20.92 53.38H45V56.62ZM51.58 50.42H20.92C20.6645 50.4201 20.4115 50.3691 20.1759 50.2701C19.9403 50.1711 19.7268 50.0261 19.548 49.8436C19.3692 49.661 19.2286 49.4446 19.1345 49.207C19.0404 48.9695 18.9947 48.7155 19 48.46V7.46C18.9947 7.20452 19.0404 6.95054 19.1345 6.71296C19.2286 6.47538 19.3692 6.25897 19.548 6.07642C19.7268 5.89388 19.9403 5.74886 20.1759 5.64988C20.4115 5.5509 20.6645 5.49994 20.92 5.5H39.57V17.92C39.57 18.3178 39.728 18.6994 40.0093 18.9807C40.2906 19.262 40.6722 19.42 41.07 19.42H53.5V48.42C53.5053 48.6755 53.4596 48.9295 53.3655 49.167C53.2714 49.4046 53.1308 49.621 52.952 49.8036C52.7732 49.9861 52.5597 50.1311 52.3241 50.2301C52.0885 50.3291 51.8355 50.3801 51.58 50.38V50.42Z" fill="black"/></svg>');
					
					htp.p('<td>');
						fcl.button_lixo('dl_tokens','prm_cod|prm_tela', ws_token.token, prm_tag => 'a');
					htp.p('<td>');

				htp.p('</tr>');
		end loop;
	close crs_tokens;

			htp.p('</tbody>');
		htp.p('</table>');

exception 
	when ws_noacess then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end Tokens;

procedure dl_tokens ( 	prm_cod  varchar2     default null,     
						prm_tela varchar2     default null )  as


	ws_nome     varchar2(200);
	ws_usuario  varchar2(80);


	ws_nouser         exception;
	ws_error          exception;	
begin

	ws_usuario  := gbl.getUsuario;
	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if;


		begin
				delete bi_token
				where code  = prm_cod;

			exception when others then
				raise ws_error;
		end;

		
		htp.p('OK');
		commit;

exception
	when ws_nouser then
		htp.p('Sem permiss&atilde;o!');
	when ws_error then
		rollback;
		htp.p('FAIL '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
	when others then
		rollback;
		htp.p('FAIL '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);

end dl_tokens;


procedure logs as

	cursor crs_logs is
	select * from(
		select dt_log, ds_log, nm_usuario, nm_procedure
		from bi_log_sistema
		where nm_procedure = 'EVENTO'
		order by dt_log desc
	) where rownum < 30;
	ws_log crs_logs%rowtype;

	ws_evento   varchar2(800);
	ws_usuario  varchar2(80);
	ws_noaccess exception;
begin

	ws_usuario := gbl.getUsuario;

	if ws_usuario = 'NOUSER' then
		raise ws_noaccess;
	end if;

	ws_evento := 'onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''logs_lista'', ''prm_tipo=''+document.getElementById(''log-tipo'').value+''&prm_usuario=''+document.getElementById(''log-usuario'').value+''&prm_linha=''+document.getElementById(''log-linha'').value+''&prm_order=''+this.title+''&prm_dir=''+dir, false, ''ajax'');"';

	htp.p('<table class="linha">');
		
		htp.p('<thead>');
			htp.p('<tr>');
				htp.p('<th><a title="1" class="red" '||ws_evento||'>'||fun.lang('DESCRI&Ccedil;&Atilde;O')||'</a></th>');
				htp.p('<th><a title="3" class="red" '||ws_evento||'>'||fun.lang('USU&Aacute;RIO')||'</a></th>');
				htp.p('<th><a title="2" class="red" '||ws_evento||'>DATA</a></th>');
				
				--htp.p('<th style="width: 110px;"><a title="4"  class="red" '||ws_evento||'>PROCEDURE</a></th>');
			htp.p('</tr>');
		htp.p('</thead>');
		
		htp.p('<tbody id="ajax" data-dir="1">');
			open crs_logs;
				loop
					fetch crs_logs into ws_log;
					exit when crs_logs%notfound;
						htp.p('<tr>');
							htp.p('<td title="'||replace(ws_log.ds_log, '"', '')||'" style="max-width: 340px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">'||replace(ws_log.ds_log, '"', '')||'</td>');
							htp.p('<td>'||ws_log.nm_usuario||'</td>');
							htp.p('<td>'||to_char(ws_log.dt_log, 'DD/MM/YY HH24:MI')||'</td>');
							--htp.p('<td style="width: 110px;">'||ws_log.nm_procedure||'</td>');
						htp.p('</tr>');
				end loop;
			close crs_logs;
		htp.p('</tbody>');
	htp.p('</table>');

exception
	when ws_noaccess then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end logs;

procedure logs_lista ( prm_tipo varchar2 default null,
					prm_usuario varchar2 default null,
					prm_linha number default 30,
					prm_order varchar2 default '2',
					prm_dir varchar2 default '2') as

	cursor crs_logs is
	select dt_log, ds_log, nm_usuario, nm_procedure from (
			select dt_log, ds_log, nm_usuario, nm_procedure
			from bi_log_sistema
			where nm_usuario = nvl(trim(prm_usuario), nm_usuario) and
			decode(nm_procedure, 'EVENTO', 'EVENTO', 'ERRO', 'ERRO','SESSAO','SESSAO','OUTROS') = nvl(trim(prm_tipo), nm_procedure)
			order by
			case when prm_dir = '1' then decode(prm_order, '1', ds_log, '2', to_char(dt_log, 'YYMMDDHH24MI'), '3', nm_usuario, '4', nm_procedure, to_char(dt_log, 'YYMMDDHH24MI')) end asc,
			case when prm_dir = '2' then decode(prm_order, '1', ds_log, '2', to_char(dt_log, 'YYMMDDHH24MI'), '3', nm_usuario, '4', nm_procedure, to_char(dt_log, 'YYMMDDHH24MI')) end desc
	) where rownum < nvl(prm_linha, 30)+1;
	ws_log crs_logs%rowtype;

begin
	/*fcl.refresh_Session;*/
	open crs_logs;
	loop
		fetch crs_logs into ws_log;
		exit when crs_logs%notfound;
			htp.p('<tr>');
				htp.p('<td title="'||replace(ws_log.ds_log, '"', '')||'" style="max-width: 340px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">'||replace(ws_log.ds_log, '"', '')||'</td>');
				htp.p('<td>'||ws_log.nm_usuario||'</td>');
				htp.p('<td>'||to_char(ws_log.dt_log, 'DD/MM/YY HH24:MI')||'</td>');
				--htp.p('<td>'||ws_log.nm_procedure||'</td>');
			htp.p('</tr>');
		end loop;
	close crs_logs;

end logs_lista;


Procedure xsend_Mail (  prm_sender     in varchar2,
						prm_recipient  in varchar2,
						prm_subject    in varchar2,
						prm_message    in varchar2,
						Prm_erro_envio in out Varchar2) As

	Mail_Conn      Utl_Smtp.Connection;
	crlf           varchar2(2)  := CHR(13) || CHR(10);
	Ws_Mesg        clob;

	Ws_Sender      varchar2(40);
	ws_recipient   varchar2(200);
	ws_title       varchar2(120);
	l_boundary     varchar2(50) := '----=*#abc1234321cba#*=';

Begin

	Prm_erro_envio := null; 

	xsend_mail_upquery('999|'||trim(prm_recipient)||'|'||trim(prm_subject)||'|'||trim(prm_message), prm_erro_envio ); 

exception when others then
	Prm_erro_envio := 'Erro no envio do email, entre em contato com o administrador do sistema';
	insert into bi_log_sistema values(sysdate, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - XSEND_MAIL - 2', gbl.getUsuario, 'ERRO');
	commit; 
End xsend_mail;

----------------------------------------------------------------------------------------------------------
-- Envia o email através da base Upquery utilizando o serviço de email da Upquery.
----------------------------------------------------------------------------------------------------------
Procedure xsend_mail_upquery ( prm_param       in     varchar2,
							Prm_erro_envio  in out Varchar2) as 
ws_command    varchar2(32000);
ws_string     varchar2(500);
ws_param      varchar2(32000);
Begin

	Prm_erro_envio := null; 
	ws_string      := null; 
	ws_param       := utl_url.escape(prm_param, true, 'ISO-8859-1'); 
	
	ws_command := 'http://'||fun.ret_var('URL_UPDATE')||'/dwu.beup.xsend_mail_upquery?prm_param='||ws_param;

	begin
		ws_string := utl_http.request(ws_command);
	exception when others then
		Prm_erro_envio := fun.lang('Erro na chamada de serviço de email, entre em contato com o administrador do sistema');
		insert into bi_log_sistema values(sysdate, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - XSEND_MAIL_UPQUERY - 1', gbl.getUsuario, 'ERRO');
		commit;	
	end;
	if nvl(ws_string,'NA') <> 'NA' then 
		Prm_erro_envio := fun.lang('Erro na chamada de serviço de email, entre em contato com o administrador do sistema');
		insert into bi_log_sistema values(sysdate, 'XSEND_MAIL_UPQUERY - Erro em utl_http.request <'||ws_string, gbl.getUsuario||'>', 'ERRO');
		commit;	
	end if; 
exception when others then 
	Prm_erro_envio := fun.lang('Erro na chamada de serviço de email, entre em contato com o administrador do sistema');
	insert into bi_log_sistema values(sysdate, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - XSEND_MAIL_UPQUERY - 2', gbl.getUsuario, 'ERRO');
	commit;	
end xsend_mail_upquery; 



procedure edit_filtro ( prm_key number default null,
						prm_valor varchar2 default null,
						prm_tipo varchar2 default null) as

	ws_converte 	 varchar2(800);
	ws_desc_eventos  varchar2(100);
	ws_objeto		 varchar2(100);
	ws_count      	 number;

	ws_fail     	 exception;

begin

	/*fcl.refresh_Session;*/

	ws_converte  := fun.converte(prm_valor);

	begin

		case prm_tipo
		when 'CONDICAO' then
			update FILTROS
			set condicao = ws_converte
			where cd_filtro = prm_key
			/*and tp_filtro = 'objeto'*/;
		when 'COLUNA' then
			update FILTROS
			set cd_coluna = ws_converte
			where cd_filtro = prm_key
			/*and tp_filtro = 'objeto'*/;
		when 'LIGACAO' then
			update FILTROS
			set ligacao = ws_converte
			where cd_filtro = prm_key
			/*and tp_filtro = 'objeto'*/;
		when 'AGRUPADO' then
			update FILTROS
			set st_agrupado = ws_converte
			where cd_filtro = prm_key
			/*and tp_filtro = 'objeto'*/;
		when 'CONDICAO-USER' then
			update FILTROS
			set condicao = ws_converte
			where cd_filtro = prm_key
			/*and tp_filtro = 'geral'*/;
		when 'COLUNA-USER' then
			update FILTROS
			set cd_coluna = ws_converte
			where cd_filtro = prm_key
			/*and tp_filtro = 'geral'*/;
		when  'CONTEUDO-USER' then
			update FILTROS
			set conteudo = ws_converte
			where cd_filtro = prm_key
			/*and tp_filtro = 'geral'*/;
		when 'LIGACAO-USER' then
			update FILTROS
			set ligacao = ws_converte
			where cd_filtro = prm_key
			/*and tp_filtro = 'geral'*/;
		when  'CONTEUDO' then
			update FILTROS
			set conteudo = ws_converte
			where cd_filtro = prm_key
			/*and tp_filtro = 'objeto'*/;
		when  'USUARIO' then
			update FILTROS
			set cd_usuario = ws_converte
			where cd_filtro = prm_key
			/*and tp_filtro = 'objeto'*/;
		else
			raise ws_fail;
		end case;
		select cd_objeto into ws_objeto from filtros where cd_filtro = prm_key;
		insert into bi_log_sistema (dt_log, ds_log, nm_usuario, nm_procedure) values (sysdate, 'Filtro #'||prm_tipo||', Objeto #'||ws_objeto||' alterado com sucesso para: #'||prm_valor||'', gbl.getUsuario, 'EVENTO');
		commit;

		ws_count := SQL%ROWCOUNT;
		
		if ws_count <> 0 then
			commit;
		else
			raise ws_fail;
		end if;

	exception 
		when ws_fail then
			htp.p('FAIL');
		when others then
			htp.p('FAIL');
	end;

end edit_filtro;

procedure edit_destaque ( prm_key      number default null,
						prm_valor    varchar2 default null,
						prm_acao     varchar2 default null ) as

	ws_converte 		varchar2(800);
	ws_desc_eventos		varchar2(200);
	ws_objeto			varchar2(200);

begin

	/*fcl.refresh_Session;*/

	ws_converte := fun.converte(prm_valor);

	begin
		if prm_acao = 'CONDICAO' then
			update destaque
			set condicao = ws_converte
			where cd_destaque = prm_key;
		elsif prm_acao = 'COLUNA' then
			update destaque
			set cd_coluna = ws_converte
			where cd_destaque = prm_key;
		elsif prm_acao = 'CONTEUDO' then
			update destaque
			set conteudo = ws_converte
			where cd_destaque = prm_key;
		elsif prm_acao = 'COR_FUNDO' then
			update destaque
			set cor_fundo = ws_converte
			where cd_destaque = prm_key;
		elsif prm_acao = 'COR_FONTE' then
			update destaque
			set cor_fonte = ws_converte
			where cd_destaque = prm_key;
		else
			update destaque
			set tipo_destaque = ws_converte
			where cd_destaque = prm_key;

		end if;
		select cd_objeto into ws_objeto from destaque where cd_destaque = prm_key;
		select decode (prm_key, 'CONDICAO', 'CONDICAO', 'COLUNA', 'COLUNA', 'CONTEUDO', 'CONTEUDO', 'COR_FUNDO', 'COR DE FUNDO', 'COR_FONTE', 'COR DA FONTE', prm_key) into ws_desc_eventos from dual;
		insert into bi_log_sistema (dt_log, ds_log, nm_usuario, nm_procedure) values (sysdate, 'Destaque #'||ws_desc_eventos||', Objeto #'||ws_objeto||' alterado com sucesso para: '||prm_valor||'', gbl.getUsuario, 'EVENTO');
		commit;

	exception when others then
		htp.p(sqlerrm);
	end;

end edit_destaque;

procedure obj_on_screen ( prm_screen varchar2 default null ) as


		ws_root varchar2(80);
		ws_count number;
		ws_ds_tipo  varchar2(100);

		procedure nested_remove_obj ( prm_objeto varchar2 default null,
									prm_screen varchar2 default null ) as

		begin
			
			htp.p('<td>');
				fcl.button_lixo('dl_obj','prm_cod|prm_tela', prm_objeto||'|'||prm_screen, prm_tag => 'a');
			htp.p('<td>');
			--htp.p('<td><a class="remove" onclick="var linha = this.parentNode.parentNode; if(confirm(TR_CE)){ call(''dl_obj'', ''ws_par_sumary='||prm_objeto||'&ws_par_screen='||prm_screen||''').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''msg'', TR_EX); linha.remove(); if(document.getElementById('''||prm_objeto||''')){ document.getElementById('''||prm_objeto||''').style.setProperty(''display'', ''none''); } } }); }">X</a></td>');

		end nested_remove_obj;

begin
	/*fcl.refresh_Session;*/
	select count(*) into ws_count from object_location where screen = prm_screen;-- and object_id like 'SECTION_%';

	htp.p('<table class="linha">');
		htp.p('<thead>');

			htp.p('<tr>');
				htp.p('<th>ID</th>');
				htp.p('<th>'||fun.lang('NOME')||'</th>');
				htp.p('<th>'||fun.lang('TIPO')||'</th>');
				htp.p('<th></th>');
				htp.p('<th></th>');
				htp.p('<th></th>');
			htp.p('</tr>');

		htp.p('</thead>');
		htp.p('<tbody>');

			if ws_count = 0 then

				for i in(select t1.object_id, (select cod from objetos t2 where t2.cd_objeto = t1.object_id) as cod, (select nm_objeto from objetos t2 where t2.cd_objeto = t1.object_id) as nome, (select tp_objeto from objetos t2 where t2.cd_objeto = t1.object_id) as tipo,(select cd_micro_visao from ponto_avaliacao t3 where t3.cd_ponto = t1.object_id) as visao from object_location t1 where screen = prm_screen and object_id not like ('SECTION_%') order by tipo desc) loop
					
					htp.p('<tr>');

						htp.p('<td>'||nvl(i.cod, i.object_id)||'</td>');
						htp.p('<td>'||i.nome||'</td>');
						htp.p('<td>'||i.tipo||'</td>');
						htp.p('<td><a title="'||fun.lang('FILTROS')||'" class="link" onclick="titulo(this, ''c''); call_save(''''); carregaPainel(''list_ofiltro'', '''||i.object_id||'|'||i.visao||'''); carrega(''list_ofiltro?ws_par_sumary='||i.object_id||'&prm_visao='||i.visao||'''); curtain(''enabled'');">FILTRO</a></td>');
						
						nested_remove_obj(i.object_id, prm_screen);

					htp.p('</tr>');

				end loop;

			else

				for a in(select object_id from object_location where screen = prm_screen) /*and object_id like 'SECTION_%')*/ loop
					
					for b in(select t1.object_id, (select cod from objetos t2 where t2.cd_objeto = t1.object_id) as cod, (select nm_objeto from objetos t2 where t2.cd_objeto = t1.object_id) as nome, (select tp_objeto from objetos t2 where t2.cd_objeto = t1.object_id) as tipo,(select cd_micro_visao from ponto_avaliacao t3 where t3.cd_ponto = t1.object_id) as visao, t1.screen from object_location t1 where t1.screen in (select object_id from object_location where screen = a.object_id) order by tipo desc) loop
						
						htp.p('<tr>');
							ws_ds_tipo := b.tipo; 
							if b.tipo = 'MAPAGEOLOC' then 
								ws_ds_tipo := 'GEOLOCALIZA&Ccedil;&Atilde;O'; 
							end if; 
							htp.p('<td>'||nvl(b.cod, b.object_id)||'</td>');
							htp.p('<td>'||b.nome||'</td>');
							htp.p('<td>'||ws_ds_tipo||'</td>');

							if b.tipo in ('PIZZA', 'ROSCA', 'CONSULTA', 'BARRAS', 'COLUNAS', 'LINHAS', 'VALOR', 'PONTEIRO', 'MAPA', 'MAPAGEOLOC','SANKEY','SCATTER','RADAR','CALENDARIO') then
								htp.p('<td><a title="'||fun.lang('FILTROS')||'" class="link" onclick="titulo(this, ''c''); call_save(''''); carregaPainel(''list_ofiltro'', '''||b.object_id||'|'||b.visao||'''); carrega(''list_ofiltro?ws_par_sumary='||b.object_id||'&prm_visao='||b.visao||'''); curtain(''enabled'');">FILTRO</a></td>');
							else
								htp.p('<td></td>');
							end if;

							htp.p('<td><a class="link" title="'||fun.lang('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||b.object_id||'&prm_screen='||prm_screen||''');">'||fun.lang('ATRIBUTOS')||'</a></td>');
							htp.p('<td><a class="link" title="'||fun.lang('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||b.object_id||''');">'||fun.lang('PROPRIEDADES')||'</a></td>');
					
							nested_remove_obj(b.object_id, b.screen);

						htp.p('</tr>');

					end loop;

				end loop;

				for i in(select t1.object_id, (select cod from objetos t2 where t2.cd_objeto = t1.object_id) as cod, (select nm_objeto from objetos t2 where t2.cd_objeto = t1.object_id) as nome, (select tp_objeto from objetos t2 where t2.cd_objeto = t1.object_id) as tipo,(select cd_micro_visao from ponto_avaliacao t3 where t3.cd_ponto = t1.object_id) as visao from object_location t1 where screen = prm_screen/* and object_id not like ('SECTION_%')*/ order by tipo desc) loop
					
					htp.p('<tr>');

						htp.p('<td>'||nvl(i.cod, i.object_id)||'</td>');
						
						if nvl(i.cod, i.object_id) like '%SECTION%'then

							htp.p('<td>DASHBOARD</td>');
							htp.p('<td>DASHBOARD</td>');
						
						else
						
							htp.p('<td>'||i.nome||'</td>');
							htp.p('<td>'||i.tipo||'</td>');
						
						end if;
						
						if i.tipo in ('PIZZA', 'ROSCA', 'CONSULTA', 'BARRAS', 'COLUNAS', 'LINHAS', 'VALOR', 'PONTEIRO', 'MAPA', 'MAPAGEOLOC', 'SANKEY','SCATTER','RADAR','CALENDARIO') then
							htp.p('<td><a title="'||fun.lang('FILTROS')||'" class="link" onclick="titulo(this, ''c''); call_save(''''); carregaPainel(''list_ofiltro'', '''||i.object_id||'|'||i.visao||'''); carrega(''list_ofiltro?ws_par_sumary='||i.object_id||'&prm_visao='||i.visao||'''); curtain(''enabled'');">FILTRO</a></td>');
						else
							htp.p('<td></td>');
						end if;

						if nvl(i.cod, i.object_id) like '%SECTION%'then

							htp.p('<td></td>');
							htp.p('<td></td>');
						else

							htp.p('<td><a class="link" title="'||fun.lang('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||i.object_id||'&prm_screen='||prm_screen||''');">'||fun.lang('ATRIBUTOS')||'</a></td>');
							htp.p('<td><a class="link" title="'||fun.lang('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||i.object_id||''');">'||fun.lang('PROPRIEDADES')||'</a></td>');
							
						end if;

						nested_remove_obj(i.object_id, prm_screen);

					htp.p('</tr>');

				end loop;
				
			end if;

		htp.p('</tbody>');
	htp.p('</table>');

end obj_on_screen;

procedure clear_sandbox as

begin
	
	/*fcl.refresh_Session;*/
	delete from filtros where cd_objeto = 'SANDBOX' and tp_filtro = 'objeto';
	delete from object_location where SCREEN = 'SANDBOX';

end clear_sandbox;

procedure dashboardmove ( prm_objeto varchar2 default null,
						prm_target varchar2 default null,
						prm_last   varchar2 default null ) as

	ws_order1 varchar2(10);
	ws_order2 varchar2(10);
	ws_count number;
begin
	/*fcl.refresh_Session;*/
	if instr(prm_objeto, 'SECTION') = 0 then
		if instr(prm_objeto, 'ARTICLE') <> 0 and instr(prm_target, 'ARTICLE') <> 0 then
			select posx into ws_order1 from object_location where screen = prm_last and object_id = prm_objeto;
			select posx into ws_order2 from object_location where screen = prm_last and object_id = prm_target;
			update object_location set posx = ws_order1 where screen = prm_last and object_id = prm_target;
			update object_location set posx = ws_order2 where screen = prm_last and object_id = prm_objeto;
		else
			select count(*) into ws_count
			from object_location
			where object_id = prm_objeto and
			screen = prm_last;

			update object_location
			set screen = prm_target,
			posx = ws_count
			where object_id = prm_objeto and
			screen = prm_last;
		end if;
	else
		select posx into ws_order1 from object_location where screen = prm_last and object_id = prm_objeto;
		select posx into ws_order2 from object_location where screen = prm_last and object_id = prm_target;
		update object_location set posx = ws_order1 where screen = prm_last and object_id = prm_target;
		update object_location set posx = ws_order2 where screen = prm_last and object_id = prm_objeto;
	end if;

end dashboardmove;

procedure executar( prm_acao varchar2 default null ) as

begin
	/*fcl.refresh_Session;*/
	begin
		execute immediate prm_acao;
		htp.p('!alert '||sqlerrm);
	exception when others then
		htp.p('!alert '||sqlerrm);
	end;

end executar;

PROCEDURE change_pass (usuario     varchar2,
					senha       varchar2 )
AS

ws_session     varchar2(100);
ws_txt         varchar2(2000);
job_id         number;

BEGIN
	/*fcl.refresh_Session;*/
SELECT SID||','||SERIAL# into ws_session
FROM V$SESSION
WHERE AUDSID = userENV('SESSIONID');

begin
		DBMS_JOB.SUBMIT(job => job_id,what => ''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.exec_pass('||chr(39)||usuario||chr(39)||','||chr(39)||senha||chr(39)||','||chr(39)||ws_session||chr(39)||');',next_date => sysdate+((1/10)/(24*60)),interval => NULL);
exception
		when others then
			ws_txt := sqlerrm;
end;
commit;

END change_pass;

procedure show_update ( prm_usuario varchar2 default null,
						prm_screen  varchar2 default null,
						prm_time    varchar2 default null,
						prm_ordem   varchar2 default '1',
						prm_tipo    varchar2 default 'all' ) as

	ws_tempo     varchar2(5);
	ws_descricao varchar2(600);
	ws_count     number := 0;

begin
	/*fcl.refresh_Session;*/
	case prm_tipo

	when 'time' then
		update user_sequence
		set time = prm_time
		where screen = prm_screen and
		usuario = prm_usuario and
		ordem = prm_ordem and
		rownum = 1;
	when 'screen' then
		update user_sequence
		set screen = prm_screen
		where time = prm_time and
		usuario = prm_usuario and
		ordem = prm_ordem and
		rownum = 1;
	when 'ordem' then
		update user_sequence
		set ordem = prm_ordem
		where time = prm_time and
		usuario = prm_usuario and
		screen = prm_screen and
		rownum = 1;
	when 'show' then
		update usuarios
		set show_only = prm_screen
		where trim(usu_nome) = prm_usuario;
	
		insert into log_eventos values(sysdate, 'ALTERACAO TIPO[show_only]', prm_usuario, 'TELA', 'USUARIO', '01'); 
		commit;

	when 'delete' then
		delete from user_sequence
		where ordem = prm_ordem and
		usuario = prm_usuario and
		screen = prm_screen and
		time = prm_time;
		commit;
		
		htp.p('[1]'||fun.lang('Removido com sucesso'));
		
	else
		insert into user_sequence (ordem, screen, time, usuario) 
		values (prm_ordem, prm_screen, prm_time, prm_usuario);
		commit; 
		
		select count(*) into ws_count from user_sequence 
		where ordem = prm_ordem and
		screen = prm_screen and
		time = prm_time and
		usuario = prm_usuario;
		
		if ws_count <> 0 then
			htp.p('[1]'||fun.lang('Adicionado com sucesso'));
		else
			htp.p(fun.lang('Erro ao adicionar'));
		end if;
	end case;

exception when others then
	htp.p('!alert erro ao alterar');
end show_update;

procedure fakedatalist ( prm_codigo    varchar2 default null,
						prm_descricao  varchar2 default null,
						prm_tabela     varchar2 default null,
						prm_rownum     number default 50,
						prm_text       varchar2 default 'N/A',
						prm_browser    varchar2 default 'N/A',
						prm_ref		   varchar2 default null,
						prm_ordem	   varchar2 default null ) as

	ws_cursor	        integer;
	ws_sql		        varchar2(4000);
	ws_where 	        varchar2(4000);
	ws_codigo           varchar2(2000);
	ws_descricao        varchar2(2000);
	ws_valor			varchar2(200);
	ws_linhas           integer;
	ws_count            number;
	ws_ordem			varchar2(2000);
	ws_nr_inicial       number;
	ws_nr_final         number;  
	ws_nr_linha         number; 
	ws_tot_linhas       number; 
	ws_cd_ordem         varchar2(1000);

begin
	
	if prm_text = 'N/A' and prm_browser = 'N/A' then
		ws_count := prm_rownum-49;
		ws_sql := 'select '||prm_codigo||', '||prm_descricao||' from (select '||prm_codigo||', '||prm_descricao||', rownum as linha from (select '||prm_codigo||', '||prm_descricao||' from '||nvl(fun.ret_var('OWNER_TABLE_DATA'),'DWU')||'.'||prm_tabela||' order by '||prm_descricao||' asc)) where linha between '||ws_count||' and '||prm_rownum||'';

		begin
			ws_cursor := dbms_sql.open_cursor;
			dbms_sql.parse(ws_cursor, ws_sql, DBMS_SQL.NATIVE);
			dbms_sql.define_column(ws_cursor, 1, ws_codigo, 200);
			dbms_sql.define_column(ws_cursor, 2, ws_descricao, 200);

			ws_linhas := dbms_sql.execute(ws_cursor);
			loop
				if dbms_sql.fetch_rows(ws_cursor) = 0 THEN
					exit;
				end if;
				ws_count := dbms_sql.last_row_count;
				dbms_sql.column_value(ws_cursor, 1, ws_codigo);
				dbms_sql.column_value(ws_cursor, 2, ws_descricao);
				htp.p('<li onclick="fakeValue(''fake_datalist'', this);" title="'||trim(ws_codigo)||'">'||trim(ws_descricao)||'</li>');
			end loop;

			dbms_sql.close_cursor(ws_cursor);

			if ws_count >= 50 then
				htp.p('<li style="font-weight: bold !important; text-align: center !important;" id="load-more" class="link" title="'||fun.lang('Carregar mais 50')||'" onclick="remover(''load-more'', ''r''); var numero = parseInt(document.getElementById(''fake_ajax'').children.length)+50; ajax(''main'', ''fakedatalist'', ''prm_codigo='||prm_codigo||'&prm_descricao='||prm_descricao||'&prm_tabela='||prm_tabela||'&prm_rownum=''+numero+''&prm_text=N/A&prm_browser='||prm_browser||'&prm_ref='||prm_ref||''', true, ''fake_ajax'');">'||fun.lang('carregar')||' mais 50</li>');
			end if;

		exception when others then
			htp.p('');
		end;
	else

		ws_cd_ordem := ' (case when replace(translate(trim('||prm_codigo||'),''0123456789'',''0''),''0'','''') is null then to_number('||prm_codigo||') end)';
		if    nvl(prm_ordem,'N/A') = 'CD' then 	ws_ordem := ws_cd_ordem 	|| ' desc, '||prm_codigo||' desc';
		elsif nvl(prm_ordem,'N/A') = 'DD' then 	ws_ordem := prm_descricao	|| ' desc';
		elsif nvl(prm_ordem,'N/A') = 'DA' then 	ws_ordem := prm_descricao	|| ' asc';
		else  									ws_ordem := ws_cd_ordem 	|| ' asc, '||prm_codigo||' asc';
		end if;

		ws_count      := prm_rownum-49;
		ws_nr_inicial := prm_rownum-49;
		ws_nr_final   := prm_rownum;

		if trim(prm_codigo) = 'column_name' then
			if prm_text = 'all' then
				ws_where := '';
			else
				ws_where := 'and upper(column_name) like (''%'||upper(trim(prm_text))||'%'')'; 
			end if;
			ws_sql := 'select column_name, column_name from all_tab_columns where table_name = '''||prm_tabela||''' and column_name not in (select cd_coluna from data_coluna where cd_micro_data = '''||prm_tabela||''') '||ws_where;
		else
			ws_where := '';
			if nvl(prm_text, 'N/A') <> 'N/A' then
				ws_where := 'where upper('||trim(prm_descricao)||') like (''%'||upper(trim(prm_text))||'%'') or upper('||trim(prm_codigo)||') like (''%'||upper(trim(prm_text))||'%'')'; 
			end if;
			ws_sql := 'select '||prm_codigo||' as a, '||prm_descricao||' as b from '||nvl(fun.ret_var('OWNER_TABLE_DATA'),'DWU')||'.'||trim(prm_tabela)||' '||ws_where||' order by '|| ws_ordem;			
		end if;

		begin
			ws_cursor := dbms_sql.open_cursor;
			dbms_sql.parse(ws_cursor, ws_sql, DBMS_SQL.NATIVE);

			dbms_sql.define_column(ws_cursor, 1, ws_codigo, 200);
			dbms_sql.define_column(ws_cursor, 2, ws_descricao, 200);

			ws_linhas   := dbms_sql.execute(ws_cursor);
			ws_nr_linha := 0;

			loop
				if dbms_sql.fetch_rows(ws_cursor) = 0 THEN
					exit;
				end if;

				ws_nr_linha   := ws_nr_linha + 1;
				ws_tot_linhas := dbms_sql.last_row_count;

				if ws_nr_linha > ws_nr_final then 
					exit;
				end if; 
				if ws_nr_linha >= ws_nr_inicial  and ws_nr_linha <= ws_nr_final then 
					dbms_sql.column_value(ws_cursor, 1, ws_codigo);
					dbms_sql.column_value(ws_cursor, 2, ws_descricao);
					for i in (select column_value from table(fun.vpipe(prm_ref))) loop
						ws_valor := i.column_value;
					end loop; 
					
					if length(trim(prm_browser)) > 0 and ws_valor not in ('ligacao','ligacaoc') then

						htp.p('<li title="'||ws_codigo||'" onclick="document.getElementById('''||prm_browser||''').parentNode.setAttribute(''data-v'', this.title); '||
																'document.getElementById('''||prm_browser||''').innerHTML = this.innerHTML.trim();'||
																'document.getElementById(''fakelist'').classList.toggle(''visible'');'||
																'if (this.parentNode.parentNode.getAttribute(''data-ref'').indexOf(''bEC'') != -1) {document.getElementById('''||prm_browser||''').onblur(); }'||
																'" >'||ws_codigo||' - '||(ws_descricao)||'</li>');
					elsif length(trim(prm_browser)) > 0 and ws_valor = 'ligacao' then --Mostra somente a descricao na lista do Browser/ CARD-437a	
						htp.p('<li title="'||ws_codigo||'" onclick="selecionaFakeList('''||prm_browser||''', this);" >'||(ws_descricao)||'</li>');		
					elsif length(trim(prm_browser)) > 0 and ws_valor = 'ligacaoc' then 
						htp.p('<li title="'||ws_codigo||'" onclick="selecionaFakeList('''||prm_browser||''', this);" >'||ws_codigo||' - '||trim(ws_descricao)||'</li>');	
					else
						htp.p('<li onclick="fakeValue(''fake_datalist'', this);" title="'||trim(ws_codigo)||'">'||ws_codigo||' - '||trim(ws_descricao)||'</li>');
					end if;
				end if; 
			end loop;

			if ws_tot_linhas > prm_rownum then
				htp.p('<li style="font-weight: bold !important; text-align: center !important;" id="load-more" class="link" title="'||fun.lang('Carregar mais 50')||'" onclick="remover(''load-more'', ''r''); var numero = parseInt(document.getElementById(''fake_ajax'').children.length)+50; ajax(''main'', ''fakedatalist'', ''prm_codigo='||prm_codigo||'&prm_descricao='||prm_descricao||'&prm_tabela='||prm_tabela||'&prm_rownum=''+numero+''&prm_text=''+document.getElementById(''filter-value'').value+''&prm_browser='||prm_browser||'&prm_ref='||prm_ref||''', true, ''fake_ajax'');">'||fun.lang('carregar')||' mais 50</li>');
			end if;

			dbms_sql.close_cursor(ws_cursor);
		exception when others then
			htp.p('');
			insert into bi_log_sistema values(sysdate, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||ws_sql||' - FAKEDATALIST', gbl.getUsuario, 'ERRO');
			commit;
		end;
	end if;

end fakedatalist;

procedure dl_view ( prm_view varchar2 default null )  as

	ws_errormsg varchar2(400);
	ws_fail exception;

begin
	/*fcl.refresh_Session;*/
	begin
		delete from ponto_avaliacao where cd_micro_visao = prm_view;
		delete from micro_visao where nm_micro_visao = prm_view;
		delete from micro_coluna where cd_micro_visao = prm_view;
		delete from filtros where micro_visao = prm_view and tp_filtro = 'geral';
		delete from filtros_notify where micro_visao = prm_view;
		delete from filtros where micro_visao = prm_view and tp_filtro = 'objeto';
		delete from linha_calculada where cd_micro_visao = prm_view;
		delete from column_restriction where cd_micro_visao = prm_view;
		commit;

	exception
	when ws_fail then
		htp.p('!alert '||ws_errormsg);
	when others then
		htp.p('!alert Erro ao excluir');
	end;
end dl_view;

PROCEDURE Send_Sms ( Prm_Origem  varchar2 Default Null,
					Prm_Msg     varchar2 Default Null,
					PRM_FONE    vARCHAR2 DEFAULT NULL,
					prm_count   varchar2 default 'NO_NUM' ) AS

	Ws_Id      Varchar2(20);
	Ws_Url     Varchar2(2000);
	Ws_Status  Varchar2(2000);
	Ws_String  Varchar2(2000);
	WS_ERRO    EXCEPTION;

BEGIN
	/*fcl.refresh_Session;*/
	ws_status := 'OK';

	Begin
		if  prm_count = 'NO_NUM' then
			Select Trim(Sid||Serial#||'.'||To_Char(Sysdate,'DDMMYYHHMISS')) Into Ws_Id
			From Sys.V_$session Where Audsid = Sys_Context('userenv','sessionid') And Rownum=1;
		else
			ws_id := prm_count||To_Char(Sysdate,'DDMMYYHHMISS');
		end if;

		ws_url := trim(fun.ret_var('SMS_URL'));
		ws_url := replace(ws_url,'$[ORIGEM]',prm_origem);
		ws_url := replace(ws_url,'$[FONE]',prm_fone);
		ws_url := replace(ws_url,'$[ID]',ws_id);
		ws_url := replace(ws_url,'$[MSG]',prm_msg);

		/*WS_URL := Utl_Url.Escape('http://api.zenvia360.com.br/GatewayIntegration/msgSms.do?account=up.query&code=hHjJu0LKId&dispatch=send&msg='||PRM_Msg||'&from='||prm_ORIGEM||'&to=55'||Prm_Fone||'&id='||Ws_Id||'&schedule='); */

		Begin
				Ws_String  := Utl_Http.Request(ws_url);
		Exception
				When Others Then Ws_Status := 'ERRO 1';
		end;

		If  Substr(Ws_String,1,3) <> '000' Then
			Ws_Status := Ws_String;
		end if;

	Exception
		When Others Then ws_status := 'ERRO 3';
	end;


	Insert Into Sent_Sms Values (USER,PRM_ORIGEM,Sysdate,PRM_FONE,ws_status);
	Commit;

	If  WS_Status <> 'OK' Then
		RAISE WS_ERRO;
	END IF;

END SEND_SMS;


procedure check_data ( prm_valor varchar2 default null,
					prm_tabela varchar2 default null,
					prm_true varchar2 default 'ok',
					prm_false varchar2 default 'error' ) as

ws_count number;
begin
	/*fcl.refresh_Session;*/
	case prm_tabela
		when 'objetos' then
			select count(*) into ws_count from objetos where upper(trim(cod)) = upper(trim(prm_valor));
		when 'visao' then
			select count(*) into ws_count from micro_visao where upper(trim(nm_micro_visao)) = upper(trim(prm_valor));
			htp.p('fail');
		when 'main' then
			select count(*) into ws_count from all_screens where screen = prm_valor and flex_flow = 'row';
		when 'lov' then
			select count(*) into ws_count from codigo_descricao where upper(trim(nds_tabela)) = upper(trim(prm_valor));
		when 'TABELA_FISICA_OBJETO' then
			if nvl(prm_valor,'NA') <> 'NA' then 
				select count(*) into ws_count from all_tables where owner = nvl(fun.ret_var('OWNER_TABLE_DATA'),'DWU') and upper(table_name) = upper(prm_valor);
			end if;	
		else
			select count(*) into ws_count from objetos where upper(trim(cd_objeto)) = upper(trim(prm_valor));
	end case;

	if ws_count = 0 then htp.p(prm_true); else htp.p(prm_false); end if;
end check_data;

procedure object_padrao as

	cursor crs_padroes is
		select t1.tp_objeto, t1.cd_prop, t1.cd_tipo, t1.label, t2.vl_default, t1.sufixo, t1.script, t2.grupo, t2.hint, t2.ordem
		from bi_object_padrao t1
		left join object_padrao t2 on t1.tp_objeto = t2.tp_objeto and t1.cd_prop = t2.cd_prop
		and nvl(t1.sufixo, 'N/A') <> 'N/A'
		order by tp_objeto, ordem, cd_prop;

	ws_padrao crs_padroes%rowtype;

begin
	htp.p('<table class="linha">');
		htp.p('<thead>');
			htp.p('<tr>');
				htp.p('<th>'||fun.lang('TIPO')||'</th>');
				htp.p('<th>'||fun.lang('PROPRIEDADE')||'</th>');
				htp.p('<th>'||fun.lang('DESCRI&Ccedil;&Atilde;O')||'</th>');
				htp.p('<th>DEFAULT</th>');
				/*htp.p('<th>'||fun.lang('GRUPO')||'</th>');
				htp.p('<th>HINT</th>');
				htp.p('<th>'||fun.lang('ORDEM')||'</th>');
				htp.p('<th></th>');*/
			htp.p('</tr>');
		htp.p('</thead>');
		htp.p('<tbody>');
			open crs_padroes;
				loop
					fetch crs_padroes into ws_padrao;
					exit when crs_padroes%notfound;
						htp.p('<tr>');
							htp.p('<td>'||ws_padrao.tp_objeto||'</td>');
							htp.p('<td>'||ws_padrao.cd_prop||'</td>');
							htp.p('<td>'||ws_padrao.label||'</td>');
							htp.p('<td><input type="text" data-default="'||ws_padrao.vl_default||'" onblur="if(this.value != this.getAttribute(''data-default'')){ ajax(''fly'', ''update_padrao'', ''prm_tipo='||ws_padrao.tp_objeto||'&prm_propriedade='||ws_padrao.cd_prop||'&prm_coluna=default&prm_valor=''+this.value); alerta(''msg'', TR_AL); }" value="'||ws_padrao.vl_default||'" /></td>');

						htp.p('</tr>');
				end loop;
			close crs_padroes;
		htp.p('</tbody>');
	htp.p('</table>');
end object_padrao;

procedure add_object_padrao (  prm_obj         varchar2 default null,
							prm_propriedade varchar2 default null,
							prm_tipo        varchar2 default null,
							prm_label       varchar2 default null,
							prm_default     varchar2 default null,
							prm_sufixo      varchar2 default 'gr',
							prm_script      varchar2 default 'rtl',
							prm_validacao   varchar2 default null,
							prm_grupo       varchar2 default 'VISUAL' ) as

	ws_erro exception;

begin

	begin
		insert into object_padrao (tp_objeto, cd_prop, cd_tipo, label, vl_default, sufixo, script, validacao, st_personalizado, ordem, grupo, hint) values (trim(prm_obj), upper(trim(prm_propriedade)), trim(prm_tipo), trim(prm_label), trim(prm_default), trim(prm_sufixo), trim(prm_script), trim(prm_validacao), 'N', 0, trim(prm_grupo), '');
		commit;
		htp.p('OK');
	exception when others then
		rollback;
		raise ws_erro;
	end;

exception
	when ws_erro then
		htp.p('#alert Erro ao adicionar');
	when others then
		htp.p('#alert Erro ao adicionar');
end;

procedure update_padrao ( prm_tipo varchar2 default null,
						prm_propriedade varchar2 default null,
						prm_coluna varchar2 default null,
						prm_valor varchar2 default null ) as

begin
	case prm_coluna
		when 'default' then
			merge into object_padrao t1
			using (select prm_tipo as tipo, prm_propriedade propriedade from dual) t2
			on (t1.tp_objeto = t2.tipo and t1.cd_prop = t2.propriedade)
			when matched then update set vl_default = prm_valor
			when not matched then insert (tp_objeto, cd_prop, vl_default) values (prm_tipo, prm_propriedade, prm_valor);
		when 'hint' then
			update object_padrao
			set hint = prm_valor
			where tp_objeto = prm_tipo and
			cd_prop = prm_propriedade;
		when 'grupo' then
			update object_padrao
			set grupo = prm_valor
			where tp_objeto = prm_tipo and
			cd_prop = prm_propriedade;
		when 'ordem' then
			update object_padrao
			set ordem = prm_valor
			where tp_objeto = prm_tipo and
			cd_prop = prm_propriedade;
		when 'delete' then
			delete from object_padrao
			where tp_objeto = prm_tipo and
			cd_prop = prm_propriedade and rownum = 1;
			insert into bi_log_sistema values(sysdate, 'Padr&atilde;o '''||prm_propriedade||''' excluido', gbl.getUsuario, 'EVENTO');
			commit;
			htp.p('EX');
	end case;
	
exception when others then
	htp.p('#alert '||fun.lang('Erro na altera&ccedil;&atilde;o')||'!');
end update_padrao;




procedure lang_table as

ws_lang_usuario  			varchar2(100);
ws_lang_sistema  			varchar2(100);
ws_texto_original_escape 	varchar2(1000);

cursor crs_traducao_colunas is
	select DISTINCT texto as texto_original , 
		((SELECT TEXTO 
			FROM TRADUCAO_COLUNAS ING
			WHERE ING.CD_LINGUAGEM   = ws_lang_usuario
			AND ING.LANG_DEFAULT   = PTG.LANG_DEFAULT 
			AND ING.CD_TABELA      = PTG.CD_TABELA 
			AND ING.CD_COLUNA      = PTG.CD_COLUNA 
			and rownum = 1
		)) AS texto_traduzido
	from traducao_colunas PTG 
	where CD_LINGUAGEM = ws_lang_sistema
	order by 1 ;   
begin

	ws_lang_sistema := 'PORTUGUESE';
	ws_lang_usuario := gbl.getlang;
	--
	htp.p('<table class="linha">');
		htp.p('<thead>');
		htp.p('<tr>');
			htp.p('<th style="width: 50%;">'||ws_lang_usuario||'</th>');
			htp.p('<th style="width: 50%;">'||ws_lang_usuario||'</th>');
		htp.p('</tr>');
		htp.p('</thead>');
		htp.p('<tbody>');
			for i in crs_traducao_colunas loop
				ws_texto_original_escape := utl_url.escape(i.texto_original, true, 'UTF-8');  		-- usar UTF-8, mesmo do navegador 		
				htp.p('<tr>');
					htp.p('<td style="width: 50%; white-space: nowrap; max-width: 300px; text-overflow: ellipsis; overflow: hidden;" title="'||i.texto_original||'">'||i.texto_original||'</td>');
					--htp.p('<td style="width: 50%"><input type="text" class="'||ws_padrao.ingles||'" value="'||ws_padrao.ingles||'" onblur="if(this.value != this.className){ if(this.value.trim().length > 0){ ajax(''fly'', ''update_lang_table'', ''prm_default='||ws_padrao.texto||'&prm_texto=''+this.value+''&prm_linguagem=ENGLISH''); noerror(''TRADU&Ccedil;&Atilde;O ALTERADA COM SUCESSO!'', '''||ws_padrao.texto||'-alert''); this.setAttribute(''class'', this.value); } else { alerta('''||ws_padrao.texto||'-alert'', ''N&Atilde;O PODE ESTAR EM BRANCO!'') }}"/></td>');
					IF ws_lang_sistema <> ws_lang_usuario then 
					htp.p('<td style="width: 50%"><input type="text" class="'||i.texto_traduzido||'" value="'||i.texto_traduzido||'" onblur="if(this.value != this.className){ if(this.value.trim().length > 0){ ajax(''fly'', ''update_lang_table'', ''prm_default='||ws_texto_original_escape||'&prm_texto=''+encodeURIComponent(this.value)+''&prm_linguagem='||ws_lang_usuario||'''); alerta(''feed-fixo'', ''TRADU&Ccedil;&Atilde;O ALTERADA COM SUCESSO!''); this.setAttribute(''class'', this.value); } else { alerta(''feed-fixo'', ''N&Atilde;O PODE ESTAR EM BRANCO!'') }}"/></td>');						
						-- htp.p('<td style="width: 50%"><input type="text" class="'||i.texto_traduzido||'" value="'||i.texto_traduzido||'" onblur="if(this.value != this.className){ if(this.value.trim().length > 0){ ajax(''fly'', ''update_lang_table'', ''prm_default=''+encodeURIComponent('''||i.texto_original||''')+''&prm_texto=''+encodeURIComponent(this.value)+''&prm_linguagem='||ws_lang_usuario||'''); alerta(''feed-fixo'', ''TRADU&Ccedil;&Atilde;O ALTERADA COM SUCESSO!''); this.setAttribute(''class'', this.value); } else { alerta(''feed-fixo'', ''N&Atilde;O PODE ESTAR EM BRANCO!'') }}"/></td>');						
						--htp.p('<td style="width: 50%"><input type="text" class="'||i.texto_traduzido||'" value="'||i.texto_traduzido||'" onblur="if(this.value != this.className){ if(this.value.trim().length > 0){ ajax(''fly'', ''update_lang_table'', ''prm_default='||i.texto_original||'&prm_texto=''+encodeURIComponent(this.value)+''&prm_linguagem='||ws_lang_usuario||'''); alerta(''feed-fixo'', ''TRADU&Ccedil;&Atilde;O ALTERADA COM SUCESSO!''); this.setAttribute(''class'', this.value); } else { alerta(''feed-fixo'', ''N&Atilde;O PODE ESTAR EM BRANCO!'') }}"/></td>');												
						--htp.p('<td style="width: 50%"><input type="text" class="'||i.texto_traduzido||'" value="'||i.texto_traduzido||'" onblur="if(this.value != this.className){ if(this.value.trim().length > 0){ ajax(''fly'', ''update_lang_table'', ''prm_default='||i.texto_original||'&prm_texto=''+this.value+''&prm_linguagem='||ws_lang_usuario||'''); noerror(''TRADU&Ccedil;&Atilde;O ALTERADA COM SUCESSO!'', '''||i.texto_original||'-alert''); this.setAttribute(''class'', this.value); } else { alerta('''||i.texto_original||'-alert'', ''N&Atilde;O PODE ESTAR EM BRANCO!'') }}"/></td>');						
					else 
						htp.p('<td style="width: 50%; white-space: nowrap; max-width: 300px; text-overflow: ellipsis; overflow: hidden;" title="'||i.texto_traduzido||'">'||i.texto_traduzido||'</td>');	
					end if; 	
				htp.p('</tr>');
				htp.p('<tr><td></td><td class="alert" id="'||i.texto_original||'-alert"></td></tr>');
			end loop;
		htp.p('</tbody>');
	htp.p('</table>');

end lang_table;



procedure update_lang_table ( prm_default varchar2 default null,
								prm_texto varchar2 default null,
								prm_linguagem varchar2 default null ) as
ws_lang_sistema  	  varchar2(100);
ws_default            varchar2(1000);
begin

	ws_lang_sistema     := 'PORTUGUESE'; 

	update traducao_colunas
	set texto = fun.converte(prm_texto)
	where lang_default = fun.converte(prm_default) 
	and cd_linguagem = prm_linguagem;

	if SQL%NOTFOUND then 
		insert into traducao_colunas 
		(select distinct cd_tabela, cd_coluna, prm_linguagem, prm_texto, lang_default, tipo, fixa 
			from traducao_colunas 
			where cd_linguagem =  ws_lang_sistema -- Idioma padrão do sistema  
			and lang_default  = fun.converte(prm_default)
		); 		   
	end if;
exception
	when others then
		insert into bi_log_sistema (dt_log, ds_log, nm_usuario, nm_procedure) values(sysdate, 'Erro: '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, gbl.getUsuario, 'EVENTO');
		htp.p('ERRO|'||fun.lang('Erro atualizando tradu&ccedil;&atilde;o') );
end update_lang_table;



procedure painel as

begin

	htp.p('<ul style="display: flex;flex-flow: row wrap;">');
		
		htp.p('<li style="display: flex; align-items: center; border: 1px solid #777; background-color: #FEFEFE; padding: 4px; border-radius: 2px;" title="MENU A DIREITA DESLIZAR AO PASSAR O MOUSE">');
			htp.p('<span style="width: 190px; font-family: &quot;montserrat&quot;; font-weight: bold; font-size: 18px; COLOR: #333;">MENU DESLIZANTE</span>');
			htp.p('<span class="checkbox" title="N"></span>');
		htp.p('</li>');
		
		htp.p('<li style="display: flex; align-items: center; border: 1px solid #777; background-color: #FEFEFE; padding: 4px; border-radius: 2px;" title="ICONE DE LINGUAGEM DO LADO DO TEXTO">');
			htp.p('<span style="width: 190px; font-family: &quot;montserrat&quot;; font-weight: bold; font-size: 18px; COLOR: #333;">LINGUAGEM</span>');
			htp.p('<span class="checkbox" title="N"></span>');
		htp.p('</li>');

		htp.p('<li style="display: flex; align-items: center; border: 1px solid #777; background-color: #FEFEFE; padding: 4px; border-radius: 2px;" title="ICONE DE LINGUAGEM DO LADO DO TEXTO">');
			htp.p('<span style="width: 190px; font-family: &quot;montserrat&quot;; font-weight: bold; font-size: 18px; COLOR: #333;">ETL</span>');
			htp.p('<span class="checkbox" title="N"></span>');
		htp.p('</li>');

	htp.p('</ul>');

exception
	when others then
		htp.print(sqlerrm);
end painel;

procedure gera_conteudo (  ws_excel in out clob,
						prm_saida varchar2 default null,
						prm_excel varchar2 default null,
						prm_pdf varchar2 default null,
						prm_csv varchar2 default null ) as

begin
	if prm_saida in ('S','O','H') then
		ws_excel := ws_excel||prm_excel;
	end if;

end gera_conteudo;



procedure template ( prm_objeto varchar2 default null,
					prm_valor varchar2 default null,
					prm_view  varchar2 default null ) as

	ws_count   number;
	ws_usuario varchar2(80);
begin

	ws_usuario := gbl.getUsuario;

	select count(*) into ws_count from object_attrib where owner = ws_usuario and cd_prop = 'TPT' and cd_object = prm_objeto and screen = prm_view;

	if ws_count = 1 then
		update object_attrib
		set propriedade = prm_valor
		where owner = ws_usuario and
		cd_prop = 'TPT' and
		screen = prm_view and
		cd_object = prm_objeto;
		commit;
		update object_attrib
		set propriedade = '1'
		where owner = ws_usuario and
		cd_prop = 'ORDEM' and
		screen = prm_view and
		cd_object = prm_objeto;
		commit;
	elsif ws_count = 0 then
		insert into OBJECT_ATTRIB values(ws_usuario, 'DEFAULT', prm_view, UPPER(prm_objeto), 'TPT', prm_valor);
		update object_attrib
		set propriedade = '1'
		where owner = ws_usuario and
		cd_prop = 'ORDEM' and
		screen = prm_view and
		cd_object = prm_objeto;
		commit;
	else
		htp.p('#alert '||fun.lang('Erro ao alterar')||'!');
	end if;
exception when others then
	htp.p(sqlerrm);

end template;

procedure sqlparse as

	ws_usuario  varchar2(80);
	ws_noaccess exception;
begin

	ws_usuario := gbl.getUsuario;

	if ws_usuario = 'NOUSER' or gbl.getNivel <> 'A' then
		raise ws_noaccess;
	end if;

	delete from BI_LOG_QUERY where dt_log <= sysdate - 1;

	htp.p('<div id="exec_query" style="width: 100%; height: 98%;" onkeypress="if(event.which == 13 && event.ctrlKey === true){ document.getElementById(''painel'').children[1].click(); }" >');
		--htp.p('<textarea id="sqlquery" value="" onkeypress="if(event.which == 13 && event.ctrlKey === true){ document.getElementById(''painel'').children[1].click(); }" onmouseout="document.getElementById(''selecionado'').value = this.value.substring(this.selectionStart, this.selectionEnd);" ></textarea>');
		htp.p('<div id="sqlquery"></div>');
		htp.p('<a class="addpurple" onclick="execute_sql(''N'', ''11'');" title="10 primeiras linhas">'||fun.lang('EXECUTAR')||'</a>');
		htp.p('<a class="addpurple" onclick="execute_sql(''N'', ''999999999'');" title="tudo">'||fun.lang('EXECUTAR COMPLETO')||'</a>');
		htp.p('<a id="logs_recentes" title="'||fun.lang('LOGS RECENTES')||'" onclick="ver_logs()"><svg height="512" viewBox="0 0 64 64" width="512" xmlns="http://www.w3.org/2000/svg"><g id="log-file"><path d="m25 27h6v10h-6z"/><path d="m56 16h-9a3 3 0 0 1 -3-3v-9h-26v17h35a1 1 0 0 1 1 1v20a1 1 0 0 1 -1 1h-35v13h38z"/><path d="m54.586 14-8.586-8.586v7.586a1 1 0 0 0 1 1z"/><path d="m60 8h-8.586l6.293 6.293a1 1 0 0 1 .293.707v42a1 1 0 0 1 -1 1h-35v2h38z"/><path d="m52 23h-48v18h48zm-31 16h-9a1 1 0 0 1 -1-1v-13h2v12h8zm12-1a1 1 0 0 1 -1 1h-8a1 1 0 0 1 -1-1v-12a1 1 0 0 1 1-1h8a1 1 0 0 1 1 1zm12-9h-2v-2h-6v10h6v-4h-3v-2h4a1 1 0 0 1 1 1v6a1 1 0 0 1 -1 1h-8a1 1 0 0 1 -1-1v-12a1 1 0 0 1 1-1h8a1 1 0 0 1 1 1z"/></g></svg></a>');
		
		htp.p('<div id="sqloutput">');
		htp.p('<table id="queryresult2"></table>');
		htp.p('<table id="queryresult"></table>');
		htp.p('<div id="count"></div>');
		htp.p('</div>');
	htp.p('</div>');

exception
	when ws_noaccess then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(sqlerrm);
end sqlparse;

procedure mapmarker ( prm_objeto varchar2 default null ) as

ws_sql           varchar2(2000);
ws_cursor        integer;
ws_nome          varchar2(300);
ws_localizacao   varchar2(400);
ws_longitude     varchar2(300);
ws_latitude      varchar2(300);
ws_info          varchar2(300);
ws_linhas        integer;

begin

	--ws_sql := 'select '||fun.getprop(prm_objeto, 'NAME')||', '||fun.getprop(prm_objeto, 'LAT')||', '||fun.getprop(prm_objeto, 'LON')||', '||fun.getprop(prm_objeto, 'INFO')||
	--          ' from '||(fun.getprop(prm_objeto, 'TABELA')||'');


	ws_sql := 'select nm_navio, latitude, longitude, ds_navio from vm_navio_coordenada';

	ws_cursor := dbms_sql.open_cursor;

	dbms_sql.parse(ws_cursor, ws_sql, DBMS_SQL.NATIVE);

	dbms_sql.define_column(ws_cursor, 1, ws_nome, 300);
	dbms_sql.define_column(ws_cursor, 2, ws_latitude, 300);
	dbms_sql.define_column(ws_cursor, 3, ws_longitude, 300);
	dbms_sql.define_column(ws_cursor, 4, ws_info, 300);

	ws_linhas := dbms_sql.execute(ws_cursor);

	loop
		if dbms_sql.fetch_rows(ws_cursor) = 0 THEN
			exit;
		end if;
		dbms_sql.column_value(ws_cursor, 1, ws_nome);
		dbms_sql.column_value(ws_cursor, 2, ws_latitude);
		dbms_sql.column_value(ws_cursor, 3, ws_longitude);
		dbms_sql.column_value(ws_cursor, 4, ws_info);

		htp.p(''||ws_nome||'| '||ws_latitude||'| '||ws_longitude||'| '||ws_info||'/');
	end loop;

	dbms_sql.close_cursor(ws_cursor);

exception when others then
	insert into bi_log_sistema values(sysdate, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - MAPMARKER', gbl.getUsuario, 'ERRO');
	commit;
end mapmarker;


procedure favoritar ( prm_favorito   number   default null,
					prm_objeto     varchar2 default null,
					prm_nome       varchar2 default null,
					prm_url        varchar2 default null,
					prm_screen     varchar2 default null,
					prm_parametros varchar2 default null,
					prm_dimensao   varchar2 default null,
					prm_medida     varchar2 default null,
					prm_pivot      varchar2 default null,
					prm_acao       varchar2 default 'incluir' ) as

	ws_usuario    varchar2(80);
	ws_admin      varchar2(10); 
	
cursor c_fav is 
	select t1.cd_favorito, t1.ds_nome, t1.ordem, t1.usuario, t1.screen, t1.parametros, t1.cd_objeto, t2.descricao, t3.nm_objeto, t3.tp_objeto 
	from favoritos        t1 
	left join all_screens t2 on t2.screen    = t1.screen  
	left join objetos     t3 on t3.cd_objeto = t1.cd_objeto 
	where t1.usuario = ws_usuario 
		and ( (prm_acao = 'list_tela' and t3.tp_objeto = 'SCREEN' and fun.check_screen_access(t1.cd_objeto, ws_usuario, ws_admin) > 0 ) or 
			(prm_acao <> 'list_tela' and t3.tp_objeto <> 'SCREEN' and t1.screen = prm_screen) ) 
	order by t1.ordem, t1.ds_nome ; 	 

	ws_count      number;
	ws_qt_existe  number; 
	ws_cd_objeto  varchar2(100);
	ws_nm_objeto  varchar2(100);
	ws_tp_objeto  varchar2(20); 
	ws_screen     varchar2(100);
	ws_ordem      number(4); 

begin

	ws_usuario := gbl.getUsuario;
	ws_admin   := gbl.getNivel; 

	select nvl(max(cd_favorito),0)+1 into ws_count from favoritos;

	if prm_acao in ('incluir','incluir_tela') then
		ws_cd_objeto := fun.get_cd_obj(prm_objeto); 
		ws_nm_objeto := null;
		ws_tp_objeto := null;
		begin 
			select cd_objeto, substr(nm_objeto,1,100), trim(substr(tp_objeto,1,20))
			into ws_cd_objeto, ws_nm_objeto, ws_tp_objeto 
			from objetos
			where cd_objeto = trim(ws_cd_objeto)
			and rownum    = 1;
		exception when others then null ;
			ws_cd_objeto := null;
		end; 	  

		ws_qt_existe := 0 ;
		if prm_acao = 'incluir_tela' then
			ws_screen    := ws_cd_objeto;
			select count(*) into ws_qt_existe 
			from favoritos
			where cd_objeto = ws_cd_objeto
			and usuario   = ws_usuario;
		else 
			ws_screen    := prm_screen;
			ws_nm_objeto := prm_nome;
		end if; 

		if ws_qt_existe = 0 and ws_cd_objeto is not null then 
			insert into favoritos ( cd_favorito, ds_nome     , url    , usuario   , screen   , parametros, cd_objeto, dimensao, medida, pivot ) 
						values ( ws_count,    ws_nm_objeto, prm_url, ws_usuario, ws_screen, prm_parametros, ws_cd_objeto, prm_dimensao, prm_medida, prm_pivot );
			commit;
		end if; 

		if prm_acao = 'incluir_tela' then
			if ws_cd_objeto is null then 
				htp.p('ERRO|'||fun.lang('Tela inv&aacutelida para adi&ccedil;&atilde;o aos Favoritos')||'!');
			elsif ws_qt_existe > 0 then 
				htp.p('ERRO|'||fun.lang('Tela j&aacute; adicionada aos Favoritos')||'!');
			else 
				htp.p('OK|'||fun.lang('Tela adicionada com sucesso')||'!');
			end if; 
		else 
			if ws_cd_objeto is null then 
				htp.p('!alert '||fun.lang('Objeto inv&aacutelido para adi&ccedil;&atilde;o aos Favoritos')||'!');
			else 	
				htp.p('!alert '||fun.lang('Adicionado com sucesso')||'!');
			end if; 	
		end if; 	
	elsif prm_acao = 'alterar' then
		update favoritos set ds_nome = prm_nome where cd_favorito = prm_favorito;
		commit;
		htp.p('!alert '||fun.lang('Alterado com sucesso')||'!');

	elsif prm_acao = 'alterar_ordem' then
		ws_ordem := null;
		begin 
			ws_ordem := prm_nome;
		exception when others then null;
		end; 	
		if ws_ordem is null then 
			htp.p('!alert '||fun.lang('Ordem n&atilde;o &eacute; um n&uacute;mero v&aacute;lido')||'!');		
		else 
			update favoritos set ordem = ws_ordem where cd_favorito = prm_favorito;
			commit;
			htp.p('!alert '||fun.lang('Alterado com sucesso')||'!');
		end if; 	
	
	elsif prm_acao = 'list' then

		htp.p('<h2 style="text-align: left;">DRILLS FAVORITAS</h2>');
		htp.p('<table class="linha">');
			htp.p('<thead>');
				htp.p('<tr>');
					htp.p('<th title="Nome/descri&ccedil;&atilde;o da drill.">'             ||fun.lang('NOME')||'</th>');
					htp.p('<th title="C&oacute;digo interno da drill/objeto.">'             ||fun.lang('ID')||'</th>');
					htp.p('<th title="Texto mostrado no bot&atilde;o/atalho para a drill.">'||fun.lang('TEXTO DO BOT&Atilde;O')||'</th>');
					htp.p('<th title="Ordem da drillna lista de favoritos.">'               ||fun.lang('ORDEM')||'</th>');
					htp.p('<th></th>');
				htp.p('</tr>');
			htp.p('</thead>');
			htp.p('<tbody>');
				for i in c_fav  loop
					htp.p('<tr title="'||i.parametros||'">');
						htp.p('<td title="'||i.descricao||' ('||i.screen||')'||'">'||i.descricao||'</td>');
						htp.p('<td title="'||i.nm_objeto||' ('||i.cd_objeto||')'||'">'||i.nm_objeto||'</td>');
						htp.p('<td><input value="'||i.ds_nome||'" data-padrao="'||i.ds_nome||'" placeholder="'||fun.lang('TEXTO DO BOT&Atilde;O')||'" onblur="var valor = this.value; if(valor.length > 0){ ajax(''fly'', ''favoritar'', ''prm_favorito='||i.cd_favorito||'&prm_objeto='||i.cd_objeto||'&prm_nome=''+encodeURIComponent(valor)+''&prm_parametros=''+encodeURIComponent('''||i.parametros||''')+''&prm_screen='||i.screen||'&prm_acao=alterar'', false); this.setAttribute(''data-padrao'', this.value); }"/></td>');
						htp.p('<td><input type="number" value="'||i.ordem||'" data-padrao="'||i.ordem||'" placeholder="'||fun.lang('N&Uacute;MERO DA ORDEM')||'"      onblur="var valor = this.value; if(valor.length > 0){ ajax(''fly'', ''favoritar'', ''prm_favorito='||i.cd_favorito||'&prm_objeto='||i.cd_objeto||'&prm_nome=''+encodeURIComponent(valor)+''&prm_parametros=''+encodeURIComponent('''||i.parametros||''')+''&prm_screen='||i.screen||'&prm_acao=alterar_ordem'', false); this.setAttribute(''data-padrao'', this.value); }"/></td>');						
						htp.p('<td>');
							fcl.button_lixo('favoritar','prm_favorito|prm_objeto|prm_acao', i.cd_favorito||'|'||i.cd_objeto||'|'||'excluir', prm_tag => 'a', prm_title => 'Remover drill da lista de favoritos.');
						htp.p('</td>');
					htp.p('</tr>');
				end loop;
			htp.p('</tbody>');
		htp.p('</table>');
	elsif prm_acao = 'list_tela' then
		htp.p('<h2 style="text-align: left;">TELAS FAVORITAS</h2>');
		htp.p('<table class="linha">');
			htp.p('<thead>');
				htp.p('<tr>');
					htp.p('<th title="Nome/descri&ccedil;&atilde;o da tela.">'             ||fun.lang('NOME')||'</th>');
					htp.p('<th title="C&oacute;digo interno da tela.">'                    ||fun.lang('ID')||'</th>');
					htp.p('<th title="Texto mostrado no bot&atilde;o/atalho para a tela.">'||fun.lang('TEXTO DO BOT&Atilde;O')||'</th>');
					htp.p('<th title="Ordem da tela na lista de favoritos.">'              ||fun.lang('ORDEM')||'</th>');
					htp.p('<th></th>');
				htp.p('</tr>');
			htp.p('</thead>');
			htp.p('<tbody>');
				for i in c_fav loop
					htp.p('<tr title="'||i.parametros||'">');
						htp.p('<td title="'||i.descricao||'">'||i.descricao||'</td>');
						htp.p('<td title="'||i.cd_objeto||'">'||i.cd_objeto||'</td>');
						htp.p('<td><input value="'||i.ds_nome||'" data-padrao="'||i.ds_nome||'" placeholder="'||fun.lang('TEXTO DO BOT&Atilde;O')||'" onblur="var valor = this.value; if(valor.length > 0){ ajax(''fly'', ''favoritar'', ''prm_favorito='||i.cd_favorito||'&prm_objeto='||i.cd_objeto||'&prm_nome=''+encodeURIComponent(valor)+''&prm_parametros=''+encodeURIComponent('''||i.parametros||''')+''&prm_screen='||i.screen||'&prm_acao=alterar'', false); this.setAttribute(''data-padrao'', this.value); document.getElementById(''id_atualizar_menu'').value = ''S'';}"/></td>');
						htp.p('<td><input type="number" value="'||i.ordem||  '" data-padrao="'||i.ordem||  '" placeholder="'||fun.lang('N&Uacute;MERO DA ORDEM')|| '" onblur="var valor = this.value; if(valor.length > 0){ ajax(''fly'', ''favoritar'', ''prm_favorito='||i.cd_favorito||'&prm_objeto='||i.cd_objeto||'&prm_nome=''+encodeURIComponent(valor)+''&prm_parametros=''+encodeURIComponent('''||i.parametros||''')+''&prm_screen='||i.screen||'&prm_acao=alterar_ordem'', false); this.setAttribute(''data-padrao'', this.value); document.getElementById(''id_atualizar_menu'').value = ''S'';}"/></td>');						
						htp.p('<td>');
							fcl.button_lixo('favoritar','prm_favorito|prm_objeto|prm_acao', i.cd_favorito||'|'||i.cd_objeto||'|'||'excluir', prm_tag => 'a', prm_title => 'Remover tela da lista de favoritos.');
						htp.p('</td>');
					htp.p('</tr>');
				end loop;
			htp.p('</tbody>');
		htp.p('</table>');		
	else
		delete from favoritos where cd_favorito = prm_favorito;
		commit;
		htp.p('!alert '||fun.lang('Removido com sucesso')||'!');
	end if ;
exception
	when others then
		htp.p(sqlerrm);
		insert into bi_log_sistema values(sysdate, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - FAVORITAR', ws_usuario, 'ERRO');
		commit;
end favoritar;

procedure Forcelogoff ( prm_nome varchar2 default null, prm_session varchar2 default null ) as

	ws_id_session varchar2(80);
	ws_cmd        varchar2(4000);
begin

	Update Active_Sessions
	Set Status = 'I'
	Where Status ='A' and usuario = gbl.getUsuario;

	--owa_cookie.send('WDB_GATEWAY_LOGOUT', 'YES', path=>'/');
	Owa_Cookie.Send(prm_nome, prm_session, Sysdate - 1);
	Owa_Cookie.remove(prm_nome, prm_session);

end Forcelogoff;

procedure passagem_test ( picado IN owa_util.vc_arr,
						nome varchar2 default null,
						parseonly varchar2 default 'S' ) as

	v_intCur         pls_integer;
	v_intIdx         pls_integer;
	v_intNumRows     pls_integer;
	ws_query         dbms_sql.varchar2a;
	ws_err           varchar2(400) := '';
	ws_exist         exception;
	

begin
	
	ws_query(1) := 'Create or replace force view '||upper(trim(nome))||' as ';
	v_intIdx := 1;
	for i in picado.FIRST..picado.LAST
	loop
		if nvl(trim(picado(i)), '%*%') <> '%*%' then
			v_intIdx := v_intIdx + 1;
			ws_query(v_intIdx) := picado(i);
		end if;
	end loop;

	begin
		v_intCur := dbms_sql.open_cursor;
		dbms_sql.parse( c => v_intCur, statement => ws_query, lb => 1, ub => v_intIdx, lfflg => false, language_flag => dbms_sql.native);
		if trim(parseonly) <> 'S' then
			v_intNumRows := dbms_sql.execute(v_intCur);
			htp.p('passed');
		end if;
		dbms_sql.close_cursor(v_intCur);

	exception when others then
		begin
			SELECT LISTAGG(TEXT, ' ') within group (order by TEXT) into ws_err FROM USER_ERRORS WHERE NAME = upper(nome);
		end;
		htp.p('#alert '||DBMS_UTILITY.FORMAT_ERROR_STACK||' '||ws_err);
	end;

end passagem_test;

procedure VERIFICA_JOB as

ws_verifica  numeric;
ws_job       numeric;
ws_next      date;
ws_broken    char(1);
ws_ok        exception;
ws_usuario   varchar2(80);

ws_owner        varchar2(90);
ws_name         varchar2(90);
ws_line         number;
ws_caller       varchar2(90);

BEGIN

	select count(*) into ws_verifica
	from all_jobs
	where upper(what) like 'SCH.MAIN;'
	and upper(schema_user) = nvl(upper(fun.ret_var('OWNER_BI')),'DWU');

	if ws_verifica <> 0 then

		select broken, next_date, job into ws_broken, ws_next, ws_job
		from all_jobs
		where upper(what) like 'SCH.MAIN;'
		and upper(schema_user) = nvl(upper(fun.ret_var('OWNER_BI')),'DWU');
			
		if ws_broken = 'Y' then
			insert into Log_Eventos Values(Sysdate , 'REATIVANDO SCH!', 'DWU', 'VRF_SCH', 'ERRO', '0');
			dbms_job.remove(ws_job);
			dbms_job.submit(ws_job, 'SCH.MAIN;', sysdate, 'SYSDATE + 60/86400');
		end if;

	else

		OWA_UTIL.WHO_CALLED_ME(ws_owner, ws_name, ws_line, ws_caller);

		insert into log_eventos Values(Sysdate , 'ERRO SEM SCH!' , 'DWU', 'VRF_SCH' , 'ERRO', '0');
		dbms_job.submit(ws_job, 'SCH.MAIN;', sysdate, 'SYSDATE + 60/86400');

	end if;

	commit; 

exception
	when ws_ok then 
		null;
	when others then
		htp.p(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
		Insert Into Log_Eventos Values(Sysdate , DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, 'DWU', 'VRF_JOB', 'ERRO', '0');
END VERIFICA_JOB;

/***** desativado 06/11/2023 - ivanor 
PROCEDURE REG_PULSE as

	ws_pending      number;
	ws_string       varchar2(1000);
	ws_command      varchar2(3000);
	ws_error        varchar2(80);

begin

	ws_command := 'localhost/update/'||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.renew?prm_par=TIPO|008|CLIENTE|'||fun.ret_var('CLIENTE')||'|CHECK|'||fun.ret_var('TOKEN')||'|CHAVE|'||fun.check_id(fun.ret_var('TOKEN'), fun.ret_var('CLIENTE'));

	ws_string  := utl_http.request(ws_command);

	ws_string := trim(replace(ws_string,chr(10),''));

	if substr(trim(ws_string), 1, 6) <> 'CHECK=' then
		if instr(trim(ws_string), '403') > 0 then
			insert into log_eventos values(sysdate, ws_string||' SEM PREMISS&Atilde;O!',gbl.getUsuario, 'REG_OFF', 'OFF', '01');
			commit;
		else
			insert into log_eventos values(sysdate, ws_string||' FALHA NO PULSE!',gbl.getUsuario, 'REG_OFF', 'OFF', '01');
			commit;
		end if;
	else
		fcl.put_var('TOKEN', substr(ws_string, 7, length(ws_string)));
	end if;

end REG_PULSE;
*******************************/ 


procedure PUT_VAR ( PRM_VARIAVEL VARCHAR2 DEFAULT NULL,
					PRM_CONTEUDO VARCHAR2 DEFAULT NULL ) as
											
	WS_COUNT NUMBER;
BEGIN

	BEGIN
		SELECT COUNT(*) INTO WS_COUNT FROM VAR_CONTEUDO WHERE VARIAVEL = PRM_VARIAVEL;
		IF WS_COUNT = 0 THEN
			INSERT INTO VAR_CONTEUDO (usuario, variavel, data, conteudo, locked) 
				VALUES('DWU', PRM_VARIAVEL, SYSDATE, PRM_CONTEUDO, 'N');
			commit;
		else
			update var_conteudo 
			set conteudo = PRM_CONTEUDO
			where upper(trim(variavel)) = upper(trim(prm_variavel));
			commit;
			
		end if;
	EXCEPTION WHEN OTHERS THEN
		htp.p(SQLERRM);
	END;
END PUT_VAR;


procedure loginScreen as

	ws_cor_tela      varchar2(10);
	ws_url_tela      varchar2(400);
	ws_chave         varchar2(100);
begin

		begin
			select nvl(cor_fundo, '#FFFFFF'), nvl(url_fundo, fun.r_gif('bg','PNG')) into ws_cor_tela, ws_url_tela from all_screens where screen = 'DEFAULT' and rownum = 1;
			--if instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'Safari/') <> 0 and instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'Chrome/') = 0 then
			--	select nvl(cor_fundo, '#FFFFFF'), nvl(url_fundo, fun.r_gif('bg','JPG')) into ws_cor_tela, ws_url_tela from all_screens where screen = 'DEFAULT' and rownum = 1;
			--else	
			--	select nvl(cor_fundo, '#FFFFFF'), nvl(url_fundo, fun.r_gif('bg','PNG')) into ws_cor_tela, ws_url_tela from all_screens where screen = 'DEFAULT' and rownum = 1;
			--end if;
		exception when others then
			ws_cor_tela := '#FFFFFF';
			ws_url_tela := fun.r_gif('bg','PNG');
			--if instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'Safari/') <> 0 and instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'Chrome/') = 0 then
			--	ws_url_tela := fun.r_gif('bg','JPG');
			--else
			--	ws_url_tela := fun.r_gif('bg','PNG');
			--end if;
		end;
			htp.p('<div id="wall">');
				htp.p('<div id="texto-inicial">');
					htp.p('<span>CONFIAN&Ccedil;A</span>');
					htp.p('<span>PARA</span>');
					htp.p('<span>DECIDIR</span>');
				htp.p('</div>');
				htp.p('<div id="login-menu" style="">');
					htp.p('<h1>LOGIN</h1>');
					htp.p('<form action="login" method="post">');
						htp.p('<span class="input-container">');
							htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 412.333 412.333" style="enable-background:new 0 0 412.333 412.333;" xml:space="preserve"> <g> <path d="M206.167,205.333c56.61,0,102.667-46.056,102.667-102.667S262.777,0,206.167,0S103.5,46.056,103.5,102.667 S149.556,205.333,206.167,205.333z M206.167,40c34.554,0,62.667,28.112,62.667,62.667s-28.112,62.667-62.667,62.667 S143.5,137.221,143.5,102.667S171.612,40,206.167,40z"/> <path d="M206.167,223.333c-93.187,0-169,75.813-169,169v20h338v-20C375.167,299.146,299.354,223.333,206.167,223.333z M78.714,372.333c9.637-61.671,63.12-109,127.452-109s117.815,47.329,127.452,109H78.714z"/> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
							htp.p('<input name="prm_usuario" class="login-session" type="text" required autocomplete="username email" value="" placeholder="'||fun.lang('Usu&aacute;rio ou email')||'" onkeypress="if(event.which == ''13''){ document.querySelectorAll(''.login-session'')[1].focus(); }">');
						htp.p('</span>');

						htp.p('<span class="input-container">');
							htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 491.213 491.213" style="enable-background:new 0 0 491.213 491.213;" xml:space="preserve"> <g> <path d="M383.169,66.283c-6.677,0-12.956,2.6-17.677,7.322c-4.722,4.722-7.323,11-7.323,17.678c0,6.677,2.601,12.956,7.323,17.677 c4.722,4.722,11,7.323,17.677,7.323c6.678,0,12.956-2.601,17.678-7.323c4.722-4.722,7.322-11,7.322-17.677 c0-6.678-2.6-12.956-7.322-17.678C396.125,68.883,389.848,66.283,383.169,66.283z"/> <path d="M439.462,34.99C416.898,12.426,386.898,0,354.988,0c-31.91,0-61.91,12.426-84.474,34.99 c-17.276,17.275-28.704,39.072-33.049,63.033c-3.618,19.953-2.156,40.243,4.204,59.273L16.817,382.152l109.061,109.062l63.64-63.64 l-19.434-19.434l21.213-21.213l19.434,19.434l63.64-63.64l-33.576-33.576l76.36-76.36c12.173,4.069,24.869,6.126,37.866,6.126 c31.9,0,61.888-12.42,84.441-34.974C486.041,157.359,486.041,81.569,439.462,34.99z M418.249,182.725 c-16.887,16.887-39.341,26.187-63.228,26.187c-12.363,0-24.352-2.479-35.635-7.369l-9.358-4.056L198.368,309.145l33.576,33.576 l-21.213,21.213L191.297,344.5l-63.639,63.64l19.433,19.434l-21.213,21.213l-66.635-66.635l217.723-217.726l-4.056-9.359 c-14.702-33.924-7.316-72.73,18.817-98.863C308.625,39.306,331.092,30,354.988,30s46.363,9.306,63.26,26.203 C453.131,91.085,453.131,147.843,418.249,182.725z"/> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
							htp.p('<input name="prm_password" class="login-session" type="password" required autocomplete="password" value="" placeholder="'||fun.lang('Senha')||'" onkeypress="if(event.which == ''13''){ login(this.nextElementSibling); }">');
							htp.p('<svg onclick="if(this.previousElementSibling.type === ''password''){ this.previousElementSibling.type = ''text''; } else { this.previousElementSibling.type = ''password''; }" class="reveal" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 487.55 487.55" style="enable-background:new 0 0 487.55 487.55;" xml:space="preserve"> <g> <g id="XMLID_1992_"> <path id="XMLID_2003_" d="M244.625,171.415c-40,0-72.4,32.4-72.4,72.4s32.4,72.4,72.4,72.4s72.4-32.4,72.4-72.4 C316.925,203.815,284.525,171.415,244.625,171.415z M244.625,220.215c-13,0-23.6,10.6-23.6,23.6c0,6-4.8,10.8-10.8,10.8 s-10.8-4.8-10.8-10.8c0-24.9,20.3-45.2,45.2-45.2c6,0,10.8,4.8,10.8,10.8C255.425,215.415,250.525,220.215,244.625,220.215z"/> <path id="XMLID_2012_" d="M481.325,227.515c-224.8-258.6-428-53.9-476.4,2.8c-6.5,7.6-6.6,18.8-0.1,26.4 c221.9,259,423.4,64.6,476.5,3.7C489.625,251.015,489.625,237.015,481.325,227.515z M244.625,346.615 c-56.8,0-102.8-46-102.8-102.8s46-102.8,102.8-102.8s102.8,46,102.8,102.8S301.325,346.615,244.625,346.615z"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
							htp.p('<a class="link" onclick="recoverPassword(this);">'||fun.lang('Esqueceu a senha?')||'</a>');
						htp.p('</span>');
					htp.p('</form>');
					htp.p('<span id="qrenviar" onclick="login(this);">Login<a></a></span>');
					
				htp.p('</div>');
			htp.p('</div>');

	fcl.alerta;

exception when others then
	htp.p(sqlerrm);
end loginScreen;

/******* desativado - 06/11/2023 - ivanor  
procedure qrcheck (  prm_session varchar2 default null ) as
	ws_url           varchar2(400);
	ws_result        varchar2(4000);
	ws_erro          exception;
	ws_erro_s        exception;
begin

	begin
		ws_url := 'http://update.upquery.com/update/dwu.check_ac?prm_ping=CHECK_ID&prm_cliente='||fun.ret_var('CLIENTE')||'&prm_session='||prm_session;
		ws_result := utl_http.request(trim(ws_url));
	exception when others then
		raise ws_erro;
	end;

	htp.p(ws_result);

exception
	when ws_erro_s then
		htp.p('SEM PERMISS&Atilde;O');
	when ws_erro then
		htp.p('ERRO '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
		insert into bi_log_sistema values(sysdate, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - QRCHECK', gbl.getUsuario, 'ERRO');
		commit;
	when others then
		htp.p('ERRO');
end qrcheck;

procedure qrmanual  ( prm_session varchar2 default null,
					prm_check   varchar2 default null ) as

	ws_url           varchar2(400);
	ws_check         varchar2(200);
	ws_result        varchar2(4000);
	ws_erro          exception;

begin

	begin
		--login_temp;
		ws_url := 'http://update.upquery.com/update/dwu.check_ac?prm_ping=CHECK_ID&prm_check='||prm_check||'&prm_origem='||prm_session;
		ws_result := utl_http.request(trim(ws_url));
		if instr(ws_result, 'ERRO') = 0 then
			fcl.qrcheck(prm_session);
		end if;
	exception when others then
		raise ws_erro;
	end;

	htp.p(ws_result);

exception
	when ws_erro then
		htp.p('ERRO URL');
		insert into bi_log_sistema values(sysdate, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - QRMANUAL', gbl.getUsuario, 'ERRO');
		commit;
	when others then
		htp.p('ERRO');
end qrmanual;
***************************/ 

procedure checkpar ( prm_variavel varchar2 default null,
					prm_visao    varchar2 default null ) as

	ws_variavel varchar2(120);
	ws_count    number;
	ws_notfound exception;

begin
	for i in (select column_value from table(fun.vpipe(prm_variavel))) loop
		ws_variavel := replace(i.column_value, '$[', '');
		ws_variavel := replace(ws_variavel, ']', '');
		select count(*) into ws_count from parametro_padrao t1, micro_coluna t2 where t1.cd_padrao = ws_variavel or (t2.cd_coluna = ws_variavel and t2.cd_micro_visao = prm_visao);
		if ws_count = 0 then
			raise ws_notfound;
			exit;
		end if;
	end loop;
exception
	when ws_notfound then
		htp.p('fail error');
	when others then
		htp.p('');
end checkpar;

/******************************************************************************************
	Decidido em reunião 20/01/23 não mostrar mais a tela admin
procedure admin_options as

	cursor crs_usuarios is
	select usuario, max(permissao) as permissao from (
		select trim(usuario) as usuario, listagg(permissao||'|'||status, '|')  within group
		(order by permissao) permissao
		from admin_options group by usuario
		union
		select trim(usu_nome) as usuario, '' from usuarios
	) where usuario <> 'DWU' group by usuario order by usuario;

	ws_usuario crs_usuarios%rowtype;

	ws_check varchar(20);

begin

	htp.p('<table class="linha">');
		htp.p('<thead>');
			htp.p('<tr>');
				htp.p('<th></th>');
				htp.p('<th colspan="2" style="text-align: center !important;">Drills</th>');
				htp.p('<th colspan="2" style="text-align: center !important;">'||fun.lang('Filtros')||'</th>');
				htp.p('<th style="text-align: center !important;">'||fun.lang('Atributos')||'</th>');
			htp.p('</tr>');
			htp.p('<tr>');
				htp.p('<th>'||fun.lang('Usu&aacute;rio')||'</th>');
				htp.p('<th style="font-size: 14px; text-align: center !important;">'||fun.lang('Adicionar')||'</th>');
				htp.p('<th style="font-size: 14px; text-align: center !important;">'||fun.lang('Excluir')||'</th>');
				htp.p('<th style="font-size: 14px; text-align: center !important;">'||fun.lang('Adicionar')||'</th>');
				htp.p('<th style="font-size: 14px; text-align: center !important;">'||fun.lang('Excluir')||'</th>');
				htp.p('<th style="font-size: 14px; text-align: center !important;">'||fun.lang('Alterar')||'</th>');
			htp.p('</tr>');
		htp.p('</thead>');

		open crs_usuarios;
			loop
				fetch crs_usuarios into ws_usuario;
				exit when crs_usuarios%notfound;

				htp.p('<tr>');
					htp.p('<td>'||ws_usuario.usuario||'</td>');

					select decode(max(cd_conteudo), 'S', 'checked', '') into ws_check from table(fun.vpipe_par(nvl(ws_usuario.permissao, 'DRILLS_ADD|N'))) where cd_coluna = 'DRILLS_ADD';
					htp.p('<td><input type="checkbox" '||ws_check||' onchange="ajax(''fly'', ''admin_alter'', ''prm_usuario='||ws_usuario.usuario||'&prm_permissao=DRILLS_ADD'', false);"/></td>');

					select decode(max(cd_conteudo), 'S', 'checked', '') into ws_check from table(fun.vpipe_par(nvl(ws_usuario.permissao, 'DRILLS_EX|N'))) where cd_coluna = 'DRILLS_EX';
					htp.p('<td><input type="checkbox" '||ws_check||' onchange="ajax(''fly'', ''admin_alter'', ''prm_usuario='||ws_usuario.usuario||'&prm_permissao=DRILLS_EX'', false);"/></td>');

					select decode(max(cd_conteudo), 'S', 'checked', '') into ws_check from table(fun.vpipe_par(nvl(ws_usuario.permissao, 'FILTERS_ADD|N'))) where cd_coluna = 'FILTERS_ADD';
					htp.p('<td><input type="checkbox" '||ws_check||' onchange="ajax(''fly'', ''admin_alter'', ''prm_usuario='||ws_usuario.usuario||'&prm_permissao=FILTERS_ADD'', false);"/></td>');

					select decode(max(cd_conteudo), 'S', 'checked', '') into ws_check from table(fun.vpipe_par(nvl(ws_usuario.permissao, 'FILTERS_EX|N'))) where cd_coluna = 'FILTERS_EX';
					htp.p('<td><input type="checkbox" '||ws_check||' onchange="ajax(''fly'', ''admin_alter'', ''prm_usuario='||ws_usuario.usuario||'&prm_permissao=FILTERS_EX'', false);"/></td>');

					select decode(max(cd_conteudo), 'S', 'checked', '') into ws_check from table(fun.vpipe_par(nvl(ws_usuario.permissao, 'ATTRIB_ALT|N'))) where cd_coluna = 'ATTRIB_ALT';
					htp.p('<td><input type="checkbox" '||ws_check||' onchange="ajax(''fly'', ''admin_alter'', ''prm_usuario='||ws_usuario.usuario||'&prm_permissao=ATTRIB_ALT'', false);"/></td>');

				htp.p('</tr>');
			end loop;
		close crs_usuarios;
	htp.p('</table>');
exception when others then
	htp.p(sqlerrm);
end admin_options;

procedure admin_alter ( prm_usuario   varchar2 default null,
						prm_permissao varchar2 default null ) as

	ws_count  	number;
	ws_status 	char(1);
	ws_erro   	exception;
	ws_inject 	exception;
	ws_usuario	varchar2(100);
	ws_admin	varchar2(10);

begin
	--Usuário que vai dar as permissões
	ws_usuario := gbl.getusuario;
	ws_admin   := nvl(gbl.getNivel, 'N');

	if ws_admin = 'A' then
		select count(*) into ws_count from admin_options where usuario = prm_usuario and permissao = prm_permissao;

		if ws_count = 0 then
			insert into admin_options (usuario, permissao, dt_permissao, status) values (prm_usuario, prm_permissao, sysdate, 'S');
			commit;
			htp.p('#alert '||fun.lang('Alterado com sucesso')||'!');
		elsif ws_count = 1 then
			select status into ws_status from admin_options where usuario = prm_usuario and permissao = prm_permissao;
			if ws_status = 'S' then
				update admin_options
				set status = 'N', dt_permissao = sysdate
				where usuario = prm_usuario and permissao = prm_permissao;
			else
				update admin_options
				set status = 'S', dt_permissao = sysdate
				where usuario = prm_usuario and permissao = prm_permissao;
			end if;
			commit;
			htp.p('#alert '||fun.lang('Alterado com sucesso')||'!');
		else
			raise ws_erro;
		end if;
	else
		raise ws_inject;
	end if;
exception
	when ws_inject then
		htp.p('Usuario sem permiss&atilde;o para essa a&ccedil;&atilde;o!');
	when ws_erro then
		htp.p('#alert '||fun.lang('Erro ao alterar permiss&otilde;es, valor duplicado')||'!');
	when others then
		htp.p('#alert '||fun.lang('Erro ao alterar permiss&otilde;es')||'!');
end admin_alter;
*******************************************************************************************/

procedure condicoes ( prm_tipo     varchar2 default null,
					prm_condicao varchar2 default null ) as

begin
	
	case prm_tipo
		when 'simple' then
			htp.p('<option value="IGUAL">'||fun.lang('Igual a')||'</option>');
			htp.p('<option value="DIFERENTE">'||fun.lang('Diferente de')||'</option>');
			htp.p('<option value="MAIOR">'||fun.lang('Maior que')||'</option>');
			htp.p('<option value="MENOR">'||fun.lang('Menor que')||'</option>');
			htp.p('<option value="MAIOROUIGUAL">'||fun.lang('Maior ou igual a')||'</option>');
			htp.p('<option value="MENOROUIGUAL">'||fun.lang('Menor ou igual a')||'</option>');
			htp.p('<option value="LIKE">'||fun.lang('Semelhante a')||'</option>');
			htp.p('<option value="NOTLIKE">'||fun.lang('Diferente(not like) de')||'</option>');
			htp.p('<option value="NOFLOAT">'||fun.lang('Ignorar float')||'</option>');
		when 'selected' then
			if prm_condicao = 'DIFERENTE' then
				htp.p('<option value="DIFERENTE" selected>'||fun.lang('Diferente de')||'</option>');
			else
				htp.p('<option value="DIFERENTE">'||fun.lang('Diferente de')||'</option>');
			end if;
			if prm_condicao = 'IGUAL' then
				htp.p('<option value="IGUAL" selected>'||fun.lang('Igual a')||'</option>');
			else
				htp.p('<option value="IGUAL">'||fun.lang('Igual a')||'</option>');
			end if;
			if prm_condicao = 'MAIOR' then
				htp.p('<option value="MAIOR" selected>'||fun.lang('Maior que')||'</option>');
			else
				htp.p('<option value="MAIOR">'||fun.lang('Maior que')||'</option>');
			end if;
			if prm_condicao = 'MENOR' then
				htp.p('<option value="MENOR" selected>'||fun.lang('Menor que')||'</option>');
			else
				htp.p('<option value="MENOR">'||fun.lang('Menor que')||'</option>');
			end if;
			if prm_condicao = 'MAIOROUIGUAL' then
				htp.p('<option value="MAIOROUIGUAL" selected>'||fun.lang('Maior ou igual a')||'</option>');
			else
				htp.p('<option value="MAIOROUIGUAL">'||fun.lang('Maior ou igual a')||'</option>');
			end if;
			if prm_condicao = 'MENOROUIGUAL' then
				htp.p('<option value="MENOROUIGUAL" selected>'||fun.lang('Menor ou igual a')||'</option>');
			else
				htp.p('<option value="MENOROUIGUAL">'||fun.lang('Menor ou igual a')||'</option>');
			end if;
			if prm_condicao = 'LIKE' then
				htp.p('<option value="LIKE" selected>'||fun.lang('Semelhante a')||'</option>');
			else
				htp.p('<option value="LIKE">'||fun.lang('Semelhante a')||'</option>');
			end if;
			if prm_condicao = 'NOTLIKE' then
				htp.p('<option value="NOTLIKE" selected>'||fun.lang('Diferente(not like) de')||'</option>');
			else
				htp.p('<option value="NOTLIKE">'||fun.lang('Diferente(not like) de')||'</option>');
			end if;
			
			if prm_condicao = 'NOFLOAT' then
				htp.p('<option value="NOFLOAT" selected>'||fun.lang('Ignorar float')||'</option>');
			else
				htp.p('<option value="NOFLOAT">'||fun.lang('Ignorar float')||'</option>');
			end if;
		else
			htp.p('');
	end case;

end condicoes;


procedure carrega_objeto ( prm_tipo      varchar2 default null,
						prm_posicao   varchar2 default null,
						prm_parametro varchar2 default null,
						prm_visao     varchar2 default null,
						prm_coluna    varchar2 default null,
						prm_agrupador varchar2 default null,
						prm_tip       varchar2 default null,
						prm_obj       varchar2 default null,
						prm_screen    varchar2 default null,
						prm_colup     varchar2 default null ) as

begin

	htp.p('<div style="display: none;" id="gxml_'||prm_obj||'">');
		fcl.charout(prm_parametro, prm_visao, prm_obj, prm_screen);
	htp.p('</div>');

	if prm_tipo in ('LINHAS','BARRAS', 'COLUNAS','SANKEY','SCATTER','RADAR','CALENDARIO') then
		htp.p('<div style="-webkit-overflow-scrolling: touch; overflow-x: auto; height: calc('||fun.put_par(prm_obj, 'ALTURA', prm_tipo)||'px + 20px);"><div id="ctnr_'||prm_obj||'" class="block-fusion" style="position: relative !important; min-width: inherit; '||prm_posicao||';">'||fun.lang('Carregando Informa&ccedil;&otilde;es...Aguarde!')||'</div></div>');
	else
		htp.p('<div id="ctnr_'||prm_obj||'" class="block-fusion" style="position: relative !important; min-width: inherit; max-width: inherit; '||prm_posicao||';">'||fun.lang('Carregando Informa&ccedil;&otilde;es...Aguarde!')||'</div>');
	end if;

end carrega_objeto;

procedure dashboardcopy ( prm_dashboard varchar2 default null, 
						prm_actual    varchar2 default null ) as

	ws_id      varchar2(200);
	ws_id_ant  varchar2(200);
	ws_count   number;
begin
	ws_count := 0;
	for i in(select object_id, posx, posy, zindex, porcentagem from object_location where screen = prm_dashboard) loop
		ws_count := ws_count+1;
		
		/* gera novo id e armazena o antigo */
		select 'ARTICLE_'||trim((Select Sid From V$session Where Audsid = Sys_Context('userenv','sessionid'))||(Select Serial# From V$session Where Audsid = Sys_Context('userenv','sessionid'))||to_char(sysdate,'yymmddhhmiss'))||ws_count into ws_id from dual;
		ws_id_ant := i.object_id;
		
		/* insere bloco com novo id */
		insert into object_location values ('DWU', 'DEFAULT', prm_actual, ws_id, i.posx, i.posy, i.zindex, i.porcentagem);
		
		/* lista objetos do antigo id e insere no novo id */
		for a in(select object_id, posx, posy, zindex, porcentagem from object_location where screen = ws_id_ant) loop
			insert into object_location values ('DWU', 'DEFAULT', ws_id, a.object_id, a.posx, a.posy, a.zindex, a.porcentagem);
		end loop;
		
	end loop;

end dashboardcopy;

procedure title_screen ( prm_screen varchar2 default null ) as 

	ws_screen varchar2(2000);
	ws_desc   varchar2(2000);
	ws_grupo  varchar2(40);
	ws_obs    varchar2(32000);
	ws_padrao varchar2(2000);
	ws_titulo varchar2(32000);

begin

		ws_padrao := gbl.getLang;

		select ds_screen, descricao, ds_objeto into ws_screen, ws_desc, ws_obs
		from all_screens t1
		left join objetos t2 on t2.cd_objeto = t1.screen
		where trim(screen) = trim(prm_screen);
		--select descricao into ws_desc from all_screens where trim(screen) = trim(prm_screen);
		select nm_grupo into ws_grupo from grupos_funcao where cd_grupo = (select cd_grupo from objetos where trim(cd_objeto) = trim(prm_screen));
		ws_titulo := trim(fun.subpar(fun.utranslate('DS_SCREEN','ALL_SCREENS', ws_screen, ws_padrao), trim(prm_screen)));
		if ws_titulo is null then 
			ws_titulo := fun.utranslate('NM_GRUPO', 'GRUPOS_FUNCAO', ws_grupo, ws_padrao)||' - '||fun.utranslate('NM_OBJETO', prm_screen, ws_desc, ws_padrao);
		end if; 
		htp.prn('<span>'||ws_titulo||'</span>');
		if nvl(ws_obs, 'N/A') <> 'N/A' then
			ws_obs := fun.subpar(ws_obs, prm_screen); 
			ws_obs := replace(ws_obs,'"', '&quot;'); 
			--htp.p('<a title="'||fun.lang('Informa&ccedil;&atilde;o da tela')||'" data-obs="<h4>'||fun.lang('Observa&ccedil;&otilde;es da tela')||'</h4><span>'||fun.subpar(ws_obs, prm_screen)||'</span>" onclick="closeSideBar(''obs-field''); screenObs();"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 490.667 490.667" style="enable-background:new 0 0 490.667 490.667;" xml:space="preserve"> <g> <g> <path d="M245.333,0C110.059,0,0,110.059,0,245.333s110.059,245.333,245.333,245.333s245.333-110.059,245.333-245.333 S380.608,0,245.333,0z M245.333,469.333c-123.52,0-224-100.48-224-224s100.48-224,224-224s224,100.48,224,224 S368.853,469.333,245.333,469.333z"/> </g> </g> <g> <g> <path d="M245.333,106.667c-41.173,0-74.667,33.493-74.667,74.667v21.333c0,5.888,4.779,10.667,10.667,10.667 S192,208.555,192,202.667v-21.333C192,151.936,215.915,128,245.333,128c29.419,0,53.333,23.936,53.333,53.333v16.149 c0,14.251-5.547,27.648-15.637,37.739l-26.496,26.496c-14.101,14.123-21.867,32.853-21.867,52.8v16.149 c0,5.888,4.779,10.667,10.667,10.667S256,336.555,256,330.667v-16.149c0-14.251,5.547-27.648,15.637-37.739l26.496-26.496 C312.235,236.16,320,217.429,320,197.483v-16.149C320,140.16,286.507,106.667,245.333,106.667z"/> </g> </g> <g> <g> <path d="M245.333,362.667C233.557,362.667,224,372.245,224,384c0,11.755,9.557,21.333,21.333,21.333s21.333-9.579,21.333-21.333 C266.667,372.245,257.109,362.667,245.333,362.667z"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg></a>');
			htp.p('<a title="'||fun.lang('Informa&ccedil;&atilde;o da tela')||'" data-obs="<h4>'||fun.lang('Observa&ccedil;&otilde;es da tela')||'</h4><span>'||ws_obs||'</span>" onclick="closeSideBar(''obs-field''); screenObs();"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Camada_1" x="0px" y="0px" viewBox="0 0 1280 1280" style="enable-background:new 0 0 1280 1280;" xml:space="preserve"><g><g><path  d="M590,249.13h100v446.71H590V249.13z M590,807.52h100v223.36H590V807.52z"/></g><path  d="M640,1256c-83.14,0-163.81-16.29-239.79-48.43c-73.36-31.03-139.23-75.44-195.79-131.99   c-56.56-56.56-100.97-122.43-131.99-195.79C40.29,803.82,24,723.14,24,640s16.29-163.81,48.43-239.79   c31.03-73.36,75.44-139.23,131.99-195.79S326.85,103.46,400.21,72.43C476.19,40.29,556.86,24,640,24s163.81,16.29,239.79,48.43   c73.36,31.03,139.23,75.44,195.79,131.99c56.56,56.55,100.97,122.43,131.99,195.79C1239.71,476.19,1256,556.86,1256,640   s-16.29,163.82-48.43,239.79c-31.03,73.36-75.44,139.23-131.99,195.79c-56.56,56.56-122.43,100.97-195.79,131.99   C803.81,1239.71,723.14,1256,640,1256z M640,123.47c-69.75,0-137.39,13.65-201.04,40.57c-61.5,26.01-116.75,63.26-164.2,110.72   c-47.45,47.45-84.7,102.7-110.72,164.2c-26.92,63.65-40.57,131.29-40.57,201.04s13.65,137.39,40.57,201.04   c26.01,61.5,63.26,116.75,110.72,164.2c47.45,47.45,102.7,84.7,164.2,110.72c63.65,26.92,131.29,40.57,201.04,40.57   s137.39-13.65,201.04-40.57c61.5-26.01,116.75-63.26,164.2-110.72c47.45-47.45,84.7-102.7,110.72-164.2   c26.92-63.65,40.57-131.29,40.57-201.04s-13.65-137.39-40.57-201.04c-26.01-61.5-63.26-116.75-110.72-164.2   c-47.45-47.45-102.7-84.7-164.2-110.72C777.39,137.12,709.75,123.47,640,123.47z"/></g></svg></a>');
		end if;
		htp.p('<titulo_aba_navagedor>'||nvl(trim(fun.utranslate('NM_GRUPO', 'GRUPOS_FUNCAO', ws_grupo, ws_padrao)), '')||' > '|| nvl(trim(fun.utranslate('NM_OBJETO', prm_screen, ws_desc, ws_padrao)), ''));
exception when others then
	insert into bi_log_sistema (dt_log, ds_log, nm_usuario, nm_procedure) values (sysdate, substr('title_screen ['||prm_screen||']: '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE,1,3999), user, 'ERRO');
	commit; 
	htp.p('');
end title_screen;

procedure obj_screen_count ( prm_screen varchar2 default null,
							prm_tipo   varchar2 default null ) as

	ws_count number := 0;

begin
	if prm_tipo = 'FLOAT' then
		select count(*) into ws_count from (select object_id as obj, screen as tela, (select tp_objeto from objetos where cd_objeto = object_id) as tipo from object_location) where trim(tela) = trim(prm_screen) and trim(tipo) in ('FLOAT_PAR', 'FLOAT_FILTER');
	elsif prm_tipo = 'FAVORITOS' then
		select count(*) into ws_count 
		from objetos obj,  favoritos  fav 
		where obj.cd_objeto = fav.cd_objeto 
			and (obj.tp_objeto = 'SCREEN' or fav.screen = prm_screen )
			and fav.usuario   = gbl.getUsuario;
	else
		select count(*) into ws_count from (select object_id as obj, screen as tela, (select tp_objeto from objetos where cd_objeto = object_id) as tipo from object_location) where trim(tela) = trim(prm_screen) and trim(tipo) = trim(prm_tipo);
	end if;

	htp.p(ws_count);
exception when others then
	htp.p('0');
end obj_screen_count;


PROCEDURE PADRAO_COLUNAS (  prm_tabela      varchar2,
							prm_micro_visao varchar2 )	AS 
	cursor crs_cols is
		select column_name, data_type   
		  from all_tab_columns tb
		  left join codigo_descricao ds on ds.nds_tfisica = tb.table_name 
		 where owner      = nvl(fun.ret_var('OWNER_TABLE_DATA'),'DWU') 
		   and table_name = prm_tabela 
		   and column_name not in(select cd_coluna from micro_coluna where cd_micro_visao = prm_micro_visao); 
		
	cursor c_padrao (prm_cd_coluna varchar2) is 
		select mc.* from micro_coluna mc
		  left join micro_visao mv on mv.nm_micro_visao = mc.cd_micro_visao 
		 where mc.cd_coluna = prm_cd_coluna 
		   and mc.cd_micro_visao is not null 
		 order by mv.dt_ultima_alteracao desc ; 

	ws1   c_padrao%rowtype; 

	BEGIN
	
		for a in crs_cols loop

			ws1 := null;
			open  c_padrao (a.column_name);
			fetch c_padrao into ws1;
			close c_padrao; 

			if a.data_type = 'VARCHAR2' then 
				ws1.st_alinhamento := 'LEFT';
				ws1.nm_mascara     := 'SEM';
				ws1.st_agrupador   := 'SEM';
			elsif a.data_type = 'DATE' then  
				ws1.st_alinhamento := 'CENTER';
				ws1.nm_mascara     := 'DATA';
				ws1.st_agrupador   := 'SEM';
			elsif a.data_type = 'NUMBER' then  
				ws1.st_alinhamento := 'RIGHT';
				ws1.nm_mascara     := 'VALOR';
				if ((nvl(ws1.st_agrupador,'SEM') = 'SEM') and (substr(upper(a.column_name),1,3) = 'VL_' or substr(upper(a.column_name),1,4) = 'QTD_')) then
					ws1.st_agrupador   := 'SUM';
				end if; 	
			end if; 	
			
			if ws1.nm_rotulo is null then 
				if a.data_type = 'VARCHAR2' and substr(upper(a.column_name),1,3) in ('CD_', 'DS_') then 
					ws1.nm_rotulo := substr(a.column_name,4,9999); 
				elsif a.data_type = 'DATE' and substr(upper(a.column_name),1,3) = 'DT_' then 
					ws1.nm_rotulo := 'DATA '||substr(a.column_name,4,9999); 
				elsif a.data_type = 'NUMBER' and substr(upper(a.column_name),1,3) = 'VL_' then 
					ws1.nm_rotulo := 'VALOR '||substr(a.column_name,4,9999); 
				else 
					ws1.nm_rotulo := a.column_name; 
				end if; 	
			end if; 

			ws1.tipo           := 'T'; -- coluna de Tabela  
			ws1.st_gera_rel    := nvl(ws1.st_gera_rel,'S'); 
			ws1.nm_mascara     := nvl(ws1.nm_mascara,'SEM');
			ws1.cd_ligacao     := nvl(ws1.cd_ligacao,'SEM');
			ws1.st_com_codigo  := nvl(ws1.st_com_codigo,'N');
			ws1.st_alinhamento := nvl(ws1.st_alinhamento,'LEFT'); 
			ws1.st_resumido    := nvl(ws1.st_resumido,'N'); 
			ws1.st_negrito     := nvl(ws1.st_negrito,'S');
			ws1.st_invisivel   := nvl(ws1.st_invisivel,'N'); 

			insert into micro_coluna (cd_micro_visao,    cd_coluna,       nm_rotulo,       st_gera_rel,      st_agrupador,     nm_mascara,     cd_ligacao,     st_com_codigo,
			                          st_alinhamento,    st_resumido,     st_negrito,      st_invisivel,     nm_unidade,       formula,        tipo,           rotulo_c, 
									  color,             hint,            flexcol,         url )
							  values (prm_micro_visao,    a.column_name,   ws1.nm_rotulo,   ws1.st_gera_rel,  ws1.st_agrupador, ws1.nm_mascara, ws1.cd_ligacao, ws1.st_com_codigo,
							          ws1.st_alinhamento, ws1.st_resumido, ws1.st_negrito,  ws1.st_invisivel, ws1.nm_unidade,   ws1.formula,    ws1.tipo,       ws1.rotulo_c,
									  ws1.color,          ws1.hint,        ws1.flexcol,     ws1.url);
		end loop;
		
		COMMIT;

	exception
		when others then
			htp.p(sqlerrm);
		
END PADRAO_COLUNAS;


/*************
PROCEDURE PADRAO_COLUNAS (  prm_tabela      varchar2,
							prm_micro_visao varchar2 )	AS 

	cursor crs_cols is
	
		select
			column_name, pf.tp_lov, pf.cd_prefixo, substr(column_name, length(pf.cd_prefixo)+1, 9999) as coluna, nvl(pf.cd_agrupador, 'SEM') as cd_agrupador, nvl(pf.cd_mascara, 'SEM') as cd_mascara, pf.alinhamento
		from all_tab_columns tb
			left join codigo_descricao ds on ds.nds_tfisica = tb.table_name 
			left join prefixo_padrao   pf on  pf.cd_prefixo = substr(tb.column_name, 1, 3)
			where owner = nvl(fun.ret_var('OWNER_TABLE_DATA'),'DWU') and table_name = prm_tabela and column_name not in(select cd_coluna from micro_coluna where cd_micro_visao = prm_micro_visao); 

		ws_cols     crs_cols%Rowtype;

	BEGIN
	
		open crs_cols;
			
			loop
				fetch crs_cols into ws_cols;
				exit when crs_cols%Notfound;		
				
					if ws_cols.cd_prefixo <> 'NULL' then
					
						insert into micro_coluna (cd_micro_visao, cd_coluna, nm_rotulo, st_gera_rel, st_agrupador, nm_mascara, cd_ligacao, st_com_codigo, st_alinhamento, st_resumido, st_negrito, st_invisivel, nm_unidade, formula, tipo, rotulo_c, color, hint, flexcol, url )
										values (prm_micro_visao,ws_cols.column_name, replace(substr(ws_cols.column_name,length(ws_cols.cd_prefixo)+1,length(ws_cols.column_name)),'_',' '),
						'S', ws_cols.cd_agrupador, ws_cols.cd_mascara, 'SEM', 'N', ws_cols.alinhamento, 'N', 'S', 'N', '', '', 'T', '', '', '', '', '');
								
					end if;
					
					if ws_cols.cd_prefixo IS NULL then
					
						insert into micro_coluna (cd_micro_visao, cd_coluna, nm_rotulo, st_gera_rel, st_agrupador, nm_mascara, cd_ligacao, st_com_codigo, st_alinhamento, st_resumido, st_negrito, st_invisivel, nm_unidade, formula, tipo, rotulo_c, color, hint, flexcol, url )
									values (prm_micro_visao,ws_cols.column_name, ws_cols.column_name, 
						'S', ws_cols.cd_agrupador, ws_cols.cd_mascara, 'SEM', 'N', nvl(ws_cols.alinhamento,'LEFT'), 'N', 'S', 'N', '', '', 'T', '', '', '', '', '');
			
							
					end if;						
				
			end loop;

		close crs_cols;
		
		COMMIT;


	exception
		when others then
			htp.p(sqlerrm);
		
END PADRAO_COLUNAS;
*************/

procedure prefixo_lista as

	cursor crs_prefixos is
	select cd_prefixo, tp_lov, prefixo_lov, cd_agrupador, cd_mascara, alinhamento
	from prefixo_padrao;

	ws_prefixo crs_prefixos%rowtype;

	ws_evento varchar2(2000);

begin


	htp.p('<table class="linha">');
		htp.p('<thead>');
			htp.p('<tr>');
				htp.p('<th>'||fun.lang('Prefixo')||'</th>');
				htp.p('<th>'||fun.lang('Tipo lov')||'</th>');
				htp.p('<th>'||fun.lang('Prefixo lov')||'</th>');
				htp.p('<th>'||fun.lang('Agrupador')||'</th>');
				htp.p('<th>'||fun.lang('M&aacute;scara')||'</th>');
				htp.p('<th>'||fun.lang('Alinhamento')||'</th>');
				htp.p('<th></th>');
			htp.p('</tr>');
		htp.p('</thead>');
		htp.p('<tbody>');
			open crs_prefixos;
				loop
					fetch crs_prefixos into ws_prefixo;
					exit when crs_prefixos%notfound;
					
						htp.p('<tr>');
							htp.p('<td><input onchange="savePrefixo(this, ''edit'');" onblur="savePrefixo(this, ''edit'');" data-ant="'||ws_prefixo.cd_prefixo||'" type="text" value="'||ws_prefixo.cd_prefixo||'" palceholder="'||fun.lang('prefixo')||'" /></td>');
							htp.p('<td><input onchange="savePrefixo(this, ''edit'');" onblur="savePrefixo(this, ''edit'');" data-ant="'||ws_prefixo.tp_lov||'" type="text" value="'||ws_prefixo.tp_lov||'" palceholder="'||fun.lang('prefixo')||'" /></td>');
							htp.p('<td><input onchange="savePrefixo(this, ''edit'');" onblur="savePrefixo(this, ''edit'');" data-ant="'||ws_prefixo.prefixo_lov||'" type="text" value="'||ws_prefixo.prefixo_lov||'" palceholder="'||fun.lang('prefixo')||'" /></td>');
							htp.p('<td><input onchange="savePrefixo(this, ''edit'');" onblur="savePrefixo(this, ''edit'');" data-ant="'||ws_prefixo.cd_agrupador||'" type="text" value="'||ws_prefixo.cd_agrupador||'" palceholder="'||fun.lang('prefixo')||'" /></td>');
							htp.p('<td><input onchange="savePrefixo(this, ''edit'');" onblur="savePrefixo(this, ''edit'');" data-ant="'||ws_prefixo.cd_mascara||'" type="text" value="'||ws_prefixo.cd_mascara||'" palceholder="'||fun.lang('prefixo')||'" /></td>');
							htp.p('<td>');
								htp.p('<select onchange="savePrefixo(this, ''edit'');" data-ant="'||ws_prefixo.alinhamento||'">');
									htp.p('<option value="LEFT">'||fun.lang('esquerda')||'</option>');
									if ws_prefixo.alinhamento = 'CENTER' then
										htp.p('<option value="CENTER" selected>'||fun.lang('centro')||'</option>');
									else
										htp.p('<option value="CENTER">'||fun.lang('centro')||'</option>');
									end if; 
									if ws_prefixo.alinhamento = 'RIGHT' then
										htp.p('<option value="RIGHT" selected>'||fun.lang('direita')||'</option>');
									else
										htp.p('<option value="RIGHT">'||fun.lang('direita')||'</option>');
									end if;
								htp.p('</select>');
							htp.p('</td>');
							htp.p('<td><a class="remove" onclick="this.parentNode.remove();">X</a></td>');
						htp.p('</tr>');
					end loop;
			close crs_prefixos;
		htp.p('</tbody>');
	htp.p('</table>');
end prefixo_lista;

procedure prefixo_alter ( prm_prefixo         varchar2 default null, 
						prm_lov             varchar2 default null,
						prm_lovp            varchar2 default null,
						prm_agrupador       varchar2 default null,
						prm_mascara         varchar2 default null,
						prm_alinhamento     varchar2 default null,
						prm_prefixo_ant     varchar2 default null, 
						prm_lov_ant         varchar2 default null,
						prm_lovp_ant        varchar2 default null,
						prm_agrupador_ant   varchar2 default null,
						prm_mascara_ant     varchar2 default null,
						prm_alinhamento_ant varchar2 default null,
						prm_evento          varchar2 default null ) as

begin

	case prm_evento
		when 'edit' then
			update prefixo_padrao set 
				cd_prefixo   = prm_prefixo, 
				tp_lov       = prm_lov,
				prefixo_lov  = prm_lovp,
				cd_agrupador = prm_agrupador,
				cd_mascara   = prm_mascara,
				alinhamento  = prm_alinhamento
			where
				cd_prefixo   = prm_prefixo_ant and
				tp_lov       = prm_lov_ant and
				prefixo_lov  = prm_lovp_ant and
				cd_agrupador = prm_agrupador_ant and
				cd_mascara   = prm_mascara_ant and
				alinhamento  = prm_alinhamento_ant;
		when 'remove' then
			delete from prefixo_padrao
			where 
				cd_prefixo   = prm_prefixo_ant and
				tp_lov       = prm_lov_ant and
				prefixo_lov  = prm_lovp_ant and
				cd_agrupador = prm_agrupador_ant and
				cd_mascara   = prm_mascara_ant and
				alinhamento  = prm_alinhamento_ant;
		when 'add' then
			insert into prefixo_padrao (
				cd_prefixo, tp_lov, prefixo_lov, cd_agrupador, cd_mascara, alinhamento 
			) values (
				prm_prefixo, prm_lov, prm_lovp, prm_agrupador, prm_mascara, prm_alinhamento 
			);
	end case;
	commit;
	htp.p('ok');
exception when others then
	htp.p('fail');
end prefixo_alter;


procedure remove_coluna ( prm_visao varchar2 default null ) as

	ws_tabela varchar2(200);

begin

	for x in(
		--select cd_coluna from micro_coluna t1 where tipo = 'T' and 
		--cd_micro_visao = prm_visao and 
		--trim(cd_coluna) not in ( 
		--	select trim(column_name) from all_tab_columns where trim(table_name) in (select nm_tabela from micro_visao where nm_micro_visao = prm_visao ) 
		select cd_coluna from micro_coluna t1 
		where tipo = 'T' 
		and cd_micro_visao = prm_visao 
		and cd_coluna not in ( select column_name from all_tab_columns 
								where owner      = nvl(upper(fun.ret_var('OWNER_TABLE_DATA')),'DWU') 
									and table_name in (select nm_tabela from micro_visao where nm_micro_visao = prm_visao ) 		
		) 
	) loop
		delete from micro_coluna where trim(cd_coluna) = trim(x.cd_coluna) and cd_micro_visao = prm_visao;
		insert into bi_log_sistema values(sysdate, 'Coluna '||trim(x.cd_coluna)||' excluida automaticamente da view '||prm_visao, gbl.getUsuario, 'EVENTO');
	end loop;
	
	commit;
	
exception when others then
	rollback;
end remove_coluna;


procedure fakeoption ( prm_id          varchar2 default null,
					prm_placeholder varchar2 default null,
					prm_valor       varchar2 default null,
					prm_opcao       varchar2 default null,
					prm_editable    varchar2 default null,
					prm_multi       varchar2 default null,
					prm_visao       varchar2 default null,
					prm_fixed       varchar2 default null,
					prm_adicional   varchar2 default null,
					prm_desc        varchar2 default null,
					prm_reverse     varchar2 default null,
					prm_children    varchar2 default null,
					prm_min         number   default null,
					prm_encode      varchar2  default 'N',
					prm_img         varchar2 default null,
					prm_limite      number   default null,
					prm_class_adic  varchar2 default null ) as

	ws_editable       varchar2(120);
	ws_focus          varchar2(120) := '';
	ws_inputable      varchar2(120);
	ws_blurclick      varchar2(120);
	ws_multi_class    varchar2(200);
	ws_disabled_class varchar2(100); 
	ws_leave          varchar2(800);
	ws_propagation    varchar2(200);
	ws_img            varchar2(200);

begin

	if nvl(prm_valor, 'N/A') = 'N/A' then
		ws_focus := 'onfocus="if(this.innerHTML == '''||prm_placeholder||'''){ this.innerHTML = ''''; }"';
	end if;

	if nvl(prm_img, 'N/A') <> 'N/A' then
		ws_img := prm_img;
		ws_multi_class := ws_multi_class||' img';
	end if;

	if prm_editable = 'S' then
		ws_editable := 'style="cursor: pointer;"';
		ws_inputable := 'true';
		ws_blurclick := 'true';
		ws_leave     := '';
	else
		ws_inputable := 'false';
		ws_blurclick := 'false';
		ws_editable := 'style="cursor: pointer;"';
	end if;
	
	if prm_editable = 'X' then
		ws_disabled_class := ' disabled ';
	end if;	

	if prm_multi = 'S' then
		ws_multi_class := ws_multi_class||' multi ';
	end if;

	/* adicional precisa passar o screen no float_filter */
	
	--htp.p('<span class="fakeoption'||ws_multi_class||'" data-editable="'||prm_editable||'" data-default="'||prm_valor||'" data-ant="" title="'||prm_valor||'" id="'||prm_id||'" data-adicional="'||prm_adicional||'" data-opcao="'||prm_opcao||'" data-visao="'||prm_visao||'" data-reverse="'||prm_reverse||'" onclick="/*fakeListBoxClick(this, '''||prm_adicional||''', '''||prm_id||''', '''||prm_opcao||''', '''||prm_multi||''','''||prm_visao||''', '''||prm_reverse||''', event);*/" '||ws_leave||'>');
	--    htp.p('<span class="input" '||ws_editable||' spellcheck="false" data-fixed="'||prm_fixed||'" data-custom="N" data-placeholder="'||prm_placeholder||'" onclick="/*fakeListInputClick(this, '''||prm_placeholder||''', '''||prm_editable||''', '''||ws_inputable||''');*/" onkeyup="/*fakeListInputKeyup(event, this, '||ws_inputable||', '''||prm_id||''', '''||prm_opcao||''', '''||prm_multi||''', '''||prm_visao||''', '''||prm_adicional||''', '''||prm_reverse||''', '''');*/" onkeypress="/*if(event.keyCode == 13){ return false; }*/" onblur="/*fakeListInputBlur(this, '||ws_blurclick||', '''||nvl(prm_desc, prm_placeholder)||''');*/">'||nvl(prm_desc, nvl(nvl(prm_fixed, prm_valor), prm_placeholder))||'</span>');
	--    htp.p('<svg class="down" version="1.1" id="Capa_8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" 	 width="292.362px" height="292.362px" viewBox="0 0 292.362 292.362" style="enable-background:new 0 0 292.362 292.362;" 	 xml:space="preserve"> <g> 	<path d="M286.935,69.377c-3.614-3.617-7.898-5.424-12.848-5.424H18.274c-4.952,0-9.233,1.807-12.85,5.424 		C1.807,72.998,0,77.279,0,82.228c0,4.948,1.807,9.229,5.424,12.847l127.907,127.907c3.621,3.617,7.902,5.428,12.85,5.428 		s9.233-1.811,12.847-5.428L286.935,95.074c3.613-3.617,5.427-7.898,5.427-12.847C292.362,77.279,290.548,72.998,286.935,69.377z"/> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>'); 
	--	htp.p('<ul class="fakelistbox" onmouseup="/*event.stopPropagation();*/" onclick="'||ws_propagation||'" onmousedown="/*var fakeobj = this.parentNode; event.stopPropagation(); this.classList.remove(''open''); if(fakeobj.previousElementSibling){ if(fakeobj.previousElementSibling.className == ''script''){ fakeobj.previousElementSibling.click(); }}*/" onmouseleave="/*if(this.classList.contains(''open'')){ this.parentNode.click(); }*/"></ul>');
	--    htp.p('<svg class="load" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"viewBox="0 0 462.088 462.088" style="enable-background:new 0 0 462.088 462.088;" xml:space="preserve"> <g> <g> <g> <path style="fill:#231F20;" d="M417.041,202.182c-7.483,0-13.896-5.345-16.034-12.827 c-18.172-80.171-88.723-136.826-172.101-136.826S74.977,109.184,56.805,189.355c-2.138,8.552-10.689,13.896-19.241,11.758 s-13.896-10.689-11.758-19.241c21.379-95.137,105.826-161.411,203.1-161.411s181.721,66.275,203.1,161.411 c2.138,8.552-3.207,17.103-11.758,19.241C419.179,201.113,418.11,202.182,417.041,202.182z"/> </g> <path style="fill:#231F20;" d="M422.386,206.458c-2.138,0-4.276,0-6.414-1.069l-55.585-23.517 c-8.552-3.207-11.758-12.827-8.552-21.379s12.827-11.758,21.379-8.552l40.62,17.103l17.103-40.62 c3.207-8.552,12.827-11.758,21.379-8.552s11.758,12.827,8.552,21.379l-23.517,55.585c-2.138,4.276-4.276,7.483-8.552,8.552 C426.662,206.458,424.524,206.458,422.386,206.458z"/> <g> <path style="fill:#231F20;" d="M232.113,441.627c-97.274,0-181.721-66.275-203.1-161.411 c-2.138-8.552,3.207-17.103,11.758-19.241s17.103,3.207,19.241,11.758c18.172,80.171,88.723,136.826,172.101,136.826 s153.929-56.654,172.101-136.826c2.138-8.552,10.689-13.896,19.241-11.758s13.896,10.69,11.758,19.241 C413.834,375.352,330.456,441.627,232.113,441.627z"/> </g> <path style="fill:#231F20;" d="M16.185,343.284c-2.138,0-4.276,0-6.414-1.069c-8.552-3.207-11.758-12.827-8.552-21.379 l23.517-55.585c3.207-8.552,12.827-11.758,21.379-8.552l55.585,23.517c8.552,3.207,11.758,12.827,8.552,21.379 c-3.207,8.552-12.827,11.758-21.379,8.552l-40.62-17.103L31.15,332.594C29.013,339.008,22.599,343.284,16.185,343.284z"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
	--	if prm_multi = 'S' then
	--	    htp.p('<a class="multi"></a>');
	--	end if;
	--htp.p('</span>');


	htp.p('<span style="'||ws_img||'" class="fakeoption'||ws_multi_class||ws_disabled_class||prm_class_adic||'" data-editable="'||prm_editable||'" data-default="'||prm_valor||'" data-ant="'||prm_valor||'" title="'||prm_valor||'" id="'||prm_id||'" data-adicional="'||prm_adicional||'" data-opcao="'||prm_opcao||'" data-visao="'||prm_visao||'" data-reverse="'||prm_reverse||'" data-children="'||prm_children||'" data-min="'||prm_min||'" data-encode="'||prm_encode||'" data-limite="'||prm_limite||'" '||ws_leave||'>');
		htp.p('<span class="input" '||ws_editable||' spellcheck="false" data-fixed-ant="'||prm_fixed||'" data-fixed="'||prm_fixed||'" data-custom="N" data-placeholder="'||prm_placeholder||'">'||nvl(prm_desc, nvl(nvl(prm_fixed, prm_valor), prm_placeholder))||'</span>');
		htp.p('<svg class="down" xmlns="http://www.w3.org/2000/svg" width="292.362" height="292.362" viewBox="0 0 292.362 292.362"><path d="M286.935 69.377c-3.614-3.617-7.898-5.424-12.848-5.424H18.274c-4.952 0-9.233 1.807-12.85 5.424C1.807 72.998 0 77.279 0 82.228c0 4.948 1.807 9.229 5.424 12.847l127.907 127.907c3.621 3.617 7.902 5.428 12.85 5.428s9.233-1.811 12.847-5.428L286.935 95.074c3.613-3.617 5.427-7.898 5.427-12.847 0-4.948-1.814-9.229-5.427-12.85z"/></svg>'); 
		htp.p('<ul class="fakelistbox" onclick="'||ws_propagation||'"></ul>');
		htp.p('<svg class="load" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 462.088 462.088"><path d="M417.041 202.182c-7.483 0-13.896-5.345-16.034-12.827-18.172-80.171-88.723-136.826-172.101-136.826S74.977 109.184 56.805 189.355c-2.138 8.552-10.689 13.896-19.241 11.758s-13.896-10.689-11.758-19.241c21.379-95.137 105.826-161.411 203.1-161.411s181.721 66.275 203.1 161.411c2.138 8.552-3.207 17.103-11.758 19.241-1.069 0-2.138 1.069-3.207 1.069z" fill="#231f20"/><path d="M422.386 206.458c-2.138 0-4.276 0-6.414-1.069l-55.585-23.517c-8.552-3.207-11.758-12.827-8.552-21.379s12.827-11.758 21.379-8.552l40.62 17.103 17.103-40.62c3.207-8.552 12.827-11.758 21.379-8.552s11.758 12.827 8.552 21.379l-23.517 55.585c-2.138 4.276-4.276 7.483-8.552 8.552-2.137 1.07-4.275 1.07-6.413 1.07zM232.113 441.627c-97.274 0-181.721-66.275-203.1-161.411-2.138-8.552 3.207-17.103 11.758-19.241s17.103 3.207 19.241 11.758c18.172 80.171 88.723 136.826 172.101 136.826s153.929-56.654 172.101-136.826c2.138-8.552 10.689-13.896 19.241-11.758s13.896 10.69 11.758 19.241c-21.379 95.136-104.757 161.411-203.1 161.411z" fill="#231f20"/><path d="M16.185 343.284c-2.138 0-4.276 0-6.414-1.069-8.552-3.207-11.758-12.827-8.552-21.379l23.517-55.585c3.207-8.552 12.827-11.758 21.379-8.552l55.585 23.517c8.552 3.207 11.758 12.827 8.552 21.379-3.207 8.552-12.827 11.758-21.379 8.552l-40.62-17.103-17.103 39.55c-2.137 6.414-8.551 10.69-14.965 10.69z" fill="#231f20"/></svg>');
		if prm_multi = 'S' then
			htp.p('<a class="multi"></a>');
		end if;
	htp.p('</span>');

	commit; 

	exception when others then
		insert into bi_log_sistema values (sysdate, 'FAKEOPTION (Others): '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, 'DWU', 'ERRO');
		commit;
		Raise_Application_Error (-20101, 'Erro montando Fakeoption: '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);		
end fakeoption;

/* clonados do fun para utilizar na sincronização individual */

procedure CHAROUT ( prm_parametros       varchar2 default null,
					prm_micro_visao      varchar2 default null,
					prm_objeto           varchar2 default null,
					prm_screen           varchar2 default null,
					prm_agrupador_troca  varchar2 default null,
					prm_ordem_troca      varchar2 default null,
					prm_usuario			 varchar2 default null,
					prm_cd_goto          varchar2 default null ) as

	ws_nm_tabela    varchar2(300);				
	ws_owner_table  varchar2(100); 

	cursor crs_colsb (prm_agrupador varchar2) is
		select cd_coluna 
		from ( select column_value as cd_coluna
				from TABLE(fun.VPIPE(prm_agrupador))
				where trim(column_value) is not null
			 ) ;
	
	cursor crs_micro_visao is
		select rtrim(cd_grupo_funcao) as cd_grupo_funcao
		from MICRO_VISAO where nm_micro_visao = prm_micro_visao;

	cursor crs_destaques(prm_usuario varchar2) is
    	select dest.cd_coluna, dest.condicao, dest.conteudo, 
               dest.cor_fundo, dest.cor_fonte, dest.tipo_destaque, 
               tabs.data_type, 
               decode(nvl(tabs.data_type,'.'), 'DATE', 
                      decode(fun.cdesc(mcol.nm_mascara, 'MASCARAS'), 'SEM', 
                             (select value from nls_session_parameters where parameter = 'NLS_DATE_FORMAT'),
                             fun.cdesc(mcol.nm_mascara, 'MASCARAS')),
                      fun.cdesc(mcol.nm_mascara, 'MASCARAS')) mascara
          from destaque dest, all_tab_columns tabs, micro_coluna mcol
		 where tabs.column_name(+) = dest.cd_coluna 
           and tabs.table_name(+)  = upper(ws_nm_tabela) 
		   and tabs.owner(+)       = ws_owner_table
           and mcol.cd_coluna      = dest.cd_coluna
           and mcol.cd_micro_visao = prm_micro_visao
           and (dest.cd_usuario = prm_usuario or dest.cd_usuario = 'DWU') 
           and dest.cd_objeto = prm_objeto
		 order by prioridade desc;

		/*
    	select dest.cd_coluna, dest.condicao, dest.conteudo, 
               dest.cor_fundo, dest.cor_fonte, dest.tipo_destaque, 
               tabs.data_type, 
               decode(tabs.data_type, 'DATE', 
                      decode(fun.cdesc(mcol.nm_mascara, 'MASCARAS'), 'SEM', 
                             (select value from nls_session_parameters where parameter = 'NLS_DATE_FORMAT'),
                             fun.cdesc(mcol.nm_mascara, 'MASCARAS')),
                      fun.cdesc(mcol.nm_mascara, 'MASCARAS')) mascara
          from destaque dest, all_tab_columns tabs, micro_coluna mcol
		 where tabs.column_name    = dest.cd_coluna(+) 
           and tabs.table_name(+)  = mcol.cd_micro_visao
           and mcol.cd_coluna      = dest.cd_coluna
           and mcol.cd_micro_visao = prm_micro_visao
           and (dest.cd_usuario = prm_usuario or dest.cd_usuario = 'DWU') 
           and dest.cd_objeto = prm_objeto
		 order by prioridade desc;
		 */ 
		-- select cd_coluna, condicao, conteudo, cor_fundo, cor_fonte, tipo_destaque
		-- from destaque 
		-- where (cd_usuario = prm_usuario or cd_usuario = 'DWU') and cd_objeto = prm_objeto
		-- order by prioridade desc;
			
	cursor nc_colunas is  
	  	select * 
	  	from micro_coluna 
	 	where cd_micro_visao = prm_micro_visao;

	type ws_tmcolunas  is table of nc_colunas%ROWTYPE index by pls_integer;

	ws_micro_visao   crs_micro_visao%rowtype;
	ws_destaque      crs_destaques%rowtype;
	ret_coluna         varchar2(400);
	ret_coluna2        varchar2(400);
	ret_coluna3        varchar2(400);
	ret_coluna4        varchar2(400);
	ws_agrupador_pv    varchar2(32000);


	ret_mcol         ws_tmcolunas;
	ret_cols         ws_tmcolunas; 
	ws_ncolumns      DBMS_SQL.VARCHAR2_TABLE;
	ws_coluna_ant    DBMS_SQL.VARCHAR2_TABLE;
	ws_pvcolumns     DBMS_SQL.VARCHAR2_TABLE;
	ws_mfiltro       DBMS_SQL.VARCHAR2_TABLE;
	ws_vcol          DBMS_SQL.VARCHAR2_TABLE;
	ws_vcon          DBMS_SQL.VARCHAR2_TABLE;
	ws_dados_arr     DBMS_SQL.number_TABLE;
	ws_grupos_arr    DBMS_SQL.VARCHAR2_TABLE;
	ws_lquery        number;
	ws_valor         number;
	ws_valor_char    varchar2(32000);
	ws_counter       number := 0;
	ws_ctx           number := 0;
	ws_scol          number := 0;
	ws_xcount        number := 0;
	ws_qt_valor      number := 0;
	ws_qt_agrupador  number := 0;
	ws_ct_agrupador  number := 0;
	ws_url_default   long;
	ws_colup         long;
	ws_coluna        long;
	ws_agrupador     long;
	ws_rp            long;
	ws_parametros    long;
	ws_perc_col      long;
	ws_find_col      long;
	ws_cursor        integer;
	ws_linhas        integer;
	ws_query_montada dbms_sql.varchar2a;
	ws_query_pivot   long;
	ws_sql           long;
	ws_binds         varchar2(32000);
	ws_mode          varchar2(40);
	ws_vazio         boolean := True;
	ws_datasets      DBMS_SQL.CLOB_TABLE;
	ws_datasets_cd   DBMS_SQL.VARCHAR2_TABLE;
	ws_count_bloq 	 number;
	ws_count         number;
	ws_coluna_new    clob;
	ws_label         clob;
	ws_cod           clob;
	ws_labelc        number;
	ws_cab_cross     clob;
	ws_amostra       number := 0;
	ws_queryoc	     clob;
	ws_qube          varchar2(2000);
	ws_destaques     varchar2(4000);
	ws_count_destaque number;
	ws_acumulado      number;
	ws_acumulado_text varchar2(800);     
	ws_id             number := 0;
	ws_ordem          varchar2(500); 

	ws_usuario        varchar2(80);
	ws_padrao         varchar2(80) := 'PORTUGUESE';
	ws_tipo           varchar2(80) := '';
	ws_tam_desc_label number;
	ws_cod_json       varchar2(1000);
	ws_colunas_json   varchar2(1000);
	ws_admin          varchar2(80);
	ws_vl_total       number;  
	ws_erro           varchar2(1000); 
	ws_obj_html       varchar2(200);
	ws_objeto         varchar2(200);
	ws_ordem_drill    varchar2(4000); 
	ws_log_exec       varchar2(10);
	ws_log_exec_id    varchar2(200);
	ws_nlin           integer; 
	ws_ncol           integer;

	ws_nodata        exception;
	ws_excep_parse   exception;
	ws_raise_col_bloc exception;
	ws_excesso_filtro exception;
	ws_raise_erro     exception;
	ws_agrupar_valor varchar2(200);
	


	PROCEDURE monta_json_grafico is 
	begin 
		ws_vazio := True;
		ws_nlin  := 0;

		htp.prn('<span class="json">');
		loop
			ws_linhas := dbms_sql.fetch_rows(ws_cursor);
			if ws_linhas = 1 then
				ws_nlin  := ws_nlin + 1; 
			else
				exit;
			end if;
			
			if ws_amostra = 0 or ws_count < ws_amostra THEN
				ws_id := ws_id+1;
				htp.prn('"'||ws_id||'": {');
			end if;

			ws_count := ws_count + 1;
			
			ws_xcount  := 0;
			ws_ctx     := 0;
			ws_xcount := ws_xcount + 1;
			ws_ctx     := ws_ctx    + 1;

			begin
				dbms_sql.column_value(ws_cursor, ws_xcount, ret_coluna);
			exception when others then
				exit;
			end;

			ws_perc_col := ret_coluna;
			ws_find_col := ws_perc_col;
	
			if ret_mcol(ws_counter).cd_ligacao <> 'SEM' then
				ws_xcount := ws_xcount + 1;
				dbms_sql.column_value(ws_cursor, ws_xcount, ret_coluna);
				ws_perc_col := ret_coluna;
			end if;



			if ws_qt_valor > 1 then



				ws_find_col     := fun.converte_json(ws_find_col); 
				ws_colunas_json := substr(fun.converte_json(trim(fun.ifmascara(fun.cdesc(ws_perc_col, ret_mcol(ws_counter).cd_ligacao), ret_mcol(ws_counter).nm_mascara, prm_micro_visao, ret_mcol(ws_counter).cd_coluna, '', '', '', ''))),1,ws_tam_desc_label); 

				if ws_amostra = 0 or ws_count <= ws_amostra THEN
					--htp.prn('"cod": "'||nvl(replace(ws_find_col, '|', ''),'.')||'", ');
					htp.prn('"cod": "'||replace(ws_find_col, '|', '#@PIPE@#')||'", '); -- Substitui | para funcionar a abertura de Drill, esse código é trocado por | novamente na CORE 
					htp.prn('"colunas": "'||nvl(ws_colunas_json,'.')||'", ');
					htp.prn('"valores": [');
				end if; 

				ws_ct_agrupador := 0;
				ws_labelc := 0;

				loop
					ws_ct_agrupador := ws_ct_agrupador + 1;

					if  ws_ct_agrupador > ws_qt_valor then
						exit;
					end if;					
					ws_xcount := ws_xcount + 1;
					ws_ctx    := ws_ctx    + 1;
					ws_labelc := ws_labelc + 1;
					dbms_sql.column_value(ws_cursor, ws_xcount, ret_coluna);
					ws_perc_col := ret_coluna;
					ws_valor := to_number(nvl(ret_coluna,0));
					ws_vl_total := ws_vl_total + ws_valor; 

					select count(*) into ws_count_bloq from column_restriction where usuario = gbl.getusuario and cd_micro_visao = prm_micro_visao and cd_coluna = ws_datasets_cd(ws_labelc);

					if ws_count_bloq = 0 then
						if ws_amostra = 0 or ws_count <= ws_amostra THEN
							htp.prn('{');
						end if; 
						
						if ws_amostra = 0 or ws_count <= ws_amostra THEN	
							begin
								htp.prn('"grupo": "'||fun.utranslate('NM_ROTULO', prm_micro_visao, ws_datasets(ws_labelc), ws_padrao)||'", ');
								htp.prn('"valor": "'||trim(ws_valor)||'"');
							exception when no_data_found then
								raise ws_raise_col_bloc;  
							end;
						else 
							begin
								if ws_dados_arr.count > 0 then
									ws_dados_arr(ws_ct_agrupador)   := ws_dados_arr(ws_ct_agrupador)+to_number(trim(ws_valor));
								else
									ws_dados_arr(ws_ct_agrupador)   := to_number(trim(ws_valor));
								end if;
								ws_grupos_arr(ws_ct_agrupador)  := ws_datasets(ws_labelc);
							exception when others then
								ws_dados_arr(ws_ct_agrupador)   := to_number(trim(ws_valor));
								ws_grupos_arr(ws_ct_agrupador)  := ws_datasets(ws_labelc);
							end;
						end if;

						if ws_amostra = 0 or ws_count <= ws_amostra THEN
							if  ws_ct_agrupador < ws_qt_valor then
								htp.prn('}, ');
							else
								htp.prn('} ');
							end if;
						end if; 	
					end if;
				end loop;

				if ws_amostra = 0 or ws_count <= ws_amostra THEN
					htp.prn('] ');
				end if;	

			else

				--unica coluna
				ws_xcount := ws_xcount + 1;
				dbms_sql.column_value(ws_cursor, ws_xcount, ret_coluna);
				
				select count(*) into ws_count_bloq from column_restriction where usuario = gbl.getusuario and cd_micro_visao = prm_micro_visao and cd_coluna = ws_datasets_cd(1);

				if ws_amostra = 0 or ws_count <= ws_amostra THEN					
					ws_find_col     := replace(ws_find_col, '|', '#@PIPE@#');  -- Se existir | no texto, substitui para funcionar a abertura de Drill, esse código é trocado por | novamente na CORE 
					ws_find_col     := fun.check_value(ws_find_col);           -- Atenção o check_value adiona o | no inicio 
					ws_find_col     := fun.converte_json(ws_find_col); 
					ws_colunas_json := nvl(substr(fun.converte_json(trim(fun.ifmascara(ws_perc_col, ret_mcol(ws_counter).nm_mascara, prm_micro_visao, ret_mcol(ws_counter).cd_coluna, '', '', '', ''))),1,ws_tam_desc_label),'.');
					ws_valor        := to_number(nvl(ret_coluna,0));
					ws_vl_total     := ws_vl_total + ws_valor; 
					if ws_count_bloq <> 0 then
						ws_valor:= null;
					end if;
					htp.prn(' "cod": "'||nvl(replace(ws_find_col, '|', ''),'.')||'", ');
					htp.prn('"colunas": "'||nvl(ws_colunas_json,'.')||'", ');
					htp.prn('"valores": "'||trim(ws_valor)||'", ');
					htp.prn('"grupo": "A"');
				else 
					ws_acumulado := ws_acumulado + to_number(nvl(ret_coluna,0));
				end if; 

			end if;
			
			if ws_amostra = 0 or ws_count <= ws_amostra THEN
				htp.prn('}, ');
			end if; 	

		end loop;

		ws_ct_agrupador := 0;

		-- acumulado separado
		-------------------------------------------------------------------
		if WS_AMOSTRA <> 0 and length(fun.getprop(WS_OBJETO, 'TEXTO_ACUMULADO')) > 0 then
			ws_id := ws_id+1;
			htp.prn('"'||ws_id||'": {');
			htp.prn('"cod":  "ACUMULADO", ');
			htp.prn('"colunas":  "'||replace(trim(fun.getprop(ws_OBJETO, 'TEXTO_ACUMULADO')), chr(9), '')||'", ');
			
			ws_count := 0;

			if ws_qt_valor > 1 then

				ws_acumulado_text := '[';
				
				loop
					ws_count := ws_count+1;
					if ws_count > ws_dados_arr.count then
						exit;
					end if;

					begin
						ws_acumulado_text := ws_acumulado_text||'{';
						ws_acumulado_text := ws_acumulado_text||'"grupo": ';
						ws_acumulado_text := ws_acumulado_text||'"'||ws_grupos_arr(ws_count)||'", ';
						ws_acumulado_text := ws_acumulado_text||'"valor": ';
						ws_acumulado_text := ws_acumulado_text||'"'||ws_dados_arr(ws_count)||'" ';

						if ws_count < ws_dados_arr.count then
							ws_acumulado_text := ws_acumulado_text||'}, ';
						else
							ws_acumulado_text := ws_acumulado_text||'} ';
						end if;
					exception when others then
						htp.p(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
					end;
				end loop;

				ws_acumulado_text :=  ws_acumulado_text||'] }';
				htp.prn('"valores":  '||ws_acumulado_text||', ');
			else
				htp.prn('"valores":  "'||ws_acumulado||'", ');
				htp.prn('"grupo":  "A" },');
			end if;
		end if;

		htp.prn('</span>');

	END monta_json_grafico; 


	PROCEDURE monta_json_SANKEY is 
		ws_json_agru clob; 
		ws_json_link clob; 
		ret_valor    varchar2(200); 
		ws_tot_col   integer;
		ws_nr_rec    integer; 
		ws_tp_link   varchar2(10); 
		ws_nm_col    varchar2(200);
		ws_cod       varchar2(200); 
		ws_des       varchar2(200); 
		ws_origem    varchar2(500);
		ws_destino   varchar2(500);
		ws_ordem     number; 
		ws_count     integer;
	begin 

		-- Percorre as Linhas 
		---------------------------------------------------
		delete BI_GRAFICO_TMP; 
		ws_tot_col     := ret_cols.COUNT; 
		ws_nlin        := 0;
		ws_nr_rec      := 0;
		ws_ordem       := 0 ;
		ws_json_agru   := null;
		ws_json_link   := null;

		loop
			ws_linhas := dbms_sql.fetch_rows(ws_cursor);
			if ws_linhas = 1 then -- Retornou registro 
				ws_nlin := ws_nlin + 1;
			else
				exit; -- Encerra o loop de linhas 
			end if;

			-- Se foi parametrizado amostragem 
			if ws_amostra <> 0 and ws_nlin > ws_amostra THEN
				exit; 
			end if;

			-- Percorre as colunas do registro 
			---------------------------------------------------
			ws_ncol     := 0;
			ws_tp_link  := 'source:'; 
			ws_origem   := null;
			loop
				ws_ncol := ws_ncol + 1; 
				exit when( ws_ncol > ws_tot_col); 
				dbms_sql.column_value(ws_cursor, ws_ncol, ret_coluna);
				if ret_cols(ws_ncol).st_agrupador = 'SEM' then	       -- Coluna Agrupadora 
					
					ws_nm_col := ret_cols(ws_ncol).cd_coluna;
					ws_cod    := ret_coluna;
					ws_des    := null; 

					if ret_cols(ws_ncol).cd_ligacao <> 'SEM' then -- Se tem TAUX 
						ws_ncol := ws_ncol + 1; 
						dbms_sql.column_value(ws_cursor, ws_ncol, ret_coluna);
						ws_des  := substr(ret_coluna,1,ws_tam_desc_label);
					end if; 
					
					ws_destino := ws_nm_col||'|'||ws_cod||'|'||ws_des; 

					dbms_sql.column_value(ws_cursor, ws_tot_col, ret_valor );   -- Pega a última coluna que contem o valor 
					if ws_origem is not null then 
						update BI_GRAFICO_TMP set val1 = nvl(val1,0) + ret_valor
				     	 where col1 = ws_origem
					   	   and col2 = ws_destino;
						if sql%notfound then
							ws_ordem := ws_ordem + 1; 
							insert into BI_GRAFICO_TMP (ordem, col1, col2, val1) values (ws_ordem, ws_origem, ws_destino, ret_valor);
						end if;    
					end if; 	   
					ws_origem := ws_destino; 
				end if; 
			end loop; 
		end loop;
		
		-- MOnta json com os agrupadores 
		htp.prn('<span class="json_data">['); 
		ws_count := 0;
		for a in (select nome, max(valor) as valor, min(ordem) as ordem, min(ordem_tipo) as ordem_tipo
		            from (select 1 ordem_tipo, col1 as nome, sum(val1) as valor, min(ordem) as ordem from BI_GRAFICO_TMP group by col1 union all 
				  	      select 2 ordem_tipo, col2 as nome, sum(val1) as valor, min(ordem) as ordem from BI_GRAFICO_TMP group by col2  
						 )
					group by nome 
				    order by ordem, ordem_tipo 	
				 ) loop 		 
			ws_count := ws_count + 1;					
			if ws_count > 1 then 
				htp.prn(','); 
			end if;	
			--htp.prn('{"name":"'||substr(a.nome,'"', '\"')||'","value":"'||a.valor||'"}');
			htp.prn('{"name":"'||replace(a.nome,'"', '\"')||'","value":"'||a.valor||'"}');
		end loop; 
		htp.prn(']</span>');

		-- MOnta json com os links entre os agrupadores 
		htp.prn('<span class="json_link">[');
		ws_count := 0;
		for a in (select col1, col2, val1 from BI_GRAFICO_TMP order by ordem) loop 		 
			ws_count := ws_count + 1;					
			if ws_count > 1 then 
				htp.prn(','); 
			end if;	
			htp.prn('{"source":"'||replace(a.col1,'"','\"')||'","target":"'||replace(a.col2,'"','\"')||'","value":"'||a.val1||'"}');
		end loop; 
		htp.prn(']</span>');

		if ws_nlin = 0 then 
			raise ws_nodata; 
		end if; 

		-- htp.prn('<span class="json_data">['||ws_json_agru||']</span>');
		--htp.prn('<span class="json_link">['||ws_json_link||']</span>');
		
		commit; -- limpa temporaria 

	END monta_json_SANKEY; 

	PROCEDURE monta_json_SCATTER is 
		ws_json   		clob;
		ws_cod_ante   varchar2(200);
		ws_col    		varchar2(200);
		ws_cod    		varchar2(200);
		ws_des    		varchar2(200);
		ws_col2    		varchar2(200);
		ws_cod2    		varchar2(200);
		ws_des2    		varchar2(200);

		ws_x      		varchar2(200);
		ws_y      		varchar2(200);
		ws_dim          varchar2(200);
		ws_ncol 		integer; 
		ws_qt_grup      integer; 
		ws_maior_X      number; 
		ws_menor_X      number; 
		ws_maior_Y      number; 
		ws_menor_Y      number; 
		ws_maior_dim    number; 
	begin 

		ws_json 	 := null;
		ws_cod_ante  := null;
		ws_qt_grup   := 0;
		ws_maior_X   := 0;
		ws_maior_Y   := 0;
		ws_menor_X   := 9999999999999999999999999;
		ws_menor_Y   := 9999999999999999999999999;
		ws_maior_dim := 0;
		loop
			ws_linhas := dbms_sql.fetch_rows(ws_cursor);
			exit when (ws_linhas <= 0) ;
			
			ws_nlin   := ws_nlin + 1;
			ws_ncol   := 1;
			dbms_sql.column_value(ws_cursor, ws_ncol, ret_coluna);
			ws_col   := ret_cols(ws_ncol).cd_coluna;
			ws_cod   := substr(ret_coluna,1,200); 
			ws_des   := '';
			-- Pega o agrupador 1
			if ws_cod_ante is null or ws_cod <> ws_cod_ante then 
				ws_qt_grup := ws_qt_grup + 1; 
				if ret_cols(ws_ncol).cd_ligacao <> 'SEM' then -- Se tem TAUX 
					ws_ncol := ws_ncol + 1; 
					dbms_sql.column_value(ws_cursor, ws_ncol, ret_coluna);
					ws_des  := substr(ret_coluna,1,ws_tam_desc_label);
				end if; 
				if ws_json is not null then 
					ws_json := substr(ws_json,1,length(ws_json)-1)||']},';
				end if;	
				ws_cod_ante := ws_cod; 				
				ws_json     := ws_json||'"'||ws_qt_grup||'":{"cod":"'||ws_cod||'","name":"'||ws_des||'","valores":[';
			end if;

			-- Pega o agrupador 2 (se houver)
			ws_cod2 := '';
			ws_des2 := '';
			if ws_qt_agrupador = 2 then 
				ws_ncol := ws_ncol + 1;
				dbms_sql.column_value(ws_cursor, ws_ncol, ret_coluna);
				ws_col2 := ret_cols(ws_ncol).cd_coluna;
				ws_cod2 := substr(ret_coluna,1,200);
				if ret_cols(ws_ncol).cd_ligacao <> 'SEM' then -- Se tem TAUX 
					ws_ncol := ws_ncol + 1; 
					dbms_sql.column_value(ws_cursor, ws_ncol, ret_coluna);
					ws_des2  := substr(ret_coluna,1,ws_tam_desc_label);
				end if; 
			end if;

			-- Pega o valor 1 (x)
			ws_ncol := ws_ncol + 1;
			dbms_sql.column_value(ws_cursor, ws_ncol, ret_coluna);  
			ws_x := substr(ret_coluna,1,200);
			begin 
				if to_number(ret_coluna) > ws_maior_X then ws_maior_X := to_number(ret_coluna); end if; 
				if to_number(ret_coluna) < ws_menor_X then ws_menor_X := to_number(ret_coluna); end if; 
			exception when others then 
				ws_maior_X := 0;
				ws_menor_X := 0;
			end; 	

			-- Pega o valor 2 (y)
			ws_ncol := ws_ncol + 1;
			dbms_sql.column_value(ws_cursor, ws_ncol, ret_coluna);  
			ws_y := substr(ret_coluna,1,200);
			begin 
				if to_number(ret_coluna) > ws_maior_Y then ws_maior_Y := to_number(ret_coluna); end if; 
				if to_number(ret_coluna) < ws_menor_Y then ws_menor_Y := to_number(ret_coluna); end if; 
			exception when others then
				ws_maior_Y := 0;
				ws_menor_Y := 0;
			end; 
			
			-- Pega o valor 3 (dimensão) (se houver)
			if ws_qt_valor > 2 then 
				ws_ncol := ws_ncol + 1;
				dbms_sql.column_value(ws_cursor, ws_ncol, ret_coluna);  
				ws_dim := substr(ret_coluna,1,200);
				if to_number(ws_dim) > ws_maior_dim then 
					ws_maior_dim := to_number(ws_dim);
				end if; 
			else 	
				ws_dim := '0';
			end if; 

			ws_json := ws_json || '["'||ws_x||'","'||ws_y||'","'||ws_dim||'","'||ws_cod||'","'||ws_des||'","'||ws_cod2||'","'||ws_des2||'","'||ws_col||'","'||ws_col2||'"],'; 

		end loop;

		ws_json := substr(ws_json,1,length(ws_json)-1)||']}';

		if ws_json is null then 
			raise ws_nodata; 
		end if; 

		htp.prn('<span class="json">' ||ws_json||'</span>');
		htp.prn('<span class="json2">{"maior_x":"'||ws_maior_x||'","menor_x":"'||ws_menor_x||'",'||
									 '"maior_y":"'||ws_maior_y||'","menor_y":"'||ws_menor_y||'",'||
		                             '"maior_dim":"'||ws_maior_dim||'"}</span>');

	end monta_json_SCATTER;

	PROCEDURE monta_json_RADAR is 
		ws_json_ind		clob;
		ws_json   		clob;
		ws_cod    		varchar2(200);
		ws_des    		varchar2(200);
		ws_col2         varchar2(200);
		ws_cod2    		varchar2(200);
		ws_des2    		varchar2(200);
		ws_val          number;
		ws_ncol 		integer; 
		ws_tot_col		integer; 
	begin 
		ws_ncol     := 0;
		ws_tot_col  := ret_cols.COUNT; 
		ws_json 	:= null;
		loop
			ws_linhas := dbms_sql.fetch_rows(ws_cursor);
			exit when (ws_linhas <= 0) ;
			
			ws_nlin   := ws_nlin + 1;
			ws_ncol   := 1;
			dbms_sql.column_value(ws_cursor, ws_ncol, ret_coluna);
			ws_cod   := substr(ret_coluna,1,200); 
			ws_des   := '';
			-- Pega o agrupador 1 - Indicadores 
			if ret_cols(ws_ncol).cd_ligacao <> 'SEM' then -- Se tem TAUX 
				ws_ncol := ws_ncol + 1; 
				dbms_sql.column_value(ws_cursor, ws_ncol, ret_coluna);
				ws_des  := substr(ret_coluna,1,ws_tam_desc_label);
			end if; 

			-- Pega o agrupador 2 (se houver)
			ws_cod2 := '';
			ws_des2 := '';
			if ret_cols(ws_ncol+1).st_agrupador = 'SEM' then	       -- Coluna Agrupadora 
				ws_ncol := ws_ncol + 1;
				dbms_sql.column_value(ws_cursor, ws_ncol, ret_coluna);
				ws_col2 := ret_cols(ws_ncol).cd_coluna; 
				ws_cod2 := substr(ret_coluna,1,200);
				if ret_cols(ws_ncol).cd_ligacao <> 'SEM' then -- Se tem TAUX 
					ws_ncol := ws_ncol + 1; 
					dbms_sql.column_value(ws_cursor, ws_ncol, ret_coluna);
					ws_des2  := substr(ret_coluna,1,ws_tam_desc_label);
				end if; 
			end if; 

			-- Pega colunas de valores 
			loop
				ws_ncol := ws_ncol + 1; 
				exit when( ws_ncol > ws_tot_col); 
				dbms_sql.column_value(ws_cursor, ws_ncol, ret_coluna);
				if ret_cols(ws_ncol).st_agrupador <> 'SEM' then	       -- Coluna Agrupadora 
					dbms_sql.column_value(ws_cursor, ws_ncol, ret_coluna);  
					update BI_GRAFICO_TMP 
					   set val1 = nvl(val1,0) + to_number(ret_coluna)
					 where col1 = ws_cod
					   and col3 = ws_cod2
					   and col5 = ret_cols(ws_ncol).cd_coluna; 
					if sql%notfound then 
						insert into BI_GRAFICO_TMP (col1, col2, col3, col4, col5, col6, col7, val1)
						                    values (ws_cod, ws_des, ws_cod2, ws_des2, ws_col2, ret_cols(ws_ncol).cd_coluna, ret_cols(ws_ncol).nm_rotulo, to_number(ret_coluna)) ; 
					end if;    
				end if; 
			end loop; 	
		end loop;

		if ws_ncol = 0 then 
			raise ws_nodata; 
		end if; 

		-- Monta os indicadores 
		ws_json_ind := null;
		for a in (select distinct col1, col2 from bi_grafico_tmp order by 1) loop 
			ws_json_ind := ws_json_ind||'{"cod":"'||a.col1||'","name":"'||a.col2||'"},';
		end loop;
		ws_json_ind := '['||substr(ws_json_ind,1,length(ws_json_ind)-1)||']';

		-- Monta as áreas do gráfico 
		for a in (select distinct col3, col4, col5, col6, col7 from bi_grafico_tmp order by 1) loop 		
			ws_json := ws_json||'{"name":"'||a.col7||'","dados":["'||a.col3||'","'||a.col4||'","'||a.col5||'","'||a.col6||'"],"valores":[';
			for b in (select distinct col1, col2 from bi_grafico_tmp order by 1) loop
				select nvl(sum(val1),0) into ws_val 
				  from bi_grafico_tmp
				 where col1          = b.col1           -- col1
				   and nvl(col3,'1') = nvl(a.col3,'1')  -- cod2
				   and col6          = a.col6;          -- cd_coluna de valores 
				ws_json := ws_json||'"'||ws_val||'",';
			end loop;
			ws_json := substr(ws_json,1,length(ws_json)-1)||']},';
		end loop; 	
		ws_json := '['||substr(ws_json,1,length(ws_json)-1)||']';

		htp.prn('<span class="json">'  ||ws_json_ind||'</span>');
		htp.prn('<span class="json2">' ||ws_json||'</span>');

	end monta_json_RADAR;

	procedure monta_json_CALENDARIO is

		ws_ncol integer;
		ws_data_convertida date;
		ret_coluna_data varchar2 (32000);
		v_column_count integer;
		l_ntt_desc_tab dbms_sql.desc_tab;
		ws_max_date date;
		ws_min_date date;

	begin

		ws_max_date := to_date('1900-01-01', 'YYYY-MM-DD');
		ws_min_date := to_date('9999-12-31', 'YYYY-MM-DD');

		DBMS_SQL.DESCRIBE_COLUMNS(ws_cursor, v_column_count, l_ntt_desc_tab);

		v_column_count := v_column_count - 4;

		htp.prn('<span class="json">');

		htp.prn('[');

		loop
			ws_linhas := dbms_sql.fetch_rows(ws_cursor);
			exit when (ws_linhas <= 0);
			ws_nlin   := ws_nlin + 1;
			ws_ncol   := 1;
			dbms_sql.column_value(ws_cursor, ws_ncol, ret_coluna);

			ret_coluna_data := fun.ifmascara(ret_coluna, 'YYYY-MM-DD');
			
			if ret_coluna_data <> ret_coluna then

				ws_data_convertida := to_date(ret_coluna_data, 'YYYY-MM-DD');

				if ws_data_convertida > ws_max_date then
					ws_max_date := ws_data_convertida; 
				end if;

				if ws_data_convertida < ws_min_date then
					ws_min_date := ws_data_convertida; 
				end if;

				htp.prn('{"date": "' || ret_coluna_data || '", "values": [');

				for a in 1..v_column_count loop
				
					ws_ncol   := ws_ncol + 1;

					dbms_sql.column_value(ws_cursor, ws_ncol, ret_coluna);
						
					htp.prn('{"value": "' || ret_coluna || '"}, ');

				end loop;

				ws_ncol   := ws_ncol + 1;

				dbms_sql.column_value(ws_cursor, ws_ncol, ret_coluna);

				htp.prn('{"value": "' || ret_coluna || '"}]},');
				
			else
				raise ws_nodata;
			end if;

		end loop;

		htp.prn(']');
		
		htp.prn('</span>');

		htp.prn('<span id="ws_range_date">');
		htp.prn('["' || to_char(ws_min_date, 'YYYY-MM') || '", "'|| to_char(ws_max_date, 'YYYY-MM') ||'"]');
		htp.prn('</span>');

	end monta_json_CALENDARIO;

	procedure monta_json_pivot_grafico is
		ws_first_value 		number;
		ws_linha 			varchar2(32000);
		l_col_cnt 			NUMBER;
		l_desc_tab 			DBMS_SQL.DESC_TAB;	
		ws_ncol 		  	integer; 
		ws_tot_col		  	integer; 
		ws_primeiro_grupo varchar2(1); 
		ws_des    	  	  varchar2(200);
		ws_prop_lab2      varchar2(30);
		ws_agrup1_cd      varchar2(4000);
		ws_agrup1_cd_ante varchar2(4000);		
		ws_agrup1_ds      varchar2(4000);
		ws_agrup2_cd      varchar2(4000);
		ws_agrup2_ds      varchar2(4000);
		ws_valor          varchar2(400);
		ws_ordem          number; 

	begin

		delete BI_GRAFICO_TMP; 
		ws_ordem        := 0;
		ws_ct_agrupador := 0;
		ws_vazio     := True;
		ws_nlin      := 0;
		ws_id        := 1;
		ws_prop_lab2 := nvl(fun.getprop(ws_objeto, 'LABEL_CONTEUDO_2'),'D');
		ws_count     := ws_count + 1;
		
		htp.prn('<span class="json">');

		ws_agrup1_cd_ante := null;
		ws_agrupador_pv   := null;
		ws_ncol           := 0;
		ws_tot_col        := ret_cols.COUNT; 

		loop

			ws_linhas := dbms_sql.fetch_rows(ws_cursor);

			if ws_linhas = 1 then
				ws_nlin  := ws_nlin + 1; 
			else
				exit;
			end if;

			ws_linha := null;

				
			-- Pega 1o Agrupador 
			-----------------------------------------------------------
			ws_ncol := 1;
			dbms_sql.column_value(ws_cursor, ws_ncol, ret_coluna);
			ws_agrup1_cd := ret_coluna;

			ws_agrup1_ds := '';
			if ret_cols(ws_ncol).cd_ligacao <> 'SEM' then -- Se tem TAUX 
				ws_ncol := ws_ncol + 1; 
				dbms_sql.column_value(ws_cursor, ws_ncol, ret_coluna);
				ws_agrup1_ds  := substr(ret_coluna,1,ws_tam_desc_label);
			end if; 

			ws_colunas_json := substr(fun.converte_json(trim(fun.ifmascara(nvl(ws_agrup1_ds, ws_agrup1_cd), ret_mcol(ws_counter).nm_mascara, prm_micro_visao, ret_mcol(ws_counter).cd_coluna, '', '', '', ''))),1,ws_tam_desc_label); 			

			if ws_agrup1_cd_ante is null or ws_agrup1_cd <> ws_agrup1_cd_ante THEN

				if ws_agrup1_cd <> ws_agrup1_cd_ante then
					ws_linha := ws_linha || ' ] },';
				end if;

				ws_linha := ws_linha || '"'||ws_id||'": {';
				ws_linha := ws_linha || '"cod":"'||ws_agrup1_cd||'",';
				ws_linha := ws_linha || '"name": "'||fun.converte_json(replace(nvl(ws_agrup1_ds, ws_agrup1_cd), '|', '#@PIPE@#'))||'",';				
				ws_linha := ws_linha || '"colunas": "'||nvl(ws_colunas_json,'.')||'", ';
				ws_linha := ws_linha || '"valores": [';

				ws_id             := ws_id + 1;
				ws_primeiro_grupo := 'S' ;
				
			end if; 

			ws_labelc := 0;

			-- Pega 2o agrupador 
			------------------------------------------------------------------------------
			ws_ncol := ws_ncol + 1; 
			dbms_sql.column_value(ws_cursor, ws_ncol, ret_coluna);
			ws_agrup2_cd := ret_coluna;

			ws_agrup2_ds := ws_agrup2_cd;
			if ret_cols(ws_ncol).cd_ligacao <> 'SEM' then -- Se tem TAUX 
				ws_ncol := ws_ncol + 1; 
				dbms_sql.column_value(ws_cursor, ws_ncol, ret_coluna);
				ws_agrup2_ds  := substr(ret_coluna,1,ws_tam_desc_label);
				if ws_prop_lab2    = 'A' then  ws_agrup2_ds := ws_agrup2_cd||'-'||ws_agrup2_ds;
				elsif ws_prop_lab2 = 'C' then  ws_agrup2_ds := ws_agrup2_cd;
				end if; 
			end if; 


			-- Pega o valor 
			------------------------------------------------------------------------
			ws_ncol := ws_ncol + 1; 
			dbms_sql.column_value(ws_cursor, ws_ncol, ret_coluna);
			ws_valor := ret_coluna; 


			if ws_agrup2_cd is null then 
				ws_agrup2_cd := 'naodefinido';
				ws_agrup2_ds := 'n&atilde;o definido';
			end if ;
			ws_agrup2_cd := trim(ws_agrup2_cd);
			ws_agrup2_ds := trim(ws_agrup2_ds);
			
			if ws_primeiro_grupo = 'S' then  	ws_linha := ws_linha || '{';
			else                    			ws_linha := ws_linha || ', {';
			end if; 
			ws_primeiro_grupo := 'N' ;
			ws_linha := ws_linha || '"grupo": "'||ws_agrup2_cd||'", ';
			ws_linha := ws_linha || '"valor": "'||ws_valor||'"';
			ws_linha := ws_linha || '}';

			htp.prn(ws_linha);

			update BI_GRAFICO_TMP set col2 = ws_agrup2_ds
				where col1 = ws_agrup2_cd; 
			if sql%notfound then
				ws_ordem := ws_ordem + 1; 
				insert into BI_GRAFICO_TMP (ordem, col1, col2) values (ws_ordem, ws_agrup2_cd, ws_agrup2_ds);
			end if;  
	
			ws_agrup1_cd_ante := ws_agrup1_cd;

		end loop;
		
		htp.p(' ] },');
		
		htp.p('</span>');

		ws_agrupador_pv := null; 
		select listagg(col1||'#$DIV$#'||col2, '|') within group (order by ordem) into ws_agrupador_pv from BI_GRAFICO_TMP;

	end monta_json_pivot_grafico;


begin

	ws_usuario := prm_usuario;
	if ws_usuario is null then    
		ws_usuario := gbl.getUsuario;
	end if;

	if  prm_cd_goto is not null then 
		ws_objeto   := fun.get_cd_obj(prm_objeto);
		ws_obj_html := ws_objeto||'trl'||prm_cd_goto;
	else
		ws_objeto   := prm_objeto; 
		ws_obj_html := prm_objeto;
	end if;

	ws_padrao      := gbl.getLang;
	ws_admin       := nvl(gbl.getNivel, 'N');
	ws_nm_tabela   := null;
	ws_owner_table := nvl(fun.ret_var('OWNER_TABLE_DATA'),'DWU'); 

	select tp_objeto into ws_tipo from objetos where cd_objeto = ws_objeto;
	select max(nm_tabela) into ws_nm_tabela from micro_visao where nm_micro_visao = prm_micro_visao;

	if nvl(fun.ret_var('LOG_EXEC'),'N') in ('S','D') then 
		ws_log_exec    := fun.ret_var('LOG_EXEC');
		ws_log_exec_id := null;
	end if; 	

	begin
		ws_tam_desc_label:= trunc(trim(fun.getProp(ws_objeto,'TAM_DESC_LABEL_GRAFICO',prm_screen,'DWU','')),0);
	exception
	when others then
		ws_tam_desc_label:=0;
	end;
	if nvl(ws_tam_desc_label,0) = 0 then
		ws_tam_desc_label := 40;
	end if;
	if ws_tam_desc_label > 1000 then
		ws_tam_desc_label := 1000;
	end if;


	select cs_coluna, cs_agrupador into ws_coluna, ws_agrupador from ponto_avaliacao where cd_ponto = ws_objeto;
	if nvl(prm_agrupador_troca,'null') <> 'null' then 
		ws_agrupador := prm_agrupador_troca;
	else 
		ws_ordem_drill := null;
		if nvl(prm_cd_goto,0) <> 0 then 
			-- Procura ordenação da drill,  1-prm_screm+ws_usuario, 2-DEFAULT+ws_usuario, 3-DEFAULT+DWU
			for a in 1..3 loop
				if ws_ordem_drill is null then 
					select max(upper(propriedade)) into ws_ordem_drill from object_attrib 
					where cd_object = ws_obj_html
					and cd_prop   = 'ORDEM' 
					and screen    = decode(a,1,prm_screen,2,'DEFAULT', 3,'DEFAULT') 
					and owner     = decode(a,1,ws_usuario,2,ws_usuario,3,'DWU');
				end if; 
			end loop; 
			--
			select nvl(max(cs_coluna), ws_coluna), nvl(max(cs_agrupador),ws_agrupador), nvl(max(cs_colup), ws_colup), nvl(ws_ordem_drill, max(orderby))
			into ws_coluna, ws_agrupador, ws_colup, ws_ordem_drill 
			from GOTO_OBJETO
			where cd_goto_objeto = prm_cd_goto ; 
			--
		end if; 	 	
	end if; 
	
	ws_agrupador := ws_agrupador||'|'||fun.getprop(ws_objeto, 'SEC');

	/********
	select cs_coluna into ws_coluna from ponto_avaliacao where cd_ponto = prm_objeto;

	if nvl(prm_agrupador_troca,'null') <> 'null' then 
		ws_agrupador := prm_agrupador_troca||'|'||fun.getprop(prm_objeto, 'SEC');
	else 	
		select cs_agrupador||'|'||fun.getprop(prm_objeto, 'SEC') into ws_agrupador from ponto_avaliacao where cd_ponto = prm_objeto;
	end if; 	
	************/ 


	if NVL(prm_ordem_troca,'null') <> 'null' then 
		ws_ordem := prm_ordem_troca ;
	else 
		if nvl(prm_cd_goto,0) <> 0 and ws_ordem_drill is not null then 
			ws_ordem := ws_ordem_drill;
		else 	
			ws_ordem := 'Y';
		end if; 	
	end if;     

	ws_rp        := 'GRUPO';
	ws_colup     := '';

	open  crs_micro_visao;
	fetch crs_micro_visao into ws_micro_visao;
	close crs_micro_visao;

	ws_parametros := prm_parametros;

	
	open nc_colunas;
		loop
			fetch nc_colunas bulk collect into ret_mcol limit 2000;
			exit when nc_colunas%NOTFOUND;	
		end loop;
	close nc_colunas;

	for a in crs_colsb (ws_agrupador) loop 
		ws_ctx := ws_ctx + 1;
		ws_datasets(ws_ctx) := replace(fun.utranslate('NM_ROTULO', prm_micro_visao, fun.check_rotuloc(a.cd_coluna,prm_micro_visao, prm_screen), ws_padrao), '<BR>', ' ');
		ws_datasets_cd(ws_ctx) := a.cd_coluna;
	end loop;
	
	loop
		ws_counter := ws_counter + 1;
		if ws_counter > ret_mcol.COUNT then
			exit;
		end if;
		if rtrim(ret_mcol(ws_counter).st_agrupador) <> 'SEM' and fun.setem(ws_agrupador,rtrim(ret_mcol(ws_counter).cd_coluna)) then
			ws_scol := ws_scol + 1;
		end if;
		
	end loop;



	
	
	select count(*) into ws_qt_valor     from TABLE(fun.VPIPE(ws_agrupador)) where trim(column_value) is not null;
	select count(*) into ws_qt_agrupador from TABLE(fun.VPIPE(ws_coluna))    where trim(column_value) is not null;
	ws_agrupar_valor := trim(fun.getProp(ws_objeto,'AGRUPAR-VALOR',prm_screen,'DWU',''));

	if ws_tipo in('LINHAS','BARRAS','COLUNAS') then
		if ws_qt_valor > 1 and ws_qt_agrupador > 1 then
			ws_erro := 'Esse tipo de gr&aacute;fico n&atilde;o permite mais de uma coluna de AGRUPADOR com mais de uma coluna de VALOR selecionada, corrija as propriedades do objeto.'; 
			raise ws_raise_erro;
		elsif ws_qt_agrupador > 2 then
			ws_erro := 'Esse tipo de gr&aacute;fico n&atilde;o permite mais de duas colunas de AGRUPADOR, corrija as propriedades do objeto.'; 
			raise ws_raise_erro;
		end if;
	end if;

	if ws_tipo in ('PIZZA','SANKEY') then 
		if ws_qt_valor > 1 then 
			ws_erro := 'Esse tipo de gr&aacute;fico n&atilde;o permite mais de uma coluna de VALOR, corrija o atributo VALOR do objeto.'; 
			raise ws_raise_erro; 
		elsif ws_qt_valor = 0 then  
			ws_erro := 'Deve ser informado pelo menos uma coluna de VALOR, corrija o atributo VALOR do objeto.'; 
			raise ws_raise_erro; 
		end if; 
	end if; 	
	if ws_tipo  = 'SANKEY' and ws_qt_agrupador <= 1 then
		ws_erro := 'Deve ser informado pelo menos uma coluna de AGRUPADOR, corrija o atributo AGRUPADOR do objeto.'; 
		raise ws_raise_erro;
	end if; 
	if ws_tipo in ('SCATTER') then 
		if ws_qt_valor not in (2,3) then 
			ws_erro := 'Deve ser selecionando 2 ou 3 colunas de valores, corrija a propriedade VALOR.'; 
			raise ws_raise_erro; 
		end if; 
		if ws_qt_agrupador not in (1,2)  then 
			ws_erro := 'Deve ser selecionando 1 ou 2 colunas de agrupador, corrija a propriedade AGRUPADOR.'; 
			raise ws_raise_erro; 
		end if; 
	end if; 	
	
	if ws_tipo in ('RADAR') then 
		if (ws_qt_agrupador > 2 ) then 
			ws_erro := 'Esse tipo de gr&aacute;fico n&atilde;o permite mais que 2 agrupadores, verifique a propriedade AGRUPADOR.'; 
			raise ws_raise_erro; 
		end if; 
	end if;

	if ws_tipo in ('CALENDARIO') then 
		if (ws_qt_agrupador > 1 ) then 
			ws_erro := 'Esse tipo de gr&aacute;fico n&atilde;o permite mais que 1 agrupador.'; 
			raise ws_raise_erro; 
		end if; 
	end if; 

	if ws_tipo in ('BARRAS', 'COLUNAS') then 
		if (ws_qt_valor > 2 and ws_agrupar_valor = 'S') then 
			ws_erro := 'Esse tipo de gr&aacute;fico n&atilde;o permite mais que 2 valores com o atributo AGRUPAR VALOR ativo, verifique a propriedade VALOR.'; 
			raise ws_raise_erro; 
		end if; 
	end if; 	


	ws_amostra := to_number(nvl(fun.getprop(ws_objeto,'AMOSTRA'), '0'));

	begin
		ws_sql := core.MONTA_QUERY_DIRECT(prm_micro_visao, ws_coluna, ws_parametros, ws_rp, ws_colup, ws_query_pivot, ws_query_montada, ws_lquery, ws_ncolumns, ws_pvcolumns, ws_agrupador, ws_mfiltro, ws_objeto, prm_ordem => ws_ordem, prm_screen => trim(prm_screen), prm_cross => 'N', prm_cab_cross => ws_cab_cross,prm_usuario => ws_usuario);
	end;
	
	if ws_sql like 'Excesso de filtros%' then
		raise ws_excesso_filtro; 
	end if; 

	-- Monta texto do SQL para retornar caso de erro.   
	ws_queryoc := '';
	begin
		ws_counter := 0;
		loop
			ws_counter := ws_counter + 1;
			if  ws_counter > ws_query_montada.COUNT then
				exit;
			end if;
			ws_queryoc := ws_queryoc||ws_query_montada(ws_counter);
		end loop;
	end;

	if ws_admin = 'A' or ws_log_exec in ('S','D') then
		ws_cursor := dbms_sql.open_cursor;
		dbms_sql.parse( c => ws_cursor, statement => ws_query_montada, lb => 1, ub => ws_lquery, lfflg => true, language_flag => dbms_sql.native );
		ws_binds := core.bind_direct(ws_parametros, ws_cursor, '', ws_objeto, prm_micro_visao, prm_screen, prm_usuario => ws_usuario );
		ws_binds := replace(ws_binds, 'Binds Carregadas=|', '');
		dbms_sql.close_cursor(ws_cursor);				
		ws_queryoc := nvl(substr(fun.replace_binds_clob (ws_queryoc, ws_binds),1,32000),'ERRO');
	end if; 

	if ws_admin = 'A' then  -- Grava a ultima query executada para o objeto
		begin  
			delete bi_object_query where cd_object = ws_objeto and nm_usuario = ws_usuario;
			insert into bi_object_query (cd_object, nm_usuario, dt_ultima_execucao, query) values (ws_objeto, ws_usuario, sysdate, ws_queryoc ); 
		exception when others then 
			insert into bi_log_sistema values (sysdate,'Erro gravando em bi_object_query ['||ws_objeto||']:'|| DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, ws_usuario,'ERRO');
		end; 
		commit;	
	end if;

	-- Monta array com as colunas das consultas com suas propriedades 
	ws_ncol := 0 ;
	loop
		ws_ncol := ws_ncol + 1;
		exit when (ws_ncol > ws_ncolumns.COUNT); 
		ws_counter := 0;
		loop
			ws_counter := ws_counter + 1;
			exit when (ws_counter > ret_mcol.COUNT); 
			if ret_mcol(ws_counter).cd_coluna = ws_ncolumns(ws_ncol) then
				ret_cols(ws_ncol) := ret_mcol(ws_counter); 
				exit;
			end if;
		end loop; 	
	end loop;

	if ws_log_exec in ('S','D') then 
		fun.log_exec_ATU ('INSERT', ws_log_exec, ws_log_exec_id, ws_objeto, ws_usuario, 'GRAFICO', 10, 'INICIO', ws_queryoc); 
	end if; 

	begin
		ws_cursor := dbms_sql.open_cursor;
		dbms_sql.parse( c => ws_cursor, statement => ws_query_montada, lb => 1, ub => ws_lquery, lfflg => true, language_flag => dbms_sql.native );
		ws_sql := core.bind_direct(ws_parametros, ws_cursor, '', ws_objeto, prm_micro_visao, prm_screen,prm_usuario => ws_usuario );
		exception when others then
			raise ws_excep_parse; 
	end; 

	begin
		ws_counter := 0;
		loop
			ws_counter := ws_counter + 1;
			if ws_counter > ws_ncolumns.COUNT then
				exit;
			end if;
			dbms_sql.define_column(ws_cursor, ws_counter, ret_coluna, 200);
		end loop;
		ws_linhas := dbms_sql.execute(ws_cursor);
	end;

	ws_counter := 0;
	loop
		ws_counter := ws_counter + 1;
		if ws_counter > ret_mcol.COUNT or ws_ncolumns(1) = ret_mcol(ws_counter).cd_coluna then
			exit;
		end if;
	end loop;

	ws_perc_col := '';

	ws_parametros := fun.check_value(ws_parametros);
	ws_coluna := fun.check_value(ws_coluna);
	ws_count := 0;
	ws_acumulado := 0;
	ws_vl_total  := 0; 

	ws_nlin := 0; 

	if ws_tipo = 'SANKEY' then 
		monta_json_SANKEY; 
	elsif ws_tipo = 'SCATTER' then 
		monta_json_SCATTER; 
	elsif ws_tipo = 'RADAR' then 
		monta_json_RADAR;
	elsif ws_tipo = 'CALENDARIO' then 
		monta_json_CALENDARIO;
	else
		if ws_qt_agrupador = 2 and ws_qt_valor < 2 and ws_tipo in('LINHAS','BARRAS','COLUNAS')  then
			monta_json_pivot_grafico;
		else 
			monta_json_grafico;
		end if;
	end if;
	
	dbms_sql.close_cursor(ws_cursor);
	
	if ws_nlin = 0 then -- Não retornou linhas para o objeto 
		raise ws_nodata;
	end if;


	-- Monta span com os destaques que deve ser aplicados no Gráfico, utilizado no JS para aplicar o destaque 
	ws_count_destaque := 0;
	ws_destaques      := ''; 
	open crs_destaques(ws_usuario);
	loop
		fetch crs_destaques into ws_destaque;
		exit when crs_destaques%notfound;
			ws_count_destaque := ws_count_destaque+1;
			ws_destaques := ws_destaques||', &quot;'||ws_count_destaque||'&quot: {&quot;coluna&quot;: &quot;'||replace(replace(fun.nome_col(ws_destaque.cd_coluna, PRM_MICRO_VISAO), '<BR>', ' '), '<br>', ' ')||'&quot;, &quot;cor&quot;: &quot;'||ws_destaque.cor_fundo||'&quot;, &quot;valor&quot;: &quot;'||replace(fun.subpar(ws_destaque.conteudo, PRM_SCREEN), '<br>', '')||'&quot, &quot;condicao&quot;: &quot;'||ws_destaque.condicao||'&quot, &quot;tipo&quot;: &quot;'||ws_destaque.data_type||'&quot, &quot;mascara&quot;: &quot;'||ws_destaque.mascara||'&quot}';
	end loop;
	close crs_destaques;
	ws_destaques := substr(ws_destaques, 2, 4000);
	htp.p('<span class="cor">'||ws_destaques||'</span>');

	if ws_agrupador_pv is not null then 
		htp.p('<span id="'||prm_objeto||'-agrupador_pivot">');
		htp.p(ws_agrupador_pv);
		htp.p('</span>');
	end if;

	/**** Desabilitado esse atributo QUBE é utilizado somente para objetos CONSULTA 
	-- Monda span com do CUBE 
	ws_count := 0;
	ws_counter := 0;
	if ws_usuario = fun.usuario then
		loop
			ws_counter := ws_counter + 1;
			if  ws_counter > ws_query_montada.COUNT then
				exit;
			end if;
			if fun.getprop(ws_OBJETO, 'QUBE') = 'S' THEN
				if instr(ws_query_montada(ws_counter), 'SEG') > 0 then
					ws_qube := '<span style="z-index: 2; height: 15px; width: 16px; position: absolute; top: 2px; right: 2px; opacity: 0.3;"><svg height="512pt" viewBox="-34 0 512 512" width="512pt" xmlns="http://www.w3.org/2000/svg" style="width: inherit;height: inherit;"><path d="m221.703125 0-221.703125 128v256l221.703125 128 221.703125-128v-256zm176.515625 136.652344-176.515625 101.914062-176.515625-101.914062 176.515625-101.910156zm-368.132812 26.027344 176.574218 101.941406v203.953125l-176.574218-101.945313zm206.660156 305.894531v-203.953125l176.574218-101.941406v203.949218zm0 0"></path></svg></span>';
				end if;
			end if;
		end loop;
	end if;
	htp.p(ws_qube);
	**************************/ 

exception 
	when ws_raise_erro then 
		if ws_log_exec in ('S','D') then 
			fun.log_exec_ATU ('FIM', ws_log_exec, ws_log_exec_id, ws_objeto, ws_usuario, 'GRAFICO', 20, 'FINALIZADO - ERRO OUTROS', null);
		end if; 
		htp.p('<span id="'||ws_obj_html||'_ERR">'||ws_erro||'</span>');	
	when ws_excesso_filtro then  -- excesso de itens selecionados nos filtros 
		if ws_log_exec in ('S','D') then 
			fun.log_exec_ATU ('FIM', ws_log_exec, ws_log_exec_id, ws_objeto, ws_usuario, 'GRAFICO', 20, 'FINALIZADO - EXCESSO FILTRO', null);
		end if; 
		htp.p('<span id="'||ws_obj_html||'_ERR">'||ws_sql||'</span>');
	when ws_nodata then -- query sem dados 
		if ws_log_exec in ('S','D') then 
			fun.log_exec_ATU ('FIM', ws_log_exec, ws_log_exec_id, ws_objeto, ws_usuario, 'GRAFICO', 20, 'FINALIZADO - SEM DADOS', null);
		end if; 
		htp.p('<span id="'||ws_obj_html||'_ERR">'||fun.subpar(fun.getprop(ws_objeto,'ERR_SD'), prm_screen)||'</span>');
	when ws_raise_col_bloc then
		htp.prn('</span>'); -- Encerra o span do Json (esse erro acontece durante a montagem do json)
		if ws_log_exec in ('S','D') then 
			fun.log_exec_ATU ('FIM', ws_log_exec, ws_log_exec_id, ws_objeto, ws_usuario, 'GRAFICO', 20, 'FINALIZADO - COLUNA BLOQUEADO', null);
		end if; 
		insert into bi_log_sistema values (sysdate, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - CHAROUT', ws_usuario, 'ERRO');
		commit;
		if ws_admin = 'A' then 
			htp.p('<span id="'||ws_obj_html||'_ERR">'||'<br>N&atilde;o foi poss&iacute;vel montar os dados do gr&aacute;fico, verifique as propriedades e atributos do gr&aacute;fico. <br><br>ERRO:'||DBMS_UTILITY.FORMAT_ERROR_STACK||'.<br><br>SQL:'||ws_queryoc||' </span>');
		else 
			htp.p('<span id="'||ws_obj_html||'_ERR">'||'<br>N&atilde;o foi poss&iacute;vel montar os dados do gr&aacute;fico, Poss&iacute;vel coluna bloqueada para o usu&aacute;rio.</span>');
		end if; 

	when ws_excep_parse then		
		if ws_log_exec in ('S','D') then 
			fun.log_exec_ATU ('FIM', ws_log_exec, ws_log_exec_id, ws_objeto, ws_usuario, 'GRAFICO', 20, 'FINALIZADO - EXCEP PARSE', null);
		end if; 
		insert into bi_log_sistema values (sysdate, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - CHAROUT', ws_usuario, 'ERRO');
		commit;
		if ws_admin = 'A' then 
			htp.p('<span id="'||ws_obj_html||'_ERR">'||'<br>N&atilde;o foi poss&iacute;vel montar os dados do gr&aacute;fico, verifique as propriedades e atributos do gr&aacute;fico. <br><br>ERRO:'||DBMS_UTILITY.FORMAT_ERROR_STACK||'.<br><br>SQL:'||ws_queryoc||' </span>');
		else 
			htp.p('<span id="'||ws_obj_html||'_ERR">'||'<br>N&atilde;o foi poss&iacute;vel montar os dados do gr&aacute;fico, verifique as propriedades e atributos do gr&aacute;fico.</span>');
		end if; 
	when others then
		if ws_log_exec in ('S','D') then
			fun.log_exec_ATU ('FIM', ws_log_exec, ws_log_exec_id, ws_objeto, ws_usuario, 'GRAFICO', 20, 'FINALIZADO - ERRO OUTROS', null);
		end if; 
		insert into bi_log_sistema values (sysdate, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - CHAROUT', ws_usuario, 'ERRO');
		commit;
		if ws_admin = 'A' then 
			htp.p('</span><span id="'||ws_obj_html||'_ERR">'||'<br>Erro montando os dados do gr&aacute;fico. <br><br>ERRO:'||DBMS_UTILITY.FORMAT_ERROR_STACK||'.<br><br>SQL:'||ws_queryoc||' </span>');
		else 
			htp.p('</span><span id="'||ws_obj_html||'_ERR">'||'<br>Erro montando os dados do gr&aacute;fico.</span>');
		end if; 	

end CHAROUT;


procedure DATAGAUGE (  prm_objeto  varchar default null, 
					prm_screen  varchar default null,
					prm_mascara varchar default null ) as

ws_visao       varchar2(30);
ws_parametros  varchar2(2000);
ws_retorno     long;
ws_med         number;

begin

select cd_micro_visao, parametros   into
		ws_visao, ws_parametros
from   PONTO_AVALIACAO
where  cd_ponto = prm_objeto;


		ws_retorno := ('<chart theme="fint" showGaugeBorder="0" lowerlimit="0" upperlimit="'||fun.put_par(prm_objeto, 'VALOR_05_GOM', 'PONTEIRO')||'" minortmnumber="0" majortmheight="0" majortmthickness="0" showValues="'||fun.getprop(prm_objeto,'HIDDEN')||'" exportShowMenuItem="0" exportEnabled="1" exportAtClient="0" exportFileName="'||prm_objeto||'" bgAlpha="0,0" stroke-width="0" stroke-opacity="1"  gaugeFillMix="{light-20},{light-10},{light-10},{dark-10},{dark-20},{dark-30}" numberSuffix="">'
		||'<colorRange>'
			||'<color label="0" minValue="0" maxValue="'||fun.put_par(prm_objeto, 'VALOR_01_GOM', 'PONTEIRO')||'" code="'||fun.put_par(prm_objeto, 'COR_ID_01_GOM', 'PONTEIRO')||'"></color>'
			||'<color link="JavaScript: isJavaScriptCall=true; showview2('''');" label="'||fun.put_par(prm_objeto, 'ROTULO_01_GOM', 'PONTEIRO')||'" minValue="'||fun.put_par(prm_objeto, 'VALOR_01_GOM', 'PONTEIRO')||'" maxValue="'||fun.put_par(prm_objeto, 'VALOR_02_GOM', 'PONTEIRO')||'" code="'||fun.put_par(prm_objeto, 'COR_ID_02_GOM', 'PONTEIRO')||'"></color>'
			||'<color link="JavaScript: isJavaScriptCall=true; showview2('''');" label="'||fun.put_par(prm_objeto, 'ROTULO_02_GOM', 'PONTEIRO')||'" minValue="'||fun.put_par(prm_objeto, 'VALOR_02_GOM', 'PONTEIRO')||'" maxValue="'||fun.put_par(prm_objeto, 'VALOR_03_GOM', 'PONTEIRO')||'" code="'||fun.put_par(prm_objeto, 'COR_ID_03_GOM', 'PONTEIRO')||'"></color>'
			||'<color link="JavaScript: isJavaScriptCall=true; showview2('''');" label="'||fun.put_par(prm_objeto, 'ROTULO_03_GOM', 'PONTEIRO')||'" minValue="'||fun.put_par(prm_objeto, 'VALOR_03_GOM', 'PONTEIRO')||'" maxValue="'||fun.put_par(prm_objeto, 'VALOR_04_GOM', 'PONTEIRO')||'" code="'||fun.put_par(prm_objeto, 'COR_ID_04_GOM', 'PONTEIRO')||'"></color>'
			||'<color link="JavaScript: isJavaScriptCall=true; showview2('''');" label="'||fun.put_par(prm_objeto, 'ROTULO_04_GOM', 'PONTEIRO')||'" minValue="'||fun.put_par(prm_objeto, 'VALOR_04_GOM', 'PONTEIRO')||'" maxValue="'||fun.put_par(prm_objeto, 'VALOR_05_GOM', 'PONTEIRO')||'" code="'||fun.put_par(prm_objeto, 'COR_ID_05_GOM', 'PONTEIRO')||'"></color>'
		||'</colorRange>'
		||'<trendpoints>'
		||'<point startValue="'||fun.put_par(prm_objeto, 'META_01_GOM', 'PONTEIRO')||'" endValue="'||fun.put_par(prm_objeto, 'META_02_GOM', 'PONTEIRO')||'" displayvalue="'||fun.lang('META')||'" color="transparent" showborder="1" bordercolor="#000000" radius="180" innerradius="1"/>'
		||'</trendpoints>'

		||'<dials>'
		||'<dial value="'||fun.ifmascara(fun.valor_ponto( ws_parametros, ws_visao, prm_objeto, prm_screen ),rtrim(prm_mascara))||'"></dial>'
		||'</dials>'
		||'</chart>');
		htp.p(ws_retorno);

end DATAGAUGE;

procedure VALOR_PONTO ( prm_parametros   varchar2 default null,
						prm_micro_visao	 varchar2 default null,
						prm_objeto		 varchar2 default null, 
						prm_screen       varchar2 default null,
						prm_formula      varchar2 default null,
						prm_mascara      varchar2 default null ) as

	ret_coluna			long;

	ws_query_pivot		long;
	ws_agrupador		long;
	ws_sql				long;
	ws_parametros		long;

	ws_lquery			number;
	ws_cursor			integer;
	ws_linhas			integer;
	ws_counter			integer;

	ws_query_montada	dbms_sql.varchar2a;
	ws_ncolumns			DBMS_SQL.VARCHAR2_TABLE;
	ws_pvcolumns		DBMS_SQL.VARCHAR2_TABLE;
	ws_mfiltro			DBMS_SQL.VARCHAR2_TABLE;
	ws_cab_cross        varchar2(4000);

	ws_excesso_filtro   exception; 

begin
	ws_parametros := prm_parametros;

	if  SUBSTR(ws_parametros,LENGTH(ws_parametros),1)='|' then
		ws_parametros := ws_parametros||'1|1';
	end if;

	ws_sql := core.MONTA_QUERY_DIRECT(prm_micro_visao, '', ws_parametros, 'SUMARY', '', ws_query_pivot, ws_query_montada, ws_lquery, ws_ncolumns, ws_pvcolumns, ws_agrupador, ws_mfiltro, prm_objeto, prm_screen => prm_screen, prm_cross => 'N', prm_cab_cross => ws_cab_cross);

	if ws_sql like 'Excesso de filtros%' then 
		raise ws_excesso_filtro; 
	end if; 

	ws_cursor := dbms_sql.open_cursor;

	dbms_sql.parse( c => ws_cursor, statement => ws_query_montada, lb => 1, ub => ws_lquery, lfflg => true, language_flag => dbms_sql.native );

	ws_sql := core.bind_direct(ws_parametros, ws_cursor, 'SUMARY', prm_objeto, prm_micro_visao, prm_screen);

	dbms_sql.define_column(ws_cursor, 1, ret_coluna, 40);
	ws_linhas := dbms_sql.execute(ws_cursor);
	ws_linhas := dbms_sql.fetch_rows(ws_cursor);
	dbms_sql.column_value(ws_cursor, 1, ret_coluna);
	dbms_sql.close_cursor(ws_cursor);
	
	htp.p(NVL(fun.ifmascara(ret_coluna,trim(prm_mascara), prm_micro_visao, substr(prm_parametros, 1 ,instr(prm_parametros,'|')-1), prm_objeto, '', prm_formula, prm_screen), 'N/A'));

exception
	when ws_excesso_filtro then
		htp.p(ws_sql);
	when others	     then
	if gbl.getUsuario = fun.usuario then
		htp.p('{'||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||'}');
	end if;
	WS_COUNTER := 0;
	LOOP
		WS_COUNTER := WS_COUNTER + 1;
		IF  WS_COUNTER > WS_QUERY_MONTADA.COUNT THEN
			EXIT;
		END IF;
		HTP.P(WS_QUERY_MONTADA(WS_COUNTER));
	END LOOP;

	htp.p('0');
end VALOR_PONTO;

procedure um ( prm_coluna  varchar2 default '$[no_co]',
			prm_visao   varchar2 default '$[no_ob]',
			prm_content varchar2 default null ) as
	
	ws_unidade varchar2(20);
	ws_nulo    varchar2(1) := null; 

begin
	
	if length(trim(prm_content)) > 0 then
		
		select nm_unidade 
		into ws_unidade 
		from micro_coluna
		where cd_micro_visao = prm_visao and 
		cd_coluna = prm_coluna;
		
		if instr(ws_unidade, '>') = 1 then
			htp.p(prm_content||' '||trim(replace(ws_unidade, '>', '')));
		elsif instr(ws_unidade, '<') = 1 then
			htp.p(trim(replace(ws_unidade, '<', ''))||' '||prm_content);
		else
			htp.p(prm_content);
		end if;
		
	else
	
		htp.p(ws_nulo);
		
	end if;
	
exception
	when others then
		htp.p(ws_nulo);
end um;

/* fim da clonagem */

procedure update_prop ( prm_id     varchar2 default null,
						prm_prop   varchar2 default null,
						prm_valor  varchar2 default null,
						prm_screen varchar2 default null ) as

	ws_cd_objeto     varchar2(200); 
	ws_count         number := 0;
	ws_qt_inv        number := 0;
	ws_valor         varchar2(4000);
	ws_valor_conv    varchar2(4000);
	ws_usuario		 varchar2(200);
	ws_largura       varchar2(4000);
	ws_altura		 varchar2(4000);
	
	-- Proc auxiliar para ajustar propriedade VISIVEL - caso alguma coluna tenha sido retirada do objeto 
	procedure ajusta_prop_colunas as 
		ws_cd_prop   varchar2(100);
		ws_prop      varchar2(4000);
	begin
		ws_cd_prop := 'VISIVEL';  -- propriedade de colunas invisíveis, 
		ws_prop := ''; 
		for a in (select column_value from table(fun.vpipe( (select cs_coluna||'|'||cs_agrupador from ponto_avaliacao where cd_ponto  = ws_cd_objeto ) ) ) ) loop 
			--
			select count(*) into ws_qt_inv 
				from table(fun.vpipe( (select propriedade from object_attrib where cd_object = ws_cd_objeto and cd_prop = ws_cd_prop and owner = ws_usuario) )) t 
				where t.column_value = a.column_value; 
			if ws_qt_inv > 0 then 
				ws_prop := ws_prop ||'|'||a.column_value; 
			end if; 
		end loop; 

		if ws_prop is null then
			delete object_attrib where cd_object = ws_cd_objeto and cd_prop = ws_cd_prop and owner = ws_usuario ;
		else
			update object_attrib set propriedade = ws_prop where cd_object = ws_cd_objeto and cd_prop = ws_cd_prop and owner = ws_usuario ;
		end if;
		commit;

	exception
	  when Others then
	  	rollback;
		insert into bi_log_sistema values ('UPDATE_PROP:'|| sysdate,DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE,gbl.getUsuario,'ERRO');
		commit;
		--
		htp.p('fail '||sqlerrm);
	end;

	
begin
	
	ws_cd_objeto := upper(trim(prm_id)) ; 
	ws_valor     := prm_valor;
	ws_usuario   := gbl.getusuario;
	
	case prm_prop
	
		when 'TABELA_FISICA_OBJETO' then

			ws_count := 0;
			update object_attrib
			set propriedade = trim(ws_valor)
			where cd_object   = upper(trim(prm_id)) 
			and cd_prop     = upper(prm_prop);
			ws_count := 1;
			if sql%notfound and nvl(ws_valor,'NA') <> 'NA' then 
				insert into object_attrib (owner, navegador, screen, cd_object, cd_prop, propriedade) values 
				('DWU', 'DEFAULT', 'DEFAULT', upper(trim(prm_id)), upper(prm_prop), trim(ws_valor));
				ws_count := 1;
			end if;    

		when 'manutencao' then
			
			select count(*) into ws_count 
			from object_attrib 
			where upper(trim(cd_object)) = upper(trim(prm_id)) 
			and cd_prop = 'MANUTENCAO';
			
			if ws_count <> 0 then
		
				update object_attrib
				set propriedade = trim(ws_valor)
				where cd_object = upper(trim(prm_id)) and
				cd_prop = 'MANUTENCAO';
			
			else
			
				insert into object_attrib (owner, navegador, screen, cd_object, cd_prop, propriedade) values 
				('DWU', 'DEFAULT', 'DEFAULT', upper(trim(prm_id)), 'MANUTENCAO', trim(ws_valor));
			
			end if;
			
			ws_count := SQL%ROWCOUNT;

		when 'atualizando' then
			
			merge into object_attrib t1
			using (select 'ATUALIZANDO' as prop, upper(trim(prm_id)) as obj from dual) t2
			on (t1.cd_prop = t2.prop and t1.cd_object = t2.obj)
			when matched then update 
			set t1.propriedade = trim(ws_valor)
			when not matched then insert (owner, navegador, screen, cd_object, cd_prop, propriedade) values 
			('DWU', 'DEFAULT', 'DEFAULT', upper(trim(prm_id)), 'ATUALIZANDO', trim(ws_valor));

			
			ws_count := SQL%ROWCOUNT;

		when 'opacidade' then
			
			merge into object_attrib t1
			using (select 'OPACIDADE' as prop, upper(trim(prm_id)) as obj from dual) t2
			on (t1.cd_prop = t2.prop and t1.cd_object = t2.obj)
			when matched then update 
			set t1.propriedade = trim(ws_valor)
			when not matched then insert (owner, navegador, screen, cd_object, cd_prop, propriedade) values 
			('DWU', 'DEFAULT', 'DEFAULT', upper(trim(prm_id)), 'OPACIDADE', trim(ws_valor));

			
			ws_count := SQL%ROWCOUNT;

		when 'cor_fundo2' then
			
			merge into object_attrib t1
			using (select 'COR_FUNDO2' as prop, upper(trim(prm_id)) as obj from dual) t2
			on (t1.cd_prop  = t2.prop 
			and t1.cd_object = t2.obj)
			when matched then update 
			set t1.propriedade = trim(ws_valor)
			when not matched then insert (owner, navegador, screen, cd_object, cd_prop, propriedade) values 
			('DWU', 'DEFAULT', 'DEFAULT', upper(trim(prm_id)), 'COR_FUNDO2', trim(ws_valor));

			
			ws_count := SQL%ROWCOUNT;
		
		when 'atributos' then
			
			update objetos
			set atributos = fun.converte(trim(ws_valor))
			where upper(trim(cd_objeto)) = upper(trim(prm_id));
			
			ws_count := SQL%ROWCOUNT;
			
		when 'tipo' then
			
			update objetos
			set tp_objeto = upper(trim(ws_valor))
			where upper(trim(cd_objeto)) = upper(trim(prm_id));
			
			ws_count := SQL%ROWCOUNT;
			
		when 'grupo' then
			
			update objetos
			set cd_grupo = upper(trim(ws_valor))
			where upper(trim(cd_objeto)) = upper(trim(prm_id));
			
			ws_count := SQL%ROWCOUNT;
			
		when 'view' then
		
			ws_count := 1;
			update ponto_avaliacao
			set cd_micro_visao = upper(trim(ws_valor))
			where upper(trim(cd_ponto)) = upper(trim(prm_id));
			if sql%notfound then 
				begin 
					insert into ponto_avaliacao (cd_ponto, nm_ponto, ds_ponto, ar_diario, ar_mensal, ar_anual, cd_visao, tp_renovacao, cd_usuario, dt_ultima, dt_criacao, cd_micro_visao, parametros, st_filtros, vl_salvo, cs_parametros, cs_coluna, cs_agrupador, cs_rp, cs_colup)
										values (upper(trim(prm_id)), '', '', 'N', 'N', 'N', 'T', 'O', 'DWU', sysdate, sysdate, upper(trim(ws_valor)), '', 'A', '', '', '', '', '', '');
				exception when others then 
					ws_count := 0;
				end; 
			end if; 


			/***** 
			if length(trim(ws_valor)) > 0 then
				select count(*) into ws_count from ponto_avaliacao 
				where cd_ponto = upper(trim(prm_id));
				if ws_count <> 0 then
					update ponto_avaliacao
					set cd_micro_visao = upper(trim(ws_valor))
					where upper(trim(cd_ponto)) = upper(trim(prm_id));
				else
					insert into ponto_avaliacao 
						(cd_ponto, nm_ponto, ds_ponto, ar_diario, ar_mensal, ar_anual, cd_visao, tp_renovacao, cd_usuario, dt_ultima, dt_criacao, cd_micro_visao, parametros, st_filtros, vl_salvo, cs_parametros, cs_coluna, cs_agrupador, cs_rp, cs_colup)
					values
						(upper(trim(prm_id)), '', '', 'N', 'N', 'N', 'T', 'O', 'DWU', sysdate, sysdate, upper(trim(ws_valor)), '', 'A', '', '', '', '', '', '');
				
				end if;
				ws_count := SQL%ROWCOUNT;
			end if;
			****/ 
			
		when 'agrupador' then

			if length(trim(ws_valor)) > 0 then
		
				update ponto_avaliacao
				set cs_agrupador = upper(trim(ws_valor))
				where upper(trim(cd_ponto)) = upper(trim(prm_id));
				ws_count := SQL%ROWCOUNT;

				ajusta_prop_colunas;
				
			end if;

		when 'csrp' then
		
			if length(trim(ws_valor)) > 0 then
		
				update ponto_avaliacao
				set cs_rp = upper(trim(ws_valor))
				where upper(trim(cd_ponto)) = upper(trim(prm_id));
				
				ws_count := SQL%ROWCOUNT;
				
			end if;

		when 'colup' then

			update ponto_avaliacao
			set cs_colup = upper(trim(ws_valor))
			where upper(trim(cd_ponto)) = ws_cd_objeto;
			ws_count := SQL%ROWCOUNT;

		when 'parametros' then
		
			update ponto_avaliacao
			set parametros = upper(trim(ws_valor))
			where upper(trim(cd_ponto)) = upper(trim(prm_id));
			
			ws_count := SQL%ROWCOUNT;

		when 'coluna' then
			
			if length(trim(ws_valor)) > 0 then

				update ponto_avaliacao
				set cs_coluna = upper(trim(ws_valor))
				where upper(trim(cd_ponto)) = ws_cd_objeto ;
				ws_count := SQL%ROWCOUNT;
				
				ajusta_prop_colunas; 
				
			end if;

		when 'nome' then

			ws_valor := fun.converte(ws_valor);
			
			update objetos
			set nm_objeto = trim(ws_valor)
			where upper(trim(cd_objeto)) = upper(trim(prm_id));
			
			ws_count := SQL%ROWCOUNT;
			
		when 'COD' then
			
			select count(*) into ws_count from objetos where upper(trim(cd_objeto)) = upper(trim(ws_valor)) and cd_objeto <> upper(trim(prm_id));

			if ws_count = 0 then
				update objetos
				set cod = trim(ws_valor)
				where upper(trim(cd_objeto)) = upper(trim(prm_id));

				ws_count := SQL%ROWCOUNT;
			else
				ws_count := 0;
			end if;
			/*if ws_count <> 0 then
				update ponto_avaliacao
				set cd_ponto = trim(ws_valor)
				where upper(trim(cd_ponto)) = upper(trim(prm_id));
				
				update object_location
				set object_id = trim(ws_valor) where
				upper(trim(object_id)) = upper(trim(prm_id));
				
			end if;*/
			
		when 'subtitulo' then

			ws_valor := fun.converte(ws_valor);
			
			update objetos
			set subtitulo = trim(ws_valor)
			where upper(trim(cd_objeto)) = upper(trim(prm_id));
			
			ws_count := SQL%ROWCOUNT;
			
		when 'descritivo' then

			ws_valor := fun.converte(ws_valor);
			
			update objetos
			set ds_objeto = trim(ws_valor)
			where upper(trim(cd_objeto)) = upper(trim(prm_id));
			
			ws_count := SQL%ROWCOUNT;
			
		when 'cor_tela' then
			
			update all_screens
			set cor_fundo = trim(ws_valor)
			where screen = upper(trim(prm_id));
			
			ws_count := SQL%ROWCOUNT;
			
		when 'usuarios-tela-del' then
			
			delete from user_screens where screen = prm_id and trim(upper(usuario)) = trim(upper(ws_valor));
			
			/*for i in(select column_value from table(fun.vpipe(ws_valor))) loop
				insert into user_screens
				values(i.column_value, prm_id, 'A');
			end loop;*/

			/*insert into user_screens
			select column_value, prm_id, 'A' from table(fun.vpipe(ws_valor));*/
			
			ws_count := SQL%ROWCOUNT;
		
		when 'usuarios-tela-add' then
			
			/*delete from user_screens where screen = prm_id;
			commit;*/
			
			/*for i in(select column_value from table(
				(ws_valor))) loop
				insert into user_screens
				values(i.column_value, prm_id, 'A');
			end loop;*/

			insert into user_screens values(ws_valor, prm_id, 'A');
			
			ws_count := SQL%ROWCOUNT;
		
		when 'descritivo_tela' then

			ws_valor := fun.converte(ws_valor);
			
			update all_screens
			set ds_screen = trim(ws_valor)
			where upper(trim(screen)) = upper(trim(prm_id));
			
			ws_count := SQL%ROWCOUNT;
		when 'nome_tela' then

			ws_valor := fun.converte(ws_valor);
			
			update all_screens
			set descricao = trim(ws_valor)
			where upper(trim(screen)) = upper(trim(prm_id));
			
			update objetos
			set nm_objeto = trim(ws_valor)
			where upper(trim(cd_objeto)) = upper(trim(prm_id));
			
			ws_count := SQL%ROWCOUNT;
			
		when 'url_tela' then
			
			update all_screens
			set url_fundo = trim(ws_valor)
			where upper(trim(screen)) = upper(trim(prm_id));
			
			ws_count := SQL%ROWCOUNT;
		
		when 'alinhamento_tela' then
		
			select count(*) into ws_count 
			from object_attrib 
			where upper(trim(cd_object)) = upper(trim(prm_id)) 
			and cd_prop = 'IMG_POS';
			
			if ws_count <> 0 then
		
				update object_attrib
				set propriedade = trim(ws_valor),
					owner	   = 'DWU'
				where cd_object = upper(trim(prm_id)) 
				and cd_prop = 'IMG_POS';
			
			else
			
				insert into object_attrib (owner, navegador, screen, cd_object, cd_prop, propriedade) values 
				('DWU', 'DEFAULT', 'DEFAULT', upper(trim(prm_id)), 'IMG_POS', trim(ws_valor));
			
			end if;
			
			ws_count := SQL%ROWCOUNT;
			
		when 'tamanho_tela' then
		
			select count(*) into ws_count 
			from object_attrib 
			where upper(trim(cd_object)) = upper(trim(prm_id)) 
			and cd_prop = 'IMG_SIZE';
			
			if ws_count <> 0 then
		
				update object_attrib
				set propriedade = trim(ws_valor),
					owner	   = 'DWU'
				where upper(trim(cd_object)) = upper(trim(prm_id)) 
				and cd_prop = 'IMG_SIZE';
			
			else
			
				insert into object_attrib (owner, navegador, screen, cd_object, cd_prop, propriedade) values 
				('DWU', 'DEFAULT', 'DEFAULT', upper(trim(prm_id)), 'IMG_SIZE', trim(ws_valor));
			
			end if;
			
			ws_count := SQL%ROWCOUNT;
		when 'repetir_tela' then
		
			select count(*) into ws_count 
			from object_attrib 
			where upper(trim(cd_object)) = upper(trim(prm_id)) 
			and cd_prop = 'REPEAT';
			
			if ws_count <> 0 then
		
				update object_attrib
				set propriedade = trim(ws_valor),
					owner	   = 'DWU'
				where upper(trim(cd_object)) = upper(trim(prm_id)) 
				and cd_prop = 'REPEAT';
			
			else
			
				insert into object_attrib (owner, navegador, screen, cd_object, cd_prop, propriedade) values 
				('DWU', 'DEFAULT', 'DEFAULT', upper(trim(prm_id)), 'REPEAT', trim(ws_valor));
			
			end if;
			
			ws_count := SQL%ROWCOUNT;
		
		when 'ordem_tela' then
		
			update all_screens
			set or_grupo = trim(ws_valor)
			where upper(trim(screen)) = upper(trim(prm_id));
			
			ws_count := SQL%ROWCOUNT;
		
		when 'item_tela' then
		
			update all_screens
			set or_item = trim(ws_valor)
			where upper(trim(screen)) = upper(trim(prm_id));
			
			ws_count := SQL%ROWCOUNT;
			
		when 'dispositivo_tela' then
		
			update all_screens
			set dispositivo = trim(ws_valor)
			where upper(trim(screen)) = upper(trim(prm_id));
			
			ws_count := SQL%ROWCOUNT;
			
		when 'flex_tela' then
		
			update all_screens
			set flex_flow = trim(ws_valor)
			where upper(trim(screen)) = upper(trim(prm_id));
			
			ws_count := SQL%ROWCOUNT;
			
		when 'timer_tela' then
		
			update all_screens
			set timer = trim(ws_valor)
			where upper(trim(screen)) = upper(trim(prm_id));
			
			ws_count := SQL%ROWCOUNT;
			
		when 'img_valor' then
			
			select count(*) into ws_count 
			from object_attrib 
			where upper(trim(cd_object)) = upper(trim(prm_id)) 
			and cd_prop = 'IMG';
			
			if ws_count <> 0 then
		
				update object_attrib
				set propriedade = trim(ws_valor)
				where upper(trim(cd_object)) = upper(trim(prm_id)) 
				and cd_prop = 'IMG';
			
			else
			
				insert into object_attrib (owner, navegador, screen, cd_object, cd_prop, propriedade) values 
				('DWU', 'DEFAULT', 'DEFAULT', upper(trim(prm_id)), 'IMG', trim(ws_valor));
			
			end if;
			
			ws_count := SQL%ROWCOUNT; 
			
		when 'sec' then
		
			select count(*) into ws_count 
			from object_attrib 
			where upper(trim(cd_object)) = upper(trim(prm_id)) 
			and cd_prop = 'SEC';
			
			if ws_count <> 0 then
		
				update object_attrib
				set propriedade = trim(ws_valor)
				where upper(trim(cd_object)) = upper(trim(prm_id)) 
				and cd_prop = 'SEC';
			
			else
			
				insert into object_attrib (owner, navegador, screen, cd_object, cd_prop, propriedade) values 
				('DWU', 'DEFAULT', 'DEFAULT', upper(trim(prm_id)), 'SEC', trim(ws_valor));
			
			end if;
			
			ws_count := SQL%ROWCOUNT;

		when 'PERMISSAOED' then
		
			select count(*) into ws_count 
			from object_attrib 
			where upper(trim(cd_object)) = upper(trim(prm_id)) 
			and cd_prop = 'PERMISSAOED';
			
			if ws_count <> 0 then
		
				update object_attrib
				set propriedade = trim(ws_valor)
				where cd_object = upper(trim(prm_id)) 
				and cd_prop = 'PERMISSAOED';
			
			else
			
				insert into object_attrib (owner, navegador, screen, cd_object, cd_prop, propriedade)values ('DWU', 'DEFAULT', 'DEFAULT', upper(trim(prm_id)), 'PERMISSAOED', trim(ws_valor));
			
			end if;
			
			ws_count := SQL%ROWCOUNT;
			
			insert into bi_log_sistema values (sysdate, 'Bloqueio de Edi&ccedil;&atilde;o do Obj #'||prm_id||' foi alterado.', ws_usuario, 'EVENTO');	
			commit;
			
		when 'PERMISSAOEX' then
		
			select count(*) into ws_count 
			from object_attrib 
			where upper(trim(cd_object)) = upper(trim(prm_id)) 
			and cd_prop = 'PERMISSAOEX';
			
			if ws_count <> 0 then
		
				update object_attrib
				set propriedade = trim(ws_valor)
				where cd_object = upper(trim(prm_id)) 
				and cd_prop = 'PERMISSAOEX';
			
			else
			
				insert into object_attrib (owner, navegador, screen, cd_object, cd_prop, propriedade) values 
				('DWU', 'DEFAULT', 'DEFAULT', upper(trim(prm_id)), 'PERMISSAOEX', trim(ws_valor));
			
			end if;
			
			ws_count := SQL%ROWCOUNT;	

			insert into bi_log_sistema values (sysdate, 'Bloqueio de Exclus&atilde;o do Obj #'||prm_id||' foi alterado.', ws_usuario, 'EVENTO');	
			commit;

		when 'PERMISSAOAD' then
		
			select count(*) into ws_count 
			from object_attrib 
			where upper(trim(cd_object)) = upper(trim(prm_id)) 
			and cd_prop = 'PERMISSAOAD';
			
			if ws_count <> 0 then
		
				update object_attrib
				set propriedade = trim(ws_valor)
				where cd_object = upper(trim(prm_id)) 
				and cd_prop = 'PERMISSAOAD';
			
			else
			
				insert into object_attrib (owner, navegador, screen, cd_object, cd_prop, propriedade) values 
				('DWU', 'DEFAULT', 'DEFAULT', upper(trim(prm_id)), 'PERMISSAOAD', trim(ws_valor));
			
			end if;
			
			ws_count := SQL%ROWCOUNT;	

			insert into bi_log_sistema values (sysdate, 'Bloqueio de Adi&ccedil;&atilde;o do Obj #'||prm_id||' foi alterado.', ws_usuario, 'EVENTO');	
			commit;

		when 'PERMISSAONOFILTER' then

			select count(*) into ws_count 
			from object_attrib 
			where upper(trim(cd_object)) = upper(trim(prm_id)) 
			and cd_prop = 'PERMISSAONOFILTER';
			
			if ws_count <> 0 then
		
				update object_attrib
				set propriedade = trim(ws_valor)
				where cd_object = upper(trim(prm_id)) 
				and cd_prop = 'PERMISSAONOFILTER';

			else
			
				insert into object_attrib (owner, navegador, screen, cd_object, cd_prop, propriedade) values 
				('DWU', 'DEFAULT', 'DEFAULT', upper(trim(prm_id)), 'PERMISSAONOFILTER', trim(ws_valor));
			
			end if;

			ws_count := SQL%ROWCOUNT;

			insert into bi_log_sistema values (sysdate, 'Bloqueio de Filtro do Obj #'||prm_id||' foi alterado.', ws_usuario, 'EVENTO');	
			commit;

		when 'PERMISSAODESTAQUE' then

			select count(*) into ws_count 
			from object_attrib 
			where upper(trim(cd_object)) = upper(trim(prm_id)) 
			and cd_prop = 'PERMISSAODESTAQUE';
			
			if ws_count <> 0 then
				update object_attrib
				set propriedade = trim(ws_valor)
				where cd_object = upper(trim(prm_id)) 
				and cd_prop = 'PERMISSAODESTAQUE';
			else
				insert into object_attrib (owner, navegador, screen, cd_object, cd_prop, propriedade) values 
				('DWU', 'DEFAULT', 'DEFAULT', upper(trim(prm_id)), 'PERMISSAODESTAQUE', trim(ws_valor));
			end if;

			ws_count := SQL%ROWCOUNT;

			insert into bi_log_sistema values (sysdate, 'Bloqueio de Destaque do Obj #'||prm_id||' foi alterado.', ws_usuario, 'EVENTO');	
			commit;

		when 'COLUNAS_FILTRO' then

			if '|'||ws_valor||'|' like '%|TODOS|%' then 
				ws_valor := 'TODOS';
			end if; 

			update object_attrib
			set propriedade = trim(ws_valor)
			where cd_object = upper(trim(prm_id)) 
			and cd_prop   = 'COLUNAS_FILTRO';

			if sql%notfound then 
				insert into object_attrib (owner, navegador, screen, cd_object, cd_prop, propriedade) values 
				('DWU', 'DEFAULT', 'DEFAULT', upper(trim(prm_id)), 'COLUNAS_FILTRO', trim(ws_valor));
			end if;

			ws_count := 1;

			insert into bi_log_sistema values (sysdate, 'Bloqueio de Coluna Filtro do Obj #'||prm_id||' foi alterado.', ws_usuario, 'EVENTO');	
			commit;

		when 'SUBQUERY' then

			select count(*) into ws_count 
			from object_attrib 
			where upper(trim(cd_object)) = upper(trim(prm_id)) 
			and cd_prop = 'SUBQUERY';
			
			if ws_count <> 0 then
		
				update object_attrib
				set propriedade = trim(ws_valor)
				where cd_object = upper(trim(prm_id)) 
				and cd_prop = 'SUBQUERY';

			else
			
				insert into object_attrib (owner, navegador, screen, cd_object, cd_prop, propriedade) values 
				('DWU', 'DEFAULT', 'DEFAULT', upper(trim(prm_id)), 'SUBQUERY', trim(ws_valor));
			
			end if;

			ws_count := SQL%ROWCOUNT;		

		when 'libera_objeto' then
			
			update objetos
			set id_liberado = upper(trim(ws_valor))
			where upper(trim(cd_objeto)) = upper(trim(prm_id));
			
			ws_count := SQL%ROWCOUNT;

		when 'LIMIT_DOC_BRO' then

			select count(*) into ws_count 
			from object_attrib 
			where upper(trim(cd_object)) = upper(trim(prm_id)) 
			and cd_prop = 'LIMIT_DOC_BRO';
			
			if ws_count <> 0 then
		
				update object_attrib
				set propriedade = trim(ws_valor)
				where cd_object = upper(trim(prm_id)) 
				and cd_prop = 'LIMIT_DOC_BRO';

			else
			
				insert into object_attrib (owner, navegador, screen, cd_object, cd_prop, propriedade) values 
				('DWU', 'DEFAULT', 'DEFAULT', upper(trim(prm_id)), 'LIMIT_DOC_BRO', trim(ws_valor));
			
			end if;

			ws_count := SQL%ROWCOUNT;

		when 'ALTURA_MIN_BRO' then

			select count(*) into ws_count 
			from object_attrib 
			where upper(trim(cd_object)) = upper(trim(prm_id)) 
			and cd_prop = 'ALTURA_MIN_BRO';
			
			if ws_count <> 0 then
		
				update object_attrib
				set propriedade = trim(ws_valor)
				where cd_object = upper(trim(prm_id)) 
				and cd_prop = 'ALTURA_MIN_BRO';
				

			else
			
				insert into object_attrib (owner, navegador, screen, cd_object, cd_prop, propriedade) values 
				('DWU', 'DEFAULT', 'DEFAULT', upper(trim(prm_id)), 'ALTURA_MIN_BRO', trim(ws_valor));
			
			end if;

			ws_count := SQL%ROWCOUNT;		
		
		when 'BLOQ_OBJ' then

			select count(*) into ws_count 
			from object_attrib 
			where upper(trim(cd_object)) = upper(trim(prm_id)) 
			and cd_prop = 'BLOQ_OBJ';
			
			if ws_count <> 0 then
		
				update object_attrib
				set propriedade = trim(ws_valor)
				where cd_object = upper(trim(prm_id)) 
				and cd_prop = 'BLOQ_OBJ';

			else
			
				insert into object_attrib (owner, navegador, screen, cd_object, cd_prop, propriedade) values 
				('DWU', 'DEFAULT', 'DEFAULT', upper(trim(prm_id)), 'BLOQ_OBJ', trim(ws_valor));
			
			end if;

			ws_count := SQL%ROWCOUNT;

		when 'ALTURA' then

			update_attrib(trim(ws_valor), 'ALTURA', upper(trim(prm_id)), ws_usuario, 'DEFAULT');
			-- update_attrib(trim(ws_valor), 'ALTURA', upper(trim(prm_id)), 'DWU', 'DEFAULT');

			ws_count := 1;

		when 'LARGURA' then

			update_attrib(trim(ws_valor), 'LARGURA', upper(trim(prm_id)), ws_usuario, 'DEFAULT');
			-- update_attrib(trim(ws_valor), 'LARGURA', upper(trim(prm_id)), 'DWU', 'DEFAULT');

			ws_count := 1;

		when 'TAMANHO_DEFAULT_BRO' then

			select
				max(propriedade)
			into
				ws_largura
			from
				object_attrib
			where 
				cd_object = upper(trim(prm_id))
				and cd_prop IN ('LARGURA')
				and owner = 'DWU';

			select
				max(propriedade)
			into
				ws_altura
			from
				object_attrib
			where 
				cd_object = upper(trim(prm_id))
				and cd_prop IN ('ALTURA')
				and owner = 'DWU';

			htp.p('['||ws_largura|| ', ' || ws_altura || ']' );
			
				ws_count := 1;

		end case;

	commit;

	if ws_count = 0 then
		htp.p('fail');
	else
		htp.p(fun.subpar(trim(ws_valor), prm_screen));
	end if;

exception when others then
	insert into bi_log_sistema values ('UPDATE_PROP:'|| sysdate,DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE,gbl.getUsuario,'ERRO');
	commit;
	--
	htp.p('fail '||sqlerrm);
end update_prop;


/************ excluido 11/06/2023 - Ivanor
procedure check_acl ( prm_host      varchar2 default null,
					prm_port_lower varchar2 default null,
					prm_port_upper varchar2 default null  ) as 

	ws_count number;
	ws_fail  exception;

begin

	htp.p('');

exception 
	when ws_fail then
		htp.p('<br /><div style="text-align: center;">CHECK_ACL: <span style="font-weight: bold; color: #00CC00;">FAIL SEM CONEX&Atilde;O</span></div>');
	when others then
		htp.p('<br /><div style="text-align: center;">CHECK_ACL: <span style="font-weight: bold; color: #00CC00;">FAIL</span></div>');
end check_acl;
*****************/ 

procedure replace_binds ( prm_query varchar2 default null, 
						prm_binds varchar2 default null )  as
	
	ws_count number;
	ws_query varchar2(24000);
	ws_valor varchar2(800);
	ws_loop  number;
	ws_raise_tamanho exception; 
	
begin

	begin 
		ws_query := prm_query;
	exception when others then 
		raise ws_raise_tamanho;
	end ; 	

	select regexp_count(ws_query, ':b[0-90-9]+') into ws_count from dual;

	ws_loop := 0;
	for i in 1..ws_count loop
		ws_loop := ws_loop+1;
		begin
			select column_value into ws_valor from( select column_value, rownum as linha from table(fun.vpipe((prm_binds)))) where linha = ws_loop;
		end;
		
		select regexp_replace(ws_query, ':b[0-90-9]+', chr(39)||ws_valor||chr(39), ws_loop, 1) into ws_query from dual;
	
	end loop;
	
	
	htp.p(ws_query);
exception 
	when ws_raise_tamanho then 
		insert into bi_log_sistema values (sysdate,DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - REPLACE_BINDS 1',gbl.getUsuario,'ERRO');
		commit;
		htp.p('Query excedeu o limite de 24 Kb');	
	when others then
		insert into bi_log_sistema values (sysdate,DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - REPLACE_BINDS 2',gbl.getUsuario,'ERRO');
		commit;
		htp.p(ws_query);
end replace_binds;

procedure data_attrib ( prm_objeto varchar2 default null,
						prm_tipo   varchar2 default null,
						prm_screen varchar2 default null ) as

	ws_um 				varchar2(200);
	ws_micro_visao		varchar2(200);
	ws_cs_coluna		varchar2(200);

	cursor crs_atributos is
	select t1.cd_prop as cd_prop, coalesce(t3.propriedade, t2.vl_default, t1.vl_default) as valor
	from bi_object_padrao t1
	left join
	object_padrao t2 on t2.cd_prop = t1.cd_prop and t2.tp_objeto = t1.tp_objeto 
	left join
	object_attrib t3 on t3.cd_prop = t1.cd_prop and t3.cd_object = fun.get_cd_obj(prm_objeto) 
	where t1.tp_objeto = prm_tipo
	and nvl(t1.sufixo, 'N/A') <> 'N/A';

-- c_colunas utilizado para aplicar UM (aba MAPEAR COLUNA) caso não haja cd_prop UM aplicado. 20/10/22
	cursor c_colunas is 
		select nm_unidade 
		from micro_coluna mc, 
				(select rownum ordem, column_value cd_coluna from table(fun.vpipe((ws_cs_coluna)))) t1  
		where mc.cd_micro_visao = ws_micro_visao 
		and  mc.cd_coluna = t1.cd_coluna 
		and nm_unidade is not null
		order by t1.ordem ; 
	
	ws_attrib crs_atributos%rowtype;

begin

	htp.p('<span id="atributos_'||prm_objeto||'"');
	
		open crs_atributos;
			loop
				
				fetch crs_atributos into ws_attrib;
				exit when crs_atributos%notfound;
					-- fun.subpar tenta tratar alguns caracteres especiais e acaba dando erro (#,@,$,[,]) o gráfico acaba não sendo reenderizado por esse motivo.
					if ws_attrib.cd_prop = 'GRAF_AXIS_UMVL' then
						htp.p(' data-'||lower(ws_attrib.cd_prop)||'="'||ws_attrib.valor||'"');
					else
						htp.p(' data-'||lower(ws_attrib.cd_prop)||'="'||fun.subpar(ws_attrib.valor, prm_screen)||'"');
					end if;

			end loop;
		close crs_atributos;
	
	htp.p('></span>');
exception
  when others then
	insert into bi_log_sistema values (sysdate, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE , gbl.getusuario, 'ERRO');
	commit;
end data_attrib;

procedure broken_job ( prm_num varchar2 default null ) as

	ws_count number;

begin

	select count(*) into ws_count from all_jobs where broken = 'Y' and job = prm_num;

	if ws_count <> 0 then
		dbms_job.remove(prm_num);
		verifica_job;
	end if;
	
	select count(*) into ws_count from all_jobs where broken = 'Y' and job = prm_num;
	
	if ws_count = 0 then
		htp.p('JOB FIXADO');
	else
		htp.p('ERRO AO RESOLVER O JOB');
	end if;

end broken_job;

procedure svg ( prm_cod number default 99 ) as

begin

	case prm_cod 
		when 1 then
			/* compras */
			htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"viewBox="0 0 201.387 201.387" style="enable-background:new 0 0 201.387 201.387;" xml:space="preserve"> <g> <g> <path d="M129.413,24.885C127.389,10.699,115.041,0,100.692,0C91.464,0,82.7,4.453,77.251,11.916 c-1.113,1.522-0.78,3.657,0.742,4.77c1.517,1.109,3.657,0.78,4.768-0.744c4.171-5.707,10.873-9.115,17.93-9.115 c10.974,0,20.415,8.178,21.963,19.021c0.244,1.703,1.705,2.932,3.376,2.932c0.159,0,0.323-0.012,0.486-0.034 C128.382,28.479,129.679,26.75,129.413,24.885z"/> </g> </g> <g> <g> <path d="M178.712,63.096l-10.24-17.067c-0.616-1.029-1.727-1.657-2.927-1.657h-9.813c-1.884,0-3.413,1.529-3.413,3.413 s1.529,3.413,3.413,3.413h7.881l6.144,10.24H31.626l6.144-10.24h3.615c1.884,0,3.413-1.529,3.413-3.413s-1.529-3.413-3.413-3.413 h-5.547c-1.2,0-2.311,0.628-2.927,1.657l-10.24,17.067c-0.633,1.056-0.648,2.369-0.043,3.439s1.739,1.732,2.97,1.732h150.187 c1.231,0,2.364-0.662,2.97-1.732S179.345,64.15,178.712,63.096z"/> </g> </g> <g> <g> <path d="M161.698,31.623c-0.478-0.771-1.241-1.318-2.123-1.524l-46.531-10.883c-0.881-0.207-1.809-0.053-2.579,0.423 c-0.768,0.478-1.316,1.241-1.522,2.123l-3.509,15c-0.43,1.835,0.71,3.671,2.546,4.099c1.835,0.43,3.673-0.71,4.101-2.546 l2.732-11.675l39.883,9.329l-6.267,26.795c-0.43,1.835,0.71,3.671,2.546,4.099c0.263,0.061,0.524,0.09,0.782,0.09 c1.55,0,2.953-1.062,3.318-2.635l7.045-30.118C162.328,33.319,162.176,32.391,161.698,31.623z"/> </g> </g> <g> <g> <path d="M102.497,39.692l-3.11-26.305c-0.106-0.899-0.565-1.72-1.277-2.28c-0.712-0.56-1.611-0.816-2.514-0.71l-57.09,6.748 c-1.871,0.222-3.209,1.918-2.988,3.791l5.185,43.873c0.206,1.737,1.679,3.014,3.386,3.014c0.133,0,0.27-0.009,0.406-0.024 c1.87-0.222,3.208-1.918,2.988-3.791l-4.785-40.486l50.311-5.946l2.708,22.915c0.222,1.872,1.91,3.202,3.791,2.99 C101.379,43.261,102.717,41.564,102.497,39.692z"/> </g> </g> <g> <g> <path d="M129.492,63.556l-6.775-28.174c-0.212-0.879-0.765-1.64-1.536-2.113c-0.771-0.469-1.696-0.616-2.581-0.406L63.613,46.087 c-1.833,0.44-2.961,2.284-2.521,4.117l3.386,14.082c0.44,1.835,2.284,2.964,4.116,2.521c1.833-0.44,2.961-2.284,2.521-4.117 l-2.589-10.764l48.35-11.626l5.977,24.854c0.375,1.565,1.775,2.615,3.316,2.615c0.265,0,0.533-0.031,0.802-0.096 C128.804,67.232,129.932,65.389,129.492,63.556z"/> </g> </g> <g> <g> <path d="M179.197,64.679c-0.094-1.814-1.592-3.238-3.41-3.238H25.6c-1.818,0-3.316,1.423-3.41,3.238l-6.827,133.12 c-0.048,0.934,0.29,1.848,0.934,2.526c0.645,0.677,1.539,1.062,2.475,1.062h163.84c0.935,0,1.83-0.384,2.478-1.062 c0.643-0.678,0.981-1.591,0.934-2.526L179.197,64.679z M22.364,194.56l6.477-126.293h143.701l6.477,126.293H22.364z"/> </g> </g> <g> <g> <path d="M126.292,75.093c-5.647,0-10.24,4.593-10.24,10.24c0,5.647,4.593,10.24,10.24,10.24c5.647,0,10.24-4.593,10.24-10.24 C136.532,79.686,131.939,75.093,126.292,75.093z M126.292,88.747c-1.883,0-3.413-1.531-3.413-3.413s1.531-3.413,3.413-3.413 c1.882,0,3.413,1.531,3.413,3.413S128.174,88.747,126.292,88.747z"/> </g> </g> <g> <g> <path d="M75.092,75.093c-5.647,0-10.24,4.593-10.24,10.24c0,5.647,4.593,10.24,10.24,10.24c5.647,0,10.24-4.593,10.24-10.24 C85.332,79.686,80.739,75.093,75.092,75.093z M75.092,88.747c-1.882,0-3.413-1.531-3.413-3.413s1.531-3.413,3.413-3.413 s3.413,1.531,3.413,3.413S76.974,88.747,75.092,88.747z"/> </g> </g> <g> <g> <path d="M126.292,85.333h-0.263c-1.884,0-3.413,1.529-3.413,3.413c0,0.466,0.092,0.911,0.263,1.316v17.457 c0,12.233-9.953,22.187-22.187,22.187s-22.187-9.953-22.187-22.187V88.747c0-1.884-1.529-3.413-3.413-3.413 s-3.413,1.529-3.413,3.413v18.773c0,15.998,13.015,29.013,29.013,29.013s29.013-13.015,29.013-29.013V88.747 C129.705,86.863,128.176,85.333,126.292,85.333z"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
		when 2 then
			/* compras */
			htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve"> <g> <g> <path d="M85.072,454.931c-1.859-1.861-4.439-2.93-7.069-2.93s-5.21,1.069-7.07,2.93c-1.86,1.861-2.93,4.44-2.93,7.07 s1.069,5.21,2.93,7.069c1.86,1.86,4.44,2.931,7.07,2.931s5.21-1.07,7.069-2.931c1.86-1.859,2.931-4.439,2.931-7.069 S86.933,456.791,85.072,454.931z"/> </g> </g> <g> <g> <path d="M469.524,182.938c-1.86-1.861-4.43-2.93-7.07-2.93c-2.63,0-5.21,1.069-7.07,2.93c-1.859,1.86-2.93,4.44-2.93,7.07 s1.07,5.21,2.93,7.069c1.86,1.86,4.44,2.931,7.07,2.931c2.64,0,5.21-1.07,7.07-2.931c1.869-1.859,2.939-4.439,2.939-7.069 S471.393,184.798,469.524,182.938z"/> </g> </g> <g> <g> <path d="M509.065,2.929C507.189,1.054,504.645,0,501.992,0L255.998,0.013c-5.522,0-9.999,4.478-9.999,10V38.61l-94.789,25.399 c-5.335,1.43-8.501,6.913-7.071,12.247l49.127,183.342l-42.499,42.499c-5.409-7.898-14.491-13.092-24.764-13.092H30.006 c-16.542,0-29.999,13.458-29.999,29.999v162.996C0.007,498.542,13.464,512,30.006,512h95.998c14.053,0,25.875-9.716,29.115-22.78 l11.89,10.369c9.179,8.004,20.939,12.412,33.118,12.412h301.867c5.522,0,10-4.478,10-10V10 C511.992,7.348,510.94,4.804,509.065,2.929z M136.002,482.001c0,5.513-4.486,10-10,10H30.005c-5.514,0-10-4.486-10-10V319.005 c0-5.514,4.486-10,10-10h37.999V424.2c0,5.522,4.478,10,10,10s10-4.478,10-10V309.005h37.999c5.514,0,10,4.486,10,10V482.001z M166.045,80.739l79.954-21.424V96.37l-6.702,1.796c-2.563,0.687-4.746,2.362-6.072,4.659s-1.686,5.026-0.999,7.588 c3.843,14.341-4.698,29.134-19.039,32.977c-2.565,0.688-4.752,2.366-6.077,4.668c-1.325,2.301-1.682,5.035-0.989,7.599 l38.979,144.338h-20.07l-10.343-40.464c-0.329-1.288-0.905-2.475-1.676-3.507L166.045,80.739z M245.999,142.229v84.381 l-18.239-67.535C235.379,155.141,241.614,149.255,245.999,142.229z M389.663,492H200.125V492c-7.345,0-14.438-2.658-19.974-7.485 l-24.149-21.061V325.147l43.658-43.658l7.918,30.98c1.132,4.427,5.119,7.523,9.688,7.523l196.604,0.012c7.72,0,14,6.28,14,14 c0,7.72-6.28,14-14,14H313.13c-5.522,0-10,4.478-10,10c0,5.522,4.478,10,10,10h132.04c7.72,0,14,6.28,14,14c0,7.72-6.28,14-14,14 H313.13c-5.522,0-10,4.478-10,10c0,5.522,4.478,10,10,10h110.643c7.72,0,14,6.28,14,14c0,7.72-6.28,14-14,14H313.13 c-5.522,0-10,4.478-10,10c0,5.522,4.478,10,10,10h76.533c7.72,0,14,6.28,14,14C403.662,485.72,397.382,492,389.663,492z M491.994,492h-0.001h-71.359c1.939-4.273,3.028-9.01,3.028-14s-1.089-9.727-3.028-14h3.139c18.747,0,33.999-15.252,33.999-33.999 c0-5.468-1.305-10.635-3.609-15.217c14.396-3.954,25.005-17.149,25.005-32.782c0-7.584-2.498-14.595-6.711-20.255V235.007 c0-5.522-4.478-10-10-10c-5.522,0-10,4.478-10,10v113.792c-2.35-0.515-4.787-0.795-7.289-0.795h-0.328 c1.939-4.273,3.028-9.01,3.028-14c0-18.748-15.252-33.999-33.999-33.999h-16.075c17.069-7.32,29.057-24.286,29.057-44.005 c0-26.389-21.468-47.858-47.857-47.858c-26.388,0-47.857,21.469-47.857,47.858c0,19.719,11.989,36.685,29.057,44.005h-54.663 V109.863c17.864-3.893,31.96-17.988,35.852-35.853h75.221c3.892,17.865,17.988,31.96,35.852,35.853v31.09c0,5.522,4.478,10,10,10 s10-4.478,10-10v-40.018c0-5.522-4.478-10-10-10c-14.847,0-26.924-12.079-26.924-26.925c0-5.522-4.478-10-10-10h-93.076 c-5.522,0-10,4.478-10,10c0,14.847-12.078,26.925-26.924,26.925c-5.522,0-10,4.478-10,10v199.069H266V20.011L491.994,20V492z M378.996,283.858c-15.361,0-27.857-12.497-27.857-27.857s12.497-27.858,27.857-27.858S406.853,240.64,406.853,256 S394.357,283.858,378.996,283.858z"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
		when 3 then
			/* financeiro */
			htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 212.755 212.755" xmlns:xlink="http://www.w3.org/1999/xlink" enable-background="new 0 0 212.755 212.755"> <g> <path d="M106.377,0C47.721,0,0,47.721,0,106.377s47.721,106.377,106.377,106.377s106.377-47.721,106.377-106.377   S165.034,0,106.377,0z M106.377,198.755C55.44,198.755,14,157.314,14,106.377S55.44,14,106.377,14s92.377,41.44,92.377,92.377   S157.314,198.755,106.377,198.755z"/> <path d="m113.377,100.096v-39.744c3.961,1.471 7.417,4.17 9.82,7.82 2.127,3.229 6.468,4.123 9.696,1.997 3.229-2.126 4.123-6.467 1.996-9.696-5.029-7.636-12.778-12.82-21.512-14.647v-11.12c0-3.866-3.134-7-7-7s-7,3.134-7,7v11.099c-15.493,3.23-27.168,16.989-27.168,33.426 0,16.437 11.676,30.198 27.168,33.428v39.744c-3.961-1.471-7.417-4.17-9.82-7.82-2.127-3.229-6.468-4.124-9.696-1.997-3.229,2.126-4.123,6.467-1.996,9.696 5.029,7.636 12.778,12.82 21.512,14.647v11.119c0,3.866 3.134,7 7,7s7-3.134 7-7v-11.098c15.493-3.23 27.168-16.989 27.168-33.426-2.84217e-14-16.437-11.675-30.198-27.168-33.428zm-27.168-20.865c0-8.653 5.494-16.027 13.168-18.874v37.748c-7.674-2.847-13.168-10.221-13.168-18.874zm27.168,73.166v-37.748c7.674,2.847 13.168,10.221 13.168,18.874s-5.493,16.027-13.168,18.874z"/> </g> </svg>');
		when 4 then
			/* financeiro */
			htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 212.755 212.755" xmlns:xlink="http://www.w3.org/1999/xlink" enable-background="new 0 0 212.755 212.755"> <g> <path d="M106.377,0C47.721,0,0,47.721,0,106.377s47.721,106.377,106.377,106.377s106.377-47.721,106.377-106.377   S165.034,0,106.377,0z M106.377,198.755C55.44,198.755,14,157.314,14,106.377S55.44,14,106.377,14s92.377,41.44,92.377,92.377   S157.314,198.755,106.377,198.755z"/> <path d="m113.377,100.096v-39.744c3.961,1.471 7.417,4.17 9.82,7.82 2.127,3.229 6.468,4.123 9.696,1.997 3.229-2.126 4.123-6.467 1.996-9.696-5.029-7.636-12.778-12.82-21.512-14.647v-11.12c0-3.866-3.134-7-7-7s-7,3.134-7,7v11.099c-15.493,3.23-27.168,16.989-27.168,33.426 0,16.437 11.676,30.198 27.168,33.428v39.744c-3.961-1.471-7.417-4.17-9.82-7.82-2.127-3.229-6.468-4.124-9.696-1.997-3.229,2.126-4.123,6.467-1.996,9.696 5.029,7.636 12.778,12.82 21.512,14.647v11.119c0,3.866 3.134,7 7,7s7-3.134 7-7v-11.098c15.493-3.23 27.168-16.989 27.168-33.426-2.84217e-14-16.437-11.675-30.198-27.168-33.428zm-27.168-20.865c0-8.653 5.494-16.027 13.168-18.874v37.748c-7.674-2.847-13.168-10.221-13.168-18.874zm27.168,73.166v-37.748c7.674,2.847 13.168,10.221 13.168,18.874s-5.493,16.027-13.168,18.874z"/> </g> </svg>');
		when 5 then
			/* rh */
			htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve"> <g> <g> <path d="M61.069,169.93C59.21,168.069,56.63,167,54,167s-5.209,1.07-7.07,2.93C45.069,171.79,44,174.37,44,177 s1.069,5.21,2.93,7.069C48.79,185.93,51.37,187,54,187s5.21-1.07,7.069-2.931C62.93,182.21,64,179.63,64,177 S62.93,171.79,61.069,169.93z"/> </g> </g> <g> <g> <path d="M438,0H235.667c-5.522,0-10,4.478-10,10s4.478,10,10,10H438c5.514,0,10,4.486,10,10v452c0,5.514-4.486,10-10,10H74 c-5.514,0-10-4.486-10-10V214.333c0-5.522-4.478-10-10-10s-10,4.478-10,10V482c0,16.542,13.458,30,30,30h364 c16.542,0,30-13.458,30-30V30C468,13.458,454.542,0,438,0z"/> </g> </g> <g> <g> <path d="M256,40c-6.804,0-13.642,0.52-20.324,1.544c-5.459,0.838-9.206,5.941-8.369,11.4c0.837,5.459,5.943,9.201,11.4,8.369 C244.39,60.441,250.208,60,256,60c62.309,0,113.001,50.692,113.001,113.001c0,27.67-10.002,53.043-26.574,72.71 c-7.333-12.61-17.349-23.487-29.506-31.924c-7.095-4.924-14.718-8.854-22.698-11.763c9.108-8.903,14.777-21.31,14.777-35.022 v-9.75c0-27.02-21.981-49.001-49-49.001c-27.019,0-49,21.981-49,49.001v9.75c0,13.712,5.668,26.119,14.777,35.022 c-7.979,2.909-15.602,6.839-22.698,11.763c-12.215,8.478-22.271,19.416-29.613,32.102c-12.627-15.005-21.453-33.461-24.906-54.05 c-0.913-5.445-6.074-9.119-11.516-8.208c-5.447,0.913-9.122,6.069-8.209,11.516c5.142,30.66,21.059,58.724,44.82,79.021 c24.031,20.529,54.696,31.835,86.344,31.835c73.337,0,133.001-59.664,133.001-133.001S329.337,40,256,40z M227,157.251 c0-15.991,13.01-29.001,29-29.001s29,13.01,29,29.001v9.75c0,15.99-13.01,29-29,29s-29-13.01-29-29V157.251z M256,286.002 c-27.074,0-52.104-9.454-71.694-25.482c13.428-27.252,40.879-44.519,71.694-44.519c30.751,0,58.15,17.196,71.608,44.349 C308.101,276.371,283.154,286.002,256,286.002z"/> </g> </g> <g> <g> <path d="M348.357,398.002h-142c-5.522,0-10,4.478-10,10c0,5.522,4.478,10,10,10h142c5.523,0,10-4.478,10-10 C358.357,402.48,353.879,398.002,348.357,398.002z"/> </g> </g> <g> <g> <path d="M170.71,344.93c-1.86-1.861-4.44-2.93-7.07-2.93s-5.21,1.07-7.07,2.93s-2.93,4.44-2.93,7.07 c0,2.639,1.071,5.21,2.93,7.069c1.86,1.861,4.44,2.931,7.07,2.931s5.21-1.07,7.07-2.931c1.87-1.859,2.93-4.439,2.93-7.069 S172.58,346.79,170.71,344.93z"/> </g> </g> <g> <g> <path d="M170.71,400.93c-1.86-1.861-4.43-2.93-7.07-2.93c-2.63,0-5.21,1.07-7.07,2.93s-2.93,4.44-2.93,7.07 c0,2.639,1.071,5.21,2.93,7.069c1.86,1.861,4.44,2.931,7.07,2.931s5.21-1.07,7.07-2.931c1.87-1.859,2.93-4.429,2.93-7.069 C173.64,405.37,172.58,402.79,170.71,400.93z"/> </g> </g> <g> <g> <path d="M348.357,342.002h-142c-5.522,0-10,4.478-10,10c0,5.522,4.478,10,10,10h142c5.523,0,10-4.478,10-10 C358.357,346.48,353.879,342.002,348.357,342.002z"/> </g> </g> <g> <g> <path d="M161.626,57.629c-3.907-3.904-10.237-3.904-14.143,0l-32.566,32.566l-11.129-11.129c-3.907-3.904-10.237-3.904-14.143,0 c-3.905,3.906-3.905,10.238,0,14.143l18.2,18.2c1.953,1.952,4.511,2.929,7.071,2.929s5.118-0.977,7.072-2.928l39.638-39.638 C165.531,67.866,165.531,61.534,161.626,57.629z"/> </g> </g> <g> <g> <path d="M126,0C80.785,0,44,36.785,44,82c0,45.215,36.785,82,82,82c45.215,0,82-36.785,82-82C208,36.785,171.215,0,126,0z M126,144c-34.187,0-62-27.813-62-62s27.813-62,62-62s62,27.813,62,62S160.187,144,126,144z"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
		when 6 then
			/* rh */
			htp.p('<svg height="480pt" viewBox="0 -7 480 479" width="480pt" xmlns="http://www.w3.org/2000/svg"><path d="m318.335938 229.730469c43.292968-33.5 60.488281-90.824219 42.785156-142.621094-17.699219-51.800781-66.382813-86.609375-121.121094-86.609375s-103.421875 34.808594-121.121094 86.609375c-17.703125 51.796875-.507812 109.121094 42.785156 142.621094-96.6875 33.472656-161.570312 124.503906-161.664062 226.824219v8h480v-8c-.09375-102.320313-64.976562-193.351563-161.664062-226.824219zm-190.335938-101.175781c-.019531-54.351563 38.984375-100.871094 92.507812-110.332032 53.519532-9.457031 106.109376 20.875 124.71875 71.9375 18.613282 51.066406-2.121093 108.121094-49.179687 135.320313-2.132813 1.234375-4.285156 2.386719-6.453125 3.464843-24.476562 11.789063-52.34375 14.492188-78.625 7.632813-9.476562-2.453125-18.570312-6.191406-27.03125-11.105469-34.566406-20.046875-55.871094-56.960937-55.9375-96.917968zm248 320v-88h-16v88h-240v-88h-16v88h-87.855469c3.519531-97.140626 69.21875-180.957032 162.710938-207.570313.738281.402344 1.496093.738281 2.234375 1.128906 1.238281.640625 2.476562 1.28125 3.742187 1.878907.945313.457031 1.894531.882812 2.855469 1.304687 1.789062.804687 3.589844 1.570313 5.410156 2.296875l.476563.183594c29.863281 11.714844 63.050781 11.714844 92.914062 0l.375-.136719c1.855469-.734375 3.6875-1.519531 5.503907-2.335937.929687-.414063 1.847656-.800782 2.769531-1.261719 1.269531-.617188 2.535156-1.265625 3.792969-1.921875.734374-.375 1.484374-.71875 2.214843-1.109375 93.480469 26.609375 159.183594 110.410156 162.710938 207.542969zm0 0"/></svg>');
	
	else
		htp.p('');
	end case;

end;

procedure popupMenu ( prm_tipo varchar2 default null,
					  prm_cond varchar2 default null ) as

	ws_usuario varchar2(80);
	ws_admin   varchar2(10);

	-- GRUPOS que possuem telas ou subgrupos com telas 
	cursor c_grupos is 
		select distinct gru.ordem, gru.cd_grupo, gru.nm_grupo 
		from grupos_funcao gru 
	   where gru.cd_grupo_superior is null
	     and length(fcl.popupmenu_itens (gru.cd_grupo, ws_usuario, ws_admin,'TODOS')) > 0 
		order by gru.ordem, gru.nm_grupo;


	cursor c_itens_menu (prm_grupo varchar2)  is 
		select fav.ordem, obj.cd_objeto, obj.nm_objeto, scr.dispositivo, 'TELA' tipo 
		from all_screens scr, objetos obj, favoritos fav 
			where scr.screen  = obj.cd_objeto 
			and obj.cd_objeto = fav.cd_objeto 
			and obj.tp_objeto = 'SCREEN'
			and fav.usuario   = ws_usuario
			and (ws_admin = 'A' or fun.check_screen_access(obj.cd_objeto, ws_usuario, ws_admin) > 0 ) 
			and prm_grupo = '###menu_grupo_favoritos###'
		union all 
			select to_number(scr.or_item), obj.cd_objeto, obj.nm_objeto, scr.dispositivo, 'TELA' tipo 
			from all_screens scr, objetos obj
			where scr.screen    = obj.cd_objeto 
			and obj.cd_objeto in (select column_value from table(fun.vpipe(fcl.popupmenu_itens (prm_grupo, ws_usuario, ws_admin,'TELAS')) ))
			and prm_grupo <> '###menu_grupo_favoritos###'
		union all 
			select ordem, cd_grupo, nm_grupo, cd_grupo_superior, 'SUBGRUPO' tipo
			from grupos_funcao gf
			where cd_grupo_superior = prm_grupo 
			and cd_grupo in (select column_value from table(fun.vpipe(fcl.popupmenu_itens (prm_grupo, ws_usuario, ws_admin,'GRUPOS')) ))
			and prm_grupo <> '###menu_grupo_favoritos###'
		order by 1,3; 

	ws_count   		 number := 0;
	ws_padrao  		 varchar2(80);
	ws_row_fav  	 c_itens_menu%rowtype;
	ws_count_menu	 number;
	ws_separator	 varchar2(5);
	ws_count_tela	 number;

begin

	ws_usuario 		:= gbl.getUsuario;
	ws_admin   		:= nvl(gbl.getNivel,'N');
	ws_padrao  		:= gbl.getLang;
	ws_count_menu 	:= 0;
	ws_count_tela	:= 0;
	ws_separator	:= ' - ';

	case  
		when prm_tipo = 'screengroup' then

			htp.p('<ul id="screengroup" data-usuario="'||ws_usuario||'" data-admin="'||ws_admin||'">');
			
				-- Cria menu de favoritos se o usuário possuir telas favoritadas 
				ws_row_fav := null;
				open  c_itens_menu ('###menu_grupo_favoritos###');
				fetch c_itens_menu into ws_row_fav;
				close c_itens_menu; 

				if ws_row_fav.cd_objeto is not null then 
					ws_count := ws_count + 1;
					htp.p('<li onclick="popupmenu(''screenlist'', ''###menu_grupo_favoritos###'', 1);">');
						htp.p('<svg style="height: 18px; width: 18px; margin: 0px;" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" 	 width="613.408px" height="613.408px" viewBox="0 0 613.408 613.408" style="enable-background:new 0 0 613.408 613.408;" 	 xml:space="preserve"> <g> 	<path d="M605.254,168.94L443.792,7.457c-6.924-6.882-17.102-9.239-26.319-6.069c-9.177,3.128-15.809,11.241-17.019,20.855 		l-9.093,70.512L267.585,216.428h-142.65c-10.344,0-19.625,6.215-23.629,15.746c-3.92,9.573-1.71,20.522,5.589,27.779 		l105.424,105.403L0.699,613.408l246.635-212.869l105.423,105.402c4.881,4.881,11.45,7.467,17.999,7.467 		c3.295,0,6.632-0.709,9.78-2.002c9.573-3.922,15.726-13.244,15.726-23.504V345.168l123.839-123.714l70.429-9.176 		c9.614-1.251,17.727-7.862,20.813-17.039C614.472,186.021,612.136,175.801,605.254,168.94z M504.856,171.985 		c-5.568,0.751-10.762,3.232-14.745,7.237L352.758,316.596c-4.796,4.775-7.466,11.242-7.466,18.041v91.742L186.437,267.481h91.68 		c6.757,0,13.243-2.669,18.04-7.466L433.51,122.766c3.983-3.983,6.569-9.176,7.258-14.786l3.629-27.696l88.155,88.114 		L504.856,171.985z"/> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');					
						htp.p('<span style="width: calc(100% - 56px); margin-left: 10px;" title="Telas Favoritas">'||fun.lang('FAVORITOS')||'</span>');
						htp.p('<svg class="down" xmlns="http://www.w3.org/2000/svg" width="292.362" height="292.362" viewBox="0 0 292.362 292.362"><path d="M286.935 69.377c-3.614-3.617-7.898-5.424-12.848-5.424H18.274c-4.952 0-9.233 1.807-12.85 5.424C1.807 72.998 0 77.279 0 82.228c0 4.948 1.807 9.229 5.424 12.847l127.907 127.907c3.621 3.617 7.902 5.428 12.85 5.428s9.233-1.811 12.847-5.428L286.935 95.074c3.613-3.617 5.427-7.898 5.427-12.847 0-4.948-1.814-9.229-5.427-12.85z"/></svg>');
					htp.p('</li>');

				end if; 

				-- Cria grupos liberados para o usuário 
				for i in c_grupos loop 
					if (nvl(fun.ret_var ('COUNT_MENU'),'N') ='S') and (instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'iPhone') = 0 and instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'Android') = 0) then
						ws_count_menu:= ws_count_menu + 1;
					else	
						ws_count_menu:='';
						ws_separator :='';
					end if;
					ws_count := ws_count+1;
					htp.p('<li onclick="popupmenu(''screenlist'', '''||(i.cd_grupo)||''', '||ws_count||');">');
						htp.p('<span title="'||i.cd_grupo||'">'||ws_count_menu||ws_separator||fun.utranslate('NM_GRUPO', 'GRUPOS_FUNCAO', i.nm_grupo, ws_padrao)||'</span>');
						htp.p('<svg class="down" xmlns="http://www.w3.org/2000/svg" width="292.362" height="292.362" viewBox="0 0 292.362 292.362"><path d="M286.935 69.377c-3.614-3.617-7.898-5.424-12.848-5.424H18.274c-4.952 0-9.233 1.807-12.85 5.424C1.807 72.998 0 77.279 0 82.228c0 4.948 1.807 9.229 5.424 12.847l127.907 127.907c3.621 3.617 7.902 5.428 12.85 5.428s9.233-1.811 12.847-5.428L286.935 95.074c3.613-3.617 5.427-7.898 5.427-12.847 0-4.948-1.814-9.229-5.427-12.85z"/></svg>');
					htp.p('</li>');
				end loop;
			htp.p('</ul>');

		when prm_tipo = 'screenlist' or prm_tipo = 'sub-screenlist' then 

			ws_count_menu:= 0;
			ws_count_tela:= 0;

			if prm_tipo = 'screenlist' then
				htp.p('<ul id="screenlist">');
			end if;

				-- verificar qual é a ordem numérica do grupo (atributo Numeração do menu) ---
				for o in c_grupos loop					
					ws_count_menu := ws_count_menu + 1;
					if o.cd_grupo = prm_cond then
						exit;
					end if;
				end loop;

				ws_count := 1;

				for i in c_itens_menu (prm_cond) loop 
					
					-- verificar qual é a ordem numérica da tela (atributo Numeração do menu) ---
					if (nvl(fun.ret_var ('COUNT_MENU'),'N') ='S') and (instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'iPhone') = 0 and instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'Android') = 0) then
						
						ws_count_tela:= ws_count_tela + 1;
						
					else	
						ws_count_tela	:= '';
						ws_count_menu	:= '';
						ws_separator 	:= '';
					end if;

					if (((instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'iPhone') > 0 or instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'Android') > 0) and nvl(i.dispositivo, '0') <> 'desktop' and nvl(i.dispositivo, '0') <> 'nenhum') or ((instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'iPhone') = 0 and instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'Android') = 0) and nvl(i.dispositivo, '0') <> 'mobile' and nvl(i.dispositivo, '0') <> 'nenhum') or ws_usuario = fun.usuario) or ws_admin = 'A' then
						
						if prm_cond <> '###menu_grupo_favoritos###' then
							--if instr(i.cd_objeto,'SRC_') = 0 then
							if i.tipo = 'SUBGRUPO' then
								htp.p('<li onclick="popupmenu(''sub-screenlist'', '''||(i.cd_objeto)||''', '||ws_count||');">');
									htp.p('<span title="'||i.cd_objeto||'">'||ws_count_menu||ws_separator||fun.utranslate('NM_GRUPO', 'GRUPOS_FUNCAO', i.nm_objeto, ws_padrao)||'</span>');
									htp.p('<svg class="down" xmlns="http://www.w3.org/2000/svg" width="292.362" height="292.362" viewBox="0 0 292.362 292.362"><path d="M286.935 69.377c-3.614-3.617-7.898-5.424-12.848-5.424H18.274c-4.952 0-9.233 1.807-12.85 5.424C1.807 72.998 0 77.279 0 82.228c0 4.948 1.807 9.229 5.424 12.847l127.907 127.907c3.621 3.617 7.902 5.428 12.85 5.428s9.233-1.811 12.847-5.428L286.935 95.074c3.613-3.617 5.427-7.898 5.427-12.847 0-4.948-1.814-9.229-5.427-12.85z"/></svg>');
								htp.p('</li>');
							else
								htp.p('<li onclick="shscr('''||i.cd_objeto||''');">'||ws_count_menu||ws_separator||ws_count_tela||ws_separator||fun.utranslate('NM_OBJETO', i.cd_objeto, i.nm_objeto, ws_padrao)||'</li>');
							end if;
						else
							htp.p('<li onclick="shscr('''||i.cd_objeto||''');">'||fun.utranslate('NM_OBJETO', i.cd_objeto, i.nm_objeto, ws_padrao)||'</li>');
						end if;			
					end if;

					ws_count := ws_count + 1;

				end loop;

			if prm_tipo = 'screenlist' then
				htp.p('</ul>');
			end if;
			
	end case;

end popupMenu;

function popupMenu_itens ( prm_grupo   varchar2 default null, 
                           prm_usuario varchar2 default null, 
                           prm_admin   varchar2 default null,
						   prm_tipo    varchar2 default 'TODOS' ) return varchar2 as
    ws_objetos  varchar2(32000) := null;
begin

    for a in ( select obj.cd_objeto from objetos obj	
				where obj.cd_grupo = prm_grupo 
                  and (obj.cd_objeto like ('SRC_%') or obj.tp_objeto = 'SCREEN') 
				  and (prm_admin = 'A' or fun.check_screen_access(obj.cd_objeto, prm_usuario, prm_admin) > 0) 
				  and prm_tipo in ('TODOS','TELAS')
                union all 
               select cd_grupo from grupos_funcao gf 
                where cd_grupo_superior = prm_grupo
				  and prm_tipo in ('TODOS','GRUPOS') 
                  and exists (select obj.cd_objeto from objetos obj	
				               where obj.cd_grupo = gf.cd_grupo
                                 and (obj.cd_objeto like ('SRC_%') or obj.tp_objeto = 'SCREEN') 
				                 and (prm_admin = 'A' or fun.check_screen_access(obj.cd_objeto, prm_usuario, prm_admin) > 0) 
                             )
             ) loop 
        ws_objetos := ws_objetos||'|'||a.cd_objeto;            
    end loop;

    return substr(ws_objetos,2,32000);  -- Desconsidera primeiro |

end popupMenu_itens;


procedure perfil as

ws_email   	varchar2(60) := '';
ws_number  	varchar2(60) := '';
ws_nome    	varchar2(120);
ws_css     	varchar2(80);
ws_padrao  	varchar2(80);
ws_usuario 	varchar2(80);
ws_conteudo	       varchar2(80);
ws_nm_tela_inicial   objetos.nm_objeto%type; 	
ws_cd_tela_inicial   usuarios.cd_tela_inicial%type;

cursor crs_temas is select cd_tema, nm_tema 
from bi_tema;

ws_tema crs_temas%rowtype;

begin

	ws_usuario         := gbl.getUsuario;
	ws_nm_tela_inicial := null;
	ws_cd_tela_inicial := null;

	select usu_email, usu_completo, usu_number, cd_tela_inicial into ws_email, ws_nome, ws_number, ws_cd_tela_inicial 
	from usuarios where trim(usu_nome) = ws_usuario;
	if nvl(upper(ws_cd_tela_inicial),'DEFAULT') <> 'DEFAULT' then 
		select max(nm_objeto) into ws_nm_tela_inicial from objetos where cd_objeto = ws_cd_tela_inicial and rownum = 1;
	end if; 	

	select nvl(fun.getprop('DEFAULT','TEMA', prm_usuario => ws_usuario), 'ideativo') into ws_css from dual;
	select nvl(fun.getprop('DEFAULT','LINGUAGEM', prm_usuario => ws_usuario), 'PORTUGUES') into ws_padrao from dual;
	
	begin
		select conteudo into ws_conteudo from var_conteudo where variavel = 'APPCODE';
	exception
	when others then
		ws_conteudo:='SEM CÓDIGO';
	end;

	
	htp.p('<div id="perfil" data-reload="N">');

		htp.p('<h4>'||fun.lang('Ol&aacute;')||', '||ws_nome||'</h4>');

		htp.p('<ul>');
		
			htp.p('<li class="readonly">');
				htp.p('<label>'||fun.lang('C&oacute;digo do Aplicativo:')||'</label>');
				htp.p('<input type="text"  value="'||ws_conteudo||'" readonly />');
			htp.p('</li>');

			htp.p('<li class="readonly">');
				htp.p('<label>Login:</label>');
				htp.p('<input type="text"  value="'||ws_usuario||'" readonly />');
			htp.p('</li>');

			htp.p('<li>');
				htp.p('<label>'||fun.lang('Nome completo')||':</label>');
				htp.p('<input id="completo" type="text" value="'||ws_nome||'"/>');
			htp.p('</li>');

			htp.p('<li>');
				htp.p('<label>'||fun.lang('Digite a nova senha')||':</label>');
				htp.p('<input id="senha1" type="password" name="p_senha" value="" maxlength="28" placeholder="'||fun.lang('Digite a nova senha')||'" />');
			htp.p('</li>');

			/*htp.p('<li>');
				htp.p('<label>'||fun.lang('Digite novamente a Senha')||':</label>');
				htp.p('<input type="password" id="senha2" name="p_senha2"  value="" maxlength="28" placeholder="'||fun.lang('repita a senha')||'"/>');
			htp.p('</li>');*/

			--htp.p('<li>');
			--    htp.p('<label>Email:</label>');
			--    htp.p('<input type="text" onkeypress="return input(event, ''email'');"  id="email" name="email" value="'||ws_email||'" maxlength="40" placeholder="Email"/>');
			--htp.p('</li>');

			-- Alterado para não permitir que o usuário altere o email, o email deve ser parametrizado pelo admnistrado que criou o usuário (Solicitação do Fabiano para que o usuário não consiga colocar emails particular)
			htp.p('<li class="readonly">');
				htp.p('<label>Email:</label>');
				htp.p('<input type="text" id="email" name="email" value="'||ws_email||'" maxlength="40" placeholder="Email" readonly />');
			htp.p('</li>');
			
			htp.p('<li>');
				htp.p('<label>'||fun.lang('Telefone')||':</label>');
				htp.p('<input type="text" id="number" oninput="this.value = VMasker.toPattern(this.value, ''(99)99999-9999'');" name="number" value="'||ws_number||'" maxlength="40" placeholder="'||fun.lang('Telefone')||'"/>');
			htp.p('</li>');

			-- Tela inicial do usuário
			htp.p('<li>');
				htp.p('<label>'||fun.lang('Tela Inicial')||':</label>');
				htp.p('<a class="script" onclick=""></a>');
				fcl.fakeoption('cd_tela_inicial_usuario', '', ws_cd_tela_inicial, 'lista-telas-usuario', 'N', 'N', '','','',nvl(ws_nm_tela_inicial,'TELA PRINCIPAL') );
			htp.p('</li>');

			htp.p('<li id="temas">');
				htp.p('<label>'||fun.lang('Temas')||':</label>');

					open crs_temas; 
						loop
							fetch crs_temas into ws_tema;
							exit when crs_temas%notfound;
							if ws_css = ws_tema.nm_tema then
								htp.p('<a class="selectedtheme" style="background-color: '||ws_tema.cd_tema||'" onclick="document.getElementById(''perfil'').setAttribute(''data-reload'', ''S''); call(''alter_attrib'', ''prm_objeto=DEFAULT&prm_prop=TEMA&prm_value='||ws_tema.nm_tema||'&prm_usuario='||ws_usuario||''').then(() => { this.parentNode.querySelector(''.selectedtheme'').classList.remove(''selectedtheme''); this.classList.add(''selectedtheme''); });"></a>');
							else
								htp.p('<a style="background-color: '||ws_tema.cd_tema||';" onclick="document.getElementById(''perfil'').setAttribute(''data-reload'', ''S''); call(''alter_attrib'', ''prm_objeto=DEFAULT&prm_prop=TEMA&prm_value='||ws_tema.nm_tema||'&prm_usuario='||ws_usuario||''').then(() => { this.parentNode.querySelector(''.selectedtheme'').classList.remove(''selectedtheme''); this.classList.add(''selectedtheme''); });"></a>');
							end if;
						end loop;
					close crs_temas;

			htp.p('</li>');

			if fun.ret_var('LANG') <> 'N' then -- Somente se está parametrizado o controle de idioma na var_conteúdo 
				htp.p('<li>');
					htp.p('<label>'||fun.lang('Linguagem')||':</label>');
					htp.p('<select onchange="ajax(''fly'', ''alter_attrib'',  ''prm_objeto=DEFAULT&prm_prop=LINGUAGEM&prm_value=''+this.value+''&prm_usuario='||ws_usuario||''');">');
						for i in(select distinct nm_lang from language) loop
							if ws_padrao = i.nm_lang then
								htp.p('<option value="'||i.nm_lang||'" selected>'||i.nm_lang||'</option>');
							else
								htp.p('<option value="'||i.nm_lang||'">'||i.nm_lang||'</option>');
							end if;
						end loop;
					htp.p('</select>');
				htp.p('</li>');
			end if; 
		htp.p('</ul>');

		/*htp.p('<div id="temas">');
			htp.p('<span>Temas:</span>');
			htp.p('<ul>');

				if ws_css = 'ideativo' then
					htp.p('<li style="background-color: #673F96; border: 2px solid #222;" onclick="call(''alter_attrib'', ''prm_objeto=DEFAULT&prm_prop=TEMA&prm_value=ideativo&prm_usuario='||ws_usuario||''').then(function(){ window.location.reload(true); });"></li>');
				else
					htp.p('<li style="background-color: #673F96;" onclick="call(''alter_attrib'', ''prm_objeto=DEFAULT&prm_prop=TEMA&prm_value=ideativo&prm_usuario='||ws_usuario||''').then(function(){ window.location.reload(true); });"></li>');
				end if;

				if ws_css = 'evergreen' then
					htp.p('<li style="background-color: #3C8846; border: 2px solid #222;" onclick="call(''alter_attrib'', ''prm_objeto=DEFAULT&prm_prop=TEMA&prm_value=evergreen&prm_usuario='||ws_usuario||''').then(function(){ window.location.reload(true); });"></li>');
				else
					htp.p('<li style="background-color: #3C8846;" onclick="call(''alter_attrib'', ''prm_objeto=DEFAULT&prm_prop=TEMA&prm_value=evergreen&prm_usuario='||ws_usuario||''').then(function(){ window.location.reload(true); });"></li>');
				end if;

				if ws_css = 'florest' then
					htp.p('<li style="background-color: #6B6254; border: 2px solid #222;" onclick="call(''alter_attrib'', ''prm_objeto=DEFAULT&prm_prop=TEMA&prm_value=florest&prm_usuario='||ws_usuario||''').then(function(){ window.location.reload(true); });"></li>');
				else
					htp.p('<li style="background-color: #6B6254;" onclick="call(''alter_attrib'', ''prm_objeto=DEFAULT&prm_prop=TEMA&prm_value=florest&prm_usuario='||ws_usuario||''').then(function(){ window.location.reload(true); });"></li>');
				end if;

			htp.p('</ul>');
		htp.p('</div>');*/

		htp.p('<div style="width: 100%; display: flex; min-height: 46px;">');
			htp.p('<a class="addpurple" onclick="save_usuario();">'||fun.lang('ALTERAR')||'</a>');
		htp.p('</div>');

	htp.p('</div>');

end perfil;

procedure alerta as

begin

	htp.p('<ul id="feed-fixo"></ul>');

	htp.p('<ul style="display: none;" id="alerta-template">');
		htp.p('<li>');
			htp.p('<span></span>');
			htp.p('<a onclick="var template = this.parentNode; template.classList.add(''clicked''); setTimeout(function(){ template.parentNode.removeChild(template); }, 300);">'||fun.lang('FECHAR')||'</a>');
			htp.p('<span style="display: none;" onclick="this.nextElementSibling.classList.toggle(''show'');">mais detalhes</span>');
			htp.p('<span></span>');
		htp.p('</li>');
	htp.p('</ul>');

end alerta;

procedure userinfo ( prm_nome               varchar2 default null,
					prm_email              varchar2 default null,
					prm_cell               varchar2 default null,
					prm_notificacao        varchar2 default null,
					prm_senha              varchar2 default null) as

	ws_count      number;
	ws_countuser  number;
	ws_nmcompleto varchar2(100);
	ws_email      varchar2(100);
	ws_numero     varchar2(100);
	ws_usuario    varchar2(80);
	ws_pwd        varchar2(80);
	ws_pwd_valida varchar2(100);
	
	begin

		ws_usuario    := gbl.getUsuario;
		g_abriu_tela_infouser := 'N'; 

		-- Alterar para solcitar nova senha também para usuários ADM - 08/06/2022 
		-- if nvl(gbl.getNivel, 'N') <> 'A' then

			select count(nm_user) into ws_countuser from BI_INFO_USER where nm_user = ws_usuario;

			if ws_countuser = 0 then

				if nvl(prm_nome, 'N/A') = 'N/A' then

					select USU_COMPLETO, USU_EMAIL, USU_NUMBER into ws_nmcompleto, ws_email, ws_numero FROM USUARIOS where usu_nome = ws_usuario;

							g_abriu_tela_infouser := 'S'; 
							htp.p('<div id="blockpage">');

								htp.p('<div id="infocontainer" class="open">');

									htp.p('<h1>Atualizar Informa&ccedil;&otilde;es</h1>');
									htp.p('<ul id="infocontent">');
										htp.p('<li>');
											htp.p('<label>Nome Completo</label>');
											htp.p('<input id="boxnome" type="text" value="'||ws_nmcompleto||'" onchange="enviodecampos();">');
										htp.p('</li>');

										-- Desabilitado a alteração do email, o usuário final não deve ter permissão de alterar o seu endereço de email  
										htp.p('<li>');
											htp.p('<label>E-mail</label>');
											htp.p('<input id="boxemail" class="readonly" readonly type="text" value="'||ws_email||'" onchange="enviodecampos();"/>');
										htp.p('</li>');

										--htp.p('<li>');
										--	htp.p('<label>E-mail</label>');
										--	htp.p('<input id="boxemail" class="boxtext" type="text" value="'||ws_email||'" onchange="enviodecampos();"/>');
										--htp.p('</li>');
										

										htp.p('<li>');
											htp.p('<label>Telefone</label>');
											htp.p('<input id="boxcelular" class="boxtext" type="text" value="'||ws_numero||'" onchange="enviodecampos();"/>');
										htp.p('</li>');

										htp.p('<li>');
											htp.p('<label>Nova Senha</label>');
											htp.p('<input id="boxsenha" class="boxtext" type="password" value="" onchange="enviodecampos();"/>');
										htp.p('</li>');
										
										/* Comentado por causa dos questionamentos dos clientes, feature ainda não funciona.

											htp.p('<h2>Receber Notifica&ccedil;&otilde;es</h2>');
											htp.p('<li>');    
												htp.p('<span>E-mail</span>');
												htp.p('<input id="checkemail" class="checknotify" title="email" type="checkbox" />'); 
												htp.p('<span>Celular</span>'); 
												htp.p('<input id="checkcell" class="checknotify" checked title="celular" type="checkbox"/>');            
											htp.p('</li>');
											
										*/

									htp.p('</ul>');

									htp.p('<div class="concluir">');
										htp.p('<a class="boxconcluir addpurple" onclick="enviodecampos(''enviar'');">CONCLUIR</a>');
									htp.p('</div>');
									
								/**************
									htp.p('<span id="motivo">');    
										htp.p('<span title="Os dados coletados ser&atilde;o de uso exclusivo do sistema, podendo ser usados para contato e novos recursos da ferramenta.">Por que devo informar estes dados?</span>');          
									htp.p('</span>');

								*************/
								htp.p('</div>');
							htp.p('</div>');    
				else
					ws_pwd_valida := substr(fun.validaPassword(ws_usuario, prm_senha),1,100);  -- Valida a senha informada 
					if ws_pwd_valida <> 'OK' then 
						htp.p('ERRO|'||ws_pwd_valida); 			
					else 
						update usuarios set usu_completo = prm_nome, /*usu_email = prm_email,*/  usu_number = prm_cell where usu_nome = ws_usuario;
						insert into BI_INFO_USER values(ws_usuario, prm_notificacao);
						ws_pwd        := fun.digestPassword(ws_usuario, prm_senha);
						commit;
						htp.p('OK|'); 			

					end if; 
				end if;
			end if;

		-- end if;

	exception
	when others then
		htp.p('ERRO|'||sqlerrm);

end userinfo;


procedure notice_popup_mount ( prm_aviso        number   default null, 
							prm_tipo         varchar2 default null) as


	cursor c_aviso (p_id_aviso number)  is 
		select * from bi_avisos 
		where id_aviso = p_id_aviso; 
	--
	ws_id_aviso      number; 
	ws_id_aviso_max  number; 
	ws_id_aviso_min  number; 
	ws_aviso         c_aviso%rowtype; 
	ws_count         number; 
	ws_usuario           varchar2(200); 
	ws_admin             varchar2(80); 
	-- ws_url_img           varchar2(300); 
	ws_action_next       varchar2(4000); 
	ws_action_prev       varchar2(4000); 		
	ws_readonly_next     varchar2(200); 
	ws_readonly_prev     varchar2(200); 
	ws_check_nao_mostrar varchar2(20); 
	ws_style_backgroud   varchar2(200);
	ws_msg               varchar2(200);
	ws_cd_cliente		 varchar2(200);
	ws_raise_aviso       exception; 

	begin
		ws_usuario := gbl.getUsuario; 
		ws_admin   := nvl(gbl.getNivel(ws_usuario),'N'); 
		ws_msg     := null;
		ws_cd_cliente := nvl(fun.ret_var('CLIENTE'), 'N/A');

		if instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'iPhone') <> 0 or instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'Android') <> 0 then
			ws_msg := 'AVISO|Tela desativada para dispositivos m&oacute;veis'; 
			raise ws_raise_aviso;
		end if; 	

		ws_id_aviso     := null; 
		ws_id_aviso_min := null; 
		ws_id_aviso_max := null; 

		select min(id_aviso), max(id_aviso) 
		into ws_id_aviso_min, ws_id_aviso_max 
		from bi_avisos t1
		where sysdate between dh_inicio and dh_fim
		and tp_usuario    = decode(tp_usuario,'TODOS',tp_usuario, ws_admin)
        and ((    t1.tp_origem = 'CLIENTE' 
              and (   exists (select 1 
                                from bi_aviso_permissao p 
                               where t1.id_aviso = p.id_aviso 
                                 and p.nm_usuario in (ws_usuario, 'DWU'))
                   or exists (select 1 
                                from bi_aviso_permissao p, gusers_itens g
                               where t1.id_aviso = p.id_aviso 
                                 and p.nm_usuario=g.cd_group
                                 and g.cd_usuario=ws_usuario))
             ) or (t1.tp_origem is null and id_aviso < 100000)) ;

		if ws_id_aviso_min is null then -- Não tem avisos ativos 
			raise ws_raise_aviso; 
		end if; 

		if prm_aviso is null then  
			-- Pega o primeiro aviso ainda não lido pelo usuário 
			select min(id_aviso) into ws_id_aviso
			from bi_avisos t1
			where sysdate between dh_inicio and dh_fim
            and ((    t1.tp_origem = 'CLIENTE' 
                  and (   exists (select 1 
                                    from bi_aviso_permissao p 
                                   where t1.id_aviso = p.id_aviso 
                                     and p.nm_usuario in (ws_usuario, 'DWU'))
                       or exists (select 1 
                                    from bi_aviso_permissao p, gusers_itens g
                                   where t1.id_aviso = p.id_aviso 
                                     and p.nm_usuario=g.cd_group
                                     and g.cd_usuario=ws_usuario))
                 ) or (t1.tp_origem is null and id_aviso < 100000))
			and tp_usuario    = decode(tp_usuario,'TODOS',tp_usuario, ws_admin)
			and not exists (select 1 from bi_aviso_usuario t2
								where t2.id_aviso = t1.id_aviso 
								and t2.usu_nome = ws_usuario
								and nvl(t2.qt_visualizacao,0) > 0 )  ;
			-- Se todos foram visualizados, pega o ultimo aviso ainda ativo (se existir)
			if ws_id_aviso is null then 
				select max(id_aviso) into ws_id_aviso 
				from bi_avisos t1
				where sysdate between dh_inicio and dh_fim
                and ((    t1.tp_origem = 'CLIENTE' 
                      and (   exists (select 1 
                                        from bi_aviso_permissao p 
                                       where t1.id_aviso = p.id_aviso 
                                         and p.nm_usuario in (ws_usuario, 'DWU'))
                           or exists (select 1 
                                        from bi_aviso_permissao p, gusers_itens g
                                       where t1.id_aviso = p.id_aviso 
                                         and p.nm_usuario=g.cd_group
                                         and g.cd_usuario=ws_usuario))
                     ) or (t1.tp_origem is null and id_aviso < 100000))
                and tp_usuario    = decode(tp_usuario,'TODOS',tp_usuario, ws_admin); 
			end if; 
		else 
			if nvl(prm_tipo,'NA') in ('NA','MENU') then
				ws_id_aviso := prm_aviso;
			else 	
				if prm_tipo = 'PROXIMO' then 
					select min(id_aviso) into ws_id_aviso from bi_avisos t1
					where id_aviso > prm_aviso 
					and sysdate between dh_inicio and dh_fim
					and tp_usuario    = decode(tp_usuario,'TODOS',tp_usuario, ws_admin) 
                    and ((    t1.tp_origem = 'CLIENTE' 
                          and (   exists (select 1 
                                            from bi_aviso_permissao p 
                                           where t1.id_aviso = p.id_aviso 
                                             and p.nm_usuario in (ws_usuario, 'DWU'))
                               or exists (select 1 
                                            from bi_aviso_permissao p, gusers_itens g
                                           where t1.id_aviso = p.id_aviso 
                                             and p.nm_usuario=g.cd_group
                                             and g.cd_usuario=ws_usuario))
                         ) or (t1.tp_origem is null and id_aviso < 100000)) ;
				elsif prm_tipo = 'ANTERIOR' then  		 
					select max(id_aviso) into ws_id_aviso from bi_avisos t1
					where id_aviso < prm_aviso 
					and sysdate between dh_inicio and dh_fim
					and tp_usuario    = decode(tp_usuario,'TODOS',tp_usuario, ws_admin) 
                    and ((    t1.tp_origem = 'CLIENTE' 
                          and (   exists (select 1 
                                            from bi_aviso_permissao p 
                                           where t1.id_aviso = p.id_aviso 
                                             and p.nm_usuario in (ws_usuario, 'DWU'))
                               or exists (select 1 
                                            from bi_aviso_permissao p, gusers_itens g
                                           where t1.id_aviso = p.id_aviso 
                                             and p.nm_usuario=g.cd_group
                                             and g.cd_usuario=ws_usuario))
                         ) or (t1.tp_origem is null and id_aviso < 100000)) ;
				end if; 
				--
				if ws_id_aviso is null then -- Se não tem próximo ou anterior então mostrar ele mesmo novamente 
					ws_id_aviso := prm_aviso;
				end if; 
			end if; 	
		end if; 

		if ws_id_aviso is null then 
			raise ws_raise_aviso; 
		end if; 

		open  c_aviso (ws_id_aviso); 
		fetch c_aviso into ws_aviso;
		close c_aviso; 

		-- Busca a situação do "Não Mostrar novamente" do último aviso do sistema 
		select decode(count(*),0,' ','checked') into ws_check_nao_mostrar
		from bi_aviso_usuario 
		where id_aviso = ws_id_aviso_max 
		and usu_nome = ws_usuario
		and nvl(id_nao_mostrar,'N') = 'S' ;

		-- Se for na abertura do sistema 
		if prm_tipo = 'INICIO' then 
			select count(*) into ws_count 
			from usuarios 
			where usu_nome                  = ws_usuario 
			and nvl(id_aviso_mostrar,'S') = 'N'; 
			--
			if nvl(fun.ret_var('AVISO_MOSTRAR'),'S') = 'N' or ws_count > 0 then 
				ws_msg := 'AVISO|Parametrizado para n&atilde;o mostrar tela de aviso na abertura do sistema.'; 
				raise ws_raise_aviso;			
			end if;
			--   
			-- Se for na abertura do BI, não mostrar se o usuário já marcou o último aviso para não mostrar
			if ws_check_nao_mostrar = 'checked' then  
				ws_msg := 'AVISO|Sem aviso a ser exibido.';
				raise ws_raise_aviso;
			end if;    
		end if; 

		-- Atualiza a quantidade de visualiação do aviso para o usuário 
		update bi_aviso_usuario 
		set qt_visualizacao = qt_visualizacao + 1,
			dh_visualizacao = nvl(dh_visualizacao,sysdate)  	
		where id_aviso = ws_id_aviso 
		and usu_nome = ws_usuario ; 
		if sql%notfound then 
			insert into bi_aviso_usuario (id_aviso, usu_nome, qt_visualizacao, dh_visualizacao, id_nao_mostrar, dh_nao_mostrar) values (ws_id_aviso, ws_usuario, 1, sysdate, 'N', null); 
		end if; 

		if ws_aviso.tp_conteudo = 'IMAGEM EXTERNA' then 
			ws_style_backgroud := 'style="background-image: url('||ws_aviso.nm_conteudo||')" ';  
		else 	
			select count(*) into ws_count from tab_documentos where name = ws_aviso.nm_conteudo and usuario in ('AVISO','DWU');
			if ws_count > 0 then 
				ws_style_backgroud := 'style="background-image: url('||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download_tab?prm_arquivo='||replace(replace(ws_aviso.nm_conteudo,'(','\('),')','\)')||'&prm_alternativo=AVISO)"'; 
			else 
				ws_style_backgroud := 'style="background-color: white;"'; 
			end if; 	
		end if;

		ws_action_prev := 'notice_popup_open (document.getElementById(''aviso_id_aviso'').value, ''ANTERIOR'' )'; 
		ws_action_next := 'notice_popup_open (document.getElementById(''aviso_id_aviso'').value, ''PROXIMO'' )'; 

		ws_readonly_next := '';
		ws_readonly_prev := ''; 
		if ws_aviso.id_aviso = ws_id_aviso_max then 
			ws_readonly_next := 'background:gray; cursor:context-menu; opacity:1;';
			ws_action_next   := ''; 
		end if; 	
		if ws_aviso.id_aviso = ws_id_aviso_min then 
			ws_readonly_prev := 'background:gray; cursor:context-menu; opacity:1;';
			ws_action_prev   := ''; 
		end if; 	

		if nvl(prm_tipo,'.') not in ('PROXIMO','ANTERIOR') then 
			htp.p('<div id="blockpage">');
		end if; 

		htp.p('<div class="notice-popup-frame" '||ws_style_backgroud||' >');

			if ws_aviso.url_aviso is not null then 
				htp.p('<a class="notice-popup-url"" href="'||replace(replace(ws_aviso.url_aviso, '${USUARIO}', ws_usuario), '${CLIENTE}', ws_cd_cliente)||'" target="_blank" rel="noopener noreferrer" ></a>'); 
			end if; 	
			
			htp.p('<span class="notice-popup-close" onclick="notice_refresh_count(); document.getElementById(''blockpage'').remove();" >');
				htp.p('<a class="notice-close-popup">X</a>');
			htp.p('</span>');
			htp.p('<span class="notice-bar-popup">'); 
                htp.p('<input id="aviso_id_aviso"     type="hidden"  value="'||ws_aviso.id_aviso||'">');
                htp.p('<input id="aviso_nao_mostrar"  type="checkbox" class="notice-popup-check" title="N&atilde;o mostrar novamente." '||ws_check_nao_mostrar||' onchange="call(''notice_update_user'', ''prm_aviso=''+document.getElementById(''aviso_id_aviso'').value+''&prm_nao_mostrar=''+(document.getElementById(''aviso_nao_mostrar'').checked?''S'':''N''));" >');
                htp.p('<span class="notice-popup-check">N&atilde;o mostrar novamente</span>');
                htp.p('<span class="notice-arrows-popup">');
                    htp.p('<a class="notice-popup-arrow" style="'||ws_readonly_prev||'" onclick="'||ws_action_prev||'"> < </a>');
                    htp.p('<a class="notice-popup-arrow" style="'||ws_readonly_next||'" onclick="'||ws_action_next||'"> > </a>'); 
                htp.p('</span>');
                if ws_aviso.tela_aviso is not null then
                    htp.p('<span class="notice-popup-go-to-span">');
                        htp.p('<a class="notice-popup-go-to" onclick="notice_popup_go_to('''||ws_aviso.tela_aviso||''')">Ir Para Tela</a');
                    htp.p('</span>');
                end if;
			htp.p('</span>');


		htp.p('</div>'); 

		if nvl(prm_tipo,'.') not in ('PROXIMO','ANTERIOR') then 				
			htp.p('</div>'); 
		end if; 	

		commit; 

	exception
		when ws_raise_aviso then 
			if prm_tipo <> 'INICIO' then 		
				htp.p(ws_msg); 			
			end if;	
		when others then
			insert into bi_log_sistema values (sysdate, 'NOTICE_POPUP_MOUNT (others):'|| DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, ws_usuario, 'ERRO');
			commit; 
			if prm_tipo <> 'INICIO' then 
				htp.p('ERRO|N&aatild;o foi poss&iacute;vel abrir aviso, favor entrar em contato com adminstrador do sistema.'); 		
			end if;		
end notice_popup_mount;



procedure notice_update_user ( prm_aviso        number   default null, 
							prm_nao_mostrar  varchar2 default 'N') as

	ws_usuario       varchar2(80); 
	ws_raise_aviso   exception; 
begin
	ws_usuario := gbl.getUsuario; 

	-- Atualiza todos os avisos do com não mostrar sim ou não
	update bi_aviso_usuario 
	set id_nao_mostrar = prm_nao_mostrar,
		dh_nao_mostrar = decode(prm_nao_mostrar,'N',null,sysdate)  	
	where usu_nome  = ws_usuario ; 
	--
	commit; 
	--
exception 
	when others then
		insert into bi_log_sistema values (sysdate, 'NOTICE_UPDATE_USER (others):'|| DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, ws_usuario, 'ERRO');
		commit; 
end notice_update_user; 

-- Retorna quantidade de avisos total e não lidos pelo usuário 
procedure notice_get_count ( prm_qt_aviso      in out number,
							prm_qt_nao_lido 	in out number) as
	ws_usuario            varchar2(80); 
	ws_admin              varchar2(80); 
begin

	ws_usuario      := gbl.getUsuario; 
	ws_admin        := nvl(gbl.getNivel(ws_usuario),'N'); 

	prm_qt_aviso    := 0;
	prm_qt_nao_lido := 0; 

	select count(*) into prm_qt_aviso 
	from bi_avisos t1
	where sysdate between dh_inicio and dh_fim
	and tp_usuario    = decode(tp_usuario,'TODOS',tp_usuario, ws_admin) 
    and ((    t1.tp_origem = 'CLIENTE' 
          and (   exists (select 1 
                            from bi_aviso_permissao p 
                           where t1.id_aviso = p.id_aviso 
                             and p.nm_usuario in (ws_usuario, 'DWU'))
               or exists (select 1 
                            from bi_aviso_permissao p, gusers_itens g
                           where t1.id_aviso = p.id_aviso 
                             and p.nm_usuario=g.cd_group
                             and g.cd_usuario=ws_usuario))
         ) or (t1.tp_origem is null and id_aviso < 100000));
	--
	select count(*) into prm_qt_nao_lido 
	from bi_avisos a 
	where sysdate between dh_inicio and dh_fim
	and tp_usuario    = decode(tp_usuario,'TODOS',tp_usuario, ws_admin)
	and ((    a.tp_origem = 'CLIENTE' 
          and (   exists (select 1 
                            from bi_aviso_permissao p 
                           where a.id_aviso = p.id_aviso 
                             and p.nm_usuario in (ws_usuario, 'DWU'))
               or exists (select 1 
                            from bi_aviso_permissao p, gusers_itens g
                           where a.id_aviso = p.id_aviso 
                             and p.nm_usuario=g.cd_group
                             and g.cd_usuario=ws_usuario))
         ) or (a.tp_origem is null and id_aviso < 100000))
    and not exists (select 1 from bi_aviso_usuario b 
					where b.id_aviso = a.id_aviso 
						and b.usu_nome = ws_usuario 
						and nvl(b.qt_visualizacao,0) > 0 
					) ;
	--
exception 
	when others then
		insert into bi_log_sistema values (sysdate, 'NOTICE_GET_COUNT (others):'|| DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, ws_usuario, 'ERRO');
		commit; 
end notice_get_count; 




-- Chamado pelo frontend para retornar a quantidade de avisos não lidos pelo usuário 
procedure notice_ret_count as
	ws_qt_aviso      number;
	ws_qt_nao_lido   number; 
begin
	notice_get_count ( ws_qt_aviso, ws_qt_nao_lido); 
	htp.p(ws_qt_nao_lido); 	
	--
exception 
	when others then
		insert into bi_log_sistema values (sysdate, 'NOTICE_RET_COUNT (others):'|| DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, 'DWU', 'ERRO');
		commit; 
		htp.p('0');
end notice_ret_count; 



procedure release_version ( prm_version varchar2 default null ) as

	/*cursor crs_scripts is 
	select tipo, nm_conteudo, conteudo 
	from script_atualizacao 
	where versao_sistema = prm_version and
	tipo in ('PACKAGE_BODY', 'PACKAGE_SPEC', 'SCRIPT')
	order by tipo;

	ws_script crs_scripts%rowtype;

	ws_conteudo clob;*/

begin

	htp.p('/* ARQUIVO VER '||prm_version||' */'||chr(13)||chr(10));

	/*open crs_scripts;
		loop
			fetch crs_scripts into ws_script;
			exit when crs_scripts%notfound;
			ws_conteudo := '';
			if ws_script.tipo = 'SCRIPT' then
				htp.p(trim(upper(ws_script.conteudo)));
			elsif ws_script.tipo = 'PACKAGE_SPEC' then
				for i in(select text from all_SOURCE where NAME = upper(ws_script.nm_conteudo) AND TYPE = 'PACKAGE' order by line) loop
					htp.p(trim(i.text));
				end loop;
			else
				for i in(select text from all_SOURCE where NAME = upper(ws_script.nm_conteudo) AND TYPE = 'PACKAGE BODY' order by line) loop
					htp.p(trim(i.text));
				end loop;
			end if;
			--htp.p(ws_script.nm_conteudo);
			htp.p(';'||chr(13)||chr(10));
		end loop;
	close crs_scripts;*/

exception when others then
	htp.p(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
end release_version;

procedure button_lixo ( prm_req      varchar2 default null,
						prm_parm     varchar2 default null,	
						prm_valores  varchar2 default null,
						prm_vldecode number   default null,
						prm_objeto   varchar2 default null,
						prm_tag      varchar2 default 'a',
						prm_pkg      varchar2 default 'FCL',
						prm_title    varchar2 default 'Excluir' ) as

BEGIN	

	htp.p('<'||prm_tag||' class="remove" data-require="'||prm_req||'" data-param="'||prm_parm||'" data-valor="'||prm_valores||'" data-decode="'||prm_vldecode||'" data-objeto="'||prm_objeto||'" data-pkg="'||prm_pkg||'" title="'||fun.lang(prm_title)||'">X</'||prm_tag||'>');

end button_lixo;

/*procedure fakecheckbox( prm_positive varchar2 default null,
						prm_negative varchar2 default null,
						prm_title    varchar2 default null,
						prm_checked  varchar2 default null ) as 
begin

	htp.p('<span class="checkbox '||prm_checked||'" data-positive="'||prm_positive||'" data-negative="'||prm_negative||'" title="'||prm_title||'"></span>');

end fakecheckbox;*/

procedure jumpdrill ( prm_objeto     varchar2, 
					prm_screen     varchar2 default null,
					prm_colunas    varchar2 default null,
					prm_visao      varchar2 default null,
					prm_objeto_ant varchar2 default null,
					prm_coluna     varchar2 default null,
					prm_condicao   varchar2 default null,
					prm_cd_goto    varchar2 default 0 ) as

	cursor crs_filtros_objeto is
		select trim(cd_coluna)||'|'||decode(rtrim(condicao),'IGUAL','$[IGUAL]','DIFERENTE','$[DIFERENTE]','MAIOR','$[MAIOR]','MENOR','$[MENOR]','MAIOROUIGUAL','$[MAIOROUIGUAL]','MENOROUIGUAL','$[MENOROUIGUAL]','LIKE','$[LIKE]','NOTLIKE','$[NOTLIKE]','$[IGUAL]')
		||rtrim(replace(conteudo,'|','@PIPE@')) as coluna
		from FILTROS
		where micro_visao  = trim(prm_visao) 
		  and cd_objeto   in (fun.get_cd_obj(prm_objeto), trim('xxx'))  --xxx é prm_screen
		  and cd_usuario   = 'DWU' 
		  and tp_filtro    = 'objeto' 
		  and ligacao    <> 'or' 
		  and st_agrupado = 'N' 
		  and condicao   <> 'NOFLOAT' 
		  and CONDICAO   <> 'NOFILTER';

	ws_filtros_objeto crs_filtros_objeto%rowtype;
	
	ws_parametros 		 clob;
	ws_colunas    		 varchar2(20000);
	ws_filtro     		 number;
	ws_pode_anotar       varchar2(1);
	ws_anot_texto        varchar2(32000); 
	ws_usua_anot         varchar2(32000); 
	ws_usua_perm         varchar2(32000); 
	ws_ds_usua_perm      varchar2(4000); 
	ws_objeto            varchar2(200); 
	ws_class_div         varchar2(50);
	ws_class_span        varchar2(50);
	ws_ds_aux            varchar2(300); 

	ws_usuario    varchar2(100); 
	ws_admin      varchar2(30); 

begin

	ws_usuario  := gbl.getUsuario;
	ws_admin    := nvl(gbl.getNivel(ws_usuario),'N');
	ws_objeto   := fun.get_cd_obj(prm_objeto);
	ws_pode_anotar    := 'N'; 
	ws_usua_anot      := fun.getprop (ws_objeto, 'USUARIO_ANOTACAO'); 

	if nvl(fun.ret_var('ANOT_HABILITA'),'N') = 'S' then 
		if prm_coluna is not null then 
			if ws_usua_anot = 'DWU' or instr('|'||ws_usua_anot||'|', '|'||ws_usuario||'|') > 0 then -- Usuário pode fazer anotação no objeto 
				ws_pode_anotar := 'S'; 
			else 
				for b in (select * from gusers_itens where cd_usuario = ws_usuario) loop 
					if instr('|'||ws_usua_anot||'|', '|'||b.cd_group||'|' ) > 0 then   -- Se o grupo do usuário estiver entre os liberados para fazer anotação 
						ws_pode_anotar := 'S';
					end if; 
				end loop; 		
			end if;	
		end if; 
	end if; 
	

	select count(*) into ws_filtro from object_attrib where cd_prop = 'FILTRO' and (propriedade = 'ISOLADO' or propriedade = 'COM CORTE' or propriedade = 'INTERROMPIDO') and cd_object = prm_objeto;
	
	if ws_filtro = 0 then
		open crs_filtros_objeto;
			loop
				fetch crs_filtros_objeto into ws_filtros_objeto;
				exit when crs_filtros_objeto%notfound;
				ws_parametros := ws_parametros||ws_filtros_objeto.coluna||'|';
				--ws_parametros_unicos := ws_parametros||ws_filtros_objeto.coluna||'|';
			end loop;
		close crs_filtros_objeto;
	end if;

if ws_pode_anotar = 'S' then 
	ws_class_div  := ' jumpdrill_div_2 ';
	ws_class_span := ' jumpdrill_span_2 ';
	-- 'style="width:calc(11% - 4px) !important;"' ;
else 	
	ws_class_div  := ' jumpdrill_div_1 ';
	ws_class_span := ' jumpdrill_span_1 '; 
END IF; 	

	htp.prn('<div id="jumpdrill" class="'||ws_class_div||'" data-parametros="'||ws_parametros||'" data-visao="'||prm_visao||'">');
		htp.p('<a class="fechartab">x</a>');
		--htp.p('<a class="script" onclick="drillChange(this.nextElementSibling.title, this.parentNode, '''||prm_objeto_ant||'|'||ws_objeto||''');"></a>');
		--fcl.fakeoption('lista-drill', fun.lang('Lista de drills'), '', 'lista-drill', 'N', 'N', '##'||ws_objeto||'|'||nvl(prm_cd_goto,0), '', prm_objeto_ant||'|'||ws_objeto); 
		htp.p('<a class="script" onclick="drillChange(this.nextElementSibling.title, this.parentNode, '''||prm_objeto_ant||'|'||prm_objeto||''');"></a>');
		fcl.fakeoption('lista-drill', fun.lang('Lista de drills'), '', 'lista-drill', 'N', 'N', '##'||ws_objeto||'|'||nvl(prm_cd_goto,0), '', prm_objeto_ant||'|'||prm_objeto);   -- ajustado para levar todo o nome do objeto na tela/html

        htp.p('<ul>');
			htp.p('<li id="quick-atalhos">');
				htp.p('<span class="icons '||ws_class_span||'" title="ponto de avalia&ccedil;&atilde;o" data-tipo="VALOR">');
					htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve"> <g> <g> <path d="M400.388,175.787c-1.707-3.413-4.267-5.12-7.68-5.12H292.015L391.855,12.8c1.707-2.56,1.707-5.973,0-8.533 S387.588,0,384.175,0H247.642c-3.413,0-5.973,1.707-7.68,4.267l-128,256c-1.707,2.56-1.707,5.973,0,8.533 c1.707,2.56,5.12,4.267,7.68,4.267h87.893l-95.573,227.84c-1.707,3.413,0,7.68,3.413,10.24c0.853,0.853,2.56,0.853,4.267,0.853 c2.56,0,5.12-0.853,6.827-2.56l273.067-324.267C401.242,182.613,402.095,179.2,400.388,175.787z M149.508,454.827l78.507-187.733 c0.853-2.56,0.853-5.12-0.853-7.68c-1.707-1.707-4.267-3.413-6.827-3.413h-87.04L252.762,17.067h116.053L268.122,174.933 c-1.707,2.56-1.707,5.973,0,8.533s4.267,4.267,7.68,4.267h98.987L149.508,454.827z"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
					--htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve"> <g> <g> <path d="M446.609,174.221H299.483L383.59,0H193.12L65.391,308.391h157.093L184.831,512L446.609,174.221z M125.329,268.34 l94.553-228.289h99.899l-84.107,174.221h129.225l-110.694,142.83l16.415-88.761H125.329z"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
				htp.p('</span>');
				htp.p('<span class="icons '||ws_class_span||'" title="gr&aacute;fico de pizza" data-tipo="PIZZA">');
					htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve"> <g> <g> <g> <path d="M234.667,263.019V32c0-5.888-4.779-10.667-10.667-10.667c-123.52,0-224,110.059-224,245.333S110.059,512,245.333,512 c60.523,0,93.269-10.965,134.784-45.099c4.459-3.669,5.184-10.219,1.643-14.784L234.667,263.019z M245.333,490.667 c-123.52,0-224-100.48-224-224c0-119.552,85.184-217.536,192-223.701v223.701c0,2.368,0.789,4.672,2.261,6.549l142.848,183.659 C324.757,482.603,296.661,490.667,245.333,490.667z"/> <path d="M266.667,256h234.667c5.888,0,10.667-4.779,10.667-10.667C512,110.059,401.941,0,266.667,0 C260.779,0,256,4.779,256,10.667v234.667C256,251.221,260.779,256,266.667,256z M277.333,21.589 c115.051,5.419,207.659,98.027,213.077,213.077H277.333V21.589z"/> <path d="M501.333,277.333H288c-4.096,0-7.872,2.368-9.643,6.08c-1.771,3.712-1.237,8.107,1.344,11.285l138.667,171.669 c1.856,2.325,4.587,3.733,7.552,3.947c0.256,0.021,0.491,0.021,0.747,0.021c2.688,0,5.291-1.024,7.275-2.859 C483.541,421.205,512,355.797,512,288C512,282.112,507.221,277.333,501.333,277.333z M427.584,443.819L310.336,298.667h180.075 C487.787,352.896,465.344,404.757,427.584,443.819z"/> </g> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
				htp.p('</span>');
				htp.p('<span class="icons '||ws_class_span||'" title="gr&aacute;fico de linha" data-tipo="LINHAS">');
					htp.p('<svg height="512" viewBox="0 0 74 74" width="512" xmlns="http://www.w3.org/2000/svg"><path d="m47.24 67h-2.97a1 1 0 0 1 0-2h2.97a1 1 0 1 1 0 2z"/><path d="m27.37 67h-24.37a1 1 0 0 1 0-2h24.37a1 1 0 1 1 0 2z"/><path d="m37.27 67h-2.9a1 1 0 0 1 0-2h2.9a1 1 0 1 1 0 2z"/><path d="m71 67h-16.76a1 1 0 0 1 0-2h15.76v-26a1 1 0 0 1 2 0v27a1 1 0 0 1 -1 1z"/><path d="m8 42a1 1 0 0 1 -.707-1.707l19.5-19.5a1 1 0 0 1 1.415 0l18.242 18.242 12.8-14.692a.959.959 0 0 1 .776-.343 1 1 0 0 1 .761.382l11 14a1 1 0 0 1 -1.573 1.236l-10.253-13.05-12.707 14.589a1 1 0 0 1 -.719.343 1.011 1.011 0 0 1 -.742-.293l-18.293-18.293-18.792 18.793a1 1 0 0 1 -.708.293z"/><path d="m8 59.75a1 1 0 0 1 -.707-1.707l19.5-19.5a1 1 0 0 1 1.415 0l18.242 18.242 12.8-14.692a.989.989 0 0 1 .779-.343 1 1 0 0 1 .761.382l11 14a1 1 0 0 1 -1.573 1.236l-10.256-13.05-12.707 14.589a1 1 0 0 1 -1.461.05l-18.293-18.293-18.792 18.793a1 1 0 0 1 -.708.293z"/><path d="m8 72a1 1 0 0 1 -1-1v-68a1 1 0 0 1 2 0v68a1 1 0 0 1 -1 1z"/></svg>');
				htp.p('</span>');
				htp.p('<span class="icons '||ws_class_span||'" title="gr&aacute;fico de coluna" data-tipo="COLUNAS">');
					htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 480 480" style="enable-background:new 0 0 480 480;" xml:space="preserve"> <g> <g> <g> <rect y="464" width="480" height="16"/> <path d="M32,448h80c4.418,0,8-3.582,8-8V296c0-4.418-3.582-8-8-8H32c-4.418,0-8,3.582-8,8v144C24,444.418,27.582,448,32,448z M40,304h64v128H40V304z"/> <path d="M256,448h80c4.418,0,8-3.582,8-8V200c0-4.418-3.582-8-8-8h-80c-4.418,0-8,3.582-8,8v240C248,444.418,251.582,448,256,448 z M264,208h64v224h-64V208z"/> <path d="M144,448h80c4.418,0,8-3.582,8-8V104c0-4.418-3.582-8-8-8h-80c-4.418,0-8,3.582-8,8v336C136,444.418,139.582,448,144,448 z M152,112h64v320h-64V112z"/> <path d="M368,448h80c4.418,0,8-3.582,8-8V8c0-4.418-3.582-8-8-8h-80c-4.418,0-8,3.582-8,8v432C360,444.418,363.582,448,368,448z M376,16h64v416h-64V16z"/> </g> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
				htp.p('</span>');
				htp.p('<span class="icons '||ws_class_span||'" title="gr&aacute;fico de barra" data-tipo="BARRAS">');
					--htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve"> <g> <g> <path d="M492,186H40v-26h252c11.046,0,20-8.954,20-20V40c0-11.046-8.954-20-20-20H40C40,8.954,31.046,0,20,0S0,8.954,0,20 c0,6.838,0,465.072,0,472c0,11.046,8.954,20,20,20s20-8.954,20-20h152c11.046,0,20-8.954,20-20V372c0-11.046-8.954-20-20-20H40 v-26h452c11.046,0,20-8.954,20-20V206C512,194.954,503.046,186,492,186z M40,60h232v60H40V60z M172,392v60H40v-60H172z M472,286 H40v-60h432V286z"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
					htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 480 480" style="enable-background:new 0 0 480 480;" xml:space="preserve"> <g> <g> <path d="M448,352H40v-56h272c4.8,0,8-3.2,8-8v-96c0-4.8-3.2-8-8-8H40v-56h144c4.8,0,8-3.2,8-8V24c0-4.8-3.2-8-8-8H40V8 c0-4.8-3.2-8-8-8s-8,3.2-8,8v464c0,4.8,3.2,8,8,8s8-3.2,8-8v-8h408c4.8,0,8-3.2,8-8v-96C456,355.2,452.8,352,448,352z M40,32h136 v80H40V32z M40,200h264v80H40V200z M440,448H40v-80h400V448z"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
				htp.p('</span>');
				htp.p('<span class="icons '||ws_class_span||'" title="gr&aacute;fico de mapa" data-tipo="MAPA">');
					htp.p('<svg version="1.1" style="border: 1px solid #AAA; padding: 0 2px; border-radius: 4px;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 423.221 423.221" style="enable-background:new 0 0 423.221 423.221;" xml:space="preserve"> <g> <path d="M352.346,231.706l7.955-0.378c2.06-0.099,3.976-0.979,5.394-2.48l8.351-8.842c2.28-2.414,2.815-6.032,1.329-9.003 l-5.843-11.564l12.973-7.983c1.674-1.03,2.901-2.637,3.456-4.521l5.253-17.86c1.133-3.855-0.797-7.955-4.49-9.538l-7.879-3.326 l1.049-6.1l9.008-3.793c2.151-0.904,3.788-2.7,4.491-4.927l1.269-4.014l10.367,12.253c1.516,1.791,3.712,2.818,6.026,2.818 c4.398,0,7.976-3.565,7.976-7.948l-0.001-13.994l-0.322-15.146c-0.214-10.079-8.578-18.279-18.645-18.279 c-0.747,0-1.504,0.045-2.25,0.135l-77.435,9.292l0.531-1.442c0.876-2.378,0.558-5.056-0.852-7.161 c-1.409-2.106-3.763-3.422-6.294-3.519l-9.848-0.379c-2.599-0.09-5.105,1.101-6.658,3.17l-24.181,32.253l-21.325,10.69 l-17.579-9.057c-1.12-0.576-2.376-0.881-3.634-0.881c-2.187,0-4.3,0.915-5.794,2.51l-16.302,17.388 c-2.068,2.206-2.704,5.34-1.658,8.177l2.943,7.884l-10.435,9.887l-9.946,5.759c-2.84,1.645-4.361,4.805-3.873,8.051l0.831,5.539 c0.578,3.856,3.955,6.766,7.854,6.765c1.125,0,2.221-0.236,3.257-0.702l8.502-3.827l10.604-4.494l10.86,7.602 c0.921,0.646,1.948,1.081,3.047,1.292l16.603,3.165v4.104l-34.356-5.153c-1.383-0.212-2.799-0.047-4.097,0.466l-22.403,8.843 c-2.456,0.97-4.263,3.087-4.835,5.664l-4.38,19.712c-0.621,2.791,0.314,5.713,2.439,7.624l10.325,9.294 c1.665,1.498,3.893,2.222,6.122,1.996l19.936-2.109l0.574,29.839c0.014,0.731,0.129,1.455,0.34,2.151l3.636,12 c2.232,7.368,8.905,12.318,16.604,12.318c6.49,0,12.385-3.575,15.385-9.33l27.542-52.836c1.64-3.145,0.978-7.037-1.61-9.464 l-3.589-3.364l5.584-1.861c2.629-0.877,4.58-3.012,5.216-5.709c0.637-2.697-0.153-5.479-2.113-7.438l-8.196-8.117l0.544-0.688 l17.154,11.061l13.818,19.96c1.483,2.143,3.921,3.421,6.523,3.421c2.989,0,5.696-1.649,7.064-4.304l6.159-12.105l13.825,9.823 c1.362,0.968,2.948,1.48,4.585,1.48c2.357-0.001,4.585-1.043,6.114-2.861c1.498-1.781,2.126-4.133,1.723-6.452L352.346,231.706z M245.226,298.895c-1.617,3.102-4.794,5.028-8.292,5.028c-4.149,0-7.745-2.668-8.948-6.639l-3.633-11.983l-0.574-29.84 c-0.042-2.214-1.017-4.325-2.675-5.793c-1.657-1.468-3.87-2.173-6.074-1.954l-19.956,2.067l-10.306-9.235l4.344-19.671 l22.372-8.839l37.33,5.6l14.892,19.379c0.341,0.455,9.062,9.044,9.062,9.044L245.226,298.895z M346.147,226.682 c-1.423,1.776-2.016,4.082-1.626,6.325l0.235,1.358l-13.705-9.738c-1.352-0.96-2.94-1.468-4.593-1.468 c-2.99,0-5.697,1.649-7.064,4.305l-6.182,12.064l-13.78-19.905c-0.596-0.86-1.344-1.584-2.225-2.152l-17.17-11.078 c-1.286-0.83-2.774-1.269-4.304-1.269c-2.267,0-4.43,0.972-5.936,2.665l-0.622,0.699c-2.789,3.138-2.648,7.921,0.32,10.89 l8.13,8.131l-9.099,3.075l-13.497-17.975v-7.436c0-3.795-2.704-7.073-6.431-7.796l-16.629-3.214l-10.862-7.603 c-2.212-1.549-5.144-1.863-7.636-0.814l-10.75,4.528l-8.507,3.911l-0.86-5.479l9.938-5.755c0.535-0.308,1.035-0.681,1.49-1.111 l10.445-9.895c2.309-2.186,3.09-5.527,1.991-8.511l-2.941-7.887l16.231-17.376l17.579,9.057c1.119,0.576,2.376,0.881,3.635,0.881 c1.226,0,2.453-0.29,3.551-0.838l21.385-10.692c1.095-0.55,2.061-1.356,2.796-2.335L303.607,102l9.794,0.3l-0.565,1.533 c-0.897,2.435-0.548,5.157,0.934,7.283c1.668,2.391,4.475,3.705,7.462,3.346l77.533-9.304c0.431-0.052,0.868-0.078,1.297-0.078 c5.748,0,10.524,4.688,10.647,10.449l0.321,15.062l-0.002,13.745l-10.33-12.209c-1.512-1.788-3.716-2.814-6.046-2.814 c-3.49,0-6.539,2.23-7.587,5.551l-1.267,4.08l-9.009,3.793c-2.497,1.052-4.268,3.271-4.738,5.938l-1.085,6.144 c-0.644,3.648,1.285,7.217,4.692,8.679l7.88,3.319l-5.228,17.826l-12.972,7.983c-3.531,2.172-4.794,6.606-2.94,10.313l5.831,11.574 l-8.311,8.824l-7.955,0.378C349.691,223.824,347.571,224.906,346.147,226.682z"/> <path d="M422.31,296.3l-9.319-17.706c-1.377-2.616-4.071-4.241-7.03-4.241c-2.629,0-5.073,1.293-6.558,3.468l-2.432-3.04 c-1.515-1.894-3.775-2.979-6.202-2.979c-1.437,0-2.849,0.391-4.083,1.132l-22.045,13.227c-2.104,1.261-3.526,3.47-3.805,5.907 l-1.877,16.424c-0.256,2.246,0.459,4.5,1.962,6.185c1.726,1.935,4.28,2.921,6.912,2.594l18.67-2.377l2.958,7.025 c1.242,2.952,4.114,4.859,7.316,4.859c0,0,0,0,0.001,0c0.455,0,0.913-0.04,1.362-0.118l10.25-1.782 c2.514-0.435,4.678-2.068,5.79-4.365l8.253-17.056C423.524,301.198,423.479,298.522,422.31,296.3z M407.02,316.996l-10.205,1.774 l-2.939-6.982c-1.243-2.951-4.115-4.858-7.317-4.858c-0.326,0-0.656,0.02-0.986,0.062l-18.665,2.407l1.849-16.379l21.969-13.242 l2.483,3.104c1.515,1.894,3.774,2.979,6.198,2.979c2.627,0,5.065-1.286,6.553-3.453l9.272,17.564L407.02,316.996z"/> <path d="M153.469,265.01l-37.698-24.424c-2.067-1.339-4.459-2.047-6.916-2.047c-3.966,0-7.648,1.844-10.051,4.947l-8.455-4.733 l-15.1-21.496h7.702c1.836,0,3.627-0.642,5.043-1.807l28.637-23.547l15.938-9.032c1.94-1.1,3.336-2.977,3.829-5.151 c0.494-2.175,0.045-4.471-1.231-6.301l-14.111-20.227c-1.531-2.193-4.057-3.468-6.713-3.395c-2.673,0.067-5.115,1.462-6.532,3.729 l-7.273,11.782l-8.339-9.378l16.573-12.187c3.068-2.257,4.102-6.388,2.459-9.822l-4.086-8.545 c-0.953-1.992-2.709-3.509-4.818-4.161c-2.11-0.653-4.415-0.391-6.323,0.715l-7.224,4.21l-32.646-13.813L32.686,97.102 c-2.844-1.604-6.443-1.283-8.957,0.795L11.31,108.156c-1.091,0.901-1.923,2.08-2.405,3.408l-8.429,23.181 c-0.871,2.393-0.534,5.079,0.9,7.185c1.435,2.105,3.811,3.4,6.358,3.467l17.89,0.422l11.355,28.074l-1.854,27.803 c-0.112,1.684,0.327,3.394,1.238,4.814l15.267,23.815c0.919,1.435,2.248,2.517,3.845,3.131l29.367,11.24 c0.266,0.254,0.562,0.465,0.876,0.633l8.586,4.807l-4.611,6.916c-1.646,2.469-1.782,5.619-0.355,8.222l9.663,17.604l-1.26,42.85 c-0.054,1.834,0.534,3.643,1.658,5.096l7.795,10.067c1.52,1.963,3.793,3.089,6.239,3.089c2.157,0,4.255-0.882,5.756-2.419 c1.485-1.521,2.274-3.552,2.222-5.719l-0.358-14.23l29.281-28.035c1.052-1.008,1.806-2.283,2.18-3.689l4.311-16.166 C157.713,270.388,156.365,266.888,153.469,265.01z M58.366,226.008l-15.258-23.78l1.854-27.803c0.079-1.189-0.115-2.4-0.561-3.504 l-11.36-28.102c-1.187-2.933-3.997-4.88-7.158-4.961L8.022,137.4l8.382-23.076l12.352-10.253l23.448,13.227 c0.265,0.149,0.538,0.283,0.807,0.396l32.653,13.815c2.281,0.964,4.924,0.798,7.07-0.441l7.194-4.239l4.105,8.471l-16.574,12.186 c-1.79,1.316-2.953,3.337-3.191,5.545s0.467,4.431,1.934,6.098l8.33,9.466c1.674,1.902,4.082,2.879,6.607,2.668 c2.525-0.206,4.744-1.557,6.087-3.705l7.321-11.713l14.079,20.065l-15.932,9.029c-0.394,0.222-0.773,0.482-1.134,0.777 l-28.608,23.54c0,0-8.894,0.001-8.941,0.002c-2.709,0.042-5.164,1.583-6.407,4.021c-1.277,2.505-1.072,5.482,0.536,7.771 l8.353,11.891L58.366,226.008z M144.799,287.798l-29.28,28.034c-1.608,1.54-2.5,3.699-2.447,5.924l0.333,14.091l-7.669-9.884 l1.26-42.851c0.041-1.412-0.295-2.813-0.975-4.051l-9.673-17.572l8.563-12.843c0.879-1.32,2.354-2.107,3.944-2.107 c0.91,0,1.797,0.263,2.566,0.762l37.673,24.358L144.799,287.798z"/> <path d="M136.06,107.943l4.304,3.261v39.436c0,4.382,3.567,7.947,7.951,7.947c1.535,0,3.034-0.45,4.335-1.302l27.258-17.822 c1.707-1.116,2.906-2.823,3.378-4.806l9.091-38.182c0.678-2.85-0.261-5.828-2.45-7.773l-8.403-7.47 c-2.229-1.982-5.52-2.545-8.282-1.414l-35.365,14.468c-2.666,1.09-4.485,3.446-4.865,6.301 C132.632,103.442,133.771,106.192,136.06,107.943z M176.209,87.212l8.384,7.411l-9.065,38.146l-27.165,17.76v-39.324 c0-2.458-1.165-4.816-3.117-6.308l-4.244-3.245L176.209,87.212z"/> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
				htp.p('</span>');
				htp.p('<span class="icons '||ws_class_span||'" title="ponteiro" data-tipo="PONTEIRO">');
					htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve"> <g> <g> <g> <path d="M366.292,215.99L241.417,325.781c-0.167,0.146-0.333,0.292-0.479,0.448c-4.042,4.021-6.271,9.385-6.271,15.104 c0,11.76,9.563,21.333,21.333,21.333c5.667,0,11.021-2.208,15.563-6.75l109.792-124.875c3.708-4.219,3.5-10.604-0.479-14.583 C376.896,212.49,370.542,212.281,366.292,215.99z"/> <path d="M256,85.333c-141.167,0-256,114.844-256,256c0,26.479,4.104,52.688,12.167,77.917c1.417,4.417,5.521,7.417,10.167,7.417 h467.333c4.646,0,8.75-3,10.167-7.417C507.896,394.021,512,367.813,512,341.333C512,200.177,397.167,85.333,256,85.333z M458.667,352h31.26c-0.824,18.04-3.237,35.947-8.177,53.333H30.25c-4.94-17.387-7.353-35.293-8.177-53.333h31.26 C59.229,352,64,347.229,64,341.333c0-5.896-4.771-10.667-10.667-10.667h-31.46c1.581-34.919,10.68-67.865,25.948-97.208 l27.324,15.781c1.688,0.969,3.521,1.427,5.333,1.427c3.667,0,7.271-1.906,9.229-5.333c2.958-5.104,1.208-11.625-3.896-14.573 l-27.263-15.746c18.323-28.539,42.602-52.816,71.142-71.138l15.746,27.28c1.958,3.417,5.563,5.333,9.229,5.333 c1.813,0,3.646-0.458,5.333-1.427c5.104-2.948,6.854-9.469,3.896-14.573l-15.777-27.332c29.345-15.27,62.293-24.37,97.215-25.951 v31.46c0,5.896,4.771,10.667,10.667,10.667s10.667-4.771,10.667-10.667v-31.46c34.922,1.581,67.87,10.681,97.215,25.951 l-15.777,27.332c-2.958,5.104-1.208,11.625,3.896,14.573c1.688,0.969,3.521,1.427,5.333,1.427c3.667,0,7.271-1.917,9.229-5.333 l15.746-27.28c28.54,18.322,52.819,42.599,71.142,71.138l-27.263,15.746c-5.104,2.948-6.854,9.469-3.896,14.573 c1.958,3.427,5.563,5.333,9.229,5.333c1.812,0,3.646-0.458,5.333-1.427l27.324-15.781c15.268,29.344,24.367,62.289,25.948,97.208 h-31.46c-5.896,0-10.667,4.771-10.667,10.667C448,347.229,452.771,352,458.667,352z"/> </g> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
				htp.p('</span>');
				--
				if ws_pode_anotar = 'S' then 
					htp.p('<span id="id_atalho_anotar" class="icons '||ws_class_span||'"" title="Anota&ccedil;&atilde;o" data-tipo="ANOTACAO">');
				    --	htp.p('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 26 26" xml:space="preserve"><path d="M4 22v-20h16v11.543c0 4.107-6 2.457-6 2.457s1.518 6-2.638 6h-7.362zm18-7.614v-14.386h-20v24h10.189c3.163 0 9.811-7.223 9.811-9.614zm-5-1.386h-10v-1h10v1zm0-4h-10v1h10v-1zm0-3h-10v1h10v-1z"/></svg>');
					htp.p('<svg version="1.1" id="Camada_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 600 600" style="enable-background:new 0 0 600 600;" xml:space="preserve"> <g>
							<path d="M99.4,3.6c-31.9,32-63.8,63.9-95.8,95.8c-1,1-2.4,1.7-3.6,2.5c0,166,0,332,0,498c149.8,0,299.3,0,448.8,0 c0-200,0-400,0-600C333.2,0,217.6,0,102,0C101.1,1.2,100.4,2.6,99.4,3.6z M114.6,9.5C221,9.4,327.4,9.4,433.8,9.4 c0.8,0,1.6,0.1,3,0.2c0,193.7,0,386.9,0,580.6c-142.6,0-285.2,0-428.6,0c0-1.9,0-3.9,0-6c0-155.6,0-311.2-0.1-466.9 c0-3.8,1-6.5,3.7-9.2C43.7,76.5,75.4,44.7,107.3,13C109.1,11.2,112.1,9.5,114.6,9.5z"/>
							<path d="M480.6,75c0,2.8,0,4.9,0,7c0,151.3,0,302.7,0.2,454c0,3.3,1.5,7.3,3.6,9.8c15.3,18.2,30.9,36.2,46.4,54.3 c6.2,0,12.5,0,18.8,0c14.7-17,29.4-34.1,44.2-51.1c1.9-2.2,4.1-4.2,6.2-6.3c0-155.9,0-311.7,0-467.6C560.4,75,520.8,75,480.6,75z M580.6,545.9c-11.9,14.7-24.5,28.8-36.9,43c-1,1.1-2.2,2.1-3.7,3.4c-13.6-16-26.2-32.4-40.6-47c-7-7.1-7.3-14.1-7.3-22.5 c0.1-142.5,0-285.1,0-427.6c0-2.5,0-5.1,0-8c32,0,63.7,0,96.3,0c0,1.9,0,4,0,6c0,146.6,0,293.3,0.1,439.9 C588.6,539.5,583.6,542.1,580.6,545.9z"/>
							<path d="M34.9,576.6c126.4,0,252.7,0,379.1,0c7.2,0,11.4-4.1,11.4-11.3c0-8,0-16,0-24c0-168.7,0-337.5,0-506.2 c0-7.1-4.1-11.5-10.6-11.5c-90.6,0-181.2,0-271.9,0c-6.2,0-10.5,4.5-10.5,11c0,30.3,0,60.5,0,90.8c0,2.1,0,4.2,0,7.2 c-2.9,0-5,0-7.1,0c-30.1,0-60.2,0-90.2,0c-7.7,0-11.6,4-11.6,11.7c0,140.2,0,280.4,0,420.7C23.4,572.5,27.4,576.6,34.9,576.6z M35.5,144.1c35.9,0,71.7,0,108.1,0c0-36.5,0-72.3,0-108.5c90.2,0,179.7,0,269.6,0c0,176.1,0,352.3,0,529.1c-126,0-251.7,0-377.7,0 C35.5,424.5,35.5,284.6,35.5,144.1z"/>
							<path d="M46.1,119.7c20.9-0.3,41.7-0.1,62.6-0.1c6.7,0,10.9-4.3,10.9-11.2c0-10.3,0-20.7,0-31s-0.4-20.7,0.2-31 c0.3-5.6-3-9.3-6.6-10.5c-4.2-1.4-9.9-2.5-14.1,1.7C78.4,58.1,57.7,78.5,37.6,99.5c-2.6,2.7-3,9.3-1.9,13.4 C36.8,116.5,40.5,119.8,46.1,119.7z M108.5,48c0,18.7,0,39.4,0,60.4c-21,0-41.8,0-60.4,0C67.8,88.6,88.6,67.8,108.5,48z"/>
							<path d="M565.6,181.6c-16.6,0-33.2,0-49.8,0c-6.4,0-10.7,4.4-10.7,10.8c0,84.2,0,168.3,0,252.5c0,6.5,4.3,10.8,10.7,10.8 c16.4,0,32.8,0,49.2,0c7.6,0,11.6-4,11.6-11.7c0-41.6,0-83.2,0-124.8c0-42.2,0-84.4,0-126.5C576.6,185.9,572.3,181.7,565.6,181.6z M564.5,443.8c-16,0-31.9,0-48.3,0c0-83.7,0-167.2,0-251.3c16.4,0,32.1,0,48.3,0C564.5,276.3,564.5,359.9,564.5,443.8z"/>
							<path d="M567,468.8c-17.4-0.1-34.7-0.1-52.1,0c-5.1,0-9.7,4.8-9.8,10c-0.1,8.6,0,17.2,0,25.8c0,8.8-0.2,17.6,0.1,26.3 c0.1,2.4,1.3,5.1,2.9,7c6.4,7.9,13.3,15.4,19.7,23.4c6.2,7.8,16.5,8.7,23.3,1.4c6.1-6.5,12-13.1,17.6-20c3-3.7,7.3-8,7.5-12.2 c0.8-17.3,0.4-34.7,0.3-52.1C576.5,473.6,571.7,468.8,567,468.8z M563.9,528.2c-3.3,8.8-12.2,15.4-18.6,23c-1.5,1.7-3,3.4-5,5.6 c-7.9-9.1-15.6-17.9-23.1-26.8c-0.8-0.9-1.3-2.5-1.3-3.7c-0.1-15.4-0.1-30.8-0.1-46.6c16.4,0,32.3,0,49,0c0,6.2,0,12.6,0,18.9 C564.8,508.6,567.2,519.5,563.9,528.2z"/>
							<path d="M515.6,168.7c8.4,0,16.8,0,25.2,0c8.6,0,17.2,0,25.8,0c5.2,0,9.9-4.7,9.9-9.8c0.1-16.4,0-32.8,0-49.2 c0-5.6-4.6-10.1-10.2-10.1c-17,0-34,0-51,0c-5.6,0-10.2,4.5-10.2,10.1c0,16.2,0,32.4,0,48.6C505.1,164.3,509.6,168.7,515.6,168.7z M516.1,110.6c16,0,31.9,0,48.5,0c0,15.3,0,30.5,0,46.1c-16.1,0-32.1,0-48.5,0C516.1,141.4,516.1,126.2,516.1,110.6z"/>
							<path d="M340.4,216.1c-77.6,0-154.7,0-232,0c0,11.7,0,22.9,0,34.4c77.5,0,154.6,0,232,0C340.4,238.8,340.4,227.4,340.4,216.1z M329,239.9c-69.7,0-139.1,0-209,0c0-3.9,0-7.9,0-12.2c69.5,0,139,0,209,0C329,232,329,235.8,329,239.9z"/>
							<path d="M108.4,401.7c77.6,0,154.7,0,231.9,0c0-11.7,0-22.9,0-34.4c-77.5,0-154.5,0-231.9,0C108.4,379.2,108.4,390.5,108.4,401.7z M119.8,378.8c69.7,0,139.1,0,209,0c0,3.9,0,7.8,0,12.2c-69.5,0-139,0-209,0C119.8,386.7,119.8,382.9,119.8,378.8z"/>
							<path d="M108.5,477.9c77.4,0,154.3,0,231.8,0c0-11.9,0-23.3,0-34.6c-77.5,0-154.6,0-231.8,0C108.5,455,108.5,466.3,108.5,477.9z M119.8,453.8c69.8,0,139.4,0,209.2,0c0,4.1,0,7.9,0,12.2c-69.6,0-139.2,0-209.2,0C119.8,461.8,119.8,458,119.8,453.8z"/>
							<path d="M108.3,326.2c77.7,0,154.8,0,232.1,0c0-11.7,0-22.9,0-34.3c-77.5,0-154.7,0-232.1,0C108.3,303.5,108.3,314.5,108.3,326.2z M119.8,302.6c69.7,0,139.1,0,209,0c0,3.9,0,7.8,0,12.2c-69.4,0-139,0-209,0C119.8,310.6,119.8,306.7,119.8,302.6z"/>
						</g>
						</svg>'); 
					htp.p('</span>');
				end if; 	
			htp.p('</li>');

			htp.p('<li id="quick-obj" class="quick-closed" data-tipo="" data-visao="" data-grupo="" colspan="9">');
				if gbl.getNivel = 'A' then
					htp.p('<input placeholder="NOME DO NOVO OBJETO">');
				else
					htp.p('<input type="hidden" placeholder="NOME DO NOVO OBJETO" value="OBJETO">');
				end if;
				htp.p('<select id="quick-coluna">');
					htp.p('<option selected="true" disabled="true" value="">COLUNAS</option>');
					
					--ws_colunas := fun.check_rotuloc(prm_colunas, prm_visao);
					for i in(select column_value from table(fun.vpipe((prm_colunas)))) loop
						htp.p('<option value="'||i.column_value||'">'||fun.check_rotuloc(i.column_value, prm_visao)||'</option>');
					end loop;
				htp.p('</select>');
				htp.p('<a id="confirm-tag" class="addpurple">+</a>');
			htp.p('</li>');

			if ws_pode_anotar = 'S' then 
				fcl.anotacao_texto ( 'TEXTO', ws_objeto, prm_screen, ws_usuario, prm_coluna, prm_condicao, ws_usua_perm, ws_anot_texto);
				if ws_anot_texto is null then 
					ws_ds_usua_perm := 'TODOS';
				else 
					ws_ds_usua_perm := '';
					for x in (select * from table (fun.vpipe(ws_usua_perm))) loop  
						select max(nvl(decode(usu_nome,'DWU','TODOS',usu_completo),usu_nome)) into ws_ds_aux from usuarios where usu_nome = x.column_value;
						if ws_ds_aux is null then 
							select max(nvl(nm_group,cd_group)) into ws_ds_aux from gusers where cd_group = x.column_value;
						end if; 
						if ws_ds_aux is not null then 
							ws_ds_usua_perm := ws_ds_usua_perm||ws_ds_aux||', ';
						end if; 	
					end loop; 	
					ws_ds_usua_perm :=  substr(ws_ds_usua_perm,1,length(ws_ds_usua_perm)-2); 
				end if; 	
			end if; 	

			htp.p('<li id="quick-anotacao" class="quick-closed-anot" data-tipo="" data-visao="" data-grupo="" colspan="9">');
				--htp.p('<input type="text" disabled="true" title="Usu&aacute;rio da anota&ccedil;&atilde;o" value="'||ws_usuario||'">');
				htp.p('<input id="nm_usuario" type="hidden" disabled="true" value="'||ws_usuario||'">');
				htp.p('<label>Usu&aacute;rios Permiss&atilde;o</label>'); 

				fcl.fakeoption('fake-usuario-permissao', ws_ds_usua_perm, ws_usua_perm, 'lista-usuario-grupo', 'N', 'S', '', '', prm_desc => ws_ds_usua_perm, prm_min => 1);

				htp.p('<textarea id="quick-anotacao-texto" title="" placeholder="'||fun.lang('ANOTA&Ccedil;&Atilde;O')||'">'||ws_anot_texto);
				htp.p('</textarea>');
				htp.p('<span id="botoes-confirm">');
					htp.p('<a id="confirm-tag-anot-add" title="Gravar anota&ccedil;&atilde;o" class="addpurple">+</a>');
					htp.p('<a id="confirm-tag-anot-del" title="Excluir anota&ccedil;&atilde;o" class="addpurple">-</a>');
				htp.p('</span>');
			htp.p('</li>');


		htp.p('</ul>');

	htp.prn('</div>');

end jumpdrill;

procedure jumpmed ( prm_coluna varchar2 default null,
					prm_visao  varchar2 default null, 
					prm_objeto varchar2 default null ) as

begin

	fcl.fakeoption('ID_'||prm_coluna, 'colunas dispon&iacute;veis', '', 'lista-jumpmed', 'N', 'N', prm_visao, '', prm_objeto);

end;

procedure listaCustomizado ( prm_usuario  varchar2 default null ) as
		

begin

	htp.p('<table class="linha">');

		htp.p('<thead>');
			htp.p('<tr>');
				htp.p('<th>VIEW</th>');
				htp.p('<th>'||fun.lang('COLUNA')||'</th>');
				htp.p('<th></th>');
			htp.p('</tr>');
		htp.p('</thead>');

		htp.p('<tbody id="ajax" >');

			for i in (select cd_custom, nm_visao, nm_coluna from bi_custom_permissao where nm_usuario = prm_usuario) loop
				htp.p('<tr>');
					htp.p('<td>'||i.nm_visao||'</td>');
					htp.p('<td>'||i.nm_coluna||'</td>');
					htp.p('<td>');
						fcl.button_lixo('deletaCustomizado','prm_chave', i.cd_custom, '', prm_tag => 'a');
					htp.p('</td>');
				htp.p('</tr>');
			end loop;

		htp.p('</tbody>');
	htp.p('</table>');

	htp.p('<div class="listar"><a title="'||fun.lang('ir para a lista de usu&aacute;rios')||'" onclick="carregaPainel(''usuarios''); carrega(''list_users''); call_save(''''); document.getElementById(''titulo'').innerHTML = '''||fun.lang('USU&Aacute;RIOS')||''';">'||fun.lang('Listar usu&aacute;rios')||'</a></div>');

end listaCustomizado;

procedure addCustomizado ( prm_usuario  varchar2 default null,
						prm_visao    varchar2 default null,
						prm_colunas  varchar2 default null ) as

	ws_count number := 0;

begin

	insert into bi_custom_permissao (cd_custom, nm_usuario, nm_visao, nm_coluna) 
	select rownum+nvl((select max(cd_custom) from bi_custom_permissao), 0), prm_usuario, prm_visao, column_value from table(fun.vpipe(prm_colunas));

	ws_count := sql%rowcount;


	if ws_count > 0 then	
		commit;
		htp.p('ADICIONADO COM SUCESSO');
	else
		rollback;
		htp.p('ERRO AO ADICIONAR');
	end if;

exception when others then
	htp.p('ERRO AO ADICIONAR');
end addCustomizado;

procedure deletaCustomizado ( prm_chave  number ) as

	ws_count number := 0;

begin

	delete from bi_custom_permissao where cd_custom = prm_chave;

	ws_count := sql%rowcount;

	if ws_count > 0 then
		htp.p('EXCLUIDO COM SUCESSO');
	else
		htp.p('ERRO AO EXCLUIR');
	end if;	

	commit;
exception when others then
	htp.p('ERRO AO EXCLUIR');
end deletaCustomizado;


procedure geraCustomizado( prm_objeto       varchar2 default null,
						prm_visao        varchar2 default null,
						prm_coluna_agrup varchar2 default null,
						prm_coluna_valor varchar2 default null,
						prm_coluna_pivot varchar2 default null,
						prm_coluna_tipo  varchar2 default null,
						prm_limite       varchar2 default null,
						filtropipe       varchar2 default null,
						prm_tipo         varchar2 default 'show',
						prm_desc         varchar2 default null ) as
begin
	obj.show_objeto(prm_objeto => prm_objeto, prm_posx => '1', prm_posy => '', prm_drill => 'C', prm_zindex => '', prm_screen => 'SCR_CUSTOMIZACAO', prm_dashboard => 'true');	
exception when others then
htp.p(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
end geraCustomizado;

/***** 
procedure adicionaCustomizado ( prm_objeto  varchar2 default null ) as
	ws_codigo   	varchar2(200); 
	ws_usuario  	varchar2(200); 
	ws_grupo    	varchar2(20);
	ws_nome_custom 	varchar2(100); 
	ws_nome     	varchar2(100); 	
	ws_alterar_nome exception;
begin

	ws_usuario     := gbl.getUsuario;
	ws_grupo       :='';
	ws_nome_custom := 'CONSULTA ATUAL'; 

	select max(nm_objeto) into ws_nome 
	from objetos where cd_objeto = prm_objeto;

	if ws_nome = ws_nome_custom then 
	raise ws_alterar_nome;
	end if; 

	Select 'COBJ_'||trim((Select Sid From V$session Where Audsid = Sys_Context('userenv','sessionid'))||
		(Select Serial# From V$session Where Audsid = Sys_Context('userenv','sessionid'))||to_char(sysdate,'yymmddhhmiss')) 
	into ws_codigo 
	From Dual;

	update call_list          set cd_objeto = ws_codigo     where cd_objeto = prm_objeto;    -- Substitui o nome padrão de objeto customizado para um novo nome de objeto de sistema 
	update filtros            set cd_objeto = ws_codigo     where cd_objeto = prm_objeto;
	update destaque           set cd_objeto = ws_codigo     where cd_objeto = prm_objeto;
	update goto_objeto        set cd_objeto = ws_codigo     where cd_objeto = prm_objeto;
	update objetos            set cd_objeto = ws_codigo     where cd_objeto = prm_objeto;
	update object_location    set object_id = ws_codigo     where object_id = prm_objeto;
	update object_restriction set cd_objeto = ws_codigo     where cd_objeto = prm_objeto;
	update object_attrib      set cd_object = ws_codigo     where cd_object = prm_objeto;
	update ponto_avaliacao    set cd_ponto  = ws_codigo     where cd_ponto  = prm_objeto;


	insert into OBJETOS (cd_objeto, cd_grupo, nm_objeto, subtitulo, tp_objeto, cd_usuario, atributos, dt_ultima, ds_objeto)  -- Cria novamente o objeto customizadao do usuário 
	values (prm_objeto, ws_grupo, ws_nome_custom, '', 'CONSULTA', ws_usuario, '', sysdate, ''); 

	htp.p('ok|'||to_char(ws_codigo)||'|'||ws_nome);

exception 
	when ws_alterar_nome then
		rollback;
		htp.p('Para salvar a consulta &eacute; necess&aacute;rio definir um nome/t&iacutetulo diferente de CONSULTA ATUAL');
	
	when others then
		rollback;
		htp.p('Ocorreu um erro ao salvar a consulta, tente novamente ou contate o administrador');
		if gbl.getNivel = 'A' then 
		htp.p(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
		end if; 
end adicionaCustomizado;
****/ 



procedure conteudoCustomizado as 
	ws_usuario       varchar2(500); 
begin
	ws_usuario := gbl.getUsuario; 

	htp.p('<section id="SECTION_CUSTOMIZACAO">');
		htp.p('<div id="painel">');
			htp.p('<h4>CONSULTA CUSTOMIZADA</h4>');
			htp.p('<a class="script" onclick="restoreCustom(this);"></a>');
			fcl.fakeoption('lista-custom-fav', fun.lang('Consultas criadas'), '', 'lista-custom-fav', 'N', 'N', ''  );
			htp.p('<a class="addpurple" onclick="nova_customizada(this);">NOVA</a>');    -- class="addpurple" 
			/* htp.p('<a class="addpurple" onclick="salva_customizada(this);">SALVAR CONSULTA</a>'); */ 
			htp.p('<a class="addpurple" onclick="exclui_customizada(this);">EXCLUIR</a>');		
		htp.p('</div>');
		htp.p('<div id="ARTICLE_CUSTOMIZACAO">'); 
		htp.p('</div>');
	htp.p('</section>');		
end conteudoCustomizado;


procedure excluiCustomizado ( prm_objeto  varchar2,
							prm_tela    varchar2 ) as 
	ws_usuario  	varchar2(200); 
	ws_count 		number := 0;
	ws_nouser  		exception; 
	ws_error		exception;
	ws_error_tela	exception;	
begin
	
	ws_usuario  := gbl.getUsuario;
	if ws_usuario = 'NOUSER' then
		raise ws_nouser;
	end if;

	-- Verifica se já está sendo utilizando em outra tela, caso contrário pode excluir o objeto sem verificar 
	select count(*) into ws_count
	from object_location  
	where object_id  = prm_objeto
	and screen     <> prm_tela ;
	if ws_count > 0 then 
		raise ws_error_tela; 
	end if;    

	begin 
		dl_object (prm_objeto) ;   -- Exclui todas as tabelas de cadastro do objeto (já tem um commit dentro dessa procedure)
	exception when others then
		raise ws_error;
	end;

	commit; 
	htp.p('OK');

exception 
	when ws_nouser then
		htp.p('Sem permiss&atilde;o!');
	when ws_error_tela then
		rollback;
		htp.p('Consulta est&aacute; sendo utilizada em outras telas, solicite ao administrador do sistema a retirada da consulta das outras telas para possibilitar a exclus&atilde;o');
	when ws_error then
		rollback;
		htp.p('N&atilde;o foi poss&iacute;vel excluir consulta');
		if gbl.getNivel = 'A' then 
		htp.p('FAIL '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
		end if;   
	when others then
		rollback;
		htp.p('N&atilde;o foi poss&iacute;vel excluir consulta');
		if gbl.getNivel = 'A' then 
		htp.p('FAIL '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
		end if;   

end excluiCustomizado;


procedure subparReal ( prm_texto  varchar2 default null,
					prm_screen varchar2 default null ) as

begin

	htp.p(fun.subpar(prm_texto, prm_screen));

end subparReal;

procedure fakeCustom ( prm_tipo   varchar2 default null,
					prm_search varchar2 default null,
					prm_extend varchar2 default null ) as

begin

	case prm_tipo
		
		when 'search' then
			
			htp.p('<li class="custom">');
				htp.p('<input type="text" maxlength="80" placeholder="'||fun.lang('BUSCAR')||'" value="'||prm_search||'" />');
				htp.p('<a title="search" class="search '||prm_extend||'"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="485.213px" height="485.213px" viewBox="0 0 485.213 485.213" style="enable-background:new 0 0 485.213 485.213;" xml:space="preserve"> <g> 	<g> 		<path d="M363.909,181.955C363.909,81.473,282.44,0,181.956,0C81.474,0,0.001,81.473,0.001,181.955s81.473,181.951,181.955,181.951 			C282.44,363.906,363.909,282.437,363.909,181.955z M181.956,318.416c-75.252,0-136.465-61.208-136.465-136.46 			c0-75.252,61.213-136.465,136.465-136.465c75.25,0,136.468,61.213,136.468,136.465 			C318.424,257.208,257.206,318.416,181.956,318.416z"></path> 		<path d="M471.882,407.567L360.567,296.243c-16.586,25.795-38.536,47.734-64.331,64.321l111.324,111.324 			c17.772,17.768,46.587,17.768,64.321,0C489.654,454.149,489.654,425.334,471.882,407.567z"></path> 	</g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg></a>');
			htp.p('</li>');

		when 'add' then
			
			htp.p('<li class="custom">');
				--htp.p('<input type="text" maxlength="200" placeholder="'||fun.lang('INSERIR VALOR')||'" value="'||prm_search||'" />');
				if prm_search is not null then 
					htp.p('<input type="text" maxlength="200" placeholder="'||prm_search||'" value="'||prm_search||'" />');
				else 
					htp.p('<input type="text" maxlength="200" placeholder="'||fun.lang('INSERIR VALOR')||'" value="" />');
				end if; 	
				htp.p('<a title="add" class="add '||prm_extend||'">+</a>');
			htp.p('</li>');

	end case;

end fakeCustom;



---------------------------------------------------------------------------------------------------------------------------------------------------------
-------- Monta a tela de Auto update  
---------------------------------------------------------------------------------------------------------------------------------------------------------
procedure autoUpdate_tela as

	ws_versao     		  varchar2(20);

	cursor c_obj is  
		select min(sq_atualizacao) sq_atualizacao, cd_versao,
			decode(substr(tp_objeto,1,7),'PACKAGE','PACKAGE',tp_objeto) tp_objeto, 
			DECODE(tp_objeto,'PROGRAMA','TODOS', 'VISUAL','TODOS', 'IMAGEM','TODOS', 'MARCADORES','TODOS', nm_objeto) nm_objeto,
			DECODE(tp_objeto,'PROGRAMA','TODOS', 'VISUAL','TODOS', 'IMAGEM','TODOS', 'MARCADORES','TODOS', ds_objeto) ds_objeto,
			sum(qt_registros)  qt_registros, 
			max(dt_versao_upquery) dt_versao_upquery_max,
			max(dt_versao_baixa)   dt_versao_baixa_max,
			max(dt_versao_sistema) dt_versao_sistema_max, 
			min(dt_versao_baixa)   dt_versao_baixa_min,
			min(dt_versao_sistema) dt_versao_sistema_min, 
			sum(dt_versao_upquery-dt_versao_baixa)   qt_pend_baixa,    
			sum(dt_versao_upquery-dt_versao_sistema) qt_pend_sistema,    
			--max(nvl(dt_versao_upquery, to_date('01/01/1000','DD/MM/YYYY'))) dt_versao_upquery,
			--min(nvl(dt_versao_baixa  , to_date('01/01/1000','DD/MM/YYYY'))) dt_versao_baixa,
			--min(nvl(dt_versao_sistema, to_date('01/01/1000','DD/MM/YYYY'))) dt_versao_sistema, 
			substr(min(decode(id_situacao,  'INVALIDO',  '1-'||id_situacao, 
											'BLOQUEADO', '3-'||id_situacao, 
											'ERRO',      '2-'||id_situacao, 
											'PENDENTE',  '4-'||id_situacao, 
											'5-'||id_situacao)), 3,20) id_situacao 
		from bi_auto_update 
		where id_situacao <> 'BLOQUEADO'
		and replace(cd_versao,'.','') >= replace(ws_versao,'.','')   
		-- AND tp_objeto not like 'MANUTENCAO%'
		group by cd_versao, decode(substr(tp_objeto,1,7),'PACKAGE','PACKAGE',tp_objeto), 
				DECODE(tp_objeto,'PROGRAMA','TODOS', 'VISUAL','TODOS', 'IMAGEM','TODOS', 'MARCADORES','TODOS', nm_objeto),
				DECODE(tp_objeto,'PROGRAMA','TODOS', 'VISUAL','TODOS', 'IMAGEM','TODOS', 'MARCADORES','TODOS', ds_objeto)
		order by 1, 2, 3 ;
	--
	cursor c_log (p_tp varchar2, p_nm varchar2, p_tp_atu varchar2) is 
		select id_situacao 
		from bi_auto_update_log
		where ( tp_objeto = p_tp or ( p_tp = 'PACKAGE' and substr(tp_objeto,1,7) = p_tp) )  
		and ( nm_objeto = p_nm or p_nm = 'TODOS')
		and id_situacao in ('FIM','ERRO')
		and tp_atualizacao = p_tp_atu
	order by id_auto_update desc ;
	--  	     
	ws_classe     		varchar2(15);
	ws_ds_objeto  		varchar2(100);
	ws_id_situacao_log  varchar2(100);
	ws_msg_bai    		varchar2(200);
	ws_ds_bai     		varchar2(50);
	ws_cl_bai     		varchar2(50);
	ws_msg_sis    		varchar2(200);
	ws_ds_sis     		varchar2(50);
	ws_cl_sis     		varchar2(50);

	ws_sistema    		  varchar2(20);
	ws_usuario   		  varchar2(200);
	ws_invalido 		  varchar2(3);
	ws_count    		  integer;
	ws_dt_versao_baixa    date; 
	ws_dt_versao_sistema  date; 

	ws_qt_obj_sis      integer;
	ws_qt_obj_upq      integer;
	ws_qt_registros    integer; 
	ws_noaccess          exception;

begin

	ws_sistema      := gbl.getSistema;
	ws_versao       := gbl.getversion;
	ws_usuario      := gbl.getUsuario;
	ws_qt_registros := 0;

	if nvl(gbl.getNivel, 'N') <> 'A' then
		raise ws_noaccess;
	end if;
	
	upd.AutoUpdate_check_atualizacoes (ws_sistema, ws_versao, ws_usuario); 

	htp.p('<table id="table_lista_auto_update" class="linha">');
		htp.p('<thead>');
			htp.p('<tr>');
				htp.p('<th>'||fun.lang('TIPO')||'</th>');
				htp.p('<th>'||fun.lang('OBJETO')||'</th>'); 
				htp.p('<th>'||fun.lang('INV&Aacute;LIDO')||'</th>'); 				
				htp.p('<th>'||fun.lang('QTD SIS')||'</th>'); 
				htp.p('<th>'||fun.lang('QTD UPQ')||'</th>'); 
				htp.p('<th>'||fun.lang('VERS&Atilde;O UPQUERY')||'</th>');
				htp.p('<th>'||fun.lang('VERS&Atilde;O BAIXA')||'</th>');
				htp.p('<th>'||fun.lang('VERS&Atilde;O SISTEMA')||'</th>');
				htp.p('<th>STATUS BAIXA</th>');				
				htp.p('<th>STATUS ATUALIZA&Ccedil;&Atilde;O</th>');
				--htp.p('<th>A&Ccedil;&Otilde;ES</th>');
				--htp.p('<th class="dir">'||fun.lang('ATUALIZA&Ccedil;&Atilde;O AUTOM&Aacute;TICA')||'</th>');
			htp.p('</tr>');
		htp.p('</thead>');

		htp.p('<tbody id="tbody_lista_autoupdate">');

			for i in c_obj loop

				ws_qt_registros := ws_qt_registros + 1; 
				-- Se for package verifica se está invalida, se estiver tanta recompilar 
				ws_invalido := ''; 
				if i.tp_objeto like 'PACKAGE%' then   
					--
					select count(*) into ws_count 
					from all_objects
					where owner       = 'DWU' 
					and status   	  = 'INVALID' 					
					and object_name = i.nm_objeto
					and object_type like 'PACKAGE%';  	
					--  
					if ws_count > 0 then 
						ws_invalido := 'SIM'; 
					end if; 	
				end if ;		


				-- Busca quantidade de Objs para os tipos PADROES e CONSTANTES 
				ws_qt_obj_upq := i.qt_registros;
				ws_qt_obj_sis := i.qt_registros;
				if i.tp_objeto = 'PADROES' then   
					select count(*) into ws_qt_obj_sis
					from bi_object_padrao;
				elsif i.tp_objeto = 'CONSTANTES' then   	  
					select count(*) into ws_qt_obj_sis 
					from bi_constantes;
				elsif i.tp_objeto = 'ESTADOS' then   	  
					select count(*) into ws_qt_obj_sis 
					from bi_estados;
				elsif i.tp_objeto = 'CIDADES' then   	  
					select count(*) into ws_qt_obj_sis 
					from bi_cidades;
				end if; 	  


				-- Situação da baixa do conteudo dos objetos 
				ws_cl_bai  := '';
				ws_ds_bai  := '';
				ws_msg_bai := null;
				
				if i.tp_objeto in ('ESTADOS', 'CIDADES') then  
					ws_cl_sis  := '';
					ws_ds_sis  := '';
					ws_msg_sis := 'Tipo de objeto n&atilde;o necessidade de baixa, somente atualiza&ccedil;&atilde;o';
					ws_dt_versao_baixa := null; 
				else 
					if i.qt_pend_baixa = 0 then 
						ws_dt_versao_baixa := i.dt_versao_baixa_max; 					
						ws_cl_bai  := 'green ok';
						ws_ds_bai  := 'Atualizado';
						ws_msg_bai := 'Objeto j&aacute; atualizado';
					else 
						ws_dt_versao_baixa := i.dt_versao_baixa_min;
						ws_id_situacao_log := null;
						open  c_log(i.tp_objeto, i.nm_objeto, 'BAIXA');
						fetch c_log into ws_id_situacao_log;
						close c_log; 
						if nvl(ws_id_situacao_log,'NA') = 'ERRO' then 
							ws_cl_bai  := 'upd error';
							ws_ds_bai  := 'Erro na baixa';
						else
							ws_cl_bai := 'upd';
							ws_ds_bai := 'Nova baixa dispon&iacute;vel';
						end if; 
					end if; 	
				end if; 	

				-- Situação da atualização do objeto no sistema 
				ws_cl_sis  := '';
				ws_ds_sis  := '';
				ws_msg_sis := null;
				--if i.dt_versao_sistema = i.dt_versao_upquery then 
				if i.qt_pend_sistema = 0 then 
					ws_dt_versao_sistema := i.dt_versao_sistema_max; 
					ws_cl_sis  			 := 'green ok';
					ws_ds_sis  			 := 'Atualizado';
					ws_msg_sis 			 := 'Objeto j&aacute; atualizado';
				else 
					ws_dt_versao_sistema := i.dt_versao_sistema_min; 				
					ws_id_situacao_log := null;
					open  c_log (i.tp_objeto, i.nm_objeto, 'ATUALIZA');
					fetch c_log into ws_id_situacao_log;
					close c_log; 
					--
					if nvl(ws_id_situacao_log,'NA') = 'ERRO' then 
						ws_cl_sis := 'upd error';
						ws_ds_sis := 'Erro na atualiza&ccedil;&atilde;o';
					else
						if i.tp_objeto in ('ESTADOS', 'CIDADES') then  
							if i.id_situacao = 'ATUALIZANDO' then 
								ws_cl_sis  := 'upd loading';
								ws_ds_sis  := 'Atualizando ... ';
								ws_msg_sis := 'Atualizaç&atilde;o em andamento';
							else 
								ws_cl_sis := 'upd';
								ws_ds_sis := 'Atualiza&ccedil;&atilde;o dispon&iacute;vel';
							end if; 	
						else 
							--if i.dt_versao_baixa = i.dt_versao_upquery then 
							if i.qt_pend_baixa = 0 then 
								ws_cl_sis := 'upd';
								ws_ds_sis := 'Atualiza&ccedil;&atilde;o dispon&iacute;vel';
							else 
								ws_cl_sis  := 'upd blocked';
								ws_ds_sis  := 'Aguardando baixa';
								ws_msg_sis := 'Primeiro execute a baixa do objeto';
							end if;	
						end if; 	
					end if; 
				end if; 	


				-- Se Estiver Bloqueado ou inexistente, desabilita as atualizações 
				if i.id_situacao = 'BLOQUEADO' then     
					ws_cl_bai  := 'upd blocked';
					ws_ds_bai  := 'Atualiza&ccedil;&atilde;o bloqueada';
					ws_msg_bai := 'Objeto bloqueado para atualiza&ccedil;&atilde;o';
					ws_cl_sis  := 'upd blocked';
					ws_ds_sis  := 'Atualiza&ccedil;&atilde;o bloqueada';
					ws_msg_sis := 'Objeto bloqueado para atualiza&ccedil;&atilde;o';
				elsif i.id_situacao = 'INVALIDO' then
					ws_cl_bai  := 'upd error';
					ws_ds_bai  := 'Objeto inexistente';
					ws_msg_bai := 'Objeto inexistente na base Upquery';
					ws_cl_sis := 'upd error';
					ws_ds_sis  := 'Objeto inexistente';
					ws_msg_sis := 'Objeto inexistente na base Upquery';
				end if;    

				htp.p('<tr data-sistema="'||ws_sistema||'" data-versao="'||i.cd_versao||'" data-usuario="'||ws_usuario||'"  data-tipo="'||i.tp_objeto||'" data-nome="'||i.nm_objeto||'" >');
					htp.p('<td>'||i.tp_objeto||'</td>');
					htp.p('<td>'||nvl(i.ds_objeto, i.nm_objeto)||'</td>');
					htp.p('<td>'||ws_invalido||'</td>');
					htp.p('<td>'||ws_qt_obj_sis||'</td>');
					htp.p('<td>'||ws_qt_obj_upq||'</td>');
					htp.p('<td>'||to_char(i.dt_versao_upquery_max, 'DD/MM/YYYY HH24:MI')||'</td>');
					htp.p('<td>'||to_char(ws_dt_versao_baixa,      'DD/MM/YYYY HH24:MI')||'</td>');
					htp.p('<td>'||to_char(ws_dt_versao_sistema,    'DD/MM/YYYY HH24:MI')||'</td>');

					htp.p('<td class="td-baixa">');
						if i.tp_objeto not in ('ESTADOS', 'CIDADES') then 
							if ws_msg_bai is not null then 
								htp.p('<a class="'||ws_cl_bai||'" onclick="alerta(''feed-fixo'', '''||ws_msg_bai||'''); ">'||fun.lang(ws_ds_bai)||'</a>');
							else 
								htp.p('<a class="'||ws_cl_bai||'" onclick="autoUpdate(this, ''BAIXA'');">'||fun.lang(ws_ds_bai)||'</a>');								
							end if;     
						end if;	
					htp.p('</td>');

					htp.p('<td class="td-atualiza">');
						if ws_msg_sis is not null then 
							htp.p('<a class="'||ws_cl_sis||'" onclick="alerta(''feed-fixo'', '''||ws_msg_sis||'''); ">'||fun.lang(ws_ds_sis)||'</a>');
						else 
							htp.p('<a class="'||ws_cl_sis||'" onclick="autoUpdate(this, ''ATUALIZA'');">'||fun.lang(ws_ds_sis)||'</a>');							
						end if;     
					htp.p('</td>');

				htp.p('</tr>');
			end loop;
		htp.p('</tbody>');
	htp.p('</table>');

	if ws_qt_registros = 0 then 
		htp.p('<h2 style="width: 100%;">'||fun.lang('N&atilde;o localizado objetos para atualiza&ccedil;&atilde;o do sistema.')||'</h2>');
	end if; 

exception 
	when ws_noaccess then
		htp.p('Sem permiss&atilde;o!');
	when others then
		htp.p(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
end autoUpdate_tela;



procedure login ( prm_user     varchar2 default null,
                  prm_password varchar2 default null, 
				  prm_session  varchar2 default null,
				  prm_prazo    number   default 0.5,
				  prm_url      varchar2 default null,
				  prm_ip       varchar2 default null,
				  prm_origem   varchar2 default 'WEB') as

    ws_test        varchar2(10);
	ws_hash        varchar2(20);
	ws_user        varchar2(40) := 'N/A';
	ws_password    varchar2(40);
	ws_show        varchar2(40);
	ws_email       varchar2(500);
	ws_email_abrev varchar2(500);
	ws_sid		   varchar2(20);
	ws_serial	   varchar2(20);
	ws_prazo       number   := 0.5;
	ws_count       number := 0;
	ws_msg_valida  varchar2(500); 
	ws_msg_expira  varchar2(500); 
	ws_token     VARCHAR2(40);
	ws_tempo_exp number; 
	ws_dt_validacao_email  date; 
	ws_dt_validacao_senha  date; 
	ws_id_expira_senha     varchar2(10); 
	ws_expirou_senha       varchar2(1);
	ws_admin               usuarios.show_only%type; 
	ws_semacesso_cd        varchar2(10);

	ws_erro_senha    	 exception;
	ws_erro          	 exception;	
	ws_semacesso     	 exception;	
	ws_usuario      	 exception;
	ws_raise_valida 	 exception;
	ws_raise_expira 	 exception;
	ws_sem_permissao_app exception;


begin

	ws_user       := upper(prm_user);
	ws_msg_expira := null; 
	ws_msg_valida := null; 

	begin 
		select upper(usu_nome), dt_validacao_email, dt_validacao_senha, id_expira_senha, usu_email, show_only
		  into ws_user, ws_dt_validacao_email, ws_dt_validacao_senha, ws_id_expira_senha, ws_email, ws_admin
	  	  from usuarios 
		  where ( ( upper(usu_nome)  = ws_user ) or      -- Procura pelo nome do usuario 
			  	  ( upper(usu_email) = ws_user )         -- Procura pelo email do usuário 
		        ) 	
			and rownum = 1;
	exception 
		when no_data_found then 
			raise ws_usuario;
		when others then
        	raise ws_erro;
	end;

	if nvl(ws_user, 'N/A') = 'N/A' then
        raise ws_erro;
	end if;

	ws_email_abrev := substr(ws_email, 1,2)||'********'||substr(ws_email, instr(ws_email,'@',1,1), 500); 

    ws_test := fun.testDigestedPassword(ws_user, prm_password);

	if ws_test = 'Y' then

		-- Verifica se o usuário possui acesso ao sistema 
		if fun.check_netwall(ws_user, prm_ip) = false then
			ws_semacesso_cd := 'NET'; 
			raise ws_semacesso;		
		end if; 

		if fun.check_user(ws_user) = false then
			ws_semacesso_cd := 'USER'; 
			raise ws_semacesso;		
		end if; 

		-- Verifica se o usuário tem a permissão para acessar via Aplicativo

		if prm_origem = 'APP' then
			if fun.check_app_permission(ws_user) = false then
				raise ws_sem_permissao_app;
			end if;
		end if;

		-- Verifica se o usuário está parametrizado para Expirar a senha e se a senha expirou - Só verifica se o usuário já fez um primeiro acesso (já possui bi_info_user)
		ws_expirou_senha := 'N'; 
		select count(*) into ws_count from bi_info_user where nm_user = ws_user; 
		if ws_count > 0 then 
			if nvl(ws_id_expira_senha,'S') = 'S' then 
				begin
					ws_tempo_exp := nvl(fun.ret_var ('TEMPO_EXPIRA_SENHA', ws_user),'0'); 
				exception when others then 
					ws_tempo_exp := 0;
				end; 
				if ( ws_tempo_exp <> 0 and (trunc(sysdate) - trunc(ws_dt_validacao_senha) ) >= ws_tempo_exp )  or 
				   ( ws_dt_validacao_senha is null ) then
					loginExpiraSenha (ws_user, '999', prm_url, ws_msg_expira ); 
					ws_expirou_senha := 'S'; 
					if ws_msg_expira <> 'TELA' then -- Se a validação for por Email, cancela o login 
						raise ws_raise_expira; 
					end if; 	
				end if; 
			end if; 
		end if; 	
		
		
		-- Verifica necessidade de Confirmação de identidade de acesso para usuários Normais (Se estiver parametrizado para solicitar confirmação)  
		if ws_admin = 'N' and upper(nvl(fun.ret_var ('CONF_ACESSO_EMAIL','DWU'),'S')) <> 'N' then 

			-- Pega a data novamente, pois pode ter sido atualizada pela validação da senha, quando é feita por email  
			select max(dt_validacao_email) into ws_dt_validacao_email   
	  	      from usuarios 
		     where upper(usu_nome)  = ws_user ; 

			begin
				ws_tempo_exp := nvl(fun.ret_var ('TEMPO_EXPIRA_EMAIL',ws_user),'0'); 
			exception when others then 
				ws_tempo_exp := 0;
			end; 
			--if ws_tempo_exp <> 0 and (ws_dt_validacao_email is null or (trunc(sysdate) - trunc(ws_dt_validacao_email)) >= ws_tempo_exp) then
			IF ( ws_tempo_exp <> 0 and (trunc(sysdate) - trunc(ws_dt_validacao_email)) >= ws_tempo_exp) or 
			   ( ws_dt_validacao_email is null ) then			
				loginValida (ws_user, '999', prm_url, ws_msg_valida ); 
				raise ws_raise_valida; 
			end if;	
		end if; 	
		insert into bi_log_sistema values(sysdate, 'Sess&atilde;o iniciada ['||trim(owa_util.get_cgi_env('REMOTE_ADDR'))||'-'||prm_ip||']', ws_user, 'SESSAO');
    	commit;

		-- Cria a SESSÃO do navegador 
		ws_prazo := prm_prazo;
		Select ws_user||
		 	   to_char(sysdate,'miss')||
		       round(dbms_random.value(10,99))||
		       to_char(sysdate,'dd') 
		  into ws_token From Dual;

		if nvl(ws_admin,'N') = 'S' then
			ws_prazo := prm_prazo+6;
		end if;

		owa_util.mime_header('text/html', FALSE, NULL);
		owa_cookie.send( name    => 'SESSION',
						 value   => ws_token,
						 expires => sysdate+nvl(ws_prazo, 0.5)
					   );
		owa_util.http_header_close;

		fun.setSessao(ws_token, ws_user, sysdate+nvl(ws_prazo, 0.5));

		update active_sessions
		   set status = 'I'
		  where status = 'A' and dt_atividade < (Sysdate-((1/1440)*30));
		--
		if upper(nvl(fun.ret_var('CONF_ACESSO_EMAIL','DWU'),'S')) = 'N' then  -- Se não exige confirmação de identificação de acesso, atualiza a data de validação de email 
			update usuarios set dt_validacao_email = sysdate 
		     where upper(usu_nome) = ws_user
			   and dt_validacao_email is null; 
			commit;  
		end if;  

		commit;
		SELECT max(sid), max(serial#) 
		  INTO ws_sid,ws_serial
   		  FROM v$session
         WHERE audsid=USERENV('SESSIONID');

		update active_sessions t1 set t1.dt_Atividade = Sysdate
		 where t1.id_session = ws_user||replace(sys_context('userenv','ip_address'), '.')
		   and t1.status = 'A';
		if sql%notfound then 
			begin
				insert into active_sessions (id_session,usuario,dt_inicio,dt_atividade,status,cd_sid,cd_serial) values (ws_user||replace(sys_context('userenv','ip_address'), '.'), ws_user, sysdate, sysdate, 'A',ws_sid,ws_serial); 
			exception
			  when others then
				insert into bi_log_sistema values (sysdate, 'Active_sessions (others):'|| DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, ws_user, 'ERRO');
				commit;
			end;
		end if;    
		commit;

		if ws_msg_expira = 'TELA' then 
			htp.p('LOGINSENHANOVA'); 
		else
			-- htp.p(ws_token);   -- Não pode mostrar porque aparece no navegador quando aberto pelo APP
			htp.p('');
		end if; 

	else
        raise ws_erro_senha;
	end if;

exception 
	when ws_raise_expira then 
		if ws_msg_expira = 'OK' then 
			htp.p('LOGINEXPIRA|OK|'||ws_email_abrev||'|'||fun.lang(ws_msg_expira)); 
		else
			htp.p('LOGINEXPIRA|ERRO|'||ws_email_abrev||'|'||fun.lang(ws_msg_expira)); 
		end if; 
	when ws_raise_valida then 
		if ws_msg_valida = 'OK' then 
			htp.p('LOGINVALIDA|OK|'||ws_email_abrev||'|'||fun.lang(ws_msg_valida)); 
		else
			htp.p('LOGINVALIDA|ERRO|'||ws_email_abrev||'|'||fun.lang(ws_msg_valida)); 
		end if; 
    when ws_erro_senha then
	    htp.p('ERRO|ERRO|'||fun.lang('Senha inv&aacute;lida'));
	when ws_usuario then
		htp.p('ERRO|ERRO|'||fun.lang('Usu&aacute;rio n&atilde;o cadastrado no sistema'));
	when ws_erro then
		htp.p('ERRO|ERRO|'||fun.lang('Erro validando usu&aacute;o, entre em contato com o administrador do sistema'));
	when ws_semacesso then
		if ws_semacesso_cd = 'NET' then  
			insert into bi_log_sistema values (sysdate, 'LOGIN (netwall): Acesso de usuario bloqueado pelas regras de NETWALL. Usuario '||ws_user||' IP '||trim(owa_util.get_cgi_env('REMOTE_ADDR')), ws_user, 'EVENTO');
		else 			
			insert into bi_log_sistema values (sysdate, 'LOGIN (usuario): Usuario '||ws_user||' inativo ou invalido.', ws_user, 'EVENTO');		
		end if; 
		commit; 		
		--
		htp.p('ERRO|ERRO|'||fun.lang('Usu&aacute;rio sem acesso ao sistema'));
		begin 
			gbl.setUsuario(prm_session, '');
		exception when others then 
			null;
		end;
	when ws_sem_permissao_app then
		insert into bi_log_sistema values (sysdate, 'LOGIN (usuario): Usuario '||ws_user||' sem permissao de acesso ao aplicativo.', ws_user, 'EVENTO');
		commit;
		htp.p('ERRO|ERRO|'||fun.lang('Usu&aacute;rio sem permiss&atilde;o de acesso ao Aplicativo'));
    when others then
		insert into bi_log_sistema values (sysdate, 'LOGIN (others):'|| DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, ws_user, 'ERRO');
		commit; 
        htp.p('ERRO|ERRO|'||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
end login;



procedure newPassword ( prm_usuario varchar2,
						prm_code    varchar2 default null,
						prm_url     varchar2 default null ) as

	ws_code          varchar2(100);
	ws_cmd           varchar2(200);
	ws_count         number;
	ws_vrf           varchar2(10);
	ws_mail          varchar2(80);
	ws_usuario       varchar2(80);
	ws_address       varchar2(80);
	ws_erro_envio    varchar2(1000);
	ws_nomail        exception;
	ws_nouser        exception;
	ws_err           exception;


begin

	if nvl(prm_code, '999') = '999' then

		--gera código
		ws_code := fun.randomCode(11);

		--testa uso do email ou login, verifica se email existe na tabela
		if instr(prm_usuario, '@') > 0 then
			begin
				ws_mail := trim(upper(prm_usuario));
				select count(*) into ws_count from usuarios where trim(upper(usu_email)) = ws_mail;

				if nvl(ws_mail, 'N/A') = 'N/A' or ws_count = 0 then
					raise ws_nomail;
				end if;

				select trim(upper(usu_nome)) into ws_usuario from usuarios where trim(upper(usu_email)) = ws_mail and rownum = 1;
			exception when others then
				raise ws_nomail;
			end;
		else
			begin
				ws_usuario := trim(upper(prm_usuario));
				select trim(upper(usu_email)) into ws_mail from usuarios where trim(upper(usu_nome)) = ws_usuario;
			exception when others then
				raise ws_nouser;
			end;
		end if;

		if ws_mail = 'N/A' or ws_count = 0 then
			raise ws_nomail;
		end if;

		--invalida outros tickets
		update bi_token set status = 'F' 
		where trim(upper(usuario)) = ws_usuario 
		and to_char(dt_envio, 'DD/MM/YY HH24') = to_char(sysdate, 'DD/MM/YY HH24') 
		and status = 'A';
		commit;

		--gera novo ticket
		insert into bi_token ( code, usuario, dt_envio, status ) 
					values   ( ws_code, ws_usuario, sysdate, 'A' );
		commit;

		insert into bi_log_sistema values (sysdate, 'Usuário solicitou alteração de senha através do link <Esqueceu a senha?>', ws_usuario, 'EVENTO');
		commit;

		fcl.xsend_mail('upquery@upquery.com', ws_mail, 'Upquery - Solicitacao de troca de senha', 
					'<p>Ol&aacute;,</p>'||
					'<p>Houve uma solicita&ccedil;&atilde;o de troca de senha do seu usu&aacute;rio, se voc&ecirc; fez essa solicita&ccedil;&atilde;o clique no link abaixo, caso contr&aacute;rio ignore esse email.</p>'||
					'<h4><a href="'||prm_url||''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.newPassword?prm_usuario='||ws_usuario||'&prm_code='||ws_code||'">Trocar senha</a></h4>'||
					'<p>Este link tem validade de 12 horas.</p>'||
					'<br><br><p><font size="1">Email gerado automaticamente pelo sistema, n&atilde;o responda.</font></p>'||
					'<img src="https://www.upquery.com/wp-content/themes/upquery/media/img/assets/brand.svg" alt="UpQuery do Brasil" width="203" height="50">' , ws_erro_envio);

		if ws_erro_envio is not null then 
			htp.p(fun.lang(ws_erro_envio));   -- Erro no envio do email 
		else 	
			htp.p(fun.lang('Em instantes voc&ecirc; receber&aacute; um email com instru&ccedil&otilde;es para a troca da sua senha!'));
		end if; 	
	else

		select count(*) into ws_count from bi_token 
		where trim(upper(usuario)) = trim(upper(prm_usuario)) 
		and code                 = prm_code 
		and to_char(dt_envio, 'DD/MM/YY HH24') = to_char(sysdate, 'DD/MM/YY HH24') 
		and status = 'A';

		if ws_count <> 0 then
			begin

				ws_usuario := trim(upper(prm_usuario));
				select trim(upper(usu_email)) into ws_mail from usuarios where trim(upper(usu_nome)) = ws_usuario;

				SELECT round(dbms_random.value(10000000,99999999)) into ws_code FROM dual;
				
				ws_vrf := fun.digestPassword(ws_usuario, ws_code);
				if ws_vrf = 'Y' then

					fcl.xsend_mail('upquery@upquery.com', ws_mail, 'Upquery - Solicitacao de troca de senha - Nova senha', 
								'<p>Ol&aacute;,</p><p>Segue abaixo sua nova senha: </p>'||
								'<h3><b>'||ws_code||'</b></h3>'||
								'<p>Aten&ccedil;&atilde;o, esta &eacute; uma senha tempor&aacute;ria, no seu primeiro acesso ao sistema ser&aacute; solicitado o cadastro de uma nova senha.</p>'||
								'<br><br><p><font size="1">Email gerado automaticamente pelo sistema, n&atilde;o responda.</font></p>'||
								'<img src="https://www.upquery.com/wp-content/themes/upquery/media/img/assets/brand.svg" alt="UpQuery do Brasil" width="203" height="50">', ws_erro_envio); 

					--invalida os tickets
					update bi_token	set status = 'F' 
					where trim(upper(usuario)) = ws_usuario 
					and code 	               = prm_code 
					and to_char(dt_envio, 'DD/MM/YY HH24') = to_char(sysdate, 'DD/MM/YY HH24') 
					and status = 'A';
					delete from bi_sessao where valor = trim(upper(ws_usuario));
					delete from bi_info_user where nm_user = trim(upper(ws_usuario));
					insert into bi_log_sistema values (sysdate, 'Senha alterada pelo usuário através do link <Esqueceu a senha?>', ws_usuario, 'EVENTO');
					commit;
					
					if ws_erro_envio is not null then 
						htp.p(fun.lang(ws_erro_envio));   -- Erro no envio do email 
					else 	
						htp.p(fun.lang('Senha alterada com sucesso!<br>'));
						htp.p(fun.lang('Em breve voc&ecirc; receber&aacute; um email com a nova senha!'));
					end if; 	

				else
					raise ws_err;
				end if;
			exception when others then
				raise ws_err;
			end;
		else

			htp.p(fun.lang('Ticket inv&aacute;lido ou prazo expirado!<br>'));
			htp.p(fun.lang('Solicite novamente a troca da senha!'));

		end if;
	end if;
exception 
	when ws_err then
		htp.p(fun.lang('Erro ao alterar a senha!'));
	when ws_nouser then
		htp.p(fun.lang('Usu&aacute;rio n&atilde;o encontrado!'));
	when ws_nomail then
		htp.p(fun.lang('Email n&atilde;o encontrado!'));
	when others then
		if instr(UPPER(DBMS_UTILITY.FORMAT_ERROR_STACK),'COULD NOT FIND PROGRAM UNIT') > 0 then 
		htp.p(fun.lang('N&atilde;o foi poss&iacute;vel localizar o pacote de fun&ccedil;&otilde;es do sistema, pacote com situa&ccedil;&atilde;o inv&aacute;lida ou inexistente.')) ;
		else    
		htp.p(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
		end if;    
end newPassword;


procedure loginValida ( prm_usuario 	varchar2,
						prm_code    	varchar2 default null,
						prm_url     	varchar2 default null,
						prm_msg_retorno in out varchar2  ) as

	ws_code          varchar2(100);
	ws_cmd           varchar2(200);
	ws_count         number;
	ws_vrf           varchar2(10);
	ws_mail          varchar2(80);
	ws_usuario       varchar2(80);
	ws_address       varchar2(80);
	ws_erro_envio    varchar2(1000);
	ws_raise_envio	 	exception;
	ws_raise_liberacao  exception;
	ws_nouser           exception;


begin

	if nvl(prm_code, '999') = '999' then

		begin 
			-- verifica se tem email cadastrado 
			prm_msg_retorno := null;
			ws_mail 		:= null;
			ws_usuario 		:= trim(upper(prm_usuario));
			select trim(upper(max(usu_email))) into ws_mail from usuarios where trim(upper(usu_nome)) = ws_usuario;
			if ws_mail is null then
				prm_msg_retorno := 'Usu&aacute;rio sem e-mail cadastrado';
				raise ws_raise_envio;
			end if;

			--invalida outros tickets pendentes do mesmo usuário 
			update bi_token set status = 'F' 
			where trim(upper(usuario)) = ws_usuario 
			and to_char(dt_envio, 'DD/MM/YY HH24') = to_char(sysdate, 'DD/MM/YY HH24') 
			and status = 'A';
			commit;

			--gera novo ticket
			ws_code := fun.randomCode(11);
			insert into bi_token ( code, usuario, dt_envio, status )  values   ( ws_code, ws_usuario, sysdate, 'A' );
			commit;

			insert into bi_log_sistema values (sysdate, 'Confirmacao de Identidade - Envio de codigo de confirmacao', ws_usuario, 'EVENTO');
			commit;

			fcl.xsend_mail('upquery@upquery.com', ws_mail, 'Upquery - Confirmacao de Identidade', 
					'<p>Ol&aacute;,</p>'||
					'<p>Este &eacute; um email de confirma&ccedil;&atilde;o da sua identidade de acesso ao sistema de BI, para confirmar sua identifica&ccedil;&atilde;o e liberar o acesso ao sistema clique no link abaixo.</p>'||
					'<h4><a href="'||prm_url||''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.loginValida?prm_usuario='||ws_usuario||'&prm_code='||ws_code||'&prm_url=&prm_msg_retorno='||'">Confirmar identidade</a></h4>'||
					'<p>Este link &eacute; v&aacute;lido somente para data de hoje, ou at&eacute; o envio de um novo email de confirma&ccedil;&atilde;o.</p>'||
					'<br><br><p><font size="1">Email gerado automaticamente pelo sistema, n&atilde;o responda.</font></p>'||
					'<img src="https://www.upquery.com/wp-content/themes/upquery/media/img/assets/brand.svg" alt="UpQuery do Brasil" width="203" height="50">', 
					ws_erro_envio);

			if ws_erro_envio is not null then 
				prm_msg_retorno := ws_erro_envio;   -- Erro no envio do email 
			else 
				-- Não converter para HTML, pois a mensagem é mostrada no Alert do navegador, o alert não converte acentuação corretamente, usar CHR porque o Wrap altera a acentuação 
				prm_msg_retorno := 'OK'; 
								--'ATEN'||chr(199)||chr(195)||'O !'||chr(10)||
								--   'Identificamos a necessidade de confirma'||chr(231)||chr(227) ||'o da sua identidade de acesso ao sistema!'||chr(10)||chr(10)||
								--   'Enviamos um e-email para endere'||chr(231)||'o de e-mail parametrizado no seu usu'||chr(225)||'rio com instru'||chr(231)||chr(245)||'es para confirma'||chr(231)||chr(227)||'o da sua identidade.' ;

			end if; 	
		exception 
			when ws_raise_envio then
				null;
			when others then
				prm_msg_retorno := 'Erro gerando e-mail de confirma&ccedil;&atilde;o de acesso, entre em contato com o administrador do sistema.';
				insert into bi_log_sistema values (sysdate, 'Erro no envio do email de confirmacao de acesso:'||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, ws_usuario, 'ERRO');
				commit; 
		end;
	else
		begin
			select count(*) into ws_count from bi_token 
			where trim(upper(usuario)) = trim(upper(prm_usuario)) 
			and code                 = prm_code 
			and to_char(dt_envio, 'DD/MM/YY HH24') = to_char(sysdate, 'DD/MM/YY HH24') 
			and status = 'A';

			if ws_count <> 0 then
				ws_usuario := trim(upper(prm_usuario));
				ws_mail    := null;

				update usuarios set dt_validacao_email = sysdate 
				where usu_nome = ws_usuario;

				--invalida os tickets
				update bi_token	set status = 'F' 
				where trim(upper(usuario)) = ws_usuario 
				and code 	               = prm_code 
				and to_char(dt_envio, 'DD/MM/YY HH24') = to_char(sysdate, 'DD/MM/YY HH24') 
				and status = 'A';

				delete from bi_sessao where valor = trim(upper(ws_usuario));
				insert into bi_log_sistema values (sysdate, 'Confirmacao de Identidade - Identificacao confirmada', ws_usuario, 'EVENTO');				
				commit;

				if ws_erro_envio is not null then 
					insert into bi_log_sistema values (sysdate, 'Erro enviando email de confirmacao da liberacao de acesso:'||ws_erro_envio, ws_usuario, 'ERRO');
				end if;	
				htp.p(fun.lang('Confirma&ccedil;&atilde;o de identidade realizada com sucesso!<br>'));
				htp.p(fun.lang('Seu acesso ao sistema de BI foi liberado.'));


			else
				htp.p(fun.lang('C&oacute;digo de valida&ccedil;&atilde;o inv&aacute;lido ou prazo expirado!<br>'));
				htp.p(fun.lang('Tente realizar um novo acesso ao sistema para gerar um novo email de confirma&ccedil;&atilde;o!'));
			end if;
		exception 
			when others then
				htp.p(fun.lang('Erro na tentativa de libera&ccedil;&atilde;o do acesso.<br>'));
				htp.p(fun.lang('Tente realizar um novo acesso ao sistema para gerar um novo email de confirma&ccedil;&atilde;o, ou entre em contato com o administrador do sistema!'));
				insert into bi_log_sistema values (sysdate, 'Erro na confirmacao da liberacao de acesso:'||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, ws_usuario, 'ERRO');
				commit; 								
		end;
	end if;
	--
end loginValida;


procedure loginExpiraSenha ( prm_usuario 	varchar2,
							prm_code    	varchar2 default null,
							prm_url     	varchar2 default null,
							prm_msg_retorno in out varchar2  ) as

	ws_code          varchar2(100);
	ws_cmd           varchar2(200);
	ws_count         number;
	ws_vrf           varchar2(10);
	ws_mail          varchar2(80);
	ws_usuario       varchar2(80);
	ws_address       varchar2(80);
	ws_erro_envio    varchar2(1000);
	ws_tipo_expira   varchar2(20); 

	ws_raise_envio	 	exception;
	ws_raise_liberacao  exception;
	ws_nouser           exception;
	ws_raise_altera 	exception;
	ws_raise_tela    	exception;


begin

	if nvl(prm_code, '999') = '999' then

		prm_msg_retorno := null;
		ws_mail 		:= null;
		ws_usuario 		:= trim(upper(prm_usuario));

		begin
			ws_tipo_expira := nvl(fun.ret_var ('TIPO_EXPIRA_SENHA', 'DWU'),'E'); 
		exception when others then 
			ws_tipo_expira := 'E'; 
		end; 

		if ws_tipo_expira = 'T' then -- Cadastra nova senha na tela aberta na abertura do BI - Exclui tabela para que o sistema abra a tela 
			delete from bi_info_user where nm_user = trim(upper(ws_usuario)); 
			raise ws_raise_tela; 
		end if; 

		begin 
			-- verifica se tem email cadastrado 
			select trim(upper(max(usu_email))) into ws_mail from usuarios where trim(upper(usu_nome)) = ws_usuario;
			if ws_mail is null then
				prm_msg_retorno := 'Usu&aacute;rio sem e-mail cadastrado';
				raise ws_raise_envio;
			end if;

			--invalida outros tickets pendentes do mesmo usuário 
			update bi_token set status = 'F' 
			where trim(upper(usuario)) = ws_usuario 
			and to_char(dt_envio, 'DD/MM/YY HH24') = to_char(sysdate, 'DD/MM/YY HH24') 
			and status = 'A';
			commit;

			--gera novo ticket
			ws_code := fun.randomCode(11);
			insert into bi_token ( code, usuario, dt_envio, status )  values   ( ws_code, ws_usuario, sysdate, 'A' );
			commit;

			insert into bi_log_sistema values (sysdate, 'Senha Expirada - Envio de email para definição de nova senha', ws_usuario, 'EVENTO');
			commit;

			fcl.xsend_mail('upquery@upquery.com', ws_mail, 'Upquery - Senha Expirada', 
					'<p>Ol&aacute;,</p>'||
					'<p>Sua senha expirou, clique no link abaixo para gera&ccedil;&atilde;o de uma nova senha de acesso tempor&aacute;rio.</p>'||
					'<h4><a href="'||prm_url||''||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.loginExpiraSenha?prm_usuario='||ws_usuario||'&prm_code='||ws_code||'&prm_url=&prm_msg_retorno='||'">Gerar senha tempor&aacute;ria</a></h4>'||
					'<p>Este link &eacute; v&aacute;lido somente para data de hoje, ou at&eacute; o envio de um novo email de altera&ccedil;&atilde;o de senha.</p>'||
					'<br><br><p><font size="1">Email gerado automaticamente pelo sistema, n&atilde;o responda.</font></p>'||
					'<img src="https://www.upquery.com/wp-content/themes/upquery/media/img/assets/brand.svg" alt="UpQuery do Brasil" width="203" height="50">', 
					ws_erro_envio);
			if ws_erro_envio is not null then 
				prm_msg_retorno := ws_erro_envio;   -- Erro no envio do email 
			else 
				prm_msg_retorno := 'OK'; 
			end if; 	
		exception 
			when ws_raise_envio then
				null;
			when others then
				prm_msg_retorno := 'Erro gerando e-mail de expira&ccedil;&atilde;o de senha , entre em contato com o administrador do sistema.';
				insert into bi_log_sistema values (sysdate, 'Erro no envio do email de expiracao de senha:'||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, ws_usuario, 'ERRO');
				commit; 
		end;
	else
		begin
			select count(*) into ws_count from bi_token 
			where trim(upper(usuario)) = trim(upper(prm_usuario)) 
			and code                 = prm_code 
			and to_char(dt_envio, 'DD/MM/YY HH24') = to_char(sysdate, 'DD/MM/YY HH24') 
			and status = 'A';

			if ws_count <> 0 then

				ws_usuario := trim(upper(prm_usuario));
				select max(trim(upper(usu_email))) into ws_mail from usuarios where trim(upper(usu_nome)) = ws_usuario;
				SELECT round(dbms_random.value(10000000,99999999)) into ws_code FROM dual;				

				ws_vrf := fun.digestPassword(ws_usuario, ws_code);
				if ws_vrf = 'Y' then
					fcl.xsend_mail('upquery@upquery.com', ws_mail, 'Upquery - Senha Expirada - Nova senha temporaria', 
								'<p>Ol&aacute;,</p>'||
								'<p>Sua senha anterior expirou, segue abaixo uma senha para acesso tempor&aacute;rio, ap&oacute;s o seu primeiro acesso ser&aacute; solicitado o cadastro de uma nova senha.</p>'||
								'<h3><b>'||ws_code||'</b></h3>'||
								'<br><br><p><font size="1">Email gerado automaticamente pelo sistema, n&atilde;o responda.</font></p>'||
								'<img src="https://www.upquery.com/wp-content/themes/upquery/media/img/assets/brand.svg" alt="UpQuery do Brasil" width="203" height="50">', ws_erro_envio); 

					if ws_erro_envio is not null then 
						htp.p(fun.lang(ws_erro_envio));   -- Erro no envio do email 
					else 
						--invalida os tickets
						update bi_token	set status = 'F' 
						where trim(upper(usuario)) = ws_usuario 
						and code 	               = prm_code 
						and to_char(dt_envio, 'DD/MM/YY HH24') = to_char(sysdate, 'DD/MM/YY HH24') 
						and status = 'A';

						update usuarios 
						set dt_validacao_senha = sysdate,   -- Data a ultima validação da senha 
							dt_validacao_email = sysdate    -- Data a ultima validação do email/login - Atualiza a validação do login também já que a atualização da senha foi feita por email 
						where usu_nome = ws_usuario ; 
						
						delete from bi_info_user where nm_user = trim(upper(ws_usuario));    -- Exclui tabela para que o sistema solicite o cadastro da nova senha 
						delete from bi_sessao    where valor = trim(upper(ws_usuario));
						insert into bi_log_sistema values (sysdate, 'Senha expirada - Gerado nova senha temporaria', ws_usuario, 'EVENTO');
						commit;
					
						htp.p(fun.lang('Senha alterada com sucesso!<br>'));
						htp.p(fun.lang('Em breve voc&ecirc; receber&aacute; um email com uma nova senha para acesso tempor&aacute;rio!'));
					end if; 	
				else
					htp.p(fun.lang('Problema criando nova senha tempor&aacuteria, entre em contato com o administrador do sistema.<br>'));
				end if;
			else
				htp.p(fun.lang('C&oacute;digo de valida&ccedil;&atilde;o inv&aacute;lido ou prazo expirado!<br>'));
				htp.p(fun.lang('Tente realizar um novo acesso ao sistema para gerar um novo email de expira&ccedil;&atilde;o de senha!'));
			end if;
		exception 
			when others then
				htp.p(fun.lang('Erro na tentativa de envio de nova senha tempor&aacute;ria.<br>'));
				htp.p(fun.lang('Tente realizar um novo acesso ao sistema para gerar um novo email de expira&ccedil;&atilde;o de senha, ou entre em contato com o administrador do sistema!'));
				insert into bi_log_sistema values (sysdate, 'Erro no envio de senha temporária para senha expirada:'||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, ws_usuario, 'ERRO');
				commit; 								
		end;
	end if;
	--
exception when ws_raise_tela then 
	prm_msg_retorno := 'TELA';
end loginExpiraSenha;







procedure copiarPermissaoBox ( prm_usuario varchar2 default null ) as

begin

	htp.p('<h3>'||fun.lang('COPIAR REGRAS')||'</h3>');
	
	fcl.fakeoption('fake-copiar-permissao', fun.lang('Lista de usu&aacute;rios'), '', 'lista-usuarios', 'N', 'N');
	htp.p('<select id="regras">');
		htp.p('<option value="semRegras" disabled selected>'||fun.lang('LIMPAR REGRAS ATUAIS')||'</option>');
		--htp.p('<option value="manter" selected readonly disabled>'||fun.lang('LIMPAR REGRAS ATUAIS')||'</option>');
		htp.p('<option value="manter">'||fun.lang('N&Atilde;O')||'</option>');
		htp.p('<option value="deletar">'||fun.lang('SIM')||'</option>');
	htp.p('</select>');
	htp.p('<a class="addpurple" onclick="copyUserBtn('''||prm_usuario||''');">'||fun.lang('EXECUTAR')||'</a>');

end;

procedure copiarPermissao ( prm_usuario varchar2, 
							prm_usuario_cop varchar2, 
							prm_status varchar2 default 'manter'
						) as
	
	var_usuario     varchar2(40) := trim(upper(prm_usuario));
	var_usuario_cop varchar2(40) := trim(upper(prm_usuario_cop));

	ws_key          number;


begin

	if prm_status = 'deletar' then

		--deleta full--

		delete filtros              where trim(upper(cd_usuario)) = var_usuario;
		delete destaque             where trim(upper(cd_usuario)) = var_usuario;
		delete float_filter_item    where trim(upper(cd_usuario)) = var_usuario;
		delete object_restriction   where trim(upper(usuario))    = var_usuario;
		delete parametro_usuario    where trim(upper(cd_usuario)) = var_usuario;
		delete roles                where trim(upper(cd_usuario)) = var_usuario;
		delete column_restriction   where trim(upper(usuario))    = var_usuario;
		delete user_netwall         where trim(upper(usuario))    = var_usuario;
		--delete bi_permissao_custom  where trim(upper(nm_usuario)) = var_usuario;
		delete user_screens         where trim(upper(usuario))    = var_usuario;

		--  insere full  --

		select nvl(max(cd_filtro),0)+1 into ws_key from filtros;
		for i in(select var_usuario as cd_usuario, cd_objeto, micro_visao, cd_coluna, condicao, conteudo, ligacao, st_agrupado, tp_filtro, cd_criado
		from filtros where trim(upper(cd_usuario)) = var_usuario_cop) loop
			ws_key := ws_key+1;
			insert into filtros (cd_usuario, cd_objeto, micro_visao, cd_coluna, condicao, conteudo, ligacao, st_agrupado, cd_filtro, tp_filtro, cd_criado)
            values (i.cd_usuario, i.cd_objeto, i.micro_visao, i.cd_coluna, i.condicao, i.conteudo, i.ligacao, i.st_agrupado, ws_key, i.tp_filtro, i.cd_criado);
		end loop;
		/*insert into filtros select var_usuario as cd_usuario,cd_objeto,micro_visao,cd_coluna,condicao,conteudo,ligacao,st_agrupado,(select nvl(max(cd_filtro),0)+1 from filtros) as cd_filtro,tp_filtro,cd_criado
		from filtros where trim(upper(cd_usuario)) = var_usuario_cop;*/

		select nvl(max(cd_destaque),0)+1 into ws_key from destaque;
		for d in(select var_usuario as cd_usuario, cd_objeto, cd_coluna, condicao, conteudo, cor_fundo, cor_fonte, tipo_destaque, prioridade
		from destaque where trim(upper(cd_usuario)) = var_usuario_cop) loop
			ws_key := ws_key+1;
			insert into destaque values (d.cd_usuario, d.cd_objeto, d.cd_coluna, d.condicao, d.conteudo, d.cor_fundo, d.cor_fonte, d.tipo_destaque, d.prioridade, ws_key);
		end loop;
		/*insert into destaque select var_usuario as cd_usuario,cd_objeto,cd_coluna,condicao,conteudo,cor_fundo,cor_fonte,tipo_destaque,prioridade,(select nvl(max(cd_destaque),0)+1 from destaque) as cd_destaque
		from destaque where trim(upper(cd_usuario)) = var_usuario_cop;*/

		insert into float_filter_item select var_usuario as cd_usuario,screen,cd_coluna,conteudo 
		from float_filter_item where trim(upper(cd_usuario)) = var_usuario_cop;

		insert into object_restriction select var_usuario as usuario,cd_objeto,st_restricao,dt_last
		from object_restriction where usuario = var_usuario_cop;

		insert into parametro_usuario select var_usuario as cd_usuario,cd_padrao,conteudo,pre_load
		from parametro_usuario where trim(upper(cd_usuario)) = var_usuario_cop;

		insert into roles select var_usuario as cd_usuario,cd_role,tipo
		from roles where trim(upper(cd_usuario)) = var_usuario_cop;

		insert into column_restriction select var_usuario as usuario,cd_micro_visao,cd_coluna,st_restricao,dt_last
		from column_restriction where trim(upper(usuario)) = var_usuario_cop;

		insert into user_netwall (usuario, nome_regra, tipo_regra, tp_net_address, net_address, hr_inicio, hr_final, dia_semana, dt_regra) 
		select var_usuario as usuario,nome_regra,tipo_regra, tp_net_address, net_address,hr_inicio,hr_final,dia_semana,trunc(sysdate)
			from user_netwall where trim(upper(usuario)) = var_usuario_cop;
		
		select nvl(max(cd_custom),0)+1 into ws_key from bi_custom_permissao;
		
		for c in (select var_usuario as nm_usuario, nm_visao,nm_coluna,cd_custom 
		from bi_custom_permissao where trim(upper(nm_usuario)) = var_usuario_cop ) loop

		ws_key := ws_key+1;
		insert into bi_custom_permissao values (c.nm_usuario,c.nm_visao,c.nm_coluna,ws_key);

		end loop;

		/*
			insert into bi_custom_permissao select var_usuario as nm_usuario,nm_visao,nm_coluna,cd_custom 
			from bi_custom_permissao where trim(upper(nm_usuario)) = var_usuario_cop;
		*/
		insert into user_screens select var_usuario as usuario,screen,status
		from user_screens where trim(upper(usuario)) = var_usuario_cop;

	end if;

	-- adiciona todos menos os que já existem --

	if prm_status = 'manter' then


		insert into filtros (cd_usuario, cd_objeto, micro_visao, cd_coluna, condicao, conteudo, ligacao, st_agrupado, cd_filtro, tp_filtro, cd_criado)
        (select cd_usuario,cd_objeto,micro_visao,cd_coluna,condicao,conteudo,ligacao,st_agrupado,(select nvl(max(cd_filtro),0) from filtros )+rownum as cd_filtro,tp_filtro,cd_criado from (
		select var_usuario as cd_usuario,cd_objeto,micro_visao,cd_coluna,condicao,conteudo,ligacao,st_agrupado,tp_filtro,cd_criado
		from filtros where trim(upper(cd_usuario)) = var_usuario_cop
		minus 
		select trim(upper(cd_usuario)),cd_objeto,micro_visao,cd_coluna,condicao,conteudo,ligacao,st_agrupado,tp_filtro,cd_criado 
		from filtros where trim(upper(cd_usuario)) = var_usuario));

		insert into destaque(
		select trim(upper(cd_usuario)),cd_objeto,cd_coluna,condicao,conteudo,cor_fundo,cor_fonte,tipo_destaque,prioridade,(select nvl(max(cd_destaque),0) from destaque)+ROWNUM as cd_destaque from( 
		select var_usuario as cd_usuario,cd_objeto,cd_coluna,condicao,conteudo,cor_fundo,cor_fonte,tipo_destaque,prioridade
		from destaque where trim(upper(cd_usuario)) = var_usuario_cop
		minus
		select trim(upper(cd_usuario)),cd_objeto,cd_coluna,condicao,conteudo,cor_fundo,cor_fonte,tipo_destaque,prioridade 
		from destaque where trim(upper(cd_usuario)) = var_usuario));


		insert into float_filter_item(
		select var_usuario as cd_usuario,screen,cd_coluna,conteudo 
		from float_filter_item where trim(upper(cd_usuario)) = var_usuario_cop
		minus
		select * from float_filter_item where trim(upper(cd_usuario)) = var_usuario);

		insert into object_restriction(
		select var_usuario as usuario,cd_objeto,st_restricao,dt_last
		from object_restriction where trim(upper(usuario)) = var_usuario_cop
		minus
		select * from object_restriction where usuario = var_usuario);

		insert into parametro_usuario(
		select var_usuario as cd_usuario,cd_padrao,conteudo,pre_load
		from parametro_usuario where trim(upper(cd_usuario)) = var_usuario_cop
		minus
		select * from parametro_usuario where trim(upper(cd_usuario)) = var_usuario);

		insert into roles(
		select var_usuario as cd_usuario,cd_role,tipo
		from roles where trim(upper(cd_usuario)) = var_usuario_cop
		minus
		select * from roles where trim(upper(cd_usuario)) = var_usuario);

		insert into column_restriction(
		select var_usuario as usuario,cd_micro_visao,cd_coluna,st_restricao,dt_last
		from column_restriction where trim(upper(usuario)) = var_usuario_cop
		minus
		select * from column_restriction where trim(upper(usuario)) = var_usuario);

		insert into user_netwall (usuario, nome_regra, tipo_regra, tp_net_address, net_address, hr_inicio, hr_final, dia_semana, dt_regra)  
			(select distinct var_usuario as usuario,nome_regra,tipo_regra,tp_net_address, net_address,hr_inicio,hr_final,dia_semana,trunc(sysdate)
			from user_netwall where trim(upper(usuario)) = var_usuario_cop
			minus
			select usuario,nome_regra,tipo_regra, tp_net_address, net_address,hr_inicio,hr_final,dia_semana,trunc(sysdate) from user_netwall where trim(upper(usuario)) = var_usuario
			);
		
		-- ADICIONADO O MAX CD_CUSTOM + ROWNUM DEVIDO AO ERRO DE CONSTRAINTS 01/06/22

		insert into bi_custom_permissao(
		select var_usuario as nm_usuario,nm_visao,nm_coluna,(SELECT NVL(MAX(cd_custom),0) FROM bi_custom_permissao)+ROWNUM AS CD_CUSTOM 
		from bi_custom_permissao where trim(upper(nm_usuario)) = var_usuario_cop
		minus
		select * from bi_custom_permissao where trim(upper(nm_usuario)) = var_usuario);

		/* COMENTADO DEVIDO AO ERRO DE CONSTRAINTS
		
			insert into bi_custom_permissao(
			select var_usuario as nm_usuario,nm_visao,nm_coluna,cd_custom 
			from bi_custom_permissao where trim(upper(nm_usuario)) = var_usuario_cop
			minus
			select * from bi_custom_permissao where trim(upper(nm_usuario)) = var_usuario);
		*/

		insert into user_screens(
		select var_usuario as usuario,screen,status
		from user_screens where trim(upper(usuario)) = var_usuario_cop
		minus
		select * from user_screens where trim(upper(usuario)) = var_usuario);

	end if;

	

	htp.p('ok');

	insert into bi_log_sistema values(sysdate, 'Foram copiadas regras do usuário '||prm_usuario_cop||' para o usuário '||prm_usuario||', foi decidido '||prm_status||' as regras atuais ', user, 'EVENTO');
	commit;

exception 
	when others then 
		htp.p('erro');
		htp.p(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
		rollback;
end copiarPermissao;

procedure listContainer as

	ws_count number;
	ws_grupo varchar2(80);

begin

	htp.p('<a style="display: none;"></a>');
	htp.p('<ul class="fakelistbox open">');

		for i in (
			select usu_nome, usu_completo, count(t2.cd_group) msgs
			from usuarios t1
			left join text_post t2 on (t2.cd_usuario = t1.usu_nome and t2.cd_group = gbl.getUsuario) or (t2.cd_usuario = gbl.getUsuario and t2.cd_group = t1.usu_nome)
			where status = 'A' and 
			usu_nome <> gbl.getUsuario 
			group by t1.usu_nome, t1.usu_completo
			order by count(t2.cd_group) desc, usu_nome asc
		) loop

			select count(*) into ws_count from check_post where cd_usuario = gbl.getUsuario and nm_remetente = i.usu_nome and dt_check is null ;
			if i.msgs > 0 then
				if nvl(ws_grupo, 'N/A') = 'N/A' then
					ws_grupo := 'CONVERSAS RECENTES';
					htp.p('<li class="opt group">'||fun.lang(ws_grupo)||'</li>');
				end if;
			else
				if nvl(ws_grupo, 'N/A') = 'N/A' or ws_grupo = 'CONVERSAS RECENTES' then
					ws_grupo := 'OUTROS USU&Aacute;RIOS';
					htp.p('<li class="opt group">'||fun.lang(ws_grupo)||'</li>');
				end if;
			end if;

			if i.msgs > 0 and ws_count <> 0 then
				htp.p('<li class="opt msgs" title="'||i.usu_nome||'" data-msg="'||i.msgs||'" onclick="selectTextPost(this);">'||i.usu_nome||'</li>');
			else
				htp.p('<li class="opt" title="'||i.usu_nome||'" data-msg="'||i.msgs||'" onclick="selectTextPost(this);">'||i.usu_nome||'</li>');
			end if;
			
		end loop;

	htp.p('</ul>');

end listContainer;

procedure numericOptions( prm_number   number default 20,
					prm_selected number default 0 ) as

begin

	for i in 1..prm_number loop
		if i = prm_selected then
			htp.p('<option value="'||i||'" selected>'||i||'</option>');
		else
			htp.p('<option value="'||i||'">'||i||'</option>');
		end if;
	end loop;
end numericOptions;

procedure monta_css_var_arquivos  as 
ws_download     varchar2(200);
ws_downloadOpen varchar2(200);
begin 

	ws_download     := nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.download?arquivo=';
	ws_downloadOpen := nvl(fun.ret_var('OWNER_BI'),'DWU')||'.fcl.downloadOpen?arquivo=';	

	htp.p('<style type="text/css">'); 
	htp.p('*:root {  ');

	htp.p('   --url-img-select-loading     : url('||ws_download||'loading.gif);'); 
	htp.p('   --url-img-alteracao_lapis    : url('||ws_download||'alteracao_lapis.svg      ); '); 
	htp.p('   --url-img-ipad               : url('||ws_download||'ipad.png                 ); '); 
	htp.p('   --url-img-ipad-load          : url('||ws_download||'ipad_load.png            ); '); 	
	htp.p('   --url-img-prop_140           : url('||ws_download||'prop_140.svg             ); '); 
	htp.p('   --url-img-star               : url('||ws_download||'star.svg                 ); '); 
	htp.p('   --url-img-star_140           : url('||ws_download||'star_140.svg             ); '); 
	htp.p('   --url-img-arrow_new          : url('||ws_download||'arrow_new.svg            ); '); 
	htp.p('   --url-img-trashcan           : url('||ws_download||'trashcan.svg             ); '); 
	htp.p('   --url-img-trash_140          : url('||ws_download||'trash_140.svg            ); '); 
	htp.p('   --url-img-plus               : url('||ws_download||'plus.svg                 ); '); 
	htp.p('   --url-img-template           : url('||ws_download||'template.svg             ); '); 
	htp.p('   --url-img-db_140             : url('||ws_download||'db_140.svg               ); '); 
	htp.p('   --url-img-sort-by            : url('||ws_download||'sort-by.svg              ); '); 
	htp.p('   --url-img-multi              : url('||ws_download||'multi.png                ); '); 
	htp.p('   --url-img-attrib_140         : url('||ws_download||'attrib_140.svg           ); '); 
	htp.p('   --url-img-talk               : url('||ws_download||'talk.png                 ); '); 
	htp.p('   --url-img-talk2              : url('||ws_download||'talk2.png                ); '); 
	htp.p('   --url-img-filter_140         : url('||ws_download||'filter_140.svg           ); '); 
	htp.p('   --url-img-cascade_140        : url('||ws_download||'cascade_140.svg          ); '); 	
	htp.p('   --url-img-excel_140          : url('||ws_download||'excel_140.svg            ); '); 
	htp.p('   --url-img-data_table_140     : url('||ws_download||'data_table_140.svg       ); '); 
	htp.p('   --url-img-sigma_140          : url('||ws_download||'sigma_140.svg            ); '); 
	htp.p('   --url-img-jumpdown_checked   : url('||ws_download||'jumpdown_checked.png     ); '); 
	htp.p('   --url-img-png_140            : url('||ws_download||'png_140.svg              ); '); 
	htp.p('   --url-img-page_pdf           : url('||ws_download||'page_pdf.png	           ); '); 
	htp.p('   --url-img-reorder            : url('||ws_download||'reorder.gif              ); '); 
	htp.p('   --url-img-exc                : url('||ws_download||'exc.png                  ); '); 
	htp.p('   --url-img-pell-centeralign   : url('||ws_download||'centeralign.svg          ); '); 
	htp.p('   --url-img-pell-leftalign     : url('||ws_download||'leftalign.svg            ); '); 
	htp.p('   --url-img-pell-rightalign    : url('||ws_download||'rightalign.svg           ); '); 
	htp.p('   --url-img-pell-fullalign     : url('||ws_download||'fullalign.svg            ); '); 
	
	htp.p('   --url-img-pell-fontsize      : url('||ws_download||'fontsize.svg             ); '); 
	htp.p('   --url-img-limpa-filtro       : url('||ws_download||'limpa-filtro.svg         ); '); 
	htp.p('   --url-img-anotacao_canto     : url('||ws_download||'anotacao_canto.svg       ); '); 

	htp.p('   --url-img-login-background   : url('||ws_downloadOpen||'background           ); '); 
	htp.p('   --url-img-login-logo         : url('||ws_downloadOpen||'logo                 ); '); 
	htp.p('   --url-img-sinchronize        : url('||ws_downloadOpen||'sinchronize          ); '); 
	htp.p('   --url-img-unlock             : url('||ws_downloadOpen||'unlock               ); '); 

	htp.p('       }' ); 
	htp.p('</style>'); 


end monta_css_var_arquivos; 

procedure valida_formula_navegador (prm_tipo            in varchar2 default 'COLUNA', 
									prm_formula         in varchar2 default null,
									prm_screen          in varchar2 default null,
									prm_objeto          in varchar2 default null,
									prm_visao           in varchar2 default null,
									prm_coluna          in varchar2 default null) as 
	ws_retorno varchar2(500); 
	ws_formula varchar2(32000);
begin 
	ws_retorno := null; 
	ws_formula := fun.converte(prm_formula);
	fun.valida_formula (prm_tipo, ws_formula, prm_screen, prm_objeto, prm_visao, prm_coluna, prm_retorno => ws_retorno); 
	htp.p(ws_retorno); 
exception when others then 
	htp.p('ERRO|Erro validando f&oacute;rmula.'); 	
end valida_formula_navegador; 									

procedure anotacao_grava ( prm_objeto     		 varchar2,
						prm_screen     		 varchar2, 
						prm_usuario    		 varchar2 default null,
						prm_coluna     		 varchar2,
						prm_condicao   		 varchar2 default null,
						prm_anotacao   		 varchar2 default null,
						prm_usuario_permissao varchar2 default 'DWU' ) is 
	ws_objeto   	varchar2(200); 
	ws_filtros  	varchar2(4000); 
	ws_anot_texto	varchar2(32000); 
	ws_usua_perm    varchar2(32000);
	ws_usuario      varchar2(100);

begin 
	ws_usuario := prm_usuario;
	if ws_usuario is null then 
		ws_usuario :=  gbl.getUsuario;
	end if; 

	ws_objeto := fun.get_cd_obj(prm_objeto);  

	-- Busca filtros do objeto para garantir que a anotação seja referente a informação cadastrada 		
	core.MONTA_FILTRO ( 'TEXTO_BIND', ws_objeto, prm_screen, null, null, ws_usuario, ws_filtros) ;  -- Busca os filtros do objeto aplicados ao objeto 

	ws_filtros := replace(ws_filtros,' ');  -- Retira espaços em branco 

	update bi_object_anotacao 
	set ds_anotacao  		  = prm_anotacao,
		usuario_permissao      = nvl(prm_usuario_permissao,'DWU'),
		dh_anotacao            = sysdate 
	where cd_object    		  = ws_objeto
	and nm_usuario   	 	  = ws_usuario
	and cd_coluna      		  = prm_coluna
	and cd_condicao  		  = prm_condicao
	and nvl(cd_filtro,'NA')    = nvl(ws_filtros,'NA'); 

	if sql%notfound then 
		insert into bi_object_anotacao (cd_object,  nm_usuario,  cd_coluna,  cd_condicao, cd_filtro,  ds_anotacao, dh_anotacao, usuario_permissao) 
								values (ws_objeto, ws_usuario,  prm_coluna, prm_condicao, ws_filtros, prm_anotacao, sysdate, nvl(prm_usuario_permissao,'DWU') ); 
	end if; 
	commit; 
	
	ws_usua_perm := ws_usuario; 
	fcl.anotacao_texto ( 'HTML_USUARIO', prm_objeto, prm_screen, null, prm_coluna, prm_condicao, ws_usua_perm, ws_anot_texto);	

	htp.p('OK|Anota&ccedil;&atilde;o gravada com sucesso|'||ws_anot_texto); 

exception 
	when others then 
		htp.p('ERRO|'||fun.lang('Erro gravando anota&ccedil;&atilde;o, verifique o log ou informe o administrador do sistema'));
		insert into bi_log_sistema values (sysdate, 'anotacao_grava:'||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, ws_usuario, 'ERRO');
		commit; 								
end anotacao_grava; 						   


procedure anotacao_exclui( prm_objeto     varchar2,
						prm_screen     varchar2, 
						prm_usuario    varchar2 default null,
						prm_coluna     varchar2,
						prm_condicao   varchar2 default null ) is 
	ws_objeto   	varchar2(200);
	ws_filtros  	varchar2(32000); 
	ws_anot_texto	varchar2(32000); 
	ws_usua_perm    varchar2(32000);
	ws_usuario  	varchar2(100);
begin 
	ws_usuario := prm_usuario;
	if ws_usuario is null then 
		ws_usuario :=  gbl.getUsuario;
	end if; 

	ws_objeto := fun.get_cd_obj(prm_objeto);  

	-- Busca filtros do objeto para garantir que a anotação seja referente a informação cadastrada 		
	core.MONTA_FILTRO ( 'TEXTO_BIND', ws_objeto, prm_screen, null, null, ws_usuario, ws_filtros) ;  -- Busca os filtros do objeto aplicados ao objeto 

	ws_filtros := replace(ws_filtros,' ');  -- Retira espaços em branco 
	
	delete bi_object_anotacao 
	where cd_object    		  = ws_objeto
	and nm_usuario  		      = ws_usuario
	and cd_coluna    		  = prm_coluna
	and cd_condicao  	      = prm_condicao
	and nvl(cd_filtro,'NA')    = nvl(ws_filtros,'NA'); 
	commit; 

	ws_usua_perm := ws_usuario; 
	fcl.anotacao_texto ( 'HTML_USUARIO', prm_objeto, prm_screen, null, prm_coluna, prm_condicao, ws_usua_perm, ws_anot_texto);	

	htp.p('OK|Anota&ccedil;&atilde;o excluida com sucesso|'||ws_anot_texto); 

exception 
	when others then 
		htp.p('ERRO|'||fun.lang('Erro excluindo anota&ccedil;&atilde;o, verifique o log ou informe o administrador do sistema'));
		insert into bi_log_sistema values (sysdate, 'anotacao_grava:'||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, ws_usuario, 'ERRO');
		commit; 								
end anotacao_exclui;  

procedure anotacao_texto ( prm_tipo           	 varchar2 default 'TEXTO', 
                           prm_objeto         	 varchar2,
 						   prm_screen         	 varchar2, 
						   prm_usuario        	 varchar2 default null,   -- Usuário que fez a anotação 
						   prm_coluna            varchar2,
						   prm_condicao          varchar2 default null,
						   prm_usua_perm  in out varchar2,                -- Usuário que deseja visualizar a anotação 
						   prm_anotacao      out varchar2 ) is 
	ws_usuario        varchar2(100);
	ws_arr_anot       arr_anotacao; 
	ws_count    number; 
begin 
	ws_usuario := nvl(prm_usua_perm, gbl.getUsuario);

	fcl.anotacao_monta_anot ( prm_objeto, prm_screen, ws_arr_anot);

	if ws_arr_anot.count > 0 then 
		fcl.anotacao_busca_anot ( prm_tipo, prm_objeto, prm_screen, prm_usuario, prm_coluna, prm_condicao, ws_arr_anot, prm_usua_perm, prm_anotacao); 
	else 
		prm_usua_perm := null;
		prm_anotacao  := null;
	end if; 	

exception 
	when others then 
		insert into bi_log_sistema values (sysdate, 'anotacao_texto:'||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, ws_usuario, 'ERRO');
		commit; 								
end anotacao_texto;  


procedure anotacao_monta_anot ( prm_objeto            varchar2,
 					 	        prm_screen            varchar2, 
								prm_arr_anot      out arr_anotacao ) is 
	ws_objeto         varchar2(200);
	ws_usuario        varchar2(200); 
	ws_filtros        varchar2(32000); 
	ws_idx            integer; 
	ws_arr_anot       arr_anotacao; 

begin 
	ws_usuario      := gbl.getUsuario;
	ws_objeto       := fun.get_cd_obj(prm_objeto);  
    prm_arr_anot.delete;
	
	-- Busca filtros do objeto para garantir que a anotação seja referente a informação cadastrada 
	core.MONTA_FILTRO ( 'TEXTO_BIND', ws_objeto, prm_screen, null, null, ws_usuario, ws_filtros) ;  -- Busca os filtros do objeto aplicados ao objeto 
	ws_filtros := replace(ws_filtros,' ');  -- Retira espaços em branco 
	ws_idx     := 0;

	for a in (select * from bi_object_anotacao
			   where cd_object           = ws_objeto
				 and nvl(cd_filtro,'NA') = nvl(ws_filtros, 'NA')
			   order by cd_coluna, usuario_permissao, cd_condicao ) loop -- Pega anotação de todos os usuários ou somente de um

		ws_idx := ws_idx + 1; 
		prm_arr_anot(ws_idx).cd_coluna         := a.cd_coluna; 		
		prm_arr_anot(ws_idx).nm_usuario        := a.nm_usuario; 
		prm_arr_anot(ws_idx).cd_condicao       := a.cd_condicao; 
		prm_arr_anot(ws_idx).usuario_permissao := a.usuario_permissao; 
		prm_arr_anot(ws_idx).ds_anotacao       := a.ds_anotacao; 
	end loop; 				

exception 
	when others then 
		insert into bi_log_sistema values (sysdate, 'anotacao_monta_anot:'||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, ws_usuario, 'ERRO');
		commit; 								
end anotacao_monta_anot;  




procedure anotacao_busca_anot ( prm_tipo         	  varchar2 default 'TEXTO', 
                                prm_objeto         	  varchar2,
 						        prm_screen         	  varchar2, 
						        prm_usuario        	  varchar2 default null,   -- Usuário que fez a anotação 
						        prm_coluna            varchar2,
						        prm_condicao          varchar2 default null,
								prm_arr_anot          arr_anotacao, 
								prm_usua_perm  in out varchar2,                -- Usuário que deseja visualizar a anotação 
						        prm_anotacao      out varchar2 ) is 
	-- prm_tipo
	--   - TEXTO        - Texto (sem usuário no texto)
	--   - TEXTO_USARIO - Texto (com usuário no inicio do texto)
	--   - HTML         - Html  (sem usuário no texto) 
	--   - HTML_USUARIO - Html  (com usuário no inicio do texto)

	ws_count1 integer;
	ws_count2 integer;
	ws_count3 integer;
	ws_count4 integer;

	ws_objeto         varchar2(200);
	ws_adm            varchar2(20); 
	ws_usuario        varchar2(100);
	ws_usuario_anot   varchar2(100); 
	ws_usuario_ant    varchar2(100); 
	ws_usua_perm      varchar2(32000); 
	ws_anotacao       varchar2(32000); 
	ws_condicao       varchar2(4000); 
	ws_enter          varchar2(50);  
	ws_tem_permissao  varchar2(1); 
	ws_arr_anot       arr_anotacao; 

begin 
	ws_usuario      := nvl(prm_usua_perm, gbl.getUsuario);
	ws_adm          := gbl.getNivel(ws_usuario);
	
	ws_usuario_anot := prm_usuario;       -- Usuário dono da anotação 
	ws_objeto       := fun.get_cd_obj(prm_objeto);  
	ws_condicao     := trim(prm_condicao); 
	if ws_condicao in ('|', '||') then 
		ws_condicao := null;
	end if; 	

	if prm_tipo like 'HTML%' then  
		ws_enter := '<hr>';
	else 	
		ws_enter := chr(13)||chr(10); 
	end if;	

	prm_anotacao   := null;
	prm_usua_perm  := null; 
 	ws_anotacao    := null;
	ws_usuario_ant := null;

	for a in 1..prm_arr_anot.count loop 

		if prm_coluna = prm_arr_anot(a).cd_coluna and prm_arr_anot(a).nm_usuario = nvl(ws_usuario_anot,prm_arr_anot(a).nm_usuario)   then

			-- Verifica se o usuário tem permissao de visualiar a anotação 
			ws_tem_permissao := 'N';
			if ws_adm = 'A' or ws_usuario in ('DWU',prm_arr_anot(a).nm_usuario) then -- é ADM ou mesmo usuário que criou  
				ws_tem_permissao := 'S';
			elsif instr('|'||prm_arr_anot(a).usuario_permissao||'|', '|DWU|') > 0 then   -- Está liberado para todos 
				ws_tem_permissao := 'S';
			elsif instr('|'||prm_arr_anot(a).usuario_permissao||'|', '|'||ws_usuario||'|' ) > 0 then   -- Usuário está entre os liberados
				ws_tem_permissao := 'S';
			else 
				for b in (select * from gusers_itens where cd_usuario = ws_usuario) loop 
					if instr('|'||prm_arr_anot(a).usuario_permissao||'|', '|'||b.cd_group||'|' ) > 0 then   -- Se o grupo do usuário estiver entre os liberados 
						ws_tem_permissao := 'S';
					end if; 
				end loop; 		
			end if; 

			if ws_tem_permissao = 'S' then 

				-- Verifica se condição e parametro é igual ao registrado na anotação 			
				ws_count1 := 0;
				ws_count2 := 0;
				ws_count3 := 0;
				ws_count4 := 0;
				select count(*) into ws_count1 from ( select * from table(fun.vpipe_par(prm_arr_anot(a).cd_condicao)) minus 
													  select * from table(fun.vpipe_par(ws_condicao))	); 				
				select count(*) into ws_count2 from ( select * from table(fun.vpipe_par(ws_condicao)) minus 
													  select * from table(fun.vpipe_par(prm_arr_anot(a).cd_condicao))	);

				if (ws_count1 + ws_count2 + ws_count3 + ws_count4) = 0 then 

					if nvl(ws_usuario_ant,'NA') <> prm_arr_anot(a).nm_usuario and prm_tipo like '%USUARIO' then 
						if ws_anotacao is not null then 
							ws_anotacao := ws_anotacao || ws_enter;
						end if;
						ws_anotacao := ws_anotacao ||'('||prm_arr_anot(a).nm_usuario||') '; 					
					end if; 

					ws_anotacao  := ws_anotacao || prm_arr_anot(a).ds_anotacao; 
					ws_usua_perm := prm_arr_anot(a).usuario_permissao; 
				end if; 

			end if; 
			ws_usuario_ant := prm_arr_anot(a).nm_usuario; 
		end if; 
	end loop; 				

	prm_anotacao  := ws_anotacao; 
	prm_usua_perm := ws_usua_perm; 
exception 
	when others then 
		insert into bi_log_sistema values (sysdate, 'anotacao_busca_anot:'||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, ws_usuario, 'ERRO');
		commit; 								
end anotacao_busca_anot;  




procedure anotacao_show( prm_objeto     varchar2, 
						prm_screen     varchar2 default null,
						prm_coluna     varchar2 default null,
						prm_condicao   varchar2 default null ) as
	
	ws_anot_texto        varchar2(32000); 
	ws_usua_perm         varchar2(32000); 
	ws_objeto            varchar2(200); 
	ws_usuario    varchar2(100); 
	ws_admin      varchar2(30); 
begin

	ws_usuario   := gbl.getUsuario;
	ws_admin     := nvl(gbl.getNivel(ws_usuario),'N');
	ws_objeto    := fun.get_cd_obj(prm_objeto);
	ws_usua_perm := ws_usuario; 

	fcl.anotacao_texto ( 'TEXTO_USUARIO', ws_objeto, prm_screen, null, prm_coluna, prm_condicao, ws_usua_perm, ws_anot_texto);

	htp.prn('<div id="anotacao_show">');
		htp.p('<a class="fechartab">x</a>');
		htp.p('<textarea id="anotacao_texto" readonly >'||ws_anot_texto||'</textarea>');
	htp.prn('</div>');

exception 
	when others then 
		insert into bi_log_sistema values (sysdate, 'anotacao_show:'||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, ws_usuario, 'ERRO');
		commit; 	
end anotacao_show;

----------------------------------------------------------------------------------------------------------------------------------------------------------------
procedure menu_etl (prm_menu      varchar2, 
		            prm_tipo      varchar2 default null,
					prm_id_copia  varchar2 default null) as 
	ws_step    etl_step%rowtype; 
	ws_onkeypress      varchar2(500); 
	ws_onkeypress_int  varchar2(500); 
	ws_onkeypress_cod  varchar2(500); 
	ws_onkeypress_num  varchar2(500); 
	ws_onkeypress_pipe varchar2(500); 
	ws_param           varchar2(4000); 
	ws_title           varchar2(300); 
	ws_tipo_comando    varchar2(200);

begin 

	ws_onkeypress      := ' onkeypress="proxCampo(event,this);"'; 
	ws_onkeypress_int  := ' onkeypress="if(!input(event, ''integer'')) {event.preventDefault();} else {proxCampo(event,this);}"'; 
	ws_onkeypress_cod  := ' onkeypress="if(!input(event, ''ID''))      {event.preventDefault();} else {proxCampo(event,this);}"'; 		
	ws_onkeypress_pipe := ' onkeypress="if(!input(event, ''nopipe''))      {event.preventDefault();} else {proxCampo(event,this);}"'; 		

	case 
	when prm_menu = 'etl_conexoes' then 	

		htp.p('<h4>'||fun.lang('CONEX&Otilde;ES')||'</h4>');

		htp.p('<span class="script" onclick="call(''menu_etl'', ''prm_menu=etl_conexoes&prm_tipo=''+this.nextElementSibling.title, ''fcl'').then(function(resposta){ '||
		       ' if(resposta.indexOf(''ERRO|'') == -1){ alerta(''feed-fixo'', resposta.split(''|'')[1]); } else { document.getElementById(''painel'').innerHTML = resposta; }  });"></span>');
		fcl.fakeoption('prm_db', fun.lang('TIPO CONEX&Atilde;O'), prm_tipo, 'lista-etl-db', 'N', 'N', null);

		if prm_tipo is not null then 
			ws_param := 'prm_id_conexao|prm_db'; 
			htp.p('<input type="text" id="prm_id_conexao" title="Informe um c&oacute;digo indentificador para a conex&atilde;o"  data-min="1"  placeholder="ID CONEX&Atilde;O" data-encode="S" class="up" '||ws_onkeypress||'/>');
			for a in (select cd_parametro, nm_parametro from etl_tipo_conexao where tp_conexao = prm_tipo and tp_parametro = 'CONEXAO' order by ordem_tela) loop 
				htp.p('<input type="text" id="prm_'||a.cd_parametro||'" data-min="1" placeholder="'||upper(a.nm_parametro)||'" data-encode="S" '||ws_onkeypress||'/>');
				ws_param := ws_param||'|prm_'||a.cd_parametro; 
			end loop;

			htp.p('<a class="addpurple followed" title="'||fun.lang('Adicionar conex&atilde;o')||'" data-sup="etl_conexoes" '||  
		           'data-req="etl_conexoes_insert" data-par-agrupa="S" data-par="'||ws_param||'" '||
				   'data-res="etl_conexoes_list" data-msg="'||fun.lang('Adicionado com sucesso')||'" data-pkg="etl">'||fun.lang('ADICIONAR')||'</a>');
		end if; 
	when prm_menu = 'etl_step' then

		htp.p('<h4>'||fun.lang('A&Ccedil;&Otilde;ES / COMANDOS')||'</h4>');

		htp.p('<span class="script" onclick="call(''menu_etl'', ''prm_menu=etl_step&prm_tipo=''+this.nextElementSibling.title, ''fcl'').then(function(resposta){ '||
		      ' if(resposta.indexOf(''ERRO|'') == -1){ alerta(''feed-fixo'', resposta.split(''|'')[1]); } else { document.getElementById(''painel'').innerHTML = resposta; }  });"></span>');
		fcl.fakeoption('prm_tipo_execucao', fun.lang('TIPO EXECU&Ccedil;&Atilde;O'), prm_tipo, 'lista-etl-tipo-execucao', 'N', 'N', null);				

		if prm_tipo is not null then 
			
			ws_step := null;
			if prm_id_copia is not null then 
				select * into ws_step from etl_step where step_id = prm_id_copia;  
			end if; 
			htp.p('<input type="hidden" id="prm_id_copia"   value="'||prm_id_copia||'">');	

			if prm_tipo <> 'PL/SQL' then
				if prm_id_copia is null then 
					fcl.fakeoption('prm_id_conexao', fun.lang('Conex&atilde;o'), null, 'lista-etl-conexao', 'N', 'N', null);
				else 
					htp.p('<input type="hidden"   id="prm_id_conexao"     values="'||ws_step.id_conexao||'">');	 
				end if; 	
			else 	
				htp.p('<input type="hidden"   id="prm_id_conexao"     values="">');	
			end if; 
			
			ws_tipo_comando := null;
			if prm_id_copia is not null then 
				ws_tipo_comando := ws_step.tipo_comando;
			end if; 

			htp.p('<span class="script" onclick="let vid = ''''; if (document.getElementById(''prm_tipo_comando'').title==''FULL''){vid=''ETL_TAUX_'';}else{vid=''ETL_V_'';}; document.getElementById(''prm_step_id'').value=vid; document.getElementById(''prm_tbl_destino'').value=vid; "></span>');
			fcl.fakeoption('prm_tipo_comando', fun.lang('TIPO COMANDO'), ws_tipo_comando, 'lista-etl-tipo-comando', 'N', 'N', null);				

			htp.p('<input type="text"   id="prm_step_id"   data-min="1" data-encode="N" placeholder="'||fun.lang('ID')||'" class="up" '||ws_onkeypress_cod||
			      'onchange="document.getElementById(''prm_tbl_destino'').value = document.getElementById(''prm_step_id'').value.toUpperCase();"  value="'||ws_step.step_id||'" />');
			if prm_tipo <> 'PL/SQL' then
				htp.p('<input type="text"   id="prm_tbl_destino"    data-min="1" data-encode="S" placeholder="'||fun.lang('TABELA DE DESTINO') ||'" '||ws_onkeypress_cod||' value="'||ws_step.tbl_destino||'">');	
			else 	
				htp.p('<input type="hidden"   id="prm_tbl_destino"    values="">');	
			end if; 

			htp.p('<a class="addpurple followed" title="'||fun.lang('Adicionar A&ccedil;&atilde;o')||'" data-sup="etl_step"'||  
	        	   'data-req="etl_step_insert" data-par="prm_step_id|prm_tipo_execucao|prm_tipo_comando|prm_id_conexao|prm_tbl_destino|prm_id_copia" '||
			   	   'data-res="etl_step_list" data-msg="'||fun.lang('Adicionado com sucesso')||'" data-pkg="etl">'||fun.lang('ADICIONAR')||'</a>');
		end if; 
	when prm_menu = 'etl_run' then 	

		htp.p('<h4>'||fun.lang('TAREFAS')||'</h4>');
		htp.p('<input type="hidden" id="painel-atributos" data-refresh="etl_run_list" data-refresh-ativo="S" data-pkg="etl">');

		htp.p('<input type="text"   id="prm_ds_run"   data-min="1" data-encode="S" placeholder="'||fun.lang('DESCRI&Ccedil&Atilde;O TAREFA')||'" '||ws_onkeypress_pipe||'/>');

		htp.p('<a class="addpurple followed" title="'||fun.lang('Adicionar Tarefa')||'" data-sup="etl_run"'||  
	           'data-req="etl_run_insert" data-par="prm_ds_run" '||
			   'data-res="etl_run_list" data-msg="'||fun.lang('Adicionado com sucesso')||'" data-pkg="etl">'||fun.lang('ADICIONAR')||'</a>');
	
	when prm_menu = 'etl_schedule' then 	
		htp.p('<h4>'||fun.lang('HOR&Aacute;RIO AGENDAMENTO')||'</h4>');
		htp.p('<input type="hidden" id="painel-atributos" data-refresh="" data-pkg="" >');

        -- script para alterar a obrigatoriedade
        -- htp.p('<a class="script" onclick="
        -- "></a>');
		fcl.fakeoption('prm_p_semana', fun.lang('Dias da semana'), '', 'lista-semanas', 'N', 'S');
		fcl.fakeoption('prm_p_dia_mes', fun.lang('Dias do m&ecirc;s'), '', 'lista-dia-mes', 'N', 'S'); 
        fcl.fakeoption('prm_p_mes', fun.lang('Meses'), '', 'lista-meses', 'N', 'S', prm_min => 1);
		fcl.fakeoption('prm_p_hora', fun.lang('Hora'), '', 'lista-horas', 'N', 'S', prm_min => 1);
		fcl.fakeoption('prm_p_quarter', fun.lang('Minuto'), '', 'lista-minutos', 'N', 'S', prm_min => 1);		

		htp.p('<a class="addpurple followed" title="'||fun.lang('Adicionar agendamento')||'" data-sup="etl_schedule"'||  
	           'data-req="etl_schedule_insert" data-par="prm_run_id|prm_p_semana|prm_p_mes|prm_p_hora|prm_p_quarter|prm_p_dia_mes" '||
			   'data-res="etl_schedule_list" data-res-par="prm_run_id" data-msg="'||fun.lang('Adicionado com sucesso')||'" data-pkg="etl">'||fun.lang('ADICIONAR')||'</a>');
	when prm_menu = 'etl_run_step' then 	

		htp.p('<h4>'||fun.lang('TAREFAS / A&Ccedil;&Otilde;ES')||'</h4>');
		htp.p('<input type="hidden" id="painel-atributos" data-refresh="etl_run_step_list" data-refresh-ativo="N" data-pkg="etl" >');

		htp.p('<input type="text" id="prm_ordem" data-min="1" data-encode="N" placeholder="'||fun.lang('ORDEM EXECU&Ccedil;&Atilde;O') ||'" '||ws_onkeypress_int||' style="display:block;" >');
		fcl.fakeoption('prm_step_id', fun.lang('A&ccedil;&atilde;o'), null, 'lista-etl-step', 'N', 'N', null);				

		htp.p('<a class="addpurple followed" title="'||fun.lang('Adicionar a&ccedil;&atilde;o na tarefa')||'" data-sup="etl_run_step"'||  
	           'data-req="etl_run_step_insert" data-par="prm_run_id|prm_ordem|prm_step_id" '||
			   'data-res="etl_run_step_list" data-res-par="prm_run_id" data-msg="'||fun.lang('Adicionado com sucesso')||'" data-pkg="etl">'||fun.lang('ADICIONAR')||'</a>');

	when prm_menu = 'etl_step_param' then 	

		htp.p('<h4>'||fun.lang('PAR&Acirc;METROS EXECU&Ccedil;&Atilde;O')||'</h4>');
		htp.p('<input type="hidden" id="painel-atributos" data-refresh="" data-pkg="etl" >');

		htp.p('<input type="text"   id="prm_cd_parametro" data-min="1" data-encode="N" placeholder="'||fun.lang('NOME/ID')||'" class="up" '||ws_onkeypress_cod||'/>');
		htp.p('<input type="text"   id="prm_ds_parametro" data-min="1" data-encode="S" placeholder="'||fun.lang('DESCRI&Ccedil;&Atilde;O') ||'" '||ws_onkeypress||'>');
		
		htp.p('<a class="addpurple followed" title="'||fun.lang('Adicionar a&ccedil;&atilde;o na tarefa')||'" data-sup="etl_step_param"'||  
	           'data-req="etl_step_param_insert" data-par="prm_step_id|prm_cd_parametro|prm_ds_parametro" '||
			   'data-res="etl_step_param_list" data-res-par="prm_step_id" data-msg="'||fun.lang('Adicionado com sucesso')||'" data-pkg="etl">'||fun.lang('ADICIONAR')||'</a>');

	end case; 

exception when others then 
   	insert into bi_log_sistema values(sysdate, 'menu_etl (others) :'||DBMS_UTILITY.FORMAT_ERROR_STACK||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, gbl.getusuario, 'ERRO');
	commit;
	htp.p('ERRO|Erro montando tela, verifique o log de erros do sistema'); 
end menu_etl; 


Procedure traducao_colunas_inserir as
	v_sql         varchar2(32767);
	v_cursor      number;
	ws_codigo     varchar2(4000);
	ws_texto      varchar2(4000);
	ws_objeto     varchar2(4000);
	dummy         number;
	v_ret         number;
Begin
	
	for ws_seq in (select CD_TABELA, CD_COLUNA, TIPO from TRADUCOES_PASSIVAS	order by TIPO ) loop 

		if  ws_seq.tipo in ('O') then
			v_sql := 'select cd_objeto, '||ws_seq.cd_coluna||' from OBJETOS where nvl(trim('||ws_seq.cd_coluna||'),'||CHR(39)||'%NOREG%'||CHR(39)||')<>'||chr(39)||'%NOREG%'||chr(39);
		end if;

		if  ws_seq.tipo in ('T','F') then
			v_sql := 'select 0 as dado, '||ws_seq.cd_coluna||' from '||nvl(fun.ret_var('OWNER_BI'),'DWU')||'.'||ws_seq.cd_tabela||' where nvl(trim('||ws_seq.cd_coluna||'),'||CHR(39)||'%NOREG%'||CHR(39)||')<>'||chr(39)||'%NOREG%'||chr(39);
		end if;

		if  ws_seq.tipo in ('C') then
			v_sql := 'select cd_micro_visao as dado, '||ws_seq.cd_coluna||' from MICRO_COLUNA where nvl(trim('||ws_seq.cd_coluna||'),'||CHR(39)||'%NOREG%'||CHR(39)||')<>'||chr(39)||'%NOREG%'||chr(39);
		end if;

		v_cursor := dbms_sql.open_cursor;
		dbms_sql.parse(v_cursor, v_sql, dbms_sql.NATIVE);
		Dbms_Sql.Define_Column(V_Cursor,1,ws_codigo, 4000);
		Dbms_Sql.Define_Column(V_Cursor,2,ws_texto,  4000);

		dummy := dbms_sql.execute(v_cursor);
		loop
			V_Ret := Dbms_Sql.Fetch_Rows(V_Cursor);
			exit when v_ret = 0;
			Dbms_Sql.Column_Value(V_Cursor,1,ws_codigo);
			Dbms_Sql.Column_Value(V_Cursor,2,ws_texto);

			if  ws_seq.TIPO in ('O','C') then
				ws_objeto := ws_codigo;
			else
				ws_objeto := ws_seq.CD_TABELA;
			end if;

			for a in (	select 'ENGLISH'  cd_linguagem from dual union all 
						select 'SPANISH'  cd_linguagem from dual union all 
						select 'ITALIAN'  cd_linguagem from dual union all 
						select 'GERMAN'   cd_linguagem from dual ) loop 

				update TRADUCAO_COLUNAS
				   set texto = decode(nvl(fixa,'N'),'N',null,texto)  -- Só limpa se não ainda não foi fixada a tradução
				 where cd_tabela    = ws_objeto 
			  	   and cd_coluna    = ws_seq.CD_COLUNA 
			  	   and lang_default = ws_texto         
			  	   and tipo         = ws_seq.TIPO
			  	   and cd_linguagem = a.cd_linguagem;

				if sql%notfound then 
					insert into TRADUCAO_COLUNAS values (ws_objeto,ws_seq.CD_COLUNA, a.cd_linguagem, null, ws_texto, ws_seq.TIPO, 'N');
				end if;    
			end loop; 				

			commit;

		end loop;
		dbms_sql.close_cursor(v_cursor);

	end loop;

END traducao_colunas_inserir;

Procedure traducao_colunas_traduzir (prm_linguagem varchar2, 
									prm_nro_reg    integer) as 
	ws_conversao     varchar2(4000);
	ws_traduzido     varchar2(4000);
	ws_id_idioma     varchar2(2); 
Begin

	if    prm_linguagem = 'ENGLISH' then   ws_id_idioma := 'en'; 
	elsif prm_linguagem = 'SPANISH' then   ws_id_idioma := 'es'; 
	elsif prm_linguagem = 'ITALIAN' then   ws_id_idioma := 'it'; 	
	elsif prm_linguagem = 'GERMAN'  then   ws_id_idioma := 'de'; 
	end if; 
	
	for a in (select * from TRADUCAO_COLUNAS 
                where cd_linguagem  = prm_linguagem
                  and nvl(fixa,'N') <> 'S'
                  and texto is null
                  and rownum <= prm_nro_reg ) loop 

		ws_conversao := a.lang_default;
		ws_conversao := replace(replace(replace(replace(ws_conversao,CHR(50051),'A'),chr(50083),'a'),chr(50101),'o'),CHR(50069),'O');
		ws_conversao := replace(ws_conversao,'&aacute;'  ,'a');
		ws_conversao := replace(ws_conversao,'&atilde;'  ,'a');
		ws_conversao := replace(ws_conversao,'&acirc;'   ,'a');
		ws_conversao := replace(ws_conversao,'&agrave;'  ,'a');
		ws_conversao := replace(ws_conversao,'&eacute;'  ,'e');
		ws_conversao := replace(ws_conversao,'&ecirc;'   ,'e');
		ws_conversao := replace(ws_conversao,'&iacute;'  ,'i');
		ws_conversao := replace(ws_conversao,'&oacute;'  ,'o');
		ws_conversao := replace(ws_conversao,'&otilde;'  ,'o');
		ws_conversao := replace(ws_conversao,'&ocirc;'   ,'o');
		ws_conversao := replace(ws_conversao,'&uacute;'  ,'u');
		ws_conversao := replace(ws_conversao,'&ccedil;'  ,'c');
		ws_conversao := replace(ws_conversao,'&Aacute;'  ,'A');
		ws_conversao := replace(ws_conversao,'&Atilde;'  ,'A');
		ws_conversao := replace(ws_conversao,'&Acirc;'   ,'A');
		ws_conversao := replace(ws_conversao,'&Agrave;'  ,'A');
		ws_conversao := replace(ws_conversao,'&Eacute;'  ,'E');
		ws_conversao := replace(ws_conversao,'&Ecirc;'   ,'E');
		ws_conversao := replace(ws_conversao,'&Iacute;'  ,'I');
		ws_conversao := replace(ws_conversao,'&Oacute;'  ,'O');
		ws_conversao := replace(ws_conversao,'&Otilde;'  ,'O');
		ws_conversao := replace(ws_conversao,'&Ocirc;'   ,'O');
		ws_conversao := replace(ws_conversao,'&Uacute;'  ,'U');
		ws_conversao := replace(ws_conversao,'&Ccedil;'  ,'C');      
		ws_conversao := replace(ws_conversao,'\u00e1', 'a'); 
		ws_conversao := replace(ws_conversao,'\u00e0', 'a'); 
		ws_conversao := replace(ws_conversao,'\u00e2', 'a'); 
		ws_conversao := replace(ws_conversao,'\u00e3', 'a'); 
		ws_conversao := replace(ws_conversao,'\u00e4', 'a'); 
		ws_conversao := replace(ws_conversao,'\u00c1', 'A'); 
		ws_conversao := replace(ws_conversao,'\u00c0', 'A'); 
		ws_conversao := replace(ws_conversao,'\u00c2', 'A'); 
		ws_conversao := replace(ws_conversao,'\u00c3', 'A'); 
		ws_conversao := replace(ws_conversao,'\u00c4', 'A'); 
		ws_conversao := replace(ws_conversao,'\u00e9', 'e'); 
		ws_conversao := replace(ws_conversao,'\u00e8', 'e'); 
		ws_conversao := replace(ws_conversao,'\u00ea', 'e'); 
		ws_conversao := replace(ws_conversao,'\u00ea', 'e'); 
		ws_conversao := replace(ws_conversao,'\u00c9', 'E'); 
		ws_conversao := replace(ws_conversao,'\u00c8', 'E'); 
		ws_conversao := replace(ws_conversao,'\u00ca', 'E'); 
		ws_conversao := replace(ws_conversao,'\u00cb', 'E'); 
		ws_conversao := replace(ws_conversao,'\u00ed', 'i'); 
		ws_conversao := replace(ws_conversao,'\u00ec', 'i'); 
		ws_conversao := replace(ws_conversao,'\u00ee', 'i'); 
		ws_conversao := replace(ws_conversao,'\u00ef', 'i'); 
		ws_conversao := replace(ws_conversao,'\u00cd', 'I'); 
		ws_conversao := replace(ws_conversao,'\u00cc', 'I'); 
		ws_conversao := replace(ws_conversao,'\u00ce', 'I'); 
		ws_conversao := replace(ws_conversao,'\u00cf', 'I'); 
		ws_conversao := replace(ws_conversao,'\u00f3', 'o'); 
		ws_conversao := replace(ws_conversao,'\u00f2', 'o'); 
		ws_conversao := replace(ws_conversao,'\u00f4', 'o'); 
		ws_conversao := replace(ws_conversao,'\u00f5', 'o'); 
		ws_conversao := replace(ws_conversao,'\u00f6', 'o'); 
		ws_conversao := replace(ws_conversao,'\u00d3', 'O'); 
		ws_conversao := replace(ws_conversao,'\u00d2', 'O'); 
		ws_conversao := replace(ws_conversao,'\u00d4', 'O'); 
		ws_conversao := replace(ws_conversao,'\u00d5', 'O'); 
		ws_conversao := replace(ws_conversao,'\u00d6', 'O'); 
		ws_conversao := replace(ws_conversao,'\u00fa', 'u'); 
		ws_conversao := replace(ws_conversao,'\u00f9', 'u'); 
		ws_conversao := replace(ws_conversao,'\u00fb', 'u'); 
		ws_conversao := replace(ws_conversao,'\u00fc', 'u'); 
		ws_conversao := replace(ws_conversao,'\u00da', 'U'); 
		ws_conversao := replace(ws_conversao,'\u00d9', 'U'); 
		ws_conversao := replace(ws_conversao,'\u00db', 'U'); 
		ws_conversao := replace(ws_conversao,'\u00e7', 'c'); 
		ws_conversao := replace(ws_conversao,'\u00c7', 'C'); 
		ws_conversao := replace(ws_conversao,'\u00f1', 'nao'); 
		ws_conversao := replace(ws_conversao,'\u00d1', 'NAO'); 
		ws_conversao := replace(ws_conversao,'\u0026', '&'); 					
		ws_conversao := replace(ws_conversao,'\u0026', '&'); 					
		ws_conversao := replace(ws_conversao,chr(10), '###'); 					
		
		ws_traduzido := substr(fun.GET_TRANSLATOR(ws_conversao,'pt', ws_id_idioma),1,3999);
		ws_traduzido := replace(ws_traduzido, '###', chr(10));

		update traducao_colunas
		   set texto = ws_traduzido
		 where cd_tabela    = a.cd_tabela 
		   and cd_coluna    = a.cd_coluna 
		   and lang_default = a.lang_default
		   and tipo         = a.tipo
		   and cd_linguagem = a.cd_linguagem;

	end loop; 					
	commit; 

END traducao_colunas_traduzir;

end FCL;

